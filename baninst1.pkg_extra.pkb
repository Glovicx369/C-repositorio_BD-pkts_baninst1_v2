DROP PACKAGE BODY BANINST1.PKG_EXTRA;

CREATE OR REPLACE PACKAGE BODY BANINST1.PKG_EXTRA AS
/*
modify glovicx 21/09/2020 se agrega parametrizador para CRN para los niveles
*/
PROCEDURE leer_file IS

 cadena VARCHAR2(32767);
 Vfile UTL_FILE.FILE_TYPE;
 materia    varchar2(8);
 iden         varchar2(10);
 grupo       varchar2(5);
 f1             VARCHAR2(10);
 f2             VARCHAR2(10);
 var           number;
 coma        number;
 i               number;
 bimestre   varchar2(1);

BEGIN

 -- En este ejemplo leo una linea del fichero prueba.txt

 -- Abro fichero en lectura (Read)
 Vfile := UTL_FILE.FOPEN('IMAGEN','prof.csv','R',256);
 delete from SZEXTRA;
commit;

loop
begin
 -- Leo del fichero
 UTL_FILE.GET_LINE(Vfile,cadena,32767);
 materia:=null; iden:=null; grupo:=null; var:=0;

 for i IN 1..40 loop
 --  dbms_output.put_line(substr(cadena,i,1)||' '||var);
  if substr(cadena,i,1)=',' then
    if var=0 then
       materia:=substr(cadena,1,i-1);
       var:=1;
       coma:=i;
    else
       if var=1 then
          iden:=substr(cadena,coma+1,i-(coma+1));
          var:=2;
          coma:=i;
       else
           if var=2 then
              grupo:=substr(cadena,coma+1,2);
              bimestre:=substr(cadena,coma+4,1);
              var:=3;
              coma:=i;
           end if;
       end if;
    end if;
 end if;
 end loop;
  --dbms_output.put_line(cadena);
 --dbms_output.put_line('materia:'||materia||' '||'iden:'||iden||' '||'grupo:'||grupo||' '||'bimestre:'||bimestre);
 for c in (select scrtext_subj_code subj,scrtext_crse_numb crse, scbcrse_title nombre_mat from scrtext, scbcrse
              where scrtext_text=materia
              and    scbcrse_subj_code=scrtext_subj_code
              and    scbcrse_crse_numb=scrtext_crse_numb) loop
 insert into SZEXTRA values(c.subj, c.crse,c.nombre_mat, iden, grupo,bimestre);
 end loop;

 --dbms_output.put_line(cadena);
exception when NO_DATA_FOUND  then
  exit;
end;
end loop;
 -- Cierro fichero
 commit;
 UTL_FILE.FCLOSE(Vfile);


 -- Muestro por partalla la linea

END leer_file;

PROCEDURE leer_file_carga IS

 cadena VARCHAR2(32767);
 Vfile UTL_FILE.FILE_TYPE;
 iden         varchar2(20);
 materia      varchar2(20);
 prog         varchar2(20);
 periodo      varchar2(20);
 parte        varchar2(4);
 grupo        varchar2(5);
 calif        varchar2(10);
 iden_prof    varchar2(10);
 f1           VARCHAR2(10);
 f2           VARCHAR2(10);
 var          number;
 coma         number;
 i            number;
 bimestre     varchar2(1);

BEGIN

 -- En este ejemplo leo una linea del fichero prueba.txt

 -- Abro fichero en lectura (Read)
 Vfile := UTL_FILE.FOPEN('IMAGEN','carga.csv','R',256);
--delete from SZEXTRA;
--commit;

loop
begin
 -- Leo del fichero
 UTL_FILE.GET_LINE(Vfile,cadena,32767);
 materia:=null; iden:=null; grupo:=null; prog:=null; periodo:=null; parte:=null; iden_prof:=null; var:=0;

 for i IN 1..60 loop
 --  dbms_output.put_line(substr(cadena,i,1)||' '||var);
  if substr(cadena,i,1)=',' then
    if var=0 then
       iden:=trim(substr(cadena,1,i-1));
       var:=1;
       coma:=i;
    else
       if var=1 then
          materia:=trim(substr(cadena,coma+1,i-(coma+1)));
          var:=2;
          coma:=i;
       else
           if var=2 then
              prog:=trim(substr(cadena,coma+1,i-(coma+1)));
              var:=3;
              coma:=i;
           else
              if var=3 then
                periodo:=trim(substr(cadena,coma+1,i-(coma+1)));
                var:=4;
                coma:=i;
              else
                 if var=4 then
                    parte:=trim(substr(cadena,coma+1,i-(coma+1)));
                    var:=5;
                    coma:=i;
                 else
                     if var=5 then
                        grupo:=trim(substr(cadena,coma+1,i-(coma+1)));
                        var:=6;
                        coma:=i;
                     else
                         if var=6 then
                             calif:=trim(substr(cadena,coma+1,i-(coma+1)));
                             iden_prof:=trim(substr(cadena,i+1,9));
                             var:=7;
                             coma:=i;
                         end if;
                     end if;
                 end if;
              end if;
           end if;
       end if;
    end if;
 end if;
 end loop;
  --dbms_output.put_line(cadena);
 --dbms_output.put_line('iden:'||iden||' materia:'||materia||' '||'prog:'||prog||' '||' periodo:'||periodo||' parte:'||parte||' grupo:'||grupo||' '||'calif:'||calif||' profesor:'||iden_prof);
 --for c in (select scrtext_subj_code subj,scrtext_crse_numb crse, scbcrse_title nombre_mat from scrtext, scbcrse
 --             where scrtext_text=materia
 --           and    scbcrse_subj_code=scrtext_subj_code
--              and    scbcrse_crse_numb=scrtext_crse_numb) loop
if iden is not null then
 insert into SZCARGA values(trim(iden), trim(materia), trim(prog), trim(periodo),trim(parte) , trim(grupo),trim(calif), trim(iden_prof), user, sysdate, NULL,NULL,null);
end if;
 -- insert into SZFCARG values(trim(iden), trim(materia), trim(prog), trim(periodo),trim(parte) , trim(grupo),trim(calif), trim(iden_prof), user, sysdate);
-- end loop;

 --dbms_output.put_line(cadena);
exception when NO_DATA_FOUND  then
  exit;
end;
end loop;

 -- Cierro fichero
 commit;
 UTL_FILE.FCLOSE(Vfile);

delete from szfcarg
where szcarga_term_code in (select szcarga_term_code from szcarga)
and     szcarga_ptrm_code in (select szcarga_ptrm_code from szcarga);
commit;

insert into szfcarg

select * from szcarga;
commit;

 -- Muestro por partalla la linea

END leer_file_carga;

PROCEDURE carga_horarios(periodo varchar2) IS

crn varchar2(5);

begin
crn:='1000';
for c in (
select distinct szextra_subj_code subj, szextra_crse_numb crse, szextra_grupo grupo , scrschd_schd_code schd, szvcamp_camp_code camp, szextra_materia title, scrgmod_gmod_code gmod,
     'L3'||szextra_bimestre ptrm, sobptrm_start_date f_inicio, sobptrm_end_date f_fin, scbcrse_credit_hr_low cred, spriden_pidm pidm
    from szextra, scrschd , szvcamp, scrgmod, scbcrse, spriden, sobptrm
    where scrschd_subj_code=szextra_subj_code
    and     scrschd_crse_numb=szextra_crse_numb
    and     scrgmod_subj_code=szextra_subj_code
    and     scrgmod_crse_numb=szextra_crse_numb
    and     scrgmod_default_ind='D'
    and     scbcrse_subj_code=szextra_subj_code
    and     scbcrse_crse_numb=szextra_crse_numb
    and     szvcamp_camp_alt_code=substr(periodo,1,2)
    and     substr(spriden_id,5,5)=lpad(szextra_id,5,'0') and substr(spriden_origin,1,1)='P' and spriden_change_ind is null
    and     substr(spriden_id,1,2)=substr(periodo,1,2)
    and     sobptrm_term_code=periodo
    and     sobptrm_ptrm_code='L3'||szextra_bimestre
    order by szextra_subj_code, szextra_crse_numb
    ) loop

       insert into ssbsect values(  periodo, crn, c.ptrm, c.subj, c.crse, substr(c.grupo,1,3),'A', c.schd, c.camp, c.title, null, 3, c.gmod, null,null,null,null,'Y',null, 0,0,0,500,0,500,null,'0',c.f_inicio,  sysdate, c.f_inicio, c.f_fin,8, null,null,null,null, null,null,null,null,
                                                   null,null,null,null,null,null,null, 'Y','N', null,null,null,'NOP',null,null,null,null,null,null,0, 500, 'MIGRA', null,'B',null,null,null,null,null,null,null,null);

       insert into ssrmeet values( periodo, crn, null,null,null,null,null,null,sysdate,c.f_inicio,c.f_fin, '01',null,null,null,null,null,null,null,c.schd,null, c.cred, null, 0,null,null,null,'CLVI','UTEL',user, null,null,null);

       insert into sirasgn values( periodo, crn, c.pidm, '01',100,null, 100, 'Y',null,null, sysdate,'AS', null,null,null, 'UTEL', user, null,null,null,null,null,null);

       crn := crn+1;
end loop;

commit;

delete from SZEXTRA;
commit;

update sobterm set sobterm_crn_oneup=crn
where sobterm_term_code=periodo;
commit;

end carga_horarios;

PROCEDURE carga_inscrip IS

crn      varchar2(5);
gpo     number;
mate   varchar2(20);
ciclo    varchar2(6);
subj       varchar2(4);
crse       varchar2(5);
sb       varchar2(4);
cr       varchar2(5);
schd   varchar2(3);
title    varchar2(30);
credit decimal(7,3);
gmod  varchar2(1);
f_inicio date;
f_fin     date;
sem     number;
conta_ptrm number;
conta_blck number;
pidm   number;
pidm_doc number;
pidm_doc2 number;
ests    varchar2(2);
levl     varchar2(2);
camp  varchar2(3);
rsts    varchar2(3);
conta_origen number:=0;
conta_destino number :=0;
conta_origen_ssbsect number:=0;
conta_origen_ssrblck number:=0;
conta_origen_sobptrm number:=0;
sp       integer;
ciclo_ext varchar2(6);
mensaje   varchar2(200);
parte varchar2(3);
pidm_prof number;
per    varchar2(6);
grupo varchar2(4);
conta_sirasgn number;
vcrn    varchar2(3);

begin

for c in (

select distinct spriden_pidm pidm, szcarga_id iden  , szcarga_program prog, sorlcur_term_code_ctlg ctlg , szcarga_materia  materia , smrarul_subj_code subj, smrarul_crse_numb_low crse ,
szcarga_term_code periodo , szcarga_ptrm_code parte, decode(sztdtec_periodicidad,1,'BIMESTRAL',2,'CUATRIMESTRAL') , szcarga_grupo grupo, szcarga_calif calif,szcarga_id_prof prof
from SZCARGA
join spriden on spriden_id=szcarga_id and spriden_change_ind is null
join sorlcur s on sorlcur_pidm=spriden_pidm and sorlcur_program=szcarga_program and sorlcur_lmod_code='LEARNER' and sorlcur_roll_ind='Y' and sorlcur_cact_code='ACTIVE' and sorlcur_seqno in (select max(sorlcur_seqno) from sorlcur ss
                                                                                                where s.sorlcur_pidm=ss.sorlcur_pidm and s.sorlcur_lmod_code=ss.sorlcur_lmod_code
                                                                                                and     s.sorlcur_program=ss.sorlcur_program)
join smrpaap on smrpaap_program=sorlcur_program and smrpaap_term_code_eff=sorlcur_term_code_ctlg
join scrtext on scrtext_text=szcarga_materia
join smrarul on smrarul_area=smrpaap_area and smrarul_term_code_eff=smrpaap_term_code_eff
left outer join sztdtec on sztdtec_program=sorlcur_program and sztdtec_term_code=sorlcur_term_code_ctlg
where  smrarul_subj_code=scrtext_subj_code and smrarul_crse_numb_low=scrtext_crse_numb
--and      szcarga_id='010033049'
order by --periodo, parte, subj,crse, grupo, prog,ctlg,
 iden


) loop

            --dbms_output.put_line('pidm:'||c.pidm||' id:'||c.iden||'subj||crse:'||c.subj||c.crse||'programa:'||c.prog||'parte:'||c.parte);
            begin
            select ssbsect_crn into crn
            from ssbsect, sfrstcr
            where sfrstcr_pidm=c.pidm
            and sfrstcr_term_code=c.periodo
            and     ssbsect_term_code=sfrstcr_term_code and ssbsect_crn=sfrstcr_crn and ssbsect_subj_code=c.subj
            and ssbsect_crse_numb=c.crse ;
            --and ssbsect_ptrm_code=c.parte;
            exception when others then
            crn:=null;
            end;

            if crn is not null then
              if c.calif is not null then
                  update sfrstcr
                        set sfrstcr_grde_code=c.calif, sfrstcr_activity_date=sysdate, sfrstcr_user_id=user, SFRSTCR_DATA_ORIGIN = 'SZTCARG'
                  where sfrstcr_pidm=c.pidm
                  and sfrstcr_term_code=c.periodo
                  and sfrstcr_crn=crn;
                  if c.prof is not null then

                     begin
                     select  spriden_pidm into pidm_doc2
                     from spriden
                     where spriden_id=c.prof and spriden_change_ind is null;
                     exception when others then
                     pidm_doc2:=null;
                     end;
                     if pidm_doc2 is not null then
                        select count(*) into conta_sirasgn
                        from sirasgn
                        where sirasgn_term_code=c.periodo and sirasgn_crn=crn and sirasgn_pidm=pidm_doc2;
                        if conta_sirasgn > 0 then
                           continue;
                        end if;
                        begin
                        select  sirasgn_pidm into pidm_doc
                        from sirasgn, spriden
                        where sirasgn_term_code=c.periodo and sirasgn_crn=crn and sirasgn_primary_ind ='Y'
                        and     spriden_pidm=sirasgn_pidm and spriden_change_ind is null;
                        exception when others then
                        pidm_doc:=null;
                        end;
                        if pidm_doc is  null then
                           --dbms_output.put_line('1 -'||c.periodo||' '||crn||' '||pidm_doc2);
                           insert into sirasgn values(c.periodo, crn, pidm_doc2, '01', 100, null, 100, 'Y', null, null, sysdate, null, null, null, null, 'Banner', user,  null, null, null, null, null, null);
                        else
                           if pidm_doc != pidm_doc2 then
                              update sirasgn set sirasgn_primary_ind='N'
                              where sirasgn_term_code=c.periodo and sirasgn_crn=crn and sirasgn_primary_ind='Y';
                              --dbms_output.put_line('2 -'||c.periodo||' '||crn||' '||pidm_doc2);
                              insert into sirasgn values(c.periodo, crn, pidm_doc2, '02', 100, null, 100, 'Y', null, null, sysdate, null, null, null, null, 'Banner', user,  null, null, null, null, null, null);
                           end if;
                        end if;
                     end if;
                  end if;
              end if;

               continue;
            else
                begin
                select max(ssbsect_crn) into crn from ssbsect
                where ssbsect_term_code=c.periodo and ssbsect_subj_code=c.subj and ssbsect_crse_numb=c.crse  and ssbsect_ptrm_code=c.parte;
                exception when others then
                crn:=null;
                end;
             end if;
           ciclo:=c.periodo;
           --dbms_output.put_line('ciclo:'||ciclo||' '||'parte:'||c.parte);
           select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
           into f_inicio, f_fin, sem
           from sobptrm
           where sobptrm_term_code=ciclo
           and     sobptrm_ptrm_code=c.parte;
            if crn is null then
                        select scrschd_schd_code, scbcrse_title, scbcrse_credit_hr_low
                        into schd, title, credit
                        from scbcrse, scrschd
                        where scbcrse_subj_code=c.subj
                        and     scbcrse_crse_numb=c.crse
                        and     scbcrse_eff_term='000000'
                        and     scrschd_subj_code=scbcrse_subj_code
                        and     scrschd_crse_numb=scbcrse_crse_numb
                        and     scrschd_eff_term=scbcrse_eff_term;

                     begin
                        select scrgmod_gmod_code
                        into gmod
                        from scrgmod
                        where scrgmod_subj_code=c.subj
                        and     scrgmod_crse_numb=c.crse
                        and     scrgmod_default_ind='D';
                     exception when others then
                        gmod:='1';
                     end;

                 select sgbstdn_levl_code, sgbstdn_camp_code
                 into levl, camp
                from sgbstdn a
                where sgbstdn_pidm=c.pidm
                and     sgbstdn_term_code_eff  in (select max(sgbstdn_term_code_eff) from sgbstdn aa
                                                                   where a.sgbstdn_pidm=aa.sgbstdn_pidm);

                        select szvcamp_camp_code into camp from szvcamp
                        where szvcamp_camp_alt_code=substr(c.iden,1,2);

                        --dbms_output.put_line('periodo:'||ciclo);

                  if per is null or per!=ciclo or mate is  null or mate!=c.subj||c.crse or parte is null or      parte != c.parte or grupo is null or grupo!=c.grupo  then
                        --select nvl(max(to_number(ssbsect_crn)),1000)+1  into crn
                        --from ssbsect where ssbsect_term_code= ciclo;
                   BEGIN

                        select sztcrnv_crn
                        into crn
                        from SZTCRNV
                        where 1 = 1
                        and rownum = 1
                        and sztcrnv_crn not in (select to_number(crn)
                                                from
                                                (
                                                select case when
                                                    substr(SSBSECT_CRN,1,1) in('L','M','A','D','B') then to_number(substr(SSBSECT_CRN,2,10))
                                                   else
                                                     to_number(SSBSECT_CRN)
                                                  end crn,
                                                   SSBSECT_CRN
                                                 from ssbsect
                                                  where 1 = 1
                                                  and ssbsect_term_code= c.periodo
                                                )
                                where 1 = 1)
                        order by 1;
                             EXCEPTION WHEN OTHERS THEN
                               -------esto es por que ya se acabaron los CRN que empiezan con L y se agrego una l mas.

                                       begin
                                        select sztcrnv_crn
                                            into crn
                                            from SZTCRNV
                                            where 1 = 1
                                            and rownum = 1
                                            and sztcrnv_crn not in (
                                                                 select to_number(crn)
                                                                    from
                                                                    (   select distinct to_number(substr(SSBSECT_CRN,2,10)) crn
                                                                        from ssbsect
                                                                        where 1 = 1
                                                                        and ssbsect_term_code= c.periodo
                                                                        and SSBSECT_CRN not like(''''||vcrn||'%')
                                                                        order by 1
                                                                   )
                                                    where 1 = 1)
                                            order by 1;
                                              dbms_output.put_line ('exception 1 CRN: '||c.periodo||'-'||crn  );
                                      Exception    When Others then

                                       crn := null;
                                        ---vl_error  := 'ERROR_1_1 AL CALCULAR CRN::';
                                      end;

                       ---  raise_application_error (-20002,'ERROR_1_1 AL CALCULAR CRN:: '||SQLERRM);
                                --dbms_output.put_line(' error en crn 2 '||sqlerrm);
                            crn := NULL;
                     END;



                        --dbms_output.put_line('ciclo:'||ciclo||' crn:'||crn||' subj||crse:'||c.subj||c.crse);
                        insert into ssbsect values( ciclo, crn, c.parte, c.subj, c.crse, '01', 'A', schd, camp, title, null, 3, gmod, null,null,null,null,'Y',null, 0,0,0,50,0,0,null,'0',f_inicio,  sysdate, f_inicio, f_fin,sem, null,null,null,null, null,null,null,null,
                                                                       null,null,null,null,null,null,null, 'Y','N', null,null,null,'NOP',null,null,null,null,null,null,0, '01', user, null,'B',null,null,null,null,null,null,null,null);
                        insert into ssrmeet values(ciclo, crn, null,null,null,null,null,null, sysdate, f_inicio, f_fin, '01', null,null,null,null,null,null,null, 'ENL', null, credit, null, 0, null,null,null, 'CLVI', 'UTEL', user, null,null,null);

                        pidm_prof := null;

                        begin
                        select spriden_pidm into pidm_prof
                        from  spriden
                        where   spriden_id=c.prof and spriden_change_ind is null;
                        exception when others then
                        pidm_prof:=null;
                        end;

                        if pidm_prof is not null then
                           insert into sirasgn values(ciclo, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,  sysdate, null,null,null,null, 'BANNER', user, null, null, null, null,  null,null);
                        end if;



                  end if;
             end if;
             --dbms_output.put_line('pidm:'||c.pidm||' materia:'||c.subj||' '||c.crse||' ciclo:'||ciclo);
             select count(*) into conta_ptrm
             from sfbetrm
             where sfbetrm_term_code=ciclo
             and     sfbetrm_pidm=c.pidm;
             if conta_ptrm =0 then
                   insert into sfbetrm values(ciclo, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'UTEL', null, 0,null,null, null,null,'MIGRA',null);
             end if;


                                                                 --  and     aa.sgbstdn_term_code_eff <=  ciclo) ;

                      select distinct max(sorlcur_key_seqno) into sp
                      from sorlcur
                      where sorlcur_pidm=c.pidm
                      and     sorlcur_program=c.prog
                      and     sorlcur_lmod_code='LEARNER';
                  --    and     sorlcur_roll_ind='Y'
                  --    and     sorlcur_current_cde='Y'
                 --     And     SORLCUR_APPL_KEY_SEQNO is not null;

        insert into sfrstcr values(ciclo, c.pidm, crn , null, 1,c.parte, 'RE', sysdate, null,null, 3, null, credit, null,credit, gmod, null, null,null, null,null,null,null,null,null,null,null,null,null, null, null, sysdate, sysdate,
                                                    levl, camp, null, null, null,  null,null,null, null,null,null,null,null, 'UTEL', null,null,null,null,null,null,null,null,null,null,sp,null,'01', null,null,null,null, user, null);

        insert into sfrareg values(c.pidm, ciclo, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'UTEL', sysdate, null,null,null);

        update sorlcur set sorlcur_start_date=f_inicio
          where sorlcur_pidm=c.pidm and sorlcur_key_seqno=sp
            And SORLCUR_CAMP_CODE not in ('UTL','UTS');

        --dbms_output.put_line('inscripcion-pidm:'||c.pidm||' crn:'||crn);

        mate:=c.subj||c.crse;
        parte:=c.parte;
        per:=ciclo;
        grupo:=c.grupo;

end loop;

commit;

update ssbsect set ssbsect_enrl=(select count(*) from sfrstcr
                                                 where sfrstcr_term_code=ssbsect_term_code
                                                 and     sfrstcr_crn=ssbsect_crn
                                                 and     sfrstcr_rsts_code='RE')
where  ssbsect_term_code in (select szcarga_term_code from szcarga where szcarga_ptrm_code=ssbsect_ptrm_code);
commit;

update ssbsect set ssbsect_seats_avail=ssbsect_max_enrl-ssbsect_enrl
where ssbsect_max_enrl-ssbsect_enrl > 0
and      ssbsect_term_code in (select szcarga_term_code from szcarga where szcarga_ptrm_code=ssbsect_ptrm_code);
commit;

update ssbsect set ssbsect_seats_avail=0
where ssbsect_max_enrl-ssbsect_enrl <= 0
and      ssbsect_term_code in (select szcarga_term_code from szcarga where szcarga_ptrm_code=ssbsect_ptrm_code);
commit;

update ssbsect set ssbsect_max_enrl=ssbsect_enrl
where ssbsect_max_enrl=0
and     ssbsect_enrl > 0
and      ssbsect_term_code in (select szcarga_term_code from szcarga where szcarga_ptrm_code=ssbsect_ptrm_code);
commit;

update ssbsect set ssbsect_census_enrl=ssbsect_enrl
where  ssbsect_term_code in (select szcarga_term_code from szcarga where szcarga_ptrm_code=ssbsect_ptrm_code);
commit;


update sobterm set sobterm_crn_oneup= (select nvl(max(to_number(ssbsect_crn)),1000) from ssbsect
                               where  sobterm_term_code=ssbsect_term_code)
where  sobterm_term_code in (select szcarga_term_code from szcarga);
commit;

end carga_inscrip;

Procedure carga_inscrip_ni(fecha varchar2, campus varchar2, nivel varchar2, peri varchar2)  IS



crn      varchar2(6);
gpo     number;
mate   varchar2(20);
ciclo    varchar2(6);
subj       varchar2(4);
crse       varchar2(5);
sb       varchar2(4);
cr       varchar2(5);
schd   varchar2(3);
title    varchar2(30);
credit decimal(7,3);
credit_bill decimal(7,3);
gmod  varchar2(1);
f_inicio date;
f_fin     date;
sem     number;
conta_ptrm number;
conta_blck number;
pidm   number;
pidm_doc number;
pidm_doc2 number;
ests    varchar2(2);
levl     varchar2(2);
camp  varchar2(3);
rsts    varchar2(3);
conta_origen number:=0;
conta_destino number :=0;
conta_origen_ssbsect number:=0;
conta_origen_ssrblck number:=0;
conta_origen_sobptrm number:=0;
sp       integer;
ciclo_ext varchar2(6);
mensaje   varchar2(200);
parte varchar2(3);
pidm_prof number;
per    varchar2(6);
grupo varchar2(4);
conta_sirasgn number;
fecha_ini date;
vl_existe number :=0;

vn_lugares number:=0;
vn_cupo_max number:=0;
vn_cupo_act number:=0;
vl_error varchar2 (2500):= 'EXITO';

vl_vueltas number :=0;
vl_numero number :=0;
vl_tipoingreso varchar2(2):= null;
vl_conversion varchar2(10):= null;

vl_secuencia_cont number:=0;
vl_mat_ext number :=0;

vl_jornada varchar2(250):=null;
vl_vuelta_L0D number :=0;
vl_exite_prof number :=0;
vmateria_padre     varchar2(15);
no_recibo        number:= 0;
vmes         varchar2(5);
vdia         number;
vcrn    varchar2(3);
l_campus_ms     varchar2(4);

--niv     varchar2(1);

begin

fecha_ini:=to_date(fecha,'dd/mm/rrrr');

If campus not in ('UVE', 'UOC' ,'UTL') and nivel not in ('EC', 'LI') then
   --dbms_output.put_line('Entrada 1');

                    for c in (

                    select  sorlcur_pidm pidm, spriden_id iden, sorlcur_program prog, sorlcur_term_code_ctlg ctlg , scrtext_text materia , smrarul_subj_code subj, smrarul_crse_numb_low crse,  '01' grupo,
                    null calif, sztdtec_periodicidad perio,
                   null  prof,
                      null pperiodo
                    from sorlcur a
                    join spriden b on b.spriden_pidm = a.sorlcur_pidm and b.spriden_change_ind is null
                    join  sgbstdn d on  d.sgbstdn_pidm=spriden_pidm
                    And d.SGBSTDN_TERM_CODE_EFF = (select max (b1.SGBSTDN_TERM_CODE_EFF)
                                                                           from SGBSTDN b1
                                                                           Where d.sgbstdn_pidm = b1.sgbstdn_pidm)
                    join smrpaap on smrpaap_program=sorlcur_program
                            and smrpaap_term_code_eff=sorlcur_term_code_ctlg
                    join smrarul on smrarul_area=smrpaap_area
                            and smrarul_term_code_eff=smrpaap_term_code_eff
                            and (smrarul_crse_numb_low like '%101%' or smrarul_crse_numb_low like '%102%' or smrarul_crse_numb_low='001')
                    join scrtext on scrtext_subj_code=smrarul_subj_code
                            and scrtext_crse_numb=smrarul_crse_numb_low
                            and (substr(scrtext_text,1,4)=smrarul_subj_code or substr(scrtext_text,1,3)=smrarul_subj_code
                            or substr(scrtext_text,1,2)=smrarul_subj_code)
                            And substr(smrarul_area,9,2) in ('01','02')
                    join sztdtec on sztdtec_program=sorlcur_program
                            and sztdtec_term_code=sorlcur_term_code_ctlg
                    Where  a.SORLCUR_LMOD_CODE = 'LEARNER'
                    And a.SORLCUR_CACT_CODE = 'ACTIVE'
                    And a.SORLCUR_ROLL_IND = 'Y'
                    And a.sorlcur_pidm in (select sorlcur_pidm
                                                      from sorlcur aa
                                                      where a.sorlcur_program=aa.sorlcur_program
                                                      and a.sorlcur_lmod_code=aa.sorlcur_lmod_code
                                                      and a.sorlcur_roll_ind=aa.sorlcur_roll_ind)
                    and a.SORLCUR_SEQNO = (select max (SORLCUR_SEQNO)
                                                            from SORLCUR aa1
                                                            Where a.sorlcur_pidm = aa1.sorlcur_pidm
                                                            And a.SORLCUR_LMOD_CODE = aa1.SORLCUR_LMOD_CODE
                                                            And a.SORLCUR_CACT_CODE = aa1.SORLCUR_CACT_CODE
                                                            And a.SORLCUR_KEY_SEQNO = aa1.SORLCUR_KEY_SEQNO
                                                            And a.sorlcur_program=aa1.sorlcur_program
                                                            And trunc (a.sorlcur_start_date) = fecha_ini
                                                            )
                    And a.SORLCUR_CAMP_CODE= campus
                    And a.SORLCUR_LEVL_CODE= nivel
                    And d.SGBSTDN_STYP_CODE in ('N', 'F')
             --     and a.sorlcur_pidm in ( 30320, 32022, 32074,32244,32667,32897, 33029 , 33511, 33714 )
                    union
                    select  distinct sorlcur_pidm pidm, spriden_id iden, sorlcur_program prog, sorlcur_term_code_ctlg ctlg , scrtext_text materia , smrarul_subj_code subj, smrarul_crse_numb_low crse,  '01' grupo,
                    null calif, sztdtec_periodicidad perio,
                   null  prof,
                      SZTPTRM_PTRM_CODE pperiodo
                    from sorlcur a
                    join spriden b on b.spriden_pidm = a.sorlcur_pidm and b.spriden_change_ind is null
                    join  sgbstdn d on  d.sgbstdn_pidm=spriden_pidm
                    And d.SGBSTDN_TERM_CODE_EFF = (select max (b1.SGBSTDN_TERM_CODE_EFF)
                                                                           from SGBSTDN b1
                                                                           Where d.sgbstdn_pidm = b1.sgbstdn_pidm)
                    join smrpaap on smrpaap_program=sorlcur_program
                            and smrpaap_term_code_eff=sorlcur_term_code_ctlg
                    join smrarul on smrarul_area=smrpaap_area
                            and smrarul_term_code_eff=smrpaap_term_code_eff
                            and  smrarul_crse_numb_low like '%401%'
                    join scrtext on scrtext_subj_code=smrarul_subj_code
                            and scrtext_crse_numb=smrarul_crse_numb_low
                            and (substr(scrtext_text,1,4)=smrarul_subj_code or substr(scrtext_text,1,3)=smrarul_subj_code or substr(scrtext_text,1,2)=smrarul_subj_code)
                            And substr(smrarul_area,9,2) in ('01','02')
                    join sztdtec on sztdtec_program=sorlcur_program
                            and sztdtec_term_code=sorlcur_term_code_ctlg
                    join sztptrm on SZTPTRM_CAMP_CODE = a.sorlcur_camp_code
                            and  a.sorlcur_levl_code =  SZTPTRM_LEVL_CODE
                            and  SZTPTRM_TERM_CODE = peri
                            and  a.sorlcur_program =   SZTPTRM_PROGRAM
                            and SZTPTRM_PROPEDEUTICO= 1
                    join sobptrm on SOBPTRM_TERM_CODE = SZTPTRM_TERM_CODE
                            and SOBPTRM_PTRM_CODE = SZTPTRM_PTRM_CODE
                            and trunc (SOBPTRM_START_DATE) = trunc (a.sorlcur_start_date)
                    Where  a.SORLCUR_LMOD_CODE = 'LEARNER'
                    And a.SORLCUR_CACT_CODE = 'ACTIVE'
                    And a.SORLCUR_ROLL_IND = 'Y'
                    And a.sorlcur_pidm in (select sorlcur_pidm
                                                      from sorlcur aa
                                                      where a.sorlcur_program=aa.sorlcur_program
                                                      and a.sorlcur_lmod_code=aa.sorlcur_lmod_code
                                                      and a.sorlcur_roll_ind=aa.sorlcur_roll_ind)
                    and a.SORLCUR_SEQNO = (select max (SORLCUR_SEQNO)
                                                            from SORLCUR aa1
                                                            Where a.sorlcur_pidm = aa1.sorlcur_pidm
                                                            And a.SORLCUR_LMOD_CODE = aa1.SORLCUR_LMOD_CODE
                                                            And a.SORLCUR_CACT_CODE = aa1.SORLCUR_CACT_CODE
                                                            And a.SORLCUR_KEY_SEQNO = aa1.SORLCUR_KEY_SEQNO
                                                            And a.sorlcur_program=aa1.sorlcur_program
                                                           And trunc (a.sorlcur_start_date) =  fecha_ini
                                                            )
                    And a.SORLCUR_CAMP_CODE= campus
                    And a.SORLCUR_LEVL_CODE= nivel
                    And d.SGBSTDN_STYP_CODE in ('N', 'F')
           --     and a.sorlcur_pidm in ( 30320, 32022, 32074,32244,32667,32897, 33029 , 33511, 33714 )
                    union
                    select  sorlcur_pidm pidm, spriden_id iden, sorlcur_program prog, sorlcur_term_code_ctlg ctlg , scrtext_text materia , smrarul_subj_code subj, smrarul_crse_numb_low crse,   '01' grupo,
                    null calif, sztdtec_periodicidad perio,
                   null  prof,
                      null pperiodo
                    from sorlcur a
                    join spriden b on b.spriden_pidm = a.sorlcur_pidm
                            and b.spriden_change_ind is null
                    join  sgbstdn d on d.sgbstdn_pidm=spriden_pidm
                            And d.SGBSTDN_TERM_CODE_EFF = (select max (b1.SGBSTDN_TERM_CODE_EFF)
                                                                                   from SGBSTDN b1
                                                                                   Where d.sgbstdn_pidm = b1.sgbstdn_pidm)
                    join smrpaap on smrpaap_program=sorlcur_program
                            and smrpaap_term_code_eff=sorlcur_term_code_ctlg
                    join smrarul on smrarul_area=smrpaap_area
                            and smrarul_term_code_eff=smrpaap_term_code_eff
                            and (( smrarul_crse_numb_low like '%101%' or smrarul_crse_numb_low like '%102%'  or smrarul_crse_numb_low='001' or smrarul_crse_numb_low='13001')  or
                       (smrarul_subj_code='131'  and (smrarul_crse_numb_low like '%01%' or smrarul_crse_numb_low like '%02%')))
                     and substr(smrarul_area,9,2) in ('01','02')
                    join scrtext on scrtext_subj_code=smrarul_subj_code and scrtext_crse_numb=smrarul_crse_numb_low and (substr(scrtext_text,1,4)=smrarul_subj_code or substr(scrtext_text,1,3)=smrarul_subj_code or substr(scrtext_text,1,2)=smrarul_subj_code)
                    join sztdtec on sztdtec_program=sorlcur_program and sztdtec_term_code=sorlcur_term_code_ctlg and sztdtec_periodicidad=2
                    Where  a.SORLCUR_LMOD_CODE = 'LEARNER'
                    And a.SORLCUR_CACT_CODE = 'ACTIVE'
                    And a.SORLCUR_ROLL_IND = 'Y'
                    And a.sorlcur_pidm in (select sorlcur_pidm
                                                      from sorlcur aa
                                                      where a.sorlcur_program=aa.sorlcur_program
                                                      and a.sorlcur_lmod_code=aa.sorlcur_lmod_code
                                                      and a.sorlcur_roll_ind=aa.sorlcur_roll_ind)
                    and a.SORLCUR_SEQNO = (select max (SORLCUR_SEQNO)
                                                            from SORLCUR aa1
                                                            Where a.sorlcur_pidm = aa1.sorlcur_pidm
                                                            And a.SORLCUR_LMOD_CODE = aa1.SORLCUR_LMOD_CODE
                                                            And a.SORLCUR_CACT_CODE = aa1.SORLCUR_CACT_CODE
                                                            And a.SORLCUR_KEY_SEQNO = aa1.SORLCUR_KEY_SEQNO
                                                            And a.sorlcur_program=aa1.sorlcur_program
                                                            And trunc (a.sorlcur_start_date) = fecha_ini
                                                            )
                    And a.SORLCUR_CAMP_CODE=campus And campus != 'UNA'
                    And a.SORLCUR_LEVL_CODE= nivel
                    And d.SGBSTDN_STYP_CODE in ('N', 'F')
               --   and a.sorlcur_pidm in ( 30320, 32022, 32074,32244,32667,32897, 33029 , 33511, 33714 )
                    union
                    select  sorlcur_pidm pidm, spriden_id iden, sorlcur_program prog, sorlcur_term_code_ctlg ctlg , scrtext_text materia , smrarul_subj_code subj, smrarul_crse_numb_low crse,   '01' grupo,
                    null calif, sztdtec_periodicidad perio,
                  null  prof,
                    null pperiodo
                    from sorlcur a
                    join spriden b on b.spriden_pidm = a.sorlcur_pidm and b.spriden_change_ind is null
                    join  sgbstdn d on  d.sgbstdn_pidm=spriden_pidm
                    And d.SGBSTDN_TERM_CODE_EFF = (select max (b1.SGBSTDN_TERM_CODE_EFF)
                                                                           from SGBSTDN b1
                                                                           Where d.sgbstdn_pidm = b1.sgbstdn_pidm)
                    join smrpaap on smrpaap_program=sorlcur_program and smrpaap_term_code_eff=sorlcur_term_code_ctlg
                    join smrarul on smrarul_area=smrpaap_area and smrarul_term_code_eff=smrpaap_term_code_eff
                    and (( smrarul_crse_numb_low like '%101%' or smrarul_crse_numb_low like '%102%'  or smrarul_crse_numb_low like '%103%' or smrarul_crse_numb_low='001' or smrarul_crse_numb_low='13001')  or
                       (smrarul_subj_code='131'  and (smrarul_crse_numb_low like '%01%' or smrarul_crse_numb_low like '%02%')))
                     and substr(smrarul_area,9,2) in ('01','02')
                    join scrtext on scrtext_subj_code=smrarul_subj_code and scrtext_crse_numb=smrarul_crse_numb_low and (substr(scrtext_text,1,4)=smrarul_subj_code or substr(scrtext_text,1,3)=smrarul_subj_code or substr(scrtext_text,1,2)=smrarul_subj_code)
                    join sztdtec on sztdtec_program=sorlcur_program and sztdtec_term_code=sorlcur_term_code_ctlg and sztdtec_periodicidad=2
                    Where  a.SORLCUR_LMOD_CODE = 'LEARNER'
                    And a.SORLCUR_CACT_CODE = 'ACTIVE'
                    And a.SORLCUR_ROLL_IND = 'Y'
                    And a.sorlcur_pidm in (select sorlcur_pidm
                                                      from sorlcur aa
                                                      where a.sorlcur_program=aa.sorlcur_program
                                                      and a.sorlcur_lmod_code=aa.sorlcur_lmod_code
                                                      and a.sorlcur_roll_ind=aa.sorlcur_roll_ind)
                    and a.SORLCUR_SEQNO = (select max (SORLCUR_SEQNO)
                                                            from SORLCUR aa1
                                                            Where a.sorlcur_pidm = aa1.sorlcur_pidm
                                                            And a.SORLCUR_LMOD_CODE = aa1.SORLCUR_LMOD_CODE
                                                            And a.SORLCUR_CACT_CODE = aa1.SORLCUR_CACT_CODE
                                                            And a.SORLCUR_KEY_SEQNO = aa1.SORLCUR_KEY_SEQNO
                                                            And a.sorlcur_program=aa1.sorlcur_program
                                                            And trunc (a.sorlcur_start_date) =  fecha_ini
                                                            )
                    And a.SORLCUR_CAMP_CODE=campus And campus = 'UNA'
                    And a.SORLCUR_LEVL_CODE= nivel
                    And d.SGBSTDN_STYP_CODE in ('N', 'F')
                 --      and a.sorlcur_pidm in ( 30320, 32022, 32074,32244,32667,32897, 33029 , 33511, 33714 )
                    order by   perio,materia, grupo, prog,ctlg, iden


                    ) loop


    --------------- Limpia Variables  --------------------
            --niv :=  null;
            parte := null;
            crn := null;
            pidm_doc2 := null;
            conta_sirasgn := null;
            pidm_doc := null;
            f_inicio := null;
            f_fin := null;
            sem := null;
            schd := null;
            title := null;
            credit := null;
            credit_bill :=null;
            levl := null;
            camp := null;
            mate := null;
            per := null;
            grupo := null;
            vl_existe :=0;

            vn_lugares :=0;
            vn_cupo_max :=0;
            vn_cupo_act :=0;
            vl_error := 'EXITO';

            vl_mat_ext :=0;
            no_recibo  :='';
            vmes      :='';
            vdia    := '';



           ----- Busca la Parte de Periodo para el programa que inicia clases
        If c.pperiodo is null then

             Begin
                    select distinct SZTPTRM_PTRM_CODE
                        Into Parte
                    from sztptrm, sobptrm
                    where SZTPTRM_CAMP_CODE = campus
                    And SZTPTRM_LEVL_CODE = nivel
                    and SZTPTRM_TERM_CODE = peri
                    and SOBPTRM_TERM_CODE = SZTPTRM_TERM_CODE
                    AND SOBPTRM_PTRM_CODE = SZTPTRM_PTRM_CODE
                    and SZTPTRM_PROGRAM = c.prog
                    and trunc (SOBPTRM_START_DATE) = fecha_ini;

                  --  dbms_output.put_line('Se llena parte de Periodo PREVIA:'||Parte ||' '||c.iden || c.subj ||c.crse);

                    If Parte in ('M0C' ) THEN
                       Parte := 'M1A';
                    Elsif  Parte in ('M0A' ) THEN
                       Parte := 'M0B';
                    Elsif  Parte in ('A0A' ) THEN
                       Parte := 'A0B';
                    Elsif  Parte in ('A0C' ) THEN
                       Parte := 'A1A';
                    End if;

                    --dbms_output.put_line('Se llena parte de Periodo PREVIA11:'||Parte ||'* '||c.iden ||'*'|| c.subj ||c.crse);

               Exception
                When Others then
                  parte := null;
               End;
        Else
             Parte := c.pperiodo;
        End if;



     --dbms_output.put_line('Se llena parte de Periodo:'||Parte ||' *'||c.iden || c.subj ||c.crse);


     --------------------- Se valida que el alumno no tenga la materia sembrada en el horario como Activa ---------------------------------------

           begin
            --existe y es aprobatoria
                select count (1)
                    into vl_existe
                from ssbsect, sfrstcr, SHRGRDE
                where sfrstcr_pidm=c.pidm
                --and sfrstcr_term_code=c.periodo
                and ssbsect_term_code=sfrstcr_term_code
                and SFRSTCR_PTRM_CODE = SSBSECT_PTRM_CODE
                and ssbsect_crn=sfrstcr_crn
                and ssbsect_subj_code=c.subj
                and ssbsect_crse_numb=c.crse
                and SFRSTCR_RSTS_CODE = 'RE'
                AND (SFRSTCR_GRDE_CODE = SHRGRDE_CODE
                                         OR SFRSTCR_GRDE_CODE IS NULL)
                AND SHRGRDE_PASSED_IND = 'Y'
                AND SHRGRDE_LEVL_CODE= NIVEL;

            Exception
            when others then
                vl_existe:=0;
            end;

            Begin
                   select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                   into f_inicio, f_fin, sem
                   from sobptrm
                   where sobptrm_term_code=Peri
                   and     sobptrm_ptrm_code=parte;
            Exception
               When Others then
                f_inicio:= null;
                f_fin := null;
                sem :=null;
            End;

------------calcula el numero de recibo al cual se va asociar la materia con la cartera glovicx 30/1/2020
           Begin
                select distinct max(sorlcur_key_seqno)
                    into sp
                from sorlcur
                where sorlcur_pidm=c.pidm
                and     sorlcur_program=c.prog
                and     sorlcur_lmod_code='LEARNER';
            Exception
               when Others then
                  sp := null;
                  vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||c.iden || c.subj ||c.crse ||sqlerrm;
            End;

          begin
            select to_char(to_date(f_inicio, 'DD/MM/YYYY'), 'DD')
            INTO vdia
            from dual;
          Exception
               when Others then
                  vmes := 0;
               --   vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||c.iden || c.subj ||c.crse ||sqlerrm;
          End;
            if vdia >= 20 then
               vmes := '+1';
             else
                 vmes := '1';
            end if;

       begin
              select DISTINCT max (TBRACCD_RECEIPT_NUMBER)
                into  no_recibo
                from tbraccd
               where 1=1
            AND  TBRACCD_DETAIL_CODE IN ( SELECT DISTINCT TBBDETC_DETAIL_CODE
                                           FROM TBBDETC
                                             where 1=1
                                             AND UPPER(TBBDETC_DESC) like('COLEGIATURA%')
                                             AND TBBDETC_TYPE_IND  = 'C'
                                             AND TBBDETC_DCAT_CODE  = 'COL')
            AND  TBRACCD_RECEIPT_NUMBER IS NOT  NULL
            and  TBRACCD_PIDM     = c.pidm
            and  TBRACCD_STSP_KEY_SEQUENCE  = sp --study
            and to_char(to_date(TBRACCD_EFFECTIVE_DATE, 'DD/MM/YYYY'), 'MM/YY') = TO_CHAR(ADD_MONTHS(f_inicio,vmes),'MM/YY')  --  (SELECT EXTRACT(MONTH FROM sysdate) FROM dual) -- mes actual o mes que sigue
            AND TBRACCD_DESC != 'COLEGIATURA LIC NOTA'
            AND TBRACCD_DESC != 'COLEGIATURA EXTRAORDINARIO'
            ;


       exception when others then
               no_recibo := '';
       end ;




        If vl_existe = 0 then

            --dbms_output.put_line('No Existe la materia:'||Parte ||' '||c.iden || c.subj ||c.crse);

                 If  c.prof is null then
                   -- dbms_output.put_line ('sin profesor '||vl_existe);
                   -- dbms_output.put_line ('crea consulta '||peri ||'*'|| c.subj  ||'*'||c.crse||'*'||c.grupo||'*'||fecha_ini);
                        begin

                                select ssbsect_crn , ssbsect_seats_avail lugares, ssbsect_max_enrl cupo_max, SSBSECT_PTRM_CODE,
                                        ssbsect_enrl cupo_Act,    SSBSECT_PTRM_START_DATE, SSBSECT_PTRM_END_DATE, SSBSECT_PTRM_WEEKS,
                                        SSBSECT_CREDIT_HRS, SSBSECT_BILL_HRS, SSBSECT_GMOD_CODE
                                into crn , vn_lugares, vn_cupo_max, parte,
                                       vn_cupo_act, f_inicio, f_fin, sem,
                                       credit, credit_bill, gmod
                                from ssbsect a
                                where a.SSBSECT_TERM_CODE= peri
                                and a.ssbsect_subj_code= c.subj
                               and a.ssbsect_crse_numb=c.crse
                               and a.SSBSECT_SEATS_AVAIL >0
                               AND a.SSBSECT_SEATS_AVAIL = (select max (a1.SSBSECT_SEATS_AVAIL)
                                                                               from ssbsect a1
                                                                                where a.SSBSECT_TERM_CODE = a1.SSBSECT_TERM_CODE
                                                                                and a.ssbsect_subj_code = a1.ssbsect_subj_code
                                                                                and a.ssbsect_crse_numb = a1.ssbsect_crse_numb
                                                                               and trunc (a.SSBSECT_PTRM_START_DATE) = trunc (a1.SSBSECT_PTRM_START_DATE))
                                and trunc (a.SSBSECT_PTRM_START_DATE) = f_inicio;

                        Exception
                        when others then
                            crn:=null;
                            vn_lugares :=0;
                            vn_cupo_max:=0;
                            vn_cupo_act:=0;
                            f_inicio := null;
                            f_fin := null;
                            sem := null;
                            credit  := null;
                            credit_bill  := null;
                            gmod  := null;
                              --dbms_output.put_line ('error de crea consulta '||sqlerrm);
                        end;
                Else
                         --   dbms_output.put_line ('con profesor '||vl_existe);

                       begin
                               select ssbsect_crn , ssbsect_seats_avail lugares, ssbsect_max_enrl cupo_max, SSBSECT_PTRM_CODE,
                                        ssbsect_enrl cupo_Act,    SSBSECT_PTRM_START_DATE, SSBSECT_PTRM_END_DATE, SSBSECT_PTRM_WEEKS,
                                        SSBSECT_CREDIT_HRS, SSBSECT_BILL_HRS, SSBSECT_GMOD_CODE
                                into crn , vn_lugares, vn_cupo_max, parte,
                                       vn_cupo_act, f_inicio, f_fin, sem,
                                       credit, credit_bill, gmod
                                from ssbsect a, sirasgn
                                where a.SSBSECT_TERM_CODE= peri
                                and a.ssbsect_subj_code= c.subj
                               and a.ssbsect_crse_numb=c.crse
                               and a.SSBSECT_SEQ_NUMB = c.grupo
                               and a.SSBSECT_SEATS_AVAIL >0
                                AND to_number (a.ssbsect_crn) = (select max (to_number (a1.ssbsect_crn))
                                                                                from ssbsect a1
                                                                                where a.SSBSECT_TERM_CODE = a1.SSBSECT_TERM_CODE
                                                                                and a.ssbsect_subj_code = a1.ssbsect_subj_code
                                                                                and a.ssbsect_crse_numb = a1.ssbsect_crse_numb
                                                                                and a.SSBSECT_SEQ_NUMB = a1.SSBSECT_SEQ_NUMB
                                                                                and a.SSBSECT_PTRM_START_DATE = a1.SSBSECT_PTRM_START_DATE
                                                                                )
                                and trunc (a.SSBSECT_PTRM_START_DATE) = f_inicio
                               And SIRASGN_PIDM = (select distinct  spriden_pidm
                                                                    from spriden
                                                                    where spriden_id = c.prof
                                                                    And spriden_change_ind is null )
                                And SIRASGN_PRIMARY_IND = 'Y' ;
                               --  dbms_output.put_line ('crea consulta '||peri ||'*'|| c.subj  ||'*'||c.crse||'*'||c.grupo||'*'||f_inicio);

                       Exception
                        when others then
                            crn:=null;
                            vn_lugares :=0;
                            vn_cupo_max:=0;
                            vn_cupo_act:=0;
                            f_inicio := null;
                            f_fin := null;
                            sem := null;
                            credit  := null;
                            credit_bill  := null;
                            gmod  := null;
                           -- dbms_output.put_line ('error de crea consulta '||sqlerrm);
                       end;

                End if;

                         --dbms_output.put_line('valida el CRN:'||crn);

                If crn is not null then

                      --dbms_output.put_line('Existe el Grupo:'||Parte ||' '||c.iden || c.subj ||c.crse);

                    If vn_lugares >0  then
                           -- dbms_output.put_line('Tiene Lugares:'||Parte ||' '||c.iden || c.subj ||c.crse);

                            If credit is null then
                               Begin
                                      select SSRMEET_CREDIT_HR_SESS
                                       Into credit
                                      from SSRMEET
                                      where SSRMEET_TERM_CODE = peri
                                      And SSRMEET_CRN = crn;
                               Exception
                                When Others then
                                   credit :=null;
                                End;

                                  If credit is not null then
                                           Begin
                                               Update ssbsect
                                               set  SSBSECT_CREDIT_HRS = credit
                                               where SSBSECT_TERM_CODE = peri
                                               and SSBSECT_CRN = crn;
                                           Exception
                                           when Others then
                                                null;
                                           End;
                                  End if;
                           End if;

                           If credit_bill is null then
                             Begin
                                     select  SCBCRSE_BILL_HR_LOW
                                        into credit_bill
                                        from scbcrse, scrschd
                                        where scbcrse_subj_code=  c.subj
                                        and     scbcrse_crse_numb=c.crse
                                        and     scbcrse_eff_term='000000'
                                        and     scrschd_subj_code=scbcrse_subj_code
                                        and     scrschd_crse_numb=scbcrse_crse_numb
                                        and     scrschd_eff_term=scbcrse_eff_term;
                             Exception
                             When Others then
                                credit_bill := 3;
                             End;



                                  If credit is not null then
                                           Begin
                                               Update ssbsect
                                               set  SSBSECT_BILL_HRS = credit_bill
                                               where SSBSECT_TERM_CODE = peri
                                               and SSBSECT_CRN = crn;
                                           Exception
                                           when Others then
                                                null;
                                           End;
                                  End if;
                           End if;




                          If gmod is null then
                                begin
                                    select scrgmod_gmod_code
                                    into gmod
                                    from scrgmod
                                    where scrgmod_subj_code=c.subj
                                    and     scrgmod_crse_numb=c.crse
                                    and     scrgmod_default_ind='D';
                                exception when others then
                                    gmod:='1';
                                end;

                                If gmod is not null then
                                           Begin
                                               Update ssbsect
                                               set  SSBSECT_GMOD_CODE = gmod
                                               where SSBSECT_TERM_CODE = peri
                                               and SSBSECT_CRN = crn;
                                           Exception
                                           when Others then
                                                null;
                                           End;
                                end if;

                          End if;


                        conta_ptrm :=0;

                            Begin
                                 select count(*)
                                    into conta_ptrm
                                 from sfbetrm
                                 where sfbetrm_term_code=peri
                                 and     sfbetrm_pidm=c.pidm;
                            Exception
                                When Others then
                                  conta_ptrm := 0;
                            End;


                             if conta_ptrm =0 then
                                    Begin
                                            insert into sfbetrm values(peri, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFNVIN', null, 0,null,null, null,null,user,null);
                                    Exception
                                    When Others then
                                        vl_error := ('Se presento un error al insertar en la tabla sfbetrm  '  ||c.iden || c.subj ||c.crse|| sqlerrm);
                                    End;
                             end if;

                          Begin
                                    select distinct max(sorlcur_key_seqno)
                                        into sp
                                    from sorlcur
                                    where sorlcur_pidm=c.pidm
                                    and     sorlcur_program=c.prog
                                    and     sorlcur_lmod_code='LEARNER';
                           Exception
                           when Others then
                              sp := null;
                              vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                           End;

                           --  calculamos la materi pade
                           begin
                           select GET_MATERIA_PADRE(c.materia)
                           into vmateria_padre
                            from dual;
                           exception when others  then
                               vmateria_padre := '';

                           end;
                           Begin
                               -- dbms_output.put_line('Se inserta en el Grupo:'||Parte ||' '||c.iden || c.subj ||c.crse);
                               insert into sfrstcr values(
                                                                peri,     --SFRSTCR_TERM_CODE
                                                                c.pidm,     --SFRSTCR_PIDM
                                                                crn,     --SFRSTCR_CRN
                                                                1,     --SFRSTCR_CLASS_SORT_KEY
                                                                1,    --SFRSTCR_REG_SEQ
                                                                parte,    --SFRSTCR_PTRM_CODE
                                                                'RE',     --SFRSTCR_RSTS_CODE
                                                                sysdate,    --SFRSTCR_RSTS_DATE
                                                                null,    --SFRSTCR_ERROR_FLAG
                                                                null,    --SFRSTCR_MESSAGE
                                                                credit_bill,    --SFRSTCR_BILL_HR
                                                                3, --SFRSTCR_WAIV_HR
                                                                credit,     --SFRSTCR_CREDIT_HR
                                                                credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                gmod,     --SFRSTCR_GMOD_CODE
                                                                null,    --SFRSTCR_GRDE_CODE
                                                                null,    --SFRSTCR_GRDE_CODE_MID
                                                                null,    --SFRSTCR_GRDE_DATE
                                                                'N',    --SFRSTCR_DUPL_OVER
                                                                'N',    --SFRSTCR_LINK_OVER
                                                                'N',    --SFRSTCR_CORQ_OVER
                                                                'N',    --SFRSTCR_PREQ_OVER
                                                                'N',     --SFRSTCR_TIME_OVER
                                                                'N',     --SFRSTCR_CAPC_OVER
                                                                'N',     --SFRSTCR_LEVL_OVER
                                                                'N',     --SFRSTCR_COLL_OVER
                                                                'N',     --SFRSTCR_MAJR_OVER
                                                                'N',     --SFRSTCR_CLAS_OVER
                                                                'N',     --SFRSTCR_APPR_OVER
                                                                'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                sysdate,      --SFRSTCR_ADD_DATE
                                                                sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                nivel,     --SFRSTCR_LEVL_CODE
                                                                campus,     --SFRSTCR_CAMP_CODE
                                                                vmateria_padre,     --SFRSTCR_RESERVED_KEY
                                                                null,     --SFRSTCR_ATTEND_HR
                                                                'Y',     --SFRSTCR_REPT_OVER
                                                                'N' ,    --SFRSTCR_RPTH_OVER
                                                                null,    --SFRSTCR_TEST_OVER
                                                                'N',    --SFRSTCR_CAMP_OVER
                                                                user,    --SFRSTCR_USER
                                                                'N',    --SFRSTCR_DEGC_OVER
                                                                'N',    --SFRSTCR_PROG_OVER
                                                                null,    --SFRSTCR_LAST_ATTEND
                                                                null,    --SFRSTCR_GCMT_CODE
                                                                'SZFNVIN',    --SFRSTCR_DATA_ORIGIN
                                                                sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                'N',  --SFRSTCR_DEPT_OVER
                                                                'N',  --SFRSTCR_ATTS_OVER
                                                                'N', --SFRSTCR_CHRT_OVER
                                                                null, --SFRSTCR_RMSG_CDE
                                                                null,  --SFRSTCR_WL_PRIORITY
                                                                null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                'N', --SFRSTCR_MEXC_OVER
                                                                sp,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                null,--SFRSTCR_BRDH_SEQ_NUM
                                                                '01',--SFRSTCR_BLCK_CODE
                                                                null,--SFRSTCR_STRH_SEQNO
                                                                null, --SFRSTCR_STRD_SEQNO
                                                                null,  --SFRSTCR_SURROGATE_ID
                                                                null, --SFRSTCR_VERSION
                                                                user,--SFRSTCR_USER_ID
                                                                no_recibo );--SFRSTCR_VPDI_CODE



                                        Begin
                                             update ssbsect
                                                    set ssbsect_enrl = ssbsect_enrl + 1
                                              where SSBSECT_TERM_CODE = peri
                                              And SSBSECT_CRN  = crn;
                                        Exception
                                        When Others then
                                        vl_error := 'Se presento un error al actualizar el enrolamiento ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                        End;

                                        Begin
                                                update ssbsect
                                                    set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                where SSBSECT_TERM_CODE = peri
                                                 And SSBSECT_CRN  = crn;
                                        Exception
                                        When Others then
                                            vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                        End;

                                        Begin
                                                 update ssbsect
                                                        set ssbsect_census_enrl=ssbsect_enrl
                                                 Where SSBSECT_TERM_CODE = peri
                                                 And SSBSECT_CRN  = crn;
                                        Exception
                                        When Others then
                                            vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                        End;


                                        conta_ptrm:=0;

                                        Begin
                                            Select count (*)
                                                Into conta_ptrm
                                            from sfrareg
                                            where SFRAREG_PIDM = c.pidm
                                            And SFRAREG_TERM_CODE = peri
                                            And SFRAREG_CRN = crn
                                            And SFRAREG_EXTENSION_NUMBER = 0
                                            And SFRAREG_RSTS_CODE = 'RE';
                                        Exception
                                        When Others then
                                           conta_ptrm :=0;
                                        End;

                                        If conta_ptrm = 0 then

                                             Begin
                                                     insert into sfrareg values(c.pidm, peri, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFNVIN', sysdate, null,null,null);
                                             Exception
                                               When Others then
                                                  vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                             End;
                                        End if;

                                         vl_existe :=0;

                                          Begin
                                             Select count(1)
                                             Into vl_existe
                                             from SHRINST
                                             Where  SHRINST_TERM_CODE = peri
                                             And SHRINST_CRN = crn
                                             And  SHRINST_PIDM = c.pidm;
                                          Exception
                                          When Others then
                                           vl_existe :=0;
                                          End;


                                          If vl_existe = 0 then
                                                Begin
                                                    Insert into SHRINST values (peri,        --SHRINST_TERM_CODE
                                                                                             crn,       --SHRINST_CRN
                                                                                             c.pidm,       --SHRINST_PIDM
                                                                                             sysdate,       --SHRINST_ACTIVITY_DATE
                                                                                             'Y',       --SHRINST_PRIMARY_IND
                                                                                              null,      --SHRINST_SURROGATE_ID
                                                                                              null,      --SHRINST_VERSION
                                                                                             user,       --SHRINST_USER_ID
                                                                                             'SZFNVIN',       --SHRINST_DATA_ORIGIN
                                                                                              null);      --SHRINST_VPDI_CODE


                                                Exception
                                                    When Others then
                                                     vl_error := 'Se presento un error al insertar al alumno en SHRINST ' ||sqlerrm;
                                                End;

                                          End if;


                                        Begin
                                            Update sgbstdn a
                                            set a.SGBSTDN_STYP_CODE ='N'
                                            Where a.SGBSTDN_PIDM = c.pidm
                                            And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                   from sgbstdn a1
                                                                                                   Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                   --And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1
                                                                                                   )
                                             --And a.SGBSTDN_PROGRAM_1 = c.prog
                                             ;
                                        Exception
                                            When Others then
                                            vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                        End;





                            Exception
                           when Others then
                               vl_error := 'Se presento un error al insertar al alumno en el grupo ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                           End;

                    Else  ----------> Se realizara la creacion del grupo
                            --dbms_output.put_line('SE crea grupo Nuevo por Cupo:'||Parte ||' '||c.iden || c.subj ||c.crse);

                            schd := null;
                            title := null;
                            credit := null;
                            gmod :=null;
                            credit_bill :=null;

                            Begin
                                select scrschd_schd_code, scbcrse_title, scbcrse_credit_hr_low, SCBCRSE_BILL_HR_LOW
                                into schd, title, credit, credit_bill
                                from scbcrse, scrschd
                                where scbcrse_subj_code=c.subj
                                and     scbcrse_crse_numb=c.crse
                                and     scbcrse_eff_term='000000'
                                and     scrschd_subj_code=scbcrse_subj_code
                                and     scrschd_crse_numb=scbcrse_crse_numb
                                and     scrschd_eff_term=scbcrse_eff_term;
                            Exception
                            When Others then
                                  schd := null;
                                  title := null;
                                  credit := null;
                                  credit_bill := null;
                            End;


                            begin
                                select scrgmod_gmod_code
                                      into gmod
                                from scrgmod
                                where scrgmod_subj_code=c.subj
                                and     scrgmod_crse_numb=c.crse
                                and     scrgmod_default_ind='D';
                            exception when others then
                                gmod:='1';
                            end;

                             Begin

                                            if nivel ='MS' then

                                                        l_campus_ms:='AS';
                                                    else
                                                        l_campus_ms:=niVel;

                                            end if;



                                                select sztcrnv_crn
                                                into crn
                                                from SZTCRNV
                                                where 1 = 1
                                                and rownum = 1
                                                AND SZTCRNV_LVEL_CODE = SUBSTR(l_campus_ms,1,1)
                                                and (SZTCRNV_crn,SZTCRNV_LVEL_CODE) not in (select to_number(crn),
                                                                                                   substr(SSBSECT_CRN,1,1)
                                                                                           from
                                                                                           (
                                                                                           select case when
                                                                                                          substr(SSBSECT_CRN,1,1) in(SELECT ZSTPARA_PARAM_VALOR
                                                                                                        FROM ZSTPARA
                                                                                                        WHERE 1=1
                                                                                                        AND ZSTPARA_MAPA_ID =  'LETRAS_CRN') then to_number(substr(SSBSECT_CRN,2,10))
                                                                                                         else
                                                                                                               to_number(SSBSECT_CRN)
                                                                                            end crn,
                                                                                                         SSBSECT_CRN
                                                                                               from ssbsect
                                                                                               where 1 = 1
                                                                                               and ssbsect_term_code=  c.pperiodo
                                                --                                               AND SUBSTR(SSBSECT_CRN,1,1) !='L'
                                                                                           )
                                                                                           where 1 = 1
                                                                                           );

                                                dbms_output.put_line(' Recupero el CRN '||crn);


                                     --------si estra aqui entonces le agrega su letra
                                              if  nivel ='LI' then
                                                crn:='L'||crn;

                                                elsif  nivel ='MA' then
                                                crn:='M'||crn;

                                                elsif  nivel ='MS' then
                                                crn:='A'||crn;

                                                elsif  nivel ='DO' then
                                                crn:='D'||crn;

                                                elsif  nivel ='BA' then
                                                 crn:='B'||crn;

                                                elsif  nivel ='EC' then
                                                 crn:='E'||crn;

                                                elsif  nivel ='ID' then
                                                 crn:='I'||crn;

                                                end if;



                              Exception
                                    When Others then
                                       crn := null;
                             End;

                             If crn is not null then
                                   Begin
                                       select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                                       into f_inicio, f_fin, sem
                                       from sobptrm
                                       where sobptrm_term_code=Peri
                                       and     sobptrm_ptrm_code=parte;
                                   Exception
                                   When Others then
                                    f_inicio:= null;
                                    f_fin := null;
                                    sem :=null;
                                   End;

                             --dbms_output.put_line('SE crea grupo Nuevo por Cupo ahora:'||Parte ||' '||c.iden ||'*'|| c.subj ||c.crse||'*'||crn);

                                  Begin
                                        Insert into ssbsect values (
                                                                           Peri,     --SSBSECT_TERM_CODE
                                                                           crn,     --SSBSECT_CRN
                                                                           parte,     --SSBSECT_PTRM_CODE
                                                                           c.subj,     --SSBSECT_SUBJ_CODE
                                                                           c.crse,     --SSBSECT_CRSE_NUMB
                                                                            '01',     --SSBSECT_SEQ_NUMB
                                                                            'A',    --SSBSECT_SSTS_CODE
                                                                            schd,    --SSBSECT_SCHD_CODE
                                                                            campus,    --SSBSECT_CAMP_CODE
                                                                             title,   --SSBSECT_CRSE_TITLE
                                                                             credit,   --SSBSECT_CREDIT_HRS
                                                                             credit_bill,   --SSBSECT_BILL_HRS
                                                                             gmod,   --SSBSECT_GMOD_CODE
                                                                              null,  --SSBSECT_SAPR_CODE
                                                                              null, --SSBSECT_SESS_CODE
                                                                              null,  --SSBSECT_LINK_IDENT
                                                                              null,  --SSBSECT_PRNT_IND
                                                                              'Y',  --SSBSECT_GRADABLE_IND
                                                                               null,  --SSBSECT_TUIW_IND
                                                                               0, --SSBSECT_REG_ONEUP
                                                                               0, --SSBSECT_PRIOR_ENRL
                                                                               0, --SSBSECT_PROJ_ENRL
                                                                               50, --SSBSECT_MAX_ENRL
                                                                                0,--SSBSECT_ENRL
                                                                                50,--SSBSECT_SEATS_AVAIL
                                                                                null,--SSBSECT_TOT_CREDIT_HRS
                                                                                '0',--SSBSECT_CENSUS_ENRL
                                                                                f_inicio,--SSBSECT_CENSUS_ENRL_DATE
                                                                                sysdate,--SSBSECT_ACTIVITY_DATE
                                                                                f_inicio,--SSBSECT_PTRM_START_DATE
                                                                                f_fin,--SSBSECT_PTRM_END_DATE
                                                                                sem,--SSBSECT_PTRM_WEEKS
                                                                                null,--SSBSECT_RESERVED_IND
                                                                                null, --SSBSECT_WAIT_CAPACITY
                                                                                null,--SSBSECT_WAIT_COUNT
                                                                                null,--SSBSECT_WAIT_AVAIL
                                                                                null,--SSBSECT_LEC_HR
                                                                                null,--SSBSECT_LAB_HR
                                                                                null,--SSBSECT_OTH_HR
                                                                                null,--SSBSECT_CONT_HR
                                                                                null,--SSBSECT_ACCT_CODE
                                                                                null,--SSBSECT_ACCL_CODE
                                                                                null,--SSBSECT_CENSUS_2_DATE
                                                                                null,--SSBSECT_ENRL_CUT_OFF_DATE
                                                                                null,--SSBSECT_ACAD_CUT_OFF_DATE
                                                                                null,--SSBSECT_DROP_CUT_OFF_DATE
                                                                                null,--SSBSECT_CENSUS_2_ENRL
                                                                                'Y',--SSBSECT_VOICE_AVAIL
                                                                                'N',--SSBSECT_CAPP_PREREQ_TEST_IND
                                                                                null,--SSBSECT_GSCH_NAME
                                                                                null,--SSBSECT_BEST_OF_COMP
                                                                                null,--SSBSECT_SUBSET_OF_COMP
                                                                                'NOP',--SSBSECT_INSM_CODE
                                                                                null,--SSBSECT_REG_FROM_DATE
                                                                                null,--SSBSECT_REG_TO_DATE
                                                                                null,--SSBSECT_LEARNER_REGSTART_FDATE
                                                                                null,--SSBSECT_LEARNER_REGSTART_TDATE
                                                                                null,--SSBSECT_DUNT_CODE
                                                                                null,--SSBSECT_NUMBER_OF_UNITS
                                                                                0,--SSBSECT_NUMBER_OF_EXTENSIONS
                                                                                'SZFNVIN',--SSBSECT_DATA_ORIGIN
                                                                                user,--SSBSECT_USER_ID
                                                                                'MOOD',--SSBSECT_INTG_CDE
                                                                                'B',--SSBSECT_PREREQ_CHK_METHOD_CDE
                                                                                user,--SSBSECT_KEYWORD_INDEX_ID
                                                                                null,--SSBSECT_SCORE_OPEN_DATE
                                                                                null,--SSBSECT_SCORE_CUTOFF_DATE
                                                                                null,--SSBSECT_REAS_SCORE_OPEN_DATE
                                                                                null,--SSBSECT_REAS_SCORE_CTOF_DATE
                                                                                null,--SSBSECT_SURROGATE_ID
                                                                                null,--SSBSECT_VERSION
                                                                                 null);--SSBSECT_VPDI_CODE

                                                   Begin
                                                        insert into ssrmeet values(peri, crn, null,null,null,null,null,null, sysdate, f_inicio, f_fin, '01', null,null,null,null,null,null,null, 'ENL', null, credit, null, 0, null,null,null, 'CLVI', 'SZFNVIN', user, null,null,null);
                                                    Exception
                                                    when Others then
                                                       vl_error := 'Se presento un Error al insertar en ssrmeet ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                                   End;

                                                   pidm_prof := null;

                                                    begin
                                                    select spriden_pidm into pidm_prof
                                                    from  spriden
                                                    where   spriden_id=c.prof and spriden_change_ind is null;
                                                    exception when others then
                                                    pidm_prof:=null;
                                                    end;

                                                   conta_ptrm :=0;
                                                  Begin
                                                    Select count (1)
                                                        Into conta_ptrm
                                                    from sirasgn
                                                    Where SIRASGN_TERM_CODE = peri
                                                    And SIRASGN_CRN = crn
                                                    and  SIRASGN_PIDM = pidm_prof
                                                    And SIRASGN_PRIMARY_IND = 'Y';
                                                  Exception
                                                  When Others then
                                                   conta_ptrm :=0;
                                                  End;



                                                     if pidm_prof is not null and conta_ptrm = 0 then
                                                        Begin
                                                                insert into sirasgn values(peri, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,  sysdate, null,null,null,null, 'SZFNVIN', user, null, null, null, null,  null,null);
                                                        Exception
                                                        When Others then
                                                        null;
                                                        End;
                                                     end if;


                                                conta_ptrm :=0;

                                                    Begin
                                                         select count(*)
                                                            into conta_ptrm
                                                         from sfbetrm
                                                         where sfbetrm_term_code=peri
                                                         and     sfbetrm_pidm=c.pidm;
                                                    Exception
                                                        When Others then
                                                          conta_ptrm := 0;
                                                    End;


                                                     if conta_ptrm =0 then
                                                            Begin
                                                                    insert into sfbetrm values(peri, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFNVIN', null, 0,null,null, null,null,user,null);
                                                            Exception
                                                            When Others then
                                                                vl_error := ('Se presento un error al insertar en la tabla sfbetrm ' ||c.iden || c.subj ||c.crse || sqlerrm);
                                                            End;
                                                     end if;



                                                    Begin
                                                        select sgbstdn_levl_code, sgbstdn_camp_code  into levl, camp
                                                        from sgbstdn a
                                                        where sgbstdn_pidm=c.pidm
                                                        and     sgbstdn_term_code_eff  in (select max(sgbstdn_term_code_eff) from sgbstdn aa
                                                                                                           where a.sgbstdn_pidm=aa.sgbstdn_pidm);
                                                    Exception
                                                    When Others then
                                                       levl := null;
                                                       camp := null;
                                                       vl_error := 'Se presento un error al obtener la informacion de SGBSTDN '||c.iden || c.subj ||c.crse || sqlerrm;
                                                    End;

                                                   Begin
                                                            select distinct max(sorlcur_key_seqno)
                                                                into sp
                                                            from sorlcur
                                                            where sorlcur_pidm=c.pidm
                                                            and     sorlcur_program=c.prog
                                                            and     sorlcur_lmod_code='LEARNER';
                                                   Exception
                                                   when Others then
                                                      sp := null;
                                                      vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                   End;

                                          --  calculamos la materi pade
                                           begin
                                           select GET_MATERIA_PADRE(c.materia)
                                           into vmateria_padre
                                            from dual;
                                           exception when others  then
                                               vmateria_padre := '';

                                           end;

                                                   Begin

                                                       insert into sfrstcr values(
                                                                                        peri,     --SFRSTCR_TERM_CODE
                                                                                        c.pidm,     --SFRSTCR_PIDM
                                                                                        crn,     --SFRSTCR_CRN
                                                                                        1,     --SFRSTCR_CLASS_SORT_KEY
                                                                                        1,    --SFRSTCR_REG_SEQ
                                                                                        parte,    --SFRSTCR_PTRM_CODE
                                                                                        'RE',     --SFRSTCR_RSTS_CODE
                                                                                        sysdate,    --SFRSTCR_RSTS_DATE
                                                                                        null,    --SFRSTCR_ERROR_FLAG
                                                                                        null,    --SFRSTCR_MESSAGE
                                                                                        credit_bill,    --SFRSTCR_BILL_HR
                                                                                        3, --SFRSTCR_WAIV_HR
                                                                                        credit,     --SFRSTCR_CREDIT_HR
                                                                                        credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                                        credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                                        gmod,     --SFRSTCR_GMOD_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE_MID
                                                                                        null,    --SFRSTCR_GRDE_DATE
                                                                                        'N',    --SFRSTCR_DUPL_OVER
                                                                                        'N',    --SFRSTCR_LINK_OVER
                                                                                        'N',    --SFRSTCR_CORQ_OVER
                                                                                        'N',    --SFRSTCR_PREQ_OVER
                                                                                        'N',     --SFRSTCR_TIME_OVER
                                                                                        'N',     --SFRSTCR_CAPC_OVER
                                                                                        'N',     --SFRSTCR_LEVL_OVER
                                                                                        'N',     --SFRSTCR_COLL_OVER
                                                                                        'N',     --SFRSTCR_MAJR_OVER
                                                                                        'N',     --SFRSTCR_CLAS_OVER
                                                                                        'N',     --SFRSTCR_APPR_OVER
                                                                                        'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                                        sysdate,      --SFRSTCR_ADD_DATE
                                                                                        sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                                        levl,     --SFRSTCR_LEVL_CODE
                                                                                        camp,     --SFRSTCR_CAMP_CODE
                                                                                        vmateria_padre,     --SFRSTCR_RESERVED_KEY
                                                                                        null,     --SFRSTCR_ATTEND_HR
                                                                                        'Y',     --SFRSTCR_REPT_OVER
                                                                                        'N' ,    --SFRSTCR_RPTH_OVER
                                                                                        null,    --SFRSTCR_TEST_OVER
                                                                                        'N',    --SFRSTCR_CAMP_OVER
                                                                                        user,    --SFRSTCR_USER
                                                                                        'N',    --SFRSTCR_DEGC_OVER
                                                                                        'N',    --SFRSTCR_PROG_OVER
                                                                                        null,    --SFRSTCR_LAST_ATTEND
                                                                                        null,    --SFRSTCR_GCMT_CODE
                                                                                        'SZFNVIN',    --SFRSTCR_DATA_ORIGIN
                                                                                        sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                                        'N',  --SFRSTCR_DEPT_OVER
                                                                                        'N',  --SFRSTCR_ATTS_OVER
                                                                                        'N', --SFRSTCR_CHRT_OVER
                                                                                        null, --SFRSTCR_RMSG_CDE
                                                                                        null,  --SFRSTCR_WL_PRIORITY
                                                                                        null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                                        null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                                        null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                                        'N', --SFRSTCR_MEXC_OVER
                                                                                        sp,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                                        null,--SFRSTCR_BRDH_SEQ_NUM
                                                                                        '01',--SFRSTCR_BLCK_CODE
                                                                                        null,--SFRSTCR_STRH_SEQNO
                                                                                        null, --SFRSTCR_STRD_SEQNO
                                                                                        null,  --SFRSTCR_SURROGATE_ID
                                                                                        null, --SFRSTCR_VERSION
                                                                                        user,--SFRSTCR_USER_ID
                                                                                        no_recibo );--SFRSTCR_VPDI_CODE



                                                                Begin
                                                                     update ssbsect
                                                                            set ssbsect_enrl = ssbsect_enrl + 1
                                                                      where SSBSECT_TERM_CODE = peri
                                                                      And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                vl_error := 'Se presento un error al actualizar el enrolamiento '||c.iden || c.subj ||c.crse ||sqlerrm;
                                                                End;

                                                                Begin
                                                                        update ssbsect
                                                                            set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                                        where SSBSECT_TERM_CODE = peri
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                                                End;

                                                                Begin
                                                                         update ssbsect
                                                                                set ssbsect_census_enrl=ssbsect_enrl
                                                                         Where SSBSECT_TERM_CODE = peri
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                                End;


                                                                conta_ptrm:=0;

                                                                Begin
                                                                    Select count (*)
                                                                        Into conta_ptrm
                                                                    from sfrareg
                                                                    where SFRAREG_PIDM = c.pidm
                                                                    And SFRAREG_TERM_CODE = peri
                                                                    And SFRAREG_CRN = crn
                                                                    And SFRAREG_EXTENSION_NUMBER = 0
                                                                    And SFRAREG_RSTS_CODE = 'RE';
                                                                Exception
                                                                When Others then
                                                                   conta_ptrm :=0;
                                                                End;

                                                                If conta_ptrm = 0 then

                                                                     Begin
                                                                             insert into sfrareg values(c.pidm, peri, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFNVIN', sysdate, null,null,null);
                                                                     Exception
                                                                       When Others then
                                                                          vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                                                     End;
                                                                End if;

                                                                vl_existe :=0;

                                                                Begin
                                                                 Select count(1)
                                                                 Into vl_existe
                                                                 from SHRINST
                                                                 Where  SHRINST_TERM_CODE = peri
                                                                 And SHRINST_CRN = crn
                                                                 And  SHRINST_PIDM = c.pidm;
                                                                Exception
                                                                When Others then
                                                                 vl_existe :=0;
                                                                End;

                                                              If vl_existe = 0 then
                                                                    Begin
                                                                        Insert into SHRINST values (peri,        --SHRINST_TERM_CODE
                                                                                                                 crn,       --SHRINST_CRN
                                                                                                                 c.pidm,       --SHRINST_PIDM
                                                                                                                 sysdate,       --SHRINST_ACTIVITY_DATE
                                                                                                                 'Y',       --SHRINST_PRIMARY_IND
                                                                                                                  null,      --SHRINST_SURROGATE_ID
                                                                                                                  null,      --SHRINST_VERSION
                                                                                                                 user,       --SHRINST_USER_ID
                                                                                                                 'SZFNVIN',       --SHRINST_DATA_ORIGIN
                                                                                                                  null);      --SHRINST_VPDI_CODE


                                                                    Exception
                                                                        When Others then
                                                                         vl_error := 'Se presento un error al insertar al alumno en SHRINST ' ||sqlerrm;
                                                                    End;

                                                              End if;

                                                               Begin
                                                                    Update sgbstdn a
                                                                    set a.SGBSTDN_STYP_CODE ='N'
                                                                    Where a.SGBSTDN_PIDM = c.pidm
                                                                    And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                                           from sgbstdn a1
                                                                                                                           Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                                           --And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1
                                                                                                                           )
                                                                     --And a.SGBSTDN_PROGRAM_1 = c.prog
                                                                     ;
                                                               Exception
                                                                    When Others then
                                                                    vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                                               End;


                                                    Exception
                                                   when Others then
                                                       vl_error := 'Se presento un error al insertar al alumno en el grupo ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                                   End;


                                  Exception
                                    When Others then
                                      vl_error := 'Se presento un Error al insertar el nuevo grupo 1 ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                  End;
                             End if;

                     --dbms_output.put_line('mensaje:'|| 'No hay grupo cupo');
                     End if;
                Else
                    --dbms_output.put_line('mensaje:'|| 'No hay grupo creado Nuevo');
                            schd := null;
                            title := null;
                            credit := null;
                            gmod :=null;
                            credit_bill :=null;

                        --dbms_output.put_line('Entra a buscar informacion '||c.iden || c.subj ||c.crse );
                            Begin
                                select scrschd_schd_code, scbcrse_title, scbcrse_credit_hr_low, SCBCRSE_BILL_HR_LOW
                                into schd, title, credit, credit_bill
                                from scbcrse, scrschd
                                where scbcrse_subj_code=c.subj
                                and     scbcrse_crse_numb=c.crse
                                and     scbcrse_eff_term='000000'
                                and     scrschd_subj_code=scbcrse_subj_code
                                and     scrschd_crse_numb=scbcrse_crse_numb
                                and     scrschd_eff_term=scbcrse_eff_term;
                            Exception
                            When Others then
                                  schd := null;
                                  title := null;
                                  credit := null;
                                  credit_bill := null;
                            End;


                            begin
                                select scrgmod_gmod_code
                                      into gmod
                                from scrgmod
                                where scrgmod_subj_code=c.subj
                                and     scrgmod_crse_numb=c.crse
                                and     scrgmod_default_ind='D';
                            exception when others then
                                gmod:='1';
                            end;

                             Begin
                               --     select nvl(max(ssbsect_crn),1000)+1
                                 --        into crn
                                   --       from ssbsect where ssbsect_term_code= peri;
                                    BEGIN

                                                select sztcrnv_crn
                                                into crn
                                                from SZTCRNV
                                                where 1 = 1
                                                and rownum = 1
                                                AND SZTCRNV_LVEL_CODE = SUBSTR(l_campus_ms,1,1)
                                                and (SZTCRNV_crn,SZTCRNV_LVEL_CODE) not in (select to_number(crn),
                                                                                                   substr(SSBSECT_CRN,1,1)
                                                                                           from
                                                                                           (
                                                                                           select case when
                                                                                                          substr(SSBSECT_CRN,1,1) in(SELECT ZSTPARA_PARAM_VALOR
                                                                                                        FROM ZSTPARA
                                                                                                        WHERE 1=1
                                                                                                        AND ZSTPARA_MAPA_ID =  'LETRAS_CRN') then to_number(substr(SSBSECT_CRN,2,10))
                                                                                                         else
                                                                                                        to_number(SSBSECT_CRN)
                                                                                            end crn,
                                                                                                         SSBSECT_CRN
                                                                                               from ssbsect
                                                                                               where 1 = 1
                                                                                               and ssbsect_term_code=  c.pperiodo
                                                --                                               AND SUBSTR(SSBSECT_CRN,1,1) !='L'
                                                                                           )
                                                                                           where 1 = 1
                                                                                           );

                                                              --------si estra aqui entonces le agrega su letra
                                                if nivel ='LI' then
                                                crn:='L'||crn;

                                                elsif  nivel ='MA' then
                                                crn:='M'||crn;

                                                elsif  nivel ='MS' then
                                                crn:='A'||crn;

                                                elsif  nivel ='DO' then
                                                crn:='D'||crn;

                                                elsif  nivel ='BA' then
                                                 crn:='B'||crn;

                                                elsif  nivel ='EC' then
                                                 crn:='E'||crn;

                                                elsif  nivel ='ID' then
                                                 crn:='I'||crn;

                                              end if;

                                      EXCEPTION WHEN OTHERS THEN
                                               -- raise_application_error (-20002,'Error al 2  '|| SQLCODE||' Error: '||SQLERRM);
                                         --       dbms_output.put_line(' error en crn 2 '||sqlerrm);
                                                crn := NULL;
                                   END;



                              Exception
                                    When Others then
                                       crn := null;
                             End;

                             If crn is not null then
                             --dbms_output.put_line('entra a crear el grupo '||c.iden || c.subj ||c.crse );

                                   Begin
                                       select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                                       into f_inicio, f_fin, sem
                                       from sobptrm
                                       where sobptrm_term_code=Peri
                                       and     sobptrm_ptrm_code=parte;
                                   Exception
                                   When Others then
                                    f_inicio:= null;
                                    f_fin := null;
                                    sem :=null;
                                   End;

                              --dbms_output.put_line('entra a crear el grupo ssbsect '||c.iden || c.subj ||c.crse ||'*'||crn||'*'||f_inicio);

                                                    Begin
                                                            Insert into ssbsect values (
                                                                                               Peri,     --SSBSECT_TERM_CODE
                                                                                               crn,     --SSBSECT_CRN
                                                                                               parte,     --SSBSECT_PTRM_CODE
                                                                                               c.subj,     --SSBSECT_SUBJ_CODE
                                                                                               c.crse,     --SSBSECT_CRSE_NUMB
                                                                                                '01',     --SSBSECT_SEQ_NUMB
                                                                                                'A',    --SSBSECT_SSTS_CODE
                                                                                                schd,    --SSBSECT_SCHD_CODE
                                                                                                campus,    --SSBSECT_CAMP_CODE
                                                                                                 title,   --SSBSECT_CRSE_TITLE
                                                                                                 credit,   --SSBSECT_CREDIT_HRS
                                                                                                 credit_bill,   --SSBSECT_BILL_HRS
                                                                                                 gmod,   --SSBSECT_GMOD_CODE
                                                                                                  null,  --SSBSECT_SAPR_CODE
                                                                                                  null, --SSBSECT_SESS_CODE
                                                                                                  null,  --SSBSECT_LINK_IDENT
                                                                                                  null,  --SSBSECT_PRNT_IND
                                                                                                  'Y',  --SSBSECT_GRADABLE_IND
                                                                                                   null,  --SSBSECT_TUIW_IND
                                                                                                   0, --SSBSECT_REG_ONEUP
                                                                                                   0, --SSBSECT_PRIOR_ENRL
                                                                                                   0, --SSBSECT_PROJ_ENRL
                                                                                                   50, --SSBSECT_MAX_ENRL
                                                                                                    0,--SSBSECT_ENRL
                                                                                                    50,--SSBSECT_SEATS_AVAIL
                                                                                                    null,--SSBSECT_TOT_CREDIT_HRS
                                                                                                    '0',--SSBSECT_CENSUS_ENRL
                                                                                                    f_inicio,--SSBSECT_CENSUS_ENRL_DATE
                                                                                                    sysdate,--SSBSECT_ACTIVITY_DATE
                                                                                                    f_inicio,--SSBSECT_PTRM_START_DATE
                                                                                                    f_fin,--SSBSECT_PTRM_END_DATE
                                                                                                    sem,--SSBSECT_PTRM_WEEKS
                                                                                                    null,--SSBSECT_RESERVED_IND
                                                                                                    null, --SSBSECT_WAIT_CAPACITY
                                                                                                    null,--SSBSECT_WAIT_COUNT
                                                                                                    null,--SSBSECT_WAIT_AVAIL
                                                                                                    null,--SSBSECT_LEC_HR
                                                                                                    null,--SSBSECT_LAB_HR
                                                                                                    null,--SSBSECT_OTH_HR
                                                                                                    null,--SSBSECT_CONT_HR
                                                                                                    null,--SSBSECT_ACCT_CODE
                                                                                                    null,--SSBSECT_ACCL_CODE
                                                                                                    null,--SSBSECT_CENSUS_2_DATE
                                                                                                    null,--SSBSECT_ENRL_CUT_OFF_DATE
                                                                                                    null,--SSBSECT_ACAD_CUT_OFF_DATE
                                                                                                    null,--SSBSECT_DROP_CUT_OFF_DATE
                                                                                                    null,--SSBSECT_CENSUS_2_ENRL
                                                                                                    'Y',--SSBSECT_VOICE_AVAIL
                                                                                                    'N',--SSBSECT_CAPP_PREREQ_TEST_IND
                                                                                                    null,--SSBSECT_GSCH_NAME
                                                                                                    null,--SSBSECT_BEST_OF_COMP
                                                                                                    null,--SSBSECT_SUBSET_OF_COMP
                                                                                                    'NOP',--SSBSECT_INSM_CODE
                                                                                                    null,--SSBSECT_REG_FROM_DATE
                                                                                                    null,--SSBSECT_REG_TO_DATE
                                                                                                    null,--SSBSECT_LEARNER_REGSTART_FDATE
                                                                                                    null,--SSBSECT_LEARNER_REGSTART_TDATE
                                                                                                    null,--SSBSECT_DUNT_CODE
                                                                                                    null,--SSBSECT_NUMBER_OF_UNITS
                                                                                                    0,--SSBSECT_NUMBER_OF_EXTENSIONS
                                                                                                    'SZFNVIN',--SSBSECT_DATA_ORIGIN
                                                                                                    user,--SSBSECT_USER_ID
                                                                                                    'MOOD',--SSBSECT_INTG_CDE
                                                                                                    'B',--SSBSECT_PREREQ_CHK_METHOD_CDE
                                                                                                    user,--SSBSECT_KEYWORD_INDEX_ID
                                                                                                    null,--SSBSECT_SCORE_OPEN_DATE
                                                                                                    null,--SSBSECT_SCORE_CUTOFF_DATE
                                                                                                    null,--SSBSECT_REAS_SCORE_OPEN_DATE
                                                                                                    null,--SSBSECT_REAS_SCORE_CTOF_DATE
                                                                                                    null,--SSBSECT_SURROGATE_ID
                                                                                                    null,--SSBSECT_VERSION
                                                                                                     null);--SSBSECT_VPDI_CODE
                                                    Exception
                                                    When Others then
                                                      vl_error := 'Se presento un Error al insertar en SSBSECT Grupo Nuevo ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                    End;

                                                    --dbms_output.put_line('Grupo creado el grupo ssbsect '||c.iden || c.subj ||c.crse );
                                                   Begin
                                                        insert into ssrmeet values(peri, crn, null,null,null,null,null,null, sysdate, f_inicio, f_fin, '01', null,null,null,null,null,null,null, 'ENL', null, credit, null, 0, null,null,null, 'CLVI', 'SZFNVIN', user, null,null,null);
                                                    Exception
                                                    when Others then
                                                       vl_error := 'Se presento un Error al insertar en ssrmeet ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                   End;

                                                              -- dbms_output.put_line('Grupo creado el grupo ssrmeet '||c.iden || c.subj ||c.crse );

                                                    begin
                                                        select spriden_pidm
                                                         into pidm_prof
                                                        from  spriden
                                                        where   spriden_id= '019814933' and spriden_change_ind is null;
                                                    Exception when others then
                                                      pidm_prof:=null;
                                                    End;



                                                       conta_ptrm := 0;

                                                     Begin
                                                        Select count (1)
                                                            Into conta_ptrm
                                                        from sirasgn
                                                        Where SIRASGN_TERM_CODE = peri
                                                        And SIRASGN_CRN = crn
                                                        and  SIRASGN_PIDM = pidm_prof
                                                        And SIRASGN_PRIMARY_IND = 'Y';
                                                     Exception
                                                      When Others then
                                                       conta_ptrm :=0;
                                                     End;


                                                     if pidm_prof is not null and conta_ptrm = 0 then

                                                        Begin
                                                                insert into sirasgn values(ciclo, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,  sysdate, null,null,null,null, 'SZFNVIN', user, null, null, null, null,  null,null);
                                                        Exception
                                                        When Others then
                                                        null;
                                                        End;
                                                    end if;


                                                conta_ptrm :=0;

                                                    Begin
                                                         select count(*)
                                                            into conta_ptrm
                                                         from sfbetrm
                                                         where sfbetrm_term_code=peri
                                                         and     sfbetrm_pidm=c.pidm;
                                                    Exception
                                                        When Others then
                                                          conta_ptrm := 0;
                                                    End;


                                                     if conta_ptrm =0 then
                                                            Begin
                                                                    insert into sfbetrm values(peri, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFNVIN', null, 0,null,null, null,null,user,null);
                                                            Exception
                                                            When Others then
                                                                vl_error := ('Se presento un error al insertar en la tabla sfbetrm ' ||c.iden || c.subj ||c.crse || sqlerrm);
                                                            End;
                                                     end if;




                                                   Begin
                                                            select distinct max(sorlcur_key_seqno)
                                                                into sp
                                                            from sorlcur
                                                            where sorlcur_pidm=c.pidm
                                                            and     sorlcur_program=c.prog
                                                            and     sorlcur_lmod_code='LEARNER';
                                                   Exception
                                                   when Others then
                                                      sp := null;
                                                      vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                   End;

                                        --  calculamos la materi pade
                                                   begin
                                                   select GET_MATERIA_PADRE(c.materia)
                                                   into vmateria_padre
                                                    from dual;
                                                   exception when others  then
                                                       vmateria_padre := '';

                                                   end;

                                                   Begin

                                                   --dbms_output.put_line('registra en Inscripciont '||c.iden || c.subj ||c.crse ||'*'||crn );

                                                       insert into sfrstcr values(
                                                                                        peri,     --SFRSTCR_TERM_CODE
                                                                                        c.pidm,     --SFRSTCR_PIDM
                                                                                        crn,     --SFRSTCR_CRN
                                                                                        1,     --SFRSTCR_CLASS_SORT_KEY
                                                                                        1,    --SFRSTCR_REG_SEQ
                                                                                        parte,    --SFRSTCR_PTRM_CODE
                                                                                        'RE',     --SFRSTCR_RSTS_CODE
                                                                                        sysdate,    --SFRSTCR_RSTS_DATE
                                                                                        null,    --SFRSTCR_ERROR_FLAG
                                                                                        null,    --SFRSTCR_MESSAGE
                                                                                        credit_bill,    --SFRSTCR_BILL_HR
                                                                                        3, --SFRSTCR_WAIV_HR
                                                                                        credit,     --SFRSTCR_CREDIT_HR
                                                                                        credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                                        credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                                        gmod,     --SFRSTCR_GMOD_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE_MID
                                                                                        null,    --SFRSTCR_GRDE_DATE
                                                                                        'N',    --SFRSTCR_DUPL_OVER
                                                                                        'N',    --SFRSTCR_LINK_OVER
                                                                                        'N',    --SFRSTCR_CORQ_OVER
                                                                                        'N',    --SFRSTCR_PREQ_OVER
                                                                                        'N',     --SFRSTCR_TIME_OVER
                                                                                        'N',     --SFRSTCR_CAPC_OVER
                                                                                        'N',     --SFRSTCR_LEVL_OVER
                                                                                        'N',     --SFRSTCR_COLL_OVER
                                                                                        'N',     --SFRSTCR_MAJR_OVER
                                                                                        'N',     --SFRSTCR_CLAS_OVER
                                                                                        'N',     --SFRSTCR_APPR_OVER
                                                                                        'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                                        sysdate,      --SFRSTCR_ADD_DATE
                                                                                        sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                                        nivel,     --SFRSTCR_LEVL_CODE
                                                                                        campus,     --SFRSTCR_CAMP_CODE
                                                                                        vmateria_padre,     --SFRSTCR_RESERVED_KEY
                                                                                        null,     --SFRSTCR_ATTEND_HR
                                                                                        'Y',     --SFRSTCR_REPT_OVER
                                                                                        'N' ,    --SFRSTCR_RPTH_OVER
                                                                                        null,    --SFRSTCR_TEST_OVER
                                                                                        'N',    --SFRSTCR_CAMP_OVER
                                                                                        user,    --SFRSTCR_USER
                                                                                        'N',    --SFRSTCR_DEGC_OVER
                                                                                        'N',    --SFRSTCR_PROG_OVER
                                                                                        null,    --SFRSTCR_LAST_ATTEND
                                                                                        null,    --SFRSTCR_GCMT_CODE
                                                                                        'SZFNVIN',    --SFRSTCR_DATA_ORIGIN
                                                                                        sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                                        'N',  --SFRSTCR_DEPT_OVER
                                                                                        'N',  --SFRSTCR_ATTS_OVER
                                                                                        'N', --SFRSTCR_CHRT_OVER
                                                                                        null, --SFRSTCR_RMSG_CDE
                                                                                        null,  --SFRSTCR_WL_PRIORITY
                                                                                        null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                                        null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                                        null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                                        'N', --SFRSTCR_MEXC_OVER
                                                                                        sp,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                                        null,--SFRSTCR_BRDH_SEQ_NUM
                                                                                        '01',--SFRSTCR_BLCK_CODE
                                                                                        null,--SFRSTCR_STRH_SEQNO
                                                                                        null, --SFRSTCR_STRD_SEQNO
                                                                                        null,  --SFRSTCR_SURROGATE_ID
                                                                                        null, --SFRSTCR_VERSION
                                                                                        user,--SFRSTCR_USER_ID
                                                                                        no_recibo );--SFRSTCR_VPDI_CODE

                                                       --dbms_output.put_line('registra en Inscripcion dos '||c.iden || c.subj ||c.crse ||'*'||crn );



                                                                            Begin
                                                                                 update ssbsect
                                                                                        set ssbsect_enrl = ssbsect_enrl + 1
                                                                                  where SSBSECT_TERM_CODE = peri
                                                                                  And SSBSECT_CRN  = crn;
                                                                            Exception
                                                                            When Others then
                                                                            vl_error := 'Se presento un error al actualizar el enrolamiento ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                                            End;

                                                                                                                            --dbms_output.put_line('Actualiza sssbsecx '||c.iden || c.subj ||c.crse ||'*'||crn );

                                                                            Begin
                                                                                    update ssbsect
                                                                                        set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                                                    where SSBSECT_TERM_CODE = peri
                                                                                     And SSBSECT_CRN  = crn;
                                                                            Exception
                                                                            When Others then
                                                                                vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                                            End;

                                                                           -- dbms_output.put_line('Actualiza sssbsecx1 '||c.iden || c.subj ||c.crse ||'*'||crn );

                                                                            Begin
                                                                                     update ssbsect
                                                                                            set ssbsect_census_enrl=ssbsect_enrl
                                                                                     Where SSBSECT_TERM_CODE = peri
                                                                                     And SSBSECT_CRN  = crn;
                                                                            Exception
                                                                            When Others then
                                                                                vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                                            End;

                                                                            --dbms_output.put_line('Actualiza sssbsecx1 '||c.iden || c.subj ||c.crse ||'*'||crn );
                                                                            conta_ptrm:=0;

                                                                            Begin
                                                                                Select count (*)
                                                                                    Into conta_ptrm
                                                                                from sfrareg
                                                                                where SFRAREG_PIDM = c.pidm
                                                                                And SFRAREG_TERM_CODE = peri
                                                                                And SFRAREG_CRN = crn
                                                                                And SFRAREG_EXTENSION_NUMBER = 0
                                                                                And SFRAREG_RSTS_CODE = 'RE';
                                                                            Exception
                                                                            When Others then
                                                                               conta_ptrm :=0;
                                                                            End;

                                                                            If conta_ptrm = 0 then

                                                                                 Begin
                                                                                         insert into sfrareg values(c.pidm, peri, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFNVIN', sysdate, null,null,null);
                                                                                 Exception
                                                                                   When Others then
                                                                                      vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                                                                 End;
                                                                            End if;

                                                                           -- dbms_output.put_line('Actualiza final cabecera '||c.iden || c.subj ||c.crse ||'*'||crn );



                                                                           Begin
                                                                             Select count(1)
                                                                             Into vl_existe
                                                                             from SHRINST
                                                                             Where  SHRINST_TERM_CODE = peri
                                                                             And SHRINST_CRN = crn
                                                                             And  SHRINST_PIDM = c.pidm;
                                                                           Exception
                                                                           When Others then
                                                                           vl_existe :=0;
                                                                           End;


                                                                          If vl_existe = 0 then
                                                                                Begin
                                                                                    Insert into SHRINST values (peri,        --SHRINST_TERM_CODE
                                                                                                                             crn,       --SHRINST_CRN
                                                                                                                             c.pidm,       --SHRINST_PIDM
                                                                                                                             sysdate,       --SHRINST_ACTIVITY_DATE
                                                                                                                             'Y',       --SHRINST_PRIMARY_IND
                                                                                                                              null,      --SHRINST_SURROGATE_ID
                                                                                                                              null,      --SHRINST_VERSION
                                                                                                                             user,       --SHRINST_USER_ID
                                                                                                                             'SZFNVIN',       --SHRINST_DATA_ORIGIN
                                                                                                                              null);      --SHRINST_VPDI_CODE


                                                                                Exception
                                                                                    When Others then
                                                                                     vl_error := 'Se presento un error al insertar al alumno en SHRINST ' ||sqlerrm;
                                                                                End;

                                                                          End if;

                                                                        Begin
                                                                            Update sgbstdn a
                                                                            set a.SGBSTDN_STYP_CODE ='N'
                                                                            Where a.SGBSTDN_PIDM = c.pidm
                                                                            And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                                                   from sgbstdn a1
                                                                                                                                   Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                                                   --And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1
                                                                                                                                   )
                                                                             --And a.SGBSTDN_PROGRAM_1 = c.prog
                                                                             ;
                                                                        Exception
                                                                            When Others then
                                                                            vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                                                        End;

                                                   Exception
                                                   when Others then
                                                       vl_error := 'Se presento un error al insertar al alumno en el grupo ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                                   End;



                             End if;

                End if;  ------ No hay  CRN Creado

                if vl_error = 'EXITO' then
                    commit; --Commit;
                    --dbms_output.put_line('mensaje:'||vl_error);
                Else
                 --dbms_output.put_line('mensaje:'||vl_error);
                   rollback;
                End if;
        Else
                --dbms_output.put_line('mensaje:'|| 'Ya tiene materias Inscritas ' ||c.iden || c.subj ||c.crse );
                null;
        End if; ----> El alumno ya tiene inscrita la materia

    End loop;



Elsif campus  in ('UTL') and nivel  in ('MA') then
    --dbms_output.put_line('Entrada 2');

                    for c in (

                    select  sorlcur_pidm pidm, spriden_id iden, sorlcur_program prog, sorlcur_term_code_ctlg ctlg , scrtext_text materia , smrarul_subj_code subj, smrarul_crse_numb_low crse,  '01' grupo,
                    null calif, sztdtec_periodicidad perio,
                   null  prof,
                      null pperiodo
                    from sorlcur a
                    join spriden b on b.spriden_pidm = a.sorlcur_pidm and b.spriden_change_ind is null
                    join  sgbstdn d on  d.sgbstdn_pidm=spriden_pidm
                    And d.SGBSTDN_TERM_CODE_EFF = (select max (b1.SGBSTDN_TERM_CODE_EFF)
                                                                           from SGBSTDN b1
                                                                           Where d.sgbstdn_pidm = b1.sgbstdn_pidm)
                    join smrpaap on smrpaap_program=sorlcur_program
                            and smrpaap_term_code_eff=sorlcur_term_code_ctlg
                    join smrarul on smrarul_area=smrpaap_area
                            and smrarul_term_code_eff=smrpaap_term_code_eff
                            and (smrarul_crse_numb_low like '%101%' or smrarul_crse_numb_low like '%102%' or smrarul_crse_numb_low='001')
                    join scrtext on scrtext_subj_code=smrarul_subj_code
                            and scrtext_crse_numb=smrarul_crse_numb_low
                            and (substr(scrtext_text,1,4)=smrarul_subj_code or substr(scrtext_text,1,3)=smrarul_subj_code
                            or substr(scrtext_text,1,2)=smrarul_subj_code)
                            And substr(smrarul_area,9,2) in ('01','02')
                    join sztdtec on sztdtec_program=sorlcur_program
                            and sztdtec_term_code=sorlcur_term_code_ctlg
                    Where  a.SORLCUR_LMOD_CODE = 'LEARNER'
                    And a.SORLCUR_CACT_CODE = 'ACTIVE'
                    And a.SORLCUR_ROLL_IND = 'Y'
                    And a.sorlcur_pidm in (select sorlcur_pidm
                                                      from sorlcur aa
                                                      where a.sorlcur_program=aa.sorlcur_program
                                                      and a.sorlcur_lmod_code=aa.sorlcur_lmod_code
                                                      and a.sorlcur_roll_ind=aa.sorlcur_roll_ind)
                    and a.SORLCUR_SEQNO = (select max (SORLCUR_SEQNO)
                                                            from SORLCUR aa1
                                                            Where a.sorlcur_pidm = aa1.sorlcur_pidm
                                                            And a.SORLCUR_LMOD_CODE = aa1.SORLCUR_LMOD_CODE
                                                            And a.SORLCUR_CACT_CODE = aa1.SORLCUR_CACT_CODE
                                                            And a.SORLCUR_KEY_SEQNO = aa1.SORLCUR_KEY_SEQNO
                                                            And a.sorlcur_program=aa1.sorlcur_program
                                                            And trunc (a.sorlcur_start_date) = fecha_ini
                                                            )
                    And a.SORLCUR_CAMP_CODE= campus
                    And a.SORLCUR_LEVL_CODE= nivel
                    And d.SGBSTDN_STYP_CODE in ('N', 'F')
               --    and a.sorlcur_pidm = 34551
                    union
                    select  distinct sorlcur_pidm pidm, spriden_id iden, sorlcur_program prog, sorlcur_term_code_ctlg ctlg , scrtext_text materia , smrarul_subj_code subj, smrarul_crse_numb_low crse,  '01' grupo,
                    null calif, sztdtec_periodicidad perio,
                  null  prof,
                      SZTPTRM_PTRM_CODE pperiodo
                    from sorlcur a
                    join spriden b on b.spriden_pidm = a.sorlcur_pidm and b.spriden_change_ind is null
--                    and spriden_id in ('010087293',
--                                                '010088584',
--                                                '010088716',
--                                                '010089536',
--                                                '010089887',
--                                                '010090435',
--                                                '010090575',
--                                                '010090945',
--                                                '020091099',
--                                                '010090605',
--                                                '020089216',
--                                                '020089550',
--                                                '010090815')
                    join  sgbstdn d on  d.sgbstdn_pidm=spriden_pidm
                    And d.SGBSTDN_TERM_CODE_EFF = (select max (b1.SGBSTDN_TERM_CODE_EFF)
                                                                           from SGBSTDN b1
                                                                           Where d.sgbstdn_pidm = b1.sgbstdn_pidm)
                    join smrpaap on smrpaap_program=sorlcur_program
                            and smrpaap_term_code_eff=sorlcur_term_code_ctlg
                    join smrarul on smrarul_area=smrpaap_area
                            and smrarul_term_code_eff=smrpaap_term_code_eff
                            and  smrarul_crse_numb_low like '%401%'
                    join scrtext on scrtext_subj_code=smrarul_subj_code
                            and scrtext_crse_numb=smrarul_crse_numb_low
                            and (substr(scrtext_text,1,4)=smrarul_subj_code or substr(scrtext_text,1,3)=smrarul_subj_code or substr(scrtext_text,1,2)=smrarul_subj_code)
                            And substr(smrarul_area,9,2) in ('01','02')
                    join sztdtec on sztdtec_program=sorlcur_program
                            and sztdtec_term_code=sorlcur_term_code_ctlg
                    join sztptrm on SZTPTRM_CAMP_CODE = a.sorlcur_camp_code
                            and  a.sorlcur_levl_code =  SZTPTRM_LEVL_CODE
                            and  SZTPTRM_TERM_CODE = peri
                            and  a.sorlcur_program =   SZTPTRM_PROGRAM
                            and SZTPTRM_PROPEDEUTICO = 1
                    join sobptrm on SOBPTRM_TERM_CODE = SZTPTRM_TERM_CODE
                            and SOBPTRM_PTRM_CODE = SZTPTRM_PTRM_CODE
                            and trunc (SOBPTRM_START_DATE) = trunc (a.sorlcur_start_date)
                    Where  a.SORLCUR_LMOD_CODE = 'LEARNER'
                    And a.SORLCUR_CACT_CODE = 'ACTIVE'
                    And a.SORLCUR_ROLL_IND = 'Y'
                    And a.sorlcur_pidm in (select sorlcur_pidm
                                                      from sorlcur aa
                                                      where a.sorlcur_program=aa.sorlcur_program
                                                      and a.sorlcur_lmod_code=aa.sorlcur_lmod_code
                                                      and a.sorlcur_roll_ind=aa.sorlcur_roll_ind)
                    and a.SORLCUR_SEQNO = (select max (SORLCUR_SEQNO)
                                                            from SORLCUR aa1
                                                            Where a.sorlcur_pidm = aa1.sorlcur_pidm
                                                            And a.SORLCUR_LMOD_CODE = aa1.SORLCUR_LMOD_CODE
                                                            And a.SORLCUR_CACT_CODE = aa1.SORLCUR_CACT_CODE
                                                            And a.SORLCUR_KEY_SEQNO = aa1.SORLCUR_KEY_SEQNO
                                                            And a.sorlcur_program=aa1.sorlcur_program
                                                           And trunc (a.sorlcur_start_date) = fecha_ini
                                                            )
                    And a.SORLCUR_CAMP_CODE= campus
                    And a.SORLCUR_LEVL_CODE= nivel
                    And d.SGBSTDN_STYP_CODE in ('N', 'F')
              --     and a.sorlcur_pidm = 34551
                    union
                    select  sorlcur_pidm pidm, spriden_id iden, sorlcur_program prog, sorlcur_term_code_ctlg ctlg , scrtext_text materia , smrarul_subj_code subj, smrarul_crse_numb_low crse,   '01' grupo,
                    null calif, sztdtec_periodicidad perio,
                   null  prof,
                   null pperiodo
                    from sorlcur a
                    join spriden b on b.spriden_pidm = a.sorlcur_pidm
                            and b.spriden_change_ind is null
                    join  sgbstdn d on d.sgbstdn_pidm=spriden_pidm
                            And d.SGBSTDN_TERM_CODE_EFF = (select max (b1.SGBSTDN_TERM_CODE_EFF)
                                                                                   from SGBSTDN b1
                                                                                   Where d.sgbstdn_pidm = b1.sgbstdn_pidm)
                    join smrpaap on smrpaap_program=sorlcur_program
                            and smrpaap_term_code_eff=sorlcur_term_code_ctlg
                    join smrarul on smrarul_area=smrpaap_area
                            and smrarul_term_code_eff=smrpaap_term_code_eff
                            and (( smrarul_crse_numb_low like '%101%' or smrarul_crse_numb_low like '%102%'  or smrarul_crse_numb_low='001' or smrarul_crse_numb_low='13001')  or
                       (smrarul_subj_code='131'  and (smrarul_crse_numb_low like '%01%' or smrarul_crse_numb_low like '%02%')))
                     and substr(smrarul_area,9,2) in ('01','02')
                    join scrtext on scrtext_subj_code=smrarul_subj_code and scrtext_crse_numb=smrarul_crse_numb_low and (substr(scrtext_text,1,4)=smrarul_subj_code or substr(scrtext_text,1,3)=smrarul_subj_code or substr(scrtext_text,1,2)=smrarul_subj_code)
                    join sztdtec on sztdtec_program=sorlcur_program and sztdtec_term_code=sorlcur_term_code_ctlg and sztdtec_periodicidad=2
                    Where  a.SORLCUR_LMOD_CODE = 'LEARNER'
                    And a.SORLCUR_CACT_CODE = 'ACTIVE'
                    And a.SORLCUR_ROLL_IND = 'Y'
                    And a.sorlcur_pidm in (select sorlcur_pidm
                                                      from sorlcur aa
                                                      where a.sorlcur_program=aa.sorlcur_program
                                                      and a.sorlcur_lmod_code=aa.sorlcur_lmod_code
                                                      and a.sorlcur_roll_ind=aa.sorlcur_roll_ind)
                    and a.SORLCUR_SEQNO = (select max (SORLCUR_SEQNO)
                                                            from SORLCUR aa1
                                                            Where a.sorlcur_pidm = aa1.sorlcur_pidm
                                                            And a.SORLCUR_LMOD_CODE = aa1.SORLCUR_LMOD_CODE
                                                            And a.SORLCUR_CACT_CODE = aa1.SORLCUR_CACT_CODE
                                                            And a.SORLCUR_KEY_SEQNO = aa1.SORLCUR_KEY_SEQNO
                                                            And a.sorlcur_program=aa1.sorlcur_program
                                                            And trunc (a.sorlcur_start_date) = fecha_ini
                                                            )
                    And a.SORLCUR_CAMP_CODE=campus And campus != 'UNA'
                    And a.SORLCUR_LEVL_CODE= nivel
                    And d.SGBSTDN_STYP_CODE in ('N', 'F')
               --     and a.sorlcur_pidm = 34551
                    union
                    select  sorlcur_pidm pidm, spriden_id iden, sorlcur_program prog, sorlcur_term_code_ctlg ctlg , scrtext_text materia , smrarul_subj_code subj, smrarul_crse_numb_low crse,   '01' grupo,
                    null calif, sztdtec_periodicidad perio,
                   null  prof,
                      null pperiodo
                    from sorlcur a
                    join spriden b on b.spriden_pidm = a.sorlcur_pidm and b.spriden_change_ind is null
--                    and spriden_id in ('010087293',
--                                                '010088584',
--                                                '010088716',
--                                                '010089536',
--                                                '010089887',
--                                                '010090435',
--                                                '010090575',
--                                                '010090945',
--                                                '020091099',
--                                                '010090605',
--                                                '020089216',
--                                                '020089550',
--                                                '010090815')
                    join  sgbstdn d on  d.sgbstdn_pidm=spriden_pidm
                    And d.SGBSTDN_TERM_CODE_EFF = (select max (b1.SGBSTDN_TERM_CODE_EFF)
                                                                           from SGBSTDN b1
                                                                           Where d.sgbstdn_pidm = b1.sgbstdn_pidm)
                    join smrpaap on smrpaap_program=sorlcur_program and smrpaap_term_code_eff=sorlcur_term_code_ctlg
                    join smrarul on smrarul_area=smrpaap_area and smrarul_term_code_eff=smrpaap_term_code_eff
                    and (( smrarul_crse_numb_low like '%101%' or smrarul_crse_numb_low like '%102%'  or smrarul_crse_numb_low like '%103%' or smrarul_crse_numb_low='001' or smrarul_crse_numb_low='13001')  or
                       (smrarul_subj_code='131'  and (smrarul_crse_numb_low like '%01%' or smrarul_crse_numb_low like '%02%')))
                     and substr(smrarul_area,9,2) in ('01','02')
                    join scrtext on scrtext_subj_code=smrarul_subj_code and scrtext_crse_numb=smrarul_crse_numb_low and (substr(scrtext_text,1,4)=smrarul_subj_code or substr(scrtext_text,1,3)=smrarul_subj_code or substr(scrtext_text,1,2)=smrarul_subj_code)
                    join sztdtec on sztdtec_program=sorlcur_program and sztdtec_term_code=sorlcur_term_code_ctlg and sztdtec_periodicidad=2
                    Where  a.SORLCUR_LMOD_CODE = 'LEARNER'
                    And a.SORLCUR_CACT_CODE = 'ACTIVE'
                    And a.SORLCUR_ROLL_IND = 'Y'
                    And a.sorlcur_pidm in (select sorlcur_pidm
                                                      from sorlcur aa
                                                      where a.sorlcur_program=aa.sorlcur_program
                                                      and a.sorlcur_lmod_code=aa.sorlcur_lmod_code
                                                      and a.sorlcur_roll_ind=aa.sorlcur_roll_ind)
                    and a.SORLCUR_SEQNO = (select max (SORLCUR_SEQNO)
                                                            from SORLCUR aa1
                                                            Where a.sorlcur_pidm = aa1.sorlcur_pidm
                                                            And a.SORLCUR_LMOD_CODE = aa1.SORLCUR_LMOD_CODE
                                                            And a.SORLCUR_CACT_CODE = aa1.SORLCUR_CACT_CODE
                                                            And a.SORLCUR_KEY_SEQNO = aa1.SORLCUR_KEY_SEQNO
                                                            And a.sorlcur_program=aa1.sorlcur_program
                                                            And trunc (a.sorlcur_start_date) = fecha_ini
                                                            )
                    And a.SORLCUR_CAMP_CODE=campus And campus = 'UNA'
                    And a.SORLCUR_LEVL_CODE= nivel
                    And d.SGBSTDN_STYP_CODE in ('N', 'F')
                 --   and a.sorlcur_pidm = 34551
                    order by   perio,materia, grupo, prog,ctlg, iden


                    ) loop


--------------- Limpia Variables  --------------------
--niv :=  null;
parte := null;
crn := null;
pidm_doc2 := null;
conta_sirasgn := null;
pidm_doc := null;
f_inicio := null;
f_fin := null;
sem := null;
schd := null;
title := null;
credit := null;
credit_bill :=null;
levl := null;
camp := null;
mate := null;
per := null;
grupo := null;
vl_existe :=0;

vn_lugares :=0;
vn_cupo_max :=0;
vn_cupo_act :=0;
vl_error := 'EXITO';

vl_mat_ext :=0;
vl_exite_prof :=0;



           ----- Busca la Parte de Periodo para el programa que inicia clases
        If c.pperiodo is null then

             Begin
                    select distinct SZTPTRM_PTRM_CODE
                        Into Parte
                    from sztptrm, sobptrm
                    where SZTPTRM_CAMP_CODE = campus
                    And SZTPTRM_LEVL_CODE = nivel
                    and SZTPTRM_TERM_CODE = peri
                    and SOBPTRM_TERM_CODE = SZTPTRM_TERM_CODE
                    AND SOBPTRM_PTRM_CODE = SZTPTRM_PTRM_CODE
                    and SZTPTRM_PROGRAM = c.prog
                    and trunc (SOBPTRM_START_DATE) = fecha_ini;

                    --dbms_output.put_line('Se llena parte de Periodo PREVIA:'||Parte ||' '||c.iden || c.subj ||c.crse);

                    If Parte in ('M0C' ) THEN
                       Parte := 'M1A';
                    Elsif  Parte in ('M0A' ) THEN
                       Parte := 'M0B';
                    Elsif  Parte in ('A0A' ) THEN
                       Parte := 'A0B';
                    Elsif  Parte in ('A0C' ) THEN
                       Parte := 'A1A';
                    End if;

                    --dbms_output.put_line('Se llena parte de Periodo PREVIA11:'||Parte ||' '||c.iden || c.subj ||c.crse);

               Exception
                When Others then
                  parte := null;
               End;
        Else
             Parte := c.pperiodo;
        End if;


--dbms_output.put_line('Se llena parte de Periodo:'||Parte ||' *'||c.iden ||'*'|| c.subj ||'*'||c.crse);


--------------------- Se valida que el alumno no tenga la materia sembrada en el horario como Activa ---------------------------------------

           begin
                select count (1)
                    into vl_existe
                from ssbsect, sfrstcr, SHRGRDE
                where sfrstcr_pidm=c.pidm
                --and sfrstcr_term_code=c.periodo
                and ssbsect_term_code=sfrstcr_term_code
                and SFRSTCR_PTRM_CODE = SSBSECT_PTRM_CODE
                and ssbsect_crn=sfrstcr_crn
                and ssbsect_subj_code=c.subj
                and ssbsect_crse_numb=c.crse
                and SFRSTCR_RSTS_CODE = 'RE'
                AND (SFRSTCR_GRDE_CODE = SHRGRDE_CODE
                                         OR SFRSTCR_GRDE_CODE IS NULL)
                AND SHRGRDE_PASSED_IND = 'Y'
                AND SHRGRDE_LEVL_CODE= NIVEL;

           Exception
            when others then
                vl_existe:=0;
           end;


            Begin
                   select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                   into f_inicio, f_fin, sem
                   from sobptrm
                   where sobptrm_term_code=Peri
                   and     sobptrm_ptrm_code=parte;
            Exception
               When Others then
                f_inicio:= null;
                f_fin := null;
                sem :=null;
            End;



        If vl_existe = 0 then

            --dbms_output.put_line('No Existe la materia:'||Parte ||' '||c.iden || c.subj ||c.crse||'*'||f_inicio);

              If  c.prof is null then
                    --dbms_output.put_line ('sin profesor '||vl_existe);
                    --dbms_output.put_line ('crea consulta '||peri ||'*'|| c.subj  ||'*'||c.crse||'*'||c.grupo||'*'||f_inicio);
                        begin
                               select ssbsect_crn , ssbsect_seats_avail lugares, ssbsect_max_enrl cupo_max, SSBSECT_PTRM_CODE,
                                        ssbsect_enrl cupo_Act,    SSBSECT_PTRM_START_DATE, SSBSECT_PTRM_END_DATE, SSBSECT_PTRM_WEEKS,
                                        SSBSECT_CREDIT_HRS, SSBSECT_BILL_HRS, SSBSECT_GMOD_CODE
                                into crn , vn_lugares, vn_cupo_max, parte,
                                       vn_cupo_act, f_inicio, f_fin, sem,
                                       credit, credit_bill, gmod
                                from ssbsect a
                                where a.SSBSECT_TERM_CODE= peri
                                and a.ssbsect_subj_code= c.subj
                               and a.ssbsect_crse_numb=c.crse
                               and a.SSBSECT_SEATS_AVAIL >0
                               AND a.SSBSECT_SEATS_AVAIL = (select max (a1.SSBSECT_SEATS_AVAIL)
                                                                               from ssbsect a1
                                                                                where a.SSBSECT_TERM_CODE = a1.SSBSECT_TERM_CODE
                                                                                and a.ssbsect_subj_code = a1.ssbsect_subj_code
                                                                                and a.ssbsect_crse_numb = a1.ssbsect_crse_numb
                                                                               and trunc (a.SSBSECT_PTRM_START_DATE) = trunc (a1.SSBSECT_PTRM_START_DATE))
                                and trunc (a.SSBSECT_PTRM_START_DATE) = f_inicio;
                        Exception
                        when others then
                            crn:=null;
                            vn_lugares :=0;
                            vn_cupo_max:=0;
                            vn_cupo_act:=0;
                            f_inicio := null;
                            f_fin := null;
                            sem := null;
                            credit  := null;
                            credit_bill  := null;
                            gmod  := null;
                             --dbms_output.put_line ('sin profesor ERROR'||SQLERRM);
                        end;
                Else
                           -- dbms_output.put_line ('con profesor '||vl_existe);
                            --dbms_output.put_line ('crea consulta '||peri ||'*'|| c.subj  ||'*'||c.crse||'*'||c.grupo||'*'||f_inicio);

                       begin
                               select ssbsect_crn , ssbsect_seats_avail lugares, ssbsect_max_enrl cupo_max, SSBSECT_PTRM_CODE,
                                        ssbsect_enrl cupo_Act,    SSBSECT_PTRM_START_DATE, SSBSECT_PTRM_END_DATE, SSBSECT_PTRM_WEEKS,
                                        SSBSECT_CREDIT_HRS, SSBSECT_BILL_HRS, SSBSECT_GMOD_CODE
                                into crn , vn_lugares, vn_cupo_max, parte,
                                       vn_cupo_act, f_inicio, f_fin, sem,
                                       credit, credit_bill, gmod
                                from ssbsect a, sirasgn
                                where a.SSBSECT_TERM_CODE= peri
                                and a.ssbsect_subj_code= c.subj
                               and a.ssbsect_crse_numb=c.crse
                               and a.SSBSECT_SEQ_NUMB = c.grupo
                               and a.SSBSECT_SEATS_AVAIL >0
                                AND to_number (a.ssbsect_crn) = (select max (to_number (a1.ssbsect_crn))
                                                                                from ssbsect a1
                                                                                where a.SSBSECT_TERM_CODE = a1.SSBSECT_TERM_CODE
                                                                                and a.ssbsect_subj_code = a1.ssbsect_subj_code
                                                                                and a.ssbsect_crse_numb = a1.ssbsect_crse_numb
                                                                                and a.SSBSECT_SEQ_NUMB = a1.SSBSECT_SEQ_NUMB
                                                                                and a.SSBSECT_PTRM_START_DATE = a1.SSBSECT_PTRM_START_DATE
                                                                                )
                                and trunc (a.SSBSECT_PTRM_START_DATE) = f_inicio
                               And SIRASGN_PIDM = (select distinct  spriden_pidm
                                                                    from spriden
                                                                    where spriden_id = c.prof
                                                                    And spriden_change_ind is null )
                                And SIRASGN_PRIMARY_IND = 'Y' ;
                       Exception
                        when others then
                            crn:=null;
                            vn_lugares :=0;
                            vn_cupo_max:=0;
                            vn_cupo_act:=0;
                            f_inicio := null;
                            f_fin := null;
                            sem := null;
                            credit  := null;
                            credit_bill  := null;
                            gmod  := null;
                            --dbms_output.put_line ('CON profesor ERROR'||SQLERRM);
                       end;

                End if;


                If crn is not null then

                      --dbms_output.put_line('Existe el Grupo:'||Parte ||' '||c.iden || c.subj ||c.crse);

                    If vn_lugares >0  then
                            --dbms_output.put_line('Tiene Lugares:'||Parte ||' '||c.iden || c.subj ||c.crse);

                            If credit is null then
                               Begin
                                      select SSRMEET_CREDIT_HR_SESS
                                       Into credit
                                      from SSRMEET
                                      where SSRMEET_TERM_CODE = peri
                                      And SSRMEET_CRN = crn;
                               Exception
                                When Others then
                                   credit :=null;
                                End;

                                  If credit is not null then
                                           Begin
                                               Update ssbsect
                                               set  SSBSECT_CREDIT_HRS = credit
                                               where SSBSECT_TERM_CODE = peri
                                               and SSBSECT_CRN = crn;
                                           Exception
                                           when Others then
                                                null;
                                           End;
                                  End if;
                           End if;

                           If credit_bill is null then
                             Begin
                                     select  SCBCRSE_BILL_HR_LOW
                                        into credit_bill
                                        from scbcrse, scrschd
                                        where scbcrse_subj_code=  c.subj
                                        and     scbcrse_crse_numb=c.crse
                                        and     scbcrse_eff_term='000000'
                                        and     scrschd_subj_code=scbcrse_subj_code
                                        and     scrschd_crse_numb=scbcrse_crse_numb
                                        and     scrschd_eff_term=scbcrse_eff_term;
                             Exception
                             When Others then
                                credit_bill := 3;
                             End;

                              If credit is not null then
                                       Begin
                                           Update ssbsect
                                           set  SSBSECT_BILL_HRS = credit_bill
                                           where SSBSECT_TERM_CODE = peri
                                           and SSBSECT_CRN = crn;
                                       Exception
                                       when Others then
                                            null;
                                       End;
                              End if;

                           End if;




                          If gmod is null then
                                begin
                                    select scrgmod_gmod_code
                                    into gmod
                                    from scrgmod
                                    where scrgmod_subj_code=c.subj
                                    and     scrgmod_crse_numb=c.crse
                                    and     scrgmod_default_ind='D';
                                exception when others then
                                    gmod:='1';
                                end;

                                If gmod is not null then
                                           Begin
                                               Update ssbsect
                                               set  SSBSECT_GMOD_CODE = gmod
                                               where SSBSECT_TERM_CODE = peri
                                               and SSBSECT_CRN = crn;
                                           Exception
                                           when Others then
                                                null;
                                           End;
                                end if;

                          End if;


                        conta_ptrm :=0;

                            Begin
                                 select count(*)
                                    into conta_ptrm
                                 from sfbetrm
                                 where sfbetrm_term_code=peri
                                 and     sfbetrm_pidm=c.pidm;
                            Exception
                                When Others then
                                  conta_ptrm := 0;
                            End;


                             if conta_ptrm =0 then
                                    Begin
                                            insert into sfbetrm values(peri, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFNVIN', null, 0,null,null, null,null,user,null);
                                    Exception
                                    When Others then
                                        vl_error := ('Se presento un error al insertar en la tabla sfbetrm  '  ||c.iden || c.subj ||c.crse|| sqlerrm);
                                    End;
                             end if;

                          Begin
                                    select distinct max(sorlcur_key_seqno)
                                        into sp
                                    from sorlcur
                                    where sorlcur_pidm=c.pidm
                                    and     sorlcur_program=c.prog
                                    and     sorlcur_lmod_code='LEARNER';
                           Exception
                           when Others then
                              sp := null;
                              vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                           End;

                        --  calculamos la materi pade
                           begin
                           select GET_MATERIA_PADRE(c.materia)
                           into vmateria_padre
                            from dual;
                           exception when others  then
                               vmateria_padre := '';

                           end;


                           Begin
                              --dbms_output.put_line('Se inserta en el Grupo:'||Parte ||' '||c.iden || c.subj ||c.crse);
                               insert into sfrstcr values(
                                                                peri,     --SFRSTCR_TERM_CODE
                                                                c.pidm,     --SFRSTCR_PIDM
                                                                crn,     --SFRSTCR_CRN
                                                                1,     --SFRSTCR_CLASS_SORT_KEY
                                                                1,    --SFRSTCR_REG_SEQ
                                                                parte,    --SFRSTCR_PTRM_CODE
                                                                'RE',     --SFRSTCR_RSTS_CODE
                                                                sysdate,    --SFRSTCR_RSTS_DATE
                                                                null,    --SFRSTCR_ERROR_FLAG
                                                                null,    --SFRSTCR_MESSAGE
                                                                credit_bill,    --SFRSTCR_BILL_HR
                                                                3, --SFRSTCR_WAIV_HR
                                                                credit,     --SFRSTCR_CREDIT_HR
                                                                credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                gmod,     --SFRSTCR_GMOD_CODE
                                                                null,    --SFRSTCR_GRDE_CODE
                                                                null,    --SFRSTCR_GRDE_CODE_MID
                                                                null,    --SFRSTCR_GRDE_DATE
                                                                'N',    --SFRSTCR_DUPL_OVER
                                                                'N',    --SFRSTCR_LINK_OVER
                                                                'N',    --SFRSTCR_CORQ_OVER
                                                                'N',    --SFRSTCR_PREQ_OVER
                                                                'N',     --SFRSTCR_TIME_OVER
                                                                'N',     --SFRSTCR_CAPC_OVER
                                                                'N',     --SFRSTCR_LEVL_OVER
                                                                'N',     --SFRSTCR_COLL_OVER
                                                                'N',     --SFRSTCR_MAJR_OVER
                                                                'N',     --SFRSTCR_CLAS_OVER
                                                                'N',     --SFRSTCR_APPR_OVER
                                                                'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                sysdate,      --SFRSTCR_ADD_DATE
                                                                sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                nivel,     --SFRSTCR_LEVL_CODE
                                                                campus,     --SFRSTCR_CAMP_CODE
                                                                vmateria_padre,     --SFRSTCR_RESERVED_KEY
                                                                null,     --SFRSTCR_ATTEND_HR
                                                                'Y',     --SFRSTCR_REPT_OVER
                                                                'N' ,    --SFRSTCR_RPTH_OVER
                                                                null,    --SFRSTCR_TEST_OVER
                                                                'N',    --SFRSTCR_CAMP_OVER
                                                                user,    --SFRSTCR_USER
                                                                'N',    --SFRSTCR_DEGC_OVER
                                                                'N',    --SFRSTCR_PROG_OVER
                                                                null,    --SFRSTCR_LAST_ATTEND
                                                                null,    --SFRSTCR_GCMT_CODE
                                                                'SZFNVIN',    --SFRSTCR_DATA_ORIGIN
                                                                sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                'N',  --SFRSTCR_DEPT_OVER
                                                                'N',  --SFRSTCR_ATTS_OVER
                                                                'N', --SFRSTCR_CHRT_OVER
                                                                null, --SFRSTCR_RMSG_CDE
                                                                null,  --SFRSTCR_WL_PRIORITY
                                                                null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                'N', --SFRSTCR_MEXC_OVER
                                                                sp,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                null,--SFRSTCR_BRDH_SEQ_NUM
                                                                '01',--SFRSTCR_BLCK_CODE
                                                                null,--SFRSTCR_STRH_SEQNO
                                                                null, --SFRSTCR_STRD_SEQNO
                                                                null,  --SFRSTCR_SURROGATE_ID
                                                                null, --SFRSTCR_VERSION
                                                                user,--SFRSTCR_USER_ID
                                                                no_recibo );--SFRSTCR_VPDI_CODE



                                        Begin
                                             update ssbsect
                                                    set ssbsect_enrl = ssbsect_enrl + 1
                                              where SSBSECT_TERM_CODE = peri
                                              And SSBSECT_CRN  = crn;
                                        Exception
                                        When Others then
                                        vl_error := 'Se presento un error al actualizar el enrolamiento ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                        End;

                                        Begin
                                                update ssbsect
                                                    set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                where SSBSECT_TERM_CODE = peri
                                                 And SSBSECT_CRN  = crn;
                                        Exception
                                        When Others then
                                            vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                        End;

                                        Begin
                                                 update ssbsect
                                                        set ssbsect_census_enrl=ssbsect_enrl
                                                 Where SSBSECT_TERM_CODE = peri
                                                 And SSBSECT_CRN  = crn;
                                        Exception
                                        When Others then
                                            vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                        End;


                                        conta_ptrm:=0;

                                        Begin
                                            Select count (*)
                                                Into conta_ptrm
                                            from sfrareg
                                            where SFRAREG_PIDM = c.pidm
                                            And SFRAREG_TERM_CODE = peri
                                            And SFRAREG_CRN = crn
                                            And SFRAREG_EXTENSION_NUMBER = 0
                                            And SFRAREG_RSTS_CODE = 'RE';
                                        Exception
                                        When Others then
                                           conta_ptrm :=0;
                                        End;

                                        If conta_ptrm = 0 then

                                             Begin
                                                     insert into sfrareg values(c.pidm, peri, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFNVIN', sysdate, null,null,null);
                                             Exception
                                               When Others then
                                                  vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                             End;
                                        End if;

                                     vl_existe :=0;

                                          Begin
                                             Select count(1)
                                             Into vl_existe
                                             from SHRINST
                                             Where  SHRINST_TERM_CODE = peri
                                             And SHRINST_CRN = crn
                                             And  SHRINST_PIDM = c.pidm;
                                          Exception
                                          When Others then
                                           vl_existe :=0;
                                          End;


                                          If vl_existe = 0 then
                                                Begin
                                                    Insert into SHRINST values (peri,        --SHRINST_TERM_CODE
                                                                                             crn,       --SHRINST_CRN
                                                                                             c.pidm,       --SHRINST_PIDM
                                                                                             sysdate,       --SHRINST_ACTIVITY_DATE
                                                                                             'Y',       --SHRINST_PRIMARY_IND
                                                                                              null,      --SHRINST_SURROGATE_ID
                                                                                              null,      --SHRINST_VERSION
                                                                                             user,       --SHRINST_USER_ID
                                                                                             'SZFNVIN',       --SHRINST_DATA_ORIGIN
                                                                                              null);      --SHRINST_VPDI_CODE


                                                Exception
                                                    When Others then
                                                     vl_error := 'Se presento un error al insertar al alumno en SHRINST ' ||sqlerrm;
                                                End;

                                          End if;



                                        Begin
                                            Update sgbstdn a
                                            set a.SGBSTDN_STYP_CODE ='N'
                                            Where a.SGBSTDN_PIDM = c.pidm
                                            And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                   from sgbstdn a1
                                                                                                   Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                   --And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1
                                                                                                   )
                                             --And a.SGBSTDN_PROGRAM_1 = c.prog
                                             ;
                                        Exception
                                            When Others then
                                            vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                        End;

                            Exception
                           when Others then
                               vl_error := 'Se presento un error al insertar al alumno en el grupo ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                           End;

                    Else  ----------> Se realizara la creacion del grupo
                            --dbms_output.put_line('SE crea grupo Nuevo por Cupo:'||Parte ||' '||c.iden || c.subj ||c.crse);

                            schd := null;
                            title := null;
                            credit := null;
                            gmod :=null;
                            credit_bill :=null;

                            Begin
                                select scrschd_schd_code, scbcrse_title, scbcrse_credit_hr_low, SCBCRSE_BILL_HR_LOW
                                into schd, title, credit, credit_bill
                                from scbcrse, scrschd
                                where scbcrse_subj_code=c.subj
                                and     scbcrse_crse_numb=c.crse
                                and     scbcrse_eff_term='000000'
                                and     scrschd_subj_code=scbcrse_subj_code
                                and     scrschd_crse_numb=scbcrse_crse_numb
                                and     scrschd_eff_term=scbcrse_eff_term;
                            Exception
                            When Others then
                                  schd := null;
                                  title := null;
                                  credit := null;
                                  credit_bill := null;
                            End;


                            begin
                                select scrgmod_gmod_code
                                      into gmod
                                from scrgmod
                                where scrgmod_subj_code=c.subj
                                and     scrgmod_crse_numb=c.crse
                                and     scrgmod_default_ind='D';
                            exception when others then
                                gmod:='1';
                            end;

                             Begin
                                    select nvl(max(ssbsect_crn),1000)+1
                                         into crn
                                    from ssbsect where ssbsect_term_code= peri;
                              Exception
                                    When Others then
                                       crn := null;
                             End;

                             If crn is not null then
                                   Begin
                                       select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                                       into f_inicio, f_fin, sem
                                       from sobptrm
                                       where sobptrm_term_code=Peri
                                       and     sobptrm_ptrm_code=parte;
                                   Exception
                                   When Others then
                                    f_inicio:= null;
                                    f_fin := null;
                                    sem :=null;
                                   End;

                             --dbms_output.put_line('SE crea grupo Nuevo por Cupo ahora:'||Parte ||' '||c.iden || c.subj ||c.crse);

                                  Begin
                                        Insert into ssbsect values (
                                                                           Peri,     --SSBSECT_TERM_CODE
                                                                           crn,     --SSBSECT_CRN
                                                                           parte,     --SSBSECT_PTRM_CODE
                                                                           c.subj,     --SSBSECT_SUBJ_CODE
                                                                           c.crse,     --SSBSECT_CRSE_NUMB
                                                                            '01',     --SSBSECT_SEQ_NUMB
                                                                            'A',    --SSBSECT_SSTS_CODE
                                                                            schd,    --SSBSECT_SCHD_CODE
                                                                            campus,    --SSBSECT_CAMP_CODE
                                                                             title,   --SSBSECT_CRSE_TITLE
                                                                             credit,   --SSBSECT_CREDIT_HRS
                                                                             credit_bill,   --SSBSECT_BILL_HRS
                                                                             gmod,   --SSBSECT_GMOD_CODE
                                                                              null,  --SSBSECT_SAPR_CODE
                                                                              null, --SSBSECT_SESS_CODE
                                                                              null,  --SSBSECT_LINK_IDENT
                                                                              null,  --SSBSECT_PRNT_IND
                                                                              'Y',  --SSBSECT_GRADABLE_IND
                                                                               null,  --SSBSECT_TUIW_IND
                                                                               0, --SSBSECT_REG_ONEUP
                                                                               0, --SSBSECT_PRIOR_ENRL
                                                                               0, --SSBSECT_PROJ_ENRL
                                                                               50, --SSBSECT_MAX_ENRL
                                                                                0,--SSBSECT_ENRL
                                                                                50,--SSBSECT_SEATS_AVAIL
                                                                                null,--SSBSECT_TOT_CREDIT_HRS
                                                                                '0',--SSBSECT_CENSUS_ENRL
                                                                                f_inicio,--SSBSECT_CENSUS_ENRL_DATE
                                                                                sysdate,--SSBSECT_ACTIVITY_DATE
                                                                                f_inicio,--SSBSECT_PTRM_START_DATE
                                                                                f_fin,--SSBSECT_PTRM_END_DATE
                                                                                sem,--SSBSECT_PTRM_WEEKS
                                                                                null,--SSBSECT_RESERVED_IND
                                                                                null, --SSBSECT_WAIT_CAPACITY
                                                                                null,--SSBSECT_WAIT_COUNT
                                                                                null,--SSBSECT_WAIT_AVAIL
                                                                                null,--SSBSECT_LEC_HR
                                                                                null,--SSBSECT_LAB_HR
                                                                                null,--SSBSECT_OTH_HR
                                                                                null,--SSBSECT_CONT_HR
                                                                                null,--SSBSECT_ACCT_CODE
                                                                                null,--SSBSECT_ACCL_CODE
                                                                                null,--SSBSECT_CENSUS_2_DATE
                                                                                null,--SSBSECT_ENRL_CUT_OFF_DATE
                                                                                null,--SSBSECT_ACAD_CUT_OFF_DATE
                                                                                null,--SSBSECT_DROP_CUT_OFF_DATE
                                                                                null,--SSBSECT_CENSUS_2_ENRL
                                                                                'Y',--SSBSECT_VOICE_AVAIL
                                                                                'N',--SSBSECT_CAPP_PREREQ_TEST_IND
                                                                                null,--SSBSECT_GSCH_NAME
                                                                                null,--SSBSECT_BEST_OF_COMP
                                                                                null,--SSBSECT_SUBSET_OF_COMP
                                                                                'NOP',--SSBSECT_INSM_CODE
                                                                                null,--SSBSECT_REG_FROM_DATE
                                                                                null,--SSBSECT_REG_TO_DATE
                                                                                null,--SSBSECT_LEARNER_REGSTART_FDATE
                                                                                null,--SSBSECT_LEARNER_REGSTART_TDATE
                                                                                null,--SSBSECT_DUNT_CODE
                                                                                null,--SSBSECT_NUMBER_OF_UNITS
                                                                                0,--SSBSECT_NUMBER_OF_EXTENSIONS
                                                                                'SZFNVIN',--SSBSECT_DATA_ORIGIN
                                                                                user,--SSBSECT_USER_ID
                                                                                'MOOD',--SSBSECT_INTG_CDE
                                                                                'B',--SSBSECT_PREREQ_CHK_METHOD_CDE
                                                                                user,--SSBSECT_KEYWORD_INDEX_ID
                                                                                null,--SSBSECT_SCORE_OPEN_DATE
                                                                                null,--SSBSECT_SCORE_CUTOFF_DATE
                                                                                null,--SSBSECT_REAS_SCORE_OPEN_DATE
                                                                                null,--SSBSECT_REAS_SCORE_CTOF_DATE
                                                                                null,--SSBSECT_SURROGATE_ID
                                                                                null,--SSBSECT_VERSION
                                                                                 null);--SSBSECT_VPDI_CODE

                                                   Begin
                                                        insert into ssrmeet values(peri, crn, null,null,null,null,null,null, sysdate, f_inicio, f_fin, '01', null,null,null,null,null,null,null, 'ENL', null, credit, null, 0, null,null,null, 'CLVI', 'SZFNVIN', user, null,null,null);
                                                    Exception
                                                    when Others then
                                                       vl_error := 'Se presento un Error al insertar en ssrmeet ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                                   End;

                                                   pidm_prof := null;

                                                    begin
                                                    select spriden_pidm into pidm_prof
                                                    from  spriden
                                                    where   spriden_id=  c.prof and spriden_change_ind is null;
                                                    exception when others then
                                                    pidm_prof:=null;
                                                    end;

                                                    conta_ptrm :=0;
                                                  Begin
                                                    Select count (1)
                                                        Into conta_ptrm
                                                    from sirasgn
                                                    Where SIRASGN_TERM_CODE = peri
                                                    And SIRASGN_CRN = crn
                                                    and  SIRASGN_PIDM = pidm_prof
                                                    And SIRASGN_PRIMARY_IND = 'Y';
                                                  Exception
                                                  When Others then
                                                   conta_ptrm :=0;
                                                  End;


                                                    if pidm_prof is not null and conta_ptrm = 0 then
                                                        Begin
                                                                insert into sirasgn values(ciclo, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,  sysdate, null,null,null,null, 'SZFNVIN', user, null, null, null, null,  null,null);
                                                        Exception
                                                        When Others then
                                                        null;
                                                        End;
                                                    end if;


                                                conta_ptrm :=0;

                                                    Begin
                                                         select count(*)
                                                            into conta_ptrm
                                                         from sfbetrm
                                                         where sfbetrm_term_code=peri
                                                         and     sfbetrm_pidm=c.pidm;
                                                    Exception
                                                        When Others then
                                                          conta_ptrm := 0;
                                                    End;


                                                     if conta_ptrm =0 then
                                                            Begin
                                                                    insert into sfbetrm values(peri, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFNVIN', null, 0,null,null, null,null,user,null);
                                                            Exception
                                                            When Others then
                                                                vl_error := ('Se presento un error al insertar en la tabla sfbetrm ' ||c.iden || c.subj ||c.crse || sqlerrm);
                                                            End;
                                                     end if;



                                                    Begin
                                                        select sgbstdn_levl_code, sgbstdn_camp_code  into levl, camp
                                                        from sgbstdn a
                                                        where sgbstdn_pidm=c.pidm
                                                        and     sgbstdn_term_code_eff  in (select max(sgbstdn_term_code_eff) from sgbstdn aa
                                                                                                           where a.sgbstdn_pidm=aa.sgbstdn_pidm);
                                                    Exception
                                                    When Others then
                                                       levl := null;
                                                       camp := null;
                                                       vl_error := 'Se presento un error al obtener la informacion de SGBSTDN '||c.iden || c.subj ||c.crse || sqlerrm;
                                                    End;

                                                   Begin
                                                            select distinct max(sorlcur_key_seqno)
                                                                into sp
                                                            from sorlcur
                                                            where sorlcur_pidm=c.pidm
                                                            and     sorlcur_program=c.prog
                                                            and     sorlcur_lmod_code='LEARNER';
                                                   Exception
                                                   when Others then
                                                      sp := null;
                                                      vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                   End;

                                              --  calculamos la materi pade
                                                   begin
                                                   select GET_MATERIA_PADRE(c.materia)
                                                   into vmateria_padre
                                                    from dual;
                                                   exception when others  then
                                                       vmateria_padre := '';

                                                   end;


                                                   Begin

                                                       insert into sfrstcr values(
                                                                                        peri,     --SFRSTCR_TERM_CODE
                                                                                        c.pidm,     --SFRSTCR_PIDM
                                                                                        crn,     --SFRSTCR_CRN
                                                                                        1,     --SFRSTCR_CLASS_SORT_KEY
                                                                                        1,    --SFRSTCR_REG_SEQ
                                                                                        parte,    --SFRSTCR_PTRM_CODE
                                                                                        'RE',     --SFRSTCR_RSTS_CODE
                                                                                        sysdate,    --SFRSTCR_RSTS_DATE
                                                                                        null,    --SFRSTCR_ERROR_FLAG
                                                                                        null,    --SFRSTCR_MESSAGE
                                                                                        credit_bill,    --SFRSTCR_BILL_HR
                                                                                        3, --SFRSTCR_WAIV_HR
                                                                                        credit,     --SFRSTCR_CREDIT_HR
                                                                                        credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                                        credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                                        gmod,     --SFRSTCR_GMOD_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE_MID
                                                                                        null,    --SFRSTCR_GRDE_DATE
                                                                                        'N',    --SFRSTCR_DUPL_OVER
                                                                                        'N',    --SFRSTCR_LINK_OVER
                                                                                        'N',    --SFRSTCR_CORQ_OVER
                                                                                        'N',    --SFRSTCR_PREQ_OVER
                                                                                        'N',     --SFRSTCR_TIME_OVER
                                                                                        'N',     --SFRSTCR_CAPC_OVER
                                                                                        'N',     --SFRSTCR_LEVL_OVER
                                                                                        'N',     --SFRSTCR_COLL_OVER
                                                                                        'N',     --SFRSTCR_MAJR_OVER
                                                                                        'N',     --SFRSTCR_CLAS_OVER
                                                                                        'N',     --SFRSTCR_APPR_OVER
                                                                                        'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                                        sysdate,      --SFRSTCR_ADD_DATE
                                                                                        sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                                        vmateria_padre,     --SFRSTCR_LEVL_CODE
                                                                                        camp,     --SFRSTCR_CAMP_CODE
                                                                                        null,     --SFRSTCR_RESERVED_KEY
                                                                                        null,     --SFRSTCR_ATTEND_HR
                                                                                        'Y',     --SFRSTCR_REPT_OVER
                                                                                        'N' ,    --SFRSTCR_RPTH_OVER
                                                                                        null,    --SFRSTCR_TEST_OVER
                                                                                        'N',    --SFRSTCR_CAMP_OVER
                                                                                        user,    --SFRSTCR_USER
                                                                                        'N',    --SFRSTCR_DEGC_OVER
                                                                                        'N',    --SFRSTCR_PROG_OVER
                                                                                        null,    --SFRSTCR_LAST_ATTEND
                                                                                        null,    --SFRSTCR_GCMT_CODE
                                                                                        'SZFNVIN',    --SFRSTCR_DATA_ORIGIN
                                                                                        sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                                        'N',  --SFRSTCR_DEPT_OVER
                                                                                        'N',  --SFRSTCR_ATTS_OVER
                                                                                        'N', --SFRSTCR_CHRT_OVER
                                                                                        null, --SFRSTCR_RMSG_CDE
                                                                                        null,  --SFRSTCR_WL_PRIORITY
                                                                                        null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                                        null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                                        null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                                        'N', --SFRSTCR_MEXC_OVER
                                                                                        sp,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                                        null,--SFRSTCR_BRDH_SEQ_NUM
                                                                                        '01',--SFRSTCR_BLCK_CODE
                                                                                        null,--SFRSTCR_STRH_SEQNO
                                                                                        null, --SFRSTCR_STRD_SEQNO
                                                                                        null,  --SFRSTCR_SURROGATE_ID
                                                                                        null, --SFRSTCR_VERSION
                                                                                        user,--SFRSTCR_USER_ID
                                                                                        no_recibo );--SFRSTCR_VPDI_CODE



                                                                Begin
                                                                     update ssbsect
                                                                            set ssbsect_enrl = ssbsect_enrl + 1
                                                                      where SSBSECT_TERM_CODE = peri
                                                                      And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                vl_error := 'Se presento un error al actualizar el enrolamiento '||c.iden || c.subj ||c.crse ||sqlerrm;
                                                                End;

                                                                Begin
                                                                        update ssbsect
                                                                            set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                                        where SSBSECT_TERM_CODE = peri
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                                                End;

                                                                Begin
                                                                         update ssbsect
                                                                                set ssbsect_census_enrl=ssbsect_enrl
                                                                         Where SSBSECT_TERM_CODE = peri
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                                End;


                                                                conta_ptrm:=0;

                                                                Begin
                                                                    Select count (*)
                                                                        Into conta_ptrm
                                                                    from sfrareg
                                                                    where SFRAREG_PIDM = c.pidm
                                                                    And SFRAREG_TERM_CODE = peri
                                                                    And SFRAREG_CRN = crn
                                                                    And SFRAREG_EXTENSION_NUMBER = 0
                                                                    And SFRAREG_RSTS_CODE = 'RE';
                                                                Exception
                                                                When Others then
                                                                   conta_ptrm :=0;
                                                                End;

                                                                If conta_ptrm = 0 then

                                                                     Begin
                                                                             insert into sfrareg values(c.pidm, peri, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFNVIN', sysdate, null,null,null);
                                                                     Exception
                                                                       When Others then
                                                                          vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                                                     End;
                                                                End if;


                                                             vl_existe :=0;

                                                              Begin
                                                                 Select count(1)
                                                                 Into vl_existe
                                                                 from SHRINST
                                                                 Where  SHRINST_TERM_CODE = peri
                                                                 And SHRINST_CRN = crn
                                                                 And  SHRINST_PIDM = c.pidm;
                                                              Exception
                                                              When Others then
                                                               vl_existe :=0;
                                                              End;


                                                              If vl_existe = 0 then
                                                                    Begin
                                                                        Insert into SHRINST values (peri,        --SHRINST_TERM_CODE
                                                                                                                 crn,       --SHRINST_CRN
                                                                                                                 c.pidm,       --SHRINST_PIDM
                                                                                                                 sysdate,       --SHRINST_ACTIVITY_DATE
                                                                                                                 'Y',       --SHRINST_PRIMARY_IND
                                                                                                                  null,      --SHRINST_SURROGATE_ID
                                                                                                                  null,      --SHRINST_VERSION
                                                                                                                 user,       --SHRINST_USER_ID
                                                                                                                 'SZFNVIN',       --SHRINST_DATA_ORIGIN
                                                                                                                  null);      --SHRINST_VPDI_CODE


                                                                    Exception
                                                                        When Others then
                                                                         vl_error := 'Se presento un error al insertar al alumno en SHRINST ' ||sqlerrm;
                                                                    End;

                                                              End if;


                                                            Begin
                                                                Update sgbstdn a
                                                                set a.SGBSTDN_STYP_CODE ='N'
                                                                Where a.SGBSTDN_PIDM = c.pidm
                                                                And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                                       from sgbstdn a1
                                                                                                                       Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                                       And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1)
                                                                 And a.SGBSTDN_PROGRAM_1 = c.prog;
                                                            Exception
                                                                When Others then
                                                                vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                                            End;




                                                    Exception
                                                   when Others then
                                                       vl_error := 'Se presento un error al insertar al alumno en el grupo ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                                   End;


                                  Exception
                                    When Others then
                                      vl_error := 'Se presento un Error al insertar el nuevo grupo 1 ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                  End;
                             End if;

                     --dbms_output.put_line('mensaje:'|| 'No hay grupo cupo');
                     End if;
                Else
                    --dbms_output.put_line('mensaje:'|| 'No hay grupo creado Nuevo');
                            schd := null;
                            title := null;
                            credit := null;
                            gmod :=null;
                            credit_bill :=null;

                        --dbms_output.put_line('Entra a buscar informacion '||c.iden || c.subj ||c.crse );
                            Begin
                                select scrschd_schd_code, scbcrse_title, scbcrse_credit_hr_low, SCBCRSE_BILL_HR_LOW
                                into schd, title, credit, credit_bill
                                from scbcrse, scrschd
                                where scbcrse_subj_code=c.subj
                                and     scbcrse_crse_numb=c.crse
                                and     scbcrse_eff_term='000000'
                                and     scrschd_subj_code=scbcrse_subj_code
                                and     scrschd_crse_numb=scbcrse_crse_numb
                                and     scrschd_eff_term=scbcrse_eff_term;
                            Exception
                            When Others then
                                  schd := null;
                                  title := null;
                                  credit := null;
                                  credit_bill := null;
                            End;


                            begin
                                select scrgmod_gmod_code
                                      into gmod
                                from scrgmod
                                where scrgmod_subj_code=c.subj
                                and     scrgmod_crse_numb=c.crse
                                and     scrgmod_default_ind='D';
                            exception when others then
                                gmod:='1';
                            end;

                             Begin
                                    select nvl(max(ssbsect_crn),1000)+1
                                         into crn
                                    from ssbsect where ssbsect_term_code= peri;
                              Exception
                                    When Others then
                                       crn := null;
                             End;

                             If crn is not null then
                             --dbms_output.put_line('entra a crear el grupo '||c.iden || c.subj ||c.crse||'*'||crn );

                                   Begin
                                       select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                                       into f_inicio, f_fin, sem
                                       from sobptrm
                                       where sobptrm_term_code=Peri
                                       and     sobptrm_ptrm_code=parte;
                                   Exception
                                   When Others then
                                    f_inicio:= null;
                                    f_fin := null;
                                    sem :=null;
                                   End;

                              --dbms_output.put_line('entra a crear el grupo ssbsect '||c.iden || c.subj ||c.crse );

                                                    Begin
                                                            Insert into ssbsect values (
                                                                                               Peri,     --SSBSECT_TERM_CODE
                                                                                               crn,     --SSBSECT_CRN
                                                                                               parte,     --SSBSECT_PTRM_CODE
                                                                                               c.subj,     --SSBSECT_SUBJ_CODE
                                                                                               c.crse,     --SSBSECT_CRSE_NUMB
                                                                                                '01',     --SSBSECT_SEQ_NUMB
                                                                                                'A',    --SSBSECT_SSTS_CODE
                                                                                                schd,    --SSBSECT_SCHD_CODE
                                                                                                campus,    --SSBSECT_CAMP_CODE
                                                                                                 title,   --SSBSECT_CRSE_TITLE
                                                                                                 credit,   --SSBSECT_CREDIT_HRS
                                                                                                 credit_bill,   --SSBSECT_BILL_HRS
                                                                                                 gmod,   --SSBSECT_GMOD_CODE
                                                                                                  null,  --SSBSECT_SAPR_CODE
                                                                                                  null, --SSBSECT_SESS_CODE
                                                                                                  null,  --SSBSECT_LINK_IDENT
                                                                                                  null,  --SSBSECT_PRNT_IND
                                                                                                  'Y',  --SSBSECT_GRADABLE_IND
                                                                                                   null,  --SSBSECT_TUIW_IND
                                                                                                   0, --SSBSECT_REG_ONEUP
                                                                                                   0, --SSBSECT_PRIOR_ENRL
                                                                                                   0, --SSBSECT_PROJ_ENRL
                                                                                                   50, --SSBSECT_MAX_ENRL
                                                                                                    0,--SSBSECT_ENRL
                                                                                                    50,--SSBSECT_SEATS_AVAIL
                                                                                                    null,--SSBSECT_TOT_CREDIT_HRS
                                                                                                    '0',--SSBSECT_CENSUS_ENRL
                                                                                                    f_inicio,--SSBSECT_CENSUS_ENRL_DATE
                                                                                                    sysdate,--SSBSECT_ACTIVITY_DATE
                                                                                                    f_inicio,--SSBSECT_PTRM_START_DATE
                                                                                                    f_fin,--SSBSECT_PTRM_END_DATE
                                                                                                    sem,--SSBSECT_PTRM_WEEKS
                                                                                                    null,--SSBSECT_RESERVED_IND
                                                                                                    null, --SSBSECT_WAIT_CAPACITY
                                                                                                    null,--SSBSECT_WAIT_COUNT
                                                                                                    null,--SSBSECT_WAIT_AVAIL
                                                                                                    null,--SSBSECT_LEC_HR
                                                                                                    null,--SSBSECT_LAB_HR
                                                                                                    null,--SSBSECT_OTH_HR
                                                                                                    null,--SSBSECT_CONT_HR
                                                                                                    null,--SSBSECT_ACCT_CODE
                                                                                                    null,--SSBSECT_ACCL_CODE
                                                                                                    null,--SSBSECT_CENSUS_2_DATE
                                                                                                    null,--SSBSECT_ENRL_CUT_OFF_DATE
                                                                                                    null,--SSBSECT_ACAD_CUT_OFF_DATE
                                                                                                    null,--SSBSECT_DROP_CUT_OFF_DATE
                                                                                                    null,--SSBSECT_CENSUS_2_ENRL
                                                                                                    'Y',--SSBSECT_VOICE_AVAIL
                                                                                                    'N',--SSBSECT_CAPP_PREREQ_TEST_IND
                                                                                                    null,--SSBSECT_GSCH_NAME
                                                                                                    null,--SSBSECT_BEST_OF_COMP
                                                                                                    null,--SSBSECT_SUBSET_OF_COMP
                                                                                                    'NOP',--SSBSECT_INSM_CODE
                                                                                                    null,--SSBSECT_REG_FROM_DATE
                                                                                                    null,--SSBSECT_REG_TO_DATE
                                                                                                    null,--SSBSECT_LEARNER_REGSTART_FDATE
                                                                                                    null,--SSBSECT_LEARNER_REGSTART_TDATE
                                                                                                    null,--SSBSECT_DUNT_CODE
                                                                                                    null,--SSBSECT_NUMBER_OF_UNITS
                                                                                                    0,--SSBSECT_NUMBER_OF_EXTENSIONS
                                                                                                    'SZFNVIN',--SSBSECT_DATA_ORIGIN
                                                                                                    user,--SSBSECT_USER_ID
                                                                                                    'MOOD',--SSBSECT_INTG_CDE
                                                                                                    'B',--SSBSECT_PREREQ_CHK_METHOD_CDE
                                                                                                    user,--SSBSECT_KEYWORD_INDEX_ID
                                                                                                    null,--SSBSECT_SCORE_OPEN_DATE
                                                                                                    null,--SSBSECT_SCORE_CUTOFF_DATE
                                                                                                    null,--SSBSECT_REAS_SCORE_OPEN_DATE
                                                                                                    null,--SSBSECT_REAS_SCORE_CTOF_DATE
                                                                                                    null,--SSBSECT_SURROGATE_ID
                                                                                                    null,--SSBSECT_VERSION
                                                                                                     null);--SSBSECT_VPDI_CODE
                                                    Exception
                                                    When Others then
                                                      vl_error := 'Se presento un Error al insertar en SSBSECT Grupo Nuevo ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                    End;

                                                    --dbms_output.put_line('Grupo creado el grupo ssbsect '||c.iden || c.subj ||c.crse ||'*'||crn);
                                                   Begin
                                                        insert into ssrmeet values(peri, crn, null,null,null,null,null,null, sysdate, f_inicio, f_fin, '01', null,null,null,null,null,null,null, 'ENL', null, credit, null, 0, null,null,null, 'CLVI', 'SZFNVIN', user, null,null,null);
                                                    Exception
                                                    when Others then
                                                       vl_error := 'Se presento un Error al insertar en ssrmeet ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                   End;

                                                               --dbms_output.put_line('Grupo creado el grupo ssrmeet '||c.iden || c.subj ||c.crse );


                                                    begin
                                                        select spriden_pidm into pidm_prof
                                                        from  spriden
                                                        where   spriden_id=c.prof and spriden_change_ind is null;
                                                    Exception when others then
                                                      pidm_prof:=null;
                                                    End;

                                                    if pidm_prof is not null then
                                                         -- dbms_output.put_line('Crea el CRN para el docente:'|| pidm_prof  ||'*'||crn);
                                                         vl_exite_prof :=0;

                                                          Begin
                                                                Select count (1)
                                                                Into vl_exite_prof
                                                                from sirasgn
                                                                Where SIRASGN_TERM_CODE = peri
                                                                And SIRASGN_CRN = crn;
                                                               -- And SIRASGN_PIDM = pidm_prof;
                                                           Exception
                                                            when others then
                                                              vl_exite_prof := 0;
                                                           End;

                                                           If vl_exite_prof = 0 then
                                                                    Begin
                                                                            insert into sirasgn values(peri, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,
                                                                                                                 sysdate, null,null,null,null, 'UTEL', user, null, null, null, null,  null,null);
                                                                    Exception
                                                                    When Others then
                                                                    null;
                                                                    End;
                                                           Else
                                                                   Begin
                                                                        Update sirasgn
                                                                        set SIRASGN_PRIMARY_IND = null
                                                                         Where SIRASGN_TERM_CODE = peri
                                                                         And SIRASGN_CRN = crn;
                                                                   Exception
                                                                    When others then
                                                                    null;
                                                                   End;

                                                                    Begin
                                                                            insert into sirasgn values(peri, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,
                                                                                                                 sysdate, null,null,null,null, 'UTEL', user, null, null, null, null,  null,null);
                                                                    Exception
                                                                    When Others then
                                                                    null;
                                                                    End;

                                                           End if;
                                                    end if;


                                                conta_ptrm :=0;

                                                    Begin
                                                         select count(*)
                                                            into conta_ptrm
                                                         from sfbetrm
                                                         where sfbetrm_term_code=peri
                                                         and     sfbetrm_pidm=c.pidm;
                                                    Exception
                                                        When Others then
                                                          conta_ptrm := 0;
                                                    End;


                                                     if conta_ptrm =0 then
                                                            Begin
                                                                    insert into sfbetrm values(peri, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFNVIN', null, 0,null,null, null,null,user,null);
                                                            Exception
                                                            When Others then
                                                                vl_error := ('Se presento un error al insertar en la tabla sfbetrm ' ||c.iden || c.subj ||c.crse || sqlerrm);
                                                            End;
                                                     end if;




                                                   Begin
                                                            select distinct max(sorlcur_key_seqno)
                                                                into sp
                                                            from sorlcur
                                                            where sorlcur_pidm=c.pidm
                                                            and     sorlcur_program=c.prog
                                                            and     sorlcur_lmod_code='LEARNER';
                                                   Exception
                                                   when Others then
                                                      sp := null;
                                                      vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                   End;

                                                 --  calculamos la materi pade
                                                   begin
                                                   select GET_MATERIA_PADRE(c.materia)
                                                   into vmateria_padre
                                                    from dual;
                                                   exception when others  then
                                                       vmateria_padre := '';

                                                   end;



                                                   Begin

                                                    -- dbms_output.put_line('registra en Inscripciont '||c.iden || c.subj ||c.crse ||'*'||crn );

                                                       insert into sfrstcr values(
                                                                                        peri,     --SFRSTCR_TERM_CODE
                                                                                        c.pidm,     --SFRSTCR_PIDM
                                                                                        crn,     --SFRSTCR_CRN
                                                                                        1,     --SFRSTCR_CLASS_SORT_KEY
                                                                                        1,    --SFRSTCR_REG_SEQ
                                                                                        parte,    --SFRSTCR_PTRM_CODE
                                                                                        'RE',     --SFRSTCR_RSTS_CODE
                                                                                        sysdate,    --SFRSTCR_RSTS_DATE
                                                                                        null,    --SFRSTCR_ERROR_FLAG
                                                                                        null,    --SFRSTCR_MESSAGE
                                                                                        credit_bill,    --SFRSTCR_BILL_HR
                                                                                        3, --SFRSTCR_WAIV_HR
                                                                                        credit,     --SFRSTCR_CREDIT_HR
                                                                                        credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                                        credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                                        gmod,     --SFRSTCR_GMOD_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE_MID
                                                                                        null,    --SFRSTCR_GRDE_DATE
                                                                                        'N',    --SFRSTCR_DUPL_OVER
                                                                                        'N',    --SFRSTCR_LINK_OVER
                                                                                        'N',    --SFRSTCR_CORQ_OVER
                                                                                        'N',    --SFRSTCR_PREQ_OVER
                                                                                        'N',     --SFRSTCR_TIME_OVER
                                                                                        'N',     --SFRSTCR_CAPC_OVER
                                                                                        'N',     --SFRSTCR_LEVL_OVER
                                                                                        'N',     --SFRSTCR_COLL_OVER
                                                                                        'N',     --SFRSTCR_MAJR_OVER
                                                                                        'N',     --SFRSTCR_CLAS_OVER
                                                                                        'N',     --SFRSTCR_APPR_OVER
                                                                                        'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                                        sysdate,      --SFRSTCR_ADD_DATE
                                                                                        sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                                        nivel,     --SFRSTCR_LEVL_CODE
                                                                                        campus,     --SFRSTCR_CAMP_CODE
                                                                                        vmateria_padre,     --SFRSTCR_RESERVED_KEY
                                                                                        null,     --SFRSTCR_ATTEND_HR
                                                                                        'Y',     --SFRSTCR_REPT_OVER
                                                                                        'N' ,    --SFRSTCR_RPTH_OVER
                                                                                        null,    --SFRSTCR_TEST_OVER
                                                                                        'N',    --SFRSTCR_CAMP_OVER
                                                                                        user,    --SFRSTCR_USER
                                                                                        'N',    --SFRSTCR_DEGC_OVER
                                                                                        'N',    --SFRSTCR_PROG_OVER
                                                                                        null,    --SFRSTCR_LAST_ATTEND
                                                                                        null,    --SFRSTCR_GCMT_CODE
                                                                                        'SZFNVIN',    --SFRSTCR_DATA_ORIGIN
                                                                                        sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                                        'N',  --SFRSTCR_DEPT_OVER
                                                                                        'N',  --SFRSTCR_ATTS_OVER
                                                                                        'N', --SFRSTCR_CHRT_OVER
                                                                                        null, --SFRSTCR_RMSG_CDE
                                                                                        null,  --SFRSTCR_WL_PRIORITY
                                                                                        null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                                        null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                                        null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                                        'N', --SFRSTCR_MEXC_OVER
                                                                                        sp,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                                        null,--SFRSTCR_BRDH_SEQ_NUM
                                                                                        '01',--SFRSTCR_BLCK_CODE
                                                                                        null,--SFRSTCR_STRH_SEQNO
                                                                                        null, --SFRSTCR_STRD_SEQNO
                                                                                        null,  --SFRSTCR_SURROGATE_ID
                                                                                        null, --SFRSTCR_VERSION
                                                                                        user,--SFRSTCR_USER_ID
                                                                                        no_recibo );--SFRSTCR_VPDI_CODE




                                                                Begin
                                                                     update ssbsect
                                                                            set ssbsect_enrl = ssbsect_enrl + 1
                                                                      where SSBSECT_TERM_CODE = peri
                                                                      And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                vl_error := 'Se presento un error al actualizar el enrolamiento ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                                End;

                                                                                                                --dbms_output.put_line('Actualiza sssbsecx '||c.iden || c.subj ||c.crse ||'*'||crn );

                                                                Begin
                                                                        update ssbsect
                                                                            set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                                        where SSBSECT_TERM_CODE = peri
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                                End;

                                                                --dbms_output.put_line('Actualiza sssbsecx1 '||c.iden || c.subj ||c.crse ||'*'||crn );

                                                                Begin
                                                                         update ssbsect
                                                                                set ssbsect_census_enrl=ssbsect_enrl
                                                                         Where SSBSECT_TERM_CODE = peri
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                                End;

                                                                --dbms_output.put_line('Actualiza sssbsecx1 '||c.iden || c.subj ||c.crse ||'*'||crn );
                                                                conta_ptrm:=0;

                                                                Begin
                                                                    Select count (*)
                                                                        Into conta_ptrm
                                                                    from sfrareg
                                                                    where SFRAREG_PIDM = c.pidm
                                                                    And SFRAREG_TERM_CODE = peri
                                                                    And SFRAREG_CRN = crn
                                                                    And SFRAREG_EXTENSION_NUMBER = 0
                                                                    And SFRAREG_RSTS_CODE = 'RE';
                                                                Exception
                                                                When Others then
                                                                   conta_ptrm :=0;
                                                                End;

                                                                If conta_ptrm = 0 then

                                                                     Begin
                                                                             insert into sfrareg values(c.pidm, peri, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFNVIN', sysdate, null,null,null);
                                                                     Exception
                                                                       When Others then
                                                                          vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                                                     End;
                                                                End if;

                                                             vl_existe :=0;

                                                              Begin
                                                                 Select count(1)
                                                                 Into vl_existe
                                                                 from SHRINST
                                                                 Where  SHRINST_TERM_CODE = peri
                                                                 And SHRINST_CRN = crn
                                                                 And  SHRINST_PIDM = c.pidm;
                                                              Exception
                                                              When Others then
                                                               vl_existe :=0;
                                                              End;


                                                              If vl_existe = 0 then
                                                                    Begin
                                                                        Insert into SHRINST values (peri,        --SHRINST_TERM_CODE
                                                                                                                 crn,       --SHRINST_CRN
                                                                                                                 c.pidm,       --SHRINST_PIDM
                                                                                                                 sysdate,       --SHRINST_ACTIVITY_DATE
                                                                                                                 'Y',       --SHRINST_PRIMARY_IND
                                                                                                                  null,      --SHRINST_SURROGATE_ID
                                                                                                                  null,      --SHRINST_VERSION
                                                                                                                 user,       --SHRINST_USER_ID
                                                                                                                 'SZFNVIN',       --SHRINST_DATA_ORIGIN
                                                                                                                  null);      --SHRINST_VPDI_CODE


                                                                    Exception
                                                                        When Others then
                                                                         vl_error := 'Se presento un error al insertar al alumno en SHRINST ' ||sqlerrm;
                                                                    End;

                                                              End if;


                                                                 Begin
                                                                    Update sgbstdn a
                                                                    set a.SGBSTDN_STYP_CODE ='N'
                                                                    Where a.SGBSTDN_PIDM = c.pidm
                                                                    And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                                           from sgbstdn a1
                                                                                                                           Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                                           --And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1
                                                                                                                           )
                                                                    -- And a.SGBSTDN_PROGRAM_1 = c.prog
                                                                    ;
                                                                Exception
                                                                    When Others then
                                                                    vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                                                End;


                                                    --dbms_output.put_line('Actualiza final cabecera '||c.iden || c.subj ||c.crse ||'*'||crn );

                                                      --dbms_output.put_line('registra en Inscripcion dos '||c.iden || c.subj ||c.crse ||'*'||crn );
                                                   Exception
                                                   when Others then
                                                       vl_error := 'Se presento un error al insertar al alumno en el grupo ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                                   End;


                             End if;

                End if;  ------ No hay  CRN Creado

                if vl_error = 'EXITO' then
                    commit; --Commit;
                    --dbms_output.put_line('mensaje:'||vl_error);
                Else
                 --dbms_output.put_line('mensaje:'||vl_error);
                   rollback;
                End if;
        Else
                -- dbms_output.put_line('mensaje:'|| 'Ya tiene materias Inscritas ' ||c.iden || c.subj ||c.crse );
                null;
        End if; ----> El alumno ya tiene inscrita la materia

    End loop;

------------- macana  ------------

   Elsif  campus  in ('UTL')  And nivel in ('LI')  then

   --dbms_output.put_line('Entrada 3');

--   dbms_output.put_line('macana');
                for c1 in (
                              with   ingreso as (
                                                  Select SOBPTRM_TERM_CODE periodo, SOBPTRM_PTRM_CODE parte, SOBPTRM_START_DATE inicio, SOBPTRM_END_DATE termino, SOBPTRM_WEEKS semanas
                                                  from sobptrm, (select min (substr (a.SOBPTRM_PTRM_CODE,3,1)) inicial
                                                                            from sobptrm a
                                                                            where a.SOBPTRM_TERM_CODE like '01%'
                                                                            And a.SOBPTRM_TERM_CODE = peri
                                                                            And a.SOBPTRM_PTRM_CODE like 'L%'
                                                                            and  a.SOBPTRM_PTRM_CODE != 'L2A'
                                                                            And a.SOBPTRM_START_DATE = fecha ) tipo
                                                where  substr (SOBPTRM_PTRM_CODE,3,1) = tipo.inicial
                                                And SOBPTRM_TERM_CODE like '01%'
                                                And SOBPTRM_PTRM_CODE like 'L%'
                                                And SOBPTRM_START_DATE =fecha
                                                And SOBPTRM_TERM_CODE = peri
                                )
                                                  select  sorlcur_pidm pidm,
                                                  spriden_id iden,
                                                   sorlcur_program prog,
                                                   sorlcur_term_code_ctlg ctlg,
                                                    sztdtec_periodicidad perio,
                                                     ingreso.parte pperiodo,
                                                     substr (ingreso.parte, 2,1) tipo_inicio,
                                                    ingreso.periodo,
                                                    ingreso.inicio,
                                                    a.SORLCUR_KEY_SEQNO Sp,
                                                    rownum numero
                                                    from sorlcur a
                                                    join spriden b on b.spriden_pidm = a.sorlcur_pidm and b.spriden_change_ind is null
                                                    join  sgbstdn d on  d.sgbstdn_pidm= a.sorlcur_pidm
                                                    And d.SGBSTDN_TERM_CODE_EFF = (select max (b1.SGBSTDN_TERM_CODE_EFF)
                                                                                                           from SGBSTDN b1
                                                                                                           Where d.sgbstdn_pidm = b1.sgbstdn_pidm)
                                                    join sztdtec on sztdtec_program=sorlcur_program
                                                            and sztdtec_term_code=sorlcur_term_code_ctlg
                                    --------------------------------------------------------------------------
                                                    join ingreso on ingreso.inicio = a.sorlcur_start_date
                                                    Where  a.SORLCUR_LMOD_CODE = 'LEARNER'
                                                    And a.SORLCUR_CACT_CODE = 'ACTIVE'
                                                    And a.SORLCUR_ROLL_IND = 'Y'
                                    --------------------------------------------------------------------------
                                                    And a.sorlcur_pidm in (select sorlcur_pidm
                                                                                      from sorlcur aa
                                                                                      where a.sorlcur_program=aa.sorlcur_program
                                                                                      and a.sorlcur_lmod_code=aa.sorlcur_lmod_code
                                                                                      and a.sorlcur_roll_ind=aa.sorlcur_roll_ind)
                                                    and a.SORLCUR_SEQNO = (select max (SORLCUR_SEQNO)
                                                                                            from SORLCUR aa1
                                                                                            Where a.sorlcur_pidm = aa1.sorlcur_pidm
                                                                                            And a.SORLCUR_LMOD_CODE = aa1.SORLCUR_LMOD_CODE
                                                                                            And a.SORLCUR_CACT_CODE = aa1.SORLCUR_CACT_CODE
                                                                                            And a.SORLCUR_KEY_SEQNO = aa1.SORLCUR_KEY_SEQNO
                                                                                            And a.sorlcur_program=aa1.sorlcur_program
                                                                                            And trunc (a.sorlcur_start_date) = fecha
                                                                                            )
                                                    And a.SORLCUR_CAMP_CODE= campus
                                                    And a.SORLCUR_LEVL_CODE= nivel
                                                    And d.SGBSTDN_STYP_CODE in ('N', 'F')
                                                 -- and a.sorlcur_pidm = 100062
                                                   order by   1 ---secuencia,perio,materia, grupo, prog,ctlg, iden
                    ) loop

--------------- Limpia Variables  --------------------
--niv :=  null;
parte := null;
crn := null;
pidm_doc2 := null;
conta_sirasgn := null;
pidm_doc := null;
f_inicio := null;
f_fin := null;
sem := null;
schd := null;
title := null;
credit := null;
credit_bill :=null;
levl := null;
camp := null;
mate := null;
per := null;
grupo := null;
vl_existe :=0;

vn_lugares :=0;
vn_cupo_max :=0;
vn_cupo_act :=0;
vl_error := 'EXITO';

vl_vueltas :=0;
vl_numero := 0;
vl_tipoingreso := null;
vl_conversion :=null;

vl_secuencia_cont :=0;
vl_mat_ext :=0;
vl_jornada :=null;

  vl_vuelta_L0D :=0;


    -- dbms_output.put_line('macana entro ');

           ----- Busca la Parte de Periodo para el programa que inicia clases

             If c1.tipo_inicio =0 then
                  vl_conversion := 'AN';
             Elsif c1.tipo_inicio =1 then
                  vl_conversion := 'NO';
             End if;


           If   c1.tipo_inicio is not null then

                  For periodos in (

                                           select SZTASGN_CRSE_NUMB, SZTASGN_INSO_CODE, SZTASGN_BIM_NUMB, SZTASGN_OPT_NUMB
                                            from SZTASGN
                                            where SZTASGN_QNUMB = 'Q1'
                                            and SZTASGN_JORN_CODE ='C'
                                            and SZTASGN_CAMP_CODE = campus
                                            And SZTASGN_LEVL_CODE = nivel
                                            And   SZTASGN_INSO_CODE = vl_conversion
                                            order by 3

                    ) loop


                   If periodos.SZTASGN_CRSE_NUMB  >0 then
                            --dbms_output.put_line('periodos entro ');
                            for c in (

                                        with serie as (
                                        SELECT DISTINCT SMRPCMT_PROGRAM AS Programa,
                                                                                SMRPCMT_TERM_CODE_EFF periodo,
                                                                                REGEXP_SUBSTR (SMRPCMT_TEXT,'[^|"]+',1,1)  AS Id_Materia,
                                                                               to_number( REGEXP_SUBSTR (SMRPCMT_TEXT,'[^|"]+',1,2) ) AS Id_Secuencia,
                                                                                NVL (SZTMACO_MATPADRE,
                                                                                REGEXP_SUBSTR (SMRPCMT_TEXT,'[^|"]+', 1,1)) ID_MATERIA_GPO
                                                                  FROM SMRPCMT, sztmaco
                                                                 WHERE     SMRPCMT_TEXT IS NOT NULL
                                                                       AND REGEXP_SUBSTR (SMRPCMT_TEXT,'[^|"]+',1,1) = SZTMACO_MATHIJO(+)
                                                                       AND SMRPCMT_PROGRAM = c1.prog
                                                                  and    to_number( REGEXP_SUBSTR (SMRPCMT_TEXT,'[^|"]+',1,2) )  > vl_secuencia_cont
                                                              ORDER BY 1, 2,  4
                                        ),
                                        ingreso as (
                                                          Select SOBPTRM_TERM_CODE periodo, SOBPTRM_PTRM_CODE parte, SOBPTRM_START_DATE inicio, SOBPTRM_END_DATE termino, SOBPTRM_WEEKS semanas
                                                          from sobptrm, (select min (substr (a.SOBPTRM_PTRM_CODE,3,1)) inicial
                                                                                    from sobptrm a
                                                                                    where a.SOBPTRM_TERM_CODE like '01%'
                                                                                    And a.SOBPTRM_PTRM_CODE like 'L%'
                                                                                    and  a.SOBPTRM_PTRM_CODE != 'L2A'
                                                                                     And a.SOBPTRM_TERM_CODE = peri
                                                                                    And a.SOBPTRM_START_DATE = fecha ) tipo
                                                        where  substr (SOBPTRM_PTRM_CODE,3,1) = tipo.inicial
                                                        And SOBPTRM_TERM_CODE = peri
                                                        And SOBPTRM_PTRM_CODE like 'L%'
                                                        And SOBPTRM_START_DATE = fecha
                                        )
                                                          select  sorlcur_pidm pidm,
                                                          spriden_id iden,
                                                           sorlcur_program prog,
                                                           sorlcur_term_code_ctlg ctlg,
                                                           serie.id_materia_gpo materia ,
                                                            smrarul_subj_code subj,
                                                            smrarul_crse_numb_low crse,
                                                             '01' grupo,
                                                           null calif,
                                                            sztdtec_periodicidad perio,
                                                          null  prof,
                                                             ingreso.parte pperiodo,
                                                             substr (ingreso.parte, 2,1) tipo_inicio,
                                                            serie.Id_Secuencia secuencia,
                                                            serie.Id_Materia materia_banner,
                                                            serie.id_materia_gpo materia_legal,
                                                            ingreso.periodo,
                                                            ingreso.inicio,
                                                            rownum numero
                                                            from sorlcur a
                                                            join spriden b on b.spriden_pidm = a.sorlcur_pidm and b.spriden_change_ind is null
                                                            join  sgbstdn d on  d.sgbstdn_pidm= a.sorlcur_pidm
                                                            And d.SGBSTDN_TERM_CODE_EFF = (select max (b1.SGBSTDN_TERM_CODE_EFF)
                                                                                                                   from SGBSTDN b1
                                                                                                                   Where d.sgbstdn_pidm = b1.sgbstdn_pidm)
                                                            join smrpaap on smrpaap_program=sorlcur_program
                                                                    and smrpaap_term_code_eff=sorlcur_term_code_ctlg
                                                            join smrarul on smrarul_area=smrpaap_area
                                                                    and smrarul_term_code_eff=smrpaap_term_code_eff
                                                                    And SMRARUL_SUBJ_CODE||SMRARUL_CRSE_NUMB_LOW not in (select SHRTRTK_SUBJ_CODE_INST||SHRTRTK_CRSE_NUMB_INST   -----> Que no se encuentre en equivalencias
                                                                                                                                                                    from SHRTRTK
                                                                                                                                                                    where SHRTRTK_PIDM = a.sorlcur_pidm
                                                                                                                                                                    And SHRTRTK_LEVL_CODE = a.sorlcur_levl_code
                                                                                                                                                                    And SHRTRTK_COUNT_GPA_IND = 'Y')
                                                            join sztdtec on sztdtec_program=sorlcur_program
                                                                    and sztdtec_term_code=sorlcur_term_code_ctlg
                                            --------------------------------------------------------------------------
                                                            join serie on serie.programa  = a.sorlcur_program
                                                                    and serie.periodo = a.sorlcur_term_code_ctlg
                                                            join ingreso on ingreso.inicio = a.sorlcur_start_date
                                                            Where  a.SORLCUR_LMOD_CODE = 'LEARNER'
                                                            And a.SORLCUR_CACT_CODE = 'ACTIVE'
                                                            And a.SORLCUR_ROLL_IND = 'Y'
                                                            and a.sorlcur_program = c1.prog
                                                            And serie.id_materia = SMRARUL_SUBJ_CODE||SMRARUL_CRSE_NUMB_LOW
                                            --------------------------------------------------------------------------
                                                            And a.sorlcur_pidm in (select sorlcur_pidm
                                                                                              from sorlcur aa
                                                                                              where a.sorlcur_program=aa.sorlcur_program
                                                                                              and a.sorlcur_lmod_code=aa.sorlcur_lmod_code
                                                                                              and a.sorlcur_roll_ind=aa.sorlcur_roll_ind)
                                                            and a.SORLCUR_SEQNO = (select max (SORLCUR_SEQNO)
                                                                                                    from SORLCUR aa1
                                                                                                    Where a.sorlcur_pidm = aa1.sorlcur_pidm
                                                                                                    And a.SORLCUR_LMOD_CODE = aa1.SORLCUR_LMOD_CODE
                                                                                                    And a.SORLCUR_CACT_CODE = aa1.SORLCUR_CACT_CODE
                                                                                                    And a.SORLCUR_KEY_SEQNO = aa1.SORLCUR_KEY_SEQNO
                                                                                                    And a.sorlcur_program=aa1.sorlcur_program
                                                                                                    And trunc (a.sorlcur_start_date) = fecha
                                                                                                    )
                                                            And a.SORLCUR_CAMP_CODE= campus
                                                            And a.SORLCUR_LEVL_CODE= nivel
                                                            And d.SGBSTDN_STYP_CODE in ('N', 'F')
                                                            and a.sorlcur_pidm = c1.pidm
                                                           order by   secuencia ---secuencia,perio,materia, grupo, prog,ctlg, iden


                         ) loop


                            --------------- Limpia Variables  --------------------
                            --niv :=  null;
                            parte := null;
                            crn := null;
                            pidm_doc2 := null;
                            conta_sirasgn := null;
                            pidm_doc := null;
                            f_inicio := null;
                            f_fin := null;
                            sem := null;
                            schd := null;
                            title := null;
                            credit := null;
                            credit_bill :=null;
                            levl := null;
                            camp := null;
                            mate := null;
                            per := null;
                            grupo := null;
                            vl_existe :=0;

                            vn_lugares :=0;
                            vn_cupo_max :=0;
                            vn_cupo_act :=0;
                            vl_error := 'EXITO';


                            vl_numero := 0;
                            vl_tipoingreso := null;

--------------------- Se valida que el alumno no tenga la materia sembrada en el horario como Activa ---------------------------------------


                               begin

                                        select count (1)
                                            into vl_existe
                                        from ssbsect, sfrstcr, SHRGRDE
                                        where sfrstcr_pidm=c.pidm
                                        --and sfrstcr_term_code=c.periodo
                                        and ssbsect_term_code=sfrstcr_term_code
                                        and SFRSTCR_PTRM_CODE = SSBSECT_PTRM_CODE
                                        and ssbsect_crn=sfrstcr_crn
                                        and ssbsect_subj_code=c.subj
                                        and ssbsect_crse_numb=c.crse
                                        and SFRSTCR_RSTS_CODE = 'RE'
                                        AND (SFRSTCR_GRDE_CODE = SHRGRDE_CODE
                                                                 OR SFRSTCR_GRDE_CODE IS NULL)
                                        AND SHRGRDE_PASSED_IND = 'Y'
                                        AND SHRGRDE_LEVL_CODE= NIVEL
                                        and SFRSTCR_STSP_KEY_SEQUENCE = c1.sp;

                               Exception
                                when others then
                                    vl_existe:=0;
                               end;


                                --dbms_output.put_line('Valida que Exista la Materia: ' || vl_existe);

                                If vl_existe = 0 then
                                        Parte :=null;

                                   -- dbms_output.put_line('No Existe la materia para el alumno:'||Parte ||' '||c.iden || c.subj ||c.crse);

                                    If vl_conversion ='NO' then

                                           If periodos.SZTASGN_BIM_NUMB = 'B0' then
                                                Parte := c.pperiodo;
                                               -- dbms_output.put_line('Entra1' ||'*'||c.pperiodo);
                                            Elsif  periodos.SZTASGN_BIM_NUMB = 'B1' then
                                               Parte := c.pperiodo;
                                           Elsif  periodos.SZTASGN_BIM_NUMB = 'B2' then
                                                Parte := 'L2A';
                                               -- dbms_output.put_line('Entra3' ||'*'||c.pperiodo);
                                           End if;
                                  Else

                                        If periodos.SZTASGN_BIM_NUMB = 'B0' then
                                                Parte := c.pperiodo;
                                               -- dbms_output.put_line('Entra1' ||'*'||c.pperiodo);
                                        Elsif  periodos.SZTASGN_BIM_NUMB = 'B1' then
                                               Parte := 'L1E';
                                        Elsif  periodos.SZTASGN_BIM_NUMB = 'B2' then
                                                Parte := 'L2A';
                                               -- dbms_output.put_line('Entra3' ||'*'||c.pperiodo);
                                        End if;

                                   End if;
                                    --dbms_output.put_line('No Existe la materia para el alumno:'||Parte ||' *'||c.iden ||'*'|| c.subj ||'*'||c.crse ||'*'||periodos.SZTASGN_BIM_NUMB);

                                   Begin
                                           select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                                           into f_inicio, f_fin, sem
                                           from sobptrm
                                           where sobptrm_term_code=Peri
                                           and     sobptrm_ptrm_code=parte;
                                   Exception
                                   When Others then
                                        f_inicio:= null;
                                        f_fin := null;
                                        sem :=null;
                                   End;




                                        If  c.prof is null then
                                            --dbms_output.put_line ('sin profesor '||vl_existe);
                                            --dbms_output.put_line ('crea consulta '||peri ||'*'|| c.subj  ||'*'||c.crse||'*'||c.grupo||'*'||f_inicio);
                                                begin

                                                   select ssbsect_crn , ssbsect_seats_avail lugares, ssbsect_max_enrl cupo_max, SSBSECT_PTRM_CODE,
                                                            ssbsect_enrl cupo_Act,    SSBSECT_PTRM_START_DATE, SSBSECT_PTRM_END_DATE, SSBSECT_PTRM_WEEKS,
                                                            SSBSECT_CREDIT_HRS, SSBSECT_BILL_HRS, SSBSECT_GMOD_CODE
                                                    into crn , vn_lugares, vn_cupo_max, parte,
                                                           vn_cupo_act, f_inicio, f_fin, sem,
                                                           credit, credit_bill, gmod
                                                    from ssbsect a
                                                    where a.SSBSECT_TERM_CODE= peri
                                                    and a.ssbsect_subj_code= c.subj
                                                   and a.ssbsect_crse_numb=c.crse
                                                   and a.SSBSECT_SEATS_AVAIL >0
                                                   AND a.SSBSECT_SEATS_AVAIL = (select max (a1.SSBSECT_SEATS_AVAIL)
                                                                                                   from ssbsect a1
                                                                                                    where a.SSBSECT_TERM_CODE = a1.SSBSECT_TERM_CODE
                                                                                                    and a.ssbsect_subj_code = a1.ssbsect_subj_code
                                                                                                    and a.ssbsect_crse_numb = a1.ssbsect_crse_numb
                                                                                                   and trunc (a.SSBSECT_PTRM_START_DATE) = trunc (a1.SSBSECT_PTRM_START_DATE))
                                                    and trunc (a.SSBSECT_PTRM_START_DATE) = f_inicio;


                                                Exception
                                                when others then
                                                    crn:=null;
                                                    vn_lugares :=0;
                                                    vn_cupo_max:=0;
                                                    vn_cupo_act:=0;
                                                    f_inicio := null;
                                                    f_fin := null;
                                                    sem := null;
                                                    credit  := null;
                                                    credit_bill  := null;
                                                    gmod  := null;
                                                     -- dbms_output.put_line ('error de crea consulta '||sqlerrm);
                                                end;
                                        Else
                                                   -- dbms_output.put_line ('con profesor '||vl_existe);

                                               begin
                                                       select ssbsect_crn , ssbsect_seats_avail lugares, ssbsect_max_enrl cupo_max, SSBSECT_PTRM_CODE,
                                                                ssbsect_enrl cupo_Act,    SSBSECT_PTRM_START_DATE, SSBSECT_PTRM_END_DATE, SSBSECT_PTRM_WEEKS,
                                                                SSBSECT_CREDIT_HRS, SSBSECT_BILL_HRS, SSBSECT_GMOD_CODE
                                                        into crn , vn_lugares, vn_cupo_max, parte,
                                                               vn_cupo_act, f_inicio, f_fin, sem,
                                                               credit, credit_bill, gmod
                                                        from ssbsect a, sirasgn
                                                        where a.SSBSECT_TERM_CODE= peri
                                                        and a.ssbsect_subj_code= c.subj
                                                       and a.ssbsect_crse_numb=c.crse
                                                       and a.SSBSECT_SEQ_NUMB = c.grupo
                                                       and a.SSBSECT_SEATS_AVAIL >0
                                                       AND to_number (a.ssbsect_crn) = (select max (to_number (a1.ssbsect_crn))
                                                                                                        from ssbsect a1
                                                                                                        where a.SSBSECT_TERM_CODE = a1.SSBSECT_TERM_CODE
                                                                                                        and a.ssbsect_subj_code = a1.ssbsect_subj_code
                                                                                                        and a.ssbsect_crse_numb = a1.ssbsect_crse_numb
                                                                                                        and a.SSBSECT_SEQ_NUMB = a1.SSBSECT_SEQ_NUMB
                                                                                                        and a.SSBSECT_PTRM_START_DATE = a1.SSBSECT_PTRM_START_DATE
                                                                                                        )
                                                        and trunc (a.SSBSECT_PTRM_START_DATE) = f_inicio
                                                       And SIRASGN_PIDM = (select distinct  spriden_pidm
                                                                                            from spriden
                                                                                            where spriden_id = c.prof
                                                                                            And spriden_change_ind is null )
                                                        And SIRASGN_PRIMARY_IND = 'Y' ;
                                                       --  dbms_output.put_line ('crea consulta '||peri ||'*'|| c.subj  ||'*'||c.crse||'*'||c.grupo||'*'||f_inicio);

                                               Exception
                                                when others then
                                                    crn:=null;
                                                    vn_lugares :=0;
                                                    vn_cupo_max:=0;
                                                    vn_cupo_act:=0;
                                                    f_inicio := null;
                                                    f_fin := null;
                                                    sem := null;
                                                    credit  := null;
                                                    credit_bill  := null;
                                                    gmod  := null;
                                                    --dbms_output.put_line ('error de crea consulta '||sqlerrm);
                                               end;

                                        End if;



                                        If crn is not null then

                                              --dbms_output.put_line('Existe el Grupo:'||Parte ||' '||c.iden || c.subj ||c.crse);

                                            If vn_lugares >0  then
                                                    --dbms_output.put_line('Tiene Lugares:'||Parte ||' '||c.iden || c.subj ||c.crse);

                                                    If credit is null then
                                                       Begin
                                                              select SSRMEET_CREDIT_HR_SESS
                                                               Into credit
                                                              from SSRMEET
                                                              where SSRMEET_TERM_CODE = peri
                                                              And SSRMEET_CRN = crn;
                                                       Exception
                                                        When Others then
                                                           credit :=null;
                                                        End;

                                                          If credit is not null then
                                                                   Begin
                                                                       Update ssbsect
                                                                       set  SSBSECT_CREDIT_HRS = credit
                                                                       where SSBSECT_TERM_CODE = peri
                                                                       and SSBSECT_CRN = crn;
                                                                   Exception
                                                                   when Others then
                                                                        null;
                                                                   End;
                                                          End if;
                                                   End if;

                                                   If credit_bill is null then
                                                         Begin
                                                                 select  SCBCRSE_BILL_HR_LOW
                                                                    into credit_bill
                                                                    from scbcrse, scrschd
                                                                    where scbcrse_subj_code=  c.subj
                                                                    and     scbcrse_crse_numb=c.crse
                                                                    and     scbcrse_eff_term='000000'
                                                                    and     scrschd_subj_code=scbcrse_subj_code
                                                                    and     scrschd_crse_numb=scbcrse_crse_numb
                                                                    and     scrschd_eff_term=scbcrse_eff_term;
                                                         Exception
                                                         When Others then
                                                            credit_bill := 3;
                                                         End;

                                                         If credit is not null then
                                                                   Begin
                                                                       Update ssbsect
                                                                       set  SSBSECT_BILL_HRS = credit_bill
                                                                       where SSBSECT_TERM_CODE = peri
                                                                       and SSBSECT_CRN = crn;
                                                                   Exception
                                                                   when Others then
                                                                        null;
                                                                   End;
                                                         End if;
                                                   End if;

                                                  If gmod is null then
                                                        begin
                                                            select scrgmod_gmod_code
                                                            into gmod
                                                            from scrgmod
                                                            where scrgmod_subj_code=c.subj
                                                            and     scrgmod_crse_numb=c.crse
                                                            and     scrgmod_default_ind='D';
                                                        exception when others then
                                                            gmod:='1';
                                                        end;

                                                        If gmod is not null then
                                                                   Begin
                                                                       Update ssbsect
                                                                       set  SSBSECT_GMOD_CODE = gmod
                                                                       where SSBSECT_TERM_CODE = peri
                                                                       and SSBSECT_CRN = crn;
                                                                   Exception
                                                                   when Others then
                                                                        null;
                                                                   End;
                                                        end if;

                                                  End if;


                                                conta_ptrm :=0;

                                                    Begin
                                                         select count(*)
                                                            into conta_ptrm
                                                         from sfbetrm
                                                         where sfbetrm_term_code=peri
                                                         and     sfbetrm_pidm=c.pidm;
                                                    Exception
                                                        When Others then
                                                          conta_ptrm := 0;
                                                    End;


                                                     if conta_ptrm =0 then
                                                            Begin
                                                                    insert into sfbetrm values(peri, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFNVIN', null, 0,null,null, null,null,user,null);
                                                            Exception
                                                            When Others then
                                                                vl_error := ('Se presento un error al insertar en la tabla sfbetrm  '  ||c.iden || c.subj ||c.crse|| sqlerrm);
                                                            End;
                                                     end if;

                                                  Begin
                                                            select distinct max(sorlcur_key_seqno)
                                                                into sp
                                                            from sorlcur
                                                            where sorlcur_pidm=c.pidm
                                                            and     sorlcur_program=c.prog
                                                            and     sorlcur_lmod_code='LEARNER';
                                                   Exception
                                                   when Others then
                                                      sp := null;
                                                      vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                                   End;


                                                     --  calculamos la materi pade
                                                   begin
                                                   select GET_MATERIA_PADRE(c.materia)
                                                   into vmateria_padre
                                                    from dual;
                                                   exception when others  then
                                                       vmateria_padre := '';

                                                   end;

                                                   Begin
                                                      --dbms_output.put_line('Se inserta en el Grupo:'||Parte ||' '||c.iden || c.subj ||c.crse);
                                                       insert into sfrstcr values(
                                                                                        peri,     --SFRSTCR_TERM_CODE
                                                                                        c.pidm,     --SFRSTCR_PIDM
                                                                                        crn,     --SFRSTCR_CRN
                                                                                        1,     --SFRSTCR_CLASS_SORT_KEY
                                                                                        1,    --SFRSTCR_REG_SEQ
                                                                                        parte,    --SFRSTCR_PTRM_CODE
                                                                                        'RE',     --SFRSTCR_RSTS_CODE
                                                                                        sysdate,    --SFRSTCR_RSTS_DATE
                                                                                        null,    --SFRSTCR_ERROR_FLAG
                                                                                        null,    --SFRSTCR_MESSAGE
                                                                                        credit_bill,    --SFRSTCR_BILL_HR
                                                                                        3, --SFRSTCR_WAIV_HR
                                                                                        credit,     --SFRSTCR_CREDIT_HR
                                                                                        credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                                        credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                                        gmod,     --SFRSTCR_GMOD_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE_MID
                                                                                        null,    --SFRSTCR_GRDE_DATE
                                                                                        'N',    --SFRSTCR_DUPL_OVER
                                                                                        'N',    --SFRSTCR_LINK_OVER
                                                                                        'N',    --SFRSTCR_CORQ_OVER
                                                                                        'N',    --SFRSTCR_PREQ_OVER
                                                                                        'N',     --SFRSTCR_TIME_OVER
                                                                                        'N',     --SFRSTCR_CAPC_OVER
                                                                                        'N',     --SFRSTCR_LEVL_OVER
                                                                                        'N',     --SFRSTCR_COLL_OVER
                                                                                        'N',     --SFRSTCR_MAJR_OVER
                                                                                        'N',     --SFRSTCR_CLAS_OVER
                                                                                        'N',     --SFRSTCR_APPR_OVER
                                                                                        'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                                        sysdate,      --SFRSTCR_ADD_DATE
                                                                                        sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                                        nivel,     --SFRSTCR_LEVL_CODE
                                                                                        campus,     --SFRSTCR_CAMP_CODE
                                                                                        vmateria_padre,     --SFRSTCR_RESERVED_KEY
                                                                                        null,     --SFRSTCR_ATTEND_HR
                                                                                        'Y',     --SFRSTCR_REPT_OVER
                                                                                        'N' ,    --SFRSTCR_RPTH_OVER
                                                                                        null,    --SFRSTCR_TEST_OVER
                                                                                        'N',    --SFRSTCR_CAMP_OVER
                                                                                        user,    --SFRSTCR_USER
                                                                                        'N',    --SFRSTCR_DEGC_OVER
                                                                                        'N',    --SFRSTCR_PROG_OVER
                                                                                        null,    --SFRSTCR_LAST_ATTEND
                                                                                        null,    --SFRSTCR_GCMT_CODE
                                                                                        'SZFNVIN',    --SFRSTCR_DATA_ORIGIN
                                                                                        sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                                        'N',  --SFRSTCR_DEPT_OVER
                                                                                        'N',  --SFRSTCR_ATTS_OVER
                                                                                        'N', --SFRSTCR_CHRT_OVER
                                                                                        null, --SFRSTCR_RMSG_CDE
                                                                                        null,  --SFRSTCR_WL_PRIORITY
                                                                                        null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                                        null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                                        null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                                        'N', --SFRSTCR_MEXC_OVER
                                                                                        sp,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                                        null,--SFRSTCR_BRDH_SEQ_NUM
                                                                                        '01',--SFRSTCR_BLCK_CODE
                                                                                        null,--SFRSTCR_STRH_SEQNO
                                                                                        null, --SFRSTCR_STRD_SEQNO
                                                                                        null,  --SFRSTCR_SURROGATE_ID
                                                                                        null, --SFRSTCR_VERSION
                                                                                        user,--SFRSTCR_USER_ID
                                                                                        no_recibo );--SFRSTCR_VPDI_CODE



                                                                Begin
                                                                     update ssbsect
                                                                            set ssbsect_enrl = ssbsect_enrl + 1
                                                                      where SSBSECT_TERM_CODE = peri
                                                                      And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                vl_error := 'Se presento un error al actualizar el enrolamiento ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                                End;

                                                                Begin
                                                                        update ssbsect
                                                                            set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                                        where SSBSECT_TERM_CODE = peri
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                                                End;

                                                                Begin
                                                                         update ssbsect
                                                                                set ssbsect_census_enrl=ssbsect_enrl
                                                                         Where SSBSECT_TERM_CODE = peri
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                                                End;


                                                                conta_ptrm:=0;

                                                                Begin
                                                                    Select count (*)
                                                                        Into conta_ptrm
                                                                    from sfrareg
                                                                    where SFRAREG_PIDM = c.pidm
                                                                    And SFRAREG_TERM_CODE = peri
                                                                    And SFRAREG_CRN = crn
                                                                    And SFRAREG_EXTENSION_NUMBER = 0
                                                                    And SFRAREG_RSTS_CODE = 'RE';
                                                                Exception
                                                                When Others then
                                                                   conta_ptrm :=0;
                                                                End;

                                                                If conta_ptrm = 0 then

                                                                     Begin
                                                                             insert into sfrareg values(c.pidm, peri, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFNVIN', sysdate, null,null,null);
                                                                     Exception
                                                                       When Others then
                                                                          vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                                     End;
                                                                End if;

                                                         vl_existe :=0;

                                                              Begin
                                                                 Select count(1)
                                                                 Into vl_existe
                                                                 from SHRINST
                                                                 Where  SHRINST_TERM_CODE = peri
                                                                 And SHRINST_CRN = crn
                                                                 And  SHRINST_PIDM = c.pidm;
                                                              Exception
                                                              When Others then
                                                               vl_existe :=0;
                                                              End;


                                                              If vl_existe = 0 then
                                                                    Begin
                                                                        Insert into SHRINST values (peri,        --SHRINST_TERM_CODE
                                                                                                                 crn,       --SHRINST_CRN
                                                                                                                 c.pidm,       --SHRINST_PIDM
                                                                                                                 sysdate,       --SHRINST_ACTIVITY_DATE
                                                                                                                 'Y',       --SHRINST_PRIMARY_IND
                                                                                                                  null,      --SHRINST_SURROGATE_ID
                                                                                                                  null,      --SHRINST_VERSION
                                                                                                                 user,       --SHRINST_USER_ID
                                                                                                                 'SZFNVIN',       --SHRINST_DATA_ORIGIN
                                                                                                                  null);      --SHRINST_VPDI_CODE


                                                                    Exception
                                                                        When Others then
                                                                         vl_error := 'Se presento un error al insertar al alumno en SHRINST ' ||sqlerrm;
                                                                    End;

                                                              End if;


                                                                Begin
                                                                    Update sgbstdn a
                                                                    set a.SGBSTDN_STYP_CODE ='N'
                                                                    Where a.SGBSTDN_PIDM = c.pidm
                                                                    And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                                           from sgbstdn a1
                                                                                                                           Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                                          --- And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1
                                                                                                                           )
                                                                    -- And a.SGBSTDN_PROGRAM_1 = c.prog
                                                                     ;
                                                                Exception
                                                                    When Others then
                                                                    vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                                                End;


                                                    Exception
                                                   when Others then
                                                       vl_error := 'Se presento un error al insertar al alumno en el grupo ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                                   End;

                                            Else  ----------> Se realizara la creacion del grupo
                                                   --dbms_output.put_line('SE crea grupo Nuevo por Cupo:'||Parte ||' '||c.iden || c.subj ||c.crse);

                                                    schd := null;
                                                    title := null;
                                                    credit := null;
                                                    gmod :=null;
                                                    credit_bill :=null;

                                                    Begin
                                                        select scrschd_schd_code, scbcrse_title, scbcrse_credit_hr_low, SCBCRSE_BILL_HR_LOW
                                                        into schd, title, credit, credit_bill
                                                        from scbcrse, scrschd
                                                        where scbcrse_subj_code=c.subj
                                                        and     scbcrse_crse_numb=c.crse
                                                        and     scbcrse_eff_term='000000'
                                                        and     scrschd_subj_code=scbcrse_subj_code
                                                        and     scrschd_crse_numb=scbcrse_crse_numb
                                                        and     scrschd_eff_term=scbcrse_eff_term;
                                                    Exception
                                                    When Others then
                                                          schd := null;
                                                          title := null;
                                                          credit := null;
                                                          credit_bill := null;
                                                    End;


                                                    begin
                                                        select scrgmod_gmod_code
                                                              into gmod
                                                        from scrgmod
                                                        where scrgmod_subj_code=c.subj
                                                        and     scrgmod_crse_numb=c.crse
                                                        and     scrgmod_default_ind='D';
                                                    exception when others then
                                                        gmod:='1';
                                                    end;

                                                     Begin
                                                            select nvl(max(ssbsect_crn),1000)+1
                                                                 into crn
                                                            from ssbsect where ssbsect_term_code= peri;
                                                      Exception
                                                            When Others then
                                                               crn := null;
                                                     End;

                                                     If crn is not null then
                                                           Begin
                                                               select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                                                               into f_inicio, f_fin, sem
                                                               from sobptrm
                                                               where sobptrm_term_code=Peri
                                                               and     sobptrm_ptrm_code=parte;
                                                           Exception
                                                           When Others then
                                                            f_inicio:= null;
                                                            f_fin := null;
                                                            sem :=null;
                                                           End;

                                                     --dbms_output.put_line('SE crea grupo Nuevo por Cupo ahora:'||Parte ||' '||c.iden || c.subj ||c.crse);

                                                          Begin
                                                                Insert into ssbsect values (
                                                                                                   Peri,     --SSBSECT_TERM_CODE
                                                                                                   crn,     --SSBSECT_CRN
                                                                                                   parte,     --SSBSECT_PTRM_CODE
                                                                                                   c.subj,     --SSBSECT_SUBJ_CODE
                                                                                                   c.crse,     --SSBSECT_CRSE_NUMB
                                                                                                    '01',     --SSBSECT_SEQ_NUMB
                                                                                                    'A',    --SSBSECT_SSTS_CODE
                                                                                                    schd,    --SSBSECT_SCHD_CODE
                                                                                                    campus,    --SSBSECT_CAMP_CODE
                                                                                                     title,   --SSBSECT_CRSE_TITLE
                                                                                                     credit,   --SSBSECT_CREDIT_HRS
                                                                                                     credit_bill,   --SSBSECT_BILL_HRS
                                                                                                     gmod,   --SSBSECT_GMOD_CODE
                                                                                                      null,  --SSBSECT_SAPR_CODE
                                                                                                      null, --SSBSECT_SESS_CODE
                                                                                                      null,  --SSBSECT_LINK_IDENT
                                                                                                      null,  --SSBSECT_PRNT_IND
                                                                                                      'Y',  --SSBSECT_GRADABLE_IND
                                                                                                       null,  --SSBSECT_TUIW_IND
                                                                                                       0, --SSBSECT_REG_ONEUP
                                                                                                       0, --SSBSECT_PRIOR_ENRL
                                                                                                       0, --SSBSECT_PROJ_ENRL
                                                                                                       50, --SSBSECT_MAX_ENRL
                                                                                                        0,--SSBSECT_ENRL
                                                                                                        50,--SSBSECT_SEATS_AVAIL
                                                                                                        null,--SSBSECT_TOT_CREDIT_HRS
                                                                                                        '0',--SSBSECT_CENSUS_ENRL
                                                                                                        f_inicio,--SSBSECT_CENSUS_ENRL_DATE
                                                                                                        sysdate,--SSBSECT_ACTIVITY_DATE
                                                                                                        f_inicio,--SSBSECT_PTRM_START_DATE
                                                                                                        f_fin,--SSBSECT_PTRM_END_DATE
                                                                                                        sem,--SSBSECT_PTRM_WEEKS
                                                                                                        null,--SSBSECT_RESERVED_IND
                                                                                                        null, --SSBSECT_WAIT_CAPACITY
                                                                                                        null,--SSBSECT_WAIT_COUNT
                                                                                                        null,--SSBSECT_WAIT_AVAIL
                                                                                                        null,--SSBSECT_LEC_HR
                                                                                                        null,--SSBSECT_LAB_HR
                                                                                                        null,--SSBSECT_OTH_HR
                                                                                                        null,--SSBSECT_CONT_HR
                                                                                                        null,--SSBSECT_ACCT_CODE
                                                                                                        null,--SSBSECT_ACCL_CODE
                                                                                                        null,--SSBSECT_CENSUS_2_DATE
                                                                                                        null,--SSBSECT_ENRL_CUT_OFF_DATE
                                                                                                        null,--SSBSECT_ACAD_CUT_OFF_DATE
                                                                                                        null,--SSBSECT_DROP_CUT_OFF_DATE
                                                                                                        null,--SSBSECT_CENSUS_2_ENRL
                                                                                                        'Y',--SSBSECT_VOICE_AVAIL
                                                                                                        'N',--SSBSECT_CAPP_PREREQ_TEST_IND
                                                                                                        null,--SSBSECT_GSCH_NAME
                                                                                                        null,--SSBSECT_BEST_OF_COMP
                                                                                                        null,--SSBSECT_SUBSET_OF_COMP
                                                                                                        'NOP',--SSBSECT_INSM_CODE
                                                                                                        null,--SSBSECT_REG_FROM_DATE
                                                                                                        null,--SSBSECT_REG_TO_DATE
                                                                                                        null,--SSBSECT_LEARNER_REGSTART_FDATE
                                                                                                        null,--SSBSECT_LEARNER_REGSTART_TDATE
                                                                                                        null,--SSBSECT_DUNT_CODE
                                                                                                        null,--SSBSECT_NUMBER_OF_UNITS
                                                                                                        0,--SSBSECT_NUMBER_OF_EXTENSIONS
                                                                                                        'SZFNVIN',--SSBSECT_DATA_ORIGIN
                                                                                                        user,--SSBSECT_USER_ID
                                                                                                        'MOOD',--SSBSECT_INTG_CDE
                                                                                                        'B',--SSBSECT_PREREQ_CHK_METHOD_CDE
                                                                                                        user,--SSBSECT_KEYWORD_INDEX_ID
                                                                                                        null,--SSBSECT_SCORE_OPEN_DATE
                                                                                                        null,--SSBSECT_SCORE_CUTOFF_DATE
                                                                                                        null,--SSBSECT_REAS_SCORE_OPEN_DATE
                                                                                                        null,--SSBSECT_REAS_SCORE_CTOF_DATE
                                                                                                        null,--SSBSECT_SURROGATE_ID
                                                                                                        null,--SSBSECT_VERSION
                                                                                                         null);--SSBSECT_VPDI_CODE

                                                                           Begin
                                                                                insert into ssrmeet values(peri, crn, null,null,null,null,null,null, sysdate, f_inicio, f_fin, '01', null,null,null,null,null,null,null, 'ENL', null, credit, null, 0, null,null,null, 'CLVI', 'SZFNVIN', user, null,null,null);
                                                                            Exception
                                                                            when Others then
                                                                               vl_error := 'Se presento un Error al insertar en ssrmeet ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                                                           End;

                                                                           pidm_prof := null;

--                                                                            If  c.prof is null then
--                                                                                c.prof :=  '019814933';
--                                                                            End if;

                                                                            begin
                                                                            select spriden_pidm into pidm_prof
                                                                            from  spriden
                                                                            where   spriden_id=c.prof and spriden_change_ind is null;
                                                                            exception when others then
                                                                            pidm_prof:=null;
                                                                            end;

                                                                            if pidm_prof is not null then
                                                                                    Begin
                                                                                            insert into sirasgn values(ciclo, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,  sysdate, null,null,null,null, 'SZFNVIN', user, null, null, null, null,  null,null);
                                                                                    Exception
                                                                                    When Others then
                                                                                    null;
                                                                                    End;
                                                                            end if;


                                                                        conta_ptrm :=0;

                                                                            Begin
                                                                                 select count(*)
                                                                                    into conta_ptrm
                                                                                 from sfbetrm
                                                                                 where sfbetrm_term_code=peri
                                                                                 and     sfbetrm_pidm=c.pidm;
                                                                            Exception
                                                                                When Others then
                                                                                  conta_ptrm := 0;
                                                                            End;


                                                                             if conta_ptrm =0 then
                                                                                    Begin
                                                                                            insert into sfbetrm values(peri, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFNVIN', null, 0,null,null, null,null,user,null);
                                                                                    Exception
                                                                                    When Others then
                                                                                        vl_error := ('Se presento un error al insertar en la tabla sfbetrm ' ||c.iden || c.subj ||c.crse || sqlerrm);
                                                                                    End;
                                                                             end if;



                                                                            Begin
                                                                                select sgbstdn_levl_code, sgbstdn_camp_code  into levl, camp
                                                                                from sgbstdn a
                                                                                where sgbstdn_pidm=c.pidm
                                                                                and     sgbstdn_term_code_eff  in (select max(sgbstdn_term_code_eff) from sgbstdn aa
                                                                                                                                   where a.sgbstdn_pidm=aa.sgbstdn_pidm);
                                                                            Exception
                                                                            When Others then
                                                                               levl := null;
                                                                               camp := null;
                                                                               vl_error := 'Se presento un error al obtener la informacion de SGBSTDN '||c.iden || c.subj ||c.crse || sqlerrm;
                                                                            End;

                                                                           Begin
                                                                                    select distinct max(sorlcur_key_seqno)
                                                                                        into sp
                                                                                    from sorlcur
                                                                                    where sorlcur_pidm=c.pidm
                                                                                    and     sorlcur_program=c.prog
                                                                                    and     sorlcur_lmod_code='LEARNER';
                                                                           Exception
                                                                           when Others then
                                                                              sp := null;
                                                                              vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                                           End;

                                                                                --  calculamos la materi pade
                                                                               begin
                                                                               select GET_MATERIA_PADRE(c.materia)
                                                                               into vmateria_padre
                                                                                from dual;
                                                                               exception when others  then
                                                                                   vmateria_padre := '';

                                                                               end;

                                                                           Begin

                                                                               insert into sfrstcr values(
                                                                                                                peri,     --SFRSTCR_TERM_CODE
                                                                                                                c.pidm,     --SFRSTCR_PIDM
                                                                                                                crn,     --SFRSTCR_CRN
                                                                                                                1,     --SFRSTCR_CLASS_SORT_KEY
                                                                                                                1,    --SFRSTCR_REG_SEQ
                                                                                                                parte,    --SFRSTCR_PTRM_CODE
                                                                                                                'RE',     --SFRSTCR_RSTS_CODE
                                                                                                                sysdate,    --SFRSTCR_RSTS_DATE
                                                                                                                null,    --SFRSTCR_ERROR_FLAG
                                                                                                                null,    --SFRSTCR_MESSAGE
                                                                                                                credit_bill,    --SFRSTCR_BILL_HR
                                                                                                                3, --SFRSTCR_WAIV_HR
                                                                                                                credit,     --SFRSTCR_CREDIT_HR
                                                                                                                credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                                                                credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                                                                gmod,     --SFRSTCR_GMOD_CODE
                                                                                                                null,    --SFRSTCR_GRDE_CODE
                                                                                                                null,    --SFRSTCR_GRDE_CODE_MID
                                                                                                                null,    --SFRSTCR_GRDE_DATE
                                                                                                                'N',    --SFRSTCR_DUPL_OVER
                                                                                                                'N',    --SFRSTCR_LINK_OVER
                                                                                                                'N',    --SFRSTCR_CORQ_OVER
                                                                                                                'N',    --SFRSTCR_PREQ_OVER
                                                                                                                'N',     --SFRSTCR_TIME_OVER
                                                                                                                'N',     --SFRSTCR_CAPC_OVER
                                                                                                                'N',     --SFRSTCR_LEVL_OVER
                                                                                                                'N',     --SFRSTCR_COLL_OVER
                                                                                                                'N',     --SFRSTCR_MAJR_OVER
                                                                                                                'N',     --SFRSTCR_CLAS_OVER
                                                                                                                'N',     --SFRSTCR_APPR_OVER
                                                                                                                'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                                                                sysdate,      --SFRSTCR_ADD_DATE
                                                                                                                sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                                                                levl,     --SFRSTCR_LEVL_CODE
                                                                                                                camp,     --SFRSTCR_CAMP_CODE
                                                                                                                vmateria_padre,     --SFRSTCR_RESERVED_KEY
                                                                                                                null,     --SFRSTCR_ATTEND_HR
                                                                                                                'Y',     --SFRSTCR_REPT_OVER
                                                                                                                'N' ,    --SFRSTCR_RPTH_OVER
                                                                                                                null,    --SFRSTCR_TEST_OVER
                                                                                                                'N',    --SFRSTCR_CAMP_OVER
                                                                                                                user,    --SFRSTCR_USER
                                                                                                                'N',    --SFRSTCR_DEGC_OVER
                                                                                                                'N',    --SFRSTCR_PROG_OVER
                                                                                                                null,    --SFRSTCR_LAST_ATTEND
                                                                                                                null,    --SFRSTCR_GCMT_CODE
                                                                                                                'SZFNVIN',    --SFRSTCR_DATA_ORIGIN
                                                                                                                sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                                                                'N',  --SFRSTCR_DEPT_OVER
                                                                                                                'N',  --SFRSTCR_ATTS_OVER
                                                                                                                'N', --SFRSTCR_CHRT_OVER
                                                                                                                null, --SFRSTCR_RMSG_CDE
                                                                                                                null,  --SFRSTCR_WL_PRIORITY
                                                                                                                null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                                                                null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                                                                null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                                                                'N', --SFRSTCR_MEXC_OVER
                                                                                                                sp,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                                                                null,--SFRSTCR_BRDH_SEQ_NUM
                                                                                                                '01',--SFRSTCR_BLCK_CODE
                                                                                                                null,--SFRSTCR_STRH_SEQNO
                                                                                                                null, --SFRSTCR_STRD_SEQNO
                                                                                                                null,  --SFRSTCR_SURROGATE_ID
                                                                                                                null, --SFRSTCR_VERSION
                                                                                                                user,--SFRSTCR_USER_ID
                                                                                                                no_recibo );--SFRSTCR_VPDI_CODE



                                                                                        Begin
                                                                                             update ssbsect
                                                                                                    set ssbsect_enrl = ssbsect_enrl + 1
                                                                                              where SSBSECT_TERM_CODE = peri
                                                                                              And SSBSECT_CRN  = crn;
                                                                                        Exception
                                                                                        When Others then
                                                                                        vl_error := 'Se presento un error al actualizar el enrolamiento '||c.iden || c.subj ||c.crse ||sqlerrm;
                                                                                        End;

                                                                                        Begin
                                                                                                update ssbsect
                                                                                                    set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                                                                where SSBSECT_TERM_CODE = peri
                                                                                                 And SSBSECT_CRN  = crn;
                                                                                        Exception
                                                                                        When Others then
                                                                                            vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                                                                        End;

                                                                                        Begin
                                                                                                 update ssbsect
                                                                                                        set ssbsect_census_enrl=ssbsect_enrl
                                                                                                 Where SSBSECT_TERM_CODE = peri
                                                                                                 And SSBSECT_CRN  = crn;
                                                                                        Exception
                                                                                        When Others then
                                                                                            vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                                                        End;


                                                                                        conta_ptrm:=0;

                                                                                        Begin
                                                                                            Select count (*)
                                                                                                Into conta_ptrm
                                                                                            from sfrareg
                                                                                            where SFRAREG_PIDM = c.pidm
                                                                                            And SFRAREG_TERM_CODE = peri
                                                                                            And SFRAREG_CRN = crn
                                                                                            And SFRAREG_EXTENSION_NUMBER = 0
                                                                                            And SFRAREG_RSTS_CODE = 'RE';
                                                                                        Exception
                                                                                        When Others then
                                                                                           conta_ptrm :=0;
                                                                                        End;

                                                                                        If conta_ptrm = 0 then

                                                                                             Begin
                                                                                                     insert into sfrareg values(c.pidm, peri, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFNVIN', sysdate, null,null,null);
                                                                                             Exception
                                                                                               When Others then
                                                                                                  vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                                                                             End;
                                                                                        End if;

                                                                                         vl_existe :=0;

                                                                                              Begin
                                                                                                 Select count(1)
                                                                                                 Into vl_existe
                                                                                                 from SHRINST
                                                                                                 Where  SHRINST_TERM_CODE = peri
                                                                                                 And SHRINST_CRN = crn
                                                                                                 And  SHRINST_PIDM = c.pidm;
                                                                                              Exception
                                                                                              When Others then
                                                                                               vl_existe :=0;
                                                                                              End;


                                                                                              If vl_existe = 0 then
                                                                                                    Begin
                                                                                                        Insert into SHRINST values (peri,        --SHRINST_TERM_CODE
                                                                                                                                                 crn,       --SHRINST_CRN
                                                                                                                                                 c.pidm,       --SHRINST_PIDM
                                                                                                                                                 sysdate,       --SHRINST_ACTIVITY_DATE
                                                                                                                                                 'Y',       --SHRINST_PRIMARY_IND
                                                                                                                                                  null,      --SHRINST_SURROGATE_ID
                                                                                                                                                  null,      --SHRINST_VERSION
                                                                                                                                                 user,       --SHRINST_USER_ID
                                                                                                                                                 'SZFNVIN',       --SHRINST_DATA_ORIGIN
                                                                                                                                                  null);      --SHRINST_VPDI_CODE


                                                                                                    Exception
                                                                                                        When Others then
                                                                                                         vl_error := 'Se presento un error al insertar al alumno en SHRINST ' ||sqlerrm;
                                                                                                    End;

                                                                                              End if;


                                                                                             Begin
                                                                                                Update sgbstdn a
                                                                                                set a.SGBSTDN_STYP_CODE ='N'
                                                                                                Where a.SGBSTDN_PIDM = c.pidm
                                                                                                And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                                                                       from sgbstdn a1
                                                                                                                                                       Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                                                                      --- And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1
                                                                                                                                                       )
                                                                                                -- And a.SGBSTDN_PROGRAM_1 = c.prog
                                                                                                 ;
                                                                                            Exception
                                                                                                When Others then
                                                                                                vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                                                                            End;




                                                                            Exception
                                                                           when Others then
                                                                               vl_error := 'Se presento un error al insertar al alumno en el grupo ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                                                           End;


                                                          Exception
                                                            When Others then
                                                              vl_error := 'Se presento un Error al insertar el nuevo grupo 1 ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                                          End;
                                                     End if;

                                            --dbms_output.put_line('mensaje:'|| 'No hay grupo cupo');
                                             End if;
                                        Else
                                            --dbms_output.put_line('mensaje:'|| 'No hay grupo creado Nuevo');
                                                    schd := null;
                                                    title := null;
                                                    credit := null;
                                                    gmod :=null;
                                                    credit_bill :=null;

                                                --dbms_output.put_line('Entra a buscar informacion '||c.iden || c.subj ||c.crse );

                                                    Begin
                                                        select scrschd_schd_code, scbcrse_title, scbcrse_credit_hr_low, SCBCRSE_BILL_HR_LOW
                                                        into schd, title, credit, credit_bill
                                                        from scbcrse, scrschd
                                                        where scbcrse_subj_code=c.subj
                                                        and     scbcrse_crse_numb=c.crse
                                                        and     scbcrse_eff_term='000000'
                                                        and     scrschd_subj_code=scbcrse_subj_code
                                                        and     scrschd_crse_numb=scbcrse_crse_numb
                                                        and     scrschd_eff_term=scbcrse_eff_term;
                                                    Exception
                                                    When Others then
                                                          schd := null;
                                                          title := null;
                                                          credit := null;
                                                          credit_bill := null;
                                                    End;


                                                    begin
                                                        select scrgmod_gmod_code
                                                              into gmod
                                                        from scrgmod
                                                        where scrgmod_subj_code=c.subj
                                                        and     scrgmod_crse_numb=c.crse
                                                        and     scrgmod_default_ind='D';
                                                    exception when others then
                                                        gmod:='1';
                                                    end;

                                                     Begin
                                                            select nvl(max(ssbsect_crn),1000)+1
                                                                 into crn
                                                            from ssbsect where ssbsect_term_code= peri;
                                                      Exception
                                                            When Others then
                                                               crn := null;
                                                     End;

                                                     If crn is not null then
                                                     --dbms_output.put_line('entra a crear el grupo '||c.iden || c.subj ||c.crse );

                                                           Begin
                                                               select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                                                               into f_inicio, f_fin, sem
                                                               from sobptrm
                                                               where sobptrm_term_code=Peri
                                                               and     sobptrm_ptrm_code=parte;
                                                           Exception
                                                           When Others then
                                                            f_inicio:= null;
                                                            f_fin := null;
                                                            sem :=null;
                                                           End;

                                                      --dbms_output.put_line('entra a crear el grupo ssbsect '||c.iden || c.subj ||c.crse );

                                                                            Begin
                                                                                    Insert into ssbsect values (
                                                                                                                       Peri,     --SSBSECT_TERM_CODE
                                                                                                                       crn,     --SSBSECT_CRN
                                                                                                                       parte,     --SSBSECT_PTRM_CODE
                                                                                                                       c.subj,     --SSBSECT_SUBJ_CODE
                                                                                                                       c.crse,     --SSBSECT_CRSE_NUMB
                                                                                                                        '01',     --SSBSECT_SEQ_NUMB
                                                                                                                        'A',    --SSBSECT_SSTS_CODE
                                                                                                                        schd,    --SSBSECT_SCHD_CODE
                                                                                                                        campus,    --SSBSECT_CAMP_CODE
                                                                                                                         title,   --SSBSECT_CRSE_TITLE
                                                                                                                         credit,   --SSBSECT_CREDIT_HRS
                                                                                                                         credit_bill,   --SSBSECT_BILL_HRS
                                                                                                                         gmod,   --SSBSECT_GMOD_CODE
                                                                                                                          null,  --SSBSECT_SAPR_CODE
                                                                                                                          null, --SSBSECT_SESS_CODE
                                                                                                                          null,  --SSBSECT_LINK_IDENT
                                                                                                                          null,  --SSBSECT_PRNT_IND
                                                                                                                          'Y',  --SSBSECT_GRADABLE_IND
                                                                                                                           null,  --SSBSECT_TUIW_IND
                                                                                                                           0, --SSBSECT_REG_ONEUP
                                                                                                                           0, --SSBSECT_PRIOR_ENRL
                                                                                                                           0, --SSBSECT_PROJ_ENRL
                                                                                                                           50, --SSBSECT_MAX_ENRL
                                                                                                                            0,--SSBSECT_ENRL
                                                                                                                            50,--SSBSECT_SEATS_AVAIL
                                                                                                                            null,--SSBSECT_TOT_CREDIT_HRS
                                                                                                                            '0',--SSBSECT_CENSUS_ENRL
                                                                                                                            f_inicio,--SSBSECT_CENSUS_ENRL_DATE
                                                                                                                            sysdate,--SSBSECT_ACTIVITY_DATE
                                                                                                                            f_inicio,--SSBSECT_PTRM_START_DATE
                                                                                                                            f_fin,--SSBSECT_PTRM_END_DATE
                                                                                                                            sem,--SSBSECT_PTRM_WEEKS
                                                                                                                            null,--SSBSECT_RESERVED_IND
                                                                                                                            null, --SSBSECT_WAIT_CAPACITY
                                                                                                                            null,--SSBSECT_WAIT_COUNT
                                                                                                                            null,--SSBSECT_WAIT_AVAIL
                                                                                                                            null,--SSBSECT_LEC_HR
                                                                                                                            null,--SSBSECT_LAB_HR
                                                                                                                            null,--SSBSECT_OTH_HR
                                                                                                                            null,--SSBSECT_CONT_HR
                                                                                                                            null,--SSBSECT_ACCT_CODE
                                                                                                                            null,--SSBSECT_ACCL_CODE
                                                                                                                            null,--SSBSECT_CENSUS_2_DATE
                                                                                                                            null,--SSBSECT_ENRL_CUT_OFF_DATE
                                                                                                                            null,--SSBSECT_ACAD_CUT_OFF_DATE
                                                                                                                            null,--SSBSECT_DROP_CUT_OFF_DATE
                                                                                                                            null,--SSBSECT_CENSUS_2_ENRL
                                                                                                                            'Y',--SSBSECT_VOICE_AVAIL
                                                                                                                            'N',--SSBSECT_CAPP_PREREQ_TEST_IND
                                                                                                                            null,--SSBSECT_GSCH_NAME
                                                                                                                            null,--SSBSECT_BEST_OF_COMP
                                                                                                                            null,--SSBSECT_SUBSET_OF_COMP
                                                                                                                            'NOP',--SSBSECT_INSM_CODE
                                                                                                                            null,--SSBSECT_REG_FROM_DATE
                                                                                                                            null,--SSBSECT_REG_TO_DATE
                                                                                                                            null,--SSBSECT_LEARNER_REGSTART_FDATE
                                                                                                                            null,--SSBSECT_LEARNER_REGSTART_TDATE
                                                                                                                            null,--SSBSECT_DUNT_CODE
                                                                                                                            null,--SSBSECT_NUMBER_OF_UNITS
                                                                                                                            0,--SSBSECT_NUMBER_OF_EXTENSIONS
                                                                                                                            'SZFNVIN',--SSBSECT_DATA_ORIGIN
                                                                                                                            user,--SSBSECT_USER_ID
                                                                                                                            'MOOD',--SSBSECT_INTG_CDE
                                                                                                                            'B',--SSBSECT_PREREQ_CHK_METHOD_CDE
                                                                                                                            user,--SSBSECT_KEYWORD_INDEX_ID
                                                                                                                            null,--SSBSECT_SCORE_OPEN_DATE
                                                                                                                            null,--SSBSECT_SCORE_CUTOFF_DATE
                                                                                                                            null,--SSBSECT_REAS_SCORE_OPEN_DATE
                                                                                                                            null,--SSBSECT_REAS_SCORE_CTOF_DATE
                                                                                                                            null,--SSBSECT_SURROGATE_ID
                                                                                                                            null,--SSBSECT_VERSION
                                                                                                                             null);--SSBSECT_VPDI_CODE
                                                                            Exception
                                                                            When Others then
                                                                              vl_error := 'Se presento un Error al insertar en SSBSECT Grupo Nuevo ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                                            End;

                                                                           -- dbms_output.put_line('Grupo creado el grupo ssbsect '||c.iden || c.subj ||c.crse );
                                                                           Begin
                                                                                insert into ssrmeet values(peri, crn, null,null,null,null,null,null, sysdate, f_inicio, f_fin, '01', null,null,null,null,null,null,null, 'ENL', null, credit, null, 0, null,null,null, 'CLVI', 'SZFNVIN', user, null,null,null);
                                                                            Exception
                                                                            when Others then
                                                                               vl_error := 'Se presento un Error al insertar en ssrmeet ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                                           End;

                                                                                      -- dbms_output.put_line('Grupo creado el grupo ssrmeet '||c.iden || c.subj ||c.crse );
                                                                            pidm_prof := null;
--                                                                            If  c.prof is null then
--                                                                               c.prof :=  '019814933';
--                                                                            End if;


                                                                            begin
                                                                                select spriden_pidm into pidm_prof
                                                                                from  spriden
                                                                                where   spriden_id=c.prof and spriden_change_ind is null;
                                                                            Exception when others then
                                                                              pidm_prof:=null;
                                                                            End;

                                                                            if pidm_prof is not null then
                                                                                Begin
                                                                                        insert into sirasgn values(ciclo, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,  sysdate, null,null,null,null, 'SZFNVIN', user, null, null, null, null,  null,null);
                                                                                Exception
                                                                                When Others then
                                                                                null;
                                                                                End;
                                                                            end if;


                                                                        conta_ptrm :=0;

                                                                            Begin
                                                                                 select count(*)
                                                                                    into conta_ptrm
                                                                                 from sfbetrm
                                                                                 where sfbetrm_term_code=peri
                                                                                 and     sfbetrm_pidm=c.pidm;
                                                                            Exception
                                                                                When Others then
                                                                                  conta_ptrm := 0;
                                                                            End;


                                                                             if conta_ptrm =0 then
                                                                                    Begin
                                                                                            insert into sfbetrm values(peri, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFNVIN', null, 0,null,null, null,null,user,null);
                                                                                    Exception
                                                                                    When Others then
                                                                                        vl_error := ('Se presento un error al insertar en la tabla sfbetrm ' ||c.iden || c.subj ||c.crse || sqlerrm);
                                                                                    End;
                                                                             end if;




                                                                           Begin
                                                                                    select distinct max(sorlcur_key_seqno)
                                                                                        into sp
                                                                                    from sorlcur
                                                                                    where sorlcur_pidm=c.pidm
                                                                                    and     sorlcur_program=c.prog
                                                                                    and     sorlcur_lmod_code='LEARNER';
                                                                           Exception
                                                                           when Others then
                                                                              sp := null;
                                                                              vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                                           End;
                                                                  --  calculamos la materi pade
                                                                               begin
                                                                               select GET_MATERIA_PADRE(c.materia)
                                                                               into vmateria_padre
                                                                                from dual;
                                                                               exception when others  then
                                                                                   vmateria_padre := '';

                                                                               end;

                                                                           Begin

                                                                           --dbms_output.put_line('registra en Inscripciont '||c.iden || c.subj ||c.crse ||'*'||crn );

                                                                               insert into sfrstcr values(
                                                                                                                peri,     --SFRSTCR_TERM_CODE
                                                                                                                c.pidm,     --SFRSTCR_PIDM
                                                                                                                crn,     --SFRSTCR_CRN
                                                                                                                1,     --SFRSTCR_CLASS_SORT_KEY
                                                                                                                1,    --SFRSTCR_REG_SEQ
                                                                                                                parte,    --SFRSTCR_PTRM_CODE
                                                                                                                'RE',     --SFRSTCR_RSTS_CODE
                                                                                                                sysdate,    --SFRSTCR_RSTS_DATE
                                                                                                                null,    --SFRSTCR_ERROR_FLAG
                                                                                                                null,    --SFRSTCR_MESSAGE
                                                                                                                credit_bill,    --SFRSTCR_BILL_HR
                                                                                                                3, --SFRSTCR_WAIV_HR
                                                                                                                credit,     --SFRSTCR_CREDIT_HR
                                                                                                                credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                                                                credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                                                                gmod,     --SFRSTCR_GMOD_CODE
                                                                                                                null,    --SFRSTCR_GRDE_CODE
                                                                                                                null,    --SFRSTCR_GRDE_CODE_MID
                                                                                                                null,    --SFRSTCR_GRDE_DATE
                                                                                                                'N',    --SFRSTCR_DUPL_OVER
                                                                                                                'N',    --SFRSTCR_LINK_OVER
                                                                                                                'N',    --SFRSTCR_CORQ_OVER
                                                                                                                'N',    --SFRSTCR_PREQ_OVER
                                                                                                                'N',     --SFRSTCR_TIME_OVER
                                                                                                                'N',     --SFRSTCR_CAPC_OVER
                                                                                                                'N',     --SFRSTCR_LEVL_OVER
                                                                                                                'N',     --SFRSTCR_COLL_OVER
                                                                                                                'N',     --SFRSTCR_MAJR_OVER
                                                                                                                'N',     --SFRSTCR_CLAS_OVER
                                                                                                                'N',     --SFRSTCR_APPR_OVER
                                                                                                                'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                                                                sysdate,      --SFRSTCR_ADD_DATE
                                                                                                                sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                                                                nivel,     --SFRSTCR_LEVL_CODE
                                                                                                                campus,     --SFRSTCR_CAMP_CODE
                                                                                                                vmateria_padre,     --SFRSTCR_RESERVED_KEY
                                                                                                                null,     --SFRSTCR_ATTEND_HR
                                                                                                                'Y',     --SFRSTCR_REPT_OVER
                                                                                                                'N' ,    --SFRSTCR_RPTH_OVER
                                                                                                                null,    --SFRSTCR_TEST_OVER
                                                                                                                'N',    --SFRSTCR_CAMP_OVER
                                                                                                                user,    --SFRSTCR_USER
                                                                                                                'N',    --SFRSTCR_DEGC_OVER
                                                                                                                'N',    --SFRSTCR_PROG_OVER
                                                                                                                null,    --SFRSTCR_LAST_ATTEND
                                                                                                                null,    --SFRSTCR_GCMT_CODE
                                                                                                                'SZFNVIN',    --SFRSTCR_DATA_ORIGIN
                                                                                                                sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                                                                'N',  --SFRSTCR_DEPT_OVER
                                                                                                                'N',  --SFRSTCR_ATTS_OVER
                                                                                                                'N', --SFRSTCR_CHRT_OVER
                                                                                                                null, --SFRSTCR_RMSG_CDE
                                                                                                                null,  --SFRSTCR_WL_PRIORITY
                                                                                                                null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                                                                null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                                                                null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                                                                'N', --SFRSTCR_MEXC_OVER
                                                                                                                sp,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                                                                null,--SFRSTCR_BRDH_SEQ_NUM
                                                                                                                '01',--SFRSTCR_BLCK_CODE
                                                                                                                null,--SFRSTCR_STRH_SEQNO
                                                                                                                null, --SFRSTCR_STRD_SEQNO
                                                                                                                null,  --SFRSTCR_SURROGATE_ID
                                                                                                                null, --SFRSTCR_VERSION
                                                                                                                user,--SFRSTCR_USER_ID
                                                                                                                no_recibo );--SFRSTCR_VPDI_CODE



                                                                            Begin
                                                                                 update ssbsect
                                                                                        set ssbsect_enrl = ssbsect_enrl + 1
                                                                                  where SSBSECT_TERM_CODE = peri
                                                                                  And SSBSECT_CRN  = crn;
                                                                            Exception
                                                                            When Others then
                                                                            vl_error := 'Se presento un error al actualizar el enrolamiento ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                                            End;

                                                                      --dbms_output.put_line('Actualiza sssbsecx '||c.iden || c.subj ||c.crse ||'*'||crn );

                                                                            Begin
                                                                                    update ssbsect
                                                                                        set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                                                    where SSBSECT_TERM_CODE = peri
                                                                                     And SSBSECT_CRN  = crn;
                                                                            Exception
                                                                            When Others then
                                                                                vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                                            End;

                                                                          --  dbms_output.put_line('Actualiza sssbsecx1 '||c.iden || c.subj ||c.crse ||'*'||crn );

                                                                            Begin
                                                                                     update ssbsect
                                                                                            set ssbsect_census_enrl=ssbsect_enrl
                                                                                     Where SSBSECT_TERM_CODE = peri
                                                                                     And SSBSECT_CRN  = crn;
                                                                            Exception
                                                                            When Others then
                                                                                vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||c.iden || c.subj ||c.crse||sqlerrm;
                                                                            End;

                                                                            --dbms_output.put_line('Actualiza sssbsecx1 '||c.iden || c.subj ||c.crse ||'*'||crn );
                                                                            conta_ptrm:=0;

                                                                            Begin
                                                                                Select count (*)
                                                                                    Into conta_ptrm
                                                                                from sfrareg
                                                                                where SFRAREG_PIDM = c.pidm
                                                                                And SFRAREG_TERM_CODE = peri
                                                                                And SFRAREG_CRN = crn
                                                                                And SFRAREG_EXTENSION_NUMBER = 0
                                                                                And SFRAREG_RSTS_CODE = 'RE';
                                                                            Exception
                                                                            When Others then
                                                                               conta_ptrm :=0;
                                                                            End;

                                                                            If conta_ptrm = 0 then

                                                                                 Begin
                                                                                         insert into sfrareg values(c.pidm, peri, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFNVIN', sysdate, null,null,null);
                                                                                 Exception
                                                                                   When Others then
                                                                                      vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                                                                 End;
                                                                            End if;

                                                                            --dbms_output.put_line('Actualiza final cabecera '||c.iden || c.subj ||c.crse ||'*'||crn );


                                                                     vl_existe :=0;

                                                                          Begin
                                                                             Select count(1)
                                                                             Into vl_existe
                                                                             from SHRINST
                                                                             Where  SHRINST_TERM_CODE = peri
                                                                             And SHRINST_CRN = crn
                                                                             And  SHRINST_PIDM = c.pidm;
                                                                          Exception
                                                                          When Others then
                                                                           vl_existe :=0;
                                                                          End;


                                                                          If vl_existe = 0 then
                                                                                Begin
                                                                                    Insert into SHRINST values (peri,        --SHRINST_TERM_CODE
                                                                                                                             crn,       --SHRINST_CRN
                                                                                                                             c.pidm,       --SHRINST_PIDM
                                                                                                                             sysdate,       --SHRINST_ACTIVITY_DATE
                                                                                                                             'Y',       --SHRINST_PRIMARY_IND
                                                                                                                              null,      --SHRINST_SURROGATE_ID
                                                                                                                              null,      --SHRINST_VERSION
                                                                                                                             user,       --SHRINST_USER_ID
                                                                                                                             'SZFNVIN',       --SHRINST_DATA_ORIGIN
                                                                                                                              null);      --SHRINST_VPDI_CODE


                                                                                Exception
                                                                                    When Others then
                                                                                     vl_error := 'Se presento un error al insertar al alumno en SHRINST ' ||sqlerrm;
                                                                                End;

                                                                          End if;

                                                                         Begin
                                                                            Update sgbstdn a
                                                                            set a.SGBSTDN_STYP_CODE ='N'
                                                                            Where a.SGBSTDN_PIDM = c.pidm
                                                                            And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                                                   from sgbstdn a1
                                                                                                                                   Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                                                  --- And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1
                                                                                                                                   )
                                                                            -- And a.SGBSTDN_PROGRAM_1 = c.prog
                                                                             ;
                                                                        Exception
                                                                            When Others then
                                                                            vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                                                        End;




                                                               --dbms_output.put_line('registra en Inscripcion dos '||c.iden || c.subj ||c.crse ||'*'||crn );
                                                           Exception
                                                           when Others then
                                                               vl_error := 'Se presento un error al insertar al alumno en el grupo ' ||c.iden || c.subj ||c.crse ||sqlerrm;
                                                           End;



                                                     End if;

                                        End if;  ------ No hay  CRN Creado

                                        if vl_error = 'EXITO' then

                                        --dbms_output.put_line('IDENTIFICA :'||vl_conversion  ||'Pperiodo= '|| c.pperiodo ||'Secuenciados= '||vl_vuelta_L0D);

                                                    vl_vueltas  := vl_vueltas + 1;
                                                    vl_secuencia_cont := c.secuencia;

                                           --dbms_output.put_line('vueltas :'||vl_vueltas  ||'Secuencia= '|| vl_secuencia_cont ||'Secuenciados= '||c.secuencia);
                                        Else
                                         --dbms_output.put_line('mensaje:'||vl_error);
                                           rollback;
                                        End if;
                                Else

                                      vl_vueltas := vl_vueltas +1;
                                       --dbms_output.put_line('SALIDA:'|| vl_vueltas);
                                End if; ----> El alumno ya tiene inscrita la materia


                                 --dbms_output.put_line('COMPARA :'||vl_vueltas ||'NUMERO'||periodos.SZTASGN_CRSE_NUMB);
                                exit when periodos.SZTASGN_CRSE_NUMB = vl_vueltas;
                         End loop c;
                         vl_vueltas :=0;
                   Else
                         null;
                   end if;

                End loop periodos;


           End if;

           Begin
                Select count (1)
                    Into vl_mat_ext
                     from sfrstcr
                where sfrstcr_pidm = c1.pidm
                and SFRSTCR_RSTS_CODE = 'RE';
           Exception
            When Others then
                vl_mat_ext :=0;
           End;

          --dbms_output.put_line('ACTUALIZA PIDM :'||c1.pidm ||'MATERIAS'||vl_mat_ext);

           If vl_mat_ext >=1 then


                 Begin
                        Update sgbstdn a
                        set a.SGBSTDN_STYP_CODE ='N'
                        Where a.SGBSTDN_PIDM = c1.pidm
                        And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                               from sgbstdn a1
                                                                               Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                               );
                 Exception
                        When Others then
                        vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                        --dbms_output.put_line('ERROR FINAL :'||vl_error);
                 End;


           ----------------------------------- Se realiza la actualizacion de la Jornada del alumno en base a las materias que le fueron cargadas.----------------------------------
                   vl_jornada :=null;

                    Begin
                            select distinct substr (SGRSATT_ATTS_CODE, 1,3) jornada
                                Into vl_jornada
                            from SGRSATT a
                            where a.SGRSATT_pidm = c1.pidm
                            and a.SGRSATT_STSP_KEY_SEQUENCE =c1.sp
                            and regexp_like(a.SGRSATT_ATTS_CODE, '^[0-9]')
                            and a.SGRSATT_TERM_CODE_EFF = (select max (a1.SGRSATT_TERM_CODE_EFF)
                                                                                    from SGRSATT a1
                                                                                    where a.SGRSATT_pidm = a1.SGRSATT_pidm
                                                                                    and a.SGRSATT_STSP_KEY_SEQUENCE = a1.SGRSATT_STSP_KEY_SEQUENCE);
                    Exception
                    when OThers then
                    vl_jornada :=null;
                    End ;

                    --dbms_output.put_line('Recupera Jornada :'||c1.pidm ||'MATERIAS'||vl_jornada);

                    If vl_jornada  is not null  then
                       vl_jornada := vl_jornada||vl_mat_ext;
                      -- dbms_output.put_line('convierte Jornada :'||c1.pidm ||'MATERIAS'||vl_jornada);
                      --   dbms_output.put_line('salida '||c.spriden_pidm||'*'|| c.SZCARGA_TERM_CODE ||'*'|| vl_jornada||'*'|| c.SORLCUR_KEY_SEQNO);
                       PKG_EXTRA.P_ACTUALIZA_JORNADA (c1.pidm, peri, vl_jornada, c1.sp);
                       Commit;
                    End if;

           End if;

           commit;

 End loop c1;
------------- fin macana ----------------




Elsif  campus = 'UVE' and nivel = 'LI' then

         --dbms_output.put_line('Entrada 4');

                    for c in (

                    select  sorlcur_pidm pidm, spriden_id iden, sorlcur_program prog, sorlcur_term_code_ctlg ctlg , scrtext_text materia , smrarul_subj_code subj, smrarul_crse_numb_low crse,  '01' grupo,
                    null calif, sztdtec_periodicidad perio,
                   null  prof,
                      null pperiodo,
                      a.SORLCUR_KEY_SEQNO sp
                    from sorlcur a
                    join spriden b on b.spriden_pidm = a.sorlcur_pidm and b.spriden_change_ind is null
                    join  sgbstdn d on  d.sgbstdn_pidm=spriden_pidm
                    And d.SGBSTDN_TERM_CODE_EFF = (select max (b1.SGBSTDN_TERM_CODE_EFF)
                                                                           from SGBSTDN b1
                                                                           Where d.sgbstdn_pidm = b1.sgbstdn_pidm)
                    join smrpaap on smrpaap_program=sorlcur_program
                            and smrpaap_term_code_eff=sorlcur_term_code_ctlg
                    join smrarul on smrarul_area=smrpaap_area
                            and smrarul_term_code_eff=smrpaap_term_code_eff
                            and (smrarul_crse_numb_low like '%101%' or
                                    smrarul_crse_numb_low like '%102%' or
                                    smrarul_crse_numb_low like '%103%' or
                                    smrarul_crse_numb_low like '%104%' or
                                    smrarul_crse_numb_low='001')
                    join scrtext on scrtext_subj_code=smrarul_subj_code
                            and scrtext_crse_numb=smrarul_crse_numb_low
                            and (substr(scrtext_text,1,4)=smrarul_subj_code or substr(scrtext_text,1,3)=smrarul_subj_code
                            or substr(scrtext_text,1,2)=smrarul_subj_code)
                            And substr(smrarul_area,9,2) in ('01','02')
                    join sztdtec on sztdtec_program=sorlcur_program
                            and sztdtec_term_code=sorlcur_term_code_ctlg
                    Where  a.SORLCUR_LMOD_CODE = 'LEARNER'
                    And a.SORLCUR_CACT_CODE = 'ACTIVE'
                    And a.SORLCUR_ROLL_IND = 'Y'
                    And a.sorlcur_pidm in (select sorlcur_pidm
                                                      from sorlcur aa
                                                      where a.sorlcur_program=aa.sorlcur_program
                                                      and a.sorlcur_lmod_code=aa.sorlcur_lmod_code
                                                      and a.sorlcur_roll_ind=aa.sorlcur_roll_ind)
                    and a.SORLCUR_SEQNO = (select max (SORLCUR_SEQNO)
                                                            from SORLCUR aa1
                                                            Where a.sorlcur_pidm = aa1.sorlcur_pidm
                                                            And a.SORLCUR_LMOD_CODE = aa1.SORLCUR_LMOD_CODE
                                                            And a.SORLCUR_CACT_CODE = aa1.SORLCUR_CACT_CODE
                                                            And a.SORLCUR_KEY_SEQNO = aa1.SORLCUR_KEY_SEQNO
                                                            And a.sorlcur_program=aa1.sorlcur_program
                                                            And trunc (a.sorlcur_start_date) = fecha_ini
                                                            )
                    And a.SORLCUR_CAMP_CODE= campus
                    And a.SORLCUR_LEVL_CODE= nivel
                    And d.SGBSTDN_STYP_CODE in ('N', 'F')
                    order by   perio,materia, grupo, prog,ctlg, iden
                    ) loop


--------------- Limpia Variables  --------------------
--niv :=  null;
parte := null;
crn := null;
pidm_doc2 := null;
conta_sirasgn := null;
pidm_doc := null;
f_inicio := null;
f_fin := null;
sem := null;
schd := null;
title := null;
credit := null;
credit_bill :=null;
levl := null;
camp := null;
mate := null;
parte := null;
per := null;
grupo := null;
vl_existe :=0;

vn_lugares :=0;
vn_cupo_max :=0;
vn_cupo_act :=0;
vl_error := 'EXITO';


           ----- Busca la Parte de Periodo para el programa que inicia clases
        If c.pperiodo is null then

             Begin
                    select distinct SZTPTRM_PTRM_CODE
                        Into Parte
                    from sztptrm, sobptrm
                    where SZTPTRM_CAMP_CODE = campus
                    And SZTPTRM_LEVL_CODE = nivel
                    and SZTPTRM_TERM_CODE = peri
                    and SOBPTRM_TERM_CODE = SZTPTRM_TERM_CODE
                    AND SOBPTRM_PTRM_CODE = SZTPTRM_PTRM_CODE
                    and SZTPTRM_PROGRAM = c.prog
                    and trunc (SOBPTRM_START_DATE) = fecha_ini;

                     If Parte in ('M0C' ) THEN
                       Parte := 'M1A';
                    Elsif  Parte in ('M0A' ) THEN
                       Parte := 'M0B';
                    Elsif  Parte in ('A0A' ) THEN
                       Parte := 'A0B';
                    Elsif  Parte in ('A0C' ) THEN
                       Parte := 'A1A';
                    End if;


               Exception
                When Others then
                  parte := null;
               End;
        Else
             Parte := c.pperiodo;
        End if;


--------------------- Se valida que el alumno no tenga la materia sembrada en el horario como Activa ---------------------------------------

           begin
                select count (1)
                    into vl_existe
                from ssbsect, sfrstcr, SHRGRDE
                where sfrstcr_pidm=c.pidm
                --and sfrstcr_term_code=c.periodo
                and ssbsect_term_code=sfrstcr_term_code
                and SFRSTCR_PTRM_CODE = SSBSECT_PTRM_CODE
                and ssbsect_crn=sfrstcr_crn
                and ssbsect_subj_code=c.subj
                and ssbsect_crse_numb=c.crse
                and SFRSTCR_RSTS_CODE = 'RE'
                AND (SFRSTCR_GRDE_CODE = SHRGRDE_CODE
                                         OR SFRSTCR_GRDE_CODE IS NULL)
                AND SHRGRDE_PASSED_IND = 'Y'
                AND SHRGRDE_LEVL_CODE= NIVEL;
            Exception
            when others then
                vl_existe:=0;
            end;


            Begin
                   select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                   into f_inicio, f_fin, sem
                   from sobptrm
                   where sobptrm_term_code=Peri
                   and     sobptrm_ptrm_code=parte;
            Exception
               When Others then
                f_inicio:= null;
                f_fin := null;
                sem :=null;
            End;




        If vl_existe = 0 then

            ---- Se busca que exista el grupo y tenga cupo

                 If  c.prof is null then
                    --dbms_output.put_line ('sin profesor '||vl_existe);
                    --dbms_output.put_line ('crea consulta '||peri ||'*'|| c.subj  ||'*'||c.crse||'*'||c.grupo||'*'||fecha_ini);
                        begin

                                select ssbsect_crn , ssbsect_seats_avail lugares, ssbsect_max_enrl cupo_max, SSBSECT_PTRM_CODE,
                                        ssbsect_enrl cupo_Act,    SSBSECT_PTRM_START_DATE, SSBSECT_PTRM_END_DATE, SSBSECT_PTRM_WEEKS,
                                        SSBSECT_CREDIT_HRS, SSBSECT_BILL_HRS, SSBSECT_GMOD_CODE
                                into crn , vn_lugares, vn_cupo_max, parte,
                                       vn_cupo_act, f_inicio, f_fin, sem,
                                       credit, credit_bill, gmod
                                from ssbsect a
                                where a.SSBSECT_TERM_CODE= peri
                                and a.ssbsect_subj_code= c.subj
                               and a.ssbsect_crse_numb=c.crse
                               and a.SSBSECT_SEATS_AVAIL >0
                               AND a.SSBSECT_SEATS_AVAIL = (select max (a1.SSBSECT_SEATS_AVAIL)
                                                                               from ssbsect a1
                                                                                where a.SSBSECT_TERM_CODE = a1.SSBSECT_TERM_CODE
                                                                                and a.ssbsect_subj_code = a1.ssbsect_subj_code
                                                                                and a.ssbsect_crse_numb = a1.ssbsect_crse_numb
                                                                               and trunc (a.SSBSECT_PTRM_START_DATE) = trunc (a1.SSBSECT_PTRM_START_DATE))
                                and trunc (a.SSBSECT_PTRM_START_DATE) = f_inicio;

                        Exception
                        when others then
                            crn:=null;
                            vn_lugares :=0;
                            vn_cupo_max:=0;
                            vn_cupo_act:=0;
                            f_inicio := null;
                            f_fin := null;
                            sem := null;
                            credit  := null;
                            credit_bill  := null;
                            gmod  := null;
                             -- dbms_output.put_line ('error de crea consulta '||sqlerrm);
                        end;
                Else
                            --dbms_output.put_line ('con profesor '||vl_existe);

                       begin
                               select ssbsect_crn , ssbsect_seats_avail lugares, ssbsect_max_enrl cupo_max, SSBSECT_PTRM_CODE,
                                        ssbsect_enrl cupo_Act,    SSBSECT_PTRM_START_DATE, SSBSECT_PTRM_END_DATE, SSBSECT_PTRM_WEEKS,
                                        SSBSECT_CREDIT_HRS, SSBSECT_BILL_HRS, SSBSECT_GMOD_CODE
                                into crn , vn_lugares, vn_cupo_max, parte,
                                       vn_cupo_act, f_inicio, f_fin, sem,
                                       credit, credit_bill, gmod
                                from ssbsect a, sirasgn
                                where a.SSBSECT_TERM_CODE= peri
                                and a.ssbsect_subj_code= c.subj
                               and a.ssbsect_crse_numb=c.crse
                               and a.SSBSECT_SEQ_NUMB = c.grupo
                               and a.SSBSECT_SEATS_AVAIL >0
                               AND to_number (a.ssbsect_crn) = (select max (to_number (a1.ssbsect_crn))
                                                                                from ssbsect a1
                                                                                where a.SSBSECT_TERM_CODE = a1.SSBSECT_TERM_CODE
                                                                                and a.ssbsect_subj_code = a1.ssbsect_subj_code
                                                                                and a.ssbsect_crse_numb = a1.ssbsect_crse_numb
                                                                                and a.SSBSECT_SEQ_NUMB = a1.SSBSECT_SEQ_NUMB
                                                                                and a.SSBSECT_PTRM_START_DATE = a1.SSBSECT_PTRM_START_DATE
                                                                                )
                                and trunc (a.SSBSECT_PTRM_START_DATE) = f_inicio
                               And SIRASGN_PIDM = (select distinct  spriden_pidm
                                                                    from spriden
                                                                    where spriden_id = c.prof
                                                                    And spriden_change_ind is null )
                                And SIRASGN_PRIMARY_IND = 'Y' ;
                                -- dbms_output.put_line ('crea consulta '||peri ||'*'|| c.subj  ||'*'||c.crse||'*'||c.grupo||'*'||fecha_ini);

                       Exception
                        when others then
                            crn:=null;
                            vn_lugares :=0;
                            vn_cupo_max:=0;
                            vn_cupo_act:=0;
                            f_inicio := null;
                            f_fin := null;
                            sem := null;
                            credit  := null;
                            credit_bill  := null;
                            gmod  := null;
                           -- dbms_output.put_line ('error de crea consulta '||sqlerrm);
                       end;

                End if;



                If crn is not null then

                    If vn_lugares >0  then

                            If credit is null then
                               Begin
                                      select SSRMEET_CREDIT_HR_SESS
                                       Into credit
                                      from SSRMEET
                                      where SSRMEET_TERM_CODE = peri
                                      And SSRMEET_CRN = crn;
                               Exception
                                When Others then
                                   credit :=null;
                                End;

                                  If credit is not null then
                                           Begin
                                               Update ssbsect
                                               set  SSBSECT_CREDIT_HRS = credit
                                               where SSBSECT_TERM_CODE = peri
                                               and SSBSECT_CRN = crn;
                                           Exception
                                           when Others then
                                                null;
                                           End;
                                  End if;
                           End if;

                           If credit_bill is null then
                                Begin
                                         select  SCBCRSE_BILL_HR_LOW
                                            into credit_bill
                                            from scbcrse, scrschd
                                            where scbcrse_subj_code=  c.subj
                                            and     scbcrse_crse_numb=c.crse
                                            and     scbcrse_eff_term='000000'
                                            and     scrschd_subj_code=scbcrse_subj_code
                                            and     scrschd_crse_numb=scbcrse_crse_numb
                                            and     scrschd_eff_term=scbcrse_eff_term;
                                 Exception
                                 When Others then
                                    credit_bill := 3;
                                 End;

                                  If credit is not null then
                                           Begin
                                               Update ssbsect
                                               set  SSBSECT_BILL_HRS = credit_bill
                                               where SSBSECT_TERM_CODE = peri
                                               and SSBSECT_CRN = crn;
                                           Exception
                                           when Others then
                                                null;
                                           End;
                                  End if;
                           End if;

                          If gmod is null then
                                begin
                                    select scrgmod_gmod_code
                                    into gmod
                                    from scrgmod
                                    where scrgmod_subj_code=c.subj
                                    and     scrgmod_crse_numb=c.crse
                                    and     scrgmod_default_ind='D';
                                exception when others then
                                    gmod:='1';
                                end;

                                If gmod is not null then
                                           Begin
                                               Update ssbsect
                                               set  SSBSECT_GMOD_CODE = gmod
                                               where SSBSECT_TERM_CODE = peri
                                               and SSBSECT_CRN = crn;
                                           Exception
                                           when Others then
                                                null;
                                           End;
                                end if;

                          End if;


                        conta_ptrm :=0;

                            Begin
                                 select count(*)
                                    into conta_ptrm
                                 from sfbetrm
                                 where sfbetrm_term_code=peri
                                 and     sfbetrm_pidm=c.pidm;
                            Exception
                                When Others then
                                  conta_ptrm := 0;
                            End;


                             if conta_ptrm =0 then
                                    Begin
                                            insert into sfbetrm values(peri, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFNVIN', null, 0,null,null, null,null,user,null);
                                    Exception
                                    When Others then
                                        vl_error := ('Se presento un error al insertar en la tabla sfbetrm ' || sqlerrm);
                                    End;
                             end if;



                            Begin
                                select sgbstdn_levl_code, sgbstdn_camp_code  into levl, camp
                                from sgbstdn a
                                where sgbstdn_pidm=c.pidm
                                and     sgbstdn_term_code_eff  in (select max(sgbstdn_term_code_eff) from sgbstdn aa
                                                                                   where a.sgbstdn_pidm=aa.sgbstdn_pidm);
                            Exception
                            When Others then
                               levl := null;
                               camp := null;
                               vl_error := 'Se presento un error al obtener la informacion de SGBSTDN ' || sqlerrm;
                            End;

                           Begin
                                    select distinct max(sorlcur_key_seqno)
                                        into sp
                                    from sorlcur
                                    where sorlcur_pidm=c.pidm
                                    and     sorlcur_program=c.prog
                                    and     sorlcur_lmod_code='LEARNER';
                           Exception
                           when Others then
                              sp := null;
                              vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||sqlerrm;
                           End;
                              --  calculamos la materi pade
                               begin
                               select GET_MATERIA_PADRE(c.materia)
                               into vmateria_padre
                                from dual;
                               exception when others  then
                                   vmateria_padre := '';

                               end;
                           Begin

                               insert into sfrstcr values(
                                                                peri,     --SFRSTCR_TERM_CODE
                                                                c.pidm,     --SFRSTCR_PIDM
                                                                crn,     --SFRSTCR_CRN
                                                                1,     --SFRSTCR_CLASS_SORT_KEY
                                                                1,    --SFRSTCR_REG_SEQ
                                                                parte,    --SFRSTCR_PTRM_CODE
                                                                'RE',     --SFRSTCR_RSTS_CODE
                                                                sysdate,    --SFRSTCR_RSTS_DATE
                                                                null,    --SFRSTCR_ERROR_FLAG
                                                                null,    --SFRSTCR_MESSAGE
                                                                credit_bill,    --SFRSTCR_BILL_HR
                                                                3, --SFRSTCR_WAIV_HR
                                                                credit,     --SFRSTCR_CREDIT_HR
                                                                credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                gmod,     --SFRSTCR_GMOD_CODE
                                                                null,    --SFRSTCR_GRDE_CODE
                                                                null,    --SFRSTCR_GRDE_CODE_MID
                                                                null,    --SFRSTCR_GRDE_DATE
                                                                'N',    --SFRSTCR_DUPL_OVER
                                                                'N',    --SFRSTCR_LINK_OVER
                                                                'N',    --SFRSTCR_CORQ_OVER
                                                                'N',    --SFRSTCR_PREQ_OVER
                                                                'N',     --SFRSTCR_TIME_OVER
                                                                'N',     --SFRSTCR_CAPC_OVER
                                                                'N',     --SFRSTCR_LEVL_OVER
                                                                'N',     --SFRSTCR_COLL_OVER
                                                                'N',     --SFRSTCR_MAJR_OVER
                                                                'N',     --SFRSTCR_CLAS_OVER
                                                                'N',     --SFRSTCR_APPR_OVER
                                                                'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                sysdate,      --SFRSTCR_ADD_DATE
                                                                sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                levl,     --SFRSTCR_LEVL_CODE
                                                                camp,     --SFRSTCR_CAMP_CODE
                                                                vmateria_padre,     --SFRSTCR_RESERVED_KEY
                                                                null,     --SFRSTCR_ATTEND_HR
                                                                'Y',     --SFRSTCR_REPT_OVER
                                                                'N' ,    --SFRSTCR_RPTH_OVER
                                                                null,    --SFRSTCR_TEST_OVER
                                                                'N',    --SFRSTCR_CAMP_OVER
                                                                user,    --SFRSTCR_USER
                                                                'N',    --SFRSTCR_DEGC_OVER
                                                                'N',    --SFRSTCR_PROG_OVER
                                                                null,    --SFRSTCR_LAST_ATTEND
                                                                null,    --SFRSTCR_GCMT_CODE
                                                                'SZFNVIN',    --SFRSTCR_DATA_ORIGIN
                                                                sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                'N',  --SFRSTCR_DEPT_OVER
                                                                'N',  --SFRSTCR_ATTS_OVER
                                                                'N', --SFRSTCR_CHRT_OVER
                                                                null, --SFRSTCR_RMSG_CDE
                                                                null,  --SFRSTCR_WL_PRIORITY
                                                                null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                'N', --SFRSTCR_MEXC_OVER
                                                                sp,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                null,--SFRSTCR_BRDH_SEQ_NUM
                                                                '01',--SFRSTCR_BLCK_CODE
                                                                null,--SFRSTCR_STRH_SEQNO
                                                                null, --SFRSTCR_STRD_SEQNO
                                                                null,  --SFRSTCR_SURROGATE_ID
                                                                null, --SFRSTCR_VERSION
                                                                user,--SFRSTCR_USER_ID
                                                                no_recibo );--SFRSTCR_VPDI_CODE



                                        Begin
                                             update ssbsect
                                                    set ssbsect_enrl = ssbsect_enrl + 1
                                              where SSBSECT_TERM_CODE = peri
                                              And SSBSECT_CRN  = crn;
                                        Exception
                                        When Others then
                                        vl_error := 'Se presento un error al actualizar el enrolamiento ' ||sqlerrm;
                                        End;

                                        Begin
                                                update ssbsect
                                                    set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                where SSBSECT_TERM_CODE = peri
                                                 And SSBSECT_CRN  = crn;
                                        Exception
                                        When Others then
                                            vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||sqlerrm;
                                        End;

                                        Begin
                                                 update ssbsect
                                                        set ssbsect_census_enrl=ssbsect_enrl
                                                 Where SSBSECT_TERM_CODE = peri
                                                 And SSBSECT_CRN  = crn;
                                        Exception
                                        When Others then
                                            vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||sqlerrm;
                                        End;


                                        conta_ptrm:=0;

                                        Begin
                                            Select count (*)
                                                Into conta_ptrm
                                            from sfrareg
                                            where SFRAREG_PIDM = c.pidm
                                            And SFRAREG_TERM_CODE = peri
                                            And SFRAREG_CRN = crn
                                            And SFRAREG_EXTENSION_NUMBER = 0
                                            And SFRAREG_RSTS_CODE = 'RE';
                                        Exception
                                        When Others then
                                           conta_ptrm :=0;
                                        End;

                                        If conta_ptrm = 0 then

                                             Begin
                                                     insert into sfrareg values(c.pidm, peri, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFNVIN', sysdate, null,null,null);
                                             Exception
                                               When Others then
                                                  vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||sqlerrm;
                                             End;
                                        End if;

                                     vl_existe :=0;

                                          Begin
                                             Select count(1)
                                             Into vl_existe
                                             from SHRINST
                                             Where  SHRINST_TERM_CODE = peri
                                             And SHRINST_CRN = crn
                                             And  SHRINST_PIDM = c.pidm;
                                          Exception
                                          When Others then
                                           vl_existe :=0;
                                          End;


                                          If vl_existe = 0 then
                                                Begin
                                                    Insert into SHRINST values (peri,        --SHRINST_TERM_CODE
                                                                                             crn,       --SHRINST_CRN
                                                                                             c.pidm,       --SHRINST_PIDM
                                                                                             sysdate,       --SHRINST_ACTIVITY_DATE
                                                                                             'Y',       --SHRINST_PRIMARY_IND
                                                                                              null,      --SHRINST_SURROGATE_ID
                                                                                              null,      --SHRINST_VERSION
                                                                                             user,       --SHRINST_USER_ID
                                                                                             'SZFNVIN',       --SHRINST_DATA_ORIGIN
                                                                                              null);      --SHRINST_VPDI_CODE


                                                Exception
                                                    When Others then
                                                     vl_error := 'Se presento un error al insertar al alumno en SHRINST ' ||sqlerrm;
                                                End;

                                          End if;

                                                              Begin
                                                                    Update sgbstdn a
                                                                    set a.SGBSTDN_STYP_CODE ='N'
                                                                    Where a.SGBSTDN_PIDM = c.pidm
                                                                    And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                                           from sgbstdn a1
                                                                                                                           Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                                          --- And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1
                                                                                                                           )
                                                                    -- And a.SGBSTDN_PROGRAM_1 = c.prog
                                                                     ;
                                                                Exception
                                                                    When Others then
                                                                    vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                                                End;




                            Exception
                           when Others then
                               vl_error := 'Se presento un error al insertar al alumno en el grupo ' ||sqlerrm;
                           End;

                     Else  ----------> Se realizara la creacion del grupo

                            schd := null;
                            title := null;
                            credit := null;
                            gmod :=null;
                            credit_bill :=null;

                            Begin
                                select scrschd_schd_code, scbcrse_title, scbcrse_credit_hr_low, SCBCRSE_BILL_HR_LOW
                                into schd, title, credit, credit_bill
                                from scbcrse, scrschd
                                where scbcrse_subj_code=c.subj
                                and     scbcrse_crse_numb=c.crse
                                and     scbcrse_eff_term='000000'
                                and     scrschd_subj_code=scbcrse_subj_code
                                and     scrschd_crse_numb=scbcrse_crse_numb
                                and     scrschd_eff_term=scbcrse_eff_term;
                            Exception
                            When Others then
                                  schd := null;
                                  title := null;
                                  credit := null;
                            End;


                            begin
                                select scrgmod_gmod_code
                                      into gmod
                                from scrgmod
                                where scrgmod_subj_code=c.subj
                                and     scrgmod_crse_numb=c.crse
                                and     scrgmod_default_ind='D';
                            exception when others then
                                gmod:='1';
                            end;

                             Begin
                                 select nvl(max(crn),1000)+1
                                into crn
                                from
                                (
                                    select case when
                                                        substr(SSBSECT_CRN,1,1) IN('L','B') then to_number(substr(SSBSECT_CRN,2,100))+1
                                              else
                                                    to_number(SSBSECT_CRN)
                                              end crn
                                    from ssbsect
                                    where ssbsect_term_code= peri
                                );

                             EXCEPTION WHEN OTHERS THEN
                                crn := NULL;
                             END;


                             if nivel ='LI' then
                                crn:='L'||crn;
                             Elsif nivel ='BA' then
                                crn:='B'||crn;
                             end if;

                             If crn is not null then

                                   Begin
                                       select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                                       into f_inicio, f_fin, sem
                                       from sobptrm
                                       where sobptrm_term_code=Peri
                                       and     sobptrm_ptrm_code=parte;
                                   Exception
                                   When Others then
                                    f_inicio:= null;
                                    f_fin := null;
                                    sem :=null;
                                   End;


                                  Begin
                                        Insert into ssbsect values (
                                                                           Peri,     --SSBSECT_TERM_CODE
                                                                           crn,     --SSBSECT_CRN
                                                                           parte,     --SSBSECT_PTRM_CODE
                                                                           c.subj,     --SSBSECT_SUBJ_CODE
                                                                           c.crse,     --SSBSECT_CRSE_NUMB
                                                                            '01',     --SSBSECT_SEQ_NUMB
                                                                            'A',    --SSBSECT_SSTS_CODE
                                                                            schd,    --SSBSECT_SCHD_CODE
                                                                            campus,    --SSBSECT_CAMP_CODE
                                                                             title,   --SSBSECT_CRSE_TITLE
                                                                             credit,   --SSBSECT_CREDIT_HRS
                                                                             credit_bill,   --SSBSECT_BILL_HRS
                                                                             gmod,   --SSBSECT_GMOD_CODE
                                                                              null,  --SSBSECT_SAPR_CODE
                                                                              null, --SSBSECT_SESS_CODE
                                                                              null,  --SSBSECT_LINK_IDENT
                                                                              null,  --SSBSECT_PRNT_IND
                                                                              'Y',  --SSBSECT_GRADABLE_IND
                                                                               null,  --SSBSECT_TUIW_IND
                                                                               0, --SSBSECT_REG_ONEUP
                                                                               0, --SSBSECT_PRIOR_ENRL
                                                                               0, --SSBSECT_PROJ_ENRL
                                                                               50, --SSBSECT_MAX_ENRL
                                                                                0,--SSBSECT_ENRL
                                                                                50,--SSBSECT_SEATS_AVAIL
                                                                                null,--SSBSECT_TOT_CREDIT_HRS
                                                                                '0',--SSBSECT_CENSUS_ENRL
                                                                                f_inicio,--SSBSECT_CENSUS_ENRL_DATE
                                                                                sysdate,--SSBSECT_ACTIVITY_DATE
                                                                                f_inicio,--SSBSECT_PTRM_START_DATE
                                                                                f_fin,--SSBSECT_PTRM_END_DATE
                                                                                sem,--SSBSECT_PTRM_WEEKS
                                                                                null,--SSBSECT_RESERVED_IND
                                                                                null, --SSBSECT_WAIT_CAPACITY
                                                                                null,--SSBSECT_WAIT_COUNT
                                                                                null,--SSBSECT_WAIT_AVAIL
                                                                                null,--SSBSECT_LEC_HR
                                                                                null,--SSBSECT_LAB_HR
                                                                                null,--SSBSECT_OTH_HR
                                                                                null,--SSBSECT_CONT_HR
                                                                                null,--SSBSECT_ACCT_CODE
                                                                                null,--SSBSECT_ACCL_CODE
                                                                                null,--SSBSECT_CENSUS_2_DATE
                                                                                null,--SSBSECT_ENRL_CUT_OFF_DATE
                                                                                null,--SSBSECT_ACAD_CUT_OFF_DATE
                                                                                null,--SSBSECT_DROP_CUT_OFF_DATE
                                                                                null,--SSBSECT_CENSUS_2_ENRL
                                                                                'Y',--SSBSECT_VOICE_AVAIL
                                                                                'N',--SSBSECT_CAPP_PREREQ_TEST_IND
                                                                                null,--SSBSECT_GSCH_NAME
                                                                                null,--SSBSECT_BEST_OF_COMP
                                                                                null,--SSBSECT_SUBSET_OF_COMP
                                                                                'NOP',--SSBSECT_INSM_CODE
                                                                                null,--SSBSECT_REG_FROM_DATE
                                                                                null,--SSBSECT_REG_TO_DATE
                                                                                null,--SSBSECT_LEARNER_REGSTART_FDATE
                                                                                null,--SSBSECT_LEARNER_REGSTART_TDATE
                                                                                null,--SSBSECT_DUNT_CODE
                                                                                null,--SSBSECT_NUMBER_OF_UNITS
                                                                                0,--SSBSECT_NUMBER_OF_EXTENSIONS
                                                                                'SZFNVIN',--SSBSECT_DATA_ORIGIN
                                                                                user,--SSBSECT_USER_ID
                                                                                'MOOD',--SSBSECT_INTG_CDE
                                                                                'B',--SSBSECT_PREREQ_CHK_METHOD_CDE
                                                                                user,--SSBSECT_KEYWORD_INDEX_ID
                                                                                null,--SSBSECT_SCORE_OPEN_DATE
                                                                                null,--SSBSECT_SCORE_CUTOFF_DATE
                                                                                null,--SSBSECT_REAS_SCORE_OPEN_DATE
                                                                                null,--SSBSECT_REAS_SCORE_CTOF_DATE
                                                                                null,--SSBSECT_SURROGATE_ID
                                                                                null,--SSBSECT_VERSION
                                                                                 null);--SSBSECT_VPDI_CODE

                                                   Begin
                                                        insert into ssrmeet values(peri, crn, null,null,null,null,null,null, sysdate, f_inicio, f_fin, '01', null,null,null,null,null,null,null, 'ENL', null, credit, null, 0, null,null,null, 'CLVI', 'SZFNVIN', user, null,null,null);
                                                    Exception
                                                    when Others then
                                                       vl_error := 'Se presento un Error al insertar en ssrmeet ' ||sqlerrm;
                                                   End;

                                                 pidm_prof := null;

--                                                   If  c.prof is null then
--                                                       c.prof :=  '019814933';
--                                                   End if;

                                                    begin
                                                    select spriden_pidm into pidm_prof
                                                    from  spriden
                                                    where   spriden_id=c.prof and spriden_change_ind is null;
                                                    exception when others then
                                                    pidm_prof:=null;
                                                    end;

                                                    if pidm_prof is not null then
                                                        Begin
                                                                insert into sirasgn values(ciclo, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,  sysdate, null,null,null,null, 'SZFNVIN', user, null, null, null, null,  null,null);
                                                        Exception
                                                        When Others then
                                                        null;
                                                        End;
                                                    end if;


                                                conta_ptrm :=0;

                                                    Begin
                                                         select count(*)
                                                            into conta_ptrm
                                                         from sfbetrm
                                                         where sfbetrm_term_code=peri
                                                         and     sfbetrm_pidm=c.pidm;
                                                    Exception
                                                        When Others then
                                                          conta_ptrm := 0;
                                                    End;


                                                     if conta_ptrm =0 then
                                                            Begin
                                                                    insert into sfbetrm values(peri, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFNVIN', null, 0,null,null, null,null,user,null);
                                                            Exception
                                                            When Others then
                                                                vl_error := ('Se presento un error al insertar en la tabla sfbetrm ' || sqlerrm);
                                                            End;
                                                     end if;



                                                    Begin
                                                        select sgbstdn_levl_code, sgbstdn_camp_code  into levl, camp
                                                        from sgbstdn a
                                                        where sgbstdn_pidm=c.pidm
                                                        and     sgbstdn_term_code_eff  in (select max(sgbstdn_term_code_eff) from sgbstdn aa
                                                                                                           where a.sgbstdn_pidm=aa.sgbstdn_pidm);
                                                    Exception
                                                    When Others then
                                                       levl := null;
                                                       camp := null;
                                                       vl_error := 'Se presento un error al obtener la informacion de SGBSTDN ' || sqlerrm;
                                                    End;

                                                   Begin
                                                            select distinct max(sorlcur_key_seqno)
                                                                into sp
                                                            from sorlcur
                                                            where sorlcur_pidm=c.pidm
                                                            and     sorlcur_program=c.prog
                                                            and     sorlcur_lmod_code='LEARNER';
                                                   Exception
                                                   when Others then
                                                      sp := null;
                                                      vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||sqlerrm;
                                                   End;
                                                --  calculamos la materi pade
                                                   begin
                                                   select GET_MATERIA_PADRE(c.materia)
                                                   into vmateria_padre
                                                    from dual;
                                                   exception when others  then
                                                       vmateria_padre := '';

                                                   end;

                                                   Begin

                                                       insert into sfrstcr values(
                                                                                        peri,     --SFRSTCR_TERM_CODE
                                                                                        c.pidm,     --SFRSTCR_PIDM
                                                                                        crn,     --SFRSTCR_CRN
                                                                                        1,     --SFRSTCR_CLASS_SORT_KEY
                                                                                        1,    --SFRSTCR_REG_SEQ
                                                                                        parte,    --SFRSTCR_PTRM_CODE
                                                                                        'RE',     --SFRSTCR_RSTS_CODE
                                                                                        sysdate,    --SFRSTCR_RSTS_DATE
                                                                                        null,    --SFRSTCR_ERROR_FLAG
                                                                                        null,    --SFRSTCR_MESSAGE
                                                                                        credit_bill,    --SFRSTCR_BILL_HR
                                                                                        3, --SFRSTCR_WAIV_HR
                                                                                        credit,     --SFRSTCR_CREDIT_HR
                                                                                        credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                                        credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                                        gmod,     --SFRSTCR_GMOD_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE_MID
                                                                                        null,    --SFRSTCR_GRDE_DATE
                                                                                        'N',    --SFRSTCR_DUPL_OVER
                                                                                        'N',    --SFRSTCR_LINK_OVER
                                                                                        'N',    --SFRSTCR_CORQ_OVER
                                                                                        'N',    --SFRSTCR_PREQ_OVER
                                                                                        'N',     --SFRSTCR_TIME_OVER
                                                                                        'N',     --SFRSTCR_CAPC_OVER
                                                                                        'N',     --SFRSTCR_LEVL_OVER
                                                                                        'N',     --SFRSTCR_COLL_OVER
                                                                                        'N',     --SFRSTCR_MAJR_OVER
                                                                                        'N',     --SFRSTCR_CLAS_OVER
                                                                                        'N',     --SFRSTCR_APPR_OVER
                                                                                        'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                                        sysdate,      --SFRSTCR_ADD_DATE
                                                                                        sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                                        levl,     --SFRSTCR_LEVL_CODE
                                                                                        camp,     --SFRSTCR_CAMP_CODE
                                                                                        vmateria_padre,     --SFRSTCR_RESERVED_KEY
                                                                                        null,     --SFRSTCR_ATTEND_HR
                                                                                        'Y',     --SFRSTCR_REPT_OVER
                                                                                        'N' ,    --SFRSTCR_RPTH_OVER
                                                                                        null,    --SFRSTCR_TEST_OVER
                                                                                        'N',    --SFRSTCR_CAMP_OVER
                                                                                        user,    --SFRSTCR_USER
                                                                                        'N',    --SFRSTCR_DEGC_OVER
                                                                                        'N',    --SFRSTCR_PROG_OVER
                                                                                        null,    --SFRSTCR_LAST_ATTEND
                                                                                        null,    --SFRSTCR_GCMT_CODE
                                                                                        'SZFNVIN',    --SFRSTCR_DATA_ORIGIN
                                                                                        sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                                        'N',  --SFRSTCR_DEPT_OVER
                                                                                        'N',  --SFRSTCR_ATTS_OVER
                                                                                        'N', --SFRSTCR_CHRT_OVER
                                                                                        null, --SFRSTCR_RMSG_CDE
                                                                                        null,  --SFRSTCR_WL_PRIORITY
                                                                                        null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                                        null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                                        null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                                        'N', --SFRSTCR_MEXC_OVER
                                                                                        sp,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                                        null,--SFRSTCR_BRDH_SEQ_NUM
                                                                                        '01',--SFRSTCR_BLCK_CODE
                                                                                        null,--SFRSTCR_STRH_SEQNO
                                                                                        null, --SFRSTCR_STRD_SEQNO
                                                                                        null,  --SFRSTCR_SURROGATE_ID
                                                                                        null, --SFRSTCR_VERSION
                                                                                        user,--SFRSTCR_USER_ID
                                                                                        no_recibo );--SFRSTCR_VPDI_CODE



                                                                Begin
                                                                     update ssbsect
                                                                            set ssbsect_enrl = ssbsect_enrl + 1
                                                                      where SSBSECT_TERM_CODE = peri
                                                                      And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                vl_error := 'Se presento un error al actualizar el enrolamiento ' ||sqlerrm;
                                                                End;

                                                                Begin
                                                                        update ssbsect
                                                                            set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                                        where SSBSECT_TERM_CODE = peri
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||sqlerrm;
                                                                End;

                                                                Begin
                                                                         update ssbsect
                                                                                set ssbsect_census_enrl=ssbsect_enrl
                                                                         Where SSBSECT_TERM_CODE = peri
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||sqlerrm;
                                                                End;


                                                                conta_ptrm:=0;

                                                                Begin
                                                                    Select count (*)
                                                                        Into conta_ptrm
                                                                    from sfrareg
                                                                    where SFRAREG_PIDM = c.pidm
                                                                    And SFRAREG_TERM_CODE = peri
                                                                    And SFRAREG_CRN = crn
                                                                    And SFRAREG_EXTENSION_NUMBER = 0
                                                                    And SFRAREG_RSTS_CODE = 'RE';
                                                                Exception
                                                                When Others then
                                                                   conta_ptrm :=0;
                                                                End;

                                                                If conta_ptrm = 0 then

                                                                     Begin

                                                                             insert into sfrareg values(c.pidm, peri, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFNVIN', sysdate, null,null,null);
                                                                     Exception
                                                                       When Others then
                                                                          vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||sqlerrm;
                                                                     End;
                                                                End if;

                                                             vl_existe :=0;

                                                              Begin
                                                                 Select count(1)
                                                                 Into vl_existe
                                                                 from SHRINST
                                                                 Where  SHRINST_TERM_CODE = peri
                                                                 And SHRINST_CRN = crn
                                                                 And  SHRINST_PIDM = c.pidm;
                                                              Exception
                                                              When Others then
                                                               vl_existe :=0;
                                                              End;


                                                              If vl_existe = 0 then
                                                                    Begin
                                                                        Insert into SHRINST values (peri,        --SHRINST_TERM_CODE
                                                                                                                 crn,       --SHRINST_CRN
                                                                                                                 c.pidm,       --SHRINST_PIDM
                                                                                                                 sysdate,       --SHRINST_ACTIVITY_DATE
                                                                                                                 'Y',       --SHRINST_PRIMARY_IND
                                                                                                                  null,      --SHRINST_SURROGATE_ID
                                                                                                                  null,      --SHRINST_VERSION
                                                                                                                 user,       --SHRINST_USER_ID
                                                                                                                 'SZFNVIN',       --SHRINST_DATA_ORIGIN
                                                                                                                  null);      --SHRINST_VPDI_CODE


                                                                    Exception
                                                                        When Others then
                                                                         vl_error := 'Se presento un error al insertar al alumno en SHRINST ' ||sqlerrm;
                                                                    End;

                                                              End if;



                                                              Begin
                                                                    Update sgbstdn a
                                                                    set a.SGBSTDN_STYP_CODE ='N'
                                                                    Where a.SGBSTDN_PIDM = c.pidm
                                                                    And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                                           from sgbstdn a1
                                                                                                                           Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                                          --- And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1
                                                                                                                           )
                                                                    -- And a.SGBSTDN_PROGRAM_1 = c.prog
                                                                     ;
                                                                Exception
                                                                    When Others then
                                                                    vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                                                End;



                                                    Exception
                                                   when Others then
                                                       vl_error := 'Se presento un error al insertar al alumno en el grupo ' ||sqlerrm;
                                                   End;


                                  Exception
                                    When Others then
                                      vl_error := 'Se presento un Error al insertar el nuevo grupo 3 ' ||sqlerrm;
                                  End;
                             End if;

                     --dbms_output.put_line('mensaje:'|| 'No hay grupo cupo');
                     End if;
                Else
                    --dbms_output.put_line('mensaje:'|| 'No hay grupo creado');
                            schd := null;
                            title := null;
                            credit := null;
                            gmod :=null;
                            credit_bill :=null;

                            Begin
                                select scrschd_schd_code, scbcrse_title, scbcrse_credit_hr_low, SCBCRSE_BILL_HR_LOW
                                into schd, title, credit, credit_bill
                                from scbcrse, scrschd
                                where scbcrse_subj_code=c.subj
                                and     scbcrse_crse_numb=c.crse
                                and     scbcrse_eff_term='000000'
                                and     scrschd_subj_code=scbcrse_subj_code
                                and     scrschd_crse_numb=scbcrse_crse_numb
                                and     scrschd_eff_term=scbcrse_eff_term;
                            Exception
                            When Others then
                                  schd := null;
                                  title := null;
                                  credit := null;
                                  credit_bill :=null;
                            End;


                            begin
                                select scrgmod_gmod_code
                                      into gmod
                                from scrgmod
                                where scrgmod_subj_code=c.subj
                                and     scrgmod_crse_numb=c.crse
                                and     scrgmod_default_ind='D';
                            exception when others then
                                gmod:='1';
                            end;

                             Begin
                                 select nvl(max(crn),1000)+1
                                into crn
                                from
                                (
                                    select case when
                                                        substr(SSBSECT_CRN,1,1) IN('L','B') then to_number(substr(SSBSECT_CRN,2,100))+1
                                              else
                                                    to_number(SSBSECT_CRN)
                                              end crn
                                    from ssbsect
                                    where ssbsect_term_code= peri
                                );

                             EXCEPTION WHEN OTHERS THEN
                                crn := NULL;
                             END;


                             if nivel ='LI' then
                                crn:='L'||crn;
                             Elsif nivel ='BA' then
                                crn:='B'||crn;
                             end if;

                        If crn is not null then

                                   Begin
                                       select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                                       into f_inicio, f_fin, sem
                                       from sobptrm
                                       where sobptrm_term_code=Peri
                                       and     sobptrm_ptrm_code=parte;
                                   Exception
                                   When Others then
                                    f_inicio:= null;
                                    f_fin := null;
                                    sem :=null;
                                   End;


                                  Begin
                                        Insert into ssbsect values (
                                                                           Peri,     --SSBSECT_TERM_CODE
                                                                           crn,     --SSBSECT_CRN
                                                                           parte,     --SSBSECT_PTRM_CODE
                                                                           c.subj,     --SSBSECT_SUBJ_CODE
                                                                           c.crse,     --SSBSECT_CRSE_NUMB
                                                                            '01',     --SSBSECT_SEQ_NUMB
                                                                            'A',    --SSBSECT_SSTS_CODE
                                                                            schd,    --SSBSECT_SCHD_CODE
                                                                            campus,    --SSBSECT_CAMP_CODE
                                                                             title,   --SSBSECT_CRSE_TITLE
                                                                             credit,   --SSBSECT_CREDIT_HRS
                                                                             credit_bill,   --SSBSECT_BILL_HRS
                                                                             gmod,   --SSBSECT_GMOD_CODE
                                                                              null,  --SSBSECT_SAPR_CODE
                                                                              null, --SSBSECT_SESS_CODE
                                                                              null,  --SSBSECT_LINK_IDENT
                                                                              null,  --SSBSECT_PRNT_IND
                                                                              'Y',  --SSBSECT_GRADABLE_IND
                                                                               null,  --SSBSECT_TUIW_IND
                                                                               0, --SSBSECT_REG_ONEUP
                                                                               0, --SSBSECT_PRIOR_ENRL
                                                                               0, --SSBSECT_PROJ_ENRL
                                                                               50, --SSBSECT_MAX_ENRL
                                                                                0,--SSBSECT_ENRL
                                                                                50,--SSBSECT_SEATS_AVAIL
                                                                                null,--SSBSECT_TOT_CREDIT_HRS
                                                                                '0',--SSBSECT_CENSUS_ENRL
                                                                                f_inicio,--SSBSECT_CENSUS_ENRL_DATE
                                                                                sysdate,--SSBSECT_ACTIVITY_DATE
                                                                                f_inicio,--SSBSECT_PTRM_START_DATE
                                                                                f_fin,--SSBSECT_PTRM_END_DATE
                                                                                sem,--SSBSECT_PTRM_WEEKS
                                                                                null,--SSBSECT_RESERVED_IND
                                                                                null, --SSBSECT_WAIT_CAPACITY
                                                                                null,--SSBSECT_WAIT_COUNT
                                                                                null,--SSBSECT_WAIT_AVAIL
                                                                                null,--SSBSECT_LEC_HR
                                                                                null,--SSBSECT_LAB_HR
                                                                                null,--SSBSECT_OTH_HR
                                                                                null,--SSBSECT_CONT_HR
                                                                                null,--SSBSECT_ACCT_CODE
                                                                                null,--SSBSECT_ACCL_CODE
                                                                                null,--SSBSECT_CENSUS_2_DATE
                                                                                null,--SSBSECT_ENRL_CUT_OFF_DATE
                                                                                null,--SSBSECT_ACAD_CUT_OFF_DATE
                                                                                null,--SSBSECT_DROP_CUT_OFF_DATE
                                                                                null,--SSBSECT_CENSUS_2_ENRL
                                                                                'Y',--SSBSECT_VOICE_AVAIL
                                                                                'N',--SSBSECT_CAPP_PREREQ_TEST_IND
                                                                                null,--SSBSECT_GSCH_NAME
                                                                                null,--SSBSECT_BEST_OF_COMP
                                                                                null,--SSBSECT_SUBSET_OF_COMP
                                                                                'NOP',--SSBSECT_INSM_CODE
                                                                                null,--SSBSECT_REG_FROM_DATE
                                                                                null,--SSBSECT_REG_TO_DATE
                                                                                null,--SSBSECT_LEARNER_REGSTART_FDATE
                                                                                null,--SSBSECT_LEARNER_REGSTART_TDATE
                                                                                null,--SSBSECT_DUNT_CODE
                                                                                null,--SSBSECT_NUMBER_OF_UNITS
                                                                                0,--SSBSECT_NUMBER_OF_EXTENSIONS
                                                                                'SZFNVIN',--SSBSECT_DATA_ORIGIN
                                                                                user,--SSBSECT_USER_ID
                                                                                'MOOD',--SSBSECT_INTG_CDE
                                                                                'B',--SSBSECT_PREREQ_CHK_METHOD_CDE
                                                                                user,--SSBSECT_KEYWORD_INDEX_ID
                                                                                null,--SSBSECT_SCORE_OPEN_DATE
                                                                                null,--SSBSECT_SCORE_CUTOFF_DATE
                                                                                null,--SSBSECT_REAS_SCORE_OPEN_DATE
                                                                                null,--SSBSECT_REAS_SCORE_CTOF_DATE
                                                                                null,--SSBSECT_SURROGATE_ID
                                                                                null,--SSBSECT_VERSION
                                                                                 null);--SSBSECT_VPDI_CODE

                                                   Begin
                                                        insert into ssrmeet values(peri, crn, null,null,null,null,null,null, sysdate, f_inicio, f_fin, '01', null,null,null,null,null,null,null, 'ENL', null, credit, null, 0, null,null,null, 'CLVI', 'SZFNVIN', user, null,null,null);
                                                    Exception
                                                    when Others then
                                                       vl_error := 'Se presento un Error al insertar en ssrmeet ' ||sqlerrm;
                                                   End;


                                                  pidm_prof := null;

--                                                  If  c.prof is null then
--                                                       c.prof :=  '019814933';
--                                                  End if;

                                                    begin
                                                        select spriden_pidm into pidm_prof
                                                        from  spriden
                                                        where   spriden_id=c.prof and spriden_change_ind is null;
                                                    Exception when others then
                                                      pidm_prof:=null;
                                                    End;

                                                    if pidm_prof is not null then
                                                        Begin
                                                                insert into sirasgn values(ciclo, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,  sysdate, null,null,null,null, 'SZFNVIN', user, null, null, null, null,  null,null);
                                                        Exception
                                                        When Others then
                                                        null;
                                                        End;
                                                    end if;


                                                conta_ptrm :=0;

                                                    Begin
                                                         select count(*)
                                                            into conta_ptrm
                                                         from sfbetrm
                                                         where sfbetrm_term_code=peri
                                                         and     sfbetrm_pidm=c.pidm;
                                                    Exception
                                                        When Others then
                                                          conta_ptrm := 0;
                                                    End;


                                                     if conta_ptrm =0 then
                                                            Begin
                                                                    insert into sfbetrm values(peri, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFNVIN', null, 0,null,null, null,null,user,null);
                                                            Exception
                                                            When Others then
                                                                vl_error := ('Se presento un error al insertar en la tabla sfbetrm ' || sqlerrm);
                                                            End;
                                                     end if;



                                                    Begin
                                                        select sgbstdn_levl_code, sgbstdn_camp_code  into levl, camp
                                                        from sgbstdn a
                                                        where sgbstdn_pidm=c.pidm
                                                        and     sgbstdn_term_code_eff  in (select max(sgbstdn_term_code_eff) from sgbstdn aa
                                                                                                           where a.sgbstdn_pidm=aa.sgbstdn_pidm);
                                                    Exception
                                                    When Others then
                                                       levl := null;
                                                       camp := null;
                                                       vl_error := 'Se presento un error al obtener la informacion de SGBSTDN ' || sqlerrm;
                                                    End;

                                                   Begin
                                                            select distinct max(sorlcur_key_seqno)
                                                                into sp
                                                            from sorlcur
                                                            where sorlcur_pidm=c.pidm
                                                            and     sorlcur_program=c.prog
                                                            and     sorlcur_lmod_code='LEARNER';
                                                   Exception
                                                   when Others then
                                                      sp := null;
                                                      vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||sqlerrm;
                                                   End;
                                                --  calculamos la materi pade
                                                   begin
                                                   select GET_MATERIA_PADRE(c.materia)
                                                   into vmateria_padre
                                                    from dual;
                                                   exception when others  then
                                                       vmateria_padre := '';

                                                   end;

                                                   Begin

                                                       insert into sfrstcr values(
                                                                                        peri,     --SFRSTCR_TERM_CODE
                                                                                        c.pidm,     --SFRSTCR_PIDM
                                                                                        crn,     --SFRSTCR_CRN
                                                                                        1,     --SFRSTCR_CLASS_SORT_KEY
                                                                                        1,    --SFRSTCR_REG_SEQ
                                                                                        parte,    --SFRSTCR_PTRM_CODE
                                                                                        'RE',     --SFRSTCR_RSTS_CODE
                                                                                        sysdate,    --SFRSTCR_RSTS_DATE
                                                                                        null,    --SFRSTCR_ERROR_FLAG
                                                                                        null,    --SFRSTCR_MESSAGE
                                                                                        credit_bill,    --SFRSTCR_BILL_HR
                                                                                        3, --SFRSTCR_WAIV_HR
                                                                                        credit,     --SFRSTCR_CREDIT_HR
                                                                                        credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                                        credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                                        gmod,     --SFRSTCR_GMOD_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE_MID
                                                                                        null,    --SFRSTCR_GRDE_DATE
                                                                                        'N',    --SFRSTCR_DUPL_OVER
                                                                                        'N',    --SFRSTCR_LINK_OVER
                                                                                        'N',    --SFRSTCR_CORQ_OVER
                                                                                        'N',    --SFRSTCR_PREQ_OVER
                                                                                        'N',     --SFRSTCR_TIME_OVER
                                                                                        'N',     --SFRSTCR_CAPC_OVER
                                                                                        'N',     --SFRSTCR_LEVL_OVER
                                                                                        'N',     --SFRSTCR_COLL_OVER
                                                                                        'N',     --SFRSTCR_MAJR_OVER
                                                                                        'N',     --SFRSTCR_CLAS_OVER
                                                                                        'N',     --SFRSTCR_APPR_OVER
                                                                                        'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                                        sysdate,      --SFRSTCR_ADD_DATE
                                                                                        sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                                        levl,     --SFRSTCR_LEVL_CODE
                                                                                        camp,     --SFRSTCR_CAMP_CODE
                                                                                        vmateria_padre,     --SFRSTCR_RESERVED_KEY
                                                                                        null,     --SFRSTCR_ATTEND_HR
                                                                                        'Y',     --SFRSTCR_REPT_OVER
                                                                                        'N' ,    --SFRSTCR_RPTH_OVER
                                                                                        null,    --SFRSTCR_TEST_OVER
                                                                                        'N',    --SFRSTCR_CAMP_OVER
                                                                                        user,    --SFRSTCR_USER
                                                                                        'N',    --SFRSTCR_DEGC_OVER
                                                                                        'N',    --SFRSTCR_PROG_OVER
                                                                                        null,    --SFRSTCR_LAST_ATTEND
                                                                                        null,    --SFRSTCR_GCMT_CODE
                                                                                        'SZFNVIN',    --SFRSTCR_DATA_ORIGIN
                                                                                        sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                                        'N',  --SFRSTCR_DEPT_OVER
                                                                                        'N',  --SFRSTCR_ATTS_OVER
                                                                                        'N', --SFRSTCR_CHRT_OVER
                                                                                        null, --SFRSTCR_RMSG_CDE
                                                                                        null,  --SFRSTCR_WL_PRIORITY
                                                                                        null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                                        null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                                        null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                                        'N', --SFRSTCR_MEXC_OVER
                                                                                        sp,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                                        null,--SFRSTCR_BRDH_SEQ_NUM
                                                                                        '01',--SFRSTCR_BLCK_CODE
                                                                                        null,--SFRSTCR_STRH_SEQNO
                                                                                        null, --SFRSTCR_STRD_SEQNO
                                                                                        null,  --SFRSTCR_SURROGATE_ID
                                                                                        null, --SFRSTCR_VERSION
                                                                                        user,--SFRSTCR_USER_ID
                                                                                        no_recibo );--SFRSTCR_VPDI_CODE



                                                                Begin
                                                                     update ssbsect
                                                                            set ssbsect_enrl = ssbsect_enrl + 1
                                                                      where SSBSECT_TERM_CODE = peri
                                                                      And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                vl_error := 'Se presento un error al actualizar el enrolamiento ' ||sqlerrm;
                                                                End;

                                                                Begin
                                                                        update ssbsect
                                                                            set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                                        where SSBSECT_TERM_CODE = peri
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||sqlerrm;
                                                                End;

                                                                Begin
                                                                         update ssbsect
                                                                                set ssbsect_census_enrl=ssbsect_enrl
                                                                         Where SSBSECT_TERM_CODE = peri
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||sqlerrm;
                                                                End;


                                                                conta_ptrm:=0;

                                                                Begin
                                                                    Select count (*)
                                                                        Into conta_ptrm
                                                                    from sfrareg
                                                                    where SFRAREG_PIDM = c.pidm
                                                                    And SFRAREG_TERM_CODE = peri
                                                                    And SFRAREG_CRN = crn
                                                                    And SFRAREG_EXTENSION_NUMBER = 0
                                                                    And SFRAREG_RSTS_CODE = 'RE';
                                                                Exception
                                                                When Others then
                                                                   conta_ptrm :=0;
                                                                End;

                                                                If conta_ptrm = 0 then

                                                                     Begin
                                                                             insert into sfrareg values(c.pidm, peri, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFNVIN', sysdate, null,null,null);
                                                                     Exception
                                                                       When Others then
                                                                          vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||sqlerrm;
                                                                     End;
                                                                End if;

                                                                vl_existe :=0;

                                                                  Begin
                                                                     Select count(1)
                                                                     Into vl_existe
                                                                     from SHRINST
                                                                     Where  SHRINST_TERM_CODE = peri
                                                                     And SHRINST_CRN = crn
                                                                     And  SHRINST_PIDM = c.pidm;
                                                                  Exception
                                                                  When Others then
                                                                   vl_existe :=0;
                                                                  End;


                                                                  If vl_existe = 0 then
                                                                        Begin
                                                                            Insert into SHRINST values (peri,        --SHRINST_TERM_CODE
                                                                                                                     crn,       --SHRINST_CRN
                                                                                                                     c.pidm,       --SHRINST_PIDM
                                                                                                                     sysdate,       --SHRINST_ACTIVITY_DATE
                                                                                                                     'Y',       --SHRINST_PRIMARY_IND
                                                                                                                      null,      --SHRINST_SURROGATE_ID
                                                                                                                      null,      --SHRINST_VERSION
                                                                                                                     user,       --SHRINST_USER_ID
                                                                                                                     'SZFNVIN',       --SHRINST_DATA_ORIGIN
                                                                                                                      null);      --SHRINST_VPDI_CODE


                                                                        Exception
                                                                            When Others then
                                                                             vl_error := 'Se presento un error al insertar al alumno en SHRINST ' ||sqlerrm;
                                                                        End;

                                                                  End if;

                                                              Begin
                                                                    Update sgbstdn a
                                                                    set a.SGBSTDN_STYP_CODE ='N'
                                                                    Where a.SGBSTDN_PIDM = c.pidm
                                                                    And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                                           from sgbstdn a1
                                                                                                                           Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                                          --- And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1
                                                                                                                           )
                                                                    -- And a.SGBSTDN_PROGRAM_1 = c.prog
                                                                     ;
                                                                Exception
                                                                    When Others then
                                                                    vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                                                End;

                                                    Exception
                                                   when Others then
                                                       vl_error := 'Se presento un error al insertar al alumno en el grupo ' ||sqlerrm;
                                                   End;


                                  Exception
                                    When Others then
                                      vl_error := 'Se presento un Error al insertar el nuevo grupo 4 ' ||sqlerrm;
                                  End;

                        End if;

                        if crn is null then
                                    dbms_output.put_line('mensaje:'|| 'CRN  es Vacio');
                                vl_error := 'No se Recupero CRN';
                        End if;

                End if;  ------ No hay  CRN Creado

                if vl_error = 'EXITO' then
                    commit; --Commit;
                   -- dbms_output.put_line('mensaje:'||vl_error);
                Else
                -- dbms_output.put_line('mensaje:'||vl_error);
                   rollback;
                End if;
        Else
                --dbms_output.put_line('mensaje:'|| 'Ya tiene materias Inscritas ');
                null;
        End if; ----> El alumno ya tiene inscrita la materia

   End Loop;

Elsif  campus = 'UVE' and nivel = 'BA' then
 --dbms_output.put_line('Entrada 5');

                    for c in (

                    select  sorlcur_pidm pidm, spriden_id iden, sorlcur_program prog, sorlcur_term_code_ctlg ctlg , scrtext_text materia , smrarul_subj_code subj, smrarul_crse_numb_low crse,  '01' grupo,
                    null calif, sztdtec_periodicidad perio,
                    null  prof,
                     null pperiodo
                    from sorlcur a
                    join spriden b on b.spriden_pidm = a.sorlcur_pidm and b.spriden_change_ind is null
                    join  sgbstdn d on  d.sgbstdn_pidm=spriden_pidm
                    And d.SGBSTDN_TERM_CODE_EFF = (select max (b1.SGBSTDN_TERM_CODE_EFF)
                                                                           from SGBSTDN b1
                                                                           Where d.sgbstdn_pidm = b1.sgbstdn_pidm)
                    join smrpaap on smrpaap_program=sorlcur_program
                            and smrpaap_term_code_eff=sorlcur_term_code_ctlg
                    join smrarul on smrarul_area=smrpaap_area
                            and smrarul_term_code_eff=smrpaap_term_code_eff
                            and smrarul_subj_code  in ('CPB', '131')
                            and (smrarul_crse_numb_low like '%01%'  or
                                    smrarul_crse_numb_low like '%02%' or
                                    smrarul_crse_numb_low like '%03%' or
                                    smrarul_crse_numb_low like '%04%' or
                                    smrarul_crse_numb_low like '%05%' or
                                    smrarul_crse_numb_low like '%06%' or
                                    smrarul_crse_numb_low like '%07%' or
                                    smrarul_crse_numb_low like '%08%' or
                                    smrarul_crse_numb_low='001')                     join scrtext on scrtext_subj_code=smrarul_subj_code
                            and scrtext_crse_numb=smrarul_crse_numb_low
                            and (substr(scrtext_text,1,4)=smrarul_subj_code or substr(scrtext_text,1,3)=smrarul_subj_code
                            or substr(scrtext_text,1,2)=smrarul_subj_code)
                            And substr(smrarul_area,9,2) in ('01','02')
                    join sztdtec on sztdtec_program=sorlcur_program
                            and sztdtec_term_code=sorlcur_term_code_ctlg
                    Where  a.SORLCUR_LMOD_CODE = 'LEARNER'
                    And a.SORLCUR_CACT_CODE = 'ACTIVE'
                    And a.SORLCUR_ROLL_IND = 'Y'
                    And a.sorlcur_pidm in (select sorlcur_pidm
                                                      from sorlcur aa
                                                      where a.sorlcur_program=aa.sorlcur_program
                                                      and a.sorlcur_lmod_code=aa.sorlcur_lmod_code
                                                      and a.sorlcur_roll_ind=aa.sorlcur_roll_ind)
                    and a.SORLCUR_SEQNO = (select max (SORLCUR_SEQNO)
                                                            from SORLCUR aa1
                                                            Where a.sorlcur_pidm = aa1.sorlcur_pidm
                                                            And a.SORLCUR_LMOD_CODE = aa1.SORLCUR_LMOD_CODE
                                                            And a.SORLCUR_CACT_CODE = aa1.SORLCUR_CACT_CODE
                                                            And a.SORLCUR_KEY_SEQNO = aa1.SORLCUR_KEY_SEQNO
                                                            And a.sorlcur_program=aa1.sorlcur_program
                                                            And trunc (a.sorlcur_start_date) = fecha_ini
                                                            )
                    And a.SORLCUR_CAMP_CODE= campus
                    And a.SORLCUR_LEVL_CODE= nivel
                    And d.SGBSTDN_STYP_CODE in ('N', 'F')
                    order by   perio,materia, grupo, prog,ctlg, iden
                    ) loop



--------------- Limpia Variables  --------------------
--niv :=  null;
parte := null;
crn := null;
pidm_doc2 := null;
conta_sirasgn := null;
pidm_doc := null;
f_inicio := null;
f_fin := null;
sem := null;
schd := null;
title := null;
credit := null;
credit_bill :=null;
levl := null;
camp := null;
mate := null;
parte := null;
per := null;
grupo := null;
vl_existe :=0;

vn_lugares :=0;
vn_cupo_max :=0;
vn_cupo_act :=0;
vl_error := 'EXITO';



           ----- Busca la Parte de Periodo para el programa que inicia clases
        If c.pperiodo is null then

             Begin
                    select distinct SZTPTRM_PTRM_CODE
                        Into Parte
                    from sztptrm, sobptrm
                    where SZTPTRM_CAMP_CODE = campus
                    And SZTPTRM_LEVL_CODE = nivel
                    and SZTPTRM_TERM_CODE = peri
                    and SOBPTRM_TERM_CODE = SZTPTRM_TERM_CODE
                    AND SOBPTRM_PTRM_CODE = SZTPTRM_PTRM_CODE
                    and SZTPTRM_PROGRAM = c.prog
                    and trunc (SOBPTRM_START_DATE) = fecha_ini;

                    If Parte in ('M0C' ) THEN
                       Parte := 'M1A';
                    Elsif  Parte in ('M0A' ) THEN
                       Parte := 'M0B';
                    Elsif  Parte in ('A0A' ) THEN
                       Parte := 'A0B';
                    Elsif  Parte in ('A0C' ) THEN
                       Parte := 'A1A';
                    End if;

               Exception
                When Others then
                  parte := null;
               End;
        Else
             Parte := c.pperiodo;
        End if;


--------------------- Se valida que el alumno no tenga la materia sembrada en el horario como Activa ---------------------------------------
           begin
            --existe y es aprobatoria
                select count (1)
                    into vl_existe
                from ssbsect, sfrstcr, SHRGRDE
                where sfrstcr_pidm=c.pidm
                --and sfrstcr_term_code=c.periodo
                and ssbsect_term_code=sfrstcr_term_code
                and SFRSTCR_PTRM_CODE = SSBSECT_PTRM_CODE
                and ssbsect_crn=sfrstcr_crn
                and ssbsect_subj_code=c.subj
                and ssbsect_crse_numb=c.crse
                and SFRSTCR_RSTS_CODE = 'RE'
                AND (SFRSTCR_GRDE_CODE = SHRGRDE_CODE
                                         OR SFRSTCR_GRDE_CODE IS NULL)
                AND SHRGRDE_PASSED_IND = 'Y'
                AND SHRGRDE_LEVL_CODE= NIVEL;

           Exception
            when others then
                vl_existe:=0;
           end;

            Begin
                   select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                   into f_inicio, f_fin, sem
                   from sobptrm
                   where sobptrm_term_code=Peri
                   and     sobptrm_ptrm_code=parte;
            Exception
               When Others then
                f_inicio:= null;
                f_fin := null;
                sem :=null;
            End;



        If vl_existe = 0 then

            ---- Se busca que exista el grupo y tenga cupo

                If  c.prof is null then
                    --dbms_output.put_line ('sin profesor '||vl_existe);
                    --dbms_output.put_line ('crea consulta '||peri ||'*'|| c.subj  ||'*'||c.crse||'*'||c.grupo||'*'||fecha_ini);
                        begin

                                select ssbsect_crn , ssbsect_seats_avail lugares, ssbsect_max_enrl cupo_max, SSBSECT_PTRM_CODE,
                                        ssbsect_enrl cupo_Act,    SSBSECT_PTRM_START_DATE, SSBSECT_PTRM_END_DATE, SSBSECT_PTRM_WEEKS,
                                        SSBSECT_CREDIT_HRS, SSBSECT_BILL_HRS, SSBSECT_GMOD_CODE
                                into crn , vn_lugares, vn_cupo_max, parte,
                                       vn_cupo_act, f_inicio, f_fin, sem,
                                       credit, credit_bill, gmod
                                from ssbsect a
                                where a.SSBSECT_TERM_CODE= peri
                                and a.ssbsect_subj_code= c.subj
                               and a.ssbsect_crse_numb=c.crse
                               and a.SSBSECT_SEATS_AVAIL >0
                               AND a.SSBSECT_SEATS_AVAIL = (select max (a1.SSBSECT_SEATS_AVAIL)
                                                                               from ssbsect a1
                                                                                where a.SSBSECT_TERM_CODE = a1.SSBSECT_TERM_CODE
                                                                                and a.ssbsect_subj_code = a1.ssbsect_subj_code
                                                                                and a.ssbsect_crse_numb = a1.ssbsect_crse_numb
                                                                               and trunc (a.SSBSECT_PTRM_START_DATE) = trunc (a1.SSBSECT_PTRM_START_DATE))
                                and trunc (a.SSBSECT_PTRM_START_DATE) = f_inicio;

                        Exception
                        when others then
                            crn:=null;
                            vn_lugares :=0;
                            vn_cupo_max:=0;
                            vn_cupo_act:=0;
                            f_inicio := null;
                            f_fin := null;
                            sem := null;
                            credit  := null;
                            credit_bill  := null;
                            gmod  := null;
                              --dbms_output.put_line ('error de crea consulta '||sqlerrm);
                        end;
                Else
                           -- dbms_output.put_line ('con profesor '||vl_existe);

                       begin
                               select ssbsect_crn , ssbsect_seats_avail lugares, ssbsect_max_enrl cupo_max, SSBSECT_PTRM_CODE,
                                        ssbsect_enrl cupo_Act,    SSBSECT_PTRM_START_DATE, SSBSECT_PTRM_END_DATE, SSBSECT_PTRM_WEEKS,
                                        SSBSECT_CREDIT_HRS, SSBSECT_BILL_HRS, SSBSECT_GMOD_CODE
                                into crn , vn_lugares, vn_cupo_max, parte,
                                       vn_cupo_act, f_inicio, f_fin, sem,
                                       credit, credit_bill, gmod
                                from ssbsect a, sirasgn
                                where a.SSBSECT_TERM_CODE= peri
                                and a.ssbsect_subj_code= c.subj
                               and a.ssbsect_crse_numb=c.crse
                               and a.SSBSECT_SEQ_NUMB = c.grupo
                               and a.SSBSECT_SEATS_AVAIL >0
                               AND to_number (a.ssbsect_crn) = (select max (to_number (a1.ssbsect_crn))
                                                                                from ssbsect a1
                                                                                where a.SSBSECT_TERM_CODE = a1.SSBSECT_TERM_CODE
                                                                                and a.ssbsect_subj_code = a1.ssbsect_subj_code
                                                                                and a.ssbsect_crse_numb = a1.ssbsect_crse_numb
                                                                                and a.SSBSECT_SEQ_NUMB = a1.SSBSECT_SEQ_NUMB
                                                                                and a.SSBSECT_PTRM_START_DATE = a1.SSBSECT_PTRM_START_DATE
                                                                                )
                                and trunc (a.SSBSECT_PTRM_START_DATE) = f_inicio
                               And SIRASGN_PIDM = (select distinct  spriden_pidm
                                                                    from spriden
                                                                    where spriden_id = c.prof
                                                                    And spriden_change_ind is null )
                                And SIRASGN_PRIMARY_IND = 'Y' ;
                                 --dbms_output.put_line ('crea consulta '||peri ||'*'|| c.subj  ||'*'||c.crse||'*'||c.grupo||'*'||fecha_ini);

                       Exception
                        when others then
                            crn:=null;
                            vn_lugares :=0;
                            vn_cupo_max:=0;
                            vn_cupo_act:=0;
                            f_inicio := null;
                            f_fin := null;
                            sem := null;
                            credit  := null;
                            credit_bill  := null;
                            gmod  := null;
                            --dbms_output.put_line ('error de crea consulta '||sqlerrm);
                       end;

                End if;

                If crn is not null then

                    If vn_lugares >0  then

                            If credit is null then
                               Begin
                                      select SSRMEET_CREDIT_HR_SESS
                                       Into credit
                                      from SSRMEET
                                      where SSRMEET_TERM_CODE = peri
                                      And SSRMEET_CRN = crn;
                               Exception
                                When Others then
                                   credit :=null;
                                End;

                                  If credit is not null then
                                           Begin
                                               Update ssbsect
                                               set  SSBSECT_CREDIT_HRS = credit
                                               where SSBSECT_TERM_CODE = peri
                                               and SSBSECT_CRN = crn;
                                           Exception
                                           when Others then
                                                null;
                                           End;
                                  End if;
                           End if;

                           If credit_bill is null then
                                 Begin
                                         select  SCBCRSE_BILL_HR_LOW
                                            into credit_bill
                                            from scbcrse, scrschd
                                            where scbcrse_subj_code=  c.subj
                                            and     scbcrse_crse_numb=c.crse
                                            and     scbcrse_eff_term='000000'
                                            and     scrschd_subj_code=scbcrse_subj_code
                                            and     scrschd_crse_numb=scbcrse_crse_numb
                                            and     scrschd_eff_term=scbcrse_eff_term;
                                 Exception
                                 When Others then
                                    credit_bill := 3;
                                 End;

                                  If credit is not null then
                                           Begin
                                               Update ssbsect
                                               set  SSBSECT_BILL_HRS = credit_bill
                                               where SSBSECT_TERM_CODE = peri
                                               and SSBSECT_CRN = crn;
                                           Exception
                                           when Others then
                                                null;
                                           End;
                                  End if;
                           End if;




                          If gmod is null then
                                begin
                                    select scrgmod_gmod_code
                                    into gmod
                                    from scrgmod
                                    where scrgmod_subj_code=c.subj
                                    and     scrgmod_crse_numb=c.crse
                                    and     scrgmod_default_ind='D';
                                exception when others then
                                    gmod:='1';
                                end;

                                If gmod is not null then
                                           Begin
                                               Update ssbsect
                                               set  SSBSECT_GMOD_CODE = gmod
                                               where SSBSECT_TERM_CODE = peri
                                               and SSBSECT_CRN = crn;
                                           Exception
                                           when Others then
                                                null;
                                           End;
                                end if;

                          End if;


                        conta_ptrm :=0;

                            Begin
                                 select count(*)
                                    into conta_ptrm
                                 from sfbetrm
                                 where sfbetrm_term_code=peri
                                 and     sfbetrm_pidm=c.pidm;
                            Exception
                                When Others then
                                  conta_ptrm := 0;
                            End;


                             if conta_ptrm =0 then
                                    Begin
                                            insert into sfbetrm values(peri, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFNVIN', null, 0,null,null, null,null,user,null);
                                    Exception
                                    When Others then
                                        vl_error := ('Se presento un error al insertar en la tabla sfbetrm ' || sqlerrm);
                                    End;
                             end if;



                            Begin
                                select sgbstdn_levl_code, sgbstdn_camp_code  into levl, camp
                                from sgbstdn a
                                where sgbstdn_pidm=c.pidm
                                and     sgbstdn_term_code_eff  in (select max(sgbstdn_term_code_eff) from sgbstdn aa
                                                                                   where a.sgbstdn_pidm=aa.sgbstdn_pidm);
                            Exception
                            When Others then
                               levl := null;
                               camp := null;
                               vl_error := 'Se presento un error al obtener la informacion de SGBSTDN ' || sqlerrm;
                            End;

                           Begin
                                    select distinct max(sorlcur_key_seqno)
                                        into sp
                                    from sorlcur
                                    where sorlcur_pidm=c.pidm
                                    and     sorlcur_program=c.prog
                                    and     sorlcur_lmod_code='LEARNER';
                           Exception
                           when Others then
                              sp := null;
                              vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||sqlerrm;
                           End;
                                  --  calculamos la materi pade
                                       begin
                                       select GET_MATERIA_PADRE(c.materia)
                                       into vmateria_padre
                                        from dual;
                                       exception when others  then
                                           vmateria_padre := '';

                                       end;
                             Begin

                               insert into sfrstcr values(
                                                                peri,     --SFRSTCR_TERM_CODE
                                                                c.pidm,     --SFRSTCR_PIDM
                                                                crn,     --SFRSTCR_CRN
                                                                1,     --SFRSTCR_CLASS_SORT_KEY
                                                                1,    --SFRSTCR_REG_SEQ
                                                                parte,    --SFRSTCR_PTRM_CODE
                                                                'RE',     --SFRSTCR_RSTS_CODE
                                                                sysdate,    --SFRSTCR_RSTS_DATE
                                                                null,    --SFRSTCR_ERROR_FLAG
                                                                null,    --SFRSTCR_MESSAGE
                                                                credit_bill,    --SFRSTCR_BILL_HR
                                                                3, --SFRSTCR_WAIV_HR
                                                                credit,     --SFRSTCR_CREDIT_HR
                                                                credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                gmod,     --SFRSTCR_GMOD_CODE
                                                                null,    --SFRSTCR_GRDE_CODE
                                                                null,    --SFRSTCR_GRDE_CODE_MID
                                                                null,    --SFRSTCR_GRDE_DATE
                                                                'N',    --SFRSTCR_DUPL_OVER
                                                                'N',    --SFRSTCR_LINK_OVER
                                                                'N',    --SFRSTCR_CORQ_OVER
                                                                'N',    --SFRSTCR_PREQ_OVER
                                                                'N',     --SFRSTCR_TIME_OVER
                                                                'N',     --SFRSTCR_CAPC_OVER
                                                                'N',     --SFRSTCR_LEVL_OVER
                                                                'N',     --SFRSTCR_COLL_OVER
                                                                'N',     --SFRSTCR_MAJR_OVER
                                                                'N',     --SFRSTCR_CLAS_OVER
                                                                'N',     --SFRSTCR_APPR_OVER
                                                                'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                sysdate,      --SFRSTCR_ADD_DATE
                                                                sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                levl,     --SFRSTCR_LEVL_CODE
                                                                camp,     --SFRSTCR_CAMP_CODE
                                                                vmateria_padre,     --SFRSTCR_RESERVED_KEY
                                                                null,     --SFRSTCR_ATTEND_HR
                                                                'Y',     --SFRSTCR_REPT_OVER
                                                                'N' ,    --SFRSTCR_RPTH_OVER
                                                                null,    --SFRSTCR_TEST_OVER
                                                                'N',    --SFRSTCR_CAMP_OVER
                                                                user,    --SFRSTCR_USER
                                                                'N',    --SFRSTCR_DEGC_OVER
                                                                'N',    --SFRSTCR_PROG_OVER
                                                                null,    --SFRSTCR_LAST_ATTEND
                                                                null,    --SFRSTCR_GCMT_CODE
                                                                'SZFNVIN',    --SFRSTCR_DATA_ORIGIN
                                                                sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                'N',  --SFRSTCR_DEPT_OVER
                                                                'N',  --SFRSTCR_ATTS_OVER
                                                                'N', --SFRSTCR_CHRT_OVER
                                                                null, --SFRSTCR_RMSG_CDE
                                                                null,  --SFRSTCR_WL_PRIORITY
                                                                null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                'N', --SFRSTCR_MEXC_OVER
                                                                sp,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                null,--SFRSTCR_BRDH_SEQ_NUM
                                                                '01',--SFRSTCR_BLCK_CODE
                                                                null,--SFRSTCR_STRH_SEQNO
                                                                null, --SFRSTCR_STRD_SEQNO
                                                                null,  --SFRSTCR_SURROGATE_ID
                                                                null, --SFRSTCR_VERSION
                                                                user,--SFRSTCR_USER_ID
                                                                no_recibo );--SFRSTCR_VPDI_CODE



                                        Begin
                                             update ssbsect
                                                    set ssbsect_enrl = ssbsect_enrl + 1
                                              where SSBSECT_TERM_CODE = peri
                                              And SSBSECT_CRN  = crn;
                                        Exception
                                        When Others then
                                        vl_error := 'Se presento un error al actualizar el enrolamiento ' ||sqlerrm;
                                        End;

                                        Begin
                                                update ssbsect
                                                    set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                where SSBSECT_TERM_CODE = peri
                                                 And SSBSECT_CRN  = crn;
                                        Exception
                                        When Others then
                                            vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||sqlerrm;
                                        End;

                                        Begin
                                                 update ssbsect
                                                        set ssbsect_census_enrl=ssbsect_enrl
                                                 Where SSBSECT_TERM_CODE = peri
                                                 And SSBSECT_CRN  = crn;
                                        Exception
                                        When Others then
                                            vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||sqlerrm;
                                        End;


                                        conta_ptrm:=0;

                                        Begin
                                            Select count (*)
                                                Into conta_ptrm
                                            from sfrareg
                                            where SFRAREG_PIDM = c.pidm
                                            And SFRAREG_TERM_CODE = peri
                                            And SFRAREG_CRN = crn
                                            And SFRAREG_EXTENSION_NUMBER = 0
                                            And SFRAREG_RSTS_CODE = 'RE';
                                        Exception
                                        When Others then
                                           conta_ptrm :=0;
                                        End;

                                        If conta_ptrm = 0 then

                                             Begin
                                                     insert into sfrareg values(c.pidm, peri, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFNVIN', sysdate, null,null,null);
                                             Exception
                                               When Others then
                                                  vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||sqlerrm;
                                             End;
                                        End if;

                                         vl_existe :=0;

                                          Begin
                                             Select count(1)
                                             Into vl_existe
                                             from SHRINST
                                             Where  SHRINST_TERM_CODE = peri
                                             And SHRINST_CRN = crn
                                             And  SHRINST_PIDM = c.pidm;
                                          Exception
                                          When Others then
                                           vl_existe :=0;
                                          End;


                                          If vl_existe = 0 then
                                                Begin
                                                    Insert into SHRINST values (peri,        --SHRINST_TERM_CODE
                                                                                             crn,       --SHRINST_CRN
                                                                                             c.pidm,       --SHRINST_PIDM
                                                                                             sysdate,       --SHRINST_ACTIVITY_DATE
                                                                                             'Y',       --SHRINST_PRIMARY_IND
                                                                                              null,      --SHRINST_SURROGATE_ID
                                                                                              null,      --SHRINST_VERSION
                                                                                             user,       --SHRINST_USER_ID
                                                                                             'SZFNVIN',       --SHRINST_DATA_ORIGIN
                                                                                              null);      --SHRINST_VPDI_CODE


                                                Exception
                                                    When Others then
                                                     vl_error := 'Se presento un error al insertar al alumno en SHRINST ' ||sqlerrm;
                                                End;

                                          End if;



                                                              Begin
                                                                    Update sgbstdn a
                                                                    set a.SGBSTDN_STYP_CODE ='N'
                                                                    Where a.SGBSTDN_PIDM = c.pidm
                                                                    And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                                           from sgbstdn a1
                                                                                                                           Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                                          --- And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1
                                                                                                                           )
                                                                    -- And a.SGBSTDN_PROGRAM_1 = c.prog
                                                                     ;
                                                                Exception
                                                                    When Others then
                                                                    vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                                                End;



                            Exception
                           when Others then
                               vl_error := 'Se presento un error al insertar al alumno en el grupo ' ||sqlerrm;
                           End;

                     Else  ----------> Se realizara la creacion del grupo

                            schd := null;
                            title := null;
                            credit := null;
                            gmod :=null;
                            credit_bill := null;

                            Begin
                                select scrschd_schd_code, scbcrse_title, scbcrse_credit_hr_low, SCBCRSE_BILL_HR_LOW
                                into schd, title, credit, credit_bill
                                from scbcrse, scrschd
                                where scbcrse_subj_code=c.subj
                                and     scbcrse_crse_numb=c.crse
                                and     scbcrse_eff_term='000000'
                                and     scrschd_subj_code=scbcrse_subj_code
                                and     scrschd_crse_numb=scbcrse_crse_numb
                                and     scrschd_eff_term=scbcrse_eff_term;
                            Exception
                            When Others then
                                  schd := null;
                                  title := null;
                                  credit := null;
                            End;


                            begin
                                select scrgmod_gmod_code
                                      into gmod
                                from scrgmod
                                where scrgmod_subj_code=c.subj
                                and     scrgmod_crse_numb=c.crse
                                and     scrgmod_default_ind='D';
                            exception when others then
                                gmod:='1';
                            end;

                             Begin
                                   dbms_output.put_line('Periodosssss:'|| peri);
                            select nvl(max(crn),1000)+1
                            into crn
                            from
                            (
                            select case when
                                                substr(SSBSECT_CRN,1,1) IN('L','B') then to_number(substr(SSBSECT_CRN,2,100))+1
                                      else
                                            to_number(SSBSECT_CRN)
                                      end crn
                            from ssbsect
                            where ssbsect_term_code= peri
                            );

                            EXCEPTION WHEN OTHERS THEN
                            crn := NULL;
                            END;


                            if nivel ='LI' then
                            crn:='L'||crn;
                            Elsif nivel ='BA' then
                            crn:='B'||crn;
                            end if;


                             If crn is not null then

                               Begin
                                   select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                                   into f_inicio, f_fin, sem
                                   from sobptrm
                                   where sobptrm_term_code=Peri
                                   and     sobptrm_ptrm_code=parte;
                               Exception
                               When Others then
                                f_inicio:= null;
                                f_fin := null;
                                sem :=null;
                               End;



                                  Begin
                                        Insert into ssbsect values (
                                                                           Peri,     --SSBSECT_TERM_CODE
                                                                           crn,     --SSBSECT_CRN
                                                                           parte,     --SSBSECT_PTRM_CODE
                                                                           c.subj,     --SSBSECT_SUBJ_CODE
                                                                           c.crse,     --SSBSECT_CRSE_NUMB
                                                                            '01',     --SSBSECT_SEQ_NUMB
                                                                            'A',    --SSBSECT_SSTS_CODE
                                                                            schd,    --SSBSECT_SCHD_CODE
                                                                            campus,    --SSBSECT_CAMP_CODE
                                                                             title,   --SSBSECT_CRSE_TITLE
                                                                             credit,   --SSBSECT_CREDIT_HRS
                                                                             credit_bill,   --SSBSECT_BILL_HRS
                                                                             gmod,   --SSBSECT_GMOD_CODE
                                                                              null,  --SSBSECT_SAPR_CODE
                                                                              null, --SSBSECT_SESS_CODE
                                                                              null,  --SSBSECT_LINK_IDENT
                                                                              null,  --SSBSECT_PRNT_IND
                                                                              'Y',  --SSBSECT_GRADABLE_IND
                                                                               null,  --SSBSECT_TUIW_IND
                                                                               0, --SSBSECT_REG_ONEUP
                                                                               0, --SSBSECT_PRIOR_ENRL
                                                                               0, --SSBSECT_PROJ_ENRL
                                                                               50, --SSBSECT_MAX_ENRL
                                                                                0,--SSBSECT_ENRL
                                                                                50,--SSBSECT_SEATS_AVAIL
                                                                                null,--SSBSECT_TOT_CREDIT_HRS
                                                                                '0',--SSBSECT_CENSUS_ENRL
                                                                                f_inicio,--SSBSECT_CENSUS_ENRL_DATE
                                                                                sysdate,--SSBSECT_ACTIVITY_DATE
                                                                                f_inicio,--SSBSECT_PTRM_START_DATE
                                                                                f_fin,--SSBSECT_PTRM_END_DATE
                                                                                sem,--SSBSECT_PTRM_WEEKS
                                                                                null,--SSBSECT_RESERVED_IND
                                                                                null, --SSBSECT_WAIT_CAPACITY
                                                                                null,--SSBSECT_WAIT_COUNT
                                                                                null,--SSBSECT_WAIT_AVAIL
                                                                                null,--SSBSECT_LEC_HR
                                                                                null,--SSBSECT_LAB_HR
                                                                                null,--SSBSECT_OTH_HR
                                                                                null,--SSBSECT_CONT_HR
                                                                                null,--SSBSECT_ACCT_CODE
                                                                                null,--SSBSECT_ACCL_CODE
                                                                                null,--SSBSECT_CENSUS_2_DATE
                                                                                null,--SSBSECT_ENRL_CUT_OFF_DATE
                                                                                null,--SSBSECT_ACAD_CUT_OFF_DATE
                                                                                null,--SSBSECT_DROP_CUT_OFF_DATE
                                                                                null,--SSBSECT_CENSUS_2_ENRL
                                                                                'Y',--SSBSECT_VOICE_AVAIL
                                                                                'N',--SSBSECT_CAPP_PREREQ_TEST_IND
                                                                                null,--SSBSECT_GSCH_NAME
                                                                                null,--SSBSECT_BEST_OF_COMP
                                                                                null,--SSBSECT_SUBSET_OF_COMP
                                                                                'NOP',--SSBSECT_INSM_CODE
                                                                                null,--SSBSECT_REG_FROM_DATE
                                                                                null,--SSBSECT_REG_TO_DATE
                                                                                null,--SSBSECT_LEARNER_REGSTART_FDATE
                                                                                null,--SSBSECT_LEARNER_REGSTART_TDATE
                                                                                null,--SSBSECT_DUNT_CODE
                                                                                null,--SSBSECT_NUMBER_OF_UNITS
                                                                                0,--SSBSECT_NUMBER_OF_EXTENSIONS
                                                                                'SZFNVIN',--SSBSECT_DATA_ORIGIN
                                                                                user,--SSBSECT_USER_ID
                                                                                'MOOD',--SSBSECT_INTG_CDE
                                                                                'B',--SSBSECT_PREREQ_CHK_METHOD_CDE
                                                                                user,--SSBSECT_KEYWORD_INDEX_ID
                                                                                null,--SSBSECT_SCORE_OPEN_DATE
                                                                                null,--SSBSECT_SCORE_CUTOFF_DATE
                                                                                null,--SSBSECT_REAS_SCORE_OPEN_DATE
                                                                                null,--SSBSECT_REAS_SCORE_CTOF_DATE
                                                                                null,--SSBSECT_SURROGATE_ID
                                                                                null,--SSBSECT_VERSION
                                                                                 null);--SSBSECT_VPDI_CODE

                                                   Begin
                                                        insert into ssrmeet values(peri, crn, null,null,null,null,null,null, sysdate, f_inicio, f_fin, '01', null,null,null,null,null,null,null, 'ENL', null, credit, null, 0, null,null,null, 'CLVI', 'SZFNVIN', user, null,null,null);
                                                    Exception
                                                    when Others then
                                                       vl_error := 'Se presento un Error al insertar en ssrmeet ' ||sqlerrm;
                                                   End;

                                                 pidm_prof := null;

--                                                  If  c.prof is null then
--                                                       c.prof :=  '019814933';
--                                                  End if;

                                                    begin
                                                    select spriden_pidm into pidm_prof
                                                    from  spriden
                                                    where   spriden_id=c.prof and spriden_change_ind is null;
                                                    exception when others then
                                                    pidm_prof:=null;
                                                    end;

                                                    if pidm_prof is not null then
                                                        Begin
                                                                insert into sirasgn values(ciclo, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,  sysdate, null,null,null,null, 'SZFNVIN', user, null, null, null, null,  null,null);
                                                        Exception
                                                        When Others then
                                                        null;
                                                        End;
                                                    end if;


                                                conta_ptrm :=0;

                                                    Begin
                                                         select count(*)
                                                            into conta_ptrm
                                                         from sfbetrm
                                                         where sfbetrm_term_code=peri
                                                         and     sfbetrm_pidm=c.pidm;
                                                    Exception
                                                        When Others then
                                                          conta_ptrm := 0;
                                                    End;


                                                     if conta_ptrm =0 then
                                                            Begin
                                                                    insert into sfbetrm values(peri, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFNVIN', null, 0,null,null, null,null,user,null);
                                                            Exception
                                                            When Others then
                                                                vl_error := ('Se presento un error al insertar en la tabla sfbetrm ' || sqlerrm);
                                                            End;
                                                     end if;



                                                    Begin
                                                        select sgbstdn_levl_code, sgbstdn_camp_code  into levl, camp
                                                        from sgbstdn a
                                                        where sgbstdn_pidm=c.pidm
                                                        and     sgbstdn_term_code_eff  in (select max(sgbstdn_term_code_eff) from sgbstdn aa
                                                                                                           where a.sgbstdn_pidm=aa.sgbstdn_pidm);
                                                    Exception
                                                    When Others then
                                                       levl := null;
                                                       camp := null;
                                                       vl_error := 'Se presento un error al obtener la informacion de SGBSTDN ' || sqlerrm;
                                                    End;

                                                   Begin
                                                            select distinct max(sorlcur_key_seqno)
                                                                into sp
                                                            from sorlcur
                                                            where sorlcur_pidm=c.pidm
                                                            and     sorlcur_program=c.prog
                                                            and     sorlcur_lmod_code='LEARNER';
                                                   Exception
                                                   when Others then
                                                      sp := null;
                                                      vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||sqlerrm;
                                                   End;
                                      --  calculamos la materi pade
                                       begin
                                       select GET_MATERIA_PADRE(c.materia)
                                       into vmateria_padre
                                        from dual;
                                       exception when others  then
                                           vmateria_padre := '';
                                       end;


                                                   Begin

                                                       insert into sfrstcr values(
                                                                                        peri,     --SFRSTCR_TERM_CODE
                                                                                        c.pidm,     --SFRSTCR_PIDM
                                                                                        crn,     --SFRSTCR_CRN
                                                                                        1,     --SFRSTCR_CLASS_SORT_KEY
                                                                                        1,    --SFRSTCR_REG_SEQ
                                                                                        parte,    --SFRSTCR_PTRM_CODE
                                                                                        'RE',     --SFRSTCR_RSTS_CODE
                                                                                        sysdate,    --SFRSTCR_RSTS_DATE
                                                                                        null,    --SFRSTCR_ERROR_FLAG
                                                                                        null,    --SFRSTCR_MESSAGE
                                                                                        credit_bill,    --SFRSTCR_BILL_HR
                                                                                        3, --SFRSTCR_WAIV_HR
                                                                                        credit,     --SFRSTCR_CREDIT_HR
                                                                                        credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                                        credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                                        gmod,     --SFRSTCR_GMOD_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE_MID
                                                                                        null,    --SFRSTCR_GRDE_DATE
                                                                                        'N',    --SFRSTCR_DUPL_OVER
                                                                                        'N',    --SFRSTCR_LINK_OVER
                                                                                        'N',    --SFRSTCR_CORQ_OVER
                                                                                        'N',    --SFRSTCR_PREQ_OVER
                                                                                        'N',     --SFRSTCR_TIME_OVER
                                                                                        'N',     --SFRSTCR_CAPC_OVER
                                                                                        'N',     --SFRSTCR_LEVL_OVER
                                                                                        'N',     --SFRSTCR_COLL_OVER
                                                                                        'N',     --SFRSTCR_MAJR_OVER
                                                                                        'N',     --SFRSTCR_CLAS_OVER
                                                                                        'N',     --SFRSTCR_APPR_OVER
                                                                                        'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                                        sysdate,      --SFRSTCR_ADD_DATE
                                                                                        sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                                        levl,     --SFRSTCR_LEVL_CODE
                                                                                        camp,     --SFRSTCR_CAMP_CODE
                                                                                        vmateria_padre,     --SFRSTCR_RESERVED_KEY
                                                                                        null,     --SFRSTCR_ATTEND_HR
                                                                                        'Y',     --SFRSTCR_REPT_OVER
                                                                                        'N' ,    --SFRSTCR_RPTH_OVER
                                                                                        null,    --SFRSTCR_TEST_OVER
                                                                                        'N',    --SFRSTCR_CAMP_OVER
                                                                                        user,    --SFRSTCR_USER
                                                                                        'N',    --SFRSTCR_DEGC_OVER
                                                                                        'N',    --SFRSTCR_PROG_OVER
                                                                                        null,    --SFRSTCR_LAST_ATTEND
                                                                                        null,    --SFRSTCR_GCMT_CODE
                                                                                        'SZFNVIN',    --SFRSTCR_DATA_ORIGIN
                                                                                        sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                                        'N',  --SFRSTCR_DEPT_OVER
                                                                                        'N',  --SFRSTCR_ATTS_OVER
                                                                                        'N', --SFRSTCR_CHRT_OVER
                                                                                        null, --SFRSTCR_RMSG_CDE
                                                                                        null,  --SFRSTCR_WL_PRIORITY
                                                                                        null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                                        null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                                        null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                                        'N', --SFRSTCR_MEXC_OVER
                                                                                        sp,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                                        null,--SFRSTCR_BRDH_SEQ_NUM
                                                                                        '01',--SFRSTCR_BLCK_CODE
                                                                                        null,--SFRSTCR_STRH_SEQNO
                                                                                        null, --SFRSTCR_STRD_SEQNO
                                                                                        null,  --SFRSTCR_SURROGATE_ID
                                                                                        null, --SFRSTCR_VERSION
                                                                                        user,--SFRSTCR_USER_ID
                                                                                        no_recibo );--SFRSTCR_VPDI_CODE



                                                                Begin
                                                                     update ssbsect
                                                                            set ssbsect_enrl = ssbsect_enrl + 1
                                                                      where SSBSECT_TERM_CODE = peri
                                                                      And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                vl_error := 'Se presento un error al actualizar el enrolamiento ' ||sqlerrm;
                                                                End;

                                                                Begin
                                                                        update ssbsect
                                                                            set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                                        where SSBSECT_TERM_CODE = peri
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||sqlerrm;
                                                                End;

                                                                Begin
                                                                         update ssbsect
                                                                                set ssbsect_census_enrl=ssbsect_enrl
                                                                         Where SSBSECT_TERM_CODE = peri
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||sqlerrm;
                                                                End;


                                                                conta_ptrm:=0;

                                                                Begin
                                                                    Select count (*)
                                                                        Into conta_ptrm
                                                                    from sfrareg
                                                                    where SFRAREG_PIDM = c.pidm
                                                                    And SFRAREG_TERM_CODE = peri
                                                                    And SFRAREG_CRN = crn
                                                                    And SFRAREG_EXTENSION_NUMBER = 0
                                                                    And SFRAREG_RSTS_CODE = 'RE';
                                                                Exception
                                                                When Others then
                                                                   conta_ptrm :=0;
                                                                End;

                                                                If conta_ptrm = 0 then

                                                                     Begin
                                                                             insert into sfrareg values(c.pidm, peri, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFNVIN', sysdate, null,null,null);
                                                                     Exception
                                                                       When Others then
                                                                          vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||sqlerrm;
                                                                     End;
                                                                End if;

                                                                 vl_existe :=0;

                                                                      Begin
                                                                         Select count(1)
                                                                         Into vl_existe
                                                                         from SHRINST
                                                                         Where  SHRINST_TERM_CODE = peri
                                                                         And SHRINST_CRN = crn
                                                                         And  SHRINST_PIDM = c.pidm;
                                                                      Exception
                                                                      When Others then
                                                                       vl_existe :=0;
                                                                      End;


                                                                      If vl_existe = 0 then
                                                                            Begin
                                                                                Insert into SHRINST values (peri,        --SHRINST_TERM_CODE
                                                                                                                         crn,       --SHRINST_CRN
                                                                                                                         c.pidm,       --SHRINST_PIDM
                                                                                                                         sysdate,       --SHRINST_ACTIVITY_DATE
                                                                                                                         'Y',       --SHRINST_PRIMARY_IND
                                                                                                                          null,      --SHRINST_SURROGATE_ID
                                                                                                                          null,      --SHRINST_VERSION
                                                                                                                         user,       --SHRINST_USER_ID
                                                                                                                         'SZFNVIN',       --SHRINST_DATA_ORIGIN
                                                                                                                          null);      --SHRINST_VPDI_CODE


                                                                            Exception
                                                                                When Others then
                                                                                 vl_error := 'Se presento un error al insertar al alumno en SHRINST ' ||sqlerrm;
                                                                            End;

                                                                      End if;


                                                              Begin
                                                                    Update sgbstdn a
                                                                    set a.SGBSTDN_STYP_CODE ='N'
                                                                    Where a.SGBSTDN_PIDM = c.pidm
                                                                    And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                                           from sgbstdn a1
                                                                                                                           Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                                          --- And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1
                                                                                                                           )
                                                                    -- And a.SGBSTDN_PROGRAM_1 = c.prog
                                                                     ;
                                                                Exception
                                                                    When Others then
                                                                    vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                                                End;


                                                    Exception
                                                   when Others then
                                                       vl_error := 'Se presento un error al insertar al alumno en el grupo ' ||sqlerrm;
                                                   End;


                                  Exception
                                    When Others then
                                      vl_error := 'Se presento un Error al insertar el nuevo grupo 5 ' ||sqlerrm;
                                  End;
                             End if;

                    -- dbms_output.put_line('mensaje:'|| 'No hay grupo cupo');
                     End if;
                Else
                   -- dbms_output.put_line('mensaje:'|| 'No hay grupo creado');
                            schd := null;
                            title := null;
                            credit := null;
                            gmod :=null;
                            credit_bill := null;

                            Begin
                                select scrschd_schd_code, scbcrse_title, scbcrse_credit_hr_low, SCBCRSE_BILL_HR_LOW
                                into schd, title, credit, credit_bill
                                from scbcrse, scrschd
                                where scbcrse_subj_code=c.subj
                                and     scbcrse_crse_numb=c.crse
                                and     scbcrse_eff_term='000000'
                                and     scrschd_subj_code=scbcrse_subj_code
                                and     scrschd_crse_numb=scbcrse_crse_numb
                                and     scrschd_eff_term=scbcrse_eff_term;
                            Exception
                            When Others then
                                  schd := null;
                                  title := null;
                                  credit := null;
                            End;


                            begin
                                select scrgmod_gmod_code
                                      into gmod
                                from scrgmod
                                where scrgmod_subj_code=c.subj
                                and     scrgmod_crse_numb=c.crse
                                and     scrgmod_default_ind='D';
                            exception when others then
                                gmod:='1';
                            end;

                            Begin
                                   dbms_output.put_line('Periodosssss:'|| peri);
                            select nvl(max(crn),1000)+1
                            into crn
                            from
                            (
                            select case when
                                                substr(SSBSECT_CRN,1,1) IN('L','B') then to_number(substr(SSBSECT_CRN,2,100))+1
                                      else
                                            to_number(SSBSECT_CRN)
                                      end crn
                            from ssbsect
                            where ssbsect_term_code= peri
                            );

                            EXCEPTION WHEN OTHERS THEN
                            crn := NULL;
                            END;


                            if nivel ='LI' then
                            crn:='L'||crn;
                            Elsif nivel ='BA' then
                            crn:='B'||crn;
                            end if;

                        If crn is not null then

                                Begin
                                   select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                                   into f_inicio, f_fin, sem
                                   from sobptrm
                                   where sobptrm_term_code=Peri
                                   and     sobptrm_ptrm_code=parte;
                                Exception
                                When Others then
                                    f_inicio:= null;
                                    f_fin := null;
                                    sem :=null;
                                End;

                                  Begin
                                        Insert into ssbsect values (
                                                                           Peri,     --SSBSECT_TERM_CODE
                                                                           crn,     --SSBSECT_CRN
                                                                           parte,     --SSBSECT_PTRM_CODE
                                                                           c.subj,     --SSBSECT_SUBJ_CODE
                                                                           c.crse,     --SSBSECT_CRSE_NUMB
                                                                            '01',     --SSBSECT_SEQ_NUMB
                                                                            'A',    --SSBSECT_SSTS_CODE
                                                                            schd,    --SSBSECT_SCHD_CODE
                                                                            campus,    --SSBSECT_CAMP_CODE
                                                                             title,   --SSBSECT_CRSE_TITLE
                                                                             credit,   --SSBSECT_CREDIT_HRS
                                                                             credit_bill,   --SSBSECT_BILL_HRS
                                                                             gmod,   --SSBSECT_GMOD_CODE
                                                                              null,  --SSBSECT_SAPR_CODE
                                                                              null, --SSBSECT_SESS_CODE
                                                                              null,  --SSBSECT_LINK_IDENT
                                                                              null,  --SSBSECT_PRNT_IND
                                                                              'Y',  --SSBSECT_GRADABLE_IND
                                                                               null,  --SSBSECT_TUIW_IND
                                                                               0, --SSBSECT_REG_ONEUP
                                                                               0, --SSBSECT_PRIOR_ENRL
                                                                               0, --SSBSECT_PROJ_ENRL
                                                                               50, --SSBSECT_MAX_ENRL
                                                                                0,--SSBSECT_ENRL
                                                                                50,--SSBSECT_SEATS_AVAIL
                                                                                null,--SSBSECT_TOT_CREDIT_HRS
                                                                                '0',--SSBSECT_CENSUS_ENRL
                                                                                f_inicio,--SSBSECT_CENSUS_ENRL_DATE
                                                                                sysdate,--SSBSECT_ACTIVITY_DATE
                                                                                f_inicio,--SSBSECT_PTRM_START_DATE
                                                                                f_fin,--SSBSECT_PTRM_END_DATE
                                                                                sem,--SSBSECT_PTRM_WEEKS
                                                                                null,--SSBSECT_RESERVED_IND
                                                                                null, --SSBSECT_WAIT_CAPACITY
                                                                                null,--SSBSECT_WAIT_COUNT
                                                                                null,--SSBSECT_WAIT_AVAIL
                                                                                null,--SSBSECT_LEC_HR
                                                                                null,--SSBSECT_LAB_HR
                                                                                null,--SSBSECT_OTH_HR
                                                                                null,--SSBSECT_CONT_HR
                                                                                null,--SSBSECT_ACCT_CODE
                                                                                null,--SSBSECT_ACCL_CODE
                                                                                null,--SSBSECT_CENSUS_2_DATE
                                                                                null,--SSBSECT_ENRL_CUT_OFF_DATE
                                                                                null,--SSBSECT_ACAD_CUT_OFF_DATE
                                                                                null,--SSBSECT_DROP_CUT_OFF_DATE
                                                                                null,--SSBSECT_CENSUS_2_ENRL
                                                                                'Y',--SSBSECT_VOICE_AVAIL
                                                                                'N',--SSBSECT_CAPP_PREREQ_TEST_IND
                                                                                null,--SSBSECT_GSCH_NAME
                                                                                null,--SSBSECT_BEST_OF_COMP
                                                                                null,--SSBSECT_SUBSET_OF_COMP
                                                                                'NOP',--SSBSECT_INSM_CODE
                                                                                null,--SSBSECT_REG_FROM_DATE
                                                                                null,--SSBSECT_REG_TO_DATE
                                                                                null,--SSBSECT_LEARNER_REGSTART_FDATE
                                                                                null,--SSBSECT_LEARNER_REGSTART_TDATE
                                                                                null,--SSBSECT_DUNT_CODE
                                                                                null,--SSBSECT_NUMBER_OF_UNITS
                                                                                0,--SSBSECT_NUMBER_OF_EXTENSIONS
                                                                                'SZFNVIN',--SSBSECT_DATA_ORIGIN
                                                                                user,--SSBSECT_USER_ID
                                                                                'MOOD',--SSBSECT_INTG_CDE
                                                                                'B',--SSBSECT_PREREQ_CHK_METHOD_CDE
                                                                                user,--SSBSECT_KEYWORD_INDEX_ID
                                                                                null,--SSBSECT_SCORE_OPEN_DATE
                                                                                null,--SSBSECT_SCORE_CUTOFF_DATE
                                                                                null,--SSBSECT_REAS_SCORE_OPEN_DATE
                                                                                null,--SSBSECT_REAS_SCORE_CTOF_DATE
                                                                                null,--SSBSECT_SURROGATE_ID
                                                                                null,--SSBSECT_VERSION
                                                                                 null);--SSBSECT_VPDI_CODE

                                                   Begin
                                                        insert into ssrmeet values(peri, crn, null,null,null,null,null,null, sysdate, f_inicio, f_fin, '01', null,null,null,null,null,null,null, 'ENL', null, credit, null, 0, null,null,null, 'CLVI', 'SZFNVIN', user, null,null,null);
                                                    Exception
                                                    when Others then
                                                       vl_error := 'Se presento un Error al insertar en ssrmeet ' ||sqlerrm;
                                                   End;


                                                 pidm_prof := null;

--                                                  If  c.prof is null then
--                                                       c.prof :=  '019814933';
--                                                  End if;

                                                    begin
                                                        select spriden_pidm into pidm_prof
                                                        from  spriden
                                                        where   spriden_id=c.prof and spriden_change_ind is null;
                                                    Exception when others then
                                                      pidm_prof:=null;
                                                    End;

                                                    if pidm_prof is not null then
                                                        Begin
                                                                insert into sirasgn values(ciclo, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,  sysdate, null,null,null,null, 'SZFNVIN', user, null, null, null, null,  null,null);
                                                        Exception
                                                        When Others then
                                                        null;
                                                        End;
                                                    end if;


                                                conta_ptrm :=0;

                                                    Begin
                                                         select count(*)
                                                            into conta_ptrm
                                                         from sfbetrm
                                                         where sfbetrm_term_code=peri
                                                         and     sfbetrm_pidm=c.pidm;
                                                    Exception
                                                        When Others then
                                                          conta_ptrm := 0;
                                                    End;


                                                     if conta_ptrm =0 then
                                                            Begin
                                                                    insert into sfbetrm values(peri, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFNVIN', null, 0,null,null, null,null,user,null);
                                                            Exception
                                                            When Others then
                                                                vl_error := ('Se presento un error al insertar en la tabla sfbetrm ' || sqlerrm);
                                                            End;
                                                     end if;



                                                    Begin
                                                        select sgbstdn_levl_code, sgbstdn_camp_code  into levl, camp
                                                        from sgbstdn a
                                                        where sgbstdn_pidm=c.pidm
                                                        and     sgbstdn_term_code_eff  in (select max(sgbstdn_term_code_eff) from sgbstdn aa
                                                                                                           where a.sgbstdn_pidm=aa.sgbstdn_pidm);
                                                    Exception
                                                    When Others then
                                                       levl := null;
                                                       camp := null;
                                                       vl_error := 'Se presento un error al obtener la informacion de SGBSTDN ' || sqlerrm;
                                                    End;

                                                   Begin
                                                            select distinct max(sorlcur_key_seqno)
                                                                into sp
                                                            from sorlcur
                                                            where sorlcur_pidm=c.pidm
                                                            and     sorlcur_program=c.prog
                                                            and     sorlcur_lmod_code='LEARNER';
                                                   Exception
                                                   when Others then
                                                      sp := null;
                                                      vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||sqlerrm;
                                                   End;

                                                   Begin

                                                       insert into sfrstcr values(
                                                                                        peri,     --SFRSTCR_TERM_CODE
                                                                                        c.pidm,     --SFRSTCR_PIDM
                                                                                        crn,     --SFRSTCR_CRN
                                                                                        1,     --SFRSTCR_CLASS_SORT_KEY
                                                                                        1,    --SFRSTCR_REG_SEQ
                                                                                        parte,    --SFRSTCR_PTRM_CODE
                                                                                        'RE',     --SFRSTCR_RSTS_CODE
                                                                                        sysdate,    --SFRSTCR_RSTS_DATE
                                                                                        null,    --SFRSTCR_ERROR_FLAG
                                                                                        null,    --SFRSTCR_MESSAGE
                                                                                        credit_bill,    --SFRSTCR_BILL_HR
                                                                                        3, --SFRSTCR_WAIV_HR
                                                                                        credit,     --SFRSTCR_CREDIT_HR
                                                                                        credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                                        credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                                        gmod,     --SFRSTCR_GMOD_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE_MID
                                                                                        null,    --SFRSTCR_GRDE_DATE
                                                                                        'N',    --SFRSTCR_DUPL_OVER
                                                                                        'N',    --SFRSTCR_LINK_OVER
                                                                                        'N',    --SFRSTCR_CORQ_OVER
                                                                                        'N',    --SFRSTCR_PREQ_OVER
                                                                                        'N',     --SFRSTCR_TIME_OVER
                                                                                        'N',     --SFRSTCR_CAPC_OVER
                                                                                        'N',     --SFRSTCR_LEVL_OVER
                                                                                        'N',     --SFRSTCR_COLL_OVER
                                                                                        'N',     --SFRSTCR_MAJR_OVER
                                                                                        'N',     --SFRSTCR_CLAS_OVER
                                                                                        'N',     --SFRSTCR_APPR_OVER
                                                                                        'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                                        sysdate,      --SFRSTCR_ADD_DATE
                                                                                        sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                                        levl,     --SFRSTCR_LEVL_CODE
                                                                                        camp,     --SFRSTCR_CAMP_CODE
                                                                                        null,     --SFRSTCR_RESERVED_KEY
                                                                                        null,     --SFRSTCR_ATTEND_HR
                                                                                        'Y',     --SFRSTCR_REPT_OVER
                                                                                        'N' ,    --SFRSTCR_RPTH_OVER
                                                                                        null,    --SFRSTCR_TEST_OVER
                                                                                        'N',    --SFRSTCR_CAMP_OVER
                                                                                        user,    --SFRSTCR_USER
                                                                                        'N',    --SFRSTCR_DEGC_OVER
                                                                                        'N',    --SFRSTCR_PROG_OVER
                                                                                        null,    --SFRSTCR_LAST_ATTEND
                                                                                        null,    --SFRSTCR_GCMT_CODE
                                                                                        'SZFNVIN',    --SFRSTCR_DATA_ORIGIN
                                                                                        sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                                        'N',  --SFRSTCR_DEPT_OVER
                                                                                        'N',  --SFRSTCR_ATTS_OVER
                                                                                        'N', --SFRSTCR_CHRT_OVER
                                                                                        null, --SFRSTCR_RMSG_CDE
                                                                                        null,  --SFRSTCR_WL_PRIORITY
                                                                                        null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                                        null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                                        null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                                        'N', --SFRSTCR_MEXC_OVER
                                                                                        sp,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                                        null,--SFRSTCR_BRDH_SEQ_NUM
                                                                                        '01',--SFRSTCR_BLCK_CODE
                                                                                        null,--SFRSTCR_STRH_SEQNO
                                                                                        null, --SFRSTCR_STRD_SEQNO
                                                                                        null,  --SFRSTCR_SURROGATE_ID
                                                                                        null, --SFRSTCR_VERSION
                                                                                        user,--SFRSTCR_USER_ID
                                                                                        no_recibo );--SFRSTCR_VPDI_CODE



                                                                Begin
                                                                     update ssbsect
                                                                            set ssbsect_enrl = ssbsect_enrl + 1
                                                                      where SSBSECT_TERM_CODE = peri
                                                                      And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                vl_error := 'Se presento un error al actualizar el enrolamiento ' ||sqlerrm;
                                                                End;

                                                                Begin
                                                                        update ssbsect
                                                                            set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                                        where SSBSECT_TERM_CODE = peri
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||sqlerrm;
                                                                End;

                                                                Begin
                                                                         update ssbsect
                                                                                set ssbsect_census_enrl=ssbsect_enrl
                                                                         Where SSBSECT_TERM_CODE = peri
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||sqlerrm;
                                                                End;


                                                                conta_ptrm:=0;

                                                                Begin
                                                                    Select count (*)
                                                                        Into conta_ptrm
                                                                    from sfrareg
                                                                    where SFRAREG_PIDM = c.pidm
                                                                    And SFRAREG_TERM_CODE = peri
                                                                    And SFRAREG_CRN = crn
                                                                    And SFRAREG_EXTENSION_NUMBER = 0
                                                                    And SFRAREG_RSTS_CODE = 'RE';
                                                                Exception
                                                                When Others then
                                                                   conta_ptrm :=0;
                                                                End;

                                                                If conta_ptrm = 0 then

                                                                     Begin
                                                                             insert into sfrareg values(c.pidm, peri, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFNVIN', sysdate, null,null,null);
                                                                     Exception
                                                                       When Others then
                                                                          vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||sqlerrm;
                                                                     End;
                                                                End if;


                                                             vl_existe :=0;

                                                                  Begin
                                                                     Select count(1)
                                                                     Into vl_existe
                                                                     from SHRINST
                                                                     Where  SHRINST_TERM_CODE = peri
                                                                     And SHRINST_CRN = crn
                                                                     And  SHRINST_PIDM = c.pidm;
                                                                  Exception
                                                                  When Others then
                                                                   vl_existe :=0;
                                                                  End;


                                                                  If vl_existe = 0 then
                                                                        Begin
                                                                            Insert into SHRINST values (peri,        --SHRINST_TERM_CODE
                                                                                                                     crn,       --SHRINST_CRN
                                                                                                                     c.pidm,       --SHRINST_PIDM
                                                                                                                     sysdate,       --SHRINST_ACTIVITY_DATE
                                                                                                                     'Y',       --SHRINST_PRIMARY_IND
                                                                                                                      null,      --SHRINST_SURROGATE_ID
                                                                                                                      null,      --SHRINST_VERSION
                                                                                                                     user,       --SHRINST_USER_ID
                                                                                                                     'SZFNVIN',       --SHRINST_DATA_ORIGIN
                                                                                                                      null);      --SHRINST_VPDI_CODE


                                                                        Exception
                                                                            When Others then
                                                                             vl_error := 'Se presento un error al insertar al alumno en SHRINST ' ||sqlerrm;
                                                                        End;

                                                                  End if;

                                                              Begin
                                                                    Update sgbstdn a
                                                                    set a.SGBSTDN_STYP_CODE ='N'
                                                                    Where a.SGBSTDN_PIDM = c.pidm
                                                                    And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                                           from sgbstdn a1
                                                                                                                           Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                                          --- And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1
                                                                                                                           )
                                                                    -- And a.SGBSTDN_PROGRAM_1 = c.prog
                                                                     ;
                                                                Exception
                                                                    When Others then
                                                                    vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                                                End;

                                                    Exception
                                                   when Others then
                                                       vl_error := 'Se presento un error al insertar al alumno en el grupo ' ||sqlerrm;
                                                   End;


                                  Exception
                                    When Others then
                                      vl_error := 'Se presento un Error al insertar el nuevo grupo 6 ' ||sqlerrm;
                                  End;

                        End if;

                    if crn is null then
                                    dbms_output.put_line('mensaje:'|| 'CRN  es Vacio');
                                vl_error := 'No se Recupero CRN';
                    End if;

                End if;  ------ No hay  CRN Creado

                if vl_error = 'EXITO' then
                    commit; --Commit;
                   -- dbms_output.put_line('mensaje:'||vl_error);
                Else
                -- dbms_output.put_line('mensaje:'||vl_error);
                   rollback;
                End if;
        Else
            null;
                -- dbms_output.put_line('mensaje:'|| 'Ya tiene materias Inscritas ');
        End if; ----> El alumno ya tiene inscrita la materia

     End loop;

Elsif  campus = 'UOC' and nivel = 'MS' then
--dbms_output.put_line('Entrada 6');

     for c in (

                    select  sorlcur_pidm pidm, spriden_id iden, sorlcur_program prog, sorlcur_term_code_ctlg ctlg , scrtext_text materia , smrarul_subj_code subj, smrarul_crse_numb_low crse,  '01' grupo,
                    null calif, sztdtec_periodicidad perio,
                   null  prof,
                     null pperiodo
                    from sorlcur a
                    join spriden b on b.spriden_pidm = a.sorlcur_pidm and b.spriden_change_ind is null
                    join  sgbstdn d on  d.sgbstdn_pidm=spriden_pidm
                    And d.SGBSTDN_TERM_CODE_EFF = (select max (b1.SGBSTDN_TERM_CODE_EFF)
                                                                           from SGBSTDN b1
                                                                           Where d.sgbstdn_pidm = b1.sgbstdn_pidm)
                    join smrpaap on smrpaap_program=sorlcur_program
                            and smrpaap_term_code_eff=sorlcur_term_code_ctlg
                    join smrarul on smrarul_area=smrpaap_area
                            and smrarul_term_code_eff=smrpaap_term_code_eff
                            and smrarul_subj_code  in (select ZSTPARA_PARAM_DESC
                                                                    from ZSTPARA
                                                                    where ZSTPARA_MAPA_ID = 'NUEVO_INGRESO'
                                                                    And ZSTPARA_PARAM_ID = d.SGBSTDN_program_1)
                            and smrarul_crse_numb_low  in (select ZSTPARA_PARAM_VALOR
                                                                    from ZSTPARA
                                                                    where ZSTPARA_MAPA_ID = 'NUEVO_INGRESO'
                                                                    And ZSTPARA_PARAM_ID = d.SGBSTDN_program_1)
                    join scrtext on scrtext_subj_code=smrarul_subj_code
                            and scrtext_crse_numb=smrarul_crse_numb_low
                            and (substr(scrtext_text,1,4)=smrarul_subj_code or substr(scrtext_text,1,3)=smrarul_subj_code
                            or substr(scrtext_text,1,2)=smrarul_subj_code)
                            And substr(smrarul_area,9,2) in ('01','02')
                    join sztdtec on sztdtec_program=sorlcur_program
                            and sztdtec_term_code=sorlcur_term_code_ctlg
                    Where  a.SORLCUR_LMOD_CODE = 'LEARNER'
                    And a.SORLCUR_CACT_CODE = 'ACTIVE'
                    And a.SORLCUR_ROLL_IND = 'Y'
                    And a.sorlcur_pidm in (select sorlcur_pidm
                                                      from sorlcur aa
                                                      where a.sorlcur_program=aa.sorlcur_program
                                                      and a.sorlcur_lmod_code=aa.sorlcur_lmod_code
                                                      and a.sorlcur_roll_ind=aa.sorlcur_roll_ind)
                    and a.SORLCUR_SEQNO = (select max (SORLCUR_SEQNO)
                                                            from SORLCUR aa1
                                                            Where a.sorlcur_pidm = aa1.sorlcur_pidm
                                                            And a.SORLCUR_LMOD_CODE = aa1.SORLCUR_LMOD_CODE
                                                            And a.SORLCUR_CACT_CODE = aa1.SORLCUR_CACT_CODE
                                                            And a.SORLCUR_KEY_SEQNO = aa1.SORLCUR_KEY_SEQNO
                                                            And a.sorlcur_program=aa1.sorlcur_program
                                                            And trunc (a.sorlcur_start_date) = fecha_ini
                                                            )
                    And a.SORLCUR_CAMP_CODE= campus
                    And a.SORLCUR_LEVL_CODE= nivel
                    And d.SGBSTDN_STYP_CODE in ('N', 'F')
                    order by   perio,materia, grupo, prog,ctlg, iden



                    ) loop



--------------- Limpia Variables  --------------------
--niv :=  null;
parte := null;
crn := null;
pidm_doc2 := null;
conta_sirasgn := null;
pidm_doc := null;
f_inicio := null;
f_fin := null;
sem := null;
schd := null;
title := null;
credit := null;
credit_bill :=null;
levl := null;
camp := null;
mate := null;
parte := null;
per := null;
grupo := null;
vl_existe :=0;

vn_lugares :=0;
vn_cupo_max :=0;
vn_cupo_act :=0;
vl_error := 'EXITO';



           ----- Busca la Parte de Periodo para el programa que inicia clases
        If c.pperiodo is null then

             Begin
                    select distinct SZTPTRM_PTRM_CODE
                        Into Parte
                    from sztptrm, sobptrm
                    where SZTPTRM_CAMP_CODE = campus
                    And SZTPTRM_LEVL_CODE = nivel
                    and SZTPTRM_TERM_CODE = peri
                    and SOBPTRM_TERM_CODE = SZTPTRM_TERM_CODE
                    AND SOBPTRM_PTRM_CODE = SZTPTRM_PTRM_CODE
                    and SZTPTRM_PROGRAM = c.prog
                    and trunc (SOBPTRM_START_DATE) = fecha_ini;

                     If Parte in ('M0C' ) THEN
                       Parte := 'M1A';
                    Elsif  Parte in ('M0A' ) THEN
                       Parte := 'M0B';
                    Elsif  Parte in ('A0A' ) THEN
                       Parte := 'A0B';
                    Elsif  Parte in ('A0C' ) THEN
                       Parte := 'A1A';
                    End if;


               Exception
                When Others then
                  parte := null;
               End;
        Else
             Parte := c.pperiodo;
        End if;


            Begin
                   select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                   into f_inicio, f_fin, sem
                   from sobptrm
                   where sobptrm_term_code=Peri
                   and     sobptrm_ptrm_code=parte;
            Exception
               When Others then
                f_inicio:= null;
                f_fin := null;
                sem :=null;
            End;


--------------------- Se valida que el alumno no tenga la materia sembrada en el horario como Activa ---------------------------------------

           begin
            --existe y es aprobatoria
                select count (1)
                    into vl_existe
                from ssbsect, sfrstcr, SHRGRDE
                where sfrstcr_pidm=c.pidm
                --and sfrstcr_term_code=c.periodo
                and ssbsect_term_code=sfrstcr_term_code
                and SFRSTCR_PTRM_CODE = SSBSECT_PTRM_CODE
                and ssbsect_crn=sfrstcr_crn
                and ssbsect_subj_code=c.subj
                and ssbsect_crse_numb=c.crse
                and SFRSTCR_RSTS_CODE = 'RE'
                AND (SFRSTCR_GRDE_CODE = SHRGRDE_CODE
                                         OR SFRSTCR_GRDE_CODE IS NULL)
                AND SHRGRDE_PASSED_IND = 'Y'
                AND SHRGRDE_LEVL_CODE= NIVEL;

           Exception
            when others then
                vl_existe:=0;
           end;



        If vl_existe = 0 then

            ---- Se busca que exista el grupo y tenga cupo

                    begin
                            select ssbsect_crn , ssbsect_seats_avail lugares, ssbsect_max_enrl cupo_max, ssbsect_enrl cupo_Act,
                                    SSBSECT_PTRM_START_DATE, SSBSECT_PTRM_END_DATE, SSBSECT_PTRM_WEEKS,
                                    SSBSECT_CREDIT_HRS, SSBSECT_BILL_HRS, SSBSECT_GMOD_CODE
                            into crn , vn_lugares, vn_cupo_max, vn_cupo_act,
                                   f_inicio, f_fin, sem,
                                   credit, credit_bill, gmod
                            from ssbsect
                            where SSBSECT_TERM_CODE= peri
                            and ssbsect_subj_code= c.subj
                            and ssbsect_crse_numb= c.crse
                            and ssbsect_ptrm_code=  parte;

                    exception when others then
                    crn:=null;
                    vn_lugares :=0;
                    vn_cupo_max:=0;
                    vn_cupo_act:=0;
                    f_inicio := null;
                    f_fin := null;
                    sem := null;
                    credit  := null;
                    credit_bill  := null;
                    gmod  := null;
                    end;

           --dbms_output.put_line('No Existe la materia:'||Parte ||' '||c.iden || c.subj ||c.crse);

                 If  c.prof is null then
                   -- dbms_output.put_line ('sin profesor '||vl_existe);
                   -- dbms_output.put_line ('crea consulta '||peri ||'*'|| c.subj  ||'*'||c.crse||'*'||c.grupo||'*'||fecha_ini);
                        begin

                                select ssbsect_crn , ssbsect_seats_avail lugares, ssbsect_max_enrl cupo_max, SSBSECT_PTRM_CODE,
                                        ssbsect_enrl cupo_Act,    SSBSECT_PTRM_START_DATE, SSBSECT_PTRM_END_DATE, SSBSECT_PTRM_WEEKS,
                                        SSBSECT_CREDIT_HRS, SSBSECT_BILL_HRS, SSBSECT_GMOD_CODE
                                into crn , vn_lugares, vn_cupo_max, parte,
                                       vn_cupo_act, f_inicio, f_fin, sem,
                                       credit, credit_bill, gmod
                                from ssbsect a
                                where a.SSBSECT_TERM_CODE= peri
                                and a.ssbsect_subj_code= c.subj
                               and a.ssbsect_crse_numb=c.crse
                               and a.SSBSECT_SEATS_AVAIL >0
                               AND a.SSBSECT_SEATS_AVAIL = (select max (a1.SSBSECT_SEATS_AVAIL)
                                                                               from ssbsect a1
                                                                                where a.SSBSECT_TERM_CODE = a1.SSBSECT_TERM_CODE
                                                                                and a.ssbsect_subj_code = a1.ssbsect_subj_code
                                                                                and a.ssbsect_crse_numb = a1.ssbsect_crse_numb
                                                                               and trunc (a.SSBSECT_PTRM_START_DATE) = trunc (a1.SSBSECT_PTRM_START_DATE))
                                and trunc (a.SSBSECT_PTRM_START_DATE) = f_inicio;

                        Exception
                        when others then
                            crn:=null;
                            vn_lugares :=0;
                            vn_cupo_max:=0;
                            vn_cupo_act:=0;
                            f_inicio := null;
                            f_fin := null;
                            sem := null;
                            credit  := null;
                            credit_bill  := null;
                            gmod  := null;
                            --  dbms_output.put_line ('error de crea consulta '||sqlerrm);
                        end;
                Else
                           -- dbms_output.put_line ('con profesor '||vl_existe);

                       begin
                               select ssbsect_crn , ssbsect_seats_avail lugares, ssbsect_max_enrl cupo_max, SSBSECT_PTRM_CODE,
                                        ssbsect_enrl cupo_Act,    SSBSECT_PTRM_START_DATE, SSBSECT_PTRM_END_DATE, SSBSECT_PTRM_WEEKS,
                                        SSBSECT_CREDIT_HRS, SSBSECT_BILL_HRS, SSBSECT_GMOD_CODE
                                into crn , vn_lugares, vn_cupo_max, parte,
                                       vn_cupo_act, f_inicio, f_fin, sem,
                                       credit, credit_bill, gmod
                                from ssbsect a, sirasgn
                                where a.SSBSECT_TERM_CODE= peri
                                and a.ssbsect_subj_code= c.subj
                               and a.ssbsect_crse_numb=c.crse
                               and a.SSBSECT_SEQ_NUMB = c.grupo
                               and a.SSBSECT_SEATS_AVAIL >0
                               AND to_number (a.ssbsect_crn) = (select max (to_number (a1.ssbsect_crn))
                                                                                from ssbsect a1
                                                                                where a.SSBSECT_TERM_CODE = a1.SSBSECT_TERM_CODE
                                                                                and a.ssbsect_subj_code = a1.ssbsect_subj_code
                                                                                and a.ssbsect_crse_numb = a1.ssbsect_crse_numb
                                                                                and a.SSBSECT_SEQ_NUMB = a1.SSBSECT_SEQ_NUMB
                                                                                and a.SSBSECT_PTRM_START_DATE = a1.SSBSECT_PTRM_START_DATE
                                                                                )
                                and trunc (a.SSBSECT_PTRM_START_DATE) = f_inicio
                               And SIRASGN_PIDM = (select distinct  spriden_pidm
                                                                    from spriden
                                                                    where spriden_id = c.prof
                                                                    And spriden_change_ind is null )
                                And SIRASGN_PRIMARY_IND = 'Y' ;
                                 --dbms_output.put_line ('crea consulta '||peri ||'*'|| c.subj  ||'*'||c.crse||'*'||c.grupo||'*'||fecha_ini);

                       Exception
                        when others then
                            crn:=null;
                            vn_lugares :=0;
                            vn_cupo_max:=0;
                            vn_cupo_act:=0;
                            f_inicio := null;
                            f_fin := null;
                            sem := null;
                            credit  := null;
                            credit_bill  := null;
                            gmod  := null;
                            --dbms_output.put_line ('error de crea consulta '||sqlerrm);
                       end;

                End if;



                If crn is not null then

                    If vn_lugares >0  then

                            If credit is null then
                               Begin
                                      select SSRMEET_CREDIT_HR_SESS
                                       Into credit
                                      from SSRMEET
                                      where SSRMEET_TERM_CODE = peri
                                      And SSRMEET_CRN = crn;
                               Exception
                                When Others then
                                   credit :=null;
                                End;

                                  If credit is not null then
                                           Begin
                                               Update ssbsect
                                               set  SSBSECT_CREDIT_HRS = credit
                                               where SSBSECT_TERM_CODE = peri
                                               and SSBSECT_CRN = crn;
                                           Exception
                                           when Others then
                                                null;
                                           End;
                                  End if;
                           End if;

                           If credit_bill is null then
                                 Begin
                                         select  SCBCRSE_BILL_HR_LOW
                                            into credit_bill
                                            from scbcrse, scrschd
                                            where scbcrse_subj_code=  c.subj
                                            and     scbcrse_crse_numb=c.crse
                                            and     scbcrse_eff_term='000000'
                                            and     scrschd_subj_code=scbcrse_subj_code
                                            and     scrschd_crse_numb=scbcrse_crse_numb
                                            and     scrschd_eff_term=scbcrse_eff_term;
                                 Exception
                                 When Others then
                                    credit_bill := 3;
                                 End;

                                  If credit is not null then
                                           Begin
                                               Update ssbsect
                                               set  SSBSECT_BILL_HRS = credit_bill
                                               where SSBSECT_TERM_CODE = peri
                                               and SSBSECT_CRN = crn;
                                           Exception
                                           when Others then
                                                null;
                                           End;
                                  End if;
                           End if;




                          If gmod is null then
                                begin
                                    select scrgmod_gmod_code
                                    into gmod
                                    from scrgmod
                                    where scrgmod_subj_code=c.subj
                                    and     scrgmod_crse_numb=c.crse
                                    and     scrgmod_default_ind='D';
                                exception when others then
                                    gmod:='1';
                                end;

                                If gmod is not null then
                                           Begin
                                               Update ssbsect
                                               set  SSBSECT_GMOD_CODE = gmod
                                               where SSBSECT_TERM_CODE = peri
                                               and SSBSECT_CRN = crn;
                                           Exception
                                           when Others then
                                                null;
                                           End;
                                end if;

                          End if;


                        conta_ptrm :=0;

                            Begin
                                 select count(*)
                                    into conta_ptrm
                                 from sfbetrm
                                 where sfbetrm_term_code=peri
                                 and     sfbetrm_pidm=c.pidm;
                            Exception
                                When Others then
                                  conta_ptrm := 0;
                            End;


                             if conta_ptrm =0 then
                                    Begin
                                            insert into sfbetrm values(peri, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFNVIN', null, 0,null,null, null,null,user,null);
                                    Exception
                                    When Others then
                                        vl_error := ('Se presento un error al insertar en la tabla sfbetrm ' || sqlerrm);
                                    End;
                             end if;



                            Begin
                                select sgbstdn_levl_code, sgbstdn_camp_code  into levl, camp
                                from sgbstdn a
                                where sgbstdn_pidm=c.pidm
                                and     sgbstdn_term_code_eff  in (select max(sgbstdn_term_code_eff) from sgbstdn aa
                                                                                   where a.sgbstdn_pidm=aa.sgbstdn_pidm);
                            Exception
                            When Others then
                               levl := null;
                               camp := null;
                               vl_error := 'Se presento un error al obtener la informacion de SGBSTDN ' || sqlerrm;
                            End;

                           Begin
                                    select distinct max(sorlcur_key_seqno)
                                        into sp
                                    from sorlcur
                                    where sorlcur_pidm=c.pidm
                                    and     sorlcur_program=c.prog
                                    and     sorlcur_lmod_code='LEARNER';
                           Exception
                           when Others then
                              sp := null;
                              vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||sqlerrm;
                           End;

                           Begin

                               insert into sfrstcr values(
                                                                peri,     --SFRSTCR_TERM_CODE
                                                                c.pidm,     --SFRSTCR_PIDM
                                                                crn,     --SFRSTCR_CRN
                                                                1,     --SFRSTCR_CLASS_SORT_KEY
                                                                1,    --SFRSTCR_REG_SEQ
                                                                parte,    --SFRSTCR_PTRM_CODE
                                                                'RE',     --SFRSTCR_RSTS_CODE
                                                                sysdate,    --SFRSTCR_RSTS_DATE
                                                                null,    --SFRSTCR_ERROR_FLAG
                                                                null,    --SFRSTCR_MESSAGE
                                                                credit_bill,    --SFRSTCR_BILL_HR
                                                                3, --SFRSTCR_WAIV_HR
                                                                credit,     --SFRSTCR_CREDIT_HR
                                                                credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                gmod,     --SFRSTCR_GMOD_CODE
                                                                null,    --SFRSTCR_GRDE_CODE
                                                                null,    --SFRSTCR_GRDE_CODE_MID
                                                                null,    --SFRSTCR_GRDE_DATE
                                                                'N',    --SFRSTCR_DUPL_OVER
                                                                'N',    --SFRSTCR_LINK_OVER
                                                                'N',    --SFRSTCR_CORQ_OVER
                                                                'N',    --SFRSTCR_PREQ_OVER
                                                                'N',     --SFRSTCR_TIME_OVER
                                                                'N',     --SFRSTCR_CAPC_OVER
                                                                'N',     --SFRSTCR_LEVL_OVER
                                                                'N',     --SFRSTCR_COLL_OVER
                                                                'N',     --SFRSTCR_MAJR_OVER
                                                                'N',     --SFRSTCR_CLAS_OVER
                                                                'N',     --SFRSTCR_APPR_OVER
                                                                'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                sysdate,      --SFRSTCR_ADD_DATE
                                                                sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                levl,     --SFRSTCR_LEVL_CODE
                                                                camp,     --SFRSTCR_CAMP_CODE
                                                                null,     --SFRSTCR_RESERVED_KEY
                                                                null,     --SFRSTCR_ATTEND_HR
                                                                'Y',     --SFRSTCR_REPT_OVER
                                                                'N' ,    --SFRSTCR_RPTH_OVER
                                                                null,    --SFRSTCR_TEST_OVER
                                                                'N',    --SFRSTCR_CAMP_OVER
                                                                user,    --SFRSTCR_USER
                                                                'N',    --SFRSTCR_DEGC_OVER
                                                                'N',    --SFRSTCR_PROG_OVER
                                                                null,    --SFRSTCR_LAST_ATTEND
                                                                null,    --SFRSTCR_GCMT_CODE
                                                                'SZFNVIN',    --SFRSTCR_DATA_ORIGIN
                                                                sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                'N',  --SFRSTCR_DEPT_OVER
                                                                'N',  --SFRSTCR_ATTS_OVER
                                                                'N', --SFRSTCR_CHRT_OVER
                                                                null, --SFRSTCR_RMSG_CDE
                                                                null,  --SFRSTCR_WL_PRIORITY
                                                                null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                'N', --SFRSTCR_MEXC_OVER
                                                                sp,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                null,--SFRSTCR_BRDH_SEQ_NUM
                                                                '01',--SFRSTCR_BLCK_CODE
                                                                null,--SFRSTCR_STRH_SEQNO
                                                                null, --SFRSTCR_STRD_SEQNO
                                                                null,  --SFRSTCR_SURROGATE_ID
                                                                null, --SFRSTCR_VERSION
                                                                user,--SFRSTCR_USER_ID
                                                                no_recibo );--SFRSTCR_VPDI_CODE



                                        Begin
                                             update ssbsect
                                                    set ssbsect_enrl = ssbsect_enrl + 1
                                              where SSBSECT_TERM_CODE = peri
                                              And SSBSECT_CRN  = crn;
                                        Exception
                                        When Others then
                                        vl_error := 'Se presento un error al actualizar el enrolamiento ' ||sqlerrm;
                                        End;

                                        Begin
                                                update ssbsect
                                                    set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                where SSBSECT_TERM_CODE = peri
                                                 And SSBSECT_CRN  = crn;
                                        Exception
                                        When Others then
                                            vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||sqlerrm;
                                        End;

                                        Begin
                                                 update ssbsect
                                                        set ssbsect_census_enrl=ssbsect_enrl
                                                 Where SSBSECT_TERM_CODE = peri
                                                 And SSBSECT_CRN  = crn;
                                        Exception
                                        When Others then
                                            vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||sqlerrm;
                                        End;


                                        conta_ptrm:=0;

                                        Begin
                                            Select count (*)
                                                Into conta_ptrm
                                            from sfrareg
                                            where SFRAREG_PIDM = c.pidm
                                            And SFRAREG_TERM_CODE = peri
                                            And SFRAREG_CRN = crn
                                            And SFRAREG_EXTENSION_NUMBER = 0
                                            And SFRAREG_RSTS_CODE = 'RE';
                                        Exception
                                        When Others then
                                           conta_ptrm :=0;
                                        End;

                                        If conta_ptrm = 0 then

                                             Begin
                                                     insert into sfrareg values(c.pidm, peri, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFNVIN', sysdate, null,null,null);
                                             Exception
                                               When Others then
                                                  vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||sqlerrm;
                                             End;
                                        End if;

                                        vl_existe :=0;

                                          Begin
                                             Select count(1)
                                             Into vl_existe
                                             from SHRINST
                                             Where  SHRINST_TERM_CODE = peri
                                             And SHRINST_CRN = crn
                                             And  SHRINST_PIDM = c.pidm;
                                          Exception
                                          When Others then
                                           vl_existe :=0;
                                          End;


                                          If vl_existe = 0 then
                                                Begin
                                                    Insert into SHRINST values (peri,        --SHRINST_TERM_CODE
                                                                                             crn,       --SHRINST_CRN
                                                                                             c.pidm,       --SHRINST_PIDM
                                                                                             sysdate,       --SHRINST_ACTIVITY_DATE
                                                                                             'Y',       --SHRINST_PRIMARY_IND
                                                                                              null,      --SHRINST_SURROGATE_ID
                                                                                              null,      --SHRINST_VERSION
                                                                                             user,       --SHRINST_USER_ID
                                                                                             'SZFNVIN',       --SHRINST_DATA_ORIGIN
                                                                                              null);      --SHRINST_VPDI_CODE


                                                Exception
                                                    When Others then
                                                     vl_error := 'Se presento un error al insertar al alumno en SHRINST ' ||sqlerrm;
                                                End;

                                          End if;



                                          Begin
                                                Update sgbstdn a
                                                set a.SGBSTDN_STYP_CODE ='N'
                                                Where a.SGBSTDN_PIDM = c.pidm
                                                And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                       from sgbstdn a1
                                                                                                       Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                      --- And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1
                                                                                                       )
                                                -- And a.SGBSTDN_PROGRAM_1 = c.prog
                                                 ;
                                            Exception
                                                When Others then
                                                vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                            End;





                            Exception
                           when Others then
                               vl_error := 'Se presento un error al insertar al alumno en el grupo ' ||sqlerrm;
                           End;

                     Else  ----------> Se realizara la creacion del grupo

                            schd := null;
                            title := null;
                            credit := null;
                            gmod :=null;
                            credit_bill := null;

                            Begin
                                select scrschd_schd_code, scbcrse_title, scbcrse_credit_hr_low, SCBCRSE_BILL_HR_LOW
                                into schd, title, credit, credit_bill
                                from scbcrse, scrschd
                                where scbcrse_subj_code=c.subj
                                and     scbcrse_crse_numb=c.crse
                                and     scbcrse_eff_term='000000'
                                and     scrschd_subj_code=scbcrse_subj_code
                                and     scrschd_crse_numb=scbcrse_crse_numb
                                and     scrschd_eff_term=scbcrse_eff_term;
                            Exception
                            When Others then
                                  schd := null;
                                  title := null;
                                  credit := null;
                            End;


                            begin
                                select scrgmod_gmod_code
                                      into gmod
                                from scrgmod
                                where scrgmod_subj_code=c.subj
                                and     scrgmod_crse_numb=c.crse
                                and     scrgmod_default_ind='D';
                            exception when others then
                                gmod:='1';
                            end;

                             Begin
                                    select nvl(max(ssbsect_crn),1000)+1
                                         into crn
                                    from ssbsect where ssbsect_term_code= peri;
                              Exception
                                    When Others then
                                       crn := null;
                             End;

                             If crn is not null then

                               Begin
                                   select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                                   into f_inicio, f_fin, sem
                                   from sobptrm
                                   where sobptrm_term_code=Peri
                                   and     sobptrm_ptrm_code=parte;
                               Exception
                               When Others then
                                f_inicio:= null;
                                f_fin := null;
                                sem :=null;
                               End;



                                  Begin
                                        Insert into ssbsect values (
                                                                           Peri,     --SSBSECT_TERM_CODE
                                                                           crn,     --SSBSECT_CRN
                                                                           parte,     --SSBSECT_PTRM_CODE
                                                                           c.subj,     --SSBSECT_SUBJ_CODE
                                                                           c.crse,     --SSBSECT_CRSE_NUMB
                                                                            '01',     --SSBSECT_SEQ_NUMB
                                                                            'A',    --SSBSECT_SSTS_CODE
                                                                            schd,    --SSBSECT_SCHD_CODE
                                                                            campus,    --SSBSECT_CAMP_CODE
                                                                             title,   --SSBSECT_CRSE_TITLE
                                                                             credit,   --SSBSECT_CREDIT_HRS
                                                                             credit_bill,   --SSBSECT_BILL_HRS
                                                                             gmod,   --SSBSECT_GMOD_CODE
                                                                              null,  --SSBSECT_SAPR_CODE
                                                                              null, --SSBSECT_SESS_CODE
                                                                              null,  --SSBSECT_LINK_IDENT
                                                                              null,  --SSBSECT_PRNT_IND
                                                                              'Y',  --SSBSECT_GRADABLE_IND
                                                                               null,  --SSBSECT_TUIW_IND
                                                                               0, --SSBSECT_REG_ONEUP
                                                                               0, --SSBSECT_PRIOR_ENRL
                                                                               0, --SSBSECT_PROJ_ENRL
                                                                               50, --SSBSECT_MAX_ENRL
                                                                                0,--SSBSECT_ENRL
                                                                                50,--SSBSECT_SEATS_AVAIL
                                                                                null,--SSBSECT_TOT_CREDIT_HRS
                                                                                '0',--SSBSECT_CENSUS_ENRL
                                                                                f_inicio,--SSBSECT_CENSUS_ENRL_DATE
                                                                                sysdate,--SSBSECT_ACTIVITY_DATE
                                                                                f_inicio,--SSBSECT_PTRM_START_DATE
                                                                                f_fin,--SSBSECT_PTRM_END_DATE
                                                                                sem,--SSBSECT_PTRM_WEEKS
                                                                                null,--SSBSECT_RESERVED_IND
                                                                                null, --SSBSECT_WAIT_CAPACITY
                                                                                null,--SSBSECT_WAIT_COUNT
                                                                                null,--SSBSECT_WAIT_AVAIL
                                                                                null,--SSBSECT_LEC_HR
                                                                                null,--SSBSECT_LAB_HR
                                                                                null,--SSBSECT_OTH_HR
                                                                                null,--SSBSECT_CONT_HR
                                                                                null,--SSBSECT_ACCT_CODE
                                                                                null,--SSBSECT_ACCL_CODE
                                                                                null,--SSBSECT_CENSUS_2_DATE
                                                                                null,--SSBSECT_ENRL_CUT_OFF_DATE
                                                                                null,--SSBSECT_ACAD_CUT_OFF_DATE
                                                                                null,--SSBSECT_DROP_CUT_OFF_DATE
                                                                                null,--SSBSECT_CENSUS_2_ENRL
                                                                                'Y',--SSBSECT_VOICE_AVAIL
                                                                                'N',--SSBSECT_CAPP_PREREQ_TEST_IND
                                                                                null,--SSBSECT_GSCH_NAME
                                                                                null,--SSBSECT_BEST_OF_COMP
                                                                                null,--SSBSECT_SUBSET_OF_COMP
                                                                                'NOP',--SSBSECT_INSM_CODE
                                                                                null,--SSBSECT_REG_FROM_DATE
                                                                                null,--SSBSECT_REG_TO_DATE
                                                                                null,--SSBSECT_LEARNER_REGSTART_FDATE
                                                                                null,--SSBSECT_LEARNER_REGSTART_TDATE
                                                                                null,--SSBSECT_DUNT_CODE
                                                                                null,--SSBSECT_NUMBER_OF_UNITS
                                                                                0,--SSBSECT_NUMBER_OF_EXTENSIONS
                                                                                'SZFNVIN',--SSBSECT_DATA_ORIGIN
                                                                                user,--SSBSECT_USER_ID
                                                                                'MOOD',--SSBSECT_INTG_CDE
                                                                                'B',--SSBSECT_PREREQ_CHK_METHOD_CDE
                                                                                user,--SSBSECT_KEYWORD_INDEX_ID
                                                                                null,--SSBSECT_SCORE_OPEN_DATE
                                                                                null,--SSBSECT_SCORE_CUTOFF_DATE
                                                                                null,--SSBSECT_REAS_SCORE_OPEN_DATE
                                                                                null,--SSBSECT_REAS_SCORE_CTOF_DATE
                                                                                null,--SSBSECT_SURROGATE_ID
                                                                                null,--SSBSECT_VERSION
                                                                                 null);--SSBSECT_VPDI_CODE

                                                   Begin
                                                        insert into ssrmeet values(peri, crn, null,null,null,null,null,null, sysdate, f_inicio, f_fin, '01', null,null,null,null,null,null,null, 'ENL', null, credit, null, 0, null,null,null, 'CLVI', 'SZFNVIN', user, null,null,null);
                                                    Exception
                                                    when Others then
                                                       vl_error := 'Se presento un Error al insertar en ssrmeet ' ||sqlerrm;
                                                   End;

                                                 pidm_prof := null;

--                                                  If  c.prof is null then
--                                                       c.prof :=  '019814933';
--                                                  End if;

                                                    begin
                                                    select spriden_pidm into pidm_prof
                                                    from  spriden
                                                    where   spriden_id=c.prof and spriden_change_ind is null;
                                                    exception when others then
                                                    pidm_prof:=null;
                                                    end;

                                                    if pidm_prof is not null then
                                                        Begin
                                                                insert into sirasgn values(ciclo, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,  sysdate, null,null,null,null, 'SZFNVIN', user, null, null, null, null,  null,null);
                                                        Exception
                                                        When Others then
                                                        null;
                                                        End;
                                                    end if;


                                                conta_ptrm :=0;

                                                    Begin
                                                         select count(*)
                                                            into conta_ptrm
                                                         from sfbetrm
                                                         where sfbetrm_term_code=peri
                                                         and     sfbetrm_pidm=c.pidm;
                                                    Exception
                                                        When Others then
                                                          conta_ptrm := 0;
                                                    End;


                                                     if conta_ptrm =0 then
                                                            Begin
                                                                    insert into sfbetrm values(peri, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFNVIN', null, 0,null,null, null,null,user,null);
                                                            Exception
                                                            When Others then
                                                                vl_error := ('Se presento un error al insertar en la tabla sfbetrm ' || sqlerrm);
                                                            End;
                                                     end if;



                                                    Begin
                                                        select sgbstdn_levl_code, sgbstdn_camp_code  into levl, camp
                                                        from sgbstdn a
                                                        where sgbstdn_pidm=c.pidm
                                                        and     sgbstdn_term_code_eff  in (select max(sgbstdn_term_code_eff) from sgbstdn aa
                                                                                                           where a.sgbstdn_pidm=aa.sgbstdn_pidm);
                                                    Exception
                                                    When Others then
                                                       levl := null;
                                                       camp := null;
                                                       vl_error := 'Se presento un error al obtener la informacion de SGBSTDN ' || sqlerrm;
                                                    End;

                                                   Begin
                                                            select distinct max(sorlcur_key_seqno)
                                                                into sp
                                                            from sorlcur
                                                            where sorlcur_pidm=c.pidm
                                                            and     sorlcur_program=c.prog
                                                            and     sorlcur_lmod_code='LEARNER';
                                                   Exception
                                                   when Others then
                                                      sp := null;
                                                      vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||sqlerrm;
                                                   End;

                                                   Begin

                                                       insert into sfrstcr values(
                                                                                        peri,     --SFRSTCR_TERM_CODE
                                                                                        c.pidm,     --SFRSTCR_PIDM
                                                                                        crn,     --SFRSTCR_CRN
                                                                                        1,     --SFRSTCR_CLASS_SORT_KEY
                                                                                        1,    --SFRSTCR_REG_SEQ
                                                                                        parte,    --SFRSTCR_PTRM_CODE
                                                                                        'RE',     --SFRSTCR_RSTS_CODE
                                                                                        sysdate,    --SFRSTCR_RSTS_DATE
                                                                                        null,    --SFRSTCR_ERROR_FLAG
                                                                                        null,    --SFRSTCR_MESSAGE
                                                                                        credit_bill,    --SFRSTCR_BILL_HR
                                                                                        3, --SFRSTCR_WAIV_HR
                                                                                        credit,     --SFRSTCR_CREDIT_HR
                                                                                        credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                                        credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                                        gmod,     --SFRSTCR_GMOD_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE_MID
                                                                                        null,    --SFRSTCR_GRDE_DATE
                                                                                        'N',    --SFRSTCR_DUPL_OVER
                                                                                        'N',    --SFRSTCR_LINK_OVER
                                                                                        'N',    --SFRSTCR_CORQ_OVER
                                                                                        'N',    --SFRSTCR_PREQ_OVER
                                                                                        'N',     --SFRSTCR_TIME_OVER
                                                                                        'N',     --SFRSTCR_CAPC_OVER
                                                                                        'N',     --SFRSTCR_LEVL_OVER
                                                                                        'N',     --SFRSTCR_COLL_OVER
                                                                                        'N',     --SFRSTCR_MAJR_OVER
                                                                                        'N',     --SFRSTCR_CLAS_OVER
                                                                                        'N',     --SFRSTCR_APPR_OVER
                                                                                        'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                                        sysdate,      --SFRSTCR_ADD_DATE
                                                                                        sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                                        levl,     --SFRSTCR_LEVL_CODE
                                                                                        camp,     --SFRSTCR_CAMP_CODE
                                                                                        null,     --SFRSTCR_RESERVED_KEY
                                                                                        null,     --SFRSTCR_ATTEND_HR
                                                                                        'Y',     --SFRSTCR_REPT_OVER
                                                                                        'N' ,    --SFRSTCR_RPTH_OVER
                                                                                        null,    --SFRSTCR_TEST_OVER
                                                                                        'N',    --SFRSTCR_CAMP_OVER
                                                                                        user,    --SFRSTCR_USER
                                                                                        'N',    --SFRSTCR_DEGC_OVER
                                                                                        'N',    --SFRSTCR_PROG_OVER
                                                                                        null,    --SFRSTCR_LAST_ATTEND
                                                                                        null,    --SFRSTCR_GCMT_CODE
                                                                                        'SZFNVIN',    --SFRSTCR_DATA_ORIGIN
                                                                                        sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                                        'N',  --SFRSTCR_DEPT_OVER
                                                                                        'N',  --SFRSTCR_ATTS_OVER
                                                                                        'N', --SFRSTCR_CHRT_OVER
                                                                                        null, --SFRSTCR_RMSG_CDE
                                                                                        null,  --SFRSTCR_WL_PRIORITY
                                                                                        null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                                        null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                                        null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                                        'N', --SFRSTCR_MEXC_OVER
                                                                                        sp,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                                        null,--SFRSTCR_BRDH_SEQ_NUM
                                                                                        '01',--SFRSTCR_BLCK_CODE
                                                                                        null,--SFRSTCR_STRH_SEQNO
                                                                                        null, --SFRSTCR_STRD_SEQNO
                                                                                        null,  --SFRSTCR_SURROGATE_ID
                                                                                        null, --SFRSTCR_VERSION
                                                                                        user,--SFRSTCR_USER_ID
                                                                                        no_recibo );--SFRSTCR_VPDI_CODE



                                                                Begin
                                                                     update ssbsect
                                                                            set ssbsect_enrl = ssbsect_enrl + 1
                                                                      where SSBSECT_TERM_CODE = peri
                                                                      And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                vl_error := 'Se presento un error al actualizar el enrolamiento ' ||sqlerrm;
                                                                End;

                                                                Begin
                                                                        update ssbsect
                                                                            set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                                        where SSBSECT_TERM_CODE = peri
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||sqlerrm;
                                                                End;

                                                                Begin
                                                                         update ssbsect
                                                                                set ssbsect_census_enrl=ssbsect_enrl
                                                                         Where SSBSECT_TERM_CODE = peri
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||sqlerrm;
                                                                End;


                                                                conta_ptrm:=0;

                                                                Begin
                                                                    Select count (*)
                                                                        Into conta_ptrm
                                                                    from sfrareg
                                                                    where SFRAREG_PIDM = c.pidm
                                                                    And SFRAREG_TERM_CODE = peri
                                                                    And SFRAREG_CRN = crn
                                                                    And SFRAREG_EXTENSION_NUMBER = 0
                                                                    And SFRAREG_RSTS_CODE = 'RE';
                                                                Exception
                                                                When Others then
                                                                   conta_ptrm :=0;
                                                                End;

                                                                If conta_ptrm = 0 then

                                                                     Begin
                                                                             insert into sfrareg values(c.pidm, peri, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFNVIN', sysdate, null,null,null);
                                                                     Exception
                                                                       When Others then
                                                                          vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||sqlerrm;
                                                                     End;
                                                                End if;

                                                                 vl_existe :=0;

                                                                      Begin
                                                                         Select count(1)
                                                                         Into vl_existe
                                                                         from SHRINST
                                                                         Where  SHRINST_TERM_CODE = peri
                                                                         And SHRINST_CRN = crn
                                                                         And  SHRINST_PIDM = c.pidm;
                                                                      Exception
                                                                      When Others then
                                                                       vl_existe :=0;
                                                                      End;


                                                                      If vl_existe = 0 then
                                                                            Begin
                                                                                Insert into SHRINST values (peri,        --SHRINST_TERM_CODE
                                                                                                                         crn,       --SHRINST_CRN
                                                                                                                         c.pidm,       --SHRINST_PIDM
                                                                                                                         sysdate,       --SHRINST_ACTIVITY_DATE
                                                                                                                         'Y',       --SHRINST_PRIMARY_IND
                                                                                                                          null,      --SHRINST_SURROGATE_ID
                                                                                                                          null,      --SHRINST_VERSION
                                                                                                                         user,       --SHRINST_USER_ID
                                                                                                                         'SZFNVIN',       --SHRINST_DATA_ORIGIN
                                                                                                                          null);      --SHRINST_VPDI_CODE


                                                                            Exception
                                                                                When Others then
                                                                                 vl_error := 'Se presento un error al insertar al alumno en SHRINST ' ||sqlerrm;
                                                                            End;

                                                                      End if;



                                                              Begin
                                                                    Update sgbstdn a
                                                                    set a.SGBSTDN_STYP_CODE ='N'
                                                                    Where a.SGBSTDN_PIDM = c.pidm
                                                                    And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                                           from sgbstdn a1
                                                                                                                           Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                                          --- And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1
                                                                                                                           )
                                                                    -- And a.SGBSTDN_PROGRAM_1 = c.prog
                                                                     ;
                                                                Exception
                                                                    When Others then
                                                                    vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                                                End;


                                                    Exception
                                                   when Others then
                                                       vl_error := 'Se presento un error al insertar al alumno en el grupo ' ||sqlerrm;
                                                   End;


                                  Exception
                                    When Others then
                                      vl_error := 'Se presento un Error al insertar el nuevo grupo 5 ' ||sqlerrm;
                                  End;
                             End if;

                    -- dbms_output.put_line('mensaje:'|| 'No hay grupo cupo');
                     End if;
                Else
                   -- dbms_output.put_line('mensaje:'|| 'No hay grupo creado');
                            schd := null;
                            title := null;
                            credit := null;
                            gmod :=null;
                            credit_bill := null;

                            Begin
                                select scrschd_schd_code, scbcrse_title, scbcrse_credit_hr_low, SCBCRSE_BILL_HR_LOW
                                into schd, title, credit, credit_bill
                                from scbcrse, scrschd
                                where scbcrse_subj_code=c.subj
                                and     scbcrse_crse_numb=c.crse
                                and     scbcrse_eff_term='000000'
                                and     scrschd_subj_code=scbcrse_subj_code
                                and     scrschd_crse_numb=scbcrse_crse_numb
                                and     scrschd_eff_term=scbcrse_eff_term;
                            Exception
                            When Others then
                                  schd := null;
                                  title := null;
                                  credit := null;
                                  credit_bill := null;
                            End;


                            begin
                                select scrgmod_gmod_code
                                      into gmod
                                from scrgmod
                                where scrgmod_subj_code=c.subj
                                and     scrgmod_crse_numb=c.crse
                                and     scrgmod_default_ind='D';
                            exception when others then
                                gmod:='1';
                            end;

                             Begin
                                    select nvl(max(ssbsect_crn),1000)+1
                                         into crn
                                    from ssbsect where ssbsect_term_code= peri;
                              Exception
                                    When Others then
                                       crn := null;
                             End;

                        If crn is not null then

                                Begin
                                   select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                                   into f_inicio, f_fin, sem
                                   from sobptrm
                                   where sobptrm_term_code=Peri
                                   and     sobptrm_ptrm_code=parte;
                                Exception
                                When Others then
                                    f_inicio:= null;
                                    f_fin := null;
                                    sem :=null;
                                End;

                                  Begin
                                        Insert into ssbsect values (
                                                                           Peri,     --SSBSECT_TERM_CODE
                                                                           crn,     --SSBSECT_CRN
                                                                           parte,     --SSBSECT_PTRM_CODE
                                                                           c.subj,     --SSBSECT_SUBJ_CODE
                                                                           c.crse,     --SSBSECT_CRSE_NUMB
                                                                            '01',     --SSBSECT_SEQ_NUMB
                                                                            'A',    --SSBSECT_SSTS_CODE
                                                                            schd,    --SSBSECT_SCHD_CODE
                                                                            campus,    --SSBSECT_CAMP_CODE
                                                                             title,   --SSBSECT_CRSE_TITLE
                                                                             credit,   --SSBSECT_CREDIT_HRS
                                                                             credit_bill,   --SSBSECT_BILL_HRS
                                                                             gmod,   --SSBSECT_GMOD_CODE
                                                                              null,  --SSBSECT_SAPR_CODE
                                                                              null, --SSBSECT_SESS_CODE
                                                                              null,  --SSBSECT_LINK_IDENT
                                                                              null,  --SSBSECT_PRNT_IND
                                                                              'Y',  --SSBSECT_GRADABLE_IND
                                                                               null,  --SSBSECT_TUIW_IND
                                                                               0, --SSBSECT_REG_ONEUP
                                                                               0, --SSBSECT_PRIOR_ENRL
                                                                               0, --SSBSECT_PROJ_ENRL
                                                                               50, --SSBSECT_MAX_ENRL
                                                                                0,--SSBSECT_ENRL
                                                                                50,--SSBSECT_SEATS_AVAIL
                                                                                null,--SSBSECT_TOT_CREDIT_HRS
                                                                                '0',--SSBSECT_CENSUS_ENRL
                                                                                f_inicio,--SSBSECT_CENSUS_ENRL_DATE
                                                                                sysdate,--SSBSECT_ACTIVITY_DATE
                                                                                f_inicio,--SSBSECT_PTRM_START_DATE
                                                                                f_fin,--SSBSECT_PTRM_END_DATE
                                                                                sem,--SSBSECT_PTRM_WEEKS
                                                                                null,--SSBSECT_RESERVED_IND
                                                                                null, --SSBSECT_WAIT_CAPACITY
                                                                                null,--SSBSECT_WAIT_COUNT
                                                                                null,--SSBSECT_WAIT_AVAIL
                                                                                null,--SSBSECT_LEC_HR
                                                                                null,--SSBSECT_LAB_HR
                                                                                null,--SSBSECT_OTH_HR
                                                                                null,--SSBSECT_CONT_HR
                                                                                null,--SSBSECT_ACCT_CODE
                                                                                null,--SSBSECT_ACCL_CODE
                                                                                null,--SSBSECT_CENSUS_2_DATE
                                                                                null,--SSBSECT_ENRL_CUT_OFF_DATE
                                                                                null,--SSBSECT_ACAD_CUT_OFF_DATE
                                                                                null,--SSBSECT_DROP_CUT_OFF_DATE
                                                                                null,--SSBSECT_CENSUS_2_ENRL
                                                                                'Y',--SSBSECT_VOICE_AVAIL
                                                                                'N',--SSBSECT_CAPP_PREREQ_TEST_IND
                                                                                null,--SSBSECT_GSCH_NAME
                                                                                null,--SSBSECT_BEST_OF_COMP
                                                                                null,--SSBSECT_SUBSET_OF_COMP
                                                                                'NOP',--SSBSECT_INSM_CODE
                                                                                null,--SSBSECT_REG_FROM_DATE
                                                                                null,--SSBSECT_REG_TO_DATE
                                                                                null,--SSBSECT_LEARNER_REGSTART_FDATE
                                                                                null,--SSBSECT_LEARNER_REGSTART_TDATE
                                                                                null,--SSBSECT_DUNT_CODE
                                                                                null,--SSBSECT_NUMBER_OF_UNITS
                                                                                0,--SSBSECT_NUMBER_OF_EXTENSIONS
                                                                                'SZFNVIN',--SSBSECT_DATA_ORIGIN
                                                                                user,--SSBSECT_USER_ID
                                                                                'MOOD',--SSBSECT_INTG_CDE
                                                                                'B',--SSBSECT_PREREQ_CHK_METHOD_CDE
                                                                                user,--SSBSECT_KEYWORD_INDEX_ID
                                                                                null,--SSBSECT_SCORE_OPEN_DATE
                                                                                null,--SSBSECT_SCORE_CUTOFF_DATE
                                                                                null,--SSBSECT_REAS_SCORE_OPEN_DATE
                                                                                null,--SSBSECT_REAS_SCORE_CTOF_DATE
                                                                                null,--SSBSECT_SURROGATE_ID
                                                                                null,--SSBSECT_VERSION
                                                                                 null);--SSBSECT_VPDI_CODE

                                                   Begin
                                                        insert into ssrmeet values(peri, crn, null,null,null,null,null,null, sysdate, f_inicio, f_fin, '01', null,null,null,null,null,null,null, 'ENL', null, credit, null, 0, null,null,null, 'CLVI', 'SZFNVIN', user, null,null,null);
                                                    Exception
                                                    when Others then
                                                       vl_error := 'Se presento un Error al insertar en ssrmeet ' ||sqlerrm;
                                                   End;

                                                  pidm_prof := null;

--                                                  If  c.prof is null then
--                                                       c.prof :=  '019814933';
--                                                  End if;


                                                    begin
                                                        select spriden_pidm into pidm_prof
                                                        from  spriden
                                                        where   spriden_id=c.prof and spriden_change_ind is null;
                                                    Exception when others then
                                                      pidm_prof:=null;
                                                    End;

                                                    if pidm_prof is not null then
                                                        Begin
                                                                insert into sirasgn values(ciclo, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,  sysdate, null,null,null,null, 'SZFNVIN', user, null, null, null, null,  null,null);
                                                        Exception
                                                        When Others then
                                                        null;
                                                        End;
                                                    end if;


                                                conta_ptrm :=0;

                                                    Begin
                                                         select count(*)
                                                            into conta_ptrm
                                                         from sfbetrm
                                                         where sfbetrm_term_code=peri
                                                         and     sfbetrm_pidm=c.pidm;
                                                    Exception
                                                        When Others then
                                                          conta_ptrm := 0;
                                                    End;


                                                     if conta_ptrm =0 then
                                                            Begin
                                                                    insert into sfbetrm values(peri, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFNVIN', null, 0,null,null, null,null,user,null);
                                                            Exception
                                                            When Others then
                                                                vl_error := ('Se presento un error al insertar en la tabla sfbetrm ' || sqlerrm);
                                                            End;
                                                     end if;



                                                    Begin
                                                        select sgbstdn_levl_code, sgbstdn_camp_code  into levl, camp
                                                        from sgbstdn a
                                                        where sgbstdn_pidm=c.pidm
                                                        and     sgbstdn_term_code_eff  in (select max(sgbstdn_term_code_eff) from sgbstdn aa
                                                                                                           where a.sgbstdn_pidm=aa.sgbstdn_pidm);
                                                    Exception
                                                    When Others then
                                                       levl := null;
                                                       camp := null;
                                                       vl_error := 'Se presento un error al obtener la informacion de SGBSTDN ' || sqlerrm;
                                                    End;

                                                   Begin
                                                            select distinct max(sorlcur_key_seqno)
                                                                into sp
                                                            from sorlcur
                                                            where sorlcur_pidm=c.pidm
                                                            and     sorlcur_program=c.prog
                                                            and     sorlcur_lmod_code='LEARNER';
                                                   Exception
                                                   when Others then
                                                      sp := null;
                                                      vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||sqlerrm;
                                                   End;

                                                   Begin

                                                       insert into sfrstcr values(
                                                                                        peri,     --SFRSTCR_TERM_CODE
                                                                                        c.pidm,     --SFRSTCR_PIDM
                                                                                        crn,     --SFRSTCR_CRN
                                                                                        1,     --SFRSTCR_CLASS_SORT_KEY
                                                                                        1,    --SFRSTCR_REG_SEQ
                                                                                        parte,    --SFRSTCR_PTRM_CODE
                                                                                        'RE',     --SFRSTCR_RSTS_CODE
                                                                                        sysdate,    --SFRSTCR_RSTS_DATE
                                                                                        null,    --SFRSTCR_ERROR_FLAG
                                                                                        null,    --SFRSTCR_MESSAGE
                                                                                        credit_bill,    --SFRSTCR_BILL_HR
                                                                                        3, --SFRSTCR_WAIV_HR
                                                                                        credit,     --SFRSTCR_CREDIT_HR
                                                                                        credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                                        credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                                        gmod,     --SFRSTCR_GMOD_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE_MID
                                                                                        null,    --SFRSTCR_GRDE_DATE
                                                                                        'N',    --SFRSTCR_DUPL_OVER
                                                                                        'N',    --SFRSTCR_LINK_OVER
                                                                                        'N',    --SFRSTCR_CORQ_OVER
                                                                                        'N',    --SFRSTCR_PREQ_OVER
                                                                                        'N',     --SFRSTCR_TIME_OVER
                                                                                        'N',     --SFRSTCR_CAPC_OVER
                                                                                        'N',     --SFRSTCR_LEVL_OVER
                                                                                        'N',     --SFRSTCR_COLL_OVER
                                                                                        'N',     --SFRSTCR_MAJR_OVER
                                                                                        'N',     --SFRSTCR_CLAS_OVER
                                                                                        'N',     --SFRSTCR_APPR_OVER
                                                                                        'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                                        sysdate,      --SFRSTCR_ADD_DATE
                                                                                        sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                                        levl,     --SFRSTCR_LEVL_CODE
                                                                                        camp,     --SFRSTCR_CAMP_CODE
                                                                                        null,     --SFRSTCR_RESERVED_KEY
                                                                                        null,     --SFRSTCR_ATTEND_HR
                                                                                        'Y',     --SFRSTCR_REPT_OVER
                                                                                        'N' ,    --SFRSTCR_RPTH_OVER
                                                                                        null,    --SFRSTCR_TEST_OVER
                                                                                        'N',    --SFRSTCR_CAMP_OVER
                                                                                        user,    --SFRSTCR_USER
                                                                                        'N',    --SFRSTCR_DEGC_OVER
                                                                                        'N',    --SFRSTCR_PROG_OVER
                                                                                        null,    --SFRSTCR_LAST_ATTEND
                                                                                        null,    --SFRSTCR_GCMT_CODE
                                                                                        'SZFNVIN',    --SFRSTCR_DATA_ORIGIN
                                                                                        sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                                        'N',  --SFRSTCR_DEPT_OVER
                                                                                        'N',  --SFRSTCR_ATTS_OVER
                                                                                        'N', --SFRSTCR_CHRT_OVER
                                                                                        null, --SFRSTCR_RMSG_CDE
                                                                                        null,  --SFRSTCR_WL_PRIORITY
                                                                                        null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                                        null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                                        null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                                        'N', --SFRSTCR_MEXC_OVER
                                                                                        sp,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                                        null,--SFRSTCR_BRDH_SEQ_NUM
                                                                                        '01',--SFRSTCR_BLCK_CODE
                                                                                        null,--SFRSTCR_STRH_SEQNO
                                                                                        null, --SFRSTCR_STRD_SEQNO
                                                                                        null,  --SFRSTCR_SURROGATE_ID
                                                                                        null, --SFRSTCR_VERSION
                                                                                        user,--SFRSTCR_USER_ID
                                                                                        no_recibo );--SFRSTCR_VPDI_CODE



                                                                Begin
                                                                     update ssbsect
                                                                            set ssbsect_enrl = ssbsect_enrl + 1
                                                                      where SSBSECT_TERM_CODE = peri
                                                                      And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                vl_error := 'Se presento un error al actualizar el enrolamiento ' ||sqlerrm;
                                                                End;

                                                                Begin
                                                                        update ssbsect
                                                                            set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                                        where SSBSECT_TERM_CODE = peri
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||sqlerrm;
                                                                End;

                                                                Begin
                                                                         update ssbsect
                                                                                set ssbsect_census_enrl=ssbsect_enrl
                                                                         Where SSBSECT_TERM_CODE = peri
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||sqlerrm;
                                                                End;


                                                                conta_ptrm:=0;

                                                                Begin
                                                                    Select count (*)
                                                                        Into conta_ptrm
                                                                    from sfrareg
                                                                    where SFRAREG_PIDM = c.pidm
                                                                    And SFRAREG_TERM_CODE = peri
                                                                    And SFRAREG_CRN = crn
                                                                    And SFRAREG_EXTENSION_NUMBER = 0
                                                                    And SFRAREG_RSTS_CODE = 'RE';
                                                                Exception
                                                                When Others then
                                                                   conta_ptrm :=0;
                                                                End;

                                                                If conta_ptrm = 0 then

                                                                     Begin
                                                                             insert into sfrareg values(c.pidm, peri, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFNVIN', sysdate, null,null,null);
                                                                     Exception
                                                                       When Others then
                                                                          vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||sqlerrm;
                                                                     End;
                                                                End if;

                                                                 vl_existe :=0;

                                                                  Begin
                                                                     Select count(1)
                                                                     Into vl_existe
                                                                     from SHRINST
                                                                     Where  SHRINST_TERM_CODE = peri
                                                                     And SHRINST_CRN = crn
                                                                     And  SHRINST_PIDM = c.pidm;
                                                                  Exception
                                                                  When Others then
                                                                   vl_existe :=0;
                                                                  End;


                                                                  If vl_existe = 0 then
                                                                        Begin
                                                                            Insert into SHRINST values (peri,        --SHRINST_TERM_CODE
                                                                                                                     crn,       --SHRINST_CRN
                                                                                                                     c.pidm,       --SHRINST_PIDM
                                                                                                                     sysdate,       --SHRINST_ACTIVITY_DATE
                                                                                                                     'Y',       --SHRINST_PRIMARY_IND
                                                                                                                      null,      --SHRINST_SURROGATE_ID
                                                                                                                      null,      --SHRINST_VERSION
                                                                                                                     user,       --SHRINST_USER_ID
                                                                                                                     'SZFNVIN',       --SHRINST_DATA_ORIGIN
                                                                                                                      null);      --SHRINST_VPDI_CODE


                                                                        Exception
                                                                            When Others then
                                                                             vl_error := 'Se presento un error al insertar al alumno en SHRINST ' ||sqlerrm;
                                                                        End;

                                                                  End if;


                                                              Begin
                                                                    Update sgbstdn a
                                                                    set a.SGBSTDN_STYP_CODE ='N'
                                                                    Where a.SGBSTDN_PIDM = c.pidm
                                                                    And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                                           from sgbstdn a1
                                                                                                                           Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                                          --- And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1
                                                                                                                           )
                                                                    -- And a.SGBSTDN_PROGRAM_1 = c.prog
                                                                     ;
                                                                Exception
                                                                    When Others then
                                                                    vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                                                End;


                                                    Exception
                                                   when Others then
                                                       vl_error := 'Se presento un error al insertar al alumno en el grupo ' ||sqlerrm;
                                                   End;


                                  Exception
                                    When Others then
                                      vl_error := 'Se presento un Error al insertar el nuevo grupo 6 ' ||sqlerrm;
                                  End;

                        End if;

                End if;  ------ No hay  CRN Creado

                if vl_error = 'EXITO' then
                    commit; --Commit;
                   -- dbms_output.put_line('mensaje:'||vl_error);
                Else
                -- dbms_output.put_line('mensaje:'||vl_error);
                   rollback;
                End if;
        Else
                -- dbms_output.put_line('mensaje:'|| 'Ya tiene materias Inscritas ');
            null;
        End if; ----> El alumno ya tiene inscrita la materia


    End loop;

Elsif  campus = 'UTS' and nivel = 'EC' then
  --dbms_output.put_line('Entrada 7');

     for c in (

                    select  sorlcur_pidm pidm, spriden_id iden, sorlcur_program prog, sorlcur_term_code_ctlg ctlg , scrtext_text materia , smrarul_subj_code subj, smrarul_crse_numb_low crse,  '01' grupo,
                    null calif, sztdtec_periodicidad perio, smrarul_area area,
                   null  prof,
                      null pperiodo
                    from sorlcur a
                    join spriden b on b.spriden_pidm = a.sorlcur_pidm and b.spriden_change_ind is null
                    join  sgbstdn d on  d.sgbstdn_pidm=spriden_pidm
                    And d.SGBSTDN_TERM_CODE_EFF = (select max (b1.SGBSTDN_TERM_CODE_EFF)
                                                                           from SGBSTDN b1
                                                                           Where d.sgbstdn_pidm = b1.sgbstdn_pidm)
                    join smrpaap on smrpaap_program=sorlcur_program
                            and smrpaap_term_code_eff=sorlcur_term_code_ctlg
                    join smrarul on smrarul_area=smrpaap_area
                            and smrarul_term_code_eff=smrpaap_term_code_eff
                    join scrtext on scrtext_subj_code=smrarul_subj_code
                            and scrtext_crse_numb=smrarul_crse_numb_low
                            and (substr(scrtext_text,1,4)=smrarul_subj_code or substr(scrtext_text,1,3)=smrarul_subj_code
                            or substr(scrtext_text,1,2)=smrarul_subj_code)
                            And substr(smrarul_area,9,2) in ('01','02')
                    join sztdtec on sztdtec_program=sorlcur_program
                            and sztdtec_term_code=sorlcur_term_code_ctlg
                    Where  a.SORLCUR_LMOD_CODE = 'LEARNER'
                    And a.SORLCUR_CACT_CODE = 'ACTIVE'
                    And a.SORLCUR_ROLL_IND = 'Y'
                    And a.sorlcur_pidm in (select sorlcur_pidm
                                                      from sorlcur aa
                                                      where a.sorlcur_program=aa.sorlcur_program
                                                      and a.sorlcur_lmod_code=aa.sorlcur_lmod_code
                                                      and a.sorlcur_roll_ind=aa.sorlcur_roll_ind)
                    and a.SORLCUR_SEQNO = (select max (SORLCUR_SEQNO)
                                                            from SORLCUR aa1
                                                            Where a.sorlcur_pidm = aa1.sorlcur_pidm
                                                            And a.SORLCUR_LMOD_CODE = aa1.SORLCUR_LMOD_CODE
                                                            And a.SORLCUR_CACT_CODE = aa1.SORLCUR_CACT_CODE
                                                            And a.SORLCUR_KEY_SEQNO = aa1.SORLCUR_KEY_SEQNO
                                                            And a.sorlcur_program=aa1.sorlcur_program
                                                            And trunc (a.sorlcur_start_date) = fecha_ini
                                                            )
                    And a.SORLCUR_CAMP_CODE= campus
                    And a.SORLCUR_LEVL_CODE= nivel
                    And d.SGBSTDN_STYP_CODE in ('N', 'F')
                    order by    iden, 5, grupo, prog,ctlg



                    ) loop



--------------- Limpia Variables  --------------------
--niv :=  null;
parte := null;
crn := null;
pidm_doc2 := null;
conta_sirasgn := null;
pidm_doc := null;
f_inicio := null;
f_fin := null;
sem := null;
schd := null;
title := null;
credit := null;
credit_bill :=null;
levl := null;
camp := null;
mate := null;
parte := null;
per := null;
grupo := null;
vl_existe :=0;

vn_lugares :=0;
vn_cupo_max :=0;
vn_cupo_act :=0;
vl_error := 'EXITO';



           ----- Busca la Parte de Periodo para el programa que inicia clases
        If c.pperiodo is null then

             Begin
                    select distinct SZTPTRM_PTRM_CODE
                        Into Parte
                    from sztptrm, sobptrm
                    where SZTPTRM_CAMP_CODE = campus
                    And SZTPTRM_LEVL_CODE = nivel
                    and SZTPTRM_TERM_CODE = peri
                    and SOBPTRM_TERM_CODE = SZTPTRM_TERM_CODE
                    AND SOBPTRM_PTRM_CODE = SZTPTRM_PTRM_CODE
                    and SZTPTRM_PROGRAM = c.prog
                    and trunc (SOBPTRM_START_DATE) = fecha_ini;

                     If Parte in ('M0C' ) THEN
                       Parte := 'M1A';
                    Elsif  Parte in ('M0A' ) THEN
                       Parte := 'M0B';
                    Elsif  Parte in ('A0A' ) THEN
                       Parte := 'A0B';
                    Elsif  Parte in ('A0C' ) THEN
                       Parte := 'A1A';
                    End if;


               Exception
                When Others then
                  parte := null;
               End;
        Else
             Parte := c.pperiodo;
        End if;


        Begin
               select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
               into f_inicio, f_fin, sem
               from sobptrm
               where sobptrm_term_code=Peri
               and     sobptrm_ptrm_code=parte;
        Exception
           When Others then
            f_inicio:= null;
            f_fin := null;
            sem :=null;
        End;

--------------------- Se valida que el alumno no tenga la materia sembrada en el horario como Activa ---------------------------------------

           begin
            --existe y es aprobatoria
                select count (1)
                    into vl_existe
                from ssbsect, sfrstcr, SHRGRDE
                where sfrstcr_pidm=c.pidm
                --and sfrstcr_term_code=c.periodo
                and ssbsect_term_code=sfrstcr_term_code
                and SFRSTCR_PTRM_CODE = SSBSECT_PTRM_CODE
                and ssbsect_crn=sfrstcr_crn
                and ssbsect_subj_code=c.subj
                and ssbsect_crse_numb=c.crse
                and SFRSTCR_RSTS_CODE = 'RE'
                AND (SFRSTCR_GRDE_CODE = SHRGRDE_CODE
                                         OR SFRSTCR_GRDE_CODE IS NULL)
                AND SHRGRDE_PASSED_IND = 'Y'
                AND SHRGRDE_LEVL_CODE= NIVEL;

            Exception
            when others then
                vl_existe:=0;
            end;



        If vl_existe = 0 then

           --dbms_output.put_line('No Existe la materia:'||Parte ||' '||c.iden || c.subj ||c.crse);

                 If  c.prof is null then
                    --dbms_output.put_line ('sin profesor '||vl_existe);
                    --dbms_output.put_line ('crea consulta '||peri ||'*'|| c.subj  ||'*'||c.crse||'*'||c.grupo||'*'||fecha_ini);
                        begin

                                select ssbsect_crn , ssbsect_seats_avail lugares, ssbsect_max_enrl cupo_max, SSBSECT_PTRM_CODE,
                                        ssbsect_enrl cupo_Act,    SSBSECT_PTRM_START_DATE, SSBSECT_PTRM_END_DATE, SSBSECT_PTRM_WEEKS,
                                        SSBSECT_CREDIT_HRS, SSBSECT_BILL_HRS, SSBSECT_GMOD_CODE
                                into crn , vn_lugares, vn_cupo_max, parte,
                                       vn_cupo_act, f_inicio, f_fin, sem,
                                       credit, credit_bill, gmod
                                from ssbsect a
                                where a.SSBSECT_TERM_CODE= peri
                                and a.ssbsect_subj_code= c.subj
                               and a.ssbsect_crse_numb=c.crse
                               and a.SSBSECT_SEATS_AVAIL >0
                               AND a.SSBSECT_SEATS_AVAIL = (select max (a1.SSBSECT_SEATS_AVAIL)
                                                                               from ssbsect a1
                                                                                where a.SSBSECT_TERM_CODE = a1.SSBSECT_TERM_CODE
                                                                                and a.ssbsect_subj_code = a1.ssbsect_subj_code
                                                                                and a.ssbsect_crse_numb = a1.ssbsect_crse_numb
                                                                               and trunc (a.SSBSECT_PTRM_START_DATE) = trunc (a1.SSBSECT_PTRM_START_DATE))
                                and trunc (a.SSBSECT_PTRM_START_DATE) = f_inicio;

                        Exception
                        when others then
                            crn:=null;
                            vn_lugares :=0;
                            vn_cupo_max:=0;
                            vn_cupo_act:=0;
                            f_inicio := null;
                            f_fin := null;
                            sem := null;
                            credit  := null;
                            credit_bill  := null;
                            gmod  := null;
                              --dbms_output.put_line ('error de crea consulta '||sqlerrm);
                        end;
                Else
                            --dbms_output.put_line ('con profesor '||vl_existe);

                       begin
                               select ssbsect_crn , ssbsect_seats_avail lugares, ssbsect_max_enrl cupo_max, SSBSECT_PTRM_CODE,
                                        ssbsect_enrl cupo_Act,    SSBSECT_PTRM_START_DATE, SSBSECT_PTRM_END_DATE, SSBSECT_PTRM_WEEKS,
                                        SSBSECT_CREDIT_HRS, SSBSECT_BILL_HRS, SSBSECT_GMOD_CODE
                                into crn , vn_lugares, vn_cupo_max, parte,
                                       vn_cupo_act, f_inicio, f_fin, sem,
                                       credit, credit_bill, gmod
                                from ssbsect a, sirasgn
                                where a.SSBSECT_TERM_CODE= peri
                                and a.ssbsect_subj_code= c.subj
                               and a.ssbsect_crse_numb=c.crse
                               and a.SSBSECT_SEQ_NUMB = c.grupo
                               and a.SSBSECT_SEATS_AVAIL >0
                               AND to_number (a.ssbsect_crn) = (select max (to_number (a1.ssbsect_crn))
                                                                                from ssbsect a1
                                                                                where a.SSBSECT_TERM_CODE = a1.SSBSECT_TERM_CODE
                                                                                and a.ssbsect_subj_code = a1.ssbsect_subj_code
                                                                                and a.ssbsect_crse_numb = a1.ssbsect_crse_numb
                                                                                and a.SSBSECT_SEQ_NUMB = a1.SSBSECT_SEQ_NUMB
                                                                                and a.SSBSECT_PTRM_START_DATE = a1.SSBSECT_PTRM_START_DATE
                                                                                )
                                and trunc (a.SSBSECT_PTRM_START_DATE) = f_inicio
                               And SIRASGN_PIDM = (select distinct  spriden_pidm
                                                                    from spriden
                                                                    where spriden_id = c.prof
                                                                    And spriden_change_ind is null )
                                And SIRASGN_PRIMARY_IND = 'Y' ;
                                 --dbms_output.put_line ('crea consulta '||peri ||'*'|| c.subj  ||'*'||c.crse||'*'||c.grupo||'*'||fecha_ini);

                       Exception
                        when others then
                            crn:=null;
                            vn_lugares :=0;
                            vn_cupo_max:=0;
                            vn_cupo_act:=0;
                            f_inicio := null;
                            f_fin := null;
                            sem := null;
                            credit  := null;
                            credit_bill  := null;
                            gmod  := null;
                           -- dbms_output.put_line ('error de crea consulta '||sqlerrm);
                       end;

                End if;



                If crn is not null then

                    If vn_lugares >0  then

                            If credit is null then
                               Begin
                                      select SSRMEET_CREDIT_HR_SESS
                                       Into credit
                                      from SSRMEET
                                      where SSRMEET_TERM_CODE = peri
                                      And SSRMEET_CRN = crn;
                               Exception
                                When Others then
                                   credit :=null;
                                End;

                                  If credit is not null then
                                           Begin
                                               Update ssbsect
                                               set  SSBSECT_CREDIT_HRS = credit
                                               where SSBSECT_TERM_CODE = peri
                                               and SSBSECT_CRN = crn;
                                           Exception
                                           when Others then
                                                null;
                                           End;
                                  End if;
                           End if;

                           If credit_bill is null then
                                 Begin
                                         select  SCBCRSE_BILL_HR_LOW
                                            into credit_bill
                                            from scbcrse, scrschd
                                            where scbcrse_subj_code=  c.subj
                                            and     scbcrse_crse_numb=c.crse
                                            and     scbcrse_eff_term='000000'
                                            and     scrschd_subj_code=scbcrse_subj_code
                                            and     scrschd_crse_numb=scbcrse_crse_numb
                                            and     scrschd_eff_term=scbcrse_eff_term;
                                 Exception
                                 When Others then
                                    credit_bill := 3;
                                 End;

                                  If credit is not null then
                                           Begin
                                               Update ssbsect
                                               set  SSBSECT_BILL_HRS = credit_bill
                                               where SSBSECT_TERM_CODE = peri
                                               and SSBSECT_CRN = crn;
                                           Exception
                                           when Others then
                                                null;
                                           End;
                                  End if;
                           End if;




                          If gmod is null then
                                begin
                                    select scrgmod_gmod_code
                                    into gmod
                                    from scrgmod
                                    where scrgmod_subj_code=c.subj
                                    and     scrgmod_crse_numb=c.crse
                                    and     scrgmod_default_ind='D';
                                exception when others then
                                    gmod:='1';
                                end;

                                If gmod is not null then
                                           Begin
                                               Update ssbsect
                                               set  SSBSECT_GMOD_CODE = gmod
                                               where SSBSECT_TERM_CODE = peri
                                               and SSBSECT_CRN = crn;
                                           Exception
                                           when Others then
                                                null;
                                           End;
                                end if;

                          End if;


                        conta_ptrm :=0;

                            Begin
                                 select count(*)
                                    into conta_ptrm
                                 from sfbetrm
                                 where sfbetrm_term_code=peri
                                 and     sfbetrm_pidm=c.pidm;
                            Exception
                                When Others then
                                  conta_ptrm := 0;
                            End;


                             if conta_ptrm =0 then
                                    Begin
                                            insert into sfbetrm values(peri, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFNVIN', null, 0,null,null, null,null,user,null);
                                    Exception
                                    When Others then
                                        vl_error := ('Se presento un error al insertar en la tabla sfbetrm ' || sqlerrm);
                                    End;
                             end if;



                            Begin
                                select sgbstdn_levl_code, sgbstdn_camp_code  into levl, camp
                                from sgbstdn a
                                where sgbstdn_pidm=c.pidm
                                and     sgbstdn_term_code_eff  in (select max(sgbstdn_term_code_eff) from sgbstdn aa
                                                                                   where a.sgbstdn_pidm=aa.sgbstdn_pidm);
                            Exception
                            When Others then
                               levl := null;
                               camp := null;
                               vl_error := 'Se presento un error al obtener la informacion de SGBSTDN ' || sqlerrm;
                            End;

                           Begin
                                    select distinct max(sorlcur_key_seqno)
                                        into sp
                                    from sorlcur
                                    where sorlcur_pidm=c.pidm
                                    and     sorlcur_program=c.prog
                                    and     sorlcur_lmod_code='LEARNER';
                           Exception
                           when Others then
                              sp := null;
                              vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||sqlerrm;
                           End;

                           Begin

                               insert into sfrstcr values(
                                                                peri,     --SFRSTCR_TERM_CODE
                                                                c.pidm,     --SFRSTCR_PIDM
                                                                crn,     --SFRSTCR_CRN
                                                                1,     --SFRSTCR_CLASS_SORT_KEY
                                                                1,    --SFRSTCR_REG_SEQ
                                                                parte,    --SFRSTCR_PTRM_CODE
                                                                'RE',     --SFRSTCR_RSTS_CODE
                                                                sysdate,    --SFRSTCR_RSTS_DATE
                                                                null,    --SFRSTCR_ERROR_FLAG
                                                                null,    --SFRSTCR_MESSAGE
                                                                credit_bill,    --SFRSTCR_BILL_HR
                                                                3, --SFRSTCR_WAIV_HR
                                                                credit,     --SFRSTCR_CREDIT_HR
                                                                credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                gmod,     --SFRSTCR_GMOD_CODE
                                                                null,    --SFRSTCR_GRDE_CODE
                                                                null,    --SFRSTCR_GRDE_CODE_MID
                                                                null,    --SFRSTCR_GRDE_DATE
                                                                'N',    --SFRSTCR_DUPL_OVER
                                                                'N',    --SFRSTCR_LINK_OVER
                                                                'N',    --SFRSTCR_CORQ_OVER
                                                                'N',    --SFRSTCR_PREQ_OVER
                                                                'N',     --SFRSTCR_TIME_OVER
                                                                'N',     --SFRSTCR_CAPC_OVER
                                                                'N',     --SFRSTCR_LEVL_OVER
                                                                'N',     --SFRSTCR_COLL_OVER
                                                                'N',     --SFRSTCR_MAJR_OVER
                                                                'N',     --SFRSTCR_CLAS_OVER
                                                                'N',     --SFRSTCR_APPR_OVER
                                                                'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                sysdate,      --SFRSTCR_ADD_DATE
                                                                sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                levl,     --SFRSTCR_LEVL_CODE
                                                                camp,     --SFRSTCR_CAMP_CODE
                                                                null,     --SFRSTCR_RESERVED_KEY
                                                                null,     --SFRSTCR_ATTEND_HR
                                                                'Y',     --SFRSTCR_REPT_OVER
                                                                'N' ,    --SFRSTCR_RPTH_OVER
                                                                null,    --SFRSTCR_TEST_OVER
                                                                'N',    --SFRSTCR_CAMP_OVER
                                                                user,    --SFRSTCR_USER
                                                                'N',    --SFRSTCR_DEGC_OVER
                                                                'N',    --SFRSTCR_PROG_OVER
                                                                null,    --SFRSTCR_LAST_ATTEND
                                                                null,    --SFRSTCR_GCMT_CODE
                                                                'SZFNVIN',    --SFRSTCR_DATA_ORIGIN
                                                                sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                'N',  --SFRSTCR_DEPT_OVER
                                                                'N',  --SFRSTCR_ATTS_OVER
                                                                'N', --SFRSTCR_CHRT_OVER
                                                                null, --SFRSTCR_RMSG_CDE
                                                                null,  --SFRSTCR_WL_PRIORITY
                                                                null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                'N', --SFRSTCR_MEXC_OVER
                                                                sp,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                null,--SFRSTCR_BRDH_SEQ_NUM
                                                                '01',--SFRSTCR_BLCK_CODE
                                                                null,--SFRSTCR_STRH_SEQNO
                                                                null, --SFRSTCR_STRD_SEQNO
                                                                null,  --SFRSTCR_SURROGATE_ID
                                                                null, --SFRSTCR_VERSION
                                                                user,--SFRSTCR_USER_ID
                                                                no_recibo );--SFRSTCR_VPDI_CODE



                                        Begin
                                             update ssbsect
                                                    set ssbsect_enrl = ssbsect_enrl + 1
                                              where SSBSECT_TERM_CODE = peri
                                              And SSBSECT_CRN  = crn;
                                        Exception
                                        When Others then
                                        vl_error := 'Se presento un error al actualizar el enrolamiento ' ||sqlerrm;
                                        End;

                                        Begin
                                                update ssbsect
                                                    set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                where SSBSECT_TERM_CODE = peri
                                                 And SSBSECT_CRN  = crn;
                                        Exception
                                        When Others then
                                            vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||sqlerrm;
                                        End;

                                        Begin
                                                 update ssbsect
                                                        set ssbsect_census_enrl=ssbsect_enrl
                                                 Where SSBSECT_TERM_CODE = peri
                                                 And SSBSECT_CRN  = crn;
                                        Exception
                                        When Others then
                                            vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||sqlerrm;
                                        End;


                                        conta_ptrm:=0;

                                        Begin
                                            Select count (*)
                                                Into conta_ptrm
                                            from sfrareg
                                            where SFRAREG_PIDM = c.pidm
                                            And SFRAREG_TERM_CODE = peri
                                            And SFRAREG_CRN = crn
                                            And SFRAREG_EXTENSION_NUMBER = 0
                                            And SFRAREG_RSTS_CODE = 'RE';
                                        Exception
                                        When Others then
                                           conta_ptrm :=0;
                                        End;

                                        If conta_ptrm = 0 then

                                             Begin
                                                     insert into sfrareg values(c.pidm, peri, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFNVIN', sysdate, null,null,null);
                                             Exception
                                               When Others then
                                                  vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||sqlerrm;
                                             End;
                                        End if;

                                          vl_existe :=0;

                                          Begin
                                             Select count(1)
                                             Into vl_existe
                                             from SHRINST
                                             Where  SHRINST_TERM_CODE = peri
                                             And SHRINST_CRN = crn
                                             And  SHRINST_PIDM = c.pidm;
                                          Exception
                                          When Others then
                                           vl_existe :=0;
                                          End;


                                          If vl_existe = 0 then
                                                Begin
                                                    Insert into SHRINST values (peri,        --SHRINST_TERM_CODE
                                                                                             crn,       --SHRINST_CRN
                                                                                             c.pidm,       --SHRINST_PIDM
                                                                                             sysdate,       --SHRINST_ACTIVITY_DATE
                                                                                             'Y',       --SHRINST_PRIMARY_IND
                                                                                              null,      --SHRINST_SURROGATE_ID
                                                                                              null,      --SHRINST_VERSION
                                                                                             user,       --SHRINST_USER_ID
                                                                                             'SZFNVIN',       --SHRINST_DATA_ORIGIN
                                                                                              null);      --SHRINST_VPDI_CODE


                                                Exception
                                                    When Others then
                                                     vl_error := 'Se presento un error al insertar al alumno en SHRINST ' ||sqlerrm;
                                                End;

                                          End if;


                                                              Begin
                                                                    Update sgbstdn a
                                                                    set a.SGBSTDN_STYP_CODE ='N'
                                                                    Where a.SGBSTDN_PIDM = c.pidm
                                                                    And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                                           from sgbstdn a1
                                                                                                                           Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                                          --- And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1
                                                                                                                           )
                                                                    -- And a.SGBSTDN_PROGRAM_1 = c.prog
                                                                     ;
                                                                Exception
                                                                    When Others then
                                                                    vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                                                End;





                            Exception
                           when Others then
                               vl_error := 'Se presento un error al insertar al alumno en el grupo ' ||sqlerrm;
                           End;

                     Else  ----------> Se realizara la creacion del grupo

                            schd := null;
                            title := null;
                            credit := null;
                            gmod :=null;
                            credit_bill := null;

                            Begin
                                select scrschd_schd_code, scbcrse_title, scbcrse_credit_hr_low, SCBCRSE_BILL_HR_LOW
                                into schd, title, credit, credit_bill
                                from scbcrse, scrschd
                                where scbcrse_subj_code=c.subj
                                and     scbcrse_crse_numb=c.crse
                                and     scbcrse_eff_term='000000'
                                and     scrschd_subj_code=scbcrse_subj_code
                                and     scrschd_crse_numb=scbcrse_crse_numb
                                and     scrschd_eff_term=scbcrse_eff_term;
                            Exception
                            When Others then
                                  schd := null;
                                  title := null;
                                  credit := null;
                            End;


                            begin
                                select scrgmod_gmod_code
                                      into gmod
                                from scrgmod
                                where scrgmod_subj_code=c.subj
                                and     scrgmod_crse_numb=c.crse
                                and     scrgmod_default_ind='D';
                            exception when others then
                                gmod:='1';
                            end;

                             Begin
                                    select nvl(max(ssbsect_crn),1000)+1
                                         into crn
                                    from ssbsect where ssbsect_term_code= peri;
                              Exception
                                    When Others then
                                       crn := null;
                             End;

                             If crn is not null then

                               Begin
                                   select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                                   into f_inicio, f_fin, sem
                                   from sobptrm
                                   where sobptrm_term_code=Peri
                                   and     sobptrm_ptrm_code=parte;
                               Exception
                               When Others then
                                f_inicio:= null;
                                f_fin := null;
                                sem :=null;
                               End;



                                  Begin
                                        Insert into ssbsect values (
                                                                           Peri,     --SSBSECT_TERM_CODE
                                                                           crn,     --SSBSECT_CRN
                                                                           parte,     --SSBSECT_PTRM_CODE
                                                                           c.subj,     --SSBSECT_SUBJ_CODE
                                                                           c.crse,     --SSBSECT_CRSE_NUMB
                                                                            '01',     --SSBSECT_SEQ_NUMB
                                                                            'A',    --SSBSECT_SSTS_CODE
                                                                            schd,    --SSBSECT_SCHD_CODE
                                                                            campus,    --SSBSECT_CAMP_CODE
                                                                             title,   --SSBSECT_CRSE_TITLE
                                                                             credit,   --SSBSECT_CREDIT_HRS
                                                                             credit_bill,   --SSBSECT_BILL_HRS
                                                                             gmod,   --SSBSECT_GMOD_CODE
                                                                              null,  --SSBSECT_SAPR_CODE
                                                                              null, --SSBSECT_SESS_CODE
                                                                              null,  --SSBSECT_LINK_IDENT
                                                                              null,  --SSBSECT_PRNT_IND
                                                                              'Y',  --SSBSECT_GRADABLE_IND
                                                                               null,  --SSBSECT_TUIW_IND
                                                                               0, --SSBSECT_REG_ONEUP
                                                                               0, --SSBSECT_PRIOR_ENRL
                                                                               0, --SSBSECT_PROJ_ENRL
                                                                               50, --SSBSECT_MAX_ENRL
                                                                                0,--SSBSECT_ENRL
                                                                                50,--SSBSECT_SEATS_AVAIL
                                                                                null,--SSBSECT_TOT_CREDIT_HRS
                                                                                '0',--SSBSECT_CENSUS_ENRL
                                                                                f_inicio,--SSBSECT_CENSUS_ENRL_DATE
                                                                                sysdate,--SSBSECT_ACTIVITY_DATE
                                                                                f_inicio,--SSBSECT_PTRM_START_DATE
                                                                                f_fin,--SSBSECT_PTRM_END_DATE
                                                                                sem,--SSBSECT_PTRM_WEEKS
                                                                                null,--SSBSECT_RESERVED_IND
                                                                                null, --SSBSECT_WAIT_CAPACITY
                                                                                null,--SSBSECT_WAIT_COUNT
                                                                                null,--SSBSECT_WAIT_AVAIL
                                                                                null,--SSBSECT_LEC_HR
                                                                                null,--SSBSECT_LAB_HR
                                                                                null,--SSBSECT_OTH_HR
                                                                                null,--SSBSECT_CONT_HR
                                                                                null,--SSBSECT_ACCT_CODE
                                                                                null,--SSBSECT_ACCL_CODE
                                                                                null,--SSBSECT_CENSUS_2_DATE
                                                                                null,--SSBSECT_ENRL_CUT_OFF_DATE
                                                                                null,--SSBSECT_ACAD_CUT_OFF_DATE
                                                                                null,--SSBSECT_DROP_CUT_OFF_DATE
                                                                                null,--SSBSECT_CENSUS_2_ENRL
                                                                                'Y',--SSBSECT_VOICE_AVAIL
                                                                                'N',--SSBSECT_CAPP_PREREQ_TEST_IND
                                                                                null,--SSBSECT_GSCH_NAME
                                                                                null,--SSBSECT_BEST_OF_COMP
                                                                                null,--SSBSECT_SUBSET_OF_COMP
                                                                                'NOP',--SSBSECT_INSM_CODE
                                                                                null,--SSBSECT_REG_FROM_DATE
                                                                                null,--SSBSECT_REG_TO_DATE
                                                                                null,--SSBSECT_LEARNER_REGSTART_FDATE
                                                                                null,--SSBSECT_LEARNER_REGSTART_TDATE
                                                                                null,--SSBSECT_DUNT_CODE
                                                                                null,--SSBSECT_NUMBER_OF_UNITS
                                                                                0,--SSBSECT_NUMBER_OF_EXTENSIONS
                                                                                'SZFNVIN',--SSBSECT_DATA_ORIGIN
                                                                                user,--SSBSECT_USER_ID
                                                                                'MOOD',--SSBSECT_INTG_CDE
                                                                                'B',--SSBSECT_PREREQ_CHK_METHOD_CDE
                                                                                user,--SSBSECT_KEYWORD_INDEX_ID
                                                                                null,--SSBSECT_SCORE_OPEN_DATE
                                                                                null,--SSBSECT_SCORE_CUTOFF_DATE
                                                                                null,--SSBSECT_REAS_SCORE_OPEN_DATE
                                                                                null,--SSBSECT_REAS_SCORE_CTOF_DATE
                                                                                null,--SSBSECT_SURROGATE_ID
                                                                                null,--SSBSECT_VERSION
                                                                                 null);--SSBSECT_VPDI_CODE

                                                   Begin
                                                        insert into ssrmeet values(peri, crn, null,null,null,null,null,null, sysdate, f_inicio, f_fin, '01', null,null,null,null,null,null,null, 'ENL', null, credit, null, 0, null,null,null, 'CLVI', 'SZFNVIN', user, null,null,null);
                                                    Exception
                                                    when Others then
                                                       vl_error := 'Se presento un Error al insertar en ssrmeet ' ||sqlerrm;
                                                   End;

                                                 pidm_prof := null;

--                                                  If  c.prof is null then
--                                                       c.prof :=  '019814933';
--                                                  End if;

                                                    begin
                                                    select spriden_pidm into pidm_prof
                                                    from  spriden
                                                    where   spriden_id=c.prof and spriden_change_ind is null;
                                                    exception when others then
                                                    pidm_prof:=null;
                                                    end;

                                                    if pidm_prof is not null then
                                                        Begin
                                                                insert into sirasgn values(ciclo, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,  sysdate, null,null,null,null, 'SZFNVIN', user, null, null, null, null,  null,null);
                                                        Exception
                                                        When Others then
                                                        null;
                                                        End;
                                                    end if;


                                                conta_ptrm :=0;

                                                    Begin
                                                         select count(*)
                                                            into conta_ptrm
                                                         from sfbetrm
                                                         where sfbetrm_term_code=peri
                                                         and     sfbetrm_pidm=c.pidm;
                                                    Exception
                                                        When Others then
                                                          conta_ptrm := 0;
                                                    End;


                                                     if conta_ptrm =0 then
                                                            Begin
                                                                    insert into sfbetrm values(peri, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFNVIN', null, 0,null,null, null,null,user,null);
                                                            Exception
                                                            When Others then
                                                                vl_error := ('Se presento un error al insertar en la tabla sfbetrm ' || sqlerrm);
                                                            End;
                                                     end if;



                                                    Begin
                                                        select sgbstdn_levl_code, sgbstdn_camp_code  into levl, camp
                                                        from sgbstdn a
                                                        where sgbstdn_pidm=c.pidm
                                                        and     sgbstdn_term_code_eff  in (select max(sgbstdn_term_code_eff) from sgbstdn aa
                                                                                                           where a.sgbstdn_pidm=aa.sgbstdn_pidm);
                                                    Exception
                                                    When Others then
                                                       levl := null;
                                                       camp := null;
                                                       vl_error := 'Se presento un error al obtener la informacion de SGBSTDN ' || sqlerrm;
                                                    End;

                                                   Begin
                                                            select distinct max(sorlcur_key_seqno)
                                                                into sp
                                                            from sorlcur
                                                            where sorlcur_pidm=c.pidm
                                                            and     sorlcur_program=c.prog
                                                            and     sorlcur_lmod_code='LEARNER';
                                                   Exception
                                                   when Others then
                                                      sp := null;
                                                      vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||sqlerrm;
                                                   End;

                                                   Begin

                                                       insert into sfrstcr values(
                                                                                        peri,     --SFRSTCR_TERM_CODE
                                                                                        c.pidm,     --SFRSTCR_PIDM
                                                                                        crn,     --SFRSTCR_CRN
                                                                                        1,     --SFRSTCR_CLASS_SORT_KEY
                                                                                        1,    --SFRSTCR_REG_SEQ
                                                                                        parte,    --SFRSTCR_PTRM_CODE
                                                                                        'RE',     --SFRSTCR_RSTS_CODE
                                                                                        sysdate,    --SFRSTCR_RSTS_DATE
                                                                                        null,    --SFRSTCR_ERROR_FLAG
                                                                                        null,    --SFRSTCR_MESSAGE
                                                                                        credit_bill,    --SFRSTCR_BILL_HR
                                                                                        3, --SFRSTCR_WAIV_HR
                                                                                        credit,     --SFRSTCR_CREDIT_HR
                                                                                        credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                                        credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                                        gmod,     --SFRSTCR_GMOD_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE_MID
                                                                                        null,    --SFRSTCR_GRDE_DATE
                                                                                        'N',    --SFRSTCR_DUPL_OVER
                                                                                        'N',    --SFRSTCR_LINK_OVER
                                                                                        'N',    --SFRSTCR_CORQ_OVER
                                                                                        'N',    --SFRSTCR_PREQ_OVER
                                                                                        'N',     --SFRSTCR_TIME_OVER
                                                                                        'N',     --SFRSTCR_CAPC_OVER
                                                                                        'N',     --SFRSTCR_LEVL_OVER
                                                                                        'N',     --SFRSTCR_COLL_OVER
                                                                                        'N',     --SFRSTCR_MAJR_OVER
                                                                                        'N',     --SFRSTCR_CLAS_OVER
                                                                                        'N',     --SFRSTCR_APPR_OVER
                                                                                        'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                                        sysdate,      --SFRSTCR_ADD_DATE
                                                                                        sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                                        levl,     --SFRSTCR_LEVL_CODE
                                                                                        camp,     --SFRSTCR_CAMP_CODE
                                                                                        null,     --SFRSTCR_RESERVED_KEY
                                                                                        null,     --SFRSTCR_ATTEND_HR
                                                                                        'Y',     --SFRSTCR_REPT_OVER
                                                                                        'N' ,    --SFRSTCR_RPTH_OVER
                                                                                        null,    --SFRSTCR_TEST_OVER
                                                                                        'N',    --SFRSTCR_CAMP_OVER
                                                                                        user,    --SFRSTCR_USER
                                                                                        'N',    --SFRSTCR_DEGC_OVER
                                                                                        'N',    --SFRSTCR_PROG_OVER
                                                                                        null,    --SFRSTCR_LAST_ATTEND
                                                                                        null,    --SFRSTCR_GCMT_CODE
                                                                                        'SZFNVIN',    --SFRSTCR_DATA_ORIGIN
                                                                                        sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                                        'N',  --SFRSTCR_DEPT_OVER
                                                                                        'N',  --SFRSTCR_ATTS_OVER
                                                                                        'N', --SFRSTCR_CHRT_OVER
                                                                                        null, --SFRSTCR_RMSG_CDE
                                                                                        null,  --SFRSTCR_WL_PRIORITY
                                                                                        null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                                        null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                                        null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                                        'N', --SFRSTCR_MEXC_OVER
                                                                                        sp,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                                        null,--SFRSTCR_BRDH_SEQ_NUM
                                                                                        '01',--SFRSTCR_BLCK_CODE
                                                                                        null,--SFRSTCR_STRH_SEQNO
                                                                                        null, --SFRSTCR_STRD_SEQNO
                                                                                        null,  --SFRSTCR_SURROGATE_ID
                                                                                        null, --SFRSTCR_VERSION
                                                                                        user,--SFRSTCR_USER_ID
                                                                                        no_recibo );--SFRSTCR_VPDI_CODE



                                                                Begin
                                                                     update ssbsect
                                                                            set ssbsect_enrl = ssbsect_enrl + 1
                                                                      where SSBSECT_TERM_CODE = peri
                                                                      And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                vl_error := 'Se presento un error al actualizar el enrolamiento ' ||sqlerrm;
                                                                End;

                                                                Begin
                                                                        update ssbsect
                                                                            set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                                        where SSBSECT_TERM_CODE = peri
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||sqlerrm;
                                                                End;

                                                                Begin
                                                                         update ssbsect
                                                                                set ssbsect_census_enrl=ssbsect_enrl
                                                                         Where SSBSECT_TERM_CODE = peri
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||sqlerrm;
                                                                End;


                                                                conta_ptrm:=0;

                                                                Begin
                                                                    Select count (*)
                                                                        Into conta_ptrm
                                                                    from sfrareg
                                                                    where SFRAREG_PIDM = c.pidm
                                                                    And SFRAREG_TERM_CODE = peri
                                                                    And SFRAREG_CRN = crn
                                                                    And SFRAREG_EXTENSION_NUMBER = 0
                                                                    And SFRAREG_RSTS_CODE = 'RE';
                                                                Exception
                                                                When Others then
                                                                   conta_ptrm :=0;
                                                                End;

                                                                If conta_ptrm = 0 then

                                                                     Begin
                                                                             insert into sfrareg values(c.pidm, peri, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFNVIN', sysdate, null,null,null);
                                                                     Exception
                                                                       When Others then
                                                                          vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||sqlerrm;
                                                                     End;
                                                                End if;

                                                              vl_existe :=0;

                                                              Begin
                                                                 Select count(1)
                                                                 Into vl_existe
                                                                 from SHRINST
                                                                 Where  SHRINST_TERM_CODE = peri
                                                                 And SHRINST_CRN = crn
                                                                 And  SHRINST_PIDM = c.pidm;
                                                              Exception
                                                              When Others then
                                                               vl_existe :=0;
                                                              End;


                                                              If vl_existe = 0 then
                                                                    Begin
                                                                        Insert into SHRINST values (peri,        --SHRINST_TERM_CODE
                                                                                                                 crn,       --SHRINST_CRN
                                                                                                                 c.pidm,       --SHRINST_PIDM
                                                                                                                 sysdate,       --SHRINST_ACTIVITY_DATE
                                                                                                                 'Y',       --SHRINST_PRIMARY_IND
                                                                                                                  null,      --SHRINST_SURROGATE_ID
                                                                                                                  null,      --SHRINST_VERSION
                                                                                                                 user,       --SHRINST_USER_ID
                                                                                                                 'SZFNVIN',       --SHRINST_DATA_ORIGIN
                                                                                                                  null);      --SHRINST_VPDI_CODE


                                                                    Exception
                                                                        When Others then
                                                                         vl_error := 'Se presento un error al insertar al alumno en SHRINST ' ||sqlerrm;
                                                                    End;

                                                              End if;


                                                              Begin
                                                                    Update sgbstdn a
                                                                    set a.SGBSTDN_STYP_CODE ='N'
                                                                    Where a.SGBSTDN_PIDM = c.pidm
                                                                    And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                                           from sgbstdn a1
                                                                                                                           Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                                          --- And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1
                                                                                                                           )
                                                                    -- And a.SGBSTDN_PROGRAM_1 = c.prog
                                                                     ;
                                                                Exception
                                                                    When Others then
                                                                    vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                                                End;



                                                    Exception
                                                   when Others then
                                                       vl_error := 'Se presento un error al insertar al alumno en el grupo ' ||sqlerrm;
                                                   End;


                                  Exception
                                    When Others then
                                      vl_error := 'Se presento un Error al insertar el nuevo grupo 5 ' ||sqlerrm;
                                  End;
                             End if;

                    -- dbms_output.put_line('mensaje:'|| 'No hay grupo cupo');
                     End if;
                Else
                   -- dbms_output.put_line('mensaje:'|| 'No hay grupo creado');
                            schd := null;
                            title := null;
                            credit := null;
                            gmod :=null;
                            credit_bill := null;

                            Begin
                                select scrschd_schd_code, scbcrse_title, scbcrse_credit_hr_low, SCBCRSE_BILL_HR_LOW
                                into schd, title, credit, credit_bill
                                from scbcrse, scrschd
                                where scbcrse_subj_code=c.subj
                                and     scbcrse_crse_numb=c.crse
                                and     scbcrse_eff_term='000000'
                                and     scrschd_subj_code=scbcrse_subj_code
                                and     scrschd_crse_numb=scbcrse_crse_numb
                                and     scrschd_eff_term=scbcrse_eff_term;
                            Exception
                            When Others then
                                  schd := null;
                                  title := null;
                                  credit := null;
                                  credit_bill := null;
                            End;


                            begin
                                select scrgmod_gmod_code
                                      into gmod
                                from scrgmod
                                where scrgmod_subj_code=c.subj
                                and     scrgmod_crse_numb=c.crse
                                and     scrgmod_default_ind='D';
                            exception when others then
                                gmod:='1';
                            end;

                             Begin
                                    select nvl(max(ssbsect_crn),1000)+1
                                         into crn
                                    from ssbsect where ssbsect_term_code= peri;
                              Exception
                                    When Others then
                                       crn := null;
                             End;

                        If crn is not null then

                                Begin
                                   select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                                   into f_inicio, f_fin, sem
                                   from sobptrm
                                   where sobptrm_term_code=Peri
                                   and     sobptrm_ptrm_code=parte;
                                Exception
                                When Others then
                                    f_inicio:= null;
                                    f_fin := null;
                                    sem :=null;
                                End;

                                  Begin
                                        Insert into ssbsect values (
                                                                           Peri,     --SSBSECT_TERM_CODE
                                                                           crn,     --SSBSECT_CRN
                                                                           parte,     --SSBSECT_PTRM_CODE
                                                                           c.subj,     --SSBSECT_SUBJ_CODE
                                                                           c.crse,     --SSBSECT_CRSE_NUMB
                                                                            '01',     --SSBSECT_SEQ_NUMB
                                                                            'A',    --SSBSECT_SSTS_CODE
                                                                            schd,    --SSBSECT_SCHD_CODE
                                                                            campus,    --SSBSECT_CAMP_CODE
                                                                             title,   --SSBSECT_CRSE_TITLE
                                                                             credit,   --SSBSECT_CREDIT_HRS
                                                                             credit_bill,   --SSBSECT_BILL_HRS
                                                                             gmod,   --SSBSECT_GMOD_CODE
                                                                              null,  --SSBSECT_SAPR_CODE
                                                                              null, --SSBSECT_SESS_CODE
                                                                              null,  --SSBSECT_LINK_IDENT
                                                                              null,  --SSBSECT_PRNT_IND
                                                                              'Y',  --SSBSECT_GRADABLE_IND
                                                                               null,  --SSBSECT_TUIW_IND
                                                                               0, --SSBSECT_REG_ONEUP
                                                                               0, --SSBSECT_PRIOR_ENRL
                                                                               0, --SSBSECT_PROJ_ENRL
                                                                               50, --SSBSECT_MAX_ENRL
                                                                                0,--SSBSECT_ENRL
                                                                                50,--SSBSECT_SEATS_AVAIL
                                                                                null,--SSBSECT_TOT_CREDIT_HRS
                                                                                '0',--SSBSECT_CENSUS_ENRL
                                                                                f_inicio,--SSBSECT_CENSUS_ENRL_DATE
                                                                                sysdate,--SSBSECT_ACTIVITY_DATE
                                                                                f_inicio,--SSBSECT_PTRM_START_DATE
                                                                                f_fin,--SSBSECT_PTRM_END_DATE
                                                                                sem,--SSBSECT_PTRM_WEEKS
                                                                                null,--SSBSECT_RESERVED_IND
                                                                                null, --SSBSECT_WAIT_CAPACITY
                                                                                null,--SSBSECT_WAIT_COUNT
                                                                                null,--SSBSECT_WAIT_AVAIL
                                                                                null,--SSBSECT_LEC_HR
                                                                                null,--SSBSECT_LAB_HR
                                                                                null,--SSBSECT_OTH_HR
                                                                                null,--SSBSECT_CONT_HR
                                                                                null,--SSBSECT_ACCT_CODE
                                                                                null,--SSBSECT_ACCL_CODE
                                                                                null,--SSBSECT_CENSUS_2_DATE
                                                                                null,--SSBSECT_ENRL_CUT_OFF_DATE
                                                                                null,--SSBSECT_ACAD_CUT_OFF_DATE
                                                                                null,--SSBSECT_DROP_CUT_OFF_DATE
                                                                                null,--SSBSECT_CENSUS_2_ENRL
                                                                                'Y',--SSBSECT_VOICE_AVAIL
                                                                                'N',--SSBSECT_CAPP_PREREQ_TEST_IND
                                                                                null,--SSBSECT_GSCH_NAME
                                                                                null,--SSBSECT_BEST_OF_COMP
                                                                                null,--SSBSECT_SUBSET_OF_COMP
                                                                                'NOP',--SSBSECT_INSM_CODE
                                                                                null,--SSBSECT_REG_FROM_DATE
                                                                                null,--SSBSECT_REG_TO_DATE
                                                                                null,--SSBSECT_LEARNER_REGSTART_FDATE
                                                                                null,--SSBSECT_LEARNER_REGSTART_TDATE
                                                                                null,--SSBSECT_DUNT_CODE
                                                                                null,--SSBSECT_NUMBER_OF_UNITS
                                                                                0,--SSBSECT_NUMBER_OF_EXTENSIONS
                                                                                'SZFNVIN',--SSBSECT_DATA_ORIGIN
                                                                                user,--SSBSECT_USER_ID
                                                                                'MOOD',--SSBSECT_INTG_CDE
                                                                                'B',--SSBSECT_PREREQ_CHK_METHOD_CDE
                                                                                user,--SSBSECT_KEYWORD_INDEX_ID
                                                                                null,--SSBSECT_SCORE_OPEN_DATE
                                                                                null,--SSBSECT_SCORE_CUTOFF_DATE
                                                                                null,--SSBSECT_REAS_SCORE_OPEN_DATE
                                                                                null,--SSBSECT_REAS_SCORE_CTOF_DATE
                                                                                null,--SSBSECT_SURROGATE_ID
                                                                                null,--SSBSECT_VERSION
                                                                                 null);--SSBSECT_VPDI_CODE

                                                   Begin
                                                        insert into ssrmeet values(peri, crn, null,null,null,null,null,null, sysdate, f_inicio, f_fin, '01', null,null,null,null,null,null,null, 'ENL', null, credit, null, 0, null,null,null, 'CLVI', 'SZFNVIN', user, null,null,null);
                                                    Exception
                                                    when Others then
                                                       vl_error := 'Se presento un Error al insertar en ssrmeet ' ||sqlerrm;
                                                   End;

                                                 pidm_prof := null;

--                                                  If  c.prof is null then
--                                                       c.prof :=  '019814933';
--                                                  End if;


                                                    begin
                                                        select spriden_pidm into pidm_prof
                                                        from  spriden
                                                        where   spriden_id=c.prof and spriden_change_ind is null;
                                                    Exception when others then
                                                      pidm_prof:=null;
                                                    End;

                                                    if pidm_prof is not null then
                                                        Begin
                                                                insert into sirasgn values(ciclo, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,  sysdate, null,null,null,null, 'SZFNVIN', user, null, null, null, null,  null,null);
                                                        Exception
                                                        When Others then
                                                        null;
                                                        End;
                                                    end if;


                                                conta_ptrm :=0;

                                                    Begin
                                                         select count(*)
                                                            into conta_ptrm
                                                         from sfbetrm
                                                         where sfbetrm_term_code=peri
                                                         and     sfbetrm_pidm=c.pidm;
                                                    Exception
                                                        When Others then
                                                          conta_ptrm := 0;
                                                    End;


                                                     if conta_ptrm =0 then
                                                            Begin
                                                                    insert into sfbetrm values(peri, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFNVIN', null, 0,null,null, null,null,user,null);
                                                            Exception
                                                            When Others then
                                                                vl_error := ('Se presento un error al insertar en la tabla sfbetrm ' || sqlerrm);
                                                            End;
                                                     end if;



                                                    Begin
                                                        select sgbstdn_levl_code, sgbstdn_camp_code  into levl, camp
                                                        from sgbstdn a
                                                        where sgbstdn_pidm=c.pidm
                                                        and     sgbstdn_term_code_eff  in (select max(sgbstdn_term_code_eff) from sgbstdn aa
                                                                                                           where a.sgbstdn_pidm=aa.sgbstdn_pidm);
                                                    Exception
                                                    When Others then
                                                       levl := null;
                                                       camp := null;
                                                       vl_error := 'Se presento un error al obtener la informacion de SGBSTDN ' || sqlerrm;
                                                    End;

                                                   Begin
                                                            select distinct max(sorlcur_key_seqno)
                                                                into sp
                                                            from sorlcur
                                                            where sorlcur_pidm=c.pidm
                                                            and     sorlcur_program=c.prog
                                                            and     sorlcur_lmod_code='LEARNER';
                                                   Exception
                                                   when Others then
                                                      sp := null;
                                                      vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||sqlerrm;
                                                   End;

                                                   Begin

                                                       insert into sfrstcr values(
                                                                                        peri,     --SFRSTCR_TERM_CODE
                                                                                        c.pidm,     --SFRSTCR_PIDM
                                                                                        crn,     --SFRSTCR_CRN
                                                                                        1,     --SFRSTCR_CLASS_SORT_KEY
                                                                                        1,    --SFRSTCR_REG_SEQ
                                                                                        parte,    --SFRSTCR_PTRM_CODE
                                                                                        'RE',     --SFRSTCR_RSTS_CODE
                                                                                        sysdate,    --SFRSTCR_RSTS_DATE
                                                                                        null,    --SFRSTCR_ERROR_FLAG
                                                                                        null,    --SFRSTCR_MESSAGE
                                                                                        credit_bill,    --SFRSTCR_BILL_HR
                                                                                        3, --SFRSTCR_WAIV_HR
                                                                                        credit,     --SFRSTCR_CREDIT_HR
                                                                                        credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                                        credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                                        gmod,     --SFRSTCR_GMOD_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE_MID
                                                                                        null,    --SFRSTCR_GRDE_DATE
                                                                                        'N',    --SFRSTCR_DUPL_OVER
                                                                                        'N',    --SFRSTCR_LINK_OVER
                                                                                        'N',    --SFRSTCR_CORQ_OVER
                                                                                        'N',    --SFRSTCR_PREQ_OVER
                                                                                        'N',     --SFRSTCR_TIME_OVER
                                                                                        'N',     --SFRSTCR_CAPC_OVER
                                                                                        'N',     --SFRSTCR_LEVL_OVER
                                                                                        'N',     --SFRSTCR_COLL_OVER
                                                                                        'N',     --SFRSTCR_MAJR_OVER
                                                                                        'N',     --SFRSTCR_CLAS_OVER
                                                                                        'N',     --SFRSTCR_APPR_OVER
                                                                                        'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                                        sysdate,      --SFRSTCR_ADD_DATE
                                                                                        sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                                        levl,     --SFRSTCR_LEVL_CODE
                                                                                        camp,     --SFRSTCR_CAMP_CODE
                                                                                        null,     --SFRSTCR_RESERVED_KEY
                                                                                        null,     --SFRSTCR_ATTEND_HR
                                                                                        'Y',     --SFRSTCR_REPT_OVER
                                                                                        'N' ,    --SFRSTCR_RPTH_OVER
                                                                                        null,    --SFRSTCR_TEST_OVER
                                                                                        'N',    --SFRSTCR_CAMP_OVER
                                                                                        user,    --SFRSTCR_USER
                                                                                        'N',    --SFRSTCR_DEGC_OVER
                                                                                        'N',    --SFRSTCR_PROG_OVER
                                                                                        null,    --SFRSTCR_LAST_ATTEND
                                                                                        null,    --SFRSTCR_GCMT_CODE
                                                                                        'SZFNVIN',    --SFRSTCR_DATA_ORIGIN
                                                                                        sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                                        'N',  --SFRSTCR_DEPT_OVER
                                                                                        'N',  --SFRSTCR_ATTS_OVER
                                                                                        'N', --SFRSTCR_CHRT_OVER
                                                                                        null, --SFRSTCR_RMSG_CDE
                                                                                        null,  --SFRSTCR_WL_PRIORITY
                                                                                        null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                                        null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                                        null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                                        'N', --SFRSTCR_MEXC_OVER
                                                                                        sp,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                                        null,--SFRSTCR_BRDH_SEQ_NUM
                                                                                        '01',--SFRSTCR_BLCK_CODE
                                                                                        null,--SFRSTCR_STRH_SEQNO
                                                                                        null, --SFRSTCR_STRD_SEQNO
                                                                                        null,  --SFRSTCR_SURROGATE_ID
                                                                                        null, --SFRSTCR_VERSION
                                                                                        user,--SFRSTCR_USER_ID
                                                                                        no_recibo );--SFRSTCR_VPDI_CODE



                                                                Begin
                                                                     update ssbsect
                                                                            set ssbsect_enrl = ssbsect_enrl + 1
                                                                      where SSBSECT_TERM_CODE = peri
                                                                      And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                vl_error := 'Se presento un error al actualizar el enrolamiento ' ||sqlerrm;
                                                                End;

                                                                Begin
                                                                        update ssbsect
                                                                            set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                                        where SSBSECT_TERM_CODE = peri
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||sqlerrm;
                                                                End;

                                                                Begin
                                                                         update ssbsect
                                                                                set ssbsect_census_enrl=ssbsect_enrl
                                                                         Where SSBSECT_TERM_CODE = peri
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||sqlerrm;
                                                                End;


                                                                conta_ptrm:=0;

                                                                Begin
                                                                    Select count (*)
                                                                        Into conta_ptrm
                                                                    from sfrareg
                                                                    where SFRAREG_PIDM = c.pidm
                                                                    And SFRAREG_TERM_CODE = peri
                                                                    And SFRAREG_CRN = crn
                                                                    And SFRAREG_EXTENSION_NUMBER = 0
                                                                    And SFRAREG_RSTS_CODE = 'RE';
                                                                Exception
                                                                When Others then
                                                                   conta_ptrm :=0;
                                                                End;

                                                                If conta_ptrm = 0 then

                                                                     Begin
                                                                             insert into sfrareg values(c.pidm, peri, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFNVIN', sysdate, null,null,null);
                                                                     Exception
                                                                       When Others then
                                                                          vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||sqlerrm;
                                                                     End;
                                                                End if;

                                                                  vl_existe :=0;

                                                                  Begin
                                                                     Select count(1)
                                                                     Into vl_existe
                                                                     from SHRINST
                                                                     Where  SHRINST_TERM_CODE = peri
                                                                     And SHRINST_CRN = crn
                                                                     And  SHRINST_PIDM = c.pidm;
                                                                  Exception
                                                                  When Others then
                                                                   vl_existe :=0;
                                                                  End;


                                                                  If vl_existe = 0 then
                                                                        Begin
                                                                            Insert into SHRINST values (peri,        --SHRINST_TERM_CODE
                                                                                                                     crn,       --SHRINST_CRN
                                                                                                                     c.pidm,       --SHRINST_PIDM
                                                                                                                     sysdate,       --SHRINST_ACTIVITY_DATE
                                                                                                                     'Y',       --SHRINST_PRIMARY_IND
                                                                                                                      null,      --SHRINST_SURROGATE_ID
                                                                                                                      null,      --SHRINST_VERSION
                                                                                                                     user,       --SHRINST_USER_ID
                                                                                                                     'SZFNVIN',       --SHRINST_DATA_ORIGIN
                                                                                                                      null);      --SHRINST_VPDI_CODE


                                                                        Exception
                                                                            When Others then
                                                                             vl_error := 'Se presento un error al insertar al alumno en SHRINST ' ||sqlerrm;
                                                                        End;

                                                                  End if;



                                                               Begin
                                                                    Update sgbstdn a
                                                                    set a.SGBSTDN_STYP_CODE ='N'
                                                                    Where a.SGBSTDN_PIDM = c.pidm
                                                                    And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                                           from sgbstdn a1
                                                                                                                           Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                                          --- And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1
                                                                                                                           )
                                                                    -- And a.SGBSTDN_PROGRAM_1 = c.prog
                                                                     ;
                                                                Exception
                                                                    When Others then
                                                                    vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                                                End;

                                                    Exception
                                                   when Others then
                                                       vl_error := 'Se presento un error al insertar al alumno en el grupo ' ||sqlerrm;
                                                   End;


                                  Exception
                                    When Others then
                                      vl_error := 'Se presento un Error al insertar el nuevo grupo 6 ' ||sqlerrm;
                                  End;

                        End if;

                End if;  ------ No hay  CRN Creado

                if vl_error = 'EXITO' then
                    commit; --Commit;
                   -- dbms_output.put_line('mensaje:'||vl_error);
                Else
                -- dbms_output.put_line('mensaje:'||vl_error);
                   rollback;
                End if;
        Else
                -- dbms_output.put_line('mensaje:'|| 'Ya tiene materias Inscritas ');
                null;
        End if; ----> El alumno ya tiene inscrita la materia


    End loop;

  End if;

end carga_inscrip_ni;



PROCEDURE carga_mate(iden varchar2, periodo varchar2, subj varchar2, crse varchar2, calif varchar2, parte varchar2, grupo varchar2)  IS

crn     varchar2(5);
per      varchar2(10);
gpo     number;
mate   varchar2(20);
ciclo    varchar2(6);
sb       varchar2(4);
cr       varchar2(5);
schd   varchar2(3);
title    varchar2(30);
credit decimal(7,3);
gmod  varchar2(1);
f_inicio date;
f_fin     date;
sem     number;
conta_ptrm number;
conta_blck number;
pidm   number;
pidm_doc number;
ests    varchar2(2);
levl     varchar2(2);
camp  varchar2(3);
rsts    varchar2(3);
conta_origen number:=0;
conta_destino number :=0;
conta_origen_ssbsect number:=0;
conta_origen_ssrblck number:=0;
conta_origen_sobptrm number:=0;
sp       integer;
ciclo_ext varchar2(6);
mensaje   varchar2(200);
pidm_prof number;
tckn number;
conta number;
conta2 number;
credit_bill decimal(7,3);

begin

for c in (

select distinct spriden_pidm pidm, spriden_id  iden, sorlcur_program prog, sorlcur_term_code_ctlg ctlg,  smrarul_subj_code subj, smrarul_crse_numb_low crse ,
 parte
from  spriden
join sorlcur s on sorlcur_pidm=spriden_pidm and sorlcur_lmod_code='LEARNER'  --and sorlcur_cact_code='ACTIVE'
and sorlcur_seqno in (select max(sorlcur_seqno) from sorlcur ss
                                                                                                where s.sorlcur_pidm=ss.sorlcur_pidm and s.sorlcur_lmod_code=ss.sorlcur_lmod_code
                                                                                                and     s.sorlcur_program=ss.sorlcur_program)
join smrpaap on smrpaap_program=sorlcur_program and smrpaap_term_code_eff=sorlcur_term_code_ctlg
join smrarul on smrarul_area=smrpaap_area and smrarul_term_code_eff=smrpaap_term_code_eff and smrarul_subj_code=subj
and smrarul_crse_numb_low=crse
where  spriden_id=iden
and spriden_change_ind is null
order by   prog,ctlg, iden

) loop

           -- dbms_output.put_line('pidm:'||c.pidm||' id:'||c.iden||'subj||crse:'||c.subj||c.crse||'programa:'||c.prog||'parte:'||c.parte);

            select scrschd_schd_code, scbcrse_title, scbcrse_credit_hr_low, SCBCRSE_BILL_HR_LOW
            into schd, title, credit, credit_bill
            from scbcrse, scrschd
            where scbcrse_subj_code=c.subj
            and     scbcrse_crse_numb=c.crse
            and     scbcrse_eff_term='000000'
            and     scrschd_subj_code=scbcrse_subj_code
            and     scrschd_crse_numb=scbcrse_crse_numb
            and     scrschd_eff_term=scbcrse_eff_term;

         begin
            select scrgmod_gmod_code
            into gmod
            from scrgmod
            where scrgmod_subj_code=c.subj
            and     scrgmod_crse_numb=c.crse
            and     scrgmod_default_ind='D';
         exception when others then
            gmod:='1';
         end;

          ciclo:=periodo;

                select szvcamp_camp_code into camp from szvcamp
                where szvcamp_camp_alt_code=substr(c.iden,1,2);

               -- dbms_output.put_line('periodo:'||ciclo);
                select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                into f_inicio, f_fin, sem
                from sobptrm
                where sobptrm_term_code=ciclo
                and     sobptrm_ptrm_code=c.parte;

            begin

            select max(ssbsect_crn) into crn
            from ssbsect
            where ssbsect_term_code=periodo
            and ssbsect_subj_code=c.subj
            and ssbsect_crse_numb=c.crse
            and ssbsect_ptrm_code=c.parte
            and ssbsect_seq_numb=grupo;

            exception when others then
            crn:=null;
            end;

           if crn is null then

                select nvl(max(to_number(ssbsect_crn)),1000)+1
                into crn
                from ssbsect where ssbsect_term_code= ciclo;

               -- dbms_output.put_line('ciclo:'||ciclo||' crn:'||crn||' subj||crse:'||c.subj||c.crse);
                insert into ssbsect values( ciclo, crn, c.parte, c.subj, c.crse, grupo, 'A', schd, camp, title, null, credit_bill, gmod, null,null,null,null,'Y',null, 0,0,0,50,0,0,null,'0',f_inicio,  sysdate, f_inicio, f_fin,sem, null,null,null,null, null,null,null,null,
                                                               null,null,null,null,null,null,null, 'Y','N', null,null,null,'NOP',null,null,null,null,null,null,0, '01', 'MIGRA1', null,'B',null,null,null,null,null,null,null,null);
                insert into ssrmeet values(ciclo, crn, null,null,null,null,null,null, sysdate, f_inicio, f_fin, '01', null,null,null,null,null,null,null, 'ENL', null, credit, null, 0, null,null,null, 'CLVI', 'UTEL', 'MIGRA1', null,null,null);
           end if;


             select count(*) into conta_ptrm
             from sfbetrm
             where sfbetrm_term_code=ciclo
             and     sfbetrm_pidm=c.pidm;
             if conta_ptrm =0 then
                   insert into sfbetrm values(ciclo, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,'MIGRA', null,'UTEL', null, 0,null,null, null,null,'MIGRA',null);
             end if;

                select sgbstdn_levl_code, sgbstdn_camp_code  into levl, camp
                from sgbstdn a
                where sgbstdn_pidm=c.pidm
                and     sgbstdn_term_code_eff  in (select max(sgbstdn_term_code_eff) from sgbstdn aa
                                                                   where a.sgbstdn_pidm=aa.sgbstdn_pidm);
                                                                 --  and     aa.sgbstdn_term_code_eff <=  ciclo) ;

                      select distinct max(sorlcur_key_seqno) into sp
                      from sorlcur
                      where sorlcur_pidm=c.pidm
                      and     sorlcur_program=c.prog
                      and     sorlcur_lmod_code='LEARNER';
                  --    and     sorlcur_roll_ind='Y'
                  --    and     sorlcur_current_cde='Y'
                 --     And     SORLCUR_APPL_KEY_SEQNO is not null;

       -- dbms_output.put_line('inscripcion-pidm:'||c.pidm||' crn:'||crn);
        insert into sfrstcr values(ciclo, c.pidm, crn , null, 1,c.parte, 'RE', sysdate, null,null, 3, null, credit, null,credit, gmod, calif, null,null, null,null,null,null,null,null,null,null,null,null, null, null, sysdate, sysdate,
                                                    levl, camp, null, null, null,  null,null,null, null,null,null,null,null, 'UTEL', null,null,null,null,null,null,null,null,null,null,sp,null,'01', null,null,null,null, 'MIGRA1', null);

        insert into sfrareg values(c.pidm, ciclo, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, 'MIGRA1', null,null,null,null,null,null,null,null, 'UTEL', sysdate, null,null,null);


        if calif!=' ' then
            select nvl(max(shrtckn_seq_no),0) +1 into tckn from shrtckn
            where shrtckn_pidm=c.pidm;

            conta:=0;
            select count(*) into conta from shrttrm
            where shrttrm_pidm=c.pidm and shrttrm_term_code=periodo;

            if conta=0 then
               insert into shrttrm values(c.pidm, periodo, 'S', 'N', 'G', sysdate, null, null, null, null, null, null, null, null, sysdate, null, null, null, null, null, null, null, null, null, null, null, 'MIGRA', 'UTEL', null);
            end if;
            select count(*) into conta2 from shrtckn
            where shrtckn_pidm=c.pidm and shrtckn_term_code=periodo and shrtckn_crn=crn;
            if conta2 > 0 then
           -- dbms_output.put_line(c.pidm||' '||periodo||' '||tckn||' '||crn||' '||c.subj||' '||c.crse);
           null;
            else
                insert into shrtckn values(c.pidm, periodo, tckn, crn, c.subj, c.crse, 'PO', 'UTL', '9990', null, null, title, null, c.prog, null, sysdate, '1', '01' , f_inicio, f_fin, null, 'ENL', null, null, null, null, title,
                sp, null, null, 'MIGRA', 'UTEL', null);

                insert into shrtckg values(c.pidm, periodo, tckn, 1, null, calif,1,credit, 'CM', null, sysdate, 'MIGRA', sysdate, 'MIGRAC', periodo, 'UTEL', 'MIGRA', credit, null, null, null, null);

                insert into shrtckl values(c.pidm, periodo, tckn, 'MA', sysdate, 'Y', null, null, 'MIGRA', 'UTEL', null);
            end if;

        end if;


end loop;

commit;

end carga_mate;


PROCEDURE leer_file_carga_nw (p_error out varchar2) IS

 cadena VARCHAR2(32767);
 Vfile UTL_FILE.FILE_TYPE;
 iden         varchar2(20);
 materia    varchar2(20);
 prog         varchar2(20);
 periodo     varchar2(20);
 parte        varchar2(4);
 grupo       varchar2(5);
 calif          varchar2(10);
 fecha       varchar2(10);
 iden_prof  varchar2(10);
 f1             VARCHAR2(10);
 f2             VARCHAR2(10);
 var           number;
 coma        number;
 i               number;
 bimestre   varchar2(1);

BEGIN

 -- En este ejemplo leo una linea del fichero prueba.txt


 -- Abro fichero en lectura (Read)
 Vfile := UTL_FILE.FOPEN('IMAGEN','materias.csv','R',256);
delete from SZCARGA;
commit;

loop
    begin
     -- Leo del fichero
     UTL_FILE.GET_LINE(Vfile,cadena,32767);
     materia:=null; iden:=null; grupo:=null; prog:=null; periodo:=null; parte:=null; iden_prof:=null; var:=0;  fecha := null; calif :=null;

     for i IN 1..70 loop
     -- -- dbms_output.put_line(substr(cadena,i,1)||' '||var);
              if substr(cadena,i,1)=',' then
                if var=0 then
                   iden:=trim(substr(cadena,1,i-1));
                   var:=1;
                   coma:=i;
                else
                   if var=1 then
                      materia:=trim(substr(cadena,coma+1,i-(coma+1)));
                      var:=2;
                      coma:=i;
                   else
                       if var=2 then
                          prog:=trim(substr(cadena,coma+1,i-(coma+1)));
                          var:=3;
                          coma:=i;
                       else
                          if var=3 then
                            periodo:=trim(substr(cadena,coma+1,i-(coma+1)));
                            var:=4;
                            coma:=i;
                          else
                             if var=4 then
                                parte:=trim(substr(cadena,coma+1,i-(coma+1)));
                                var:=5;
                                coma:=i;
                             else
                                 if var=5 then
                                    grupo:=trim(substr(cadena,coma+1,i-(coma+1)));
                                    var:=6;
                                    coma:=i;
                                 else
                                     if var=6 then
                                         calif:=trim(substr(cadena,coma+1,i-(coma+1)));
                                         var:=7;
                                         coma:=i;
                                     Else
                                            if var=7 then
                                              iden_prof:=trim(substr(cadena,coma+1,i-(coma+1)));
                                            -- fecha:=trim(substr(cadena,coma+1,i-(coma+1)));
                                             fecha:=trim(substr(cadena,i+1,10));
                                             var:=8;
                                             coma:=i;
                                           End if;
                                         end if;
                                 end if;
                             end if;
                          end if;
                       end if;
                   end if;
                end if;
             end if;



     end loop;


    -- dbms_output.put_line('iden:'||iden||' materia:'||materia||' '||'prog:'||prog||' '||' periodo:'||periodo||' parte:'||parte||' grupo:'||grupo||' '||'calif:'||calif||' profesor:'||iden_prof||' Fecha:'||fecha);
    --if iden is not null then
        Begin
            insert into SZCARGA values(trim(iden), trim(materia), trim(prog), trim(periodo),trim(parte) , trim(grupo),trim(calif), trim(iden_prof), user, sysdate,to_date(fecha,'dd/mm/yyyy'),null,null);
        Exception
        When Others then
        p_error:=sqlerrm;
       -- dbms_output.put_line('Salida iden:'||iden||' materia:'||materia||' '||'prog:'||prog||' '||' periodo:'||periodo||' parte:'||parte||' grupo:'||grupo||' '||'calif:'||calif||' profesor:'||iden_prof||' Fecha:'||fecha);
        End;
    --end if;

    exception
      when NO_DATA_FOUND  then

      --p_error:=sqlerrm;
      exit;
     when OTHERS  then
      p_error:=sqlerrm;
      exit;
    end;
end loop;

 commit;
 UTL_FILE.FCLOSE(Vfile);

--delete from szfcarg
--where szcarga_term_code in (select szcarga_term_code from szcarga)
--and     szcarga_ptrm_code in (select szcarga_ptrm_code from szcarga);
--commit;
--
--insert into szfcarg
--select * from szcarga;
--commit;

 -- Muestro por partalla la linea

END leer_file_carga_nw;




PROCEDURE carga_inscrip_nw  (pn_fecha  in varchar2 ) is

---este proceso es el de carga de materias en szcarga---
----------------------------------ESTE ES EL QUE ESTA BIEN HAY QUE PASAR SOLO LO NUEVO FOR  Y BANDERAS  VIC-----



crn     varchar2(5);
gpo     number;
mate   varchar2(20);
ciclo    varchar2(6);
subj       varchar2(4);
crse       varchar2(5);
sb       varchar2(4);
cr       varchar2(5);
schd   varchar2(3);
title    varchar2(30);
credit decimal(7,3);
credit_bill decimal(7,3);
gmod  varchar2(1);
f_inicio date;
f_fin     date;
sem     number;
conta_ptrm number;
conta_blck number;
pidm   number;
pidm_doc number;
pidm_doc2 number;
ests    varchar2(2);
levl     varchar2(2);
camp  varchar2(3);
rsts    varchar2(3);
conta_origen number:=0;
conta_destino number :=0;
conta_origen_ssbsect number:=0;
conta_origen_ssrblck number:=0;
conta_origen_sobptrm number:=0;
sp       integer;
ciclo_ext varchar2(6);
mensaje   varchar2(200);
parte varchar2(3);
pidm_prof number;
per    varchar2(6);
grupo varchar2(4);
conta_sirasgn number;
fecha_ini date;
vl_existe number :=0;

vn_lugares number:=0;
vn_cupo_max number:=0;
vn_cupo_act number:=0;
vl_error varchar2 (2500):= 'EXITO';

parteper_cur  varchar2(3);
period_cur varchar2(10);
vl_jornada varchar2(250):=null;
vl_exite_prof number :=0;
VBANDERA   NUMBER;
no_recibo   NUMBER;
vmes         varchar2(5);
vdia         number;
vcrn    varchar2(3);
Vlvel_parte   varchar2(4);
l_campus_ms    varchar2(4);

--niv     varchar2(1);
-- se agrego SZTMACO para compactaci??e Materias Juan Jess Corona Miranda 21/08/2018

cursor c_no_proce is
select *
                    from szcarga carg
                    where  1=1
                    --and carg.SZCARGA_ID='010078157'
                    and not exists (select 1
                                         from SZCARGA
                                        join spriden on spriden_id=szcarga_id and spriden_change_ind is null
                                        join  sgbstdn d on  d.sgbstdn_pidm=spriden_pidm
                                        And d.SGBSTDN_TERM_CODE_EFF = (select max (b1.SGBSTDN_TERM_CODE_EFF)
                                                                           from SGBSTDN b1
                                                                           Where d.sgbstdn_pidm = b1.sgbstdn_pidm
                                                                           AND d.sgbstdn_program_1 = b1.sgbstdn_program_1
                                                                           )
                                        join sorlcur s on sorlcur_pidm=spriden_pidm
                                                and s.sorlcur_program=szcarga_program
                                                and s.sorlcur_lmod_code='LEARNER'
                                                and s.sorlcur_seqno in (select max(ss.sorlcur_seqno)
                                                                                from sorlcur ss
                                                                                where s.sorlcur_pidm=ss.sorlcur_pidm
                                                                                and s.sorlcur_lmod_code=ss.sorlcur_lmod_code
                                                                                and     s.sorlcur_program=ss.sorlcur_program)
                                        join smrpaap on smrpaap_program=sorlcur_program
                                                and smrpaap_term_code_eff=sorlcur_term_code_ctlg
                                        join sztmaco on SZTMACO_MATPADRE =szcarga_materia
                                        join smrarul on smrarul_area=smrpaap_area
                                                and smrarul_term_code_eff=smrpaap_term_code_eff
                                        left outer join sztdtec on sztdtec_program=sorlcur_program
                                                and sztdtec_term_code=sorlcur_term_code_ctlg
                                        where  smrarul_subj_code||smrarul_crse_numb_low=SZTMACO_MATHIJO
                                        and carg.SZCARGA_ID=spriden_id
                                        and carg.SZCARGA_MATERIA = SZCARGA_MATERIA
                                        and carg.SZCARGA_PROGRAM=SZCARGA_PROGRAM
                                        and carg.SZCARGA_FECHA_INI=SZCARGA_FECHA_INI
                                  --      and szcarga_materia = 'M1ED116'
                                        ) ;


begin

fecha_ini:=to_date(pn_fecha,'dd/mm/rrrr');
--  vl_error := 'Se presento un Error NO se encuentra Cursor inicial REVISAR:: '||sqlerrm;


for  jump in (

select *   from SZCARGA   where  1=1
                    and  trunc(SZCARGA_ACTIVITY_DATE) = trunc(sysdate)
                    AND SZCARGA_NO_REGLA IS NULL
                  --  And SZCARGA_ID = '020273699'

                     ) loop

VBANDERA := 0;
--dbms_output.put_line('procesa 1 :: '|| VBANDERA ||'-'|| jump.SZCARGA_ID||'-'|| jump.SZCARGA_MATERIA );

for c in (


select distinct spriden_pidm pidm,
                      szcarga_id iden  ,
                      szcarga_program prog,
                      sorlcur_camp_code campus,
                      sorlcur_levl_code nivel,
                      sorlcur_term_code_ctlg ctlg ,
                      szcarga_materia  materia ,
                       smrarul_subj_code subj,
                        smrarul_crse_numb_low crse ,
                        szcarga_term_code periodo ,
                        szcarga_ptrm_code parte,
                        decode(sztdtec_periodicidad,1,'BIMESTRAL',2,'CUATRIMESTRAL') periodicidad,
                        szcarga_grupo grupo,
                        szcarga_calif calif,
                        szcarga_id_prof prof,
                        SZCARGA_FECHA_INI Fecha_Inicio,
                        SORLCUR_KEY_SEQNO study, d.SGBSTDN_STST_CODE
from SZCARGA a
join spriden on spriden_id=szcarga_id and spriden_change_ind is null
join  sgbstdn d on  d.sgbstdn_pidm=spriden_pidm
And d.SGBSTDN_TERM_CODE_EFF = (select max (b1.SGBSTDN_TERM_CODE_EFF)
                                                       from SGBSTDN b1
                                                       Where d.sgbstdn_pidm = b1.sgbstdn_pidm
                                                       AND d.sgbstdn_program_1 = b1.sgbstdn_program_1
                                                       )
join sorlcur s on sorlcur_pidm=spriden_pidm
AND s.sorlcur_pidm = d.sgbstdn_pidm
--AND s.sorlcur_program = d.sgbstdn_program_1
and sorlcur_program=szcarga_program
and sorlcur_lmod_code='LEARNER'
and sorlcur_seqno in (select max(sorlcur_seqno)
                                            from sorlcur ss
                                            where s.sorlcur_pidm=ss.sorlcur_pidm
                                            and s.sorlcur_lmod_code=ss.sorlcur_lmod_code
                                            and     s.sorlcur_program=ss.sorlcur_program)
left outer join sztdtec on sztdtec_program=sorlcur_program and sztdtec_term_code=sorlcur_term_code_ctlg
join smrpaap on smrpaap_program=sorlcur_program and smrpaap_term_code_eff=sorlcur_term_code_ctlg
join sztmaco on SZTMACO_MATPADRE=szcarga_materia
join smrarul on smrarul_area=smrpaap_area and smrarul_term_code_eff=smrpaap_term_code_eff
where   (smrarul_subj_code||smrarul_crse_numb_low) = SZTMACO_MATHIJO
-- And SZCARGA_ID = '070220053'
and szcarga_id = JUMP.szcarga_id
and SZCARGA_MATERIA = jump.SZCARGA_MATERIA
order by  iden, 10


) loop

VBANDERA := 1;
--------------- Limpia Variables  --------------------
--niv :=  null;
parte := null;
crn := null;
pidm_doc2 := null;
conta_sirasgn := null;
pidm_doc := null;
f_inicio := null;
f_fin := null;
sem := null;
schd := null;
title := null;
credit := null;
credit_bill :=null;
levl := null;
camp := null;
mate := null;
parte := null;
per := null;
grupo := null;
vl_existe :=0;
vl_error := 'EXITO';
vn_lugares :=0;
vn_cupo_max :=0;
vn_cupo_act :=0;

parteper_cur  :=null;
period_cur :=null;
vl_exite_prof :=0;
no_recibo   := '';

--dbms_output.put_line('procesa 2 :: '|| VBANDERA ||'-'|| jump.SZCARGA_ID );
--------------calcula el numero de recibo al cual se va asociar la materia con la cartera glovicx 30/1/2020
           Begin
                select distinct max(sorlcur_key_seqno)
                    into sp
                from sorlcur
                where sorlcur_pidm=c.pidm
                and     sorlcur_program=c.prog
                and     sorlcur_lmod_code='LEARNER';
            Exception
               when Others then
                  sp := null;
                  vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||c.iden || c.subj ||c.crse ||sqlerrm;
            End;

          begin
            select to_char(to_date(c.Fecha_Inicio, 'DD/MM/YYYY'), 'DD')
            INTO vdia
            from dual;
          Exception
               when Others then
                  vmes := 0;
               --   vl_error := 'Se presento un error al obtener la informacion de SORLCUR ' ||c.iden || c.subj ||c.crse ||sqlerrm;
          End;


            if vdia >= 20 then
               vmes := '+1';
             else
                 vmes := '1';
            end if;
                  --dbms_output.put_line('salida antes de buscar no orden en tbraccd'|| vmes||'--'||vdia||'---'|| c.Fecha_Inicio );

          begin

            select distinct(SFRSTCR_LEVL_CODE)
                INTO Vlvel_parte
             FROM SFRSTCR f, ssbsect b
               WHERE     F.SFRSTCR_CRN      = B.SSBSECT_CRN
                  AND F.SFRSTCR_TERM_CODE   = B.SSBSECT_TERM_CODE
                  and SSBSECT_PTRM_CODE    = c.parte
                         ;


            exception when others then
             Vlvel_parte := '';
            end;

               --------aqui validaos la parte de periodo cuando sea un 2 en la segunda posision no recorren el mes
               --------regla la valido VIC ramrz 06/03/2020
          if  substr(c.parte,2,1)   = '2'  then
               begin


                  select DISTINCT max(TBRACCD_RECEIPT_NUMBER)
                    into  no_recibo
                    from tbraccd
                   where 1=1
                AND  TBRACCD_DETAIL_CODE IN ( SELECT DISTINCT TBBDETC_DETAIL_CODE
                                               FROM TBBDETC
                                                 where 1=1
                                                 AND UPPER(TBBDETC_DESC) like('COLEGIATURA%')
                                                 AND TBBDETC_TYPE_IND  = 'C'
                                                 AND TBBDETC_DCAT_CODE  = 'COL')
                AND  TBRACCD_RECEIPT_NUMBER IS NOT  NULL
                and  TBRACCD_PIDM     = c.pidm
                and  TBRACCD_STSP_KEY_SEQUENCE  = sp --study
                and  TBRACCD_PERIOD             = c.parte
                and  TBRACCD_TERM_CODE          = c.periodo
                AND TBRACCD_DESC != 'COLEGIATURA LIC NOTA'
                AND TBRACCD_DESC != 'COLEGIATURA EXTRAORDINARIO'
                ;


              exception when others then
                       no_recibo := '';
              end ;
          else
                       begin


                              select DISTINCT max(TBRACCD_RECEIPT_NUMBER)
                                into  no_recibo
                                from tbraccd
                               where 1=1
                            AND  TBRACCD_DETAIL_CODE IN ( SELECT DISTINCT TBBDETC_DETAIL_CODE
                                                           FROM TBBDETC
                                                             where 1=1
                                                             AND UPPER(TBBDETC_DESC) like('COLEGIATURA%')
                                                             AND TBBDETC_TYPE_IND  = 'C'
                                                             AND TBBDETC_DCAT_CODE  = 'COL')
                            AND  TBRACCD_RECEIPT_NUMBER IS NOT  NULL
                            and  TBRACCD_PIDM     = c.pidm
                            and  TBRACCD_STSP_KEY_SEQUENCE  = sp --study
                            and to_char(to_date(TBRACCD_EFFECTIVE_DATE, 'DD/MM/YYYY'), 'MM/YY') = TO_CHAR(ADD_MONTHS(c.Fecha_Inicio,vmes),'MM/YY')  --  (SELECT EXTRACT(MONTH FROM sysdate) FROM dual) -- mes actual o mes que sigue
                            AND TBRACCD_DESC != 'COLEGIATURA LIC NOTA'
                            AND TBRACCD_DESC != 'COLEGIATURA EXTRAORDINARIO'
                            ;


                       exception when others then
                               no_recibo := '';
                       end ;


               end if;



--   insert into twpasow(valor1, valor2, valor3, valor4, valor5, valor6, valor7, valor8, valor9, valor10)
--                      values('szfcarg_no_recibox', c.pidm,  c.subj||c.crse, vdia,vmes,  c.Fecha_Inicio,f_inicio,  sp,no_recibo, sysdate  );
--                      commit;
    -----esta validacion la pidio Fernando G.  y se creo el parametro para dejar pasar a los alumnos que aparezcan
    ----- en este paramtrizador  glovicx 12/03/2020
    ----esta nueva validacion anula la anterior donde se validada el periodo que fuera 8 o 9 (nive,ss) segun FER
 for alt in (select ZSTPARA_PARAM_VALOR as alum_sin_restriccion   from zstpara z
                  where 1=1
                      and Z.ZSTPARA_MAPA_ID  = 'SIN_RESTRICCION') loop
vl_error := 'EXITO';




--  iF C.SGBSTDN_STST_CODE not in  ('X') and Vlvel_parte = c.nivel then
 -- IF C.SGBSTDN_STST_CODE not in ('BT','BI','BD','EG','SG','CV') OR SUBSTR(C.periodo,5,1) in  ('8','9')  and Vlvel_parte = c.nivel then
--------------------- Se valida que el alumno no tenga la materia sembrada en el horario como Activa ---------------------------------------
 IF C.SGBSTDN_STST_CODE not in ('BT','BI','BD','EG','SG','CV') or SUBSTR(C.periodo,5,1) in  ('8','9')
         OR   c.iden = alt.alum_sin_restriccion and Vlvel_parte = c.nivel    then

        begin
                --existe y es aprobatoria
                select count (1), SFRSTCR_TERM_CODE, SFRSTCR_PTRM_CODE
                    into vl_existe, period_cur, parteper_cur
                from ssbsect, sfrstcr, SHRGRDE
                where sfrstcr_pidm=c.pidm
                --and sfrstcr_term_code=c.periodo
                and ssbsect_term_code=sfrstcr_term_code
                and SFRSTCR_PTRM_CODE = SSBSECT_PTRM_CODE
                and ssbsect_crn=sfrstcr_crn
                and ssbsect_subj_code=c.subj
                and ssbsect_crse_numb=c.crse
                and SFRSTCR_RSTS_CODE = 'RE'
                AND (SFRSTCR_GRDE_CODE = SHRGRDE_CODE
                                         OR SFRSTCR_GRDE_CODE IS NULL)
                AND SHRGRDE_PASSED_IND = 'Y'
                AND SHRGRDE_LEVL_CODE= C.NIVEL
                group by SFRSTCR_TERM_CODE, SFRSTCR_PTRM_CODE;

        Exception
         when others then
             vl_existe:=0;
        end;

        If vl_existe = 0 then
         --   dbms_output.put_line ('salida  1 ');
            ---- Se busca que exista el grupo y tenga cupo

                If  c.prof is null then
                   -- dbms_output.put_line ('sin profesor '||vl_existe);
                        begin
                               select a.ssbsect_crn , a.ssbsect_seats_avail lugares, a.ssbsect_max_enrl cupo_max, a.SSBSECT_PTRM_CODE,
                                        a.ssbsect_enrl cupo_Act,    a.SSBSECT_PTRM_START_DATE, a.SSBSECT_PTRM_END_DATE, a.SSBSECT_PTRM_WEEKS,
                                        a.SSBSECT_CREDIT_HRS, a.SSBSECT_BILL_HRS, a.SSBSECT_GMOD_CODE
                                into crn , vn_lugares, vn_cupo_max, parte,
                                       vn_cupo_act, f_inicio, f_fin, sem,
                                       credit, credit_bill, gmod
                                from ssbsect a
                                where a.SSBSECT_TERM_CODE= c.periodo
                                and a.ssbsect_subj_code= c.subj
                               and a.ssbsect_crse_numb=c.crse
                               and a.SSBSECT_SEQ_NUMB = c.grupo
                                and trunc (a.SSBSECT_PTRM_START_DATE) = c.Fecha_Inicio
                                And a.ssbsect_seats_avail = (select max (a1.ssbsect_seats_avail)
                                                                            from ssbsect a1
                                                                            Where a.SSBSECT_TERM_CODE = a1.SSBSECT_TERM_CODE
                                                                            And a.ssbsect_subj_code = a1.ssbsect_subj_code
                                                                            And a.ssbsect_crse_numb = a1.ssbsect_crse_numb
                                                                            And a.SSBSECT_SEQ_NUMB = a1.SSBSECT_SEQ_NUMB
                                                                            And trunc (a.SSBSECT_PTRM_START_DATE) = trunc (a1.SSBSECT_PTRM_START_DATE)
                                                                            )
                                    and rownum < 2;
                        Exception
                        when others then
                            crn:=null;
                            vn_lugares :=0;
                            vn_cupo_max:=0;
                            vn_cupo_act:=0;
                            f_inicio := null;
                            f_fin := null;
                            sem := null;
                            credit  := null;
                            credit_bill  := null;
                            gmod  := null;
                        end;
                Else
                         --   dbms_output.put_line ('con profesor '||vl_existe);

                       begin
                               select a.ssbsect_crn , a.ssbsect_seats_avail lugares, a.ssbsect_max_enrl cupo_max, a.SSBSECT_PTRM_CODE,
                                          a.ssbsect_enrl cupo_Act,    a.SSBSECT_PTRM_START_DATE, a.SSBSECT_PTRM_END_DATE, a.SSBSECT_PTRM_WEEKS,
                                          a.SSBSECT_CREDIT_HRS,  a.SSBSECT_BILL_HRS, a.SSBSECT_GMOD_CODE
                                into crn , vn_lugares, vn_cupo_max, parte,
                                       vn_cupo_act, f_inicio, f_fin, sem,
                                       credit, credit_bill, gmod
                                from ssbsect a, sirasgn
                                where a.SSBSECT_TERM_CODE= c.periodo
                                and a.ssbsect_subj_code= c.subj
                               and a.ssbsect_crse_numb=c.crse
                               and a.SSBSECT_SEQ_NUMB = c.grupo
                                and trunc (a.SSBSECT_PTRM_START_DATE) = c.Fecha_Inicio
                                 And SIRASGN_TERM_CODE = a.SSBSECT_TERM_CODE
                                 And a.SSBSECT_CRN = SIRASGN_CRN
                                 And SIRASGN_PIDM = (select distinct  spriden_pidm
                                                                    from spriden
                                                                    where spriden_id = c.prof
                                                                    And spriden_change_ind is null )
                                And SIRASGN_PRIMARY_IND = 'Y'
                                And a.ssbsect_seats_avail = (select max (a1.ssbsect_seats_avail)
                                                                            from ssbsect a1
                                                                            Where a.SSBSECT_TERM_CODE = a1.SSBSECT_TERM_CODE
                                                                            And a.ssbsect_subj_code = a1.ssbsect_subj_code
                                                                            And a.ssbsect_crse_numb = a1.ssbsect_crse_numb
                                                                            And a.SSBSECT_SEQ_NUMB = a1.SSBSECT_SEQ_NUMB
                                                                            And trunc (a.SSBSECT_PTRM_START_DATE) = trunc (a1.SSBSECT_PTRM_START_DATE)
                                                                            )
                                   and rownum < 2;
                       Exception
                        when others then
                            crn:=null;
                            vn_lugares :=0;
                            vn_cupo_max:=0;
                            vn_cupo_act:=0;
                            f_inicio := null;
                            f_fin := null;
                            sem := null;
                            credit  := null;
                            credit_bill  := null;
                            gmod  := null;
                       end;

                End if;
     --       dbms_output.put_line ('salida  2 '|| crn);
                If crn is not null then
                  --dbms_output.put_line ('CRN no es null '||crn);

                    If vn_lugares >0  then

                            If credit is null  then
                               Begin
                                      select SSRMEET_CREDIT_HR_SESS
                                       Into credit
                                      from SSRMEET
                                      where SSRMEET_TERM_CODE = c.periodo
                                      And SSRMEET_CRN = crn;
                               Exception
                                When Others then
                                   credit :=null;
                                End;

                                  If credit is not null then
                                           Begin
                                               Update ssbsect
                                               set  SSBSECT_CREDIT_HRS = credit
                                               where SSBSECT_TERM_CODE = c.periodo
                                               and SSBSECT_CRN = crn;
                                           Exception
                                           when Others then
                                                null;
                                           End;
                                  End if;
                           End if;

                           If credit_bill is null then
                               credit_bill := 1;
                                  If credit is not null then
                                           Begin
                                               Update ssbsect
                                               set  SSBSECT_BILL_HRS = credit_bill
                                               where SSBSECT_TERM_CODE = c.periodo
                                               and SSBSECT_CRN = crn;
                                           Exception
                                           when Others then
                                                null;
                                           End;
                                  End if;
                           End if;

                          If gmod is null or  gmod = 0  then
                                begin
                                    select scrgmod_gmod_code
                                    into gmod
                                    from scrgmod
                                    where scrgmod_subj_code=c.subj
                                    and     scrgmod_crse_numb=c.crse
                                    and     scrgmod_default_ind='D';
                                exception when others then
                                    gmod:='1';
                                end;

                                If gmod is not null then
                                           Begin
                                               Update ssbsect
                                               set  SSBSECT_GMOD_CODE = gmod
                                               where SSBSECT_TERM_CODE = c.periodo
                                               and SSBSECT_CRN = crn;
                                           Exception
                                           when Others then
                                                null;
                                           End;
                                end if;

                          End if;

                          begin
                                select spriden_pidm into pidm_prof
                                from  spriden
                                where   spriden_id=c.prof and spriden_change_ind is null;
                          Exception when others then
                              pidm_prof:=null;
                          End;

                            conta_ptrm :=0;
                          Begin
                            Select count (1)
                                Into conta_ptrm
                            from sirasgn
                            Where SIRASGN_TERM_CODE = c.periodo
                            And SIRASGN_CRN = crn
                            and  SIRASGN_PIDM = pidm_prof
                            And SIRASGN_PRIMARY_IND = 'Y';
                          Exception
                          When Others then
                           conta_ptrm :=0;
                          End;



                            if pidm_prof is not null and conta_ptrm = 0 then
                                Begin
                                        insert into sirasgn values(c.periodo, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,  sysdate, null,null,null,null, 'SZFCARG', user, null, null, null, null,  null,null);
                                Exception
                                When Others then
                                null;
                                End;
                            end if;

                             conta_ptrm :=0;

                            Begin
                                 select count(*)
                                    into conta_ptrm
                                 from sfbetrm
                                 where sfbetrm_term_code=c.periodo
                                 and     sfbetrm_pidm=c.pidm;
                            Exception
                                When Others then
                                  conta_ptrm := 0;
                            End;


                             if conta_ptrm =0 then
                                    Begin
                                            insert into sfbetrm values(c.periodo, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFCARG', null, 0,null,null, null,null,user,null);
                                    Exception
                                    When Others then
                                        vl_error := ('Se presento un error al insertar en la tabla sfbetrm ' || sqlerrm);
                                    End;
                             end if;

                       -- dbms_output.put_line ('salida  3 antes de insert sfrstcr '||c.periodo||'-'||parte  );
                           Begin

                               insert into sfrstcr values(
                                                                c.periodo,     --SFRSTCR_TERM_CODE
                                                                c.pidm,     --SFRSTCR_PIDM
                                                                crn,     --SFRSTCR_CRN
                                                                null,     --SFRSTCR_CLASS_SORT_KEY
                                                                c.grupo,    --SFRSTCR_REG_SEQ
                                                                parte,    --SFRSTCR_PTRM_CODE
                                                                'RE',     --SFRSTCR_RSTS_CODE
                                                                sysdate,    --SFRSTCR_RSTS_DATE
                                                                null,    --SFRSTCR_ERROR_FLAG
                                                                null,    --SFRSTCR_MESSAGE
                                                                credit_bill,    --SFRSTCR_BILL_HR
                                                                3, --SFRSTCR_WAIV_HR
                                                                credit,     --SFRSTCR_CREDIT_HR
                                                                credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                gmod,     --SFRSTCR_GMOD_CODE
                                                                null,    --SFRSTCR_GRDE_CODE
                                                                null,    --SFRSTCR_GRDE_CODE_MID
                                                                null,    --SFRSTCR_GRDE_DATE
                                                                'N',    --SFRSTCR_DUPL_OVER
                                                                'N',    --SFRSTCR_LINK_OVER
                                                                'N',    --SFRSTCR_CORQ_OVER
                                                                'N',    --SFRSTCR_PREQ_OVER
                                                                'N',     --SFRSTCR_TIME_OVER
                                                                'N',     --SFRSTCR_CAPC_OVER
                                                                'N',     --SFRSTCR_LEVL_OVER
                                                                'N',     --SFRSTCR_COLL_OVER
                                                                'N',     --SFRSTCR_MAJR_OVER
                                                                'N',     --SFRSTCR_CLAS_OVER
                                                                'N',     --SFRSTCR_APPR_OVER
                                                                'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                sysdate,      --SFRSTCR_ADD_DATE
                                                                sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                c.nivel,     --SFRSTCR_LEVL_CODE
                                                                c.campus,     --SFRSTCR_CAMP_CODE
                                                                 c.materia,     --SFRSTCR_RESERVED_KEY
                                                                null,     --SFRSTCR_ATTEND_HR
                                                                'Y',     --SFRSTCR_REPT_OVER
                                                                'N' ,    --SFRSTCR_RPTH_OVER
                                                                null,    --SFRSTCR_TEST_OVER
                                                                'N',    --SFRSTCR_CAMP_OVER
                                                                user,    --SFRSTCR_USER
                                                                'N',    --SFRSTCR_DEGC_OVER
                                                                'N',    --SFRSTCR_PROG_OVER
                                                                null,    --SFRSTCR_LAST_ATTEND
                                                                null,    --SFRSTCR_GCMT_CODE
                                                                'SZFCARG',    --SFRSTCR_DATA_ORIGIN
                                                                sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                'N',  --SFRSTCR_DEPT_OVER
                                                                'N',  --SFRSTCR_ATTS_OVER
                                                                'N', --SFRSTCR_CHRT_OVER
                                                                null, --SFRSTCR_RMSG_CDE
                                                                null,  --SFRSTCR_WL_PRIORITY
                                                                null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                'N', --SFRSTCR_MEXC_OVER
                                                                c.study,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                null,--SFRSTCR_BRDH_SEQ_NUM
                                                                '01',--SFRSTCR_BLCK_CODE
                                                                null,--SFRSTCR_STRH_SEQNO
                                                                null, --SFRSTCR_STRD_SEQNO
                                                                null,  --SFRSTCR_SURROGATE_ID
                                                                null, --SFRSTCR_VERSION
                                                                user,--SFRSTCR_USER_ID
                                                                no_recibo );--SFRSTCR_VPDI_CODE



                                        Begin
                                             update ssbsect
                                                    set ssbsect_enrl = ssbsect_enrl + 1
                                              where SSBSECT_TERM_CODE = C.PERIODO
                                              And SSBSECT_CRN  = crn;
                                        Exception
                                        When Others then
                                        vl_error := 'Se presento un error al actualizar el enrolamiento ' ||sqlerrm;
                                        End;

                                        Begin
                                                update ssbsect
                                                    set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                where SSBSECT_TERM_CODE = c.periodo
                                                 And SSBSECT_CRN  = crn;
                                        Exception
                                        When Others then
                                            vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||sqlerrm;
                                        End;

                                        Begin
                                                 update ssbsect
                                                        set ssbsect_census_enrl=ssbsect_enrl
                                                 Where SSBSECT_TERM_CODE = c.periodo
                                                 And SSBSECT_CRN  = crn;
                                        Exception
                                        When Others then
                                            vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||sqlerrm;
                                        End;

                                        Begin
                                            Update sgbstdn a
                                            set a.SGBSTDN_STYP_CODE ='C'
                                            Where a.SGBSTDN_PIDM = c.pidm
                                            And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                   from sgbstdn a1
                                                                                                   Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                   And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1)
                                             And a.SGBSTDN_PROGRAM_1 = c.prog;
                                        Exception
                                            When Others then
                                            vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                        End;

                                        f_inicio := null;

                                         Begin
                                                select distinct sobptrm_start_date
                                                into f_inicio
                                                from sobptrm
                                                where sobptrm_term_code=c.periodo
                                                and     sobptrm_ptrm_code=c.parte;
                                         Exception
                                         When Others then
                                           f_inicio := null;
                                            vl_error := 'Se presento un error al Obtener la fecha de inicio de Clases ' ||sqlerrm;
                                         End;
                         --   dbms_output.put_line ('salida  4 fechas de inicio  '||c.periodo||'-'||parte  );
                                        If f_inicio is not null then

                                            Begin-------se activa esta opci?? petici??e Fer gallegos solo para periodos que no sean NIVE o SERVsoc. 24092019
                                              null;
                                                    Update sorlcur
                                                    set sorlcur_start_date  = trunc (f_inicio)
                                                    Where SORLCUR_PIDM = c.pidm
                                                    And SORLCUR_PROGRAM = c.prog
                                                    And SORLCUR_LMOD_CODE = 'LEARNER'
                                                    And SORLCUR_KEY_SEQNO = c.study
                                                    and  substr(c.periodo,5,1)  not in (8,9)
                                                    ;

                                            Exception
                                                When Others then
                                                   vl_error := 'Se presento un error al actualizar la fecha de Inicio de Clases en sorlcur ' ||sqlerrm;
                                            End;

                                        End if;

                                        conta_ptrm:=0;

                                        Begin
                                            Select count (*)
                                                Into conta_ptrm
                                            from sfrareg
                                            where SFRAREG_PIDM = c.pidm
                                            And SFRAREG_TERM_CODE = c.periodo
                                            And SFRAREG_CRN = crn
                                            And SFRAREG_EXTENSION_NUMBER = 0
                                            And SFRAREG_RSTS_CODE = 'RE';
                                        Exception
                                        When Others then
                                           conta_ptrm :=0;
                                        End;

                                        If conta_ptrm = 0 then

                                             Begin
                                                     insert into sfrareg values(c.pidm, c.periodo, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFCARG', sysdate, null,null,null);
                                             Exception
                                               When Others then
                                                  vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||sqlerrm;
                                             End;
                                        End if;


                                       Begin
                                         Select count(1)
                                         Into vl_existe
                                         from SHRINST
                                         Where  SHRINST_TERM_CODE = c.periodo
                                         And SHRINST_CRN = crn
                                         And  SHRINST_PIDM = c.pidm;
                                       Exception
                                       When Others then
                                       vl_existe :=0;
                                       End;


                                      If vl_existe = 0 then
                                            Begin
                                                Insert into SHRINST values (c.periodo,        --SHRINST_TERM_CODE
                                                                                         crn,       --SHRINST_CRN
                                                                                         c.pidm,       --SHRINST_PIDM
                                                                                         sysdate,       --SHRINST_ACTIVITY_DATE
                                                                                         'Y',       --SHRINST_PRIMARY_IND
                                                                                          null,      --SHRINST_SURROGATE_ID
                                                                                          null,      --SHRINST_VERSION
                                                                                         user,       --SHRINST_USER_ID
                                                                                         'SZFCARG',       --SHRINST_DATA_ORIGIN
                                                                                          null);      --SHRINST_VPDI_CODE


                                            Exception
                                                When Others then
                                                 vl_error := 'Se presento un error al insertar al alumno en SHRINST ' ||sqlerrm;
                                            End;

                                      End if;



                            Exception
                           when Others then
                               vl_error := 'Se presento un error al insertar al alumno en el grupo ' ||sqlerrm;
                           End;

                    Else
                --      dbms_output.put_line('mensaje:'|| 'No hay grupo creado linea 632 ');
                            schd := null;
                            title := null;
                            credit := null;
                            gmod :=null;
                            f_inicio :=null;
                            f_fin :=null;
                            sem :=null;
                             credit_bill := null;

                            Begin
                                 select scrschd_schd_code, scbcrse_title, scbcrse_credit_hr_low, SCBCRSE_BILL_HR_LOW
                                into schd, title, credit, credit_bill
                                from scbcrse, scrschd
                                where scbcrse_subj_code=c.subj
                                and     scbcrse_crse_numb=c.crse
                                and     scbcrse_eff_term='000000'
                                and     scrschd_subj_code=scbcrse_subj_code
                                and     scrschd_crse_numb=scbcrse_crse_numb
                                and     scrschd_eff_term=scbcrse_eff_term;
                            Exception
                            When Others then
                                  schd := null;
                                  title := null;
                                  credit := null;
                                   credit_bill := null;
                            End;


                            begin
                                select scrgmod_gmod_code
                                      into gmod
                                from scrgmod
                                where scrgmod_subj_code=c.subj
                                and     scrgmod_crse_numb=c.crse
                                and     scrgmod_default_ind='D';
                            exception when others then
                                gmod:='1';
                            end;

                             Begin


                                            if c.nivel ='MS' then
                                                        l_campus_ms:='AS';
                                              else
                                                        l_campus_ms:=c.niVel;
                                            end if;

                                             BEGIN

                                                select sztcrnv_crn
                                                into crn
                                                from SZTCRNV
                                                where 1 = 1
                                                and rownum = 1
                                                AND SZTCRNV_LVEL_CODE = SUBSTR(l_campus_ms,1,1)
                                                and (SZTCRNV_crn,SZTCRNV_LVEL_CODE) not in (select to_number(crn),
                                                                                                   substr(SSBSECT_CRN,1,1)
                                                                                           from
                                                                                           (
                                                                                           select case when
                                                                                                          substr(SSBSECT_CRN,1,1) in(SELECT ZSTPARA_PARAM_VALOR
                                                                                                        FROM ZSTPARA
                                                                                                        WHERE 1=1
                                                                                                        AND ZSTPARA_MAPA_ID =  'LETRAS_CRN') then to_number(substr(SSBSECT_CRN,2,10))
                                                                                                         else
                                                                                                        to_number(SSBSECT_CRN)
                                                                                            end crn,
                                                                                                         SSBSECT_CRN
                                                                                               from ssbsect
                                                                                               where 1 = 1
                                                                                               and ssbsect_term_code=  c.periodo
                                                --                                               AND SUBSTR(SSBSECT_CRN,1,1) !='L'
                                                                                           )
                                                                                           where 1 = 1
                                                                                           );

                                                              --------si estra aqui entonces le agrega su letra
                                                if c.nivel ='LI' then
                                                crn:='L'||crn;

                                                elsif  c.nivel ='MA' then
                                                crn:='M'||crn;

                                                elsif  c.nivel ='MS' then
                                                crn:='A'||crn;

                                                elsif  c.nivel ='DO' then
                                                crn:='D'||crn;

                                                elsif  c.nivel ='BA' then
                                                 crn:='B'||crn;

                                                elsif  c.nivel ='EC' then
                                                 crn:='E'||crn;

                                                elsif  c.nivel ='ID' then
                                                 crn:='I'||crn;

                                              end if;

                                             EXCEPTION WHEN OTHERS THEN
                                               -- raise_application_error (-20002,'Error al 2  '|| SQLCODE||' Error: '||SQLERRM);
                                         --       dbms_output.put_line(' error en crn 2 '||sqlerrm);
                                                crn := NULL;
                                             END;



                              Exception
                                    When Others then
                                           -------esto es por que ya se acabaron los CRN que empiezan con L y se agrego una l mas.
                                null;

                             End;



                 --    dbms_output.put_line ('salida  5 antes de insert sfrstcr '||c.periodo||'-'||crn  );
                             Begin
                                select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                                into f_inicio, f_fin, sem
                                from sobptrm
                                where sobptrm_term_code=c.periodo
                                and     sobptrm_ptrm_code=c.parte;
                             End;

                        If crn is not null then
                                      Begin
                                --     dbms_output.put_line ('salida  6 antes de insert ssbsect '||c.periodo||'-'||crn  );
                                            Insert into ssbsect values (
                                                                               c.periodo,     --SSBSECT_TERM_CODE
                                                                               crn,     --SSBSECT_CRN
                                                                               c.parte,     --SSBSECT_PTRM_CODE
                                                                               c.subj,     --SSBSECT_SUBJ_CODE
                                                                               c.crse,     --SSBSECT_CRSE_NUMB
                                                                                c.grupo,     --SSBSECT_SEQ_NUMB
                                                                                'A',    --SSBSECT_SSTS_CODE
                                                                                schd,    --SSBSECT_SCHD_CODE
                                                                                c.campus,    --SSBSECT_CAMP_CODE
                                                                                 title,   --SSBSECT_CRSE_TITLE
                                                                                 credit,   --SSBSECT_CREDIT_HRS
                                                                                 credit_bill,   --SSBSECT_BILL_HRS
                                                                                 gmod,   --SSBSECT_GMOD_CODE
                                                                                  null,  --SSBSECT_SAPR_CODE
                                                                                  null, --SSBSECT_SESS_CODE
                                                                                  null,  --SSBSECT_LINK_IDENT
                                                                                  null,  --SSBSECT_PRNT_IND
                                                                                  'Y',  --SSBSECT_GRADABLE_IND
                                                                                   null,  --SSBSECT_TUIW_IND
                                                                                   0, --SSBSECT_REG_ONEUP
                                                                                   0, --SSBSECT_PRIOR_ENRL
                                                                                   0, --SSBSECT_PROJ_ENRL
                                                                                   50, --SSBSECT_MAX_ENRL
                                                                                    0,--SSBSECT_ENRL
                                                                                    50,--SSBSECT_SEATS_AVAIL
                                                                                    null,--SSBSECT_TOT_CREDIT_HRS
                                                                                    '0',--SSBSECT_CENSUS_ENRL
                                                                                    f_inicio,--SSBSECT_CENSUS_ENRL_DATE
                                                                                    sysdate,--SSBSECT_ACTIVITY_DATE
                                                                                    f_inicio,--SSBSECT_PTRM_START_DATE
                                                                                    f_fin,--SSBSECT_PTRM_END_DATE
                                                                                    sem,--SSBSECT_PTRM_WEEKS
                                                                                    null,--SSBSECT_RESERVED_IND
                                                                                    null, --SSBSECT_WAIT_CAPACITY
                                                                                    null,--SSBSECT_WAIT_COUNT
                                                                                    null,--SSBSECT_WAIT_AVAIL
                                                                                    null,--SSBSECT_LEC_HR
                                                                                    null,--SSBSECT_LAB_HR
                                                                                    null,--SSBSECT_OTH_HR
                                                                                    null,--SSBSECT_CONT_HR
                                                                                    null,--SSBSECT_ACCT_CODE
                                                                                    null,--SSBSECT_ACCL_CODE
                                                                                    null,--SSBSECT_CENSUS_2_DATE
                                                                                    null,--SSBSECT_ENRL_CUT_OFF_DATE
                                                                                    null,--SSBSECT_ACAD_CUT_OFF_DATE
                                                                                    null,--SSBSECT_DROP_CUT_OFF_DATE
                                                                                    null,--SSBSECT_CENSUS_2_ENRL
                                                                                    'Y',--SSBSECT_VOICE_AVAIL
                                                                                    'N',--SSBSECT_CAPP_PREREQ_TEST_IND
                                                                                    null,--SSBSECT_GSCH_NAME
                                                                                    null,--SSBSECT_BEST_OF_COMP
                                                                                    null,--SSBSECT_SUBSET_OF_COMP
                                                                                    'NOP',--SSBSECT_INSM_CODE
                                                                                    null,--SSBSECT_REG_FROM_DATE
                                                                                    null,--SSBSECT_REG_TO_DATE
                                                                                    null,--SSBSECT_LEARNER_REGSTART_FDATE
                                                                                    null,--SSBSECT_LEARNER_REGSTART_TDATE
                                                                                    null,--SSBSECT_DUNT_CODE
                                                                                    null,--SSBSECT_NUMBER_OF_UNITS
                                                                                    0,--SSBSECT_NUMBER_OF_EXTENSIONS
                                                                                    'SZFCARG',--SSBSECT_DATA_ORIGIN
                                                                                    user,--SSBSECT_USER_ID
                                                                                    'MOOD',--SSBSECT_INTG_CDE
                                                                                    'B',--SSBSECT_PREREQ_CHK_METHOD_CDE
                                                                                    user,--SSBSECT_KEYWORD_INDEX_ID
                                                                                    null,--SSBSECT_SCORE_OPEN_DATE
                                                                                    null,--SSBSECT_SCORE_CUTOFF_DATE
                                                                                    null,--SSBSECT_REAS_SCORE_OPEN_DATE
                                                                                    null,--SSBSECT_REAS_SCORE_CTOF_DATE
                                                                                    null,--SSBSECT_SURROGATE_ID
                                                                                    null,--SSBSECT_VERSION
                                                                                     null);--SSBSECT_VPDI_CODE


                                                   Begin
                                                                update SOBTERM
                                                                     set SOBTERM_CRN_ONEUP = crn
                                                                where SOBTERM_TERM_CODE = c.periodo;
                                                   Exception
                                                   When Others then
                                                     null;
                                                   End;



                                                       Begin
                                                            insert into ssrmeet values(C.periodo, crn, null,null,null,null,null,null, sysdate, f_inicio, f_fin, '01', null,null,null,null,null,null,null, 'ENL', null, credit, null, 0, null,null,null, 'CLVI', 'SZFCARG', user, null,null,null);
                                                        Exception
                                                        when Others then
                                                           vl_error := 'Se presento un Error al insertar en ssrmeet ' ||sqlerrm;
                                                       End;


                                                        begin
                                                            select spriden_pidm
                                                                into pidm_prof
                                                            from  spriden
                                                            where   spriden_id=c.prof and spriden_change_ind is null;
                                                        Exception when others then
                                                          pidm_prof:=null;
                                                        End;

                                                       if pidm_prof is not null then
                                                         -- dbms_output.put_line('Crea el CRN para el docente:'|| pidm_prof  ||'*'||crn);

                                                          Begin
                                                                Select count (1)
                                                                Into vl_exite_prof
                                                                from sirasgn
                                                                Where SIRASGN_TERM_CODE = c.periodo
                                                                And SIRASGN_CRN = crn;
                                                               -- And SIRASGN_PIDM = pidm_prof;
                                                           Exception
                                                            when others then
                                                              vl_exite_prof := 0;
                                                           End;

                                                           If vl_exite_prof = 0 then
                                                                    Begin
                                                                            insert into sirasgn values(c.periodo, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,
                                                                                                                 sysdate, null,null,null,null, 'UTEL', 'MIGRA_D', null, null, null, null,  null,null);
                                                                    Exception
                                                                    When Others then
                                                                    null;
                                                                    End;
                                                           Else
                                                                   Begin
                                                                        Update sirasgn
                                                                        set SIRASGN_PRIMARY_IND = null
                                                                         Where SIRASGN_TERM_CODE = c.periodo
                                                                         And SIRASGN_CRN = crn;
                                                                   Exception
                                                                    When others then
                                                                    null;
                                                                   End;

                                                                    Begin
                                                                            insert into sirasgn values(c.periodo, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,
                                                                                                                 sysdate, null,null,null,null, 'UTEL', 'MIGRA_D', null, null, null, null,  null,null);
                                                                    Exception
                                                                    When Others then
                                                                    null;
                                                                    End;

                                                           End if;
                                                       end if;


                                                    conta_ptrm :=0;

                                                        Begin
                                                             select count(*)
                                                                into conta_ptrm
                                                             from sfbetrm
                                                             where sfbetrm_term_code=c.periodo
                                                             and     sfbetrm_pidm=c.pidm;
                                                        Exception
                                                            When Others then
                                                              conta_ptrm := 0;
                                                        End;


                                                         if conta_ptrm =0 then
                                                                Begin
                                                                        insert into sfbetrm values(c.periodo, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFCARG', null, 0,null,null, null,null,user,null);
                                                                Exception
                                                                When Others then
                                                                    vl_error := ('Se presento un error al insertar en la tabla sfbetrm ' || sqlerrm);
                                                                End;
                                                         end if;

                                                       Begin
                                                 --        dbms_output.put_line ('salida  7 linea 892 antes de insert sfrstcr '||c.periodo||'-'||parte  );
                                                           insert into sfrstcr values(
                                                                                            c.periodo,     --SFRSTCR_TERM_CODE
                                                                                            c.pidm,     --SFRSTCR_PIDM
                                                                                            crn,     --SFRSTCR_CRN
                                                                                            null,     --SFRSTCR_CLASS_SORT_KEY
                                                                                            c.grupo,    --SFRSTCR_REG_SEQ
                                                                                            c.parte,    --SFRSTCR_PTRM_CODE
                                                                                            'RE',     --SFRSTCR_RSTS_CODE
                                                                                            sysdate,    --SFRSTCR_RSTS_DATE
                                                                                            null,    --SFRSTCR_ERROR_FLAG
                                                                                            null,    --SFRSTCR_MESSAGE
                                                                                            credit_bill,    --SFRSTCR_BILL_HR
                                                                                            3, --SFRSTCR_WAIV_HR
                                                                                            credit,     --SFRSTCR_CREDIT_HR
                                                                                            credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                                            credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                                            gmod,     --SFRSTCR_GMOD_CODE
                                                                                            null,    --SFRSTCR_GRDE_CODE
                                                                                            null,    --SFRSTCR_GRDE_CODE_MID
                                                                                            null,    --SFRSTCR_GRDE_DATE
                                                                                            'N',    --SFRSTCR_DUPL_OVER
                                                                                            'N',    --SFRSTCR_LINK_OVER
                                                                                            'N',    --SFRSTCR_CORQ_OVER
                                                                                            'N',    --SFRSTCR_PREQ_OVER
                                                                                            'N',     --SFRSTCR_TIME_OVER
                                                                                            'N',     --SFRSTCR_CAPC_OVER
                                                                                            'N',     --SFRSTCR_LEVL_OVER
                                                                                            'N',     --SFRSTCR_COLL_OVER
                                                                                            'N',     --SFRSTCR_MAJR_OVER
                                                                                            'N',     --SFRSTCR_CLAS_OVER
                                                                                            'N',     --SFRSTCR_APPR_OVER
                                                                                            'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                                            sysdate,      --SFRSTCR_ADD_DATE
                                                                                            sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                                            c.nivel,     --SFRSTCR_LEVL_CODE
                                                                                            c.campus,     --SFRSTCR_CAMP_CODE
                                                                                             c.materia,     --SFRSTCR_RESERVED_KEY
                                                                                            null,     --SFRSTCR_ATTEND_HR
                                                                                            'Y',     --SFRSTCR_REPT_OVER
                                                                                            'N' ,    --SFRSTCR_RPTH_OVER
                                                                                            null,    --SFRSTCR_TEST_OVER
                                                                                            'N',    --SFRSTCR_CAMP_OVER
                                                                                            user,    --SFRSTCR_USER
                                                                                            'N',    --SFRSTCR_DEGC_OVER
                                                                                            'N',    --SFRSTCR_PROG_OVER
                                                                                            null,    --SFRSTCR_LAST_ATTEND
                                                                                            null,    --SFRSTCR_GCMT_CODE
                                                                                            'SZFCARG',    --SFRSTCR_DATA_ORIGIN
                                                                                            sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                                            'N',  --SFRSTCR_DEPT_OVER
                                                                                            'N',  --SFRSTCR_ATTS_OVER
                                                                                            'N', --SFRSTCR_CHRT_OVER
                                                                                            null, --SFRSTCR_RMSG_CDE
                                                                                            null,  --SFRSTCR_WL_PRIORITY
                                                                                            null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                                            null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                                            null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                                            'N', --SFRSTCR_MEXC_OVER
                                                                                            c.study,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                                            null,--SFRSTCR_BRDH_SEQ_NUM
                                                                                            '01',--SFRSTCR_BLCK_CODE
                                                                                            null,--SFRSTCR_STRH_SEQNO
                                                                                            null, --SFRSTCR_STRD_SEQNO
                                                                                            null,  --SFRSTCR_SURROGATE_ID
                                                                                            null, --SFRSTCR_VERSION
                                                                                            user,--SFRSTCR_USER_ID
                                                                                            no_recibo );--SFRSTCR_VPDI_CODE



                                                                    Begin
                                                                         update ssbsect
                                                                                set ssbsect_enrl = ssbsect_enrl + 1
                                                                          where SSBSECT_TERM_CODE = C.periodo
                                                                          And SSBSECT_CRN  = crn;
                                                                    Exception
                                                                    When Others then
                                                                    vl_error := 'Se presento un error al actualizar el enrolamiento ' ||sqlerrm;
                                                                    End;

                                                                    Begin
                                                                            update ssbsect
                                                                                set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                                            where SSBSECT_TERM_CODE = c.periodo
                                                                             And SSBSECT_CRN  = crn;
                                                                    Exception
                                                                    When Others then
                                                                        vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||sqlerrm;
                                                                    End;

                                                                    Begin
                                                                             update ssbsect
                                                                                    set ssbsect_census_enrl=ssbsect_enrl
                                                                             Where SSBSECT_TERM_CODE = c.periodo
                                                                             And SSBSECT_CRN  = crn;
                                                                    Exception
                                                                    When Others then
                                                                        vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||sqlerrm;
                                                                    End;


                                                                   Begin
                                                                        Update sgbstdn a
                                                                        set a.SGBSTDN_STYP_CODE ='C'
                                                                        Where a.SGBSTDN_PIDM = c.pidm
                                                                        And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                                               from sgbstdn a1
                                                                                                                               Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                                               And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1)
                                                                         And a.SGBSTDN_PROGRAM_1 = c.prog;
                                                                   Exception
                                                                        When Others then
                                                                        vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                                                   End;

                                                                    f_inicio := null;

                                                                     Begin
                                                                            select distinct sobptrm_start_date
                                                                            into f_inicio
                                                                            from sobptrm
                                                                            where sobptrm_term_code=c.periodo
                                                                            and     sobptrm_ptrm_code=c.parte;
                                                                     Exception
                                                                     When Others then
                                                                       f_inicio := null;
                                                                        vl_error := 'Se presento un error al Obtener la fecha de inicio de Clases ' ||sqlerrm;
                                                                     End;

                                                                    If f_inicio is not null then

                                                                        Begin   ----se activa este update a peticion de Fer gallem para todos menos nive y SS
                                                                                Update sorlcur
                                                                                set sorlcur_start_date  = trunc (f_inicio)
                                                                                Where SORLCUR_PIDM = c.pidm
                                                                                And SORLCUR_PROGRAM = c.prog
                                                                                And SORLCUR_LMOD_CODE = 'LEARNER'
                                                                                And SORLCUR_KEY_SEQNO = c.study
                                                                                --And SORLCUR_CAMP_CODE NOT in ('UTL','UTS')
                                                                                   and  substr(c.periodo,5,1)  not in (8,9)
                                                                                ;
                                                                        Exception
                                                                            When Others then
                                                                               vl_error := 'Se presento un error al actualizar la fecha de Inicio de Clases en sorlcur ' ||sqlerrm;
                                                                        End;

                                                                    End if;



                                                                    conta_ptrm:=0;

                                                                    Begin
                                                                        Select count (*)
                                                                            Into conta_ptrm
                                                                        from sfrareg
                                                                        where SFRAREG_PIDM = c.pidm
                                                                        And SFRAREG_TERM_CODE = c.periodo
                                                                        And SFRAREG_CRN = crn
                                                                        And SFRAREG_EXTENSION_NUMBER = 0
                                                                        And SFRAREG_RSTS_CODE = 'RE';
                                                                    Exception
                                                                    When Others then
                                                                       conta_ptrm :=0;
                                                                    End;

                                                                    If conta_ptrm = 0 then

                                                                         Begin
                                                                                 insert into sfrareg values(c.pidm, c.periodo, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFCARG', sysdate, null,null,null);
                                                                         Exception
                                                                           When Others then
                                                                              vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||sqlerrm;
                                                                         End;
                                                                    End if;

                                                        Exception
                                                       when Others then
                                                           vl_error := 'Se presento un error al insertar al alumno en el grupo2 ' ||sqlerrm;
                                                       End;


                                      Exception
                                        When Others then
                                          vl_error := 'Se presento un Error al insertar el nuevo grupo en la tabla SSBSECT 1' ||'CRN '||crn ||' '||c.periodo||' '||sqlerrm;
                                      End;
                                  --    dbms_output.put_line ('salida  8 final if linea 1078 '||c.periodo||'-'||parte  );
                        End if;
                          --  dbms_output.put_line ('salida  9 final if linea 1080 '||c.periodo||'-'||parte  );
                        End if;  -------- > No hay cupo en el grupo
                Else
             --       dbms_output.put_line('salida 10:'|| 'No hay grupo creado Con docente linea 1083');
                            schd := null;
                            title := null;
                            credit := null;
                            gmod :=null;
                            f_inicio :=null;
                            f_fin :=null;
                            sem :=null;
                            crn := null;
                            pidm_prof := null;
                            vl_exite_prof :=0;

                           Begin
                                select scrschd_schd_code, scbcrse_title, scbcrse_credit_hr_low, SCBCRSE_BILL_HR_LOW
                                into schd, title, credit, credit_bill
                                from scbcrse, scrschd
                                where scbcrse_subj_code=c.subj
                                and     scbcrse_crse_numb=c.crse
                                and     scbcrse_eff_term='000000'
                                and     scrschd_subj_code=scbcrse_subj_code
                                and     scrschd_crse_numb=scbcrse_crse_numb
                                and     scrschd_eff_term=scbcrse_eff_term;
                           Exception
                            When Others then
                                  schd := null;
                                  title := null;
                                  credit := null;
                                  credit_bill :=null;
                           End;



                            begin
                                select scrgmod_gmod_code
                                      into gmod
                                from scrgmod
                                where scrgmod_subj_code=c.subj
                                and     scrgmod_crse_numb=c.crse
                                and     scrgmod_default_ind='D';
                            exception when others then
                                gmod:='1';
                            end;

                             Begin

                                            if c.nivel ='MS' then

                                                        l_campus_ms:='AS';
                                                    else
                                                        l_campus_ms:=c.niVel;

                                            end if;

                                             BEGIN

                                                select sztcrnv_crn
                                                into crn
                                                from SZTCRNV
                                                where 1 = 1
                                                and rownum = 1
                                                AND SZTCRNV_LVEL_CODE = SUBSTR(l_campus_ms,1,1)
                                                and (SZTCRNV_crn,SZTCRNV_LVEL_CODE) not in (select to_number(crn),
                                                                                                   substr(SSBSECT_CRN,1,1)
                                                                                           from
                                                                                           (
                                                                                           select case when
                                                                                                          substr(SSBSECT_CRN,1,1) in(SELECT ZSTPARA_PARAM_VALOR
                                                                                                        FROM ZSTPARA
                                                                                                        WHERE 1=1
                                                                                                        AND ZSTPARA_MAPA_ID =  'LETRAS_CRN') then to_number(substr(SSBSECT_CRN,2,10))
                                                                                                         else
                                                                                                               to_number(SSBSECT_CRN)
                                                                                            end crn,
                                                                                                         SSBSECT_CRN
                                                                                               from ssbsect
                                                                                               where 1 = 1
                                                                                               and ssbsect_term_code=  c.periodo
                                                --                                               AND SUBSTR(SSBSECT_CRN,1,1) !='L'
                                                                                           )
                                                                                           where 1 = 1
                                                                                           );

                                         --       dbms_output.put_line(' Recupero el CRN '||crn);

                                             EXCEPTION WHEN OTHERS THEN
                                              --  raise_application_error (-20002,'Error al 2  '|| SQLCODE||' Error: '||SQLERRM);
                                            --    dbms_output.put_line(' error en crn 2 '||sqlerrm);
                                                crn := NULL;
                                             END;
                                     --------si estra aqui entonces le agrega su letra
                                             if c.nivel ='LI' then
                                                crn:='L'||crn;

                                                elsif  c.nivel ='MA' then
                                                crn:='M'||crn;

                                                elsif  c.nivel ='MS' then
                                                crn:='A'||crn;

                                                elsif  c.nivel ='DO' then
                                                crn:='D'||crn;

                                                elsif  c.nivel ='BA' then
                                                 crn:='B'||crn;

                                                elsif  c.nivel ='EC' then
                                                 crn:='E'||crn;

                                                elsif  c.nivel ='ID' then
                                                 crn:='I'||crn;
                                             end if;

                     --        dbms_output.put_line(' Recupero el CRN Se le agregua la letra '||crn);

                              Exception
                                    When Others then

                                  null;

                             End;

                             Begin
                                select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                                into f_inicio, f_fin, sem
                                from sobptrm
                                where sobptrm_term_code=c.periodo
                                and     sobptrm_ptrm_code=c.parte;
                             Exception
                             When Others then
                                vl_error := 'No se Encontro configuracion para el Periodo= ' ||c.periodo ||' y Parte de Periodo= '||c.parte ||sqlerrm;
                             End;

                      --          dbms_output.put_line(' Se recuperan las fechas  '||f_inicio ||'*'|| f_fin, sem);

                        If crn is not null then
                      --     dbms_output.put_line('salida 11:'|| 'No hay grupo creado Con docente linea 1171');
                                  Begin
                                        Insert into ssbsect values (
                                                                           c.periodo,     --SSBSECT_TERM_CODE
                                                                           crn,     --SSBSECT_CRN
                                                                           c.parte,     --SSBSECT_PTRM_CODE
                                                                           c.subj,     --SSBSECT_SUBJ_CODE
                                                                           c.crse,     --SSBSECT_CRSE_NUMB
                                                                            c.grupo,     --SSBSECT_SEQ_NUMB
                                                                            'A',    --SSBSECT_SSTS_CODE
                                                                            schd,    --SSBSECT_SCHD_CODE
                                                                            c.campus,    --SSBSECT_CAMP_CODE
                                                                             title,   --SSBSECT_CRSE_TITLE
                                                                             credit,   --SSBSECT_CREDIT_HRS
                                                                             credit_bill,   --SSBSECT_BILL_HRS
                                                                             gmod,   --SSBSECT_GMOD_CODE
                                                                              null,  --SSBSECT_SAPR_CODE
                                                                              null, --SSBSECT_SESS_CODE
                                                                              null,  --SSBSECT_LINK_IDENT
                                                                              null,  --SSBSECT_PRNT_IND
                                                                              'Y',  --SSBSECT_GRADABLE_IND
                                                                               null,  --SSBSECT_TUIW_IND
                                                                               0, --SSBSECT_REG_ONEUP
                                                                               0, --SSBSECT_PRIOR_ENRL
                                                                               0, --SSBSECT_PROJ_ENRL
                                                                               50, --SSBSECT_MAX_ENRL
                                                                                0,--SSBSECT_ENRL
                                                                                50,--SSBSECT_SEATS_AVAIL
                                                                                null,--SSBSECT_TOT_CREDIT_HRS
                                                                                '0',--SSBSECT_CENSUS_ENRL
                                                                                f_inicio,--SSBSECT_CENSUS_ENRL_DATE
                                                                                sysdate,--SSBSECT_ACTIVITY_DATE
                                                                                f_inicio,--SSBSECT_PTRM_START_DATE
                                                                                f_fin,--SSBSECT_PTRM_END_DATE
                                                                                sem,--SSBSECT_PTRM_WEEKS
                                                                                null,--SSBSECT_RESERVED_IND
                                                                                null, --SSBSECT_WAIT_CAPACITY
                                                                                null,--SSBSECT_WAIT_COUNT
                                                                                null,--SSBSECT_WAIT_AVAIL
                                                                                null,--SSBSECT_LEC_HR
                                                                                null,--SSBSECT_LAB_HR
                                                                                null,--SSBSECT_OTH_HR
                                                                                null,--SSBSECT_CONT_HR
                                                                                null,--SSBSECT_ACCT_CODE
                                                                                null,--SSBSECT_ACCL_CODE
                                                                                null,--SSBSECT_CENSUS_2_DATE
                                                                                null,--SSBSECT_ENRL_CUT_OFF_DATE
                                                                                null,--SSBSECT_ACAD_CUT_OFF_DATE
                                                                                null,--SSBSECT_DROP_CUT_OFF_DATE
                                                                                null,--SSBSECT_CENSUS_2_ENRL
                                                                                'Y',--SSBSECT_VOICE_AVAIL
                                                                                'N',--SSBSECT_CAPP_PREREQ_TEST_IND
                                                                                null,--SSBSECT_GSCH_NAME
                                                                                null,--SSBSECT_BEST_OF_COMP
                                                                                null,--SSBSECT_SUBSET_OF_COMP
                                                                                'NOP',--SSBSECT_INSM_CODE
                                                                                null,--SSBSECT_REG_FROM_DATE
                                                                                null,--SSBSECT_REG_TO_DATE
                                                                                null,--SSBSECT_LEARNER_REGSTART_FDATE
                                                                                null,--SSBSECT_LEARNER_REGSTART_TDATE
                                                                                null,--SSBSECT_DUNT_CODE
                                                                                null,--SSBSECT_NUMBER_OF_UNITS
                                                                                0,--SSBSECT_NUMBER_OF_EXTENSIONS
                                                                                'SZFCARG',--SSBSECT_DATA_ORIGIN
                                                                                user,--SSBSECT_USER_ID
                                                                                'MOOD',--SSBSECT_INTG_CDE
                                                                                'B',--SSBSECT_PREREQ_CHK_METHOD_CDE
                                                                                user,--SSBSECT_KEYWORD_INDEX_ID
                                                                                null,--SSBSECT_SCORE_OPEN_DATE
                                                                                null,--SSBSECT_SCORE_CUTOFF_DATE
                                                                                null,--SSBSECT_REAS_SCORE_OPEN_DATE
                                                                                null,--SSBSECT_REAS_SCORE_CTOF_DATE
                                                                                null,--SSBSECT_SURROGATE_ID
                                                                                null,--SSBSECT_VERSION
                                                                                 null);--SSBSECT_VPDI_CODE


                                                   Begin
                                                                update SOBTERM
                                                                     set SOBTERM_CRN_ONEUP = crn
                                                                where SOBTERM_TERM_CODE = c.periodo;
                                                   Exception
                                                   When Others then
                                                     null;
                                                   End;

                                                   Begin
                                                        insert into ssrmeet values(C.periodo, crn, null,null,null,null,null,null, sysdate, f_inicio, f_fin, '01', null,null,null,null,null,null,null, 'ENL', null, credit, null, 0, null,null,null, 'CLVI', 'SZFCARG', user, null,null,null);
                                                    Exception
                                                    when Others then
                                                       vl_error := 'Se presento un Error al insertar en ssrmeet ' ||sqlerrm;
                                                   End;


                                                    begin
                                                        select spriden_pidm
                                                            into pidm_prof
                                                        from  spriden
                                                        where   spriden_id=c.prof and spriden_change_ind is null;
                                                    Exception when others then
                                                      pidm_prof:=null;
                                                    End;

                                                    if pidm_prof is not null then
                                                     -- dbms_output.put_line('Crea el CRN para el docente:'|| pidm_prof  ||'*'||crn);

                                                      Begin
                                                            Select count (1)
                                                            Into vl_exite_prof
                                                            from sirasgn
                                                            Where SIRASGN_TERM_CODE = c.periodo
                                                            And SIRASGN_CRN = crn;
                                                           -- And SIRASGN_PIDM = pidm_prof;
                                                       Exception
                                                        when others then
                                                          vl_exite_prof := 0;
                                                       End;

                                                       If vl_exite_prof = 0 then
                                                                Begin
                                                                        insert into sirasgn values(c.periodo, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,
                                                                                                             sysdate, null,null,null,null, 'UTEL', 'MIGRA_D', null, null, null, null,  null,null);
                                                                Exception
                                                                When Others then
                                                                null;
                                                                End;
                                                       Else
                                                               Begin
                                                                    Update sirasgn
                                                                    set SIRASGN_PRIMARY_IND = null
                                                                     Where SIRASGN_TERM_CODE = c.periodo
                                                                     And SIRASGN_CRN = crn;
                                                               Exception
                                                                When others then
                                                                null;
                                                               End;

                                                                Begin
                                                                        insert into sirasgn values(c.periodo, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,
                                                                                                             sysdate, null,null,null,null, 'UTEL', 'MIGRA_D', null, null, null, null,  null,null);
                                                                Exception
                                                                When Others then
                                                                null;
                                                                End;

                                                       End if;
                                                    end if;


                                                conta_ptrm :=0;

                                                    Begin
                                                         select count(*)
                                                            into conta_ptrm
                                                         from sfbetrm
                                                         where sfbetrm_term_code=c.periodo
                                                         and     sfbetrm_pidm=c.pidm;
                                                    Exception
                                                        When Others then
                                                          conta_ptrm := 0;
                                                    End;


                                                     if conta_ptrm =0 then
                                                            Begin
                                                                    insert into sfbetrm values(c.periodo, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFCARG', null, 0,null,null, null,null,user,null);
                                                            Exception
                                                            When Others then
                                                                vl_error := ('Se presento un error al insertar en la tabla sfbetrm ' || sqlerrm);
                                                            End;
                                                     end if;

                                                   Begin
                                                 --   dbms_output.put_line('salida 12:'|| 'No hay grupo creado Con docente linea 1345');

                                                       insert into sfrstcr values(
                                                                                        c.periodo,     --SFRSTCR_TERM_CODE
                                                                                        c.pidm,     --SFRSTCR_PIDM
                                                                                        crn,     --SFRSTCR_CRN
                                                                                        null,     --SFRSTCR_CLASS_SORT_KEY
                                                                                        c.grupo,    --SFRSTCR_REG_SEQ
                                                                                        c.parte,    --SFRSTCR_PTRM_CODE
                                                                                        'RE',     --SFRSTCR_RSTS_CODE
                                                                                        sysdate,    --SFRSTCR_RSTS_DATE
                                                                                        null,    --SFRSTCR_ERROR_FLAG
                                                                                        null,    --SFRSTCR_MESSAGE
                                                                                        credit_bill,    --SFRSTCR_BILL_HR
                                                                                        3, --SFRSTCR_WAIV_HR
                                                                                        credit,     --SFRSTCR_CREDIT_HR
                                                                                        credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                                        credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                                        gmod,     --SFRSTCR_GMOD_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE_MID
                                                                                        null,    --SFRSTCR_GRDE_DATE
                                                                                        'N',    --SFRSTCR_DUPL_OVER
                                                                                        'N',    --SFRSTCR_LINK_OVER
                                                                                        'N',    --SFRSTCR_CORQ_OVER
                                                                                        'N',    --SFRSTCR_PREQ_OVER
                                                                                        'N',     --SFRSTCR_TIME_OVER
                                                                                        'N',     --SFRSTCR_CAPC_OVER
                                                                                        'N',     --SFRSTCR_LEVL_OVER
                                                                                        'N',     --SFRSTCR_COLL_OVER
                                                                                        'N',     --SFRSTCR_MAJR_OVER
                                                                                        'N',     --SFRSTCR_CLAS_OVER
                                                                                        'N',     --SFRSTCR_APPR_OVER
                                                                                        'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                                        sysdate,      --SFRSTCR_ADD_DATE
                                                                                        sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                                        c.nivel,     --SFRSTCR_LEVL_CODE
                                                                                        c.campus,     --SFRSTCR_CAMP_CODE
                                                                                         c.materia,     --SFRSTCR_RESERVED_KEY
                                                                                        null,     --SFRSTCR_ATTEND_HR
                                                                                        'Y',     --SFRSTCR_REPT_OVER
                                                                                        'N' ,    --SFRSTCR_RPTH_OVER
                                                                                        null,    --SFRSTCR_TEST_OVER
                                                                                        'N',    --SFRSTCR_CAMP_OVER
                                                                                        user,    --SFRSTCR_USER
                                                                                        'N',    --SFRSTCR_DEGC_OVER
                                                                                        'N',    --SFRSTCR_PROG_OVER
                                                                                        null,    --SFRSTCR_LAST_ATTEND
                                                                                        null,    --SFRSTCR_GCMT_CODE
                                                                                        'SZFCARG',    --SFRSTCR_DATA_ORIGIN
                                                                                        sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                                        'N',  --SFRSTCR_DEPT_OVER
                                                                                        'N',  --SFRSTCR_ATTS_OVER
                                                                                        'N', --SFRSTCR_CHRT_OVER
                                                                                        null, --SFRSTCR_RMSG_CDE
                                                                                        null,  --SFRSTCR_WL_PRIORITY
                                                                                        null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                                        null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                                        null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                                        'N', --SFRSTCR_MEXC_OVER
                                                                                        c.study,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                                        null,--SFRSTCR_BRDH_SEQ_NUM
                                                                                        '01',--SFRSTCR_BLCK_CODE
                                                                                        null,--SFRSTCR_STRH_SEQNO
                                                                                        null, --SFRSTCR_STRD_SEQNO
                                                                                        null,  --SFRSTCR_SURROGATE_ID
                                                                                        null, --SFRSTCR_VERSION
                                                                                        user,--SFRSTCR_USER_ID
                                                                                        no_recibo );--SFRSTCR_VPDI_CODE



                                                                Begin
                                                                     update ssbsect
                                                                            set ssbsect_enrl = ssbsect_enrl + 1
                                                                      where SSBSECT_TERM_CODE = C.periodo
                                                                      And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                vl_error := 'Se presento un error al actualizar el enrolamiento ' ||sqlerrm;
                                                                End;

                                                                Begin
                                                                        update ssbsect
                                                                            set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                                        where SSBSECT_TERM_CODE = c.periodo
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||sqlerrm;
                                                                End;

                                                                Begin
                                                                         update ssbsect
                                                                                set ssbsect_census_enrl=ssbsect_enrl
                                                                         Where SSBSECT_TERM_CODE = c.periodo
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||sqlerrm;
                                                                End;

                                                                Begin
                                                                    Update sgbstdn a
                                                                    set a.SGBSTDN_STYP_CODE ='C'
                                                                    Where a.SGBSTDN_PIDM = c.pidm
                                                                    And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                                           from sgbstdn a1
                                                                                                                           Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                                           And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1)
                                                                     And a.SGBSTDN_PROGRAM_1 = c.prog;
                                                                Exception
                                                                    When Others then
                                                                    vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                                                End;

                                                                f_inicio := null;

                                                                 Begin
                                                                        select distinct sobptrm_start_date
                                                                        into f_inicio
                                                                        from sobptrm
                                                                        where sobptrm_term_code=c.periodo
                                                                        and     sobptrm_ptrm_code=c.parte;
                                                                 Exception
                                                                 When Others then
                                                                   f_inicio := null;
                                                                    vl_error := 'Se presento un error al Obtener la fecha de inicio de Clases ' ||sqlerrm;
                                                                 End;

                                                                If f_inicio is not null then

                                                                    Begin
                                                                     null;  --------se  activa esta funcion a peticion de FER GALLem para todos menos nive y SS 24.09.2019
                                                                            Update sorlcur
                                                                            set sorlcur_start_date  = trunc (f_inicio)
                                                                            Where SORLCUR_PIDM = c.pidm
                                                                            And SORLCUR_PROGRAM = c.prog
                                                                            And SORLCUR_LMOD_CODE = 'LEARNER'
                                                                            And SORLCUR_KEY_SEQNO = c.study
                                                                             and  substr(c.periodo,5,1)  not in (8,9);
                                                                            --  And SORLCUR_CAMP_CODE NOT in ('UTL','UTS');
                                                                    Exception
                                                                        When Others then
                                                                           vl_error := 'Se presento un error al actualizar la fecha de Inicio de Clases en sorlcur ' ||sqlerrm;
                                                                    End;

                                                                End if;

                                                                conta_ptrm:=0;

                                                                Begin
                                                                    Select count (*)
                                                                        Into conta_ptrm
                                                                    from sfrareg
                                                                    where SFRAREG_PIDM = c.pidm
                                                                    And SFRAREG_TERM_CODE = c.periodo
                                                                    And SFRAREG_CRN = crn
                                                                    And SFRAREG_EXTENSION_NUMBER = 0
                                                                    And SFRAREG_RSTS_CODE = 'RE';
                                                                Exception
                                                                When Others then
                                                                   conta_ptrm :=0;
                                                                End;

                                                                If conta_ptrm = 0 then

                                                                     Begin
                                                                             insert into sfrareg values(c.pidm, c.periodo, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFCARG', sysdate, null,null,null);
                                                                     Exception
                                                                       When Others then
                                                                          vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||sqlerrm;
                                                                     End;
                                                                End if;

                                                    Exception
                                                   when Others then
                                                       vl_error := 'Se presento un error al insertar al alumno en el grupo3 ' ||sqlerrm;
                                                   End;

                                                 -- dbms_output.put_line('mensaje1:'|| 'SE creo el grupo :=' ||crn);
                                  Exception
                                    When Others then
                                      vl_error := 'Se presento un Error al insertar el nuevo grupo 3AA ' || 'CRN: ' ||crn||  ' --' ||c.periodo||' '||sqlerrm;
                                  End;
                            -- dbms_output.put_line('salida 14:'|| 'No hay grupo creado Con docente linea 1528');
                        End if;
                    --    dbms_output.put_line('salida 15:'|| 'No hay grupo creado Con docente linea 1530');
                End if;  ------ No hay  CRN Creado

                if vl_error = 'EXITO' then
                    commit; --Commit;
              --     dbms_output.put_line('mensaje:EXITO 16 line 13285 '||vl_error);
                    Begin
                --    insert into twpasow (valor1, valor2,valor3,valor4) values('sztcarga_EXITO', c.iden, c.materia,sysdate); commit;
                            Insert into SZtCARGA values (c.iden, --SZCARGA_ID
                                                                       c.materia, --SZCARGA_MATERIA
                                                                       c.prog,         --SZCARGA_PROGRAM
                                                                       c.periodo,         --SZCARGA_TERM_CODE
                                                                       c.parte,         --SZCARGA_PTRM_CODE
                                                                       c.grupo,         --SZCARGA_GRUPO
                                                                       null,         --SZCARGA_CALIF
                                                                       c.prof,         --SZCARGA_ID_PROF
                                                                       user,         --SZCARGA_USER_ID
                                                                       sysdate,         --SZCARGA_ACTIVITY_DATE
                                                                       c.fecha_inicio,         --SZCARGA_FECHA_INI
                                                                      'P',          --SZCARGA_ESTATUS
                                                                       'Horario Generado' ,  --SZCARGA_OBSERVACIONES
                                                                       'MATE',
                                                                       null
                                                                       );
                    Exception
                     when DUP_VAL_ON_INDEX then
                        Begin
                          Update SZtCARGA
                          set SZCARGA_ESTATUS = 'P' ,
                          SZCARGA_OBSERVACIONES =  'Horario Generado',
                          SZCARGA_ACTIVITY_DATE = sysdate
                          Where SZCARGA_ID = c.iden
                          and SZCARGA_MATERIA = c.materia
                          AND SZTCARGA_TIPO_PROC = 'MATE'
                          and trunc (SZCARGA_FECHA_INI) = c.fecha_inicio;
                          Exception
                          When Others then
                          vl_error := 'Se presento un Error al Actualizar la bitacora '||sqlerrm;
                        End;
                    When Others then
                     vl_error := 'Se presento un Error al insertar la bitacora '||sqlerrm;
                    End;


                Else
        --         dbms_output.put_line('mensaje:20:: '||vl_error);
                   rollback;
                    Begin
                  --  insert into twpasow (valor1, valor2,valor3,valor4) values('sztcarga_mensaje20', c.iden, c.materia,sysdate); commit;
                            Insert into SZtCARGA values (c.iden, --SZCARGA_ID
                                                                       c.materia, --SZCARGA_MATERIA
                                                                       c.prog,         --SZCARGA_PROGRAM
                                                                       c.periodo,         --SZCARGA_TERM_CODE
                                                                       c.parte,         --SZCARGA_PTRM_CODE
                                                                       c.grupo,         --SZCARGA_GRUPO
                                                                       null,         --SZCARGA_CALIF
                                                                       c.prof,         --SZCARGA_ID_PROF
                                                                       user,         --SZCARGA_USER_ID
                                                                       sysdate,         --SZCARGA_ACTIVITY_DATE
                                                                       c.fecha_inicio,         --SZCARGA_FECHA_INI
                                                                      'E',          --SZCARGA_ESTATUS
                                                                       vl_error,  --SZCARGA_OBSERVACIONES
                                                                       'MATE',
                                                                       null
                                                                       );
                              commit;
                    Exception
                     when DUP_VAL_ON_INDEX then
                        Begin
                          Update SZtCARGA
                          set SZCARGA_ESTATUS = 'E' ,
                          SZCARGA_OBSERVACIONES =  vl_error,
                          SZCARGA_ACTIVITY_DATE = sysdate
                          Where SZCARGA_ID = c.iden
                          and SZCARGA_MATERIA = c.materia
                          AND SZTCARGA_TIPO_PROC = 'MATE'
                          AND SZCARGA_ESTATUS = 'E';
                         -- and trunc (SZCARGA_FECHA_INI) = c.fecha_inicio;
                          Exception
                          When Others then
                          vl_error := 'Se presento un Error al Actualizar la bitacora de Error '||sqlerrm;
                        End;
                    When Others then
                     vl_error := 'Se presento un Error al insertar la bitacora de Error '||sqlerrm;
                    End;


                End if;
        Else
           vl_error := 'El alumno ya tiene la materia Inscritas en el Periodo:'||period_cur||'. Parte-periodo:'||parteper_cur;
                   Begin
                --     insert into twpasow (valor1, valor2,valor3,valor4) values('sztcarga_pparte', c.iden, c.materia,sysdate); commit;

                            Insert into SZtCARGA values (c.iden, --SZCARGA_ID
                                                                       c.materia, --SZCARGA_MATERIA
                                                                       c.prog,         --SZCARGA_PROGRAM
                                                                       c.periodo,         --SZCARGA_TERM_CODE
                                                                       c.parte,         --SZCARGA_PTRM_CODE
                                                                       c.grupo,         --SZCARGA_GRUPO
                                                                       null,         --SZCARGA_CALIF
                                                                       c.prof,         --SZCARGA_ID_PROF
                                                                       user,         --SZCARGA_USER_ID
                                                                       sysdate,         --SZCARGA_ACTIVITY_DATE
                                                                       c.fecha_inicio,         --SZCARGA_FECHA_INI
                                                                       'A',--'P',          --SZCARGA_ESTATUS
                                                                       vl_error,  --SZCARGA_OBSERVACIONES
                                                                       'MATE',
                                                                       null
                                                                       );
                              commit;
                     Exception
                     when DUP_VAL_ON_INDEX then
                        Begin
                          Update SZtCARGA
                          set SZCARGA_ESTATUS = 'A',--'P' ,
                          SZCARGA_OBSERVACIONES =  vl_error,
                          SZCARGA_ACTIVITY_DATE = sysdate
                          Where SZCARGA_ID = c.iden
                          and SZCARGA_MATERIA = c.materia
                          AND SZTCARGA_TIPO_PROC = 'MATE'
                          AND SZCARGA_ESTATUS = 'E';
                         -- and trunc (SZCARGA_FECHA_INI) = c.fecha_inicio;
                          Exception
                          When Others then
                          vl_error := 'Se presento un Error al Actualizar la bitacora de Error '||sqlerrm;
                        End;
                    When Others then
                     vl_error := 'Se presento un Error al insertar la bitacora de Error '||sqlerrm;
                    End;


        End if; ----> El alumno ya tiene inscrita la materia
     ELSE
      ---- vl_error := 'EL ALUMNO TIENE UN ESTATUS DE BAJA "'||C.SGBSTDN_STST_CODE||'"  SE GENERA HORARIO OK';
                   Begin
                --   insert into twpasow (valor1, valor2,valor3,valor4) values('sztcarga_EStatus', c.iden, c.materia,sysdate); commit;
                            Insert into SZtCARGA values (c.iden, --SZCARGA_ID
                                                                       c.materia, --SZCARGA_MATERIA
                                                                       c.prog,         --SZCARGA_PROGRAM
                                                                       c.periodo,         --SZCARGA_TERM_CODE
                                                                       c.parte,         --SZCARGA_PTRM_CODE
                                                                       c.grupo,         --SZCARGA_GRUPO
                                                                       null,         --SZCARGA_CALIF
                                                                       c.prof,         --SZCARGA_ID_PROF
                                                                       user,         --SZCARGA_USER_ID
                                                                       sysdate,         --SZCARGA_ACTIVITY_DATE
                                                                       c.fecha_inicio,         --SZCARGA_FECHA_INI
                                                                       'A',--'P',          --SZCARGA_ESTATUS
                                                                       vl_error,  --SZCARGA_OBSERVACIONES
                                                                       'MATE',
                                                                       null
                                                                       );
                              commit;
                     Exception
                     when DUP_VAL_ON_INDEX then
                        Begin
                          Update SZtCARGA
                          set SZCARGA_ESTATUS = 'A',--'P' ,
                          SZCARGA_OBSERVACIONES =  vl_error,
                          SZCARGA_ACTIVITY_DATE = sysdate
                          Where SZCARGA_ID = c.iden
                          and SZCARGA_MATERIA = c.materia
                          AND SZTCARGA_TIPO_PROC = 'MATE'
                          and trunc (SZCARGA_FECHA_INI) = c.fecha_inicio;
                          Exception
                          When Others then
                          vl_error := 'Se presento un Error al Actualizar la bitacora de Error '||sqlerrm;
                        End;
                    When Others then
                     vl_error := 'Se presento un Error al insertar la bitacora de Error '||sqlerrm;
                    End;
     END IF;

    end loop; --nuevo loop del parametrizador que pidio FER.

 End loop;

 commit;

IF VBANDERA = 0 THEN  ----SI BANDERA ES CERO QUIERE DECIR QUE NO PASO AL SEGUNDO CURSOR MANDA ERROR

vl_error := 'no entra curso principal: '||jump.SZCARGA_ID;
                   Begin
               ---    insert into twpasow (valor1, valor2,valor3, valor4 ) values('sztcarga_cursor', jump.SZCARGA_ID, jump.SZCARGA_MATERIA,sysdate); commit;
                            Insert into SZtCARGA values (jump.SZCARGA_ID, --SZCARGA_ID
                                                                       jump.SZCARGA_MATERIA, --SZCARGA_MATERIA
                                                                       jump.SZCARGA_PROGRAM,         --SZCARGA_PROGRAM
                                                                       jump.SZCARGA_TERM_CODE,         --SZCARGA_TERM_CODE
                                                                       jump.SZCARGA_PTRM_CODE,         --SZCARGA_PTRM_CODE
                                                                       jump.SZCARGA_GRUPO,         --SZCARGA_GRUPO
                                                                       null,         --SZCARGA_CALIF
                                                                       jump.SZCARGA_ID_PROF,         --SZCARGA_ID_PROF
                                                                       user,         --SZCARGA_USER_ID
                                                                       sysdate,         --SZCARGA_ACTIVITY_DATE
                                                                       jump.SZCARGA_FECHA_INI,         --SZCARGA_FECHA_INI
                                                                       'E',--'P',          --SZCARGA_ESTATUS
                                                                       vl_error,  --SZCARGA_OBSERVACIONES
                                                                       'MATE',
                                                                       null
                                                                       );
                              commit;
                     Exception
                     when DUP_VAL_ON_INDEX then
                        Begin
                          Update SZtCARGA
                          set SZCARGA_ESTATUS = 'E',--'P' ,
                          SZCARGA_OBSERVACIONES =  vl_error,
                          SZCARGA_ACTIVITY_DATE = sysdate
                          Where SZCARGA_ID = jump.SZCARGA_ID
                          and SZCARGA_MATERIA = jump.SZCARGA_MATERIA
                          AND SZTCARGA_TIPO_PROC = 'MATE'
                          and trunc (SZCARGA_FECHA_INI) =  trunc(jump.SZCARGA_FECHA_INI);
                          Exception
                          When Others then
                          vl_error := 'Se presento un Error al Actualizar la bitacora de Error '||sqlerrm;
                        End;
                    When Others then
                     vl_error := 'Se presento un Error al insertar la bitacora de Error '||sqlerrm;
                    End;
END IF;

end loop; ---de alumnos en la tabla sztcarg

end carga_inscrip_nw;


PROCEDURE leer_file_carga_Calif IS

 cadena VARCHAR2(32767);
 Vfile UTL_FILE.FILE_TYPE;
 iden         varchar2(20);
 materia    varchar2(20);
 prog         varchar2(20);
 periodo     varchar2(20);
 --parte        varchar2(4);
 --grupo       varchar2(5);
 calif          varchar2(10);
 iden_prof  varchar2(10);
 f1             VARCHAR2(10);
 f2             VARCHAR2(10);
 var           number;
 coma        number;
 i               number;
 bimestre   varchar2(1);

 crn      number;
gpo     number;
mate   varchar2(20);
ciclo    varchar2(6);
subj       varchar2(4);
crse       varchar2(5);
sb       varchar2(4);
cr       varchar2(5);
schd   varchar2(3);
title    varchar2(30);
credit decimal(7,3);
gmod  varchar2(1);
f_inicio date;
f_fin     date;
sem     number;
conta_ptrm number;
conta_blck number;
pidm   number;
pidm_doc number;
pidm_doc2 number;
ests    varchar2(2);
levl     varchar2(2);
camp  varchar2(3);
rsts    varchar2(3);
conta_origen number:=0;
conta_destino number :=0;
conta_origen_ssbsect number:=0;
conta_origen_ssrblck number:=0;
conta_origen_sobptrm number:=0;
sp       integer;
ciclo_ext varchar2(6);
mensaje   varchar2(200);
parte varchar2(4);
pidm_prof number;
per    varchar2(6);
grupo varchar2(4);
conta_sirasgn number;


BEGIN

 -- Abro fichero en lectura (Read)
 Vfile := UTL_FILE.FOPEN('IMAGEN','carga.csv','R',256);

    loop
        begin
         -- Leo del fichero
         UTL_FILE.GET_LINE(Vfile,cadena,32767);
         materia:=null; iden:=null; grupo:=null; prog:=null; periodo:=null; parte:=null; iden_prof:=null; var:=0;

           for i IN 1..60 loop
             -- -- dbms_output.put_line(substr(cadena,i,1)||' '||var);
              if substr(cadena,i,1)=',' then
                if var=0 then
                   iden:=trim(substr(cadena,1,i-1));
                   var:=1;
                   coma:=i;
                else
                   if var=1 then
                      materia:=trim(substr(cadena,coma+1,i-(coma+1)));
                      var:=2;
                      coma:=i;
                   else
                       if var=2 then
                          prog:=trim(substr(cadena,coma+1,i-(coma+1)));
                          var:=3;
                          coma:=i;
                       else
                          if var=3 then
                            periodo:=trim(substr(cadena,coma+1,i-(coma+1)));
                            var:=4;
                            coma:=i;
                          else
                             if var=4 then
                                parte:=trim(substr(cadena,coma+1,i-(coma+1)));
                                var:=5;
                                coma:=i;
                             else
                                 if var=5 then
                                    grupo:=trim(substr(cadena,coma+1,i-(coma+1)));
                                    var:=6;
                                    coma:=i;
                                 else
                                     if var=6 then
                                         calif:=trim(substr(cadena,coma+1,i-(coma+1)));
                                         iden_prof:=trim(substr(cadena,i+1,9));
                                         var:=7;
                                         coma:=i;
                                     end if;
                                 end if;
                             end if;
                          end if;
                       end if;
                   end if;
                end if;
             end if;
           end loop;


            if iden is not null then
                Begin
                        insert into SZCARGA values(trim(iden), trim(materia), trim(prog), trim(periodo),trim(parte) , trim(grupo),trim(calif), trim(iden_prof), user, sysdate, NULL,98,null);
                Exception
                  When Others then
                    null;
                End;
            end if;

        exception
        when NO_DATA_FOUND  then
          exit;
        end;

    end loop;

 -- Cierro fichero
 commit;
 UTL_FILE.FCLOSE(Vfile);


begin

            for c in (

            select distinct spriden_pidm pidm,
                                szcarga_id iden  ,
                                szcarga_program prog,
                                sorlcur_term_code_ctlg ctlg ,
                                szcarga_materia  materia ,
                                smrarul_subj_code subj,
                                smrarul_crse_numb_low crse ,
                                szcarga_term_code periodo ,
                                szcarga_ptrm_code parte,
                                decode(sztdtec_periodicidad,1,'BIMESTRAL',2,'CUATRIMESTRAL') Periodicidad,
                                szcarga_grupo grupo,
                                szcarga_calif calif,
                                szcarga_id_prof prof
            from SZCARGA
            join spriden on spriden_id=szcarga_id and spriden_change_ind is null
            join sorlcur s on sorlcur_pidm=spriden_pidm
                    and sorlcur_program=szcarga_program
                    and sorlcur_lmod_code='LEARNER'
                    and sorlcur_seqno in (select max(sorlcur_seqno)
                                                    from sorlcur ss
                                                    where s.sorlcur_pidm=ss.sorlcur_pidm
                                                    and s.sorlcur_lmod_code=ss.sorlcur_lmod_code
                                                    and     s.sorlcur_program=ss.sorlcur_program)
            join smrpaap on smrpaap_program=sorlcur_program
                    and smrpaap_term_code_eff=sorlcur_term_code_ctlg
            join scrtext on scrtext_text=szcarga_materia
            join smrarul on smrarul_area=smrpaap_area
                    and smrarul_term_code_eff=smrpaap_term_code_eff
            left outer join sztdtec on sztdtec_program=sorlcur_program
                    and sztdtec_term_code=sorlcur_term_code_ctlg
            where  smrarul_subj_code=scrtext_subj_code and smrarul_crse_numb_low=scrtext_crse_numb
            AND    SZCARGA_NO_REGLA  = 98
            order by  iden


            ) loop

            --dbms_output.put_line('pidm:'||c.pidm||' id:'||c.iden||'subj||crse:'||c.subj||c.crse||'programa:'||c.prog||'parte:'||c.parte);
            begin
                    select ssbsect_crn
                        into crn
                    from ssbsect, sfrstcr
                    where sfrstcr_pidm=c.pidm
                    and sfrstcr_term_code=c.periodo
                    and   ssbsect_term_code=sfrstcr_term_code
                    and ssbsect_crn=sfrstcr_crn
                    and ssbsect_subj_code=c.subj
                    and ssbsect_ptrm_code in ('M4A','M4B','M4C','M4D','M5A','M5B','M5C','M5D','A4A','A4B','A4C','A4D','A5A','A5B','A5C','A5D') --modificaci??er
                    and ssbsect_crse_numb=c.crse ;
            Exception
                when others then
                    crn:=null;
            end;

            if crn is not null then
                  if c.calif is not null then
                      update sfrstcr
                            set sfrstcr_grde_code=c.calif,
                                 sfrstcr_activity_date=sysdate,
                                 sfrstcr_user_id=user,
                                 SFRSTCR_DATA_ORIGIN = 'SZTCALI'
                      where sfrstcr_pidm=c.pidm
                      and sfrstcr_term_code=c.periodo
                      AND sfrstcr_ptrm_code in ('M4A','M4B','M4C','M4D','M5A','M5B','M5C','M5D','A4A','A4B','A4C','A4D','A5A','A5B','A5C','A5D') --modificaci??er
                      and sfrstcr_crn=crn;

                      if c.prof is not null then

                         begin
                             select  spriden_pidm
                                into pidm_doc2
                             from spriden
                             where spriden_id=c.prof
                             and spriden_change_ind is null;
                             exception
                             when others then
                                pidm_doc2:=null;
                         end;

                         if pidm_doc2 is not null then
                            select count(*) into conta_sirasgn
                            from sirasgn
                            where sirasgn_term_code=c.periodo and sirasgn_crn=crn and sirasgn_pidm=pidm_doc2;
                            if conta_sirasgn > 0 then
                               continue;
                            end if;
                            begin
                            select  sirasgn_pidm into pidm_doc
                            from sirasgn, spriden
                            where sirasgn_term_code=c.periodo and sirasgn_crn=crn and sirasgn_primary_ind ='Y'
                            and     spriden_pidm=sirasgn_pidm and spriden_change_ind is null;
                            exception when others then
                            pidm_doc:=null;
                            end;
                            if pidm_doc is  null then
                              -- dbms_output.put_line('1 -'||c.periodo||' '||crn||' '||pidm_doc2);
                               insert into sirasgn values(c.periodo, crn, pidm_doc2, '01', 100, null, 100, 'Y', null, null, sysdate, null, null, null, null, 'Banner', user,  null, null, null, null, null, null);
                            else
                               if pidm_doc != pidm_doc2 then
                                  update sirasgn set sirasgn_primary_ind='N'
                                  where sirasgn_term_code=c.periodo and sirasgn_crn=crn and sirasgn_primary_ind='Y';
                                 -- dbms_output.put_line('2 -'||c.periodo||' '||crn||' '||pidm_doc2);
                                  insert into sirasgn values(c.periodo, crn, pidm_doc2, '02', 100, null, 100, 'Y', null, null, sysdate, null, null, null, null, 'Banner', user,  null, null, null, null, null, null);
                               end if;
                            end if;
                         end if;
                      end if;
                  end if;
            End if;

end loop;

End;


END leer_file_carga_Calif;

PROCEDURE leer_file_carga_Calif_NW   (p_error out varchar2 )  IS

 cadena       VARCHAR2(32767);
 Vfile UTL_FILE.FILE_TYPE;
 iden         varchar2(25);
 materia      varchar2(25);
 prog         varchar2(25);
 periodo      varchar2(20);
 --parte        varchar2(4);
 --grupo       varchar2(5);
 calif        varchar2(10);
 iden_prof    varchar2(10);
 f1           VARCHAR2(10);
 f2           VARCHAR2(10);
 var          number;
 coma         number;
 i            number;
 bimestre     varchar2(10);
 crn          varchar2(5);
gpo           number;
mate          varchar2(20);
ciclo         varchar2(6);
subj          varchar2(4);
crse          varchar2(5);
sb            varchar2(4);
cr            varchar2(5);
schd          varchar2(3);
title         varchar2(50);
credit        decimal(7,3);
gmod          varchar2(2);
f_inicio      date;
f_fin         date;
sem           number;
conta_ptrm    number;
conta_blck    number;
pidm          number;
pidm_doc      number;
pidm_doc2     number;
ests          varchar2(3);
levl          varchar2(3);
camp          varchar2(3);
rsts          varchar2(3);
conta_origen  number:=0;
conta_destino number :=0;
conta_origen_ssbsect number:=0;
conta_origen_ssrblck number:=0;
conta_origen_sobptrm number:=0;
sp            integer;
ciclo_ext     varchar2(6);
mensaje       varchar2(500);
parte         varchar2(4);
pidm_prof     number;
per           varchar2(6);
grupo         varchar2(4);
conta_sirasgn number;

vl_error      varchar2 (5000):= 'EXITO';
fecha_ini     date;
fecha         varchar2(10);
vl_periodo_act varchar2(6);
vl_alumno     number:=0;

cursor c_no_proce is
    select * from SZCARGA a
     where  a.SZCARGA_NO_REGLA = 98
     and (SZCARGA_ID, SZCARGA_MATERIA) not in (  select carg.SZCARGA_ID, carg.SZCARGA_MATERIA
                                                   from SZtCARGA carg
                                                  where 1=1
                                                    and CARG.SZTCARGA_NO_REGLA = 98);


BEGIN

--fecha_ini:=to_date(pn_fecha,'dd/mm/rrrr');

 -- Abro fichero en lectura (Read)
 Vfile := UTL_FILE.FOPEN('IMAGEN','calificaciones.csv','R',256);
 delete from SZCARGA
 WHERE  SZCARGA_NO_REGLA = 98;

 commit;

    loop
        begin
         -- Leo del fichero
         UTL_FILE.GET_LINE(Vfile,cadena,32767);
         materia:=null; iden:=null; grupo:=null; prog:=null; periodo:=null; parte:=null; iden_prof:=null; var:=0; fecha := null;

           for i IN 1..60 loop
             -- -- dbms_output.put_line(substr(cadena,i,1)||' '||var);
              if substr(cadena,i,1)=',' then
                if var=0 then
                   iden:=trim(substr(cadena,1,i-1));
                   var:=1;
                   coma:=i;
                else
                   if var=1 then
                      materia:=trim(substr(cadena,coma+1,i-(coma+1)));
                      var:=2;
                      coma:=i;
                   else
                       if var=2 then
                          prog:=trim(substr(cadena,coma+1,i-(coma+1)));
                          var:=3;
                          coma:=i;
                       else
                          if var=3 then
                            periodo:=trim(substr(cadena,coma+1,i-(coma+1)));
                            var:=4;
                            coma:=i;
                          else
                             if var=4 then
                                parte:=trim(substr(cadena,coma+1,i-(coma+1)));
                                var:=5;
                                coma:=i;
                             else
                                 if var=5 then
                                    grupo:=trim(substr(cadena,coma+1,i-(coma+1)));
                                    var:=6;
                                    coma:=i;
                                 else
                                      if var=6 then
                                         calif:=trim(substr(cadena,coma+1,i-(coma+1)));
                                         var:=7;
                                         coma:=i;
                                     Else
                                            if var=7 then
                                              iden_prof:=trim(substr(cadena,coma+1,i-(coma+1)));
                                              fecha:=trim(substr(cadena,i+1,10));
                                             var:=8;
                                             coma:=i;
                                           End if;
                                         end if;
                                 end if;
                             end if;
                          end if;
                       end if;
                   end if;
                end if;
             end if;
           end loop;


            if iden is not null then
                Begin
                    insert into SZCARGA values(trim(iden), trim(materia), trim(prog), trim(periodo),trim(parte) , trim(grupo),trim(calif), trim(iden_prof), user, sysdate, to_date(fecha,'dd/mm/yyyy'),98,null);
                Exception
                When No_data_found then
                   vl_error := 'No se Encontraron Datos para registrar';
                   When Others then
                   vl_error := 'Se presento el error al insertar el tabla de Carga ' ||sqlerrm;
                End;
            end if;

        exception
        when NO_DATA_FOUND  then
          exit;
        end;

    end loop;
    p_error := vl_error;
 -- Cierro fichero
 commit;
 UTL_FILE.FCLOSE(Vfile);


BEGIN

    delete SZtCARGA
    WHERE SZTCARGA_NO_REGLA = 98;
    commit;

      for c in (
                    select distinct spriden_pidm pidm,
                       szcarga_id iden  ,
                       szcarga_program prog,
                       sorlcur_camp_code campus,
                       sorlcur_levl_code nivel,
                       sorlcur_term_code_ctlg ctlg ,
                       szcarga_materia  materia ,
                       smrarul_subj_code subj,
                       smrarul_crse_numb_low crse ,
                       szcarga_term_code periodo ,
                       szcarga_ptrm_code parte,
                       decode(sztdtec_periodicidad,1,'BIMESTRAL',2,'CUATRIMESTRAL') periodicidad,
                       szcarga_grupo grupo,
                       szcarga_calif calif,
                       szcarga_id_prof prof,
                       SZCARGA_FECHA_INI Fecha_Inicio,
                       SORLCUR_KEY_SEQNO study, g.SGBSTDN_STST_CODE,
                       r.sorlcur_term_code  as sorlterm
                    from SZCARGA a, spriden S, sgbstdn G, sorlcur r, sztdtec z, smrpaap p, sztmaco t, smrarul u
                    where  a.SZCARGA_NO_REGLA = 98
                    --and a.SZCARGA_USER_ID = 'EXEX'
                    --and a.szcarga_id  =  010004551
                    and s.spriden_id=a.szcarga_id
                    and s.spriden_change_ind is null
                    and  g.sgbstdn_pidm=spriden_pidm
                    And g.SGBSTDN_TERM_CODE_EFF = (select max (b1.SGBSTDN_TERM_CODE_EFF)
                                                     from SGBSTDN b1
                                                    Where g.sgbstdn_pidm = b1.sgbstdn_pidm
                                                      -- AND g.sgbstdn_program_1 = b1.sgbstdn_program_1
                                                   )
                    and r.sorlcur_pidm= s.spriden_pidm
                    AND r.sorlcur_pidm = g.sgbstdn_pidm
                    --AND r.sorlcur_program = g.sgbstdn_program_1
                    and r.sorlcur_program=szcarga_program
                    and r.sorlcur_lmod_code='LEARNER'
                    and r.sorlcur_seqno in (select max(sorlcur_seqno)
                                              from sorlcur ss
                                             where r.sorlcur_pidm=ss.sorlcur_pidm
                                               and r.sorlcur_lmod_code=ss.sorlcur_lmod_code
                                               and r.sorlcur_program=ss.sorlcur_program)
                    and z.sztdtec_program=r.sorlcur_program
                    and z.sztdtec_term_code=r.sorlcur_term_code_ctlg-----outer join
                    and p.smrpaap_program= r.sorlcur_program
                    and p.smrpaap_term_code_eff=r.sorlcur_term_code_ctlg
                    and T.SZTMACO_MATPADRE  = a.szcarga_materia  --- se quito por que esta es la clave legal en maco no lleva punto ??ion
                    and u.smrarul_area=p.smrpaap_area
                    and u.smrarul_term_code_eff=p.smrpaap_term_code_eff
                    and (u.smrarul_subj_code||u.smrarul_crse_numb_low) = SZTMACO_MATHIJO
                    order by  iden, 10

              ) loop

            --dbms_output.put_line('pidm:'||c.pidm||' id:'||c.iden||'subj||crse:'||c.subj||c.crse||'programa:'||c.prog||'parte:'||c.parte ||'Materia' ||c.materia);

            crn := null;
            pidm_doc2 := null;
            conta_sirasgn :=0;
            vl_periodo_act := null;
            vl_error := 'EXITO';

        for d in (
                  select ZSTPARA_PARAM_ID estatus
                    from zstpara
                   where zstpara_mapa_id='ESTATUS_CARG'
                     and ZSTPARA_PARAM_VALOR='ACTIVO'
                 ) loop

--              Procesa solo los estatus con valor = ACTIVO or c.periodo,5,1 sean 8 y 9

--                   IF C.SGBSTDN_STST_CODE not in ('BT','BI','BD','EG','SG','CV') OR SUBSTR(C.periodo,5,1) in  ('8','9') then
                   IF  C.SGBSTDN_STST_CODE=d.estatus OR SUBSTR(C.periodo,5,1) in  ('8','9') then

                         crn :=null;
                         vl_periodo_act := null;

                            begin

                                 Select max (x.crn) crn, x.periodo
                                     into crn ,vl_periodo_act
                                from (
                                         select b.sfrstcr_crn crn , b.SFRSTCR_TERM_CODE periodo
                                           from ssbsect a, sfrstcr b
                                          where b.sfrstcr_pidm=  c.pidm
                                            and a.ssbsect_crn= b.sfrstcr_crn
                                            and a.ssbsect_subj_code= c.subj
                                            and a.ssbsect_crse_numb=c.crse
                                            and b.SFRSTCR_RSTS_CODE = 'RE'
                                            and a.SSBSECT_TERM_CODE  = b.SFRSTCR_TERM_CODE
                                            and b.SFRSTCR_TERM_CODE = c.periodo
                                            order by 2 desc
                                       ) x
                                    group by x.periodo;

                               Exception
                                when no_data_found then
                                   crn:=null;
                                    vl_error := 'No existe la Materia: Revisar que los datos sean correctos '||sqlerrm;
                                when others then
                                    crn:=null;
                                    vl_error := 'No existe la Materia: Revisar que los datos sean correctos: ' ||sqlerrm;

                            end;

                          --dbms_output.put_line('CRN:'||  crn ||'*'||vl_periodo_act ||'*'||vl_error);

                            vl_alumno :=0;
                            if crn is not null then

                               if c.calif is not null then

                                     Begin
                                            select count(1)
                                             into vl_alumno
                                            from sfrstcr
                                           where sfrstcr_pidm= c.pidm
                                             and sfrstcr_term_code= vl_periodo_act
                                             and sfrstcr_crn= crn
                                             AND SFRSTCR_RSTS_CODE = 'RE'    ;
--                                              dbms_output.put_line('valida existe:'||  vl_alumno ||'*'||vl_periodo_act ||'*'||vl_error);

                                     Exception
                                        When No_Data_Found then
                                          vl_error := 'No se Encontro la Materia para el alumno: '||sqlerrm;
                                          vl_alumno :=0;
--                                          dbms_output.put_line('valida No se Encontro la Materia error1:'||  vl_alumno ||'*'||vl_periodo_act ||'*'||vl_error);
                                        When Others then
                                         vl_error := 'Se presento el siguiente Error al actualizar la calificacion: '||sqlerrm;
                                         vl_alumno :=0;
--                                         dbms_output.put_line('valida existe al actualizar error2:'||  vl_alumno ||'*'||vl_periodo_act ||'*'||vl_error);
                                     End;

                                     If vl_alumno >= 1 then
                                            Begin
                                                      update sfrstcr
                                                            set sfrstcr_grde_code=c.calif,
                                                                 sfrstcr_activity_date=sysdate,
                                                                 sfrstcr_user_id=user,
                                                                 SFRSTCR_GRDE_DATE = NULL,
                                                                 SFRSTCR_DATA_ORIGIN = 'SZTCALI'---'SZTCALI'
                                                      where sfrstcr_pidm=c.pidm
                                                      and sfrstcr_term_code=vl_periodo_act
                                                      and sfrstcr_crn=crn
                                                      AND SFRSTCR_RSTS_CODE = 'RE'    ;
                                                      --dbms_output.put_line('salida Materia 1:'||  vl_alumno ||'*'||c.materia  ||'*'||vl_error);

                                            Exception
                                                When No_Data_Found then
                                                  vl_error := 'No se Encontro la Materia ' ||c.materia || ' para el alumno';
--                                                  dbms_output.put_line('Error Materia No se Encontro 1:'||  vl_alumno ||'*'||c.materia  ||'*'||vl_error);
                                                When Others then
                                                 vl_error := 'Se presento el siguiente Error al actualizar la calificacion: '||sqlerrm;
--                                                 dbms_output.put_line('Error al actualizar CALIF  2:'||  vl_alumno ||'*'||c.materia  ||'*'||vl_error);
                                            End;
                                    Else
                                      vl_error := 'No se encontro la Materia ' ||c.materia || ' para el alumno';
                                      --dbms_output.put_line(vl_error);
                                    End if;

                                    if  vl_error = 'EXITO' then

                                         if c.prof is not null then

                                             begin
                                                 select  spriden_pidm
                                                    into pidm_doc2
                                                 from spriden
                                                 where spriden_id=c.prof
                                                 and spriden_change_ind is null;
                                                 exception
                                                 when others then
                                                    pidm_doc2:=null;
                                             end;

                                             if pidm_doc2 is not null then

                                                Begin
                                                        select count(*)
                                                            into conta_sirasgn
                                                        from sirasgn
                                                        where sirasgn_term_code=vl_periodo_act
                                                        and sirasgn_crn=crn
                                                        and sirasgn_pidm=pidm_doc2
                                                        And SIRASGN_PRIMARY_IND = 'Y';
                                                Exception
                                                    When Others then
                                                      conta_sirasgn :=0;
                                                End;

                                                If conta_sirasgn = 0 then
                                                    Begin
                                                           select count(*)
                                                                into conta_sirasgn
                                                            from sirasgn
                                                            where sirasgn_term_code=vl_periodo_act
                                                            and sirasgn_crn=crn
                                                            and sirasgn_pidm=pidm_doc2
                                                            And SIRASGN_PRIMARY_IND != 'Y';
                                                    Exception
                                                        When Others then
                                                         conta_sirasgn :=0;
                                                    End;

                                                    if conta_sirasgn > 0 then
                                                       Begin
                                                               Update sirasgn
                                                                set SIRASGN_PRIMARY_IND = 'Y',
                                                                      SIRASGN_DATA_ORIGIN ='SZTCALI'
                                                               where sirasgn_term_code=vl_periodo_act
                                                               and sirasgn_crn=crn
                                                               and sirasgn_pidm=pidm_doc2;
                                                       Exception
                                                        When Others then
                                                          vl_error := 'Se presento un error al actualizar el docente= ' ||sqlerrm;
                                                           --dbms_output.put_line(vl_error);
                                                       End;
                                                    Elsif conta_sirasgn = 0 then
                                                        Begin
                                                                insert into sirasgn values(vl_periodo_act, crn, pidm_doc2, '01', 100, null, 100, 'Y', null, null, sysdate, null, null, null, null, 'SZTCALI', user,  null, null, null, null, null, null);
                                                        Exception
                                                            When Others then
                                                              vl_error := 'Se presento un error al insertar el docente= ' ||sqlerrm;
                                                               --dbms_output.put_line(vl_error);
                                                        End;
                                                    end if;

                                                End if;

                                             end if;

                                         end if;

                                     end if;

                               else
                                 vl_error := 'No se detecto Calificacion en el archivo para la materia '||c.materia  ;
                                  --dbms_output.put_line(vl_error);
                               End if;


                            End if;

                            if vl_error = 'EXITO' then
                                    --dbms_output.put_line('mensaje commit:'||vl_error);
                                    Begin
                                            Insert into SZtCARGA values (c.iden, --SZCARGA_ID
                                                                         c.materia, --SZCARGA_MATERIA
                                                                         c.prog,         --SZCARGA_PROGRAM
                                                                         vl_periodo_act,         --SZCARGA_TERM_CODE
                                                                         c.parte,         --SZCARGA_PTRM_CODE
                                                                         c.grupo,         --SZCARGA_GRUPO
                                                                         c.calif,         --SZCARGA_CALIF
                                                                         c.prof,         --SZCARGA_ID_PROF
                                                                         user,         --SZCARGA_USER_ID
                                                                         sysdate,         --SZCARGA_ACTIVITY_DATE
                                                                         c.fecha_inicio,         --SZCARGA_FECHA_INI
                                                                         'P',          --SZCARGA_ESTATUS
                                                                         'Calificacion Cargada' ,  --SZCARGA_OBSERVACIONES
                                                                         'CALI',
                                                                         98
                                                                         );

                                    Exception
                                     when DUP_VAL_ON_INDEX then
                                        Begin
                                          Update SZtCARGA
                                          set SZCARGA_ESTATUS = 'P' ,
                                          SZCARGA_OBSERVACIONES =  'Calificacion Cargada',
                                          SZCARGA_CALIF=c.calif,
                                          SZCARGA_ACTIVITY_DATE = sysdate
                                          Where SZCARGA_ID = c.iden
                                          and SZCARGA_MATERIA = c.materia
                                          AND SZTCARGA_TIPO_PROC = 'CALI'
                                          and  SZTCARGA_NO_REGLA = 98
                                          and trunc (SZCARGA_FECHA_INI) = c.fecha_inicio;
                                          Exception
                                          When Others then
                                          vl_error := 'Se presento un Error al Actualizar la bitacora '||sqlerrm;
                                          --dbms_output.put_line('mensaje rollback1:'||vl_error);
                                        End;
                                    When Others then
                                     vl_error := 'Se presento un Error al insertar la bitacora '||sqlerrm;
                                     --dbms_output.put_line('mensaje rollback2:'||vl_error);
                                    End;
                                    commit; --Commit;

                            Else
                                 --dbms_output.put_line('mensaje rollback general:'||vl_error);
                                   rollback;
                                    Begin
                                            Insert into SZtCARGA values (c.iden, --SZCARGA_ID
                                                                         c.materia, --SZCARGA_MATERIA
                                                                         c.prog,         --SZCARGA_PROGRAM
                                                                         c.periodo,         --SZCARGA_TERM_CODE
                                                                         c.parte,         --SZCARGA_PTRM_CODE
                                                                         c.grupo,         --SZCARGA_GRUPO
                                                                         c.calif,         --SZCARGA_CALIF
                                                                         c.prof,         --SZCARGA_ID_PROF
                                                                         user,         --SZCARGA_USER_ID
                                                                         sysdate,         --SZCARGA_ACTIVITY_DATE
                                                                         c.fecha_inicio,         --SZCARGA_FECHA_INI
                                                                         'E',          --SZCARGA_ESTATUS
                                                                         vl_error,  --SZCARGA_OBSERVACIONES
                                                                         'CALI',
                                                                         98
                                                                        );
                                              commit;
                                    Exception
                                     when DUP_VAL_ON_INDEX then
                                        Begin
                                          Update SZtCARGA
                                          set SZCARGA_ESTATUS = 'E' ,
                                          SZCARGA_OBSERVACIONES =  vl_error,
                                          SZCARGA_CALIF=c.calif,
                                          SZCARGA_ACTIVITY_DATE = sysdate
                                          Where SZCARGA_ID = c.iden
                                          and SZCARGA_MATERIA = c.materia
                                          AND SZTCARGA_TIPO_PROC = 'CALI'
                                          and  SZTCARGA_NO_REGLA = 98
                                          and trunc (SZCARGA_FECHA_INI) = c.fecha_inicio;
                                          commit; --Commit;
                                          Exception
                                          When Others then
                                          vl_error := 'Se presento un Error al Actualizar la bitacora de Error=  '||sqlerrm;
                                         -- dbms_output.put_line('mensaje rollback2 general:'||vl_error);
                                        End;
                                    When Others then
                                     vl_error := 'Se presento un Error al insertar la bitacora de Error=  '||sqlerrm;
                                     --dbms_output.put_line('mensaje rollback2 general:'||vl_error);
                                    End;


                            End if;

                    END IF;


                 end loop;
          --p_error := vl_error;

        end loop;

--IF  vl_error  != 'EXITO'  THEN
 --DBMS_OUTPUT.PUT_LINE('ENTRO A LA ZONA  DE ERROR....'||vl_error );


for x in c_no_proce loop

 --DBMS_OUTPUT.PUT_LINE('ERRRRRORR....'||x.SZCARGA_ID ||'*'|| x.SZCARGA_MATERIA);
                vl_alumno :=0;
                 Begin
                        select count (1)
                          Into vl_alumno
                          from SZTMACO
                         where SZTMACO_MATPADRE  = x.SZCARGA_MATERIA
                           and SZTMACO_CAMP_CODE=substr(x.SZCARGA_program,1,3);
                 Exception
                    When Others then
                       vl_alumno :=0;
                 End;

                vl_error := null;

                If vl_alumno >= 1 then
                    vl_error := 'Estatus no valido del alumno para realizar carga SZFPARA "ESTATUS_CARG" ';
                Elsif vl_alumno = 0 then
                    vl_error := 'No se detecto la materia  ' || x.SZCARGA_MATERIA ||' Campus : '||substr(x.SZCARGA_program,1,3)||' Como materia padre en SZFMACO';
                End if;
                --DBMS_OUTPUT.PUT_LINE('ERRRRRORR....'||x.SZCARGA_ID ||'*'|| x.SZCARGA_MATERIA||'*'||vl_error);

                   Begin
                            Insert into SZtCARGA values (x.SZCARGA_ID, --SZCARGA_ID
                                                         x.SZCARGA_MATERIA, --SZCARGA_MATERIA
                                                         x.SZCARGA_PROGRAM,         --SZCARGA_PROGRAM
                                                         x.SZCARGA_TERM_CODE,         --SZCARGA_TERM_CODE
                                                         x.SZCARGA_PTRM_CODE,         --SZCARGA_PTRM_CODE
                                                         x.SZCARGA_GRUPO,         --SZCARGA_GRUPO
                                                         x.SZCARGA_CALIF,         --SZCARGA_CALIF
                                                         x.SZCARGA_ID_PROF,         --SZCARGA_ID_PROF
                                                         user,         --SZCARGA_USER_ID
                                                         sysdate,         --SZCARGA_ACTIVITY_DATE
                                                         x.SZCARGA_FECHA_INI,         --SZCARGA_FECHA_INI
                                                         'E',          --SZCARGA_ESTATUS
                                                         vl_error,  --SZCARGA_OBSERVACIONES
                                                         'CALI',
                                                         98
                                                        );
                              commit;
                   Exception
                     when DUP_VAL_ON_INDEX then
                        Begin
                          Update SZtCARGA
                          set SZCARGA_ESTATUS = 'E',
                          SZCARGA_CALIF=x.SZCARGA_CALIF,
                          SZCARGA_OBSERVACIONES =  vl_error,
                          SZCARGA_ACTIVITY_DATE = sysdate
                          Where SZCARGA_ID = x.SZCARGA_ID
                          and SZCARGA_MATERIA = x.SZCARGA_MATERIA
                          AND SZTCARGA_TIPO_PROC = 'CALI'
                          and  SZTCARGA_NO_REGLA = 98
                          and trunc (SZCARGA_FECHA_INI) = x.SZCARGA_FECHA_INI;
                          commit; --Commit;
                          Exception
                          When Others then
                          vl_error := 'Se presento un Error al Actualizar la bitacora de Error '||sqlerrm;
                        End;
                    When Others then
                     vl_error := 'Se presento un Error al insertar la bitacora de Error '||sqlerrm;
                    End;
end loop;

----End;

--end if;
 commit;
end;

END leer_file_carga_Calif_NW;


/*
PROCEDURE leer_file_carga_Calif_NW   (p_error out varchar2 )  IS

 cadena VARCHAR2(32767);
 Vfile UTL_FILE.FILE_TYPE;
 iden         varchar2(25);
 materia    varchar2(25);
 prog         varchar2(25);
 periodo     varchar2(20);
 --parte        varchar2(4);
 --grupo       varchar2(5);
 calif          varchar2(10);
 iden_prof  varchar2(10);
 f1             VARCHAR2(10);
 f2             VARCHAR2(10);
 var           number;
 coma        number;
 i               number;
 bimestre   varchar2(10);

 crn       varchar2(5);
gpo     number;
mate   varchar2(20);
ciclo    varchar2(6);
subj       varchar2(4);
crse       varchar2(5);
sb       varchar2(4);
cr       varchar2(5);
schd   varchar2(3);
title    varchar2(50);
credit decimal(7,3);
gmod  varchar2(2);
f_inicio date;
f_fin     date;
sem     number;
conta_ptrm number;
conta_blck number;
pidm   number;
pidm_doc number;
pidm_doc2 number;
ests    varchar2(3);
levl     varchar2(3);
camp  varchar2(3);
rsts    varchar2(3);
conta_origen number:=0;
conta_destino number :=0;
conta_origen_ssbsect number:=0;
conta_origen_ssrblck number:=0;
conta_origen_sobptrm number:=0;
sp       integer;
ciclo_ext varchar2(6);
mensaje   varchar2(500);
parte varchar2(4);
pidm_prof number;
per    varchar2(6);
grupo varchar2(4);
conta_sirasgn number;

vl_error varchar2 (5000):= 'EXITO';
fecha_ini date;
fecha       varchar2(10);
vl_periodo_act varchar2(6);
vl_alumno number:=0;

cursor c_no_proce is
select *
from SZCARGA a
where  a.SZCARGA_NO_REGLA = 98
and (SZCARGA_ID, SZCARGA_MATERIA) not in (  select carg.SZCARGA_ID, carg.SZCARGA_MATERIA
                                                                        from SZtCARGA carg
                                                                        where  1=1
                                                                        and CARG.SZTCARGA_NO_REGLA = 98);


BEGIN

--fecha_ini:=to_date(pn_fecha,'dd/mm/rrrr');

 -- Abro fichero en lectura (Read)
 Vfile := UTL_FILE.FOPEN('IMAGEN','calificaciones.csv','R',256);
 delete from SZCARGA
 WHERE  SZCARGA_NO_REGLA = 98;

 commit;

    loop
        begin
         -- Leo del fichero
         UTL_FILE.GET_LINE(Vfile,cadena,32767);
         materia:=null; iden:=null; grupo:=null; prog:=null; periodo:=null; parte:=null; iden_prof:=null; var:=0; fecha := null;

           for i IN 1..60 loop
             -- -- dbms_output.put_line(substr(cadena,i,1)||' '||var);
              if substr(cadena,i,1)=',' then
                if var=0 then
                   iden:=trim(substr(cadena,1,i-1));
                   var:=1;
                   coma:=i;
                else
                   if var=1 then
                      materia:=trim(substr(cadena,coma+1,i-(coma+1)));
                      var:=2;
                      coma:=i;
                   else
                       if var=2 then
                          prog:=trim(substr(cadena,coma+1,i-(coma+1)));
                          var:=3;
                          coma:=i;
                       else
                          if var=3 then
                            periodo:=trim(substr(cadena,coma+1,i-(coma+1)));
                            var:=4;
                            coma:=i;
                          else
                             if var=4 then
                                parte:=trim(substr(cadena,coma+1,i-(coma+1)));
                                var:=5;
                                coma:=i;
                             else
                                 if var=5 then
                                    grupo:=trim(substr(cadena,coma+1,i-(coma+1)));
                                    var:=6;
                                    coma:=i;
                                 else
                                      if var=6 then
                                         calif:=trim(substr(cadena,coma+1,i-(coma+1)));
                                         var:=7;
                                         coma:=i;
                                     Else
                                            if var=7 then
                                              iden_prof:=trim(substr(cadena,coma+1,i-(coma+1)));
                                              fecha:=trim(substr(cadena,i+1,10));
                                             var:=8;
                                             coma:=i;
                                           End if;
                                         end if;
                                 end if;
                             end if;
                          end if;
                       end if;
                   end if;
                end if;
             end if;
           end loop;


            if iden is not null then
                Begin
                        insert into SZCARGA values(trim(iden), trim(materia), trim(prog), trim(periodo),trim(parte) , trim(grupo),trim(calif), trim(iden_prof), user, sysdate, to_date(fecha,'dd/mm/yyyy'),98,null);
                Exception
                When No_data_found then
                   vl_error := 'No se Encontraron Datos para registrar';
                  When Others then
                    vl_error := 'Se presento el error al insertar el tabla de Carga ' ||sqlerrm;
                End;
            end if;

        exception
        when NO_DATA_FOUND  then
          exit;
        end;

    end loop;
    p_error := vl_error;
 -- Cierro fichero
 commit;
 UTL_FILE.FCLOSE(Vfile);


BEGIN

delete SZtCARGA
WHERE SZTCARGA_NO_REGLA = 98;
commit;

            for c in (
                   select distinct spriden_pidm pidm,
                      szcarga_id iden  ,
                      szcarga_program prog,
                      sorlcur_camp_code campus,
                      sorlcur_levl_code nivel,
                      sorlcur_term_code_ctlg ctlg ,
                      szcarga_materia  materia ,
                       smrarul_subj_code subj,
                      smrarul_crse_numb_low crse ,
                        szcarga_term_code periodo ,
                       szcarga_ptrm_code parte,
                       decode(sztdtec_periodicidad,1,'BIMESTRAL',2,'CUATRIMESTRAL') periodicidad,
                        szcarga_grupo grupo,
                        szcarga_calif calif,
                        szcarga_id_prof prof,
                        SZCARGA_FECHA_INI Fecha_Inicio,
                        SORLCUR_KEY_SEQNO study, g.SGBSTDN_STST_CODE,
                        r.sorlcur_term_code  as sorlterm
from SZCARGA a, spriden S, sgbstdn G, sorlcur r, sztdtec z, smrpaap p, sztmaco t, smrarul u
where  a.SZCARGA_NO_REGLA = 98
--and a.SZCARGA_USER_ID = 'EXEX'
--and a.szcarga_id  =  010004551
and s.spriden_id=a.szcarga_id
and s.spriden_change_ind is null
and  g.sgbstdn_pidm=spriden_pidm
And g.SGBSTDN_TERM_CODE_EFF = (select max (b1.SGBSTDN_TERM_CODE_EFF)
                                                       from SGBSTDN b1
                                                       Where g.sgbstdn_pidm = b1.sgbstdn_pidm
                                                      -- AND g.sgbstdn_program_1 = b1.sgbstdn_program_1
                                                       )
and r.sorlcur_pidm= s.spriden_pidm
AND r.sorlcur_pidm = g.sgbstdn_pidm
--AND r.sorlcur_program = g.sgbstdn_program_1
and r.sorlcur_program=szcarga_program
and r.sorlcur_lmod_code='LEARNER'
and r.sorlcur_seqno in (select max(sorlcur_seqno)
                                            from sorlcur ss
                                            where r.sorlcur_pidm=ss.sorlcur_pidm
                                            and   r.sorlcur_lmod_code=ss.sorlcur_lmod_code
                                            and   r.sorlcur_program=ss.sorlcur_program)
and z.sztdtec_program=r.sorlcur_program
and z.sztdtec_term_code=r.sorlcur_term_code_ctlg-----outer join
and p.smrpaap_program= r.sorlcur_program
and p.smrpaap_term_code_eff=r.sorlcur_term_code_ctlg
and T.SZTMACO_MATPADRE  = a.szcarga_materia  --- se quito por que esta es la clave legal en maco no lleva punto ??ion
and u.smrarul_area=p.smrpaap_area
and u.smrarul_term_code_eff=p.smrpaap_term_code_eff
and (u.smrarul_subj_code||u.smrarul_crse_numb_low) = SZTMACO_MATHIJO
order by  iden, 10

            ) loop

            --dbms_output.put_line('pidm:'||c.pidm||' id:'||c.iden||'subj||crse:'||c.subj||c.crse||'programa:'||c.prog||'parte:'||c.parte ||'Materia' ||c.materia);

            crn := null;
            pidm_doc2 := null;
            conta_sirasgn :=0;
            vl_periodo_act := null;

            vl_error := 'EXITO';

   IF  C.SGBSTDN_STST_CODE not in  ('xx','xx','xx')  OR SUBSTR(C.periodo,5,1) in  ('8','9') then
--      IF C.SGBSTDN_STST_CODE not in ('BT','BI','BD','EG','SG','CV')   then

--    IF  C.SGBSTDN_STST_CODE in (select ZSTPARA_PARAM_ID from zstpara where zstpara_mapa_id='ESTATUS_CARG' and ZSTPARA_PARAM_VALOR='ACTIVO')
--        OR SUBSTR(C.periodo,5,1) in  ('8','9') then


         crn :=null;
         vl_periodo_act := null;

            begin

                 Select max (x.crn) crn, x.periodo
                     into crn ,vl_periodo_act
                from (
                 select b.sfrstcr_crn crn , b.SFRSTCR_TERM_CODE periodo
                    from ssbsect a, sfrstcr b
                    where b.sfrstcr_pidm=  c.pidm
                   and a.ssbsect_crn= b.sfrstcr_crn
                    and a.ssbsect_subj_code= c.subj
                   and a.ssbsect_crse_numb=c.crse
                    and b.SFRSTCR_RSTS_CODE = 'RE'
                     and a.SSBSECT_TERM_CODE  = b.SFRSTCR_TERM_CODE
                     and b.SFRSTCR_TERM_CODE = c.periodo
--                   and b.SFRSTCR_TERM_CODE = (select max (b1.SFRSTCR_TERM_CODE)
--                                                                    from SFRSTCR b1, ssbsect a1
--                                                                    where b1.sfrstcr_pidm = b.sfrstcr_pidm
--                                                                    and b1.sfrstcr_crn = a1.ssbsect_crn
--                                                                    and   a.ssbsect_subj_code= a1.ssbsect_subj_code
--                                                                    and a.ssbsect_crse_numb = a1.ssbsect_crse_numb
--                                                                    and a1.SSBSECT_TERM_CODE  = b1.SFRSTCR_TERM_CODE
--                                                                    )
                    order by 2 desc ) x
                    group by x.periodo;

               Exception
                when no_data_found then
                   crn:=null;
                    vl_error := 'No existe la Materia: Revisar que los datos sean correctos '||sqlerrm;
                when others then
                    crn:=null;
                    vl_error := 'No existe la Materia: Revisar que los datos sean correctos: ' ||sqlerrm;

            end;

          --dbms_output.put_line('CRN:'||  crn ||'*'||vl_periodo_act ||'*'||vl_error);

            vl_alumno :=0;
            if crn is not null then

               if c.calif is not null then

                     Begin

                            select count(1)
                             into vl_alumno
                            from sfrstcr
                               where sfrstcr_pidm= c.pidm
                              and sfrstcr_term_code= vl_periodo_act
                              and sfrstcr_crn= crn
                              AND SFRSTCR_RSTS_CODE = 'RE'    ;
                              --dbms_output.put_line('valida existe:'||  vl_alumno ||'*'||vl_periodo_act ||'*'||vl_error);

                     Exception
                        When No_Data_Found then
                          vl_error := 'No se Encontro la Materia para el alumno: '||sqlerrm;
                          vl_alumno :=0;
                          --dbms_output.put_line('valida existe error1:'||  vl_alumno ||'*'||vl_periodo_act ||'*'||vl_error);
                        When Others then
                         vl_error := 'Se presento el siguiente Error al actualizar la calificacion: '||sqlerrm;
                         vl_alumno :=0;
                         --dbms_output.put_line('valida existe error2:'||  vl_alumno ||'*'||vl_periodo_act ||'*'||vl_error);
                     End;

                     If vl_alumno >= 1 then
                            Begin
                                      update sfrstcr
                                            set sfrstcr_grde_code=c.calif,
                                                 sfrstcr_activity_date=sysdate,
                                                 sfrstcr_user_id=user,
                                                 SFRSTCR_GRDE_DATE = NULL,
                                                 SFRSTCR_DATA_ORIGIN = 'SZTCALI'---'SZTCALI'
                                      where sfrstcr_pidm=c.pidm
                                      and sfrstcr_term_code=vl_periodo_act
                                      and sfrstcr_crn=crn
                                      AND SFRSTCR_RSTS_CODE = 'RE'    ;
                                      --dbms_output.put_line('salida Materia 1:'||  vl_alumno ||'*'||c.materia  ||'*'||vl_error);

                            Exception
                                When No_Data_Found then
                                  vl_error := 'No se Encontro la Materia ' ||c.materia || ' para el alumno';
                                  --dbms_output.put_line('Error Materia 1:'||  vl_alumno ||'*'||c.materia  ||'*'||vl_error);
                                When Others then
                                 vl_error := 'Se presento el siguiente Error al actualizar la calificacion: '||sqlerrm;
                                 --dbms_output.put_line('Error Materia 1:'||  vl_alumno ||'*'||c.materia  ||'*'||vl_error);
                            End;
                    Else
                      vl_error := 'No se encontro la Materia ' ||c.materia || ' para el alumno';
                      --dbms_output.put_line(vl_error);
                    End if;

                    if  vl_error = 'EXITO' then

                         if c.prof is not null then

                             begin
                                 select  spriden_pidm
                                    into pidm_doc2
                                 from spriden
                                 where spriden_id=c.prof
                                 and spriden_change_ind is null;
                                 exception
                                 when others then
                                    pidm_doc2:=null;
                             end;

                             if pidm_doc2 is not null then

                                Begin
                                        select count(*)
                                            into conta_sirasgn
                                        from sirasgn
                                        where sirasgn_term_code=vl_periodo_act
                                        and sirasgn_crn=crn
                                        and sirasgn_pidm=pidm_doc2
                                        And SIRASGN_PRIMARY_IND = 'Y';
                                Exception
                                    When Others then
                                      conta_sirasgn :=0;
                                End;

                                If conta_sirasgn = 0 then
                                    Begin
                                           select count(*)
                                                into conta_sirasgn
                                            from sirasgn
                                            where sirasgn_term_code=vl_periodo_act
                                            and sirasgn_crn=crn
                                            and sirasgn_pidm=pidm_doc2
                                            And SIRASGN_PRIMARY_IND != 'Y';
                                    Exception
                                        When Others then
                                         conta_sirasgn :=0;
                                    End;

                                    if conta_sirasgn > 0 then
                                       Begin
                                               Update sirasgn
                                                set SIRASGN_PRIMARY_IND = 'Y',
                                                      SIRASGN_DATA_ORIGIN ='SZTCALI'
                                               where sirasgn_term_code=vl_periodo_act
                                               and sirasgn_crn=crn
                                               and sirasgn_pidm=pidm_doc2;
                                       Exception
                                        When Others then
                                          vl_error := 'Se presento un error al actualizar el docente= ' ||sqlerrm;
                                           --dbms_output.put_line(vl_error);
                                       End;
                                    Elsif conta_sirasgn = 0 then
                                        Begin
                                                insert into sirasgn values(vl_periodo_act, crn, pidm_doc2, '01', 100, null, 100, 'Y', null, null, sysdate, null, null, null, null, 'SZTCALI', user,  null, null, null, null, null, null);
                                        Exception
                                            When Others then
                                              vl_error := 'Se presento un error al insertar el docente= ' ||sqlerrm;
                                               --dbms_output.put_line(vl_error);
                                        End;
                                    end if;

                                End if;

                             end if;

                         end if;

                     end if;

               else
                 vl_error := 'No se detecto Calificacion en el archivo para la materia '||c.materia  ;
                  --dbms_output.put_line(vl_error);
               End if;


            End if;

            if vl_error = 'EXITO' then
                    --dbms_output.put_line('mensaje commit:'||vl_error);
                    Begin
                            Insert into SZtCARGA values (c.iden, --SZCARGA_ID
                                                                       c.materia, --SZCARGA_MATERIA
                                                                       c.prog,         --SZCARGA_PROGRAM
                                                                       vl_periodo_act,         --SZCARGA_TERM_CODE
                                                                       c.parte,         --SZCARGA_PTRM_CODE
                                                                       c.grupo,         --SZCARGA_GRUPO
                                                                       c.calif,         --SZCARGA_CALIF
                                                                       c.prof,         --SZCARGA_ID_PROF
                                                                       user,         --SZCARGA_USER_ID
                                                                       sysdate,         --SZCARGA_ACTIVITY_DATE
                                                                       c.fecha_inicio,         --SZCARGA_FECHA_INI
                                                                      'P',          --SZCARGA_ESTATUS
                                                                       'Calificaci??argada' ,  --SZCARGA_OBSERVACIONES
                                                                       'CALI',
                                                                       98
                                                                       );

                    Exception
                     when DUP_VAL_ON_INDEX then
                        Begin
                          Update SZtCARGA
                          set SZCARGA_ESTATUS = 'P' ,
                          SZCARGA_OBSERVACIONES =  'Calificaci??argada',
                          SZCARGA_CALIF=c.calif,
                          SZCARGA_ACTIVITY_DATE = sysdate
                          Where SZCARGA_ID = c.iden
                          and SZCARGA_MATERIA = c.materia
                          AND SZTCARGA_TIPO_PROC = 'CALI'
                          and  SZTCARGA_NO_REGLA = 98
                          and trunc (SZCARGA_FECHA_INI) = c.fecha_inicio;
                          Exception
                          When Others then
                          vl_error := 'Se presento un Error al Actualizar la bitacora '||sqlerrm;
                          --dbms_output.put_line('mensaje rollback1:'||vl_error);
                        End;
                    When Others then
                     vl_error := 'Se presento un Error al insertar la bitacora '||sqlerrm;
                     --dbms_output.put_line('mensaje rollback2:'||vl_error);
                    End;
                    commit; --Commit;

            Else
                 --dbms_output.put_line('mensaje rollback general:'||vl_error);
                   rollback;
                    Begin
                            Insert into SZtCARGA values (c.iden, --SZCARGA_ID
                                                                       c.materia, --SZCARGA_MATERIA
                                                                       c.prog,         --SZCARGA_PROGRAM
                                                                       c.periodo,         --SZCARGA_TERM_CODE
                                                                       c.parte,         --SZCARGA_PTRM_CODE
                                                                       c.grupo,         --SZCARGA_GRUPO
                                                                       c.calif,         --SZCARGA_CALIF
                                                                       c.prof,         --SZCARGA_ID_PROF
                                                                       user,         --SZCARGA_USER_ID
                                                                       sysdate,         --SZCARGA_ACTIVITY_DATE
                                                                       c.fecha_inicio,         --SZCARGA_FECHA_INI
                                                                      'E',          --SZCARGA_ESTATUS
                                                                       vl_error,  --SZCARGA_OBSERVACIONES
                                                                       'CALI',
                                                                       98
                                                                       );
                              commit;
                    Exception
                     when DUP_VAL_ON_INDEX then
                        Begin
                          Update SZtCARGA
                          set SZCARGA_ESTATUS = 'E' ,
                          SZCARGA_OBSERVACIONES =  vl_error,
                          SZCARGA_CALIF=c.calif,
                          SZCARGA_ACTIVITY_DATE = sysdate
                          Where SZCARGA_ID = c.iden
                          and SZCARGA_MATERIA = c.materia
                          AND SZTCARGA_TIPO_PROC = 'CALI'
                          and  SZTCARGA_NO_REGLA = 98
                          and trunc (SZCARGA_FECHA_INI) = c.fecha_inicio;
                          commit; --Commit;
                          Exception
                          When Others then
                          vl_error := 'Se presento un Error al Actualizar la bitacora de Error=  '||sqlerrm;
                         -- dbms_output.put_line('mensaje rollback2 general:'||vl_error);
                        End;
                    When Others then
                     vl_error := 'Se presento un Error al insertar la bitacora de Error=  '||sqlerrm;
                     --dbms_output.put_line('mensaje rollback2 general:'||vl_error);
                    End;


            End if;

    ELSE
       vl_error := 'Estatus no valido para realizar la carga: '||C.SGBSTDN_STST_CODE;
       --dbms_output.put_line(vl_error);
                   Begin
                            Insert into SZtCARGA values (c.iden, --SZCARGA_ID
                                                                       c.materia, --SZCARGA_MATERIA
                                                                       c.prog,         --SZCARGA_PROGRAM
                                                                       c.periodo,         --SZCARGA_TERM_CODE
                                                                       c.parte,         --SZCARGA_PTRM_CODE
                                                                       c.grupo,         --SZCARGA_GRUPO
                                                                       c.calif,         --SZCARGA_CALIF
                                                                       c.prof,         --SZCARGA_ID_PROF
                                                                       user,         --SZCARGA_USER_ID
                                                                       sysdate,         --SZCARGA_ACTIVITY_DATE
                                                                       c.fecha_inicio,         --SZCARGA_FECHA_INI
                                                                       'A',--'P',          --SZCARGA_ESTATUS
                                                                       vl_error,  --SZCARGA_OBSERVACIONES
                                                                       'CALI',
                                                                       98
                                                                       );
                              commit;
                              --dbms_output.put_line('commit errr 2 '||vl_error);
                   Exception
                     when DUP_VAL_ON_INDEX then
                        Begin
                          Update SZtCARGA
                          set SZCARGA_ESTATUS = 'A',--'P' ,
                          SZCARGA_CALIF=c.calif,
                          SZCARGA_OBSERVACIONES =  vl_error,
                          SZCARGA_ACTIVITY_DATE = sysdate
                          Where SZCARGA_ID = c.iden
                          and SZCARGA_MATERIA = c.materia
                          AND SZTCARGA_TIPO_PROC = 'CALI'
                          and  SZTCARGA_NO_REGLA = 98
                          and trunc (SZCARGA_FECHA_INI) = c.fecha_inicio;
                          commit; --Commit;
                          Exception
                          When Others then
                          vl_error := 'Se presento un Error al Actualizar la bitacora de Error '||sqlerrm;
                         -- dbms_output.put_line('commit rollback 3 '||vl_error);
                        End;
                    When Others then
                     vl_error := 'Se presento un Error al insertar la bitacora de Error '||sqlerrm;
                     --dbms_output.put_line('commit rollback 4 ' ||vl_error);
                    End;
    END IF;

    --p_error := vl_error;

end loop;

--IF  vl_error  != 'EXITO'  THEN
 --DBMS_OUTPUT.PUT_LINE('ENTRO A LA ZONA  DE ERROR....'||vl_error );


for x in c_no_proce loop

 --DBMS_OUTPUT.PUT_LINE('ERRRRRORR....'||x.SZCARGA_ID ||'*'|| x.SZCARGA_MATERIA);
                vl_alumno :=0;
                Begin
                        select count (1)
                        Into vl_alumno
                        from SZTMACO
                        where SZTMACO_MATPADRE  = x.SZCARGA_MATERIA
                          and SZTMACO_CAMP_CODE=substr(x.SZCARGA_program,1,3);
                Exception
                    When Others then
                       vl_alumno :=0;
                End;

                vl_error := null;

                If vl_alumno >= 1 then
                    vl_error := 'No se Encontro el registro en la consulta Principal Validar con Servicios Escolares';
                Elsif vl_alumno = 0 then
                    vl_error := 'No se detecto la materia  ' || x.SZCARGA_MATERIA ||' Como materia padre en SZFMACO';
                End if;
                --DBMS_OUTPUT.PUT_LINE('ERRRRRORR....'||x.SZCARGA_ID ||'*'|| x.SZCARGA_MATERIA||'*'||vl_error);

                   Begin
                            Insert into SZtCARGA values (x.SZCARGA_ID, --SZCARGA_ID
                                                                       x.SZCARGA_MATERIA, --SZCARGA_MATERIA
                                                                       x.SZCARGA_PROGRAM,         --SZCARGA_PROGRAM
                                                                       x.SZCARGA_TERM_CODE,         --SZCARGA_TERM_CODE
                                                                       x.SZCARGA_PTRM_CODE,         --SZCARGA_PTRM_CODE
                                                                       x.SZCARGA_GRUPO,         --SZCARGA_GRUPO
                                                                       x.SZCARGA_CALIF,         --SZCARGA_CALIF
                                                                       x.SZCARGA_ID_PROF,         --SZCARGA_ID_PROF
                                                                       user,         --SZCARGA_USER_ID
                                                                       sysdate,         --SZCARGA_ACTIVITY_DATE
                                                                       x.SZCARGA_FECHA_INI,         --SZCARGA_FECHA_INI
                                                                       'E',          --SZCARGA_ESTATUS
                                                                       vl_error,  --SZCARGA_OBSERVACIONES
                                                                       'CALI',
                                                                       98
                                                                       );
                              commit;
                   Exception
                     when DUP_VAL_ON_INDEX then
                        Begin
                          Update SZtCARGA
                          set SZCARGA_ESTATUS = 'E',
                          SZCARGA_CALIF=x.SZCARGA_CALIF,
                          SZCARGA_OBSERVACIONES =  vl_error,
                          SZCARGA_ACTIVITY_DATE = sysdate
                          Where SZCARGA_ID = x.SZCARGA_ID
                          and SZCARGA_MATERIA = x.SZCARGA_MATERIA
                          AND SZTCARGA_TIPO_PROC = 'CALI'
                          and  SZTCARGA_NO_REGLA = 98
                          and trunc (SZCARGA_FECHA_INI) = x.SZCARGA_FECHA_INI;
                          commit; --Commit;
                          Exception
                          When Others then
                          vl_error := 'Se presento un Error al Actualizar la bitacora de Error '||sqlerrm;
                        End;
                    When Others then
                     vl_error := 'Se presento un Error al insertar la bitacora de Error '||sqlerrm;
                    End;
end loop;

----End;

--end if;
 commit;
end;

END leer_file_carga_Calif_NW;
*/


PROCEDURE P_ACTUALIZA_JORNADA (P_PIDM NUMBER, P_PERIODO VARCHAR2, P_JORNADA VARCHAR2, P_STUDY NUMBER) AS

vn_number number :=0;

Begin

            Begin
                    Select count (*)
                        into vn_number
                    from SGRSATT
                    where SGRSATT_PIDM = P_PIDM
                   -- and SGRSATT_ATTS_CODE = P_JORNADA
                   and regexp_like(SGRSATT_ATTS_CODE, '^[0-9]')
                    and SGRSATT_TERM_CODE_EFF = P_PERIODO
                    And SGRSATT_STSP_KEY_SEQUENCE  = P_STUDY;
            Exception
            When Others then
               vn_number :=0;
            End;

            If vn_number = 0  and  substr(P_PERIODO,5,1) not in (8,9) then
                Begin
                        Insert into SGRSATT values (P_PIDM,
                                                    P_PERIODO,
                                                    P_JORNADA,
                                                    sysdate,
                                                    P_STUDY,
                                                    null,
                                                    null,
                                                    user,
                                                    'SZFCARG',
                                                    NULL);
                Exception
                When Others then
                 null;
                End;

            Else
                 Begin

                  if substr(P_PERIODO,5,1) not in (8,9) then
                        Update  SGRSATT
                        set      SGRSATT_ATTS_CODE  = P_JORNADA,
                                   SGRSATT_ACTIVITY_DATE = sysdate,
                                   SGRSATT_USER_ID = user,
                                   SGRSATT_DATA_ORIGIN= 'SZFCARG'
                        Where  SGRSATT_PIDM                 = P_PIDM
                        and     SGRSATT_TERM_CODE_EFF = P_PERIODO
                        and     SGRSATT_STSP_KEY_SEQUENCE = P_STUDY
                        and     regexp_like(SGRSATT_ATTS_CODE, '^[0-9]');
                    end if;

                  NULL;
                Exception
                When Others then
                 null;
                End;

            End if;

    commit;

End;


PROCEDURE leer_file_carga_extra (p_error out varchar2) IS

 cadena VARCHAR2(32767);
 Vfile UTL_FILE.FILE_TYPE;
 iden         varchar2(20);
 materia    varchar2(20);
 prog         varchar2(20);
 periodo     varchar2(20);
 parte        varchar2(8);
 grupo       varchar2(5);
 calif          varchar2(10);
 fecha       varchar2(14);
 iden_prof  varchar2(12);
 f1             VARCHAR2(10);
 f2             VARCHAR2(10);
 var           number;
 coma        number;
 i               number;
 bimestre   varchar2(1);

BEGIN

 -- En este ejemplo leo una linea del fichero prueba.txt


 -- Abro fichero en lectura (Read)
 Vfile := UTL_FILE.FOPEN('IMAGEN','extraordinarios.csv','R',256);
delete from SZCARGA
where  SZCARGA_NO_REGLA = 99;
commit;

loop
    begin
     -- Leo del fichero
     UTL_FILE.GET_LINE(Vfile,cadena,32767);
     materia:=null; iden:=null; grupo:=null; prog:=null; periodo:=null; parte:=null; iden_prof:=null; var:=0;  fecha := null; calif :=null;

     for i IN 1..70 loop
     -- -- dbms_output.put_line(substr(cadena,i,1)||' '||var);
              if substr(cadena,i,1)=',' then
                if var=0 then
                   iden:=trim(substr(cadena,1,i-1));
                   var:=1;
                   coma:=i;
                else
                   if var=1 then
                      materia:=trim(substr(cadena,coma+1,i-(coma+1)));
                      var:=2;
                      coma:=i;
                   else
                       if var=2 then
                          prog:=trim(substr(cadena,coma+1,i-(coma+1)));
                          var:=3;
                          coma:=i;
                       else
                          if var=3 then
                            periodo:=trim(substr(cadena,coma+1,i-(coma+1)));
                            var:=4;
                            coma:=i;
                          else
                             if var=4 then
                                parte:=trim(substr(cadena,coma+1,i-(coma+1)));
                                var:=5;
                                coma:=i;
                             else
                                 if var=5 then
                                    grupo:=trim(substr(cadena,coma+1,i-(coma+1)));
                                    var:=6;
                                    coma:=i;
                                 else
                                     if var=6 then
                                         calif:=trim(substr(cadena,coma+1,i-(coma+1)));
                                         var:=7;
                                         coma:=i;
                                     Else
                                            if var=7 then
                                              iden_prof:=trim(substr(cadena,coma+1,i-(coma+1)));
                                            -- fecha:=trim(substr(cadena,coma+1,i-(coma+1)));
                                             fecha:=trim(substr(cadena,i+1,10));
                                             var:=8;
                                             coma:=i;
                                           End if;
                                         end if;
                                 end if;
                             end if;
                          end if;
                       end if;
                   end if;
                end if;
             end if;



     end loop;


    -- dbms_output.put_line('iden:'||iden||' materia:'||materia||' '||'prog:'||prog||' '||' periodo:'||periodo||' parte:'||parte||' grupo:'||grupo||' '||'calif:'||calif||' profesor:'||iden_prof||' Fecha:'||fecha);
    --if iden is not null then
        Begin
            insert into SZCARGA values(trim(iden), trim(materia), trim(prog), trim(periodo),trim(parte) , trim(grupo),trim(calif), trim(iden_prof),'EXEX', sysdate,to_date(fecha,'dd/mm/yyyy'),99,null);
        Exception
        When Others then
        p_error:=sqlerrm;
       -- dbms_output.put_line('Salida iden:'||iden||' materia:'||materia||' '||'prog:'||prog||' '||' periodo:'||periodo||' parte:'||parte||' grupo:'||grupo||' '||'calif:'||calif||' profesor:'||iden_prof||' Fecha:'||fecha);
        End;
    --end if;

    exception
      when NO_DATA_FOUND  then

      --p_error:=sqlerrm;
      exit;
     when OTHERS  then
      p_error:=sqlerrm;
      exit;
    end;
end loop;

 commit;
 UTL_FILE.FCLOSE(Vfile);

--delete from szfcarg
--where szcarga_term_code in (select szcarga_term_code from szcarga)
--and     szcarga_ptrm_code in (select szcarga_ptrm_code from szcarga);
--commit;
--
--insert into szfcarg
--select * from szcarga;
--commit;

 -- Muestro por partalla la linea

END leer_file_carga_extra;

PROCEDURE carga_inscrip_extra  (pn_fecha  in varchar2 ) is

vn_number   NUMBER;
crn2      number;
crn      varchar2(8);
gpo     number;
mate    varchar2(20);
ciclo    varchar2(6);
subj       varchar2(4);
crse       varchar2(5);
sb       varchar2(4);
cr       varchar2(5);
schd   varchar2(3);
title    varchar2(30);
credit decimal(7,3);
credit_bill decimal(7,3);
gmod  varchar2(1);
f_inicio date;
f_fin     date;
sem     number;
conta_ptrm number;
conta_blck number;
pidm   number;
pidm_doc number;
pidm_doc2 number;
ests    varchar2(2);
levl     varchar2(2);
camp  varchar2(3);
rsts    varchar2(3);
conta_origen number:=0;
conta_destino number :=0;
conta_origen_ssbsect number:=0;
conta_origen_ssrblck number:=0;
conta_origen_sobptrm number:=0;
sp       integer;
ciclo_ext varchar2(6);
mensaje   varchar2(200);
parte varchar2(3);
pidm_prof number;
per    varchar2(6);
grupo varchar2(4);
conta_sirasgn number;
fecha_ini date;
vl_existe number :=0;

vn_lugares number:=0;
vn_cupo_max number:=0;
vn_cupo_act number:=0;
vl_error varchar2 (2500):= 'EXITO';

parteper_cur  varchar2(3);
period_cur varchar2(10);
vl_jornada varchar2(250):=null;
vl_exite_prof number :=0;
vvalidacion    number:=0;
no_recibo      number:=0;
--niv     varchar2(1);
vcrn    varchar2(3);
l_campus_ms  varchar2(4);

cursor c_no_proce is-----
select *
    from szcarga carg
    where  1=1
    --and carg.SZCARGA_ID='010078157'
     and CARG.SZCARGA_NO_REGLA = 99
     and CARG.SZCARGA_USER_ID = 'EXEX'
      and not exists (select 1
                 from SZtCARGA zt
                 where ZT.SZCARGA_ID  = carg.SZCARGA_ID
                 and   ZT.SZCARGA_MATERIA  =  carg.SZCARGA_MATERIA
                 and   ZT.SZCARGA_PROGRAM  =  carg.SZCARGA_PROGRAM
                 and   ZT.SZCARGA_PTRM_CODE  = carg.SZCARGA_PTRM_CODE
                 and   zt.SZCARGA_ESTATUS    is not null);
    /*   se modifico es este cursor mas sencillo por que lo unico que queremos saber es si quedo algun regs sin algun estatus ya sea de exito o error---vic 25 may 2018
     and not exists (select 1
                 from SZCARGA
                join spriden on spriden_id=szcarga_id and spriden_change_ind is null
                join  sgbstdn d on  d.sgbstdn_pidm=spriden_pidm
                And d.SGBSTDN_TERM_CODE_EFF = (select max (b1.SGBSTDN_TERM_CODE_EFF)
                                                   from SGBSTDN b1
                                                   Where d.sgbstdn_pidm = b1.sgbstdn_pidm
                                                   AND d.sgbstdn_program_1 = b1.sgbstdn_program_1
                                                   )
                join sorlcur s on sorlcur_pidm=spriden_pidm
                        and s.sorlcur_program=szcarga_program
                        and s.sorlcur_lmod_code='LEARNER'
                        and s.sorlcur_seqno in (select max(ss.sorlcur_seqno)
                                                        from sorlcur ss
                                                        where s.sorlcur_pidm=ss.sorlcur_pidm
                                                        and s.sorlcur_lmod_code=ss.sorlcur_lmod_code
                                                        and     s.sorlcur_program=ss.sorlcur_program)
                join smrpaap on smrpaap_program=sorlcur_program
                 and smrpaap_term_code_eff=sorlcur_term_code_ctlg
                join scrtext on scrtext_text =szcarga_materia
                join smrarul on smrarul_area=smrpaap_area
                 and smrarul_term_code_eff=smrpaap_term_code_eff
                left outer join sztdtec on sztdtec_program=sorlcur_program
                 and sztdtec_term_code=sorlcur_term_code_ctlg
                where  smrarul_subj_code=scrtext_subj_code
                and smrarul_crse_numb_low=scrtext_crse_numb
                and carg.SZCARGA_ID=spriden_id
                and carg.SZCARGA_MATERIA = SZCARGA_MATERIA
                and carg.SZCARGA_PROGRAM=SZCARGA_PROGRAM
                and carg.SZCARGA_FECHA_INI=SZCARGA_FECHA_INI
              --      and szcarga_materia = 'M1ED116'
                ) ;
*/

begin

fecha_ini:=to_date(pn_fecha,'dd/mm/rrrr');

---------BORRA TODA LA TABLA PARA LA REGLA  DE NIVELACION  1210/2018  GLOVICX----
DELETE
from SZtCARGA
where SZTCARGA_NO_REGLA = 99;

for c in (
select distinct spriden_pidm pidm,
                      szcarga_id iden  ,
                      szcarga_program prog,
                      sorlcur_camp_code campus,
                      sorlcur_levl_code nivel,
                      sorlcur_term_code_ctlg ctlg ,
                      szcarga_materia  materia ,
                       smrarul_subj_code subj,
                      smrarul_crse_numb_low crse ,
                        szcarga_term_code periodo ,
                       szcarga_ptrm_code parte,
                       decode(sztdtec_periodicidad,1,'BIMESTRAL',2,'CUATRIMESTRAL') periodicidad,
                        szcarga_grupo grupo,
                        szcarga_calif calif,
                        szcarga_id_prof prof,
                        SZCARGA_FECHA_INI Fecha_Inicio,
                        SORLCUR_KEY_SEQNO study, g.SGBSTDN_STST_CODE,
                        r.sorlcur_term_code  as sorlterm
from SZCARGA a, spriden S, sgbstdn G, sorlcur r, sztdtec z, smrpaap p, sztmaco t, smrarul u
where  a.SZCARGA_NO_REGLA = 99
and a.SZCARGA_USER_ID = 'EXEX'
and s.spriden_id=a.szcarga_id
and s.spriden_change_ind is null
and  g.sgbstdn_pidm=spriden_pidm
And g.SGBSTDN_TERM_CODE_EFF = (select max (b1.SGBSTDN_TERM_CODE_EFF)
                                                       from SGBSTDN b1
                                                       Where g.sgbstdn_pidm = b1.sgbstdn_pidm
                                                       AND g.sgbstdn_program_1 = b1.sgbstdn_program_1
                                                       )
and r.sorlcur_pidm= s.spriden_pidm
AND r.sorlcur_pidm = g.sgbstdn_pidm
AND r.sorlcur_program = g.sgbstdn_program_1
and r.sorlcur_program=szcarga_program
and r.sorlcur_lmod_code='LEARNER'
and r.sorlcur_seqno in (select max(sorlcur_seqno)
                                            from sorlcur ss
                                            where r.sorlcur_pidm=ss.sorlcur_pidm
                                            and   r.sorlcur_lmod_code=ss.sorlcur_lmod_code
                                            and   r.sorlcur_program=ss.sorlcur_program)
and z.sztdtec_program=r.sorlcur_program
and z.sztdtec_term_code=r.sorlcur_term_code_ctlg
and p.smrpaap_program= r.sorlcur_program
and p.smrpaap_term_code_eff=r.sorlcur_term_code_ctlg
and T.SZTMACO_MATPADRE  = a.szcarga_materia
and u.smrarul_area=p.smrpaap_area
and u.smrarul_term_code_eff=p.smrpaap_term_code_eff
and (u.smrarul_subj_code||u.smrarul_crse_numb_low) = SZTMACO_MATHIJO
order by  iden

) loop


--------------- Limpia Variables  --------------------
--niv :=  null;
parte := null;
crn := null;
pidm_doc2 := null;
conta_sirasgn := null;
pidm_doc := null;
f_inicio := null;
f_fin := null;
sem := null;
schd := null;
title := null;
credit := null;
credit_bill :=null;
levl := null;
camp := null;
mate := null;
parte := null;
per := null;
grupo := null;
vl_existe :=0;
vl_error := 'EXITO';
vn_lugares :=0;
vn_cupo_max :=0;
vn_cupo_act :=0;

parteper_cur  :=null;
period_cur :=null;
vl_exite_prof :=0;

 --dbms_output.put_line('salida 1  '||c.pidm ||'-'|| c.prog  );

   IF C.SGBSTDN_STST_CODE  NOT IN  ('XX') then    ----se cambia la validacion para que tome todos estatus del alumno   vic.24.05.2017----
--------------------- Se valida que el alumno no tenga la materia sembrada en el horario como Activa ---------------------------------------
       --dbms_output.put_line('salida 2 '||c.pidm ||'-'|| c.prog  );
        begin
                --existe y es aprobatoria
                select count (1), SFRSTCR_TERM_CODE, SFRSTCR_PTRM_CODE
                  into vl_existe, period_cur, parteper_cur
                from ssbsect, sfrstcr, SHRGRDE
                where sfrstcr_pidm=c.pidm
                --and sfrstcr_term_code=c.periodo
                and ssbsect_term_code=sfrstcr_term_code
                and SFRSTCR_PTRM_CODE = SSBSECT_PTRM_CODE
                and ssbsect_crn=sfrstcr_crn
                and ssbsect_subj_code=c.subj
                and ssbsect_crse_numb=c.crse
                and SFRSTCR_RSTS_CODE = 'RE'
                AND (SFRSTCR_GRDE_CODE = SHRGRDE_CODE
                                         OR SFRSTCR_GRDE_CODE IS NULL)
                AND SHRGRDE_PASSED_IND = 'Y'
                AND SHRGRDE_LEVL_CODE= C.NIVEL
                group by SFRSTCR_TERM_CODE, SFRSTCR_PTRM_CODE;

        Exception
         when others then
             vl_existe:=0;
        end;

        If vl_existe = 0 then
         --dbms_output.put_line('salida 3 '||c.pidm ||'-'|| c.prog  );
            ---- Se busca que exista el grupo y tenga cupo

                If  c.prof is null then
                   -- dbms_output.put_line ('sin profesor '||vl_existe);
                        begin
                               select ssbsect_crn , ssbsect_seats_avail lugares, ssbsect_max_enrl cupo_max, SSBSECT_PTRM_CODE,
                                          ssbsect_enrl cupo_Act,    SSBSECT_PTRM_START_DATE, SSBSECT_PTRM_END_DATE, SSBSECT_PTRM_WEEKS,
                                        SSBSECT_CREDIT_HRS, SSBSECT_BILL_HRS, SSBSECT_GMOD_CODE
                                into crn , vn_lugares, vn_cupo_max, parte,
                                       vn_cupo_act, f_inicio, f_fin, sem,
                                       credit, credit_bill, gmod
                                from ssbsect
                                where SSBSECT_TERM_CODE= c.periodo
                                and ssbsect_subj_code= c.subj
                               and ssbsect_crse_numb=c.crse
                               and SSBSECT_SEQ_NUMB = c.grupo
                                and trunc (SSBSECT_PTRM_START_DATE) = c.Fecha_Inicio;
                        Exception
                        when others then
                            crn:=null;
                            vn_lugares :=0;
                            vn_cupo_max:=0;
                            vn_cupo_act:=0;
                            f_inicio := null;
                            f_fin := null;
                            sem := null;
                            credit  := null;
                            credit_bill  := null;
                            gmod  := null;
                        end;
                Else
                          --dbms_output.put_line ('con profesor '||vl_existe);
                        --dbms_output.put_line('salida 4  '||c.pidm ||'-'|| c.prog  );
                       begin
                               select ssbsect_crn , ssbsect_seats_avail lugares, ssbsect_max_enrl cupo_max, SSBSECT_PTRM_CODE,
                                          ssbsect_enrl cupo_Act,    SSBSECT_PTRM_START_DATE, SSBSECT_PTRM_END_DATE, SSBSECT_PTRM_WEEKS,
                                        SSBSECT_CREDIT_HRS, SSBSECT_BILL_HRS, SSBSECT_GMOD_CODE
                                into crn , vn_lugares, vn_cupo_max, parte,
                                       vn_cupo_act, f_inicio, f_fin, sem,
                                       credit, credit_bill, gmod
                                from ssbsect, sirasgn
                                where SSBSECT_TERM_CODE= c.periodo
                                and ssbsect_subj_code= c.subj
                               and ssbsect_crse_numb=c.crse
                               and SSBSECT_SEQ_NUMB = c.grupo
                                and trunc (SSBSECT_PTRM_START_DATE) = c.Fecha_Inicio
                                 And SIRASGN_TERM_CODE = SSBSECT_TERM_CODE
                                 And SSBSECT_CRN = SIRASGN_CRN
                                 And SIRASGN_PIDM = (select distinct  spriden_pidm
                                                                    from spriden
                                                                    where spriden_id = c.prof
                                                                    And spriden_change_ind is null )
                                And SIRASGN_PRIMARY_IND = 'Y' ;
                       Exception
                        when others then
                            crn:=null;
                            vn_lugares :=0;
                            vn_cupo_max:=0;
                            vn_cupo_act:=0;
                            f_inicio := null;
                            f_fin := null;
                            sem := null;
                            credit  := null;
                            credit_bill  := null;
                            gmod  := null;
                       end;

                End if;

                If crn is not null then
                  --dbms_output.put_line ('CRN no es null '||crn);
                -- dbms_output.put_line('salida 5  '||c.pidm ||'-'|| c.prog  );

                    If vn_lugares >0  then

                            If credit is null then
                               Begin
                                      select SSRMEET_CREDIT_HR_SESS
                                       Into credit
                                      from SSRMEET
                                      where SSRMEET_TERM_CODE = c.periodo
                                      And SSRMEET_CRN = crn;
                               Exception
                                When Others then
                                   credit :=null;
                                End;

                                  If credit is not null then
                                           Begin
                                               Update ssbsect
                                               set  SSBSECT_CREDIT_HRS = credit
                                               where SSBSECT_TERM_CODE = c.periodo
                                               and SSBSECT_CRN = crn;
                                           Exception
                                           when Others then
                                                null;
                                           End;
                                  End if;
                           End if;

                           If credit_bill is null then
                               credit_bill := 1;
                                  If credit is not null then
                                           Begin
                                               Update ssbsect
                                               set  SSBSECT_BILL_HRS = credit_bill
                                               where SSBSECT_TERM_CODE = c.periodo
                                               and SSBSECT_CRN = crn;
                                           Exception
                                           when Others then
                                                null;
                                           End;
                                  End if;
                           End if;

                          If gmod is null then
                                begin
                                    select scrgmod_gmod_code
                                    into gmod
                                    from scrgmod
                                    where scrgmod_subj_code=c.subj
                                    and     scrgmod_crse_numb=c.crse
                                    and     scrgmod_default_ind='D';
                                exception when others then
                                    gmod:='1';
                                end;

                                If gmod is not null then
                                           Begin
                                               Update ssbsect
                                               set  SSBSECT_GMOD_CODE = gmod
                                               where SSBSECT_TERM_CODE = c.periodo
                                               and SSBSECT_CRN = crn;
                                           Exception
                                           when Others then
                                                null;
                                           End;
                                end if;

                          End if;

                          begin
                                select spriden_pidm into pidm_prof
                                from  spriden
                                where   spriden_id=c.prof and spriden_change_ind is null;
                          Exception when others then
                              pidm_prof:=null;
                          End;

                            conta_ptrm :=0;
                          Begin
                            Select count (1)
                                Into conta_ptrm
                            from sirasgn
                            Where SIRASGN_TERM_CODE = c.periodo
                            And SIRASGN_CRN = crn
                            and  SIRASGN_PIDM = pidm_prof
                            And SIRASGN_PRIMARY_IND = 'Y';
                          Exception
                          When Others then
                           conta_ptrm :=0;
                          End;



                            if pidm_prof is not null and conta_ptrm = 0 then
                                Begin
                                        insert into sirasgn values(c.periodo, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,  sysdate, null,null,null,null, 'SZFCARG', user, null, null, null, null,  null,null);
                                Exception
                                When Others then
                                null;
                                End;
                            end if;

                             conta_ptrm :=0;

                            Begin
                                 select count(*)
                                    into conta_ptrm
                                 from sfbetrm
                                 where sfbetrm_term_code=c.periodo
                                 and     sfbetrm_pidm=c.pidm;
                            Exception
                                When Others then
                                  conta_ptrm := 0;
                            End;


                             if conta_ptrm =0 then
                                    Begin
                                            insert into sfbetrm values(c.periodo, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFCARG', null, 0,null,null, null,null,user,null);
                                    Exception
                                    When Others then
                                        vl_error := ('Se presento un error al insertar en la tabla sfbetrm ' || sqlerrm);
                                    End;
                             end if;


                           Begin
                           --dbms_output.put_line('salida 6 '||c.pidm ||'-'|| c.prog  );
                               insert into sfrstcr values(
                                                                c.periodo,     --SFRSTCR_TERM_CODE
                                                                c.pidm,     --SFRSTCR_PIDM
                                                                crn,     --SFRSTCR_CRN
                                                                null,     --SFRSTCR_CLASS_SORT_KEY
                                                                c.grupo,    --SFRSTCR_REG_SEQ
                                                                c.parte,    --SFRSTCR_PTRM_CODE
                                                                'RE',     --SFRSTCR_RSTS_CODE
                                                                sysdate,    --SFRSTCR_RSTS_DATE
                                                                null,    --SFRSTCR_ERROR_FLAG
                                                                null,    --SFRSTCR_MESSAGE
                                                                credit_bill,    --SFRSTCR_BILL_HR
                                                                3, --SFRSTCR_WAIV_HR
                                                                credit,     --SFRSTCR_CREDIT_HR
                                                                credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                gmod,     --SFRSTCR_GMOD_CODE
                                                                null,    --SFRSTCR_GRDE_CODE
                                                                null,    --SFRSTCR_GRDE_CODE_MID
                                                                null,    --SFRSTCR_GRDE_DATE
                                                                'N',    --SFRSTCR_DUPL_OVER
                                                                'N',    --SFRSTCR_LINK_OVER
                                                                'N',    --SFRSTCR_CORQ_OVER
                                                                'N',    --SFRSTCR_PREQ_OVER
                                                                'N',     --SFRSTCR_TIME_OVER
                                                                'N',     --SFRSTCR_CAPC_OVER
                                                                'N',     --SFRSTCR_LEVL_OVER
                                                                'N',     --SFRSTCR_COLL_OVER
                                                                'N',     --SFRSTCR_MAJR_OVER
                                                                'N',     --SFRSTCR_CLAS_OVER
                                                                'N',     --SFRSTCR_APPR_OVER
                                                                'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                sysdate,      --SFRSTCR_ADD_DATE
                                                                sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                c.nivel,     --SFRSTCR_LEVL_CODE
                                                                c.campus,     --SFRSTCR_CAMP_CODE
                                                                c.materia,     --SFRSTCR_RESERVED_KEY
                                                                null,     --SFRSTCR_ATTEND_HR
                                                                'Y',     --SFRSTCR_REPT_OVER
                                                                'N' ,    --SFRSTCR_RPTH_OVER
                                                                null,    --SFRSTCR_TEST_OVER
                                                                'N',    --SFRSTCR_CAMP_OVER
                                                                user,    --SFRSTCR_USER
                                                                'N',    --SFRSTCR_DEGC_OVER
                                                                'N',    --SFRSTCR_PROG_OVER
                                                                null,    --SFRSTCR_LAST_ATTEND
                                                                null,    --SFRSTCR_GCMT_CODE
                                                                'SZFCARG',    --SFRSTCR_DATA_ORIGIN
                                                                sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                'N',  --SFRSTCR_DEPT_OVER
                                                                'N',  --SFRSTCR_ATTS_OVER
                                                                'N', --SFRSTCR_CHRT_OVER
                                                                null, --SFRSTCR_RMSG_CDE
                                                                null,  --SFRSTCR_WL_PRIORITY
                                                                null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                'N', --SFRSTCR_MEXC_OVER
                                                                c.study,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                null,--SFRSTCR_BRDH_SEQ_NUM
                                                                '01',--SFRSTCR_BLCK_CODE
                                                                null,--SFRSTCR_STRH_SEQNO
                                                                null, --SFRSTCR_STRD_SEQNO
                                                                null,  --SFRSTCR_SURROGATE_ID
                                                                null, --SFRSTCR_VERSION
                                                                user,--SFRSTCR_USER_ID
                                                                NULL );--SFRSTCR_VPDI_CODE



                                        Begin
                                             update ssbsect
                                                    set ssbsect_enrl = ssbsect_enrl + 1
                                              where SSBSECT_TERM_CODE = C.PERIODO
                                              And SSBSECT_CRN  = crn;
                                        Exception
                                        When Others then
                                        vl_error := 'Se presento un error al actualizar el enrolamiento ' ||sqlerrm;
                                        End;
                                      --dbms_output.put_line('salida 7  '||c.pidm ||'-'|| c.prog  );
                                        Begin
                                                update ssbsect
                                                    set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                where SSBSECT_TERM_CODE = c.periodo
                                                 And SSBSECT_CRN  = crn;
                                        Exception
                                        When Others then
                                            vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||sqlerrm;
                                        End;

                                        Begin
                                                 update ssbsect
                                                        set ssbsect_census_enrl=ssbsect_enrl
                                                 Where SSBSECT_TERM_CODE = c.periodo
                                                 And SSBSECT_CRN  = crn;
                                        Exception
                                        When Others then
                                            vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||sqlerrm;
                                        End;

                                        Begin
                                            Update sgbstdn a
                                            set a.SGBSTDN_STYP_CODE ='C'
                                            Where a.SGBSTDN_PIDM = c.pidm
                                            And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                   from sgbstdn a1
                                                                                                   Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                   And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1)
                                             And a.SGBSTDN_PROGRAM_1 = c.prog;
                                        Exception
                                            When Others then
                                            vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                        End;

                                        f_inicio := null;
                                       --- dbms_output.put_line('salida 8  '||c.pidm ||'-'|| c.prog  );
                                         Begin
                                                select distinct sobptrm_start_date
                                                into f_inicio
                                                from sobptrm
                                                where sobptrm_term_code=c.periodo
                                                and     sobptrm_ptrm_code=c.parte;
                                         Exception
                                         When Others then
                                           f_inicio := null;
                                            vl_error := 'Se presento un error al Obtener la fecha de inicio de Clases ' ||sqlerrm;
                                         End;

                                        If f_inicio is not null then
                                            null;
                                           /* Begin-------------------este update no debe ir por que le cambia la fecha de inicio
                                                    Update sorlcur
                                                    set sorlcur_start_date  = trunc (f_inicio)
                                                    Where SORLCUR_PIDM = c.pidm
                                                    And SORLCUR_PROGRAM = c.prog
                                                    And SORLCUR_LMOD_CODE = 'LEARNER'
                                                    And SORLCUR_KEY_SEQNO = c.study;
                                            Exception
                                                When Others then
                                                   vl_error := 'Se presento un error al actualizar la fecha de Inicio de Clases en sorlcur ' ||sqlerrm;
                                            End;
                                            */
                                        End if;

                                        conta_ptrm:=0;
                                    --dbms_output.put_line('salida 9  '||c.pidm ||'-'|| c.prog  );
                                        Begin
                                            Select count (*)
                                                Into conta_ptrm
                                            from sfrareg
                                            where SFRAREG_PIDM = c.pidm
                                            And SFRAREG_TERM_CODE = c.periodo
                                            And SFRAREG_CRN = crn
                                            And SFRAREG_EXTENSION_NUMBER = 0
                                            And SFRAREG_RSTS_CODE = 'RE';
                                        Exception
                                        When Others then
                                           conta_ptrm :=0;
                                        End;

                                        If conta_ptrm = 0 then

                                             Begin
                                                     insert into sfrareg values(c.pidm, c.periodo, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFCARG', sysdate, null,null,null);
                                             Exception
                                               When Others then
                                                  vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||sqlerrm;
                                             End;
                                        End if;


                                       Begin
                                         Select count(1)
                                         Into vl_existe
                                         from SHRINST
                                         Where  SHRINST_TERM_CODE = c.periodo
                                         And SHRINST_CRN = crn
                                         And  SHRINST_PIDM = c.pidm;
                                       Exception
                                       When Others then
                                       vl_existe :=0;
                                       End;


                                      If vl_existe = 0 then
                                       --dbms_output.put_line('salida 10  '||c.pidm ||'-'|| c.prog  );
                                            Begin
                                                Insert into SHRINST values (c.periodo,        --SHRINST_TERM_CODE
                                                                                         crn,       --SHRINST_CRN
                                                                                         c.pidm,       --SHRINST_PIDM
                                                                                         sysdate,       --SHRINST_ACTIVITY_DATE
                                                                                         'Y',       --SHRINST_PRIMARY_IND
                                                                                          null,      --SHRINST_SURROGATE_ID
                                                                                          null,      --SHRINST_VERSION
                                                                                         user,       --SHRINST_USER_ID
                                                                                         'SZFCARG',       --SHRINST_DATA_ORIGIN
                                                                                          null);      --SHRINST_VPDI_CODE


                                            Exception
                                                When Others then
                                                 vl_error := 'Se presento un error al insertar al alumno en SHRINST ' ||sqlerrm;
                                            End;

                                      End if;



                            Exception
                           when Others then
                               vl_error := 'Se presento un error al insertar al alumno en el grupo ' ||sqlerrm;
                           End;

                    Else
                    --dbms_output.put_line('mensaje:'|| 'No hay grupo creado');
                    --dbms_output.put_line('salida 11  '||c.pidm ||'-'|| c.prog  );
                            schd := null;
                            title := null;
                            credit := null;
                            gmod :=null;
                            f_inicio :=null;
                            f_fin :=null;
                            sem :=null;
                             credit_bill := null;

                            Begin
                                 select scrschd_schd_code, scbcrse_title, scbcrse_credit_hr_low, SCBCRSE_BILL_HR_LOW
                                into schd, title, credit, credit_bill
                                from scbcrse, scrschd
                                where scbcrse_subj_code=c.subj
                                and     scbcrse_crse_numb=c.crse
                                and     scbcrse_eff_term='000000'
                                and     scrschd_subj_code=scbcrse_subj_code
                                and     scrschd_crse_numb=scbcrse_crse_numb
                                and     scrschd_eff_term=scbcrse_eff_term;
                            Exception
                            When Others then
                                  schd := null;
                                  title := null;
                                  credit := null;
                                   credit_bill := null;
                            End;
                     --dbms_output.put_line('salida 12  '||c.pidm ||'-'|| c.prog  );

                            begin
                                select scrgmod_gmod_code
                                      into gmod
                                from scrgmod
                                where scrgmod_subj_code=c.subj
                                and     scrgmod_crse_numb=c.crse
                                and     scrgmod_default_ind='D';
                            exception when others then
                                gmod:='1';
                            end;

                           Begin

                                   -------------------nuevo codigo de chuy para que tome los crn vacios huecos
                                    if c.nivel ='MS' then

                                                l_campus_ms:='AS';
                                            else
                                                l_campus_ms:=c.niVel;

                                     end if;

                                             BEGIN

                                                select sztcrnv_crn
                                                into crn
                                                from SZTCRNV
                                                where 1 = 1
                                                and rownum = 1
                                                AND SZTCRNV_LVEL_CODE = SUBSTR(l_campus_ms,1,1)
                                                and (SZTCRNV_crn,SZTCRNV_LVEL_CODE) not in (select to_number(crn),
                                                                                                   substr(SSBSECT_CRN,1,1)
                                                                                           from
                                                                                           (
                                                                                           select case when
                                                                                                          substr(SSBSECT_CRN,1,1) in(SELECT ZSTPARA_PARAM_VALOR
                                                                                                        FROM ZSTPARA
                                                                                                        WHERE 1=1
                                                                                                        AND ZSTPARA_MAPA_ID =  'LETRAS_CRN') then to_number(substr(SSBSECT_CRN,2,10))
                                                                                                         else
                                                                                                               to_number(SSBSECT_CRN)
                                                                                            end crn,
                                                                                                         SSBSECT_CRN
                                                                                               from ssbsect
                                                                                               where 1 = 1
                                                                                               and ssbsect_term_code=  c.periodo
                                                --                                               AND SUBSTR(SSBSECT_CRN,1,1) !='L'
                                                                                           )
                                                                                           where 1 = 1
                                                                                           );

                                             EXCEPTION WHEN OTHERS THEN
                                              --  raise_application_error (-20002,'Error al 2  '|| SQLCODE||' Error: '||SQLERRM);
                                                dbms_output.put_line(' error en crn 2 '||sqlerrm);
                                                crn := NULL;
                                             END;

                                         --------si estra aqui entonces le agrega su letra
                                  if c.nivel ='LI' then
                                    crn:='L'||crn;

                                    elsif  c.nivel ='MA' then
                                    crn:='M'||crn;

                                    elsif  c.nivel ='MS' then
                                    crn:='A'||crn;

                                    elsif  c.nivel ='DO' then
                                    crn:='D'||crn;
                                    end if;


                           EXCEPTION WHEN OTHERS THEN

                                   -------esto es por que ya se acabaron los CRN que empiezan con L y se agrego una l mas.
                                null;

                            END;



                             Begin
                                select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                                into f_inicio, f_fin, sem
                                from sobptrm
                                where sobptrm_term_code=c.periodo
                                and     sobptrm_ptrm_code=c.parte;
                             End;
                             --dbms_output.put_line('salida 13  '||c.pidm ||'-'|| c.prog  );
                             If crn is not null then
                                      Begin
                                            Insert into ssbsect values (
                                                                               c.periodo,     --SSBSECT_TERM_CODE
                                                                               crn,     --SSBSECT_CRN
                                                                               c.parte,     --SSBSECT_PTRM_CODE
                                                                               c.subj,     --SSBSECT_SUBJ_CODE
                                                                               c.crse,     --SSBSECT_CRSE_NUMB
                                                                                c.grupo,     --SSBSECT_SEQ_NUMB
                                                                                'A',    --SSBSECT_SSTS_CODE
                                                                                schd,    --SSBSECT_SCHD_CODE
                                                                                c.campus,    --SSBSECT_CAMP_CODE
                                                                                 title,   --SSBSECT_CRSE_TITLE
                                                                                 credit,   --SSBSECT_CREDIT_HRS
                                                                                 credit_bill,   --SSBSECT_BILL_HRS
                                                                                 gmod,   --SSBSECT_GMOD_CODE
                                                                                  null,  --SSBSECT_SAPR_CODE
                                                                                  null, --SSBSECT_SESS_CODE
                                                                                  null,  --SSBSECT_LINK_IDENT
                                                                                  null,  --SSBSECT_PRNT_IND
                                                                                  'Y',  --SSBSECT_GRADABLE_IND
                                                                                   null,  --SSBSECT_TUIW_IND
                                                                                   0, --SSBSECT_REG_ONEUP
                                                                                   0, --SSBSECT_PRIOR_ENRL
                                                                                   0, --SSBSECT_PROJ_ENRL
                                                                                   50, --SSBSECT_MAX_ENRL
                                                                                    0,--SSBSECT_ENRL
                                                                                    50,--SSBSECT_SEATS_AVAIL
                                                                                    null,--SSBSECT_TOT_CREDIT_HRS
                                                                                    '0',--SSBSECT_CENSUS_ENRL
                                                                                    f_inicio,--SSBSECT_CENSUS_ENRL_DATE
                                                                                    sysdate,--SSBSECT_ACTIVITY_DATE
                                                                                    f_inicio,--SSBSECT_PTRM_START_DATE
                                                                                    f_fin,--SSBSECT_PTRM_END_DATE
                                                                                    sem,--SSBSECT_PTRM_WEEKS
                                                                                    null,--SSBSECT_RESERVED_IND
                                                                                    null, --SSBSECT_WAIT_CAPACITY
                                                                                    null,--SSBSECT_WAIT_COUNT
                                                                                    null,--SSBSECT_WAIT_AVAIL
                                                                                    null,--SSBSECT_LEC_HR
                                                                                    null,--SSBSECT_LAB_HR
                                                                                    null,--SSBSECT_OTH_HR
                                                                                    null,--SSBSECT_CONT_HR
                                                                                    null,--SSBSECT_ACCT_CODE
                                                                                    null,--SSBSECT_ACCL_CODE
                                                                                    null,--SSBSECT_CENSUS_2_DATE
                                                                                    null,--SSBSECT_ENRL_CUT_OFF_DATE
                                                                                    null,--SSBSECT_ACAD_CUT_OFF_DATE
                                                                                    null,--SSBSECT_DROP_CUT_OFF_DATE
                                                                                    null,--SSBSECT_CENSUS_2_ENRL
                                                                                    'Y',--SSBSECT_VOICE_AVAIL
                                                                                    'N',--SSBSECT_CAPP_PREREQ_TEST_IND
                                                                                    null,--SSBSECT_GSCH_NAME
                                                                                    null,--SSBSECT_BEST_OF_COMP
                                                                                    null,--SSBSECT_SUBSET_OF_COMP
                                                                                    'NOP',--SSBSECT_INSM_CODE
                                                                                    null,--SSBSECT_REG_FROM_DATE
                                                                                    null,--SSBSECT_REG_TO_DATE
                                                                                    null,--SSBSECT_LEARNER_REGSTART_FDATE
                                                                                    null,--SSBSECT_LEARNER_REGSTART_TDATE
                                                                                    null,--SSBSECT_DUNT_CODE
                                                                                    null,--SSBSECT_NUMBER_OF_UNITS
                                                                                    0,--SSBSECT_NUMBER_OF_EXTENSIONS
                                                                                    'SZFCARG',--SSBSECT_DATA_ORIGIN
                                                                                    user,--SSBSECT_USER_ID
                                                                                    'MOOD',--SSBSECT_INTG_CDE
                                                                                    'B',--SSBSECT_PREREQ_CHK_METHOD_CDE
                                                                                    user,--SSBSECT_KEYWORD_INDEX_ID
                                                                                    null,--SSBSECT_SCORE_OPEN_DATE
                                                                                    null,--SSBSECT_SCORE_CUTOFF_DATE
                                                                                    null,--SSBSECT_REAS_SCORE_OPEN_DATE
                                                                                    null,--SSBSECT_REAS_SCORE_CTOF_DATE
                                                                                    null,--SSBSECT_SURROGATE_ID
                                                                                    null,--SSBSECT_VERSION
                                                                                     null);--SSBSECT_VPDI_CODE
                                            --dbms_output.put_line('salida 14  '||c.pidm ||'-'|| c.prog  );

                                                   Begin
                                                                update SOBTERM
                                                                     set SOBTERM_CRN_ONEUP = crn
                                                                where SOBTERM_TERM_CODE = c.periodo;
                                                   Exception
                                                   When Others then
                                                     null;
                                                   End;



                                                       Begin
                                                            insert into ssrmeet values(C.periodo, crn, null,null,null,null,null,null, sysdate, f_inicio, f_fin, '01', null,null,null,null,null,null,null, 'ENL', null, credit, null, 0, null,null,null, 'CLVI', 'SZFCARG', user, null,null,null);
                                                        Exception
                                                        when Others then
                                                           vl_error := 'Se presento un Error al insertar en ssrmeet ' ||sqlerrm;
                                                       End;


                                                        begin
                                                            select spriden_pidm
                                                                into pidm_prof
                                                            from  spriden
                                                            where   spriden_id=c.prof and spriden_change_ind is null;
                                                        Exception when others then
                                                          pidm_prof:=null;
                                                        End;

                                              --dbms_output.put_line('salida 15  '||c.pidm ||'-'|| c.prog  );

                                                       if pidm_prof is not null then
                                                         -- dbms_output.put_line('Crea el CRN para el docente:'|| pidm_prof  ||'*'||crn);

                                                          Begin
                                                                Select count (1)
                                                                Into vl_exite_prof
                                                                from sirasgn
                                                                Where SIRASGN_TERM_CODE = c.periodo
                                                                And SIRASGN_CRN = crn;
                                                               -- And SIRASGN_PIDM = pidm_prof;
                                                           Exception
                                                            when others then
                                                              vl_exite_prof := 0;
                                                           End;

                                                           If vl_exite_prof = 0 then
                                                                    Begin
                                                                            insert into sirasgn values(c.periodo, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,
                                                                                                                 sysdate, null,null,null,null, 'UTEL', 'MIGRA_D', null, null, null, null,  null,null);
                                                                    Exception
                                                                    When Others then
                                                                    null;
                                                                    End;
                                                           Else
                                                                   Begin
                                                                        Update sirasgn
                                                                        set SIRASGN_PRIMARY_IND = null
                                                                         Where SIRASGN_TERM_CODE = c.periodo
                                                                         And SIRASGN_CRN = crn;
                                                                   Exception
                                                                    When others then
                                                                    null;
                                                                   End;

                                                                    Begin
                                                                            insert into sirasgn values(c.periodo, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,
                                                                                                                 sysdate, null,null,null,null, 'UTEL', 'MIGRA_D', null, null, null, null,  null,null);
                                                                    Exception
                                                                    When Others then
                                                                    null;
                                                                    End;

                                                           End if;
                                                       end if;


                                                    conta_ptrm :=0;
                                           --dbms_output.put_line('salida 16  '||c.pidm ||'-'|| c.prog  );
                                                        Begin
                                                             select count(*)
                                                                into conta_ptrm
                                                             from sfbetrm
                                                             where sfbetrm_term_code=c.periodo
                                                             and     sfbetrm_pidm=c.pidm;
                                                        Exception
                                                            When Others then
                                                              conta_ptrm := 0;
                                                        End;


                                                         if conta_ptrm =0 then
                                                                Begin
                                                                        insert into sfbetrm values(c.periodo, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFCARG', null, 0,null,null, null,null,user,null);
                                                                Exception
                                                                When Others then
                                                                    vl_error := ('Se presento un error al insertar en la tabla sfbetrm ' || sqlerrm);
                                                                End;
                                                         end if;

                                                       Begin
                                                           --dbms_output.put_line('salida 17  '||c.pidm ||'-'|| c.prog  );
                                                           insert into sfrstcr values(
                                                                                            c.periodo,     --SFRSTCR_TERM_CODE
                                                                                            c.pidm,     --SFRSTCR_PIDM
                                                                                            crn,     --SFRSTCR_CRN
                                                                                            null,     --SFRSTCR_CLASS_SORT_KEY
                                                                                            c.grupo,    --SFRSTCR_REG_SEQ
                                                                                            c.parte,    --SFRSTCR_PTRM_CODE
                                                                                            'RE',     --SFRSTCR_RSTS_CODE
                                                                                            sysdate,    --SFRSTCR_RSTS_DATE
                                                                                            null,    --SFRSTCR_ERROR_FLAG
                                                                                            null,    --SFRSTCR_MESSAGE
                                                                                            credit_bill,    --SFRSTCR_BILL_HR
                                                                                            3, --SFRSTCR_WAIV_HR
                                                                                            credit,     --SFRSTCR_CREDIT_HR
                                                                                            credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                                            credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                                            gmod,     --SFRSTCR_GMOD_CODE
                                                                                            null,    --SFRSTCR_GRDE_CODE
                                                                                            null,    --SFRSTCR_GRDE_CODE_MID
                                                                                            null,    --SFRSTCR_GRDE_DATE
                                                                                            'N',    --SFRSTCR_DUPL_OVER
                                                                                            'N',    --SFRSTCR_LINK_OVER
                                                                                            'N',    --SFRSTCR_CORQ_OVER
                                                                                            'N',    --SFRSTCR_PREQ_OVER
                                                                                            'N',     --SFRSTCR_TIME_OVER
                                                                                            'N',     --SFRSTCR_CAPC_OVER
                                                                                            'N',     --SFRSTCR_LEVL_OVER
                                                                                            'N',     --SFRSTCR_COLL_OVER
                                                                                            'N',     --SFRSTCR_MAJR_OVER
                                                                                            'N',     --SFRSTCR_CLAS_OVER
                                                                                            'N',     --SFRSTCR_APPR_OVER
                                                                                            'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                                            sysdate,      --SFRSTCR_ADD_DATE
                                                                                            sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                                            c.nivel,     --SFRSTCR_LEVL_CODE
                                                                                            c.campus,     --SFRSTCR_CAMP_CODE
                                                                                             c.materia,     --SFRSTCR_RESERVED_KEY
                                                                                            null,     --SFRSTCR_ATTEND_HR
                                                                                            'Y',     --SFRSTCR_REPT_OVER
                                                                                            'N' ,    --SFRSTCR_RPTH_OVER
                                                                                            null,    --SFRSTCR_TEST_OVER
                                                                                            'N',    --SFRSTCR_CAMP_OVER
                                                                                            user,    --SFRSTCR_USER
                                                                                            'N',    --SFRSTCR_DEGC_OVER
                                                                                            'N',    --SFRSTCR_PROG_OVER
                                                                                            null,    --SFRSTCR_LAST_ATTEND
                                                                                            null,    --SFRSTCR_GCMT_CODE
                                                                                            'SZFCARG',    --SFRSTCR_DATA_ORIGIN
                                                                                            sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                                            'N',  --SFRSTCR_DEPT_OVER
                                                                                            'N',  --SFRSTCR_ATTS_OVER
                                                                                            'N', --SFRSTCR_CHRT_OVER
                                                                                            null, --SFRSTCR_RMSG_CDE
                                                                                            null,  --SFRSTCR_WL_PRIORITY
                                                                                            null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                                            null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                                            null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                                            'N', --SFRSTCR_MEXC_OVER
                                                                                            c.study,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                                            null,--SFRSTCR_BRDH_SEQ_NUM
                                                                                            '01',--SFRSTCR_BLCK_CODE
                                                                                            null,--SFRSTCR_STRH_SEQNO
                                                                                            null, --SFRSTCR_STRD_SEQNO
                                                                                            null,  --SFRSTCR_SURROGATE_ID
                                                                                            null, --SFRSTCR_VERSION
                                                                                            user,--SFRSTCR_USER_ID
                                                                                            NULL );--SFRSTCR_VPDI_CODE



                                                                    Begin
                                                                         update ssbsect
                                                                                set ssbsect_enrl = ssbsect_enrl + 1
                                                                          where SSBSECT_TERM_CODE = C.periodo
                                                                          And SSBSECT_CRN  = crn;
                                                                    Exception
                                                                    When Others then
                                                                    vl_error := 'Se presento un error al actualizar el enrolamiento ' ||sqlerrm;
                                                                    End;

                                                                    Begin
                                                                            update ssbsect
                                                                                set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                                            where SSBSECT_TERM_CODE = c.periodo
                                                                             And SSBSECT_CRN  = crn;
                                                                    Exception
                                                                    When Others then
                                                                        vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||sqlerrm;
                                                                    End;

                                                                    Begin
                                                                             update ssbsect
                                                                                    set ssbsect_census_enrl=ssbsect_enrl
                                                                             Where SSBSECT_TERM_CODE = c.periodo
                                                                             And SSBSECT_CRN  = crn;
                                                                    Exception
                                                                    When Others then
                                                                        vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||sqlerrm;
                                                                    End;

                                                        --dbms_output.put_line('salida 18  '||c.pidm ||'-'|| c.prog  );

                                                                   Begin
                                                                        Update sgbstdn a
                                                                        set a.SGBSTDN_STYP_CODE ='C'
                                                                        Where a.SGBSTDN_PIDM = c.pidm
                                                                        And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                                               from sgbstdn a1
                                                                                                                               Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                                               And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1)
                                                                         And a.SGBSTDN_PROGRAM_1 = c.prog;
                                                                   Exception
                                                                        When Others then
                                                                        vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                                                   End;

                                                                    f_inicio := null;

                                                                     Begin
                                                                            select distinct sobptrm_start_date
                                                                            into f_inicio
                                                                            from sobptrm
                                                                            where sobptrm_term_code=c.periodo
                                                                            and     sobptrm_ptrm_code=c.parte;
                                                                     Exception
                                                                     When Others then
                                                                       f_inicio := null;
                                                                        vl_error := 'Se presento un error al Obtener la fecha de inicio de Clases ' ||sqlerrm;
                                                                     End;

                                                                    If f_inicio is not null then

                                                                        Begin
                                                                        null;
                                                                              /*  Update sorlcur
                                                                                set sorlcur_start_date  = trunc (f_inicio)
                                                                                Where SORLCUR_PIDM = c.pidm
                                                                                And SORLCUR_PROGRAM = c.prog
                                                                                And SORLCUR_LMOD_CODE = 'LEARNER'
                                                                                And SORLCUR_KEY_SEQNO = c.study;
                                                                               */
                                                                        Exception
                                                                            When Others then
                                                                               vl_error := 'Se presento un error al actualizar la fecha de Inicio de Clases en sorlcur ' ||sqlerrm;
                                                                        End;

                                                                    End if;



                                                                    conta_ptrm:=0;
                                                               --  dbms_output.put_line('salida 19  '||c.pidm ||'-'|| c.prog  );
                                                                    Begin
                                                                        Select count (*)
                                                                            Into conta_ptrm
                                                                        from sfrareg
                                                                        where SFRAREG_PIDM = c.pidm
                                                                        And SFRAREG_TERM_CODE = c.periodo
                                                                        And SFRAREG_CRN = crn
                                                                        And SFRAREG_EXTENSION_NUMBER = 0
                                                                        And SFRAREG_RSTS_CODE = 'RE';
                                                                    Exception
                                                                    When Others then
                                                                       conta_ptrm :=0;
                                                                    End;

                                                                    If conta_ptrm = 0 then

                                                                         Begin
                                                                                 insert into sfrareg values(c.pidm, c.periodo, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFCARG', sysdate, null,null,null);
                                                                         Exception
                                                                           When Others then
                                                                              vl_error := 'Se presento un error al insertar el registro de la materia para el alumno ' ||sqlerrm;
                                                                         End;
                                                                    End if;

                                                        Exception
                                                       when Others then
                                                           vl_error := 'Se presento un error al insertar al alumno en el grupo2 ' ||sqlerrm;
                                                       End;


                                      Exception
                                        When Others then
                                          vl_error := 'Se presento un Error al insertar el nuevo grupo en la tabla SSBSECT ' ||sqlerrm;
                                      End;
                            End if;
                        End if;  -------- > No hay cupo en el grupo
                Else
                    --dbms_output.put_line('mensaje:'|| 'No hay grupo creado Con docente');
                    --dbms_output.put_line('salida 20  '||c.pidm ||'-'|| c.prog  );
                            schd := null;
                            title := null;
                            credit := null;
                            gmod :=null;
                            f_inicio :=null;
                            f_fin :=null;
                            sem :=null;
                            crn := null;
                            pidm_prof := null;
                            vl_exite_prof :=0;

                           Begin
                                select scrschd_schd_code, scbcrse_title, scbcrse_credit_hr_low, SCBCRSE_BILL_HR_LOW
                                into schd, title, credit, credit_bill
                                from scbcrse, scrschd
                                where scbcrse_subj_code=c.subj
                                and     scbcrse_crse_numb=c.crse
                                and     scbcrse_eff_term='000000'
                                and     scrschd_subj_code=scbcrse_subj_code
                                and     scrschd_crse_numb=scbcrse_crse_numb
                                and     scrschd_eff_term=scbcrse_eff_term;
                           Exception
                            When Others then
                                  schd := null;
                                  title := null;
                                  credit := null;
                                  credit_bill :=null;
                           End;



                            begin
                                select scrgmod_gmod_code
                                      into gmod
                                from scrgmod
                                where scrgmod_subj_code=c.subj
                                and     scrgmod_crse_numb=c.crse
                                and     scrgmod_default_ind='D';
                            exception when others then
                                gmod:='1';
                            end;


                             BEGIN

                                    if c.nivel ='MS' then

                                                l_campus_ms:='AS';
                                            else
                                                l_campus_ms:=c.niVel;

                                     end if;

                                             BEGIN

                                                select sztcrnv_crn
                                                into crn
                                                from SZTCRNV
                                                where 1 = 1
                                                and rownum = 1
                                                AND SZTCRNV_LVEL_CODE = SUBSTR(l_campus_ms,1,1)
                                                and (SZTCRNV_crn,SZTCRNV_LVEL_CODE) not in (select to_number(crn),
                                                                                                   substr(SSBSECT_CRN,1,1)
                                                                                           from
                                                                                           (
                                                                                           select case when
                                                                                                          substr(SSBSECT_CRN,1,1) in(SELECT ZSTPARA_PARAM_VALOR
                                                                                                        FROM ZSTPARA
                                                                                                        WHERE 1=1
                                                                                                        AND ZSTPARA_MAPA_ID =  'LETRAS_CRN') then to_number(substr(SSBSECT_CRN,2,10))
                                                                                                         else
                                                                                                               to_number(SSBSECT_CRN)
                                                                                            end crn,
                                                                                                         SSBSECT_CRN
                                                                                               from ssbsect
                                                                                               where 1 = 1
                                                                                               and ssbsect_term_code=  c.periodo
                                                --                                               AND SUBSTR(SSBSECT_CRN,1,1) !='L'
                                                                                           )
                                                                                           where 1 = 1
                                                                                           );

                                             EXCEPTION WHEN OTHERS THEN
                                                raise_application_error (-20002,'Error al 2  '|| SQLCODE||' Error: '||SQLERRM);
                                                dbms_output.put_line(' error en crn 2 '||sqlerrm);
                                                crn := NULL;
                                             END;

                                    --------si estra aqui entonces le agrega su letra
                                  if c.nivel ='LI' then
                                    crn:='L'||crn;

                                    elsif  c.nivel ='MA' then
                                    crn:='M'||crn;

                                    elsif  c.nivel ='MS' then
                                    crn:='A'||crn;

                                    elsif  c.nivel ='DO' then
                                    crn:='D'||crn;
                                    end if;


                                EXCEPTION WHEN OTHERS THEN
                                      -------esto es por que ya se acabaron los CRN que empiezan con L y se agrego una l mas.
                                  null;

                             END;




                             Begin
                                select distinct sobptrm_start_date, sobptrm_end_date , sobptrm_weeks
                                into f_inicio, f_fin, sem
                                from sobptrm
                                where sobptrm_term_code=c.periodo
                                and     sobptrm_ptrm_code=c.parte;
                             Exception
                             When Others then
                                vl_error := 'No se Encontro configuracion para el Periodo= ' ||c.periodo ||' y Parte de Periodo= '||c.parte ||sqlerrm;
                             End;


                        If crn is not null then
                                  Begin

                                   --dbms_output.put_line('Salida  20-A :'|| c.periodo  ||'*'||crn||'*'|| c.parte||'*'||c.subj||'*'||c.crse||'*'||c.grupo||'*'||schd||'*'||c.campus);

                                        Insert into ssbsect values (
                                                                           c.periodo,     --SSBSECT_TERM_CODE
                                                                           crn,     --SSBSECT_CRN
                                                                           c.parte,     --SSBSECT_PTRM_CODE
                                                                           c.subj,     --SSBSECT_SUBJ_CODE
                                                                           c.crse,     --SSBSECT_CRSE_NUMB
                                                                            c.grupo,     --SSBSECT_SEQ_NUMB
                                                                            'A',    --SSBSECT_SSTS_CODE
                                                                            schd,    --SSBSECT_SCHD_CODE
                                                                            c.campus,    --SSBSECT_CAMP_CODE
                                                                             title,   --SSBSECT_CRSE_TITLE
                                                                             credit,   --SSBSECT_CREDIT_HRS
                                                                             credit_bill,   --SSBSECT_BILL_HRS
                                                                             gmod,   --SSBSECT_GMOD_CODE
                                                                              null,  --SSBSECT_SAPR_CODE
                                                                              null, --SSBSECT_SESS_CODE
                                                                              null,  --SSBSECT_LINK_IDENT
                                                                              null,  --SSBSECT_PRNT_IND
                                                                              'Y',  --SSBSECT_GRADABLE_IND
                                                                               null,  --SSBSECT_TUIW_IND
                                                                               0, --SSBSECT_REG_ONEUP
                                                                               0, --SSBSECT_PRIOR_ENRL
                                                                               0, --SSBSECT_PROJ_ENRL
                                                                               50, --SSBSECT_MAX_ENRL
                                                                                0,--SSBSECT_ENRL
                                                                                50,--SSBSECT_SEATS_AVAIL
                                                                                null,--SSBSECT_TOT_CREDIT_HRS
                                                                                '0',--SSBSECT_CENSUS_ENRL
                                                                                f_inicio,--SSBSECT_CENSUS_ENRL_DATE
                                                                                sysdate,--SSBSECT_ACTIVITY_DATE
                                                                                f_inicio,--SSBSECT_PTRM_START_DATE
                                                                                f_fin,--SSBSECT_PTRM_END_DATE
                                                                                sem,--SSBSECT_PTRM_WEEKS
                                                                                null,--SSBSECT_RESERVED_IND
                                                                                null, --SSBSECT_WAIT_CAPACITY
                                                                                null,--SSBSECT_WAIT_COUNT
                                                                                null,--SSBSECT_WAIT_AVAIL
                                                                                null,--SSBSECT_LEC_HR
                                                                                null,--SSBSECT_LAB_HR
                                                                                null,--SSBSECT_OTH_HR
                                                                                null,--SSBSECT_CONT_HR
                                                                                null,--SSBSECT_ACCT_CODE
                                                                                null,--SSBSECT_ACCL_CODE
                                                                                null,--SSBSECT_CENSUS_2_DATE
                                                                                null,--SSBSECT_ENRL_CUT_OFF_DATE
                                                                                null,--SSBSECT_ACAD_CUT_OFF_DATE
                                                                                null,--SSBSECT_DROP_CUT_OFF_DATE
                                                                                null,--SSBSECT_CENSUS_2_ENRL
                                                                                'Y',--SSBSECT_VOICE_AVAIL
                                                                                'N',--SSBSECT_CAPP_PREREQ_TEST_IND
                                                                                null,--SSBSECT_GSCH_NAME
                                                                                null,--SSBSECT_BEST_OF_COMP
                                                                                null,--SSBSECT_SUBSET_OF_COMP
                                                                                'NOP',--SSBSECT_INSM_CODE
                                                                                null,--SSBSECT_REG_FROM_DATE
                                                                                null,--SSBSECT_REG_TO_DATE
                                                                                null,--SSBSECT_LEARNER_REGSTART_FDATE
                                                                                null,--SSBSECT_LEARNER_REGSTART_TDATE
                                                                                null,--SSBSECT_DUNT_CODE
                                                                                null,--SSBSECT_NUMBER_OF_UNITS
                                                                                0,--SSBSECT_NUMBER_OF_EXTENSIONS
                                                                                'SZFCARG',--SSBSECT_DATA_ORIGIN
                                                                                user,--SSBSECT_USER_ID
                                                                                'MOOD',--SSBSECT_INTG_CDE
                                                                                'B',--SSBSECT_PREREQ_CHK_METHOD_CDE
                                                                                user,--SSBSECT_KEYWORD_INDEX_ID
                                                                                null,--SSBSECT_SCORE_OPEN_DATE
                                                                                null,--SSBSECT_SCORE_CUTOFF_DATE
                                                                                null,--SSBSECT_REAS_SCORE_OPEN_DATE
                                                                                null,--SSBSECT_REAS_SCORE_CTOF_DATE
                                                                                null,--SSBSECT_SURROGATE_ID
                                                                                null,--SSBSECT_VERSION
                                                                                 null);--SSBSECT_VPDI_CODE


                                                   Begin
                                                                update SOBTERM
                                                                     set SOBTERM_CRN_ONEUP = crn
                                                                where SOBTERM_TERM_CODE = c.periodo;
                                                   Exception
                                                   When Others then
                                                     null;
                                                   End;

                                                   Begin
                                                        insert into ssrmeet values(C.periodo, crn, null,null,null,null,null,null, sysdate, f_inicio, f_fin, '01', null,null,null,null,null,null,null, 'ENL', null, credit, null, 0, null,null,null, 'CLVI', 'SZFCARG', user, null,null,null);
                                                    Exception
                                                    when Others then
                                                       vl_error := 'Se presento un Error al insertar en ssrmeet ' ||sqlerrm;
                                                   End;


                                                    begin
                                                        select spriden_pidm
                                                            into pidm_prof
                                                        from  spriden
                                                        where   spriden_id=c.prof and spriden_change_ind is null;
                                                    Exception when others then
                                                      pidm_prof:=null;
                                                    End;

                                                    if pidm_prof is not null then
                                                      --dbms_output.put_line('Crea el CRN para el docente:'|| pidm_prof  ||'*'||crn);

                                                      Begin
                                                            Select count (1)
                                                            Into vl_exite_prof
                                                            from sirasgn
                                                            Where SIRASGN_TERM_CODE = c.periodo
                                                            And SIRASGN_CRN = crn;
                                                           -- And SIRASGN_PIDM = pidm_prof;
                                                       Exception
                                                        when others then
                                                          vl_exite_prof := 0;
                                                       End;

                                                       If vl_exite_prof = 0 then
                                                                Begin
                                                                --dbms_output.put_line('Salida INST EXEX  20-B :'|| c.periodo  ||'*'||crn||'*'|| pidm_prof||'*'||c.subj||'*'||c.crse||'*'||c.grupo||'*'||schd||'*'||c.campus);

                                                                        insert into sirasgn values(c.periodo, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,
                                                                                                             sysdate, null,null,null,null, 'UTEL', 'MIGRA_D', null, null, null, null,  null,null);
                                                                Exception
                                                                When Others then
                                                                null;
                                                                End;
                                                       Else
                                                               Begin
                                                                    Update sirasgn
                                                                    set SIRASGN_PRIMARY_IND = null
                                                                     Where SIRASGN_TERM_CODE = c.periodo
                                                                     And SIRASGN_CRN = crn;
                                                               Exception
                                                                When others then
                                                                null;
                                                               End;

                                                                Begin
                                                                --dbms_output.put_line('Salida INST EXEX  20-C :'|| c.periodo  ||'*'||crn||'*'|| pidm_prof||'*'||c.subj||'*'||c.crse||'*'||c.grupo||'*'||schd||'*'||c.campus);

                                                                        insert into sirasgn values(c.periodo, crn, pidm_prof, '01', 100, null, 100,'Y', null, null,
                                                                                                             sysdate, null,null,null,null, 'UTEL', 'MIGRA_D', null, null, null, null,  null,null);
                                                                Exception
                                                                When Others then
                                                                null;
                                                                End;

                                                       End if;
                                                    end if;


                                                conta_ptrm :=0;
                                   --dbms_output.put_line('salida 21  '||c.pidm ||'-'|| c.prog  );
                                                    Begin
                                                         select count(*)
                                                            into conta_ptrm
                                                         from sfbetrm
                                                         where sfbetrm_term_code=c.periodo
                                                         and     sfbetrm_pidm=c.pidm;
                                                    Exception
                                                        When Others then
                                                          conta_ptrm := 0;
                                                    End;


                                                     if conta_ptrm =0 then
                                                            Begin
                                                                    insert into sfbetrm values(c.periodo, c.pidm, 'EL', sysdate, 99.99, 'Y', null, sysdate, sysdate, null,null,null,null,user, null,'SZFCARG', null, 0,null,null, null,null,user,null);
                                                            Exception
                                                            When Others then
                                                                vl_error := ('Se presento un error al insertar en la tabla sfbetrm ' || sqlerrm);
                                                            End;
                                                     end if;

                                                   Begin
                                                   --dbms_output.put_line('Salida INST EXEX  21-D :'||c.pidm||'-'||  c.periodo  ||'*'||crn||'*'|| c.grupo||'*'||c.parte||'*'||credit_bill||'*'||credit||'*'||gmod||'*'||c.campus);

                                                       insert into sfrstcr values(
                                                                                        c.periodo,     --SFRSTCR_TERM_CODE
                                                                                        c.pidm,     --SFRSTCR_PIDM
                                                                                        crn,     --SFRSTCR_CRN
                                                                                        null,     --SFRSTCR_CLASS_SORT_KEY
                                                                                        c.grupo,    --SFRSTCR_REG_SEQ
                                                                                        c.parte,    --SFRSTCR_PTRM_CODE
                                                                                        'RE',     --SFRSTCR_RSTS_CODE
                                                                                        sysdate,    --SFRSTCR_RSTS_DATE
                                                                                        null,    --SFRSTCR_ERROR_FLAG
                                                                                        null,    --SFRSTCR_MESSAGE
                                                                                        credit_bill,    --SFRSTCR_BILL_HR
                                                                                        3, --SFRSTCR_WAIV_HR
                                                                                        credit,     --SFRSTCR_CREDIT_HR
                                                                                        credit_bill,     --SFRSTCR_BILL_HR_HOLD
                                                                                        credit,     --SFRSTCR_CREDIT_HR_HOLD
                                                                                        gmod,     --SFRSTCR_GMOD_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE
                                                                                        null,    --SFRSTCR_GRDE_CODE_MID
                                                                                        null,    --SFRSTCR_GRDE_DATE
                                                                                        'N',    --SFRSTCR_DUPL_OVER
                                                                                        'N',    --SFRSTCR_LINK_OVER
                                                                                        'N',    --SFRSTCR_CORQ_OVER
                                                                                        'N',    --SFRSTCR_PREQ_OVER
                                                                                        'N',     --SFRSTCR_TIME_OVER
                                                                                        'N',     --SFRSTCR_CAPC_OVER
                                                                                        'N',     --SFRSTCR_LEVL_OVER
                                                                                        'N',     --SFRSTCR_COLL_OVER
                                                                                        'N',     --SFRSTCR_MAJR_OVER
                                                                                        'N',     --SFRSTCR_CLAS_OVER
                                                                                        'N',     --SFRSTCR_APPR_OVER
                                                                                        'N',     --SFRSTCR_APPR_RECEIVED_IND
                                                                                        sysdate,      --SFRSTCR_ADD_DATE
                                                                                        sysdate,     --SFRSTCR_ACTIVITY_DATE
                                                                                        c.nivel,     --SFRSTCR_LEVL_CODE
                                                                                        c.campus,     --SFRSTCR_CAMP_CODE
                                                                                         c.materia,     --SFRSTCR_RESERVED_KEY
                                                                                        null,     --SFRSTCR_ATTEND_HR
                                                                                        'Y',     --SFRSTCR_REPT_OVER
                                                                                        'N' ,    --SFRSTCR_RPTH_OVER
                                                                                        null,    --SFRSTCR_TEST_OVER
                                                                                        'N',    --SFRSTCR_CAMP_OVER
                                                                                        user,    --SFRSTCR_USER
                                                                                        'N',    --SFRSTCR_DEGC_OVER
                                                                                        'N',    --SFRSTCR_PROG_OVER
                                                                                        null,    --SFRSTCR_LAST_ATTEND
                                                                                        null,    --SFRSTCR_GCMT_CODE
                                                                                        'SZFCARG',    --SFRSTCR_DATA_ORIGIN
                                                                                        sysdate,   --SFRSTCR_ASSESS_ACTIVITY_DATE
                                                                                        'N',  --SFRSTCR_DEPT_OVER
                                                                                        'N',  --SFRSTCR_ATTS_OVER
                                                                                        'N', --SFRSTCR_CHRT_OVER
                                                                                        null, --SFRSTCR_RMSG_CDE
                                                                                        null,  --SFRSTCR_WL_PRIORITY
                                                                                        null,  --SFRSTCR_WL_PRIORITY_ORIG
                                                                                        null,  --SFRSTCR_GRDE_CODE_INCMP_FINAL
                                                                                        null, --SFRSTCR_INCOMPLETE_EXT_DATE
                                                                                        'N', --SFRSTCR_MEXC_OVER
                                                                                        c.study,--SFRSTCR_STSP_KEY_SEQUENCE
                                                                                        null,--SFRSTCR_BRDH_SEQ_NUM
                                                                                        '01',--SFRSTCR_BLCK_CODE
                                                                                        null,--SFRSTCR_STRH_SEQNO
                                                                                        null, --SFRSTCR_STRD_SEQNO
                                                                                        null,  --SFRSTCR_SURROGATE_ID
                                                                                        null, --SFRSTCR_VERSION
                                                                                        user,--SFRSTCR_USER_ID
                                                                                        null );--SFRSTCR_VPDI_CODE

                                                         --dbms_output.put_line('DESPUES de insertar EXEX ' || c.pidm||'-'||c.periodo||'-'|| crn|| c.grupo||'-'||  c.parte||'EXEX'  );


                                                                Begin
                                                                     update ssbsect
                                                                            set ssbsect_enrl = ssbsect_enrl + 1
                                                                      where SSBSECT_TERM_CODE = C.periodo
                                                                      And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                vl_error := 'Se presento un error al actualizar el enrolamiento ' ||sqlerrm;
                                                                End;

                                                                Begin
                                                                        update ssbsect
                                                                            set ssbsect_seats_avail=ssbsect_seats_avail -1
                                                                        where SSBSECT_TERM_CODE = c.periodo
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar la disponibilidad del grupo ' ||sqlerrm;
                                                                End;

                                                                Begin
                                                                         update ssbsect
                                                                                set ssbsect_census_enrl=ssbsect_enrl
                                                                         Where SSBSECT_TERM_CODE = c.periodo
                                                                         And SSBSECT_CRN  = crn;
                                                                Exception
                                                                When Others then
                                                                    vl_error := 'Se presento un error al actualizar el Censo del grupo ' ||sqlerrm;
                                                                End;

                                                                Begin
                                                                    Update sgbstdn a
                                                                    set a.SGBSTDN_STYP_CODE ='C'
                                                                    Where a.SGBSTDN_PIDM = c.pidm
                                                                    And a.SGBSTDN_TERM_CODE_EFF = (select max (a1.SGBSTDN_TERM_CODE_EFF)
                                                                                                                           from sgbstdn a1
                                                                                                                           Where a1.SGBSTDN_PIDM = a.SGBSTDN_PIDM
                                                                                                                           And a1.SGBSTDN_PROGRAM_1 = a.SGBSTDN_PROGRAM_1)
                                                                     And a.SGBSTDN_PROGRAM_1 = c.prog;
                                                                Exception
                                                                    When Others then
                                                                    vl_error := 'Se presento un error al actualizar el tipo de alumno en sgbstdn ' ||sqlerrm;
                                                                End;

                                                                f_inicio := null;

                                                                 Begin
                                                                        select distinct sobptrm_start_date
                                                                        into f_inicio
                                                                        from sobptrm
                                                                        where sobptrm_term_code=c.periodo
                                                                        and     sobptrm_ptrm_code=c.parte;
                                                                 Exception
                                                                 When Others then
                                                                   f_inicio := null;
                                                                    vl_error := 'Se presento un error al Obtener la fecha de inicio de Clases ' ||sqlerrm;
                                                                 End;

                                                                If f_inicio is not null then

                                                                    Begin
                                                                    null;
                                                                    /*
                                                                            Update sorlcur
                                                                            set sorlcur_start_date  = trunc (f_inicio)
                                                                            Where SORLCUR_PIDM = c.pidm
                                                                            And SORLCUR_PROGRAM = c.prog
                                                                            And SORLCUR_LMOD_CODE = 'LEARNER'
                                                                            And SORLCUR_KEY_SEQNO = c.study;
                                                                   */
                                                                    Exception
                                                                        When Others then

                                                                         vl_error := 'Se presento un error al actualizar la fecha de Inicio de Clases en sorlcur ' ||sqlerrm;
                                                                       --dbms_output.put_line(vl_error);

                                                                    End;

                                                                End if;

                                                                conta_ptrm:=0;

                                                                Begin
                                                                    Select count (*)
                                                                        Into conta_ptrm
                                                                    from sfrareg
                                                                    where SFRAREG_PIDM = c.pidm
                                                                    And SFRAREG_TERM_CODE = c.periodo
                                                                    And SFRAREG_CRN = crn
                                                                    And SFRAREG_EXTENSION_NUMBER = 0
                                                                    And SFRAREG_RSTS_CODE = 'RE';
                                                                Exception
                                                                When Others then
                                                                   conta_ptrm :=0;
                                                                End;

                                                                If conta_ptrm = 0 then

                                                                     Begin
                                                                       --dbms_output.put_line(' SALIDA 22A--antes de insertar ' || c.pidm||'-'||c.periodo||'-'|| crn||f_inicio||'-'|| f_fin||'-'|| 'N'||'-'||'N'   );

                                                                             insert into sfrareg values(c.pidm, c.periodo, crn , 0, 'RE', f_inicio, f_fin, 'N','N', sysdate, user, null,null,null,null,null,null,null,null, 'SZFCARG', sysdate, null,null,null);
                                                                     Exception
                                                                       When Others then
                                                                          vl_error := 'Se presento un error al insertar el registro de la materia para el alumno EXEX ' ||sqlerrm;
                                                                     End;
                                                                End if;
                                                       commit;
                                                    Exception
                                                   when Others then
                                                       vl_error := 'Se presento un error al insertar al alumno en el grupo3 ' ||sqlerrm;
                                                   End;
                                     commit;
                                                  --dbms_output.put_line('mensaje1:exex'|| 'SE creo el grupo :=' ||crn);
                                  Exception
                                    When Others then
                                      vl_error := 'Se presento un Error al insertar el nuevo grupo 3' ||sqlerrm;
                                  End;

                        End if;
                End if;  ------ No hay  CRN Creado

                if vl_error = 'EXITO' then
                    commit; --Commit;
                    --dbms_output.put_line('mensaje EXITO EXEX :'||vl_error);
                    --dbms_output.put_line('salida22  '||c.pidm ||'-'|| c.prog  );
                    Begin
                            Insert into SZtCARGA values (c.iden, --SZCARGA_ID
                                                           c.materia, --SZCARGA_MATERIA
                                                           c.prog,         --SZCARGA_PROGRAM
                                                           c.periodo,         --SZCARGA_TERM_CODE
                                                           c.parte,         --SZCARGA_PTRM_CODE
                                                           c.grupo,         --SZCARGA_GRUPO
                                                           null,         --SZCARGA_CALIF
                                                           c.prof,         --SZCARGA_ID_PROF
                                                           user,         --SZCARGA_USER_ID
                                                           sysdate,         --SZCARGA_ACTIVITY_DATE
                                                           c.fecha_inicio,         --SZCARGA_FECHA_INI
                                                           'P',          --SZCARGA_ESTATUS
                                                           'Horario Generado' ,  --SZCARGA_OBSERVACIONES
                                                           'EXEX',
                                                           99
                                                           );
                    Exception
                     when DUP_VAL_ON_INDEX then
                        Begin
                          Update SZtCARGA
                          set SZCARGA_ESTATUS = 'P' ,
                          SZCARGA_OBSERVACIONES =  'Horario Generado',
                          SZCARGA_ACTIVITY_DATE = sysdate
                          Where SZCARGA_ID = c.iden
                          and SZCARGA_MATERIA = c.materia
                          AND SZTCARGA_TIPO_PROC = 'EXEX'
                          and SZTCARGA_NO_REGLA  = 99
                          and trunc (SZCARGA_FECHA_INI) = c.fecha_inicio;
                          --dbms_output.put_line('mensaje UPDATE SZTCARGA 23 :'||vl_error);
                          Exception
                          When Others then
                          vl_error := 'Se presento un Error al Actualizar la bitacora '||sqlerrm;
                        End;
                    When Others then
                     vl_error := 'Se presento un Error al insertar la bitacora '||sqlerrm;
                    End;


                Else
                 --dbms_output.put_line('mensaje else EXEX:'||vl_error);
                 --dbms_output.put_line('salida 23  '||c.pidm ||'-'|| c.prog  );
                   rollback;
                    Begin
                            Insert into SZtCARGA values (c.iden, --SZCARGA_ID
                                                                       c.materia, --SZCARGA_MATERIA
                                                                       c.prog,         --SZCARGA_PROGRAM
                                                                       c.periodo,         --SZCARGA_TERM_CODE
                                                                       c.parte,         --SZCARGA_PTRM_CODE
                                                                       c.grupo,         --SZCARGA_GRUPO
                                                                       null,         --SZCARGA_CALIF
                                                                       c.prof,         --SZCARGA_ID_PROF
                                                                       user,         --SZCARGA_USER_ID
                                                                       sysdate,         --SZCARGA_ACTIVITY_DATE
                                                                       c.fecha_inicio,         --SZCARGA_FECHA_INI
                                                                      'E',          --SZCARGA_ESTATUS
                                                                       vl_error,  --SZCARGA_OBSERVACIONES
                                                                       'EXEX',
                                                                       99
                                                                       );
                              commit;
                    Exception
                     when DUP_VAL_ON_INDEX then
                        Begin
                          Update SZtCARGA
                          set SZCARGA_ESTATUS = 'E' ,
                          SZCARGA_OBSERVACIONES =  vl_error,
                          SZCARGA_ACTIVITY_DATE = sysdate
                          Where SZCARGA_ID = c.iden
                          and SZCARGA_MATERIA = c.materia
                          AND SZTCARGA_TIPO_PROC = 'EXEX'
                          and SZTCARGA_NO_REGLA  = 99
                          and trunc (SZCARGA_FECHA_INI) = c.fecha_inicio;
                          Exception
                          When Others then
                          vl_error := 'Se presento un Error al Actualizar la bitacora de Error '||sqlerrm;
                        End;
                    When Others then
                     vl_error := 'Se presento un Error al insertar la bitacora de Error '||sqlerrm;
                    End;


                End if;
        Else
        --dbms_output.put_line('salida 24  '||c.pidm ||'-'|| c.prog  );
           vl_error := 'El alumno ya tiene la materia Inscritas en el Periodo:'||period_cur||'. Parte-periodo:'||parteper_cur;
                   Begin
                            Insert into SZtCARGA values (c.iden, --SZCARGA_ID
                                                           c.materia, --SZCARGA_MATERIA
                                                           c.prog,         --SZCARGA_PROGRAM
                                                           c.periodo,         --SZCARGA_TERM_CODE
                                                           c.parte,         --SZCARGA_PTRM_CODE
                                                           c.grupo,         --SZCARGA_GRUPO
                                                           null,         --SZCARGA_CALIF
                                                           c.prof,         --SZCARGA_ID_PROF
                                                           user,         --SZCARGA_USER_ID
                                                           sysdate,         --SZCARGA_ACTIVITY_DATE
                                                           c.fecha_inicio,         --SZCARGA_FECHA_INI
                                                           'A',--'P',          --SZCARGA_ESTATUS
                                                           vl_error,  --SZCARGA_OBSERVACIONES
                                                           'EXEX',
                                                           99
                                                           );
                              commit;
                     Exception
                     when DUP_VAL_ON_INDEX then
                        Begin
                          Update SZtCARGA
                          set SZCARGA_ESTATUS = 'A',--'P' ,
                          SZCARGA_OBSERVACIONES =  vl_error,
                          SZCARGA_ACTIVITY_DATE = sysdate
                          Where SZCARGA_ID = c.iden
                          and SZCARGA_MATERIA = c.materia
                          AND SZTCARGA_TIPO_PROC = 'EXEX'
                          and SZTCARGA_NO_REGLA  = 99
                          and trunc (SZCARGA_FECHA_INI) = c.fecha_inicio;
                          Exception
                          When Others then
                          vl_error := 'Se presento un Error al Actualizar la bitacora de Error '||sqlerrm;
                        End;
                    When Others then
                     vl_error := 'Se presento un Error al insertar la bitacora de Error '||sqlerrm;
                    End;


        End if; ----> El alumno ya tiene inscrita la materia
   ELSE
   --dbms_output.put_line('salida 25  '||c.pidm ||'-'|| c.prog  );
       vl_error := 'Estatus no v?do para realizar la carga: '||C.SGBSTDN_STST_CODE;
                   Begin
                            Insert into SZtCARGA values (c.iden, --SZCARGA_ID
                                                                       c.materia, --SZCARGA_MATERIA
                                                                       c.prog,         --SZCARGA_PROGRAM
                                                                       c.periodo,         --SZCARGA_TERM_CODE
                                                                       c.parte,         --SZCARGA_PTRM_CODE
                                                                       c.grupo,         --SZCARGA_GRUPO
                                                                       null,         --SZCARGA_CALIF
                                                                       c.prof,         --SZCARGA_ID_PROF
                                                                       user,         --SZCARGA_USER_ID
                                                                       sysdate,         --SZCARGA_ACTIVITY_DATE
                                                                       c.fecha_inicio,         --SZCARGA_FECHA_INI
                                                                       'A',--'P',          --SZCARGA_ESTATUS
                                                                       vl_error,  --SZCARGA_OBSERVACIONES
                                                                       'EXEX',
                                                                       99
                                                                       );
                              commit;
                     Exception
                     when DUP_VAL_ON_INDEX then
                        Begin
                          Update SZtCARGA
                          set SZCARGA_ESTATUS = 'A',--'P' ,
                          SZCARGA_OBSERVACIONES =  vl_error,
                          SZCARGA_ACTIVITY_DATE = sysdate
                          Where SZCARGA_ID = c.iden
                          and SZCARGA_MATERIA = c.materia
                          AND SZTCARGA_TIPO_PROC = 'EXEX'
                          and SZTCARGA_NO_REGLA  = 99
                          and trunc (SZCARGA_FECHA_INI) = c.fecha_inicio;
                          Exception
                          When Others then
                          vl_error := 'Se presento un Error al Actualizar la bitacora de Error '||sqlerrm;
                        End;
                    When Others then
                     vl_error := 'Se presento un Error al insertar la bitacora de Error '||sqlerrm;
                    End;
   END IF;
   --dbms_output.put_line('salida 30  '||c.pidm ||'-'|| c.prog || '-'|| c.periodo );

   ---------- SECAMBIA EL ESTTUS DE LA SOLICITUD DE SERVICIO-  CONCLUIDO----------VIC.. 09.05.2018-----

    begin
    UPDATE SVRSVPR V
       SET  v.SVRSVPR_SRVS_CODE = 'CL'
        ,SVRSVPR_ACTIVITY_DATE  = sysdate
       where  V.SVRSVPR_PIDM   = c.pidm
           and   v.SVRSVPR_PROTOCOL_SEQ_NO = (
            SELECT distinct P.SVRSVPR_PROTOCOL_SEQ_NO
                  FROM SVRSVPR p,
                       SVRSVAD a,
                       SVRSRAD r
                 WHERE a.SVRSVAD_PROTOCOL_SEQ_NO = p.SVRSVPR_PROTOCOL_SEQ_NO
                   AND r.SVRSRAD_SRVC_CODE       = p.SVRSVPR_SRVC_CODE
                   AND r.SVRSRAD_ADDL_DATA_SEQ   = a.SVRSVAD_ADDL_DATA_SEQ
                   and  P.SVRSVPR_PIDM  =  c.pidm
                   AND SUBSTR(SVRSVAD_ADDL_DATA_CDE,1,INSTR(SVRSVAD_ADDL_DATA_CDE,'|',1)-1)    = c.materia  --materia
                   and  P.SVRSVPR_TERM_CODE     =  c.sorlterm   ---term
                   ) ;
   exception when others then
   null;
   --dbms_output.put_line('salida 33  actualiza al final ultima   '||c.pidm ||'-'|| c.prog || '-'|| c.periodo );


   end;
  ---------------SE ACTUALIZA LA MATERIA NIVELACION CON EL NUMERO DE ORDEN QUE SE LE PUSO EN TBRACCD--- GLO VIC 21/05/2019

   --dbms_output.put_line('salida 31  '||c.pidm ||'-'|| c.prog || '-' || c.periodo );

     begin

        select DISTINCT max(TBRACCD_RECEIPT_NUMBER)
        into  no_recibo
        from tbraccd
        where 1=1
        AND  TBRACCD_DETAIL_CODE IN ( SELECT  DISTINCT SVRRSSO_DETL_CODE
                                      FROM SVRRSSO
                                        WHERE  1=1
                                      AND SVRRSSO_SRVC_CODE = 'NIVE')
        AND  TBRACCD_RECEIPT_NUMBER IS NOT  NULL
        and  TBRACCD_PIDM  = c.pidm
        --AND  TRUNC(TBRACCD_ACTIVITY_DATE) >= TRUNC(SYSDATE)-30
        ;
       exception when others then
       no_recibo := '';
       end ;

        begin
             UPDATE sfrstcr f
                SET  SFRSTCR_VPDI_CODE = no_recibo
                WHERE 1=1
                and F.SFRSTCR_PIDM = c.pidm
                and F.SFRSTCR_CRN  = crn
                ;
       exception when others then
       no_recibo := '';

       end ;


 End loop;

 commit;

/*         se desahabilito  esta seccion por que ya todos los regs estan marcados con error o exito; SI N? cambiar el cursor
for x in c_no_proce loop
          ---     vl_error := 'Materia no Registrada para el Alumno en SFAREGS';
                   Begin
                            Insert into SZtCARGA values (x.SZCARGA_ID, --SZCARGA_ID
                                                                       x.SZCARGA_MATERIA, --SZCARGA_MATERIA
                                                                       x.SZCARGA_PROGRAM,         --SZCARGA_PROGRAM
                                                                       x.SZCARGA_TERM_CODE,         --SZCARGA_TERM_CODE
                                                                       x.SZCARGA_PTRM_CODE,         --SZCARGA_PTRM_CODE
                                                                       x.SZCARGA_GRUPO,         --SZCARGA_GRUPO
                                                                       x.SZCARGA_CALIF,         --SZCARGA_CALIF
                                                                       x.SZCARGA_ID_PROF,         --SZCARGA_ID_PROF
                                                                       user,         --SZCARGA_USER_ID
                                                                       sysdate,         --SZCARGA_ACTIVITY_DATE
                                                                       x.SZCARGA_FECHA_INI,         --SZCARGA_FECHA_INI
                                                                       'E',          --SZCARGA_ESTATUS
                                                                       vl_error,  --SZCARGA_OBSERVACIONES
                                                                       'EXEX',
                                                                       99
                                                                       );
                       commit;
                   Exception
                     when DUP_VAL_ON_INDEX then
                        Begin
                          Update SZtCARGA
                          set SZCARGA_ESTATUS = 'E',
                          SZCARGA_CALIF=x.SZCARGA_CALIF,
                          SZCARGA_OBSERVACIONES =  vl_error,
                          SZCARGA_ACTIVITY_DATE = sysdate
                          Where SZCARGA_ID = x.SZCARGA_ID
                          and SZCARGA_MATERIA = x.SZCARGA_MATERIA
                          AND SZTCARGA_TIPO_PROC = 'EXEX'
                          and SZTCARGA_NO_REGLA  = 99
                          and trunc (SZCARGA_FECHA_INI) = x.SZCARGA_FECHA_INI;
                          Exception
                          When Others then
                          vl_error := 'Se presento un Error al Actualizar la bitacora de Error '||sqlerrm;
                        End;
                    When Others then
                     vl_error := 'Se presento un Error al insertar la bitacora de Error '||sqlerrm;
                    End;
end loop;

*/
 commit;


--         se desahabilito  esta seccion por que ya todos los regs estan marcados con error o exito; SI N? cambiar el cursor
for x in (select *
                from szcarga
                where SZCARGA_NO_REGLA = 99)
 loop
          ---     vl_error := 'Materia no Registrada para el Alumno en SFAREGS';

    begin
       select count(SZCARGA_ID)
         into vvalidacion
       from sztcarga
       where SZCARGA_ID = x.SZCARGA_ID;

    exception when others then
     vvalidacion := 0;
    end;

    IF  vvalidacion = 0 then
                Begin
                            Insert into SZtCARGA values (x.SZCARGA_ID, --SZCARGA_ID
                                                                       x.SZCARGA_MATERIA, --SZCARGA_MATERIA
                                                                       x.SZCARGA_PROGRAM,         --SZCARGA_PROGRAM
                                                                       x.SZCARGA_TERM_CODE,         --SZCARGA_TERM_CODE
                                                                       x.SZCARGA_PTRM_CODE,         --SZCARGA_PTRM_CODE
                                                                       x.SZCARGA_GRUPO,         --SZCARGA_GRUPO
                                                                       x.SZCARGA_CALIF,         --SZCARGA_CALIF
                                                                       x.SZCARGA_ID_PROF,         --SZCARGA_ID_PROF
                                                                       user,         --SZCARGA_USER_ID
                                                                       sysdate,         --SZCARGA_ACTIVITY_DATE
                                                                       x.SZCARGA_FECHA_INI,         --SZCARGA_FECHA_INI
                                                                       'E',          --SZCARGA_ESTATUS
                                                                       'Materia no esta en la bitacora',  --SZCARGA_OBSERVACIONES
                                                                       'EXEX',
                                                                       99
                                                                       );
                       commit;
                   Exception
                     when DUP_VAL_ON_INDEX then
                        Begin
                          Update SZtCARGA
                          set SZCARGA_ESTATUS = 'E',
                          SZCARGA_CALIF=x.SZCARGA_CALIF,
                          SZCARGA_OBSERVACIONES =  vl_error,
                          SZCARGA_ACTIVITY_DATE = sysdate
                          Where SZCARGA_ID = x.SZCARGA_ID
                          and SZCARGA_MATERIA = x.SZCARGA_MATERIA
                          AND SZTCARGA_TIPO_PROC = 'EXEX'
                          and SZTCARGA_NO_REGLA  = 99
                          and trunc (SZCARGA_FECHA_INI) = x.SZCARGA_FECHA_INI;
                          Exception
                          When Others then
                          vl_error := 'Se presento un Error al Actualizar la bitacora de Error '||sqlerrm;
                        End;
                    When Others then
                     vl_error := 'Se presento un Error al insertar la bitacora de Error '||sqlerrm;
                    End;

     end if;

end loop;


 commit;

-------------------------

 ------------------- Realiza el proceso de actualizacion de Jornadas  ----------------------------------

Begin

For c in (
select SZCARGA_ID, SZCARGA_TERM_CODE, SZCARGA_PTRM_CODE, spriden_pidm , SORLCUR_KEY_SEQNO,  count (*) numero
from SZtCARGA, spriden, sorlcur  s
where SZTCARGA_TIPO_PROC = 'EXEX'
and SZCARGA_ESTATUS != 'E'
and SZCARGA_ID = spriden_id
and s.sorlcur_pidm = spriden_pidm
and s.sorlcur_program=SZCARGA_PROGRAM
and s.sorlcur_lmod_code='LEARNER'
and s.sorlcur_seqno in (select max(ss.sorlcur_seqno)
                                from sorlcur ss
                                where s.sorlcur_pidm=ss.sorlcur_pidm
                                and s.sorlcur_lmod_code=ss.sorlcur_lmod_code
                                and     s.sorlcur_program=ss.sorlcur_program)
--and  SZCARGA_ID    = '040178216'
group by SZCARGA_ID, SZCARGA_TERM_CODE, SZCARGA_PTRM_CODE, spriden_pidm, SORLCUR_KEY_SEQNO
order by 1, 2, 3

) loop

   vl_jornada := null;

    Begin
    select distinct substr (SGRSATT_ATTS_CODE, 1,3) jornada
        Into vl_jornada
    from SGRSATT a
    where a.SGRSATT_pidm = c.spriden_pidm
    and a.SGRSATT_STSP_KEY_SEQUENCE = c.SORLCUR_KEY_SEQNO
    and regexp_like(a.SGRSATT_ATTS_CODE, '^[0-9]')
    and a.SGRSATT_TERM_CODE_EFF = (select max (a1.SGRSATT_TERM_CODE_EFF)
                                                            from SGRSATT a1
                                                            where a.SGRSATT_pidm = a1.SGRSATT_pidm
                                                            and a.SGRSATT_STSP_KEY_SEQUENCE = a1.SGRSATT_STSP_KEY_SEQUENCE);

    Exception
    when OThers then
    vl_jornada :=null;
    End ;

--dbms_output.put_line('salida1 '||c.spriden_pidm||'*'|| c.SZCARGA_TERM_CODE ||'*'|| vl_jornada||'*'|| c.SORLCUR_KEY_SEQNO);
    If vl_jornada  is not null  then
       vl_jornada := vl_jornada||c.numero;
         NULL;
          -----  --------SSE QUITO ESTA VALIDACION POR REGLA DE FER DIA 12 OCT 2018  GLOVICX EN PROD  SOLO SE HACE EL INSERT
       ----PKG_EXTRA.P_ACTUALIZA_JORNADA (c.spriden_pidm, c.SZCARGA_TERM_CODE, vl_jornada, c.SORLCUR_KEY_SEQNO);


        Begin

            Begin
                    Select count (*)
                        into vn_number
                    from SGRSATT
                    where SGRSATT_PIDM = c.spriden_pidm
                   -- and SGRSATT_ATTS_CODE = P_JORNADA
                   and regexp_like(SGRSATT_ATTS_CODE, '^[0-9]')
                    and SGRSATT_TERM_CODE_EFF =  c.SZCARGA_TERM_CODE
                    And SGRSATT_STSP_KEY_SEQUENCE  =  c.SORLCUR_KEY_SEQNO;

            Exception
            When Others then
               vn_number :=0;
            End;

            If vn_number = 0 and substr(c.SZCARGA_TERM_CODE,5,1) not in (8,9) then
                Begin
                        Insert into SGRSATT values (c.spriden_pidm,
                                                    c.SZCARGA_TERM_CODE,
                                                    vl_jornada,
                                                    sysdate,
                                                    c.SORLCUR_KEY_SEQNO,
                                                    null,
                                                    null,
                                                    user,
                                                    'SZFCARG_NIVE',
                                                    NULL);
                Exception
                When Others then
                 null;
                End;

            Else
                NULL;

            End if;

                commit;

        End;



    End if;

 End loop;
 Commit;
 End;


end carga_inscrip_extra;




END PKG_EXTRA;
/

DROP PUBLIC SYNONYM PKG_EXTRA;

CREATE OR REPLACE PUBLIC SYNONYM PKG_EXTRA FOR BANINST1.PKG_EXTRA;


GRANT EXECUTE, DEBUG ON BANINST1.PKG_EXTRA TO PUBLIC;
