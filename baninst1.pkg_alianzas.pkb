DROP PACKAGE BODY BANINST1.PKG_ALIANZAS;

CREATE OR REPLACE PACKAGE BODY BANINST1.pkg_alianzas AS
--
--
    --Jpg@Create@Jun22 Proceso de Elimina Etiqueta Alianza en GORADID en base a la regla que se ejecuta
    PROCEDURE p_elimina_etiqueta(p_regla number, p_delete number default 0) is
        lv_totcurr number :=0;
    Begin

                                     Pkg_Algoritmo.P_Track_Prono(p_regla,'Entra a elimina etiqueta p_delete:'||p_delete );

            FOR pob IN (
Select distinct sztprono_id matricula,
                                sztprono_pidm pidm,
                                Case When sztalgo_levl_code='MS' Then 'MA' else sztalgo_levl_code end nivel
                from sztalgo
                join sztprono p on p.sztprono_no_regla=sztalgo_no_regla
                            and p.sztprono_term_code=sztalgo_term_code_new
                join goradid on goradid_pidm = sztprono_pidm
                join sztalia on sztalia_code = goradid_adid_code
                            and sztalia_lvel = Case When sztalgo_levl_code='MS' Then 'MA' else sztalgo_levl_code end
                            and SZTALIA_NUM_MATERIAS > 0  --Solo Alianzas con materias
                where sztprono_no_regla=NVL(p_regla,sztprono_no_regla)
--                and sztprono_id='010198725'
                order by sztprono_pidm
            ) LOOP

                    FOR alu IN (
                        Select Distinct sztalia_code alianza, sztalia_num_materias totmat
                        from goradid
                        join sztalia on sztalia_code = goradid_adid_code
                        where goradid_pidm= pob.pidm
                        and sztalia_lvel = pob.nivel
                    ) LOOP
--dbms_output.put_line('pidm: '||pob.pidm||' nivel: '||pob.nivel||' alianza: '||alu.alianza||' totmat:'||alu.totmat);

                            Select count(1) tot_curr
                                into lv_totcurr
                            from szstume z
                              join sztalmt on sztalmt_materia = z.SZSTUME_SUBJ_CODE
                                  and sztalmt_nivel = pob.nivel
                                  and sztalmt_alianza = alu.alianza
                             where z.szstume_pidm=pob.pidm
                             and z.szstume_rsts_code='RE'
                             and z.SZSTUME_SEQ_NO = (Select Max(x.SZSTUME_SEQ_NO)
                                                    from SZSTUME x
                                                    where x.SZSTUME_no_regla = z.SZSTUME_no_regla
                                                    and x.SZSTUME_subj_code = z.SZSTUME_subj_code
                                                    and x.szstume_pidm = z.szstume_pidm);

                            if lv_totcurr >= alu.totmat then

                                IF P_DELETE = 0 THEN
                                    dbms_output.put_line('Alumno dar de baja etiqueta matricula: '||pob.matricula
                                                ||' Materias x Cursar'||alu.totmat||' Materias cursadas: '||lv_totcurr||
                                                ' Alianza: '||alu.alianza||' Nivel: '||pob.nivel ||' P_DELETE:'||p_delete );
                                END IF;

                                if p_delete > 0 Then

                                     Begin
                                        Delete from goradid
                                        where goradid_pidm= pob.pidm
                                        and GORADID_ADID_CODE = alu.alianza;

                                    dbms_output.put_line('Alumno dar de baja etiqueta matricula: '||pob.matricula
                                                ||' Materias x Cursar'||alu.totmat||' Materias cursadas: '||lv_totcurr||
                                                ' Alianza: '||alu.alianza||' Nivel: '||pob.nivel ||' P_DELETE:'||p_delete );

                                     Pkg_Algoritmo.P_Track_Prono(p_regla,'Alumno dar de baja etiqueta matricula: '||pob.matricula
                                                ||' Materias x Cursar'||alu.totmat||' Materias cursadas: '||lv_totcurr||
                                                ' Alianza: '||alu.alianza||' Nivel: '||pob.nivel ||' P_DELETE:'||p_delete );

                                     Exception When Others Then
                                        dbms_output.put_line('No fue posible borrar etiqueta: '||alu.alianza||' Matricula : '||pob.matricula||
                                            ' error: '||sqlerrm);
                                        Pkg_Algoritmo.P_Track_Prono(p_regla,'Alumno dar de baja etiqueta matricula: '||pob.matricula
                                                ||' Materias x Cursar'||alu.totmat||' Materias cursadas: '||lv_totcurr||
                                                ' Alianza: '||alu.alianza||' Nivel: '||pob.nivel ||' P_DELETE:'||p_delete );
                                     End;
                                end if;
                            end if;

                    END LOOP;

            END LOOP;

    end;

    --Jpg@Create@Feb22 Proceso de prioridades de alianzas
    --Proceso provisional para darle eliminar alianzas pronosticadas de más
    PROCEDURE p_prioridad_alianzas(p_regla number) IS
        Procedure delete_profun(p_regla number, p_prof number) is
        Begin
                Delete from sztprono
                where (sztprono_no_regla,sztprono_pidm, sztprono_secuencia)
                IN (
                Select  Distinct sztprono_no_regla, sztprono_pidm, sztprono_secuencia
                from sztalgo
                join sztprono p on p.sztprono_no_regla=sztalgo_no_regla
                            and p.sztprono_term_code=sztalgo_term_code_new
                join sztalmt on sztalmt_materia = sztprono_materia_legal
                            and sztalmt_nivel = Case When sztalgo_levl_code='MS' Then 'MA' else sztalgo_levl_code end
                join sztalia on sztalia_code = sztalmt_alianza
                            and sztalia_lvel = sztalmt_nivel
                            and SZTALIA_NUM_MATERIAS > 0  --Solo Alianzas con materias
                join (
                        Select  Distinct
                        sztalgo_no_regla regla,
                        p.sztprono_pidm pidm,
                        Max(sztalia_seq) sec_ali
                        from sztalgo
                        join sztprono p on p.sztprono_no_regla=sztalgo_no_regla
                                    and p.sztprono_term_code=sztalgo_term_code_new
                        join (
                            Select goradid_pidm pidm,
                            Count(GORADID_ADID_CODE) tot
                            from goradid
                            where GORADID_ADID_CODE   in
                                    (Select Distinct sztalia_code
                                        from sztalia)
                            having Count(1) >1
                            group by goradid_pidm
                        ) pob on pob.pidm = p.sztprono_pidm
                        join sztalmt on sztalmt_materia = p.sztprono_materia_legal
                                    and sztalmt_nivel = Case When sztalgo_levl_code='MS' Then 'MA' else sztalgo_levl_code end
                        join sztalia on sztalia_code = sztalmt_alianza
                                    and sztalia_lvel = sztalmt_nivel
                            and SZTALIA_NUM_MATERIAS > 0  --Solo Alianzas con materias
                        join (
                        Select sztprono_pidm pidm,  count(Distinct SZTALMT_ALIANZA) tot
                                    FROM sztprono
                                    join sztalmt on sztalmt_materia = sztprono_materia_legal
                                    join sztalia on sztalia_code= sztalmt_alianza
                                                    and sztalia_lvel = sztalmt_nivel
                                                    and SZTALIA_NUM_MATERIAS > 0  --Solo Alianzas con materias
                                    where sztprono_no_regla=p_regla
                                    and nvl(sztalia_seq,0) > 2
                          Group By sztprono_pidm
                        ) ali on ali.pidm=p.sztprono_pidm
                        where p.sztprono_no_regla=p_regla
                        and ali.tot= p_prof
                        and nvl(sztalia_seq,0) > 2 --Solo alianzas arriba de 2
                        GRoup by sztalgo_no_regla, p.sztprono_pidm
                    ) pob on pob.pidm = sztprono_pidm
                            and pob.regla = sztprono_no_regla
                            and pob.sec_ali = sztalia_seq
                )      ;
                commit;
        End;

        Procedure delete_2ejec_2ali(p_regla number, p_ejec varchar2, p_ali varchar2) is
        Begin
                DELETE FROM SZTPRONO
                WHERE (SZTPRONO_NO_REGLA, SZTPRONO_PIDM, SZTPRONO_SECUENCIA) IN (
                    Select  Distinct
                            sztalgo_no_regla regla,
                            p.sztprono_pidm pidm,
                            p.sztprono_secuencia
                        from sztalgo
                        join sztprono p on p.sztprono_no_regla=sztalgo_no_regla
                                    and p.sztprono_term_code=sztalgo_term_code_new
                        join (
                            Select goradid_pidm pidm,
                            Count(GORADID_ADID_CODE) tot
                            from goradid
                            where GORADID_ADID_CODE   in
                                    (Select Distinct sztalia_code
                                        from sztalia)
                            having Count(1) >1
                            group by goradid_pidm
                        ) pob on pob.pidm = p.sztprono_pidm
                        join sztalmt on sztalmt_materia = p.sztprono_materia_legal
                                    and sztalmt_nivel = Case When sztalgo_levl_code='MS' Then 'MA' else sztalgo_levl_code end
                        join sztalia on sztalia_code = sztalmt_alianza
                                    and sztalia_lvel = sztalmt_nivel
                        join (
                        Select sztprono_pidm pidm,  count(Distinct SZTALMT_ALIANZA) tot
                                    FROM sztprono
                                    join sztalmt on sztalmt_materia = sztprono_materia_legal
                                    join sztalia on sztalia_code= sztalmt_alianza
                                                    and sztalia_lvel = sztalmt_nivel
                                    where sztprono_no_regla=p_regla
                                    and sztalia_seq is not null
                          Group By sztprono_pidm
                        ) ali on ali.pidm=p.sztprono_pidm
                        join ( --1ER COMBINACION
                                Select  sztprono_pidm pidm, sztalia_code alianza,
                                        count(Distinct sztprono_materia_legal) tot
                                from sztalgo
                                join sztprono p on p.sztprono_no_regla=sztalgo_no_regla
                                            and p.sztprono_term_code=sztalgo_term_code_new
                                join sztalmt on sztalmt_materia = sztprono_materia_legal
                                            and sztalmt_nivel = Case When sztalgo_levl_code='MS' Then 'MA' else sztalgo_levl_code end
                                join sztalia on sztalia_code = sztalmt_alianza
                                            and sztalia_lvel = sztalmt_nivel
                                where sztprono_no_regla=p_regla
                                and sztalia_code=p_ejec
                                group by  sztprono_pidm,sztalia_code
                        ) ejec on ejec.pidm = p.sztprono_pidm
                                and ejec.tot=2
                        join ( --2DA COMBINACION
                                Select  sztprono_pidm pidm, sztalia_code alianza,
                                        count(Distinct sztprono_materia_legal) tot
                                from sztalgo
                                join sztprono p on p.sztprono_no_regla=sztalgo_no_regla
                                            and p.sztprono_term_code=sztalgo_term_code_new
                                join sztalmt on sztalmt_materia = sztprono_materia_legal
                                            and sztalmt_nivel = Case When sztalgo_levl_code='MS' Then 'MA' else sztalgo_levl_code end
                                join sztalia on sztalia_code = sztalmt_alianza
                                            and sztalia_lvel = sztalmt_nivel
                                where sztprono_no_regla=p_regla
                                and sztalia_code=p_ali
                                group by  sztprono_pidm,sztalia_code
                        ) muba on muba.pidm = p.sztprono_pidm
                                and muba.tot=2
                        --WHERE-
                        where p.sztprono_no_regla=p_regla
                        --PARA CUANDO ES 2EJEC+2MUBA BORRAMOS EJEC
                        AND SZTALIA_SEQ=1  --secuencia de alianza ejec.
                );
             Commit;
        End;

        Procedure delete_ali_2ejec(p_regla number, p_ejec varchar2, p_ali varchar2) is
        Begin
                DELETE FROM SZTPRONO
                WHERE (SZTPRONO_NO_REGLA, SZTPRONO_PIDM, SZTPRONO_SECUENCIA) IN (
                    Select  Distinct
                            sztalgo_no_regla regla,
                            p.sztprono_pidm pidm,
                            p.sztprono_secuencia
                        from sztalgo
                        join sztprono p on p.sztprono_no_regla=sztalgo_no_regla
                                    and p.sztprono_term_code=sztalgo_term_code_new
                        join (
                            Select goradid_pidm pidm,
                            Count(GORADID_ADID_CODE) tot
                            from goradid
                            where GORADID_ADID_CODE   in
                                    (Select Distinct sztalia_code
                                        from sztalia)
                            having Count(1) >1
                            group by goradid_pidm
                        ) pob on pob.pidm = p.sztprono_pidm
                        join sztalmt on sztalmt_materia = p.sztprono_materia_legal
                                    and sztalmt_nivel = Case When sztalgo_levl_code='MS' Then 'MA' else sztalgo_levl_code end
                        join sztalia on sztalia_code = sztalmt_alianza
                                    and sztalia_lvel = sztalmt_nivel
                        join (
                        Select sztprono_pidm pidm,  count(Distinct SZTALMT_ALIANZA) tot
                                    FROM sztprono
                                    join sztalmt on sztalmt_materia = sztprono_materia_legal
                                    join sztalia on sztalia_code= sztalmt_alianza
                                                    and sztalia_lvel = sztalmt_nivel
                                    where sztprono_no_regla=p_regla
                                    and sztalia_seq is not null
                          Group By sztprono_pidm
                        ) ali on ali.pidm=p.sztprono_pidm
                        join ( --1ER COMBINACION
                                Select  sztprono_pidm pidm, sztalia_code alianza,
                                        count(Distinct sztprono_materia_legal) tot
                                from sztalgo
                                join sztprono p on p.sztprono_no_regla=sztalgo_no_regla
                                            and p.sztprono_term_code=sztalgo_term_code_new
                                join sztalmt on sztalmt_materia = sztprono_materia_legal
                                            and sztalmt_nivel = Case When sztalgo_levl_code='MS' Then 'MA' else sztalgo_levl_code end
                                join sztalia on sztalia_code = sztalmt_alianza
                                            and sztalia_lvel = sztalmt_nivel
                                where sztprono_no_regla=p_regla
                                and sztalia_code=p_ejec
                                group by  sztprono_pidm,sztalia_code
                        ) ejec on ejec.pidm = p.sztprono_pidm
                                and ejec.tot=2
                        join ( --2DA COMBINACION
                                Select  sztprono_pidm pidm, sztalia_code alianza,
                                        count(Distinct sztprono_materia_legal) tot
                                from sztalgo
                                join sztprono p on p.sztprono_no_regla=sztalgo_no_regla
                                            and p.sztprono_term_code=sztalgo_term_code_new
                                join sztalmt on sztalmt_materia = sztprono_materia_legal
                                            and sztalmt_nivel = Case When sztalgo_levl_code='MS' Then 'MA' else sztalgo_levl_code end
                                join sztalia on sztalia_code = sztalmt_alianza
                                            and sztalia_lvel = sztalmt_nivel
                                where sztprono_no_regla=p_regla
                                and sztalia_code=p_ali
                                group by  sztprono_pidm,sztalia_code
                        ) muba on muba.pidm = p.sztprono_pidm
                                and muba.tot=1
                        --WHERE-
                        where p.sztprono_no_regla=p_regla
                        --PARA CUANDO ES 2EJEC+1ALIANZA borramos la alianza por excepcion
                        AND sztalia_code=muba.alianza
                );
             Commit;
        End;

        Procedure delete_1ejec_2ali(p_regla number, p_ejec varchar2) is
        Begin
                DELETE FROM SZTPRONO
                WHERE (SZTPRONO_NO_REGLA, SZTPRONO_PIDM, SZTPRONO_SECUENCIA) IN (
                    Select  Distinct
                            sztalgo_no_regla regla,
                            p.sztprono_pidm pidm,
                            MAx(p.sztprono_secuencia) sec
                        from sztalgo
                        join sztprono p on p.sztprono_no_regla=sztalgo_no_regla
                                    and p.sztprono_term_code=sztalgo_term_code_new
                        join (
                            Select goradid_pidm pidm,
                            Count(GORADID_ADID_CODE) tot
                            from goradid
                            where GORADID_ADID_CODE   in
                                    (Select Distinct sztalia_code
                                        from sztalia)
                            having Count(1) >1
                            group by goradid_pidm
                        ) pob on pob.pidm = p.sztprono_pidm
                        join sztalmt on sztalmt_materia = p.sztprono_materia_legal
                                    and sztalmt_nivel = Case When sztalgo_levl_code='MS' Then 'MA' else sztalgo_levl_code end
                        join sztalia on sztalia_code = sztalmt_alianza
                                    and sztalia_lvel = sztalmt_nivel
                        join (
                        Select sztprono_pidm pidm,  count(Distinct SZTALMT_ALIANZA) tot
                                    FROM sztprono
                                    join sztalmt on sztalmt_materia = sztprono_materia_legal
                                    join sztalia on sztalia_code= sztalmt_alianza
                                                    and sztalia_lvel = sztalmt_nivel
                                    where sztprono_no_regla=p_regla
                                    and sztalia_seq is not null
                          Group By sztprono_pidm
                        ) ali on ali.pidm=p.sztprono_pidm
                        join ( --1ER COMBINACION
                                Select  sztprono_pidm pidm, sztalia_code alianza,
                                        count(Distinct sztprono_materia_legal) tot
                                from sztalgo
                                join sztprono p on p.sztprono_no_regla=sztalgo_no_regla
                                            and p.sztprono_term_code=sztalgo_term_code_new
                                join sztalmt on sztalmt_materia = sztprono_materia_legal
                                            and sztalmt_nivel = Case When sztalgo_levl_code='MS' Then 'MA' else sztalgo_levl_code end
                                join sztalia on sztalia_code = sztalmt_alianza
                                            and sztalia_lvel = sztalmt_nivel
                                where sztprono_no_regla=p_regla
                                and sztalia_code=p_ejec
                                group by  sztprono_pidm,sztalia_code
                        ) ejec on ejec.pidm = p.sztprono_pidm
                                and ejec.tot=2
                        join ( --2DA COMBINACION
                                Select  sztprono_pidm pidm, sztalia_code alianza,
                                        count(Distinct sztprono_materia_legal) tot
                                from sztalgo
                                join sztprono p on p.sztprono_no_regla=sztalgo_no_regla
                                            and p.sztprono_term_code=sztalgo_term_code_new
                                join sztalmt on sztalmt_materia = sztprono_materia_legal
                                            and sztalmt_nivel = Case When sztalgo_levl_code='MS' Then 'MA' else sztalgo_levl_code end
                                join sztalia on sztalia_code = sztalmt_alianza
                                            and sztalia_lvel = sztalmt_nivel
                                where sztprono_no_regla=p_regla
--                                and sztalia_code=p_ali
                                and nvl(sztalia_seq,0)>2 --cualquier
                                group by  sztprono_pidm,sztalia_code
                        ) muba on muba.pidm = p.sztprono_pidm
                                and muba.tot=1
                        --WHERE-
                        where p.sztprono_no_regla=p_regla
                        and ali.tot=2
                        and sztalia_seq is not null
                        --PARA CUANDO ES 2EJEC+1UNIFEC BORRAMOS 1 EJEC
                        AND SZTALIA_SEQ=1
                    group by sztalgo_no_regla ,
                                p.sztprono_pidm ,
                                sztalia_code,
                                sztalia_seq
                );

             Commit;
        End;

        Procedure delete_ali_b0(p_regla number, p_ptrm varchar2) is
        Begin
                Delete from sztprono
                Where (sztprono_no_regla,sztprono_pidm, sztprono_secuencia) in (
                 Select  Distinct sztprono_no_regla, sztprono_pidm, sztprono_secuencia
                    from sztalgo
                    join sztprono p on p.sztprono_no_regla=sztalgo_no_regla
                                and p.sztprono_term_code=sztalgo_term_code_new
                    join sztalmt on sztalmt_materia = sztprono_materia_legal
                                and sztalmt_nivel = Case When sztalgo_levl_code='MS' Then 'MA' else sztalgo_levl_code end
                    join sztalia on sztalia_code = sztalmt_alianza
                                and sztalia_lvel = sztalmt_nivel
                    where sztprono_no_regla=p_regla
                    and sztalia_code In ('CIFA','UNIC','MUBA')
                    and SZTPRONO_PTRM_CODE_NW = p_ptrm
                );
                Commit;
        End;

        procedure delete_alianzas_posterior(p_regla number) is
        begin
                Delete from sztprono
                Where (sztprono_pidm, sztprono_no_regla,sztprono_secuencia) IN
                (
                    Select pr.sztprono_pidm, pr.sztprono_no_regla,
                    pr.sztprono_secuencia--, max.talia
                    From (
                        Select pidm, Min(seq_talia) talia, Max(seq_prono) prono
                        from (
                        select sztalian_pidm pidm, sztalian_alianza,
                                sztalia_seq seq_talia, p.seq seq_prono
                        from  sztalian
                        join sztalia on sztalia_code=sztalian_alianza
                                and sztalia_lvel in (Select Distinct Case When sztalgo_levl_code='MS' Then 'MA' else sztalgo_levl_code end
                                            from sztalgo where sztalgo_no_regla=p_regla)
                                and SZTALIA_NUM_MATERIAS > 0  --Solo Alianzas con materias
                        left join (
                            Select sztprono_pidm pidm, sztalmt_alianza alianza,
                            sztalia_seq seq, sztprono_secuencia
                            from sztprono
                            join sztalmt on sztalmt_nivel in (Select Distinct Case When sztalgo_levl_code='MS' Then 'MA' else sztalgo_levl_code end
                                            from sztalgo where sztalgo_no_regla=p_regla)
                                and sztalmt_materia = sztprono_materia_legal
                            join sztalia on sztalia_code = sztalmt_alianza
                                    and sztalia_lvel=sztalmt_nivel
                                    and SZTALIA_NUM_MATERIAS > 0  --Solo Alianzas con materias
                            where sztprono_no_regla=p_regla
                            and nvl(sztalia_seq,0) > 2
                            order by pidm, sztalia_seq
                            ) p on p.pidm   = sztalian_pidm and
                               p.alianza= sztalian_alianza and
                               p.seq    = sztalia_seq
                        where nvl(sztalia_seq,0) > 2
                        and sztalian_no_regla=p_regla
                        and (Select Count(GORADID_ADID_CODE)
                                        from goradid
                                        where Goradid_pidm = sztalian_pidm
                                          and GORADID_ADID_CODE   in
                                                (Select Distinct sztalia_code
                                                    from sztalia
                                                    where nvl(sztalia_seq,0)>2)
                            )>1
                        Order by pidm, sztalia_seq
                        )
                        Group by pidm
                        having Min(seq_talia) < Max(seq_prono)
                    ) max
                    join (
                            Select sztprono_no_regla, sztprono_id,
                            sztprono_pidm, sztalmt_alianza,
                            sztalia_seq, sztprono_secuencia
                            from sztprono
                            join sztalmt on sztalmt_nivel in (Select Distinct Case When sztalgo_levl_code='MS' Then 'MA' else sztalgo_levl_code end
                                            from sztalgo where sztalgo_no_regla=p_regla)
                                and sztalmt_materia = sztprono_materia_legal
                            join sztalia on sztalia_code = sztalmt_alianza
                                    and sztalia_lvel=sztalmt_nivel
                                    and SZTALIA_NUM_MATERIAS > 0  --Solo Alianzas con materias
                            where sztprono_no_regla=p_regla
                            and nvl(sztalia_seq,0) > 2
                    ) pr on pr.sztprono_pidm = max.pidm and
                            pr.sztalia_seq = max.prono
                );  commit;

        end;

		procedure delete_ali_prtm(p_regla varchar2) is
		begin
			 DELETE FROM SZTPRONO
				WHERE (SZTPRONO_NO_REGLA, SZTPRONO_PIDM, SZTPRONO_SECUENCIA)
							IN (
								Select  Distinct
										Z.SZTPRONO_NO_REGLA,
										Z.sztprono_pidm ,
										Z.sztprono_secuencia
									from sztprono z
									join sztalmt on sztalmt_materia = Z.sztprono_materia_legal
                                    join sztalia on sztalia_code = sztalmt_alianza
                                        and sztalia_lvel=sztalmt_nivel
                                        and SZTALIA_NUM_MATERIAS > 0  --Solo Alianzas con materias
--									where sztprono_id='010394241'
									WHERE sztprono_ptrm_code IN ('M0A','M0B','M0C','M1A','A1A')
									and Z.sztprono_cuatri = 'Q1'
									and sztalmt_alianza not in ('EJEC') --excepto ejecutiva, ya que estas van siempre.
									and Z.sztprono_ptrm_code_nw IN ('B0','B1','B2')
									and Z.sztprono_no_regla=p_regla
									and Not Exists(SElect 1 from sztprono x
												where x.sztprono_pidm = z.sztprono_pidm
												and x.sztprono_no_regla < z.sztprono_no_regla
												and x.sztprono_ptrm_code_nw not IN ('B0')
												)
									and nvl(sztalia_seq,0) > 2
									);
			Commit;
		end;

        --FRank@Create@Jul22 Borra la alianza max sec de p_ali contando p_c_ali, y cumpliendo con la primera
        --combinacion p_ejec y total p_c_ejec.
		procedure delete_ali(p_regla varchar2,
                             p_ejec varchar2,
                             p_c_ejec number,
                             p_ali varchar2,
                             p_c_ali number) is
		begin
			DELETE FROM SZTPRONO
            WHERE (SZTPRONO_NO_REGLA, SZTPRONO_PIDM, SZTPRONO_SECUENCIA) IN (
                Select  Distinct
                            sztalgo_no_regla regla,
                            p.sztprono_pidm pidm,
                            max(p.sztprono_secuencia)
                        from sztalgo
                        join sztprono p on p.sztprono_no_regla=sztalgo_no_regla
                                    and p.sztprono_term_code=sztalgo_term_code_new
                        join (
                            Select goradid_pidm pidm,
                            Count(GORADID_ADID_CODE) tot
                            from goradid
                            where GORADID_ADID_CODE   in
                                    (Select Distinct sztalia_code
                                        from sztalia)
                            having Count(1) >1
                            group by goradid_pidm
                        ) pob on pob.pidm = p.sztprono_pidm
                        join sztalmt on sztalmt_materia = p.sztprono_materia_legal
                                    and sztalmt_nivel = Case When sztalgo_levl_code='MS' Then 'MA' else sztalgo_levl_code end
                        join sztalia on sztalia_code = sztalmt_alianza
                                    and sztalia_lvel = sztalmt_nivel
                        join (
                        Select sztprono_pidm pidm,  count(Distinct SZTALMT_ALIANZA) tot
                                    FROM sztprono
                                    join sztalmt on sztalmt_materia = sztprono_materia_legal
                                    join sztalia on sztalia_code= sztalmt_alianza
                                                    and sztalia_lvel = sztalmt_nivel
                                    where sztprono_no_regla=p_regla
                                    and sztalia_seq is not null
                          Group By sztprono_pidm
                        ) ali on ali.pidm=p.sztprono_pidm
                        join ( --1ER COMBINACION
                                Select  sztprono_pidm pidm, sztalia_code alianza,
                                        count(Distinct sztprono_materia_legal) tot
                                from sztalgo
                                join sztprono p on p.sztprono_no_regla=sztalgo_no_regla
                                            and p.sztprono_term_code=sztalgo_term_code_new
                                join sztalmt on sztalmt_materia = sztprono_materia_legal
                                            and sztalmt_nivel = Case When sztalgo_levl_code='MS' Then 'MA' else sztalgo_levl_code end
                                join sztalia on sztalia_code = sztalmt_alianza
                                            and sztalia_lvel = sztalmt_nivel
                                where sztprono_no_regla=p_regla
                                and sztalia_code=p_ejec
                                group by  sztprono_pidm,sztalia_code
                        ) ejec on ejec.pidm = p.sztprono_pidm
                                and ejec.tot=p_c_ejec
                        join ( --2DA COMBINACION
                                Select  sztprono_pidm pidm, sztalia_code alianza,
                                        count(Distinct sztprono_materia_legal) tot
                                from sztalgo
                                join sztprono p on p.sztprono_no_regla=sztalgo_no_regla
                                            and p.sztprono_term_code=sztalgo_term_code_new
                                join sztalmt on sztalmt_materia = sztprono_materia_legal
                                            and sztalmt_nivel = Case When sztalgo_levl_code='MS' Then 'MA' else sztalgo_levl_code end
                                join sztalia on sztalia_code = sztalmt_alianza
                                            and sztalia_lvel = sztalmt_nivel
                                where sztprono_no_regla=p_regla
                                and sztalia_code=p_ali
                                group by  sztprono_pidm,sztalia_code
                        ) muba on muba.pidm = p.sztprono_pidm
                                and muba.tot=p_c_ali
                        --WHERE-
                        where p.sztprono_no_regla=p_regla
                        AND sztalia_code=p_ali
            group by  sztalgo_no_regla ,  p.sztprono_pidm);
			Commit;
		end;

    BEGIN
        --Quitamos alianzas especificas que no deben ir en b0
        delete_ali_b0(p_regla,'B0');

        delete_profun(p_regla,6);
        delete_profun(p_regla,5);
        delete_profun(p_regla,4);
        delete_profun(p_regla,3);
        delete_profun(p_regla,2);
        --Borra alianzas que estén despues de otras alianzas
        --esto se da por motivos que hay ocasiones que las materias no se habren
        --y el prono sigue asignando
        delete_alianzas_posterior(p_regla);

        --Borra 2Ejecutivas cuando tiene 2alianzas en este caso MUBA
--        delete_2ejec_2ali(p_regla,'EJEC','MUBA');

	   --Borra UBA y UNIFEC por exception
		delete_ali_2ejec(p_regla,'EJEC','MUBA');
		delete_ali_2ejec(p_regla,'EJEC','UNIC');

        --Borra 1Ejecutivas cuando tiene 2 Ejec + 2alianzas en este caso UNIC
--        delete_1ejec_2ali(p_regla,'EJEC','UNIC');
        delete_1ejec_2ali(p_regla,'EJEC');

		--delete alianzas en primer parte de periodo q1
		delete_ali_prtm(p_regla);

		--Borramos 1 alianza UNICEF cuando tenga 2 ejecutivas + 2 unicef
--		delete_ali(p_regla,'EJEC',2,'UNIC',2);
		--Borramos 1 alianza EJEC cuando tenga 2 UNIFEC + 2 EJECUTIVAS
		delete_ali(p_regla,'UNIC',2,'EJEC',2);
		--Borramos 1 alianza EJEC cuando tenga 2 UNIFEC + 1 EJECUTIVA
		delete_ali(p_regla,'UNIC',2,'EJEC',1);
		delete_ali(p_regla,'MUBA',2,'EJEC',2);

    END;

    --Jpg@Create@Feb22 Proceso de prioridades de alianzas
    --Proceso provisional para darle eliminar alianzas pronosticadas de más
    PROCEDURE p_prioridad_pidm(p_regla number, p_pidm number) IS

        --FRank@Create@Jul22 Borra la alianza max sec de p_ali contando p_c_ali, y cumpliendo con la primera
        --combinacion p_ejec y total p_c_ejec.
		procedure delete_ali(p_regla varchar2,
                             p_ejec varchar2,
                             p_c_ejec number,
                             p_ali varchar2,
                             p_c_ali number  --Cuando es 0 se borra toda la alianza
                            ) is
		begin
			DELETE FROM SZTPRONO
            WHERE (SZTPRONO_NO_REGLA, SZTPRONO_PIDM, SZTPRONO_SECUENCIA) IN (
                Select  Distinct
                            sztalgo_no_regla regla,
                            p.sztprono_pidm pidm,
                            max(p.sztprono_secuencia)
                        from sztalgo
                        join sztprono p on p.sztprono_no_regla=sztalgo_no_regla
                                    and p.sztprono_term_code=sztalgo_term_code_new
                        join (
                            Select goradid_pidm pidm,
                            Count(GORADID_ADID_CODE) tot
                            from goradid
                            where GORADID_ADID_CODE   in
                                    (Select Distinct sztalia_code
                                        from sztalia)
                            having Count(1) >1
                            group by goradid_pidm
                        ) pob on pob.pidm = p.sztprono_pidm
                        join sztalmt on sztalmt_materia = p.sztprono_materia_legal
                                    and sztalmt_nivel = Case When sztalgo_levl_code='MS' Then 'MA' else sztalgo_levl_code end
                        join sztalia on sztalia_code = sztalmt_alianza
                                    and sztalia_lvel = sztalmt_nivel
                        join (
                        Select sztprono_pidm pidm,  count(Distinct SZTALMT_ALIANZA) tot
                                    FROM sztprono
                                    join sztalmt on sztalmt_materia = sztprono_materia_legal
                                    join sztalia on sztalia_code= sztalmt_alianza
                                                    and sztalia_lvel = sztalmt_nivel
                                    where sztprono_no_regla=p_regla
                                    and sztalia_seq is not null
                          Group By sztprono_pidm
                        ) ali on ali.pidm=p.sztprono_pidm
                        join ( --1ER COMBINACION
                                Select  sztprono_pidm pidm, sztalia_code alianza,
                                        count(Distinct sztprono_materia_legal) tot
                                from sztalgo
                                join sztprono p on p.sztprono_no_regla=sztalgo_no_regla
                                            and p.sztprono_term_code=sztalgo_term_code_new
                                join sztalmt on sztalmt_materia = sztprono_materia_legal
                                            and sztalmt_nivel = Case When sztalgo_levl_code='MS' Then 'MA' else sztalgo_levl_code end
                                join sztalia on sztalia_code = sztalmt_alianza
                                            and sztalia_lvel = sztalmt_nivel
                                where sztprono_no_regla=p_regla
                                and sztalia_code=p_ejec
                                group by  sztprono_pidm,sztalia_code
                        ) ejec on ejec.pidm = p.sztprono_pidm
                                and ejec.tot=p_c_ejec
                        join ( --2DA COMBINACION
                                Select  sztprono_pidm pidm, sztalia_code alianza,
                                        count(Distinct sztprono_materia_legal) tot
                                from sztalgo
                                join sztprono p on p.sztprono_no_regla=sztalgo_no_regla
                                            and p.sztprono_term_code=sztalgo_term_code_new
                                join sztalmt on sztalmt_materia = sztprono_materia_legal
                                            and sztalmt_nivel = Case When sztalgo_levl_code='MS' Then 'MA' else sztalgo_levl_code end
                                join sztalia on sztalia_code = sztalmt_alianza
                                            and sztalia_lvel = sztalmt_nivel
                                where sztprono_no_regla=p_regla
                                and sztalia_code=p_ali
                                group by  sztprono_pidm,sztalia_code
                        ) muba on muba.pidm = p.sztprono_pidm
                                and muba.tot=p_c_ali
                        --WHERE-
                        where p.sztprono_no_regla=p_regla
                        AND sztalia_code=p_ali
                        and p.sztprono_pidm = p_pidm
            group by  sztalgo_no_regla ,  p.sztprono_pidm);
			Commit;
		end;

    BEGIN
		delete_ali(p_regla,'UNIC',2,'EJEC',2);
		delete_ali(p_regla,'UNIC',2,'EJEC',1);
		delete_ali(p_regla,'MUBA',2,'EJEC',2);

    END;

    --Function obtiene parte del periodo primero del alumno
    --es copia fiel de PKG_REPORTES_PIPELINED.F_ASIGNACION_MATERIAS
    --Pero mejora el rendimiento ya que se obtiene por ID -optimización-
    FUNCTION get_prtm_pi(p_regla number, p_id varchar2) RETURN varchar2 is
        l_ptrm  varchar2(10);
    Begin
        For x in (
                SELECT
                CASE WHEN ptrm_pi ='A4B' THEN 'A0B'
                            WHEN ptrm_pi ='M4B' THEN 'M0B'
                            WHEN ptrm_pi ='A4D' THEN 'A1A'
                            WHEN ptrm_pi ='M4D' THEN 'M1A'
                            WHEN ptrm_pi ='A3C' THEN 'A0C'
                            WHEN ptrm_pi ='M3C' THEN 'M0C'
                            WHEN ptrm_pi ='A3A' THEN 'A0A'
                            WHEN ptrm_pi ='M3A' THEN 'M0A'
                            WHEN ptrm_pi ='A3B' THEN 'A0B'
                            WHEN ptrm_pi ='M3B' THEN 'M0B'
                            WHEN ptrm_pi ='A3D' THEN 'A1A'
                            WHEN ptrm_pi ='M3D' THEN 'M1A'
                       ELSE
                             ptrm_pi
                       END ptrm_pi
                FROM
                (select Distinct
                       NVL((
                        SELECT distinct min(SFRSTCR_PTRM_CODE) ptrm_pi
                        FROM SFRSTCR a
                        WHERE 1 = 1
                        AND a.sfrstcr_pidm = sztprono_pidm
                        AND a.sfrstcr_stsp_key_sequence =sztprono_study_path
                        AND SUBSTR(A.sfrstcr_term_code,5,1)NOT IN(8,9)
                        AND a.sfrstcr_rsts_code ='RE'
                        AND sfrstcr_term_code =(select min(b.sfrstcr_term_code)
                                                from sfrstcr b
                                                where a.sfrstcr_pidm = b.sfrstcr_pidm
                                                and a.sfrstcr_stsp_key_sequence =b.sfrstcr_stsp_key_sequence
                                                and a.sfrstcr_rsts_code = b.sfrstcr_rsts_code
                                                AND SUBSTR(b.sfrstcr_term_code,5,1)NOT IN(8,9)
                                                AND b.SFRSTCR_DATA_ORIGIN NOT IN ('CONVALIDACION') --Jpg@ModJun23 quitamos convalidaciones en el
                                                )
                         AND a.sfrstcr_ptrm_code = (SELECT min (d1.sfrstcr_ptrm_code)
                                                    FROM sfrstcr D1
                                                    WHERE a.sfrstcr_pidm = d1.sfrstcr_pidm
                                                    AND a.sfrstcr_term_code = d1.sfrstcr_term_code
                                                    AND a.sfrstcr_rsts_code = d1.sfrstcr_rsts_code
                                                    AND SUBSTR(d1.sfrstcr_term_code,5,1)NOT IN(8,9)
                                                    AND d1.SFRSTCR_DATA_ORIGIN NOT IN ('CONVALIDACION') --Jpg@ModJun23 quitamos convalidaciones en el
                                                   )
                                             ),SZTPRONO_PTRM_CODE)ptrm_pi,
                SZTPRONO_TIPO_INICIO tipo_ini
                from sztprono
                where 1 = 1
                and sztprono_id         = p_id
                and sztprono_no_regla   = p_regla
                )a
        )
        Loop
            l_ptrm:=x.ptrm_pi;
dbms_output.put_line('ptrm ini:'||l_ptrm );
        End Loop;

        Return l_ptrm;
    End;

    --Jpg@Create@Ene22
    --Function obtiene max materia asignada para una alianza y retorna la secuencia
    --TipoGiroCarrusel 0-Se detiene Carrusel 1-Vuelve a dar vuelta
    FUNCTION get_max_materia(p_regla number, p_alianza varchar2, p_tipo number ) RETURN number is
        l_materia varchar2(10):=null;
        l_secuencia number:=0;
        l_max       number;
    Begin

--    dbms_output.put_line('get_max_materia regla:'||p_regla||' alianza:'||p_alianza);
        for m in (
                    SELECT Distinct
                            sztprono_cuatri QA,
                            sztprono_ptrm_code_nw avance,
                            SZSTUME_SUBJ_CODE materia
                      FROM sztalian a
                      join sztprono on
                                sztprono_no_regla = sztalian_no_regla
                            and sztprono_pidm = sztalian_pidm
                      join szstume on
                             szstume_pidm = sztalian_pidm
--                      join sztalgo on sztalgo_no_regla=sztprono_no_regla
--                                and sztprono_term_code=sztalgo_term_code_new
                      WHERE a.sztalian_no_regla = p_regla
                      AND a.SZTALIAN_FLEX ='PR'
                      and a.SZTALIAN_ALIANZA = P_ALIANZA
                      and SZSTUME_START_DATE IN (Select Distinct  SZTALGO_FECHA_ANT
                            from sztalgo where sztalgo_no_Regla= sztprono_no_regla)
                      and SZSTUME_SUBJ_CODE IN ( Select Distinct Sztalmt_Materia
                                                From Sztalmt
                                                  join sztalgo on sztalgo_no_regla=a.sztalian_no_regla
                                                    and Case When sztalgo_levl_code='MS' Then 'MA' else sztalgo_levl_code end = sztalmt_nivel
                                                Where Sztalmt_Alianza=A.Sztalian_Alianza
                                                )
                    Order by  materia
                )
        Loop
                l_materia:=m.materia;
--                dbms_output.put_line('get_max_materia avance:'||m.avance||' QA:'||m.qa||' materia:'||l_materia);
        End loop;
        if l_materia is not null then
            Begin
                Select sztalmt_secuencia
                   into l_secuencia
                from sztalmt
                where sztalmt_materia = l_materia;
            exception when others then
                l_secuencia:=1;
            end;

            Begin
                Select mAX(sztalmt_secuencia)
                   into l_max
                from sztalmt
                where Sztalmt_Alianza = P_ALIANZA;
            exception when others then
                l_max:=1;
            end;

--dbms_output.put_line('l_secuencia:'||l_secuencia||' l_max:'||l_max);

            if p_tipo = 1 Then
                if l_max=l_secuencia then l_secuencia:=0; end if;
            end if;

--            if l_secuencia=1  Then l_secuencia:=0; end if;

                dbms_output.put_line('get_max_materia secuencia:'||l_secuencia||' max_sec:'||l_max);
        else
                dbms_output.put_line('get_max_materia no se encontro materia maxima');
        end if;

        Return l_secuencia;
    End;

     PROCEDURE p_iebs_pidm(p_regla   NUMBER,
                          p_pidm    NUMBER)
     is
        l_avance_mayor    number;
        l_avance          number;
        l_pidm_mayor      number;
        l_materia_alianza varchar2(10):=NULL;
        l_cuenta_nivel_li     number;
        l_cuenta_nivel_ma     number;
        l_cuenta_nivel_do     number;
        l_nivel           varchar2(2);
        l_secuencia       number;
        l_contador        number:=0;
        l_contar_alumnos  number;
        l_materias_para   number;
        l_materias_alianza number;
        l_cuenta_materias number;
        l_si_unicef       number;
        l_peirod_uni      varchar2(2);
        l_ptrm_pi         varchar2(3);
        l_cuenta_qali     number;
        l_chk_ind           number:=1;
    begin

p_no_carrusel_pidm(p_regla,'IEBS',p_pidm);

if l_chk_ind = 0 Then        begin

            select count(*)
            into l_cuenta_nivel_li
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_ma
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_do
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma > 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  if;

        delete sztalian
        where 1 = 1
        and sztalian_no_regla = p_regla
        and sztalian_pidm = p_pidm
        and SZTALIAN_ALIANZA ='IEBS'
        AND sztalian_FLEX ='PR';

        for c in ( select distinct (select  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                    from SMRPRLE
                    where 1 = 1
                    and SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                    SZTPRONO_PROGRAM programa,
                    sztprono_pidm pidm,
                    sztprono_id matricula,
                     SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                    'IEBS' alianza,
                    SZTPRONO_TIPO_INICIO tipo_inicio,
                    sztprono_no_regla regla
            from sztprono
            where 1 = 1
            and sztprono_no_regla = p_regla
            and sztprono_pidm = p_pidm
            AND EXISTS (SELECT NULL
                        FROM GORADID
                        WHERE 1 = 1
                        AND GORADID_PIDM = SZTPRONO_PIDM
                        AND  GORADID_ADID_CODE ='IEBS')
            )loop


                begin

                  SELECT MAX(zstpara_param_id)
                  INTO l_avance
                  FROM ZSTPARA
                  WHERE 1 = 1
                  and zstpara_mapa_id ='INSCRIPCIONES'
                  and zstpara_param_valor = c.avance
                  and zstpara_param_desc = c.tipo_inicio;

                exception when others then
                    null;
                end;


                BEGIN

                 --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                  INSERT INTO sztalian VALUES (c.pidm,
                                               c.matricula,
                                               c.programa,
                                               c.alianza,
                                               l_avance,
                                               c.regla,
                                               'N',
                                               nvl(l_materias_para,0),
                                               nvl(l_materias_alianza,0),
                                               c.tipo_inicio,
                                               'PR'
                                               );

                EXCEPTION WHEN OTHERS THEN
                 NULL;
                END;

                COMMIT;


            end loop;

             FOR c IN (SELECT *
                       FROM sztalian
                       where 1 = 1
                       AND sztalian_flex ='PR'
                       AND sztalian_no_regla = p_regla
                       AND sztalian_pidm = p_pidm
                       and SZTALIAN_ALIANZA ='IEBS'
                       )loop



                         for d in
                                 (
                                     select distinct SZTPRONO_MATERIA_LEGAL materia,
                                                     sztprono_no_regla regla
                                     from SZTPRONO a
                                     join SZTALMT b on a.SZTPRONO_MATERIA_LEGAL = b.SZTALMT_MATERIA
                                                     AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                     where 1 = 1
                                     and sztprono_no_regla = c.SZTALIAN_NO_REGLA
                                     and sztprono_materia_legal like 'IEBS%'
                                     and exists(select null
                                                from goradid
                                                where 1 = 1
                                                and goradid_pidm=SZTPRONO_PIDM
                                                and GORADID_ADID_CODE ='IEBS' )
                                     union
                                      select distinct SZTGPME_SUBJ_CRSE materia,
                                                        SZTGPME_no_regla regla
                                                 from sztgpme a
                                                 join SZTALMT b on a.SZTGPME_SUBJ_CRSE = b.SZTALMT_MATERIA
                                                 --                AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                                 where 1 = 1
                                                 and SZTGPME_no_regla = p_regla
                                                 and SZTGPME_SUBJ_CRSE like 'IEBS%'
                                     order by 1
                                     )loop

                                             l_contador:=0;

                                             for x in (select *
                                                       from sztprono
                                                       where 1 = 1
                                                       and sztprono_no_regla = c.sztalian_no_regla
                                                       and sztprono_pidm = c.sztalian_pidm
                                                       )loop

                                                         l_contador:=l_contador+1;

                                                           begin

                                                             SELECT nvl(max(sztprono_secuencia),0)+1
                                                             INTO l_secuencia
                                                             FROM sztprono
                                                             where 1 = 1
                                                             and sztprono_no_regla = c.sztalian_no_regla
                                                             and sztprono_pidm = c.SZTALIAN_PIDM;

                                                           exception when others then
                                                               null;
                                                           end;

                                                           begin

                                                               insert into sztprono values(x.SZTPRONO_PIDM,
                                                                                           x.SZTPRONO_ID,
                                                                                           x.SZTPRONO_TERM_CODE,
                                                                                           x.SZTPRONO_PROGRAM,
                                                                                           d.materia,
                                                                                           l_secuencia,
                                                                                           x.SZTPRONO_PTRM_CODE,
                                                                                           d.materia,
                                                                                           'x',
                                                                                           x.SZTPRONO_FECHA_INICIO,
                                                                                           x.SZTPRONO_PTRM_CODE_NW,
                                                                                           x.SZTPRONO_FECHA_INICIO_NW,
                                                                                           x.SZTPRONO_AVANCE,
                                                                                           x.SZTPRONO_NO_REGLA,
                                                                                           x.SZTPRONO_USUARIO,
                                                                                           x.SZTPRONO_STUDY_PATH,
                                                                                           x.SZTPRONO_RATE,
                                                                                           x.SZTPRONO_JORNADA,
                                                                                           x.SZTPRONO_ACTIVITY_DATE,
                                                                                           x.SZTPRONO_CUATRI,
                                                                                           x.SZTPRONO_TIPO_INICIO,
                                                                                           x.SZTPRONO_JORNADA_DOS,
                                                                                           'N',
                                                                                           'N',
                                                                                           x.SZTPRONO_ESTATUS,
                                                                                           'N',
                                                                                           null,
                                                                                           x.SZTPRONO_GRUPO_ASIG
                                                                                           );

                                                           exception when others then
                    --                                           raise_application_error (-20002,' tres Materia '||d.materia||' -->'||sqlerrm);
                                                               dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                           end;

                                                           begin
                                                               UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                               where 1 = 1
                                                               and sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                               and sztalian_pidm = x.SZTPRONO_PIDM
                                                               and SZTALIAN_ALIANZA ='IEBS';
                                                           exception when others then
                                                               null;
                                                           end;


                                                           exit when l_contador = 1;

                                                       end loop;


                                     end loop;

                       end loop;
        commit;
end if;
    end;

--
--
    PROCEDURE p_unic_pidm(p_regla   NUMBER,
                          p_pidm    NUMBER)
     is
        l_avance_mayor    number;
        l_avance          number;
        l_pidm_mayor      number;
        l_materia_alianza varchar2(10):=NULL;
        l_cuenta_nivel_li     number;
        l_cuenta_nivel_ma     number;
        l_cuenta_nivel_do     number;
        l_nivel           varchar2(2);
        l_secuencia       number;
        l_contador        number:=0;
        l_contar_alumnos  number;
        l_materias_para   number;
        l_materias_alianza number;
        l_cuenta_materias number;
        l_si_unicef       number;
        l_peirod_uni      varchar2(2);
        l_ptrm_pi         varchar2(3);
        l_cuenta_qali     number;
        l_chk_ind           number:=1;
    begin

p_carrusel_pidm(p_regla,'UNIC',p_pidm);

if l_chk_ind = 0 Then        begin

            select count(*)
            into l_cuenta_nivel_li
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_ma
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_do
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma > 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  if;

        delete sztalian
        where 1 = 1
        and sztalian_no_regla = p_regla
        and sztalian_pidm = p_pidm
        and SZTALIAN_ALIANZA ='UNIC'
        AND sztalian_FLEX ='PR';

        for c in ( select distinct (select  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            from SMRPRLE
                            where 1 = 1
                            and SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'UNIC' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
            from sztprono
            where 1 = 1
            and sztprono_no_regla = p_regla
            and sztprono_pidm = p_pidm
            AND EXISTS (SELECT NULL
                        FROM GORADID
                        WHERE 1 = 1
                        AND GORADID_PIDM = SZTPRONO_PIDM
                        AND  GORADID_ADID_CODE ='UNIC')
            )loop


                begin

                  SELECT MAX(zstpara_param_id)
                  INTO l_avance
                  FROM ZSTPARA
                  WHERE 1 = 1
                  and zstpara_mapa_id ='INSCRIPCIONES'
                  and zstpara_param_valor = c.avance
                  and zstpara_param_desc = c.tipo_inicio;

                exception when others then
                    null;
                end;


                BEGIN

                 --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                  INSERT INTO sztalian VALUES (c.pidm,
                                               c.matricula,
                                               c.programa,
                                               c.alianza,
                                               l_avance,
                                               c.regla,
                                               'N',
                                               nvl(l_materias_para,0),
                                               nvl(l_materias_alianza,0),
                                               c.tipo_inicio,
                                               'PR'
                                               );

                EXCEPTION WHEN OTHERS THEN
                 NULL;
                END;

                COMMIT;


            end loop;

             FOR c IN (SELECT *
                       FROM sztalian
                       where 1 = 1
                       AND sztalian_flex ='PR'
                       AND sztalian_no_regla = p_regla
                       AND sztalian_pidm = p_pidm
                       and SZTALIAN_ALIANZA ='UNIC'
                       )loop

                            for d in
                                      (
                                          select distinct SZTPRONO_MATERIA_LEGAL materia,
                                                          sztprono_no_regla regla
                                          from SZTPRONO a
                                          join SZTALMT b on a.SZTPRONO_MATERIA_LEGAL = b.SZTALMT_MATERIA
                                                          AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                          where 1 = 1
                                          and sztprono_no_regla = c.SZTALIAN_NO_REGLA
                                          and sztprono_materia_legal like 'UNIC%'
                                          and exists(select null
                                                     from goradid
                                                     where 1 = 1
                                                     and goradid_pidm=SZTPRONO_PIDM
                                                     and GORADID_ADID_CODE ='UNIC' )
                                          union
                                          select distinct SZTGPME_SUBJ_CRSE materia,
                                                        SZTGPME_no_regla regla
                                                 from sztgpme a
                                                 join SZTALMT b on a.SZTGPME_SUBJ_CRSE = b.SZTALMT_MATERIA
                                                 --                AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                                 where 1 = 1
                                                 and SZTGPME_no_regla = p_regla
                                                 and SZTGPME_SUBJ_CRSE like 'UNIC%'
                                          order by 1
                                          )loop

                                                  l_contador:=0;

                                                   for x in (select *
                                                            from sztprono
                                                            where 1 = 1
                                                            and sztprono_no_regla = c.sztalian_no_regla
                                                            and sztprono_pidm = c.sztalian_pidm
                    --                                        and sztprono_id ='010000758'
                                                            )loop

                                                                l_contador:=l_contador+1;

                                                                if l_nivel ='MA' then

                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);

                                                                    begin

                                                                        select count(*)
                                                                        into l_cuenta_qali
                                                                        from SZTQALI
                                                                        where 1 = 1
                                                                        and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                        AND SZTQALI_PTRM =l_ptrm_pi
                                                                        AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                        AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                    exception when others then
                                                                        null;
                                                                    end;

                                                                    dbms_output.put_line(' Cueneta qali '||l_cuenta_qali);

--                                                                    if l_cuenta_qali > 0 then

                                                                        begin

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          where 1 = 1
                                                                          and sztprono_no_regla = c.sztalian_no_regla
                                                                          and sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        begin

                                                                            insert into sztprono values(x.SZTPRONO_PIDM,
                                                                                                        x.SZTPRONO_ID,
                                                                                                        x.SZTPRONO_TERM_CODE,
                                                                                                        x.SZTPRONO_PROGRAM,
                                                                                                        d.materia,
                                                                                                        l_secuencia,
                                                                                                        x.SZTPRONO_PTRM_CODE,
                                                                                                        d.materia,
                                                                                                        'x',
                                                                                                        x.SZTPRONO_FECHA_INICIO,
                                                                                                        x.SZTPRONO_PTRM_CODE_NW,
                                                                                                        x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                        x.SZTPRONO_AVANCE,
                                                                                                        x.SZTPRONO_NO_REGLA,
                                                                                                        x.SZTPRONO_USUARIO,
                                                                                                        x.SZTPRONO_STUDY_PATH,
                                                                                                        x.SZTPRONO_RATE,
                                                                                                        x.SZTPRONO_JORNADA,
                                                                                                        x.SZTPRONO_ACTIVITY_DATE,
                                                                                                        x.SZTPRONO_CUATRI,
                                                                                                        x.SZTPRONO_TIPO_INICIO,
                                                                                                        x.SZTPRONO_JORNADA_DOS,
                                                                                                        'N',
                                                                                                        'N',
                                                                                                        x.SZTPRONO_ESTATUS,
                                                                                                        'N',
                                                                                                        null,
                                                                                                        x.SZTPRONO_GRUPO_ASIG
                                                                                                        );

                                                                        exception when others then

                                                                            dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                        end;

                                                                        begin
                                                                            UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                            where 1 = 1
                                                                            and sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                            and sztalian_pidm = x.SZTPRONO_PIDM
                                                                            AND SZTALIAN_ALIANZA='UNIC';
                                                                        exception when others then
                                                                            null;
                                                                        end;

--                                                                    end if;

                                                                else

                                                                   IF C.SZTALIAN_AVANCE > 1 THEN

                                                                        begin

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          where 1 = 1
                                                                          and sztprono_no_regla = c.sztalian_no_regla
                                                                          and sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        begin

                                                                            insert into sztprono values(x.SZTPRONO_PIDM,
                                                                                                        x.SZTPRONO_ID,
                                                                                                        x.SZTPRONO_TERM_CODE,
                                                                                                        x.SZTPRONO_PROGRAM,
                                                                                                        d.materia,
                                                                                                        l_secuencia,
                                                                                                        x.SZTPRONO_PTRM_CODE,
                                                                                                        d.materia,
                                                                                                        'x',
                                                                                                        x.SZTPRONO_FECHA_INICIO,
                                                                                                        x.SZTPRONO_PTRM_CODE_NW,
                                                                                                        x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                        x.SZTPRONO_AVANCE,
                                                                                                        x.SZTPRONO_NO_REGLA,
                                                                                                        x.SZTPRONO_USUARIO,
                                                                                                        x.SZTPRONO_STUDY_PATH,
                                                                                                        x.SZTPRONO_RATE,
                                                                                                        x.SZTPRONO_JORNADA,
                                                                                                        x.SZTPRONO_ACTIVITY_DATE,
                                                                                                        x.SZTPRONO_CUATRI,
                                                                                                        x.SZTPRONO_TIPO_INICIO,
                                                                                                        x.SZTPRONO_JORNADA_DOS,
                                                                                                        'N',
                                                                                                        'N',
                                                                                                        x.SZTPRONO_ESTATUS,
                                                                                                        'N',
                                                                                                        null,
                                                                                                        x.SZTPRONO_GRUPO_ASIG
                                                                                                        );

                                                                        exception when others then

                                                                            dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                        end;

                                                                        begin
                                                                            UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                            where 1 = 1
                                                                            and sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                            and sztalian_pidm = x.SZTPRONO_PIDM
                                                                            AND SZTALIAN_ALIANZA='UNIC';
                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                   END IF;

                                                                end if;

                                                                exit when l_contador = 1;

                                                            end loop;


                                          end loop;

                       end loop;

        commit;
end if;
    end;
--
--
    PROCEDURE p_monu_pidm(p_regla   NUMBER,
                          p_pidm    NUMBER)
     is
        l_avance_mayor    number;
        l_avance          number;
        l_pidm_mayor      number;
        l_materia_alianza varchar2(10):=NULL;
        l_cuenta_nivel_li     number;
        l_cuenta_nivel_ma     number;
        l_cuenta_nivel_do     number;
        l_nivel           varchar2(2);
        l_secuencia       number;
        l_contador        number:=0;
        l_contar_alumnos  number;
        l_materias_para   number;
        l_materias_alianza number;
        l_cuenta_materias number;
        l_si_unicef       number;
        l_peirod_uni      varchar2(2);
        l_ptrm_pi         varchar2(3);
        l_cuenta_qali     number;
        l_chk_ind           number:=1;
    begin

p_carrusel_pidm(p_regla,'MONU',p_pidm);

if l_chk_ind = 0 Then
        begin

            select count(*)
            into l_cuenta_nivel_li
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_ma
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_do
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma > 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  if;

        delete sztalian
        where 1 = 1
        and sztalian_no_regla = p_regla
        and sztalian_pidm = p_pidm
        and SZTALIAN_ALIANZA ='MONU'
        AND sztalian_FLEX ='PR';

        for c in ( select distinct (select  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            from SMRPRLE
                            where 1 = 1
                            and SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'MONU' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
            from sztprono
            where 1 = 1
            and sztprono_no_regla = p_regla
            and sztprono_pidm = p_pidm
            AND EXISTS (SELECT NULL
                        FROM GORADID
                        WHERE 1 = 1
                        AND GORADID_PIDM = SZTPRONO_PIDM
                        AND  GORADID_ADID_CODE ='MONU')
            )loop


                begin

                  SELECT MAX(zstpara_param_id)
                  INTO l_avance
                  FROM ZSTPARA
                  WHERE 1 = 1
                  and zstpara_mapa_id ='INSCRIPCIONES'
                  and zstpara_param_valor = c.avance
                  and zstpara_param_desc = c.tipo_inicio;

                exception when others then
                    null;
                end;


                BEGIN

                 --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                  INSERT INTO sztalian VALUES (c.pidm,
                                               c.matricula,
                                               c.programa,
                                               c.alianza,
                                               l_avance,
                                               c.regla,
                                               'N',
                                               nvl(l_materias_para,0),
                                               nvl(l_materias_alianza,0),
                                               c.tipo_inicio,
                                               'PR'
                                               );

                EXCEPTION WHEN OTHERS THEN
                 NULL;
                END;

                COMMIT;


            end loop;

             FOR c IN (SELECT *
                       FROM sztalian
                       where 1 = 1
                       AND sztalian_flex ='PR'
                       AND sztalian_no_regla = p_regla
                       AND sztalian_pidm = p_pidm
                       and SZTALIAN_ALIANZA ='MONU'
                       )loop

                                 for d in
                                      (
                                          select distinct SZTPRONO_MATERIA_LEGAL materia,
                                                          sztprono_no_regla regla
                                          from SZTPRONO a
                                          join SZTALMT b on a.SZTPRONO_MATERIA_LEGAL = b.SZTALMT_MATERIA
                                                          AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                          where 1 = 1
                                          and sztprono_no_regla = c.SZTALIAN_NO_REGLA
                                          and sztprono_materia_legal like 'ONU%'
                                          and exists(select null
                                                     from goradid
                                                     where 1 = 1
                                                     and goradid_pidm=SZTPRONO_PIDM
                                                     and GORADID_ADID_CODE ='MONU' )
                                          union
                                         select distinct SZTGPME_SUBJ_CRSE materia,
                                                SZTGPME_no_regla regla
                                         from sztgpme a
                                         join SZTALMT b on a.SZTGPME_SUBJ_CRSE = b.SZTALMT_MATERIA
                                         --                AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                         where 1 = 1
                                         and SZTGPME_no_regla = p_regla
                                         and SZTGPME_SUBJ_CRSE like 'ONU%'
                                          order by 1
                                          )loop

                                                  l_contador:=0;

                                                  for x in (select *
                                                            from sztprono
                                                            where 1 = 1
                                                            and sztprono_no_regla = c.sztalian_no_regla
                                                            and sztprono_pidm = c.sztalian_pidm
                    --                                        and sztprono_id ='010000758'
                                                            )loop

                                                              l_contador:=l_contador+1;

                                                                begin

                                                                  SELECT nvl(max(sztprono_secuencia),0)+1
                                                                  INTO l_secuencia
                                                                  FROM sztprono
                                                                  where 1 = 1
                                                                  and sztprono_no_regla = c.sztalian_no_regla
                                                                  and sztprono_pidm = c.SZTALIAN_PIDM;

                                                                exception when others then
                                                                    null;
                                                                end;

                                                                begin

                                                                    insert into sztprono values(x.SZTPRONO_PIDM,
                                                                                                x.SZTPRONO_ID,
                                                                                                x.SZTPRONO_TERM_CODE,
                                                                                                x.SZTPRONO_PROGRAM,
                                                                                                d.materia,
                                                                                                l_secuencia,
                                                                                                x.SZTPRONO_PTRM_CODE,
                                                                                                d.materia,
                                                                                                'x',
                                                                                                x.SZTPRONO_FECHA_INICIO,
                                                                                                x.SZTPRONO_PTRM_CODE_NW,
                                                                                                x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                x.SZTPRONO_AVANCE,
                                                                                                x.SZTPRONO_NO_REGLA,
                                                                                                x.SZTPRONO_USUARIO,
                                                                                                x.SZTPRONO_STUDY_PATH,
                                                                                                x.SZTPRONO_RATE,
                                                                                                x.SZTPRONO_JORNADA,
                                                                                                x.SZTPRONO_ACTIVITY_DATE,
                                                                                                x.SZTPRONO_CUATRI,
                                                                                                x.SZTPRONO_TIPO_INICIO,
                                                                                                x.SZTPRONO_JORNADA_DOS,
                                                                                                'N',
                                                                                                'N',
                                                                                                x.SZTPRONO_ESTATUS,
                                                                                                'N',
                                                                                                null,
                                                                                                x.SZTPRONO_GRUPO_ASIG
                                                                                                );

                                                                exception when others then
                --                                                    raise_application_error (-20002,' tres Materia '||d.materia||' -->'||sqlerrm);
                                                                    dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                end;

                                                                 begin
                                                                    UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                    where 1 = 1
                                                                    and sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                    and sztalian_pidm = x.SZTPRONO_PIDM
                                                                    and SZTALIAN_ALIANZA ='MONU';
                                                                exception when others then
                                                                    null;
                                                                end;


                                                                exit when l_contador = 1;

                                                            end loop;


                                          end loop;



                       end loop;
        commit;
end if;
    end;
--
--
    PROCEDURE p_muba_pidm(p_regla   NUMBER,
                          p_pidm    NUMBER)
     is
        l_avance_mayor    number;
        l_avance          number;
        l_pidm_mayor      number;
        l_materia_alianza varchar2(10):=NULL;
        l_cuenta_nivel_li     number;
        l_cuenta_nivel_ma     number;
        l_cuenta_nivel_do     number;
        l_nivel           varchar2(2);
        l_secuencia       number;
        l_contador        number:=0;
        l_contar_alumnos  number;
        l_materias_para   number;
        l_materias_alianza number;
        l_cuenta_materias number;
        l_si_unicef       number;
        l_peirod_uni      varchar2(2);
        l_ptrm_pi         varchar2(3);
        l_cuenta_qali     number;
        l_chk_ind           number:=1;
    begin

p_carrusel_pidm(p_regla,'MUBA',p_pidm);

if l_chk_ind = 0 Then

        begin

            select count(*)
            into l_cuenta_nivel_li
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_ma
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_do
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma > 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  if;

        delete sztalian
        where 1 = 1
        and sztalian_no_regla = p_regla
        and sztalian_pidm = p_pidm
        and SZTALIAN_ALIANZA ='MUBA'
        AND sztalian_FLEX ='PR';

        for c in ( select distinct (select  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            from SMRPRLE
                            where 1 = 1
                            and SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'MUBA' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
            from sztprono
            where 1 = 1
            and sztprono_no_regla = p_regla
            and sztprono_pidm = p_pidm
            AND EXISTS (SELECT NULL
                        FROM GORADID
                        WHERE 1 = 1
                        AND GORADID_PIDM = SZTPRONO_PIDM
                        AND  GORADID_ADID_CODE ='MUBA')
            )loop


                begin

                  SELECT MAX(zstpara_param_id)
                  INTO l_avance
                  FROM ZSTPARA
                  WHERE 1 = 1
                  and zstpara_mapa_id ='INSCRIPCIONES'
                  and zstpara_param_valor = c.avance
                  and zstpara_param_desc = c.tipo_inicio;

                exception when others then
                    null;
                end;


                BEGIN

                 --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                  INSERT INTO sztalian VALUES (c.pidm,
                                               c.matricula,
                                               c.programa,
                                               c.alianza,
                                               l_avance,
                                               c.regla,
                                               'N',
                                               nvl(l_materias_para,0),
                                               nvl(l_materias_alianza,0),
                                               c.tipo_inicio,
                                               'PR'
                                               );

                EXCEPTION WHEN OTHERS THEN
                 NULL;
                END;

                COMMIT;
            end loop;

             FOR c IN (SELECT *
                       FROM sztalian
                       where 1 = 1
                       AND sztalian_flex ='PR'
                       AND sztalian_no_regla = p_regla
                       AND sztalian_pidm = p_pidm
                       and SZTALIAN_ALIANZA ='MUBA'
                       )loop

                        for d in
                                      (
                                          select distinct SZTPRONO_MATERIA_LEGAL materia,
                                                          sztprono_no_regla regla
                                          from SZTPRONO a
                                          join SZTALMT b on a.SZTPRONO_MATERIA_LEGAL = b.SZTALMT_MATERIA
                                                          AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                          where 1 = 1
                                          and sztprono_no_regla = c.SZTALIAN_NO_REGLA
                                          and sztprono_materia_legal like 'UBA%'
                                          and exists(select null
                                                     from goradid
                                                     where 1 = 1
                                                     and goradid_pidm=SZTPRONO_PIDM
                                                     and GORADID_ADID_CODE ='MUBA' )
                                          union
                                          select distinct SZTGPME_SUBJ_CRSE materia,
                                                        SZTGPME_no_regla regla
                                          from sztgpme a
                                          join SZTALMT b on a.SZTGPME_SUBJ_CRSE = b.SZTALMT_MATERIA
                                          where 1 = 1
                                          and SZTGPME_no_regla = p_regla
                                          and SZTGPME_SUBJ_CRSE like 'UBA%'
                                          order by 1
                                          )loop

                                                  l_contador:=0;

                                                  for x in (select *
                                                            from sztprono
                                                            where 1 = 1
                                                            and sztprono_no_regla = c.sztalian_no_regla
                                                            and sztprono_pidm = c.sztalian_pidm
                                                            )loop

                                                              l_contador:=l_contador+1;

                                                                begin

                                                                  SELECT nvl(max(sztprono_secuencia),0)+1
                                                                  INTO l_secuencia
                                                                  FROM sztprono
                                                                  where 1 = 1
                                                                  and sztprono_no_regla = c.sztalian_no_regla
                                                                  and sztprono_pidm = c.SZTALIAN_PIDM;

                                                                exception when others then
                                                                    null;
                                                                end;

                                                                begin

                                                                    insert into sztprono values(x.SZTPRONO_PIDM,
                                                                                                x.SZTPRONO_ID,
                                                                                                x.SZTPRONO_TERM_CODE,
                                                                                                x.SZTPRONO_PROGRAM,
                                                                                                d.materia,
                                                                                                l_secuencia,
                                                                                                x.SZTPRONO_PTRM_CODE,
                                                                                                d.materia,
                                                                                                'x',
                                                                                                x.SZTPRONO_FECHA_INICIO,
                                                                                                x.SZTPRONO_PTRM_CODE_NW,
                                                                                                x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                x.SZTPRONO_AVANCE,
                                                                                                x.SZTPRONO_NO_REGLA,
                                                                                                x.SZTPRONO_USUARIO,
                                                                                                x.SZTPRONO_STUDY_PATH,
                                                                                                x.SZTPRONO_RATE,
                                                                                                x.SZTPRONO_JORNADA,
                                                                                                x.SZTPRONO_ACTIVITY_DATE,
                                                                                                x.SZTPRONO_CUATRI,
                                                                                                x.SZTPRONO_TIPO_INICIO,
                                                                                                x.SZTPRONO_JORNADA_DOS,
                                                                                                'N',
                                                                                                'N',
                                                                                                x.SZTPRONO_ESTATUS,
                                                                                                'N',
                                                                                                null,
                                                                                                x.SZTPRONO_GRUPO_ASIG
                                                                                                );

                                                                exception when others then
                --                                                    raise_application_error (-20002,' tres Materia '||d.materia||' -->'||sqlerrm);
                                                                    dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                end;

                                                                 begin
                                                                    UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                    where 1 = 1
                                                                    and sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                    and sztalian_pidm = x.SZTPRONO_PIDM
                                                                    and SZTALIAN_ALIANZA ='MUBA';
                                                                exception when others then
                                                                    null;
                                                                end;


                                                                exit when l_contador = 1;

                                                            end loop;


                                          end loop;



                       end loop;

        commit;
end if;
    end;
--
--
    PROCEDURE p_fcbk_pidm(p_regla   NUMBER,
                          p_pidm    NUMBER)
     is
        l_avance_mayor    number;
        l_avance          number;
        l_pidm_mayor      number;
        l_materia_alianza varchar2(10):=NULL;
        l_cuenta_nivel_li     number;
        l_cuenta_nivel_ma     number;
        l_cuenta_nivel_do     number;
        l_nivel           varchar2(2);
        l_secuencia       number;
        l_contador        number:=0;
        l_contar_alumnos  number;
        l_materias_para   number;
        l_materias_alianza number;
        l_cuenta_materias number;
        l_si_unicef       number;
        l_peirod_uni      varchar2(2);
        l_ptrm_pi         varchar2(3);
        l_cuenta_qali     number;
        l_chk_ind           number:=1;
    begin

p_NO_carrusel_pidm(p_regla,'FCBK',p_pidm);

if l_chk_ind = 0 Then
        begin

            select count(*)
            into l_cuenta_nivel_li
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_ma
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_do
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma > 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  if;

        delete sztalian
        where 1 = 1
        and sztalian_no_regla = p_regla
        and sztalian_pidm = p_pidm
        and SZTALIAN_ALIANZA ='FCBK'
        AND sztalian_FLEX ='PR';

        for c in ( select distinct (select  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            from SMRPRLE
                            where 1 = 1
                            and SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'FCBK' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
            from sztprono
            where 1 = 1
            and sztprono_no_regla = p_regla
            and sztprono_pidm = p_pidm
            AND EXISTS (SELECT NULL
                        FROM GORADID
                        WHERE 1 = 1
                        AND GORADID_PIDM = SZTPRONO_PIDM
                        AND  GORADID_ADID_CODE ='FCBK')
            )loop


                begin

                  SELECT MAX(zstpara_param_id)
                  INTO l_avance
                  FROM ZSTPARA
                  WHERE 1 = 1
                  and zstpara_mapa_id ='INSCRIPCIONES'
                  and zstpara_param_valor = c.avance
                  and zstpara_param_desc = c.tipo_inicio;

                exception when others then
                    null;
                end;


                BEGIN

                 --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                  INSERT INTO sztalian VALUES (c.pidm,
                                               c.matricula,
                                               c.programa,
                                               c.alianza,
                                               l_avance,
                                               c.regla,
                                               'N',
                                               nvl(l_materias_para,0),
                                               nvl(l_materias_alianza,0),
                                               c.tipo_inicio,
                                               'PR'
                                               );

                EXCEPTION WHEN OTHERS THEN
                 NULL;
                END;

                COMMIT;


            end loop;

             FOR c IN (SELECT *
                       FROM sztalian
                       where 1 = 1
                       AND sztalian_flex ='PR'
                       AND sztalian_no_regla = p_regla
                       AND sztalian_pidm = p_pidm
                       and SZTALIAN_ALIANZA ='FCBK'
                       )loop

                            for d in
                                      (
                                          select distinct SZTPRONO_MATERIA_LEGAL materia,
                                                          sztprono_no_regla regla
                                          from SZTPRONO a
                                          join SZTALMT b on a.SZTPRONO_MATERIA_LEGAL = b.SZTALMT_MATERIA
                                                          AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                          where 1 = 1
                                          and sztprono_no_regla = c.SZTALIAN_NO_REGLA
                                          and sztprono_materia_legal like 'FACE%'
                                          and exists(select null
                                                     from goradid
                                                     where 1 = 1
                                                     and goradid_pidm=SZTPRONO_PIDM
                                                     and GORADID_ADID_CODE ='FCBK' )
                                          union
                                          select distinct SZTGPME_SUBJ_CRSE materia,
                                                        SZTGPME_no_regla regla
                                                 from sztgpme a
                                                 join SZTALMT b on a.SZTGPME_SUBJ_CRSE = b.SZTALMT_MATERIA
                                                 --                AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                                 where 1 = 1
                                                 and SZTGPME_no_regla = p_regla
                                                 and SZTGPME_SUBJ_CRSE like 'FACE%'
                                          order by 1
                                          )loop

                                                  l_contador:=0;

                                                   for x in (select *
                                                            from sztprono
                                                            where 1 = 1
                                                            and sztprono_no_regla = c.sztalian_no_regla
                                                            and sztprono_pidm = c.sztalian_pidm
                    --                                        and sztprono_id ='010000758'
                                                            )loop

                                                                l_contador:=l_contador+1;

                                                                if l_nivel ='MA' then

                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);

                                                                    begin

                                                                        select count(*)
                                                                        into l_cuenta_qali
                                                                        from SZTQALI
                                                                        where 1 = 1
                                                                        and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                        AND SZTQALI_PTRM =l_ptrm_pi
                                                                        AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                        AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                    exception when others then
                                                                        null;
                                                                    end;

                                                                    dbms_output.put_line(' Cueneta qali '||l_cuenta_qali);

                                                                    if l_cuenta_qali > 0 then

                                                                        begin

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          where 1 = 1
                                                                          and sztprono_no_regla = c.sztalian_no_regla
                                                                          and sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        begin

                                                                            insert into sztprono values(x.SZTPRONO_PIDM,
                                                                                                        x.SZTPRONO_ID,
                                                                                                        x.SZTPRONO_TERM_CODE,
                                                                                                        x.SZTPRONO_PROGRAM,
                                                                                                        d.materia,
                                                                                                        l_secuencia,
                                                                                                        x.SZTPRONO_PTRM_CODE,
                                                                                                        d.materia,
                                                                                                        'x',
                                                                                                        x.SZTPRONO_FECHA_INICIO,
                                                                                                        x.SZTPRONO_PTRM_CODE_NW,
                                                                                                        x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                        x.SZTPRONO_AVANCE,
                                                                                                        x.SZTPRONO_NO_REGLA,
                                                                                                        x.SZTPRONO_USUARIO,
                                                                                                        x.SZTPRONO_STUDY_PATH,
                                                                                                        x.SZTPRONO_RATE,
                                                                                                        x.SZTPRONO_JORNADA,
                                                                                                        x.SZTPRONO_ACTIVITY_DATE,
                                                                                                        x.SZTPRONO_CUATRI,
                                                                                                        x.SZTPRONO_TIPO_INICIO,
                                                                                                        x.SZTPRONO_JORNADA_DOS,
                                                                                                        'N',
                                                                                                        'N',
                                                                                                        x.SZTPRONO_ESTATUS,
                                                                                                        'N',
                                                                                                        null,
                                                                                                        x.SZTPRONO_GRUPO_ASIG
                                                                                                        );

                                                                        exception when others then

                                                                            dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                        end;

                                                                        begin
                                                                            UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                            where 1 = 1
                                                                            and sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                            and sztalian_pidm = x.SZTPRONO_PIDM
                                                                            AND SZTALIAN_ALIANZA='FCBK';
                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                    end if;

                                                                else

                                                                   IF C.SZTALIAN_AVANCE IN (3,4,5,6) THEN

                                                                        begin

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          where 1 = 1
                                                                          and sztprono_no_regla = c.sztalian_no_regla
                                                                          and sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        begin

                                                                            insert into sztprono values(x.SZTPRONO_PIDM,
                                                                                                        x.SZTPRONO_ID,
                                                                                                        x.SZTPRONO_TERM_CODE,
                                                                                                        x.SZTPRONO_PROGRAM,
                                                                                                        d.materia,
                                                                                                        l_secuencia,
                                                                                                        x.SZTPRONO_PTRM_CODE,
                                                                                                        d.materia,
                                                                                                        'x',
                                                                                                        x.SZTPRONO_FECHA_INICIO,
                                                                                                        x.SZTPRONO_PTRM_CODE_NW,
                                                                                                        x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                        x.SZTPRONO_AVANCE,
                                                                                                        x.SZTPRONO_NO_REGLA,
                                                                                                        x.SZTPRONO_USUARIO,
                                                                                                        x.SZTPRONO_STUDY_PATH,
                                                                                                        x.SZTPRONO_RATE,
                                                                                                        x.SZTPRONO_JORNADA,
                                                                                                        x.SZTPRONO_ACTIVITY_DATE,
                                                                                                        x.SZTPRONO_CUATRI,
                                                                                                        x.SZTPRONO_TIPO_INICIO,
                                                                                                        x.SZTPRONO_JORNADA_DOS,
                                                                                                        'N',
                                                                                                        'N',
                                                                                                        x.SZTPRONO_ESTATUS,
                                                                                                        'N',
                                                                                                        null,
                                                                                                        x.SZTPRONO_GRUPO_ASIG
                                                                                                        );

                                                                        exception when others then

                                                                            dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                        end;

                                                                        begin
                                                                            UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                            where 1 = 1
                                                                            and sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                            and sztalian_pidm = x.SZTPRONO_PIDM
                                                                            AND SZTALIAN_ALIANZA='FCBK';
                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                   END IF;

                                                                end if;

                                                                exit when l_contador = 1;

                                                            end loop;


                                          end loop;

                       end loop;
        commit;
    END IF;
    end;
--
--
    PROCEDURE p_coll_pidm(p_regla   NUMBER,
                          p_pidm    NUMBER)
     is
        l_avance_mayor    number;
        l_avance          number;
        l_pidm_mayor      number;
        l_materia_alianza varchar2(10):=NULL;
        l_cuenta_nivel_li     number;
        l_cuenta_nivel_ma     number;
        l_cuenta_nivel_do     number;
        l_nivel           varchar2(2);
        l_secuencia       number;
        l_contador        number:=0;
        l_contar_alumnos  number;
        l_materias_para   number;
        l_materias_alianza number;
        l_cuenta_materias number;
        l_si_unicef       number;
        l_peirod_uni      varchar2(2);
        l_ptrm_pi         varchar2(3);
        l_cuenta_qali     number;
        l_chk_ind           number:=1;
    begin

p_NO_carrusel_pidm(p_regla,'COLL',p_pidm);

if l_chk_ind = 0 Then
        begin

            select count(*)
            into l_cuenta_nivel_li
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_ma
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_do
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma > 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  if;

        delete sztalian
        where 1 = 1
        and sztalian_no_regla = p_regla
        and sztalian_pidm = p_pidm
        and SZTALIAN_ALIANZA ='COLL'
        AND sztalian_FLEX ='PR';

        for c in ( select distinct (select  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            from SMRPRLE
                            where 1 = 1
                            and SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'COLL' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
            from sztprono
            where 1 = 1
            and sztprono_no_regla = p_regla
            and sztprono_pidm = p_pidm
            AND EXISTS (SELECT NULL
                        FROM GORADID
                        WHERE 1 = 1
                        AND GORADID_PIDM = SZTPRONO_PIDM
                        AND  GORADID_ADID_CODE ='COLL')
            )loop


                begin

                  SELECT MAX(zstpara_param_id)
                  INTO l_avance
                  FROM ZSTPARA
                  WHERE 1 = 1
                  and zstpara_mapa_id ='INSCRIPCIONES'
                  and zstpara_param_valor = c.avance
                  and zstpara_param_desc = c.tipo_inicio;

                exception when others then
                    null;
                end;


                BEGIN

                 --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                  INSERT INTO sztalian VALUES (c.pidm,
                                               c.matricula,
                                               c.programa,
                                               c.alianza,
                                               l_avance,
                                               c.regla,
                                               'N',
                                               nvl(l_materias_para,0),
                                               nvl(l_materias_alianza,0),
                                               c.tipo_inicio,
                                               'PR'
                                               );

                EXCEPTION WHEN OTHERS THEN
                 NULL;
                END;

                COMMIT;


            end loop;

             FOR c IN (SELECT *
                       FROM sztalian
                       where 1 = 1
                       AND sztalian_flex ='PR'
                       AND sztalian_no_regla = p_regla
                       AND sztalian_pidm = p_pidm
                       and SZTALIAN_ALIANZA ='COLL'
                       )loop

                             for d in
                                      (
                                         select distinct SZTPRONO_MATERIA_LEGAL materia,
                                                          sztprono_no_regla regla
                                          from SZTPRONO a
                                          join SZTALMT b on a.SZTPRONO_MATERIA_LEGAL = b.SZTALMT_MATERIA
                                                          AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                          where 1 = 1
                                          and sztprono_no_regla = c.SZTALIAN_NO_REGLA
                                          and sztprono_materia_legal like 'EXCO%'
                                          and exists(select null
                                                     from goradid
                                                     where 1 = 1
                                                     and goradid_pidm=SZTPRONO_PIDM
                                                     and GORADID_ADID_CODE ='EXCO' )
                                          union
                                          select distinct SZTGPME_SUBJ_CRSE materia,
                                                        SZTGPME_no_regla regla
                                                 from sztgpme a
                                                 join SZTALMT b on a.SZTGPME_SUBJ_CRSE = b.SZTALMT_MATERIA
                                                 --                AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                                 where 1 = 1
                                                 and SZTGPME_no_regla = p_regla
                                                 and SZTGPME_SUBJ_CRSE like 'EXCO%'
                                          order by 1
                                          )loop

                                                  l_contador:=0;

                                                  for x in (select *
                                                            from sztprono
                                                            where 1 = 1
                                                            and sztprono_no_regla = c.sztalian_no_regla
                                                            and sztprono_pidm = c.sztalian_pidm
                    --                                        and sztprono_id ='010000758'
                                                            )loop

                                                              l_contador:=l_contador+1;

                                                                begin

                                                                  SELECT nvl(max(sztprono_secuencia),0)+1
                                                                  INTO l_secuencia
                                                                  FROM sztprono
                                                                  where 1 = 1
                                                                  and sztprono_no_regla = c.sztalian_no_regla
                                                                  and sztprono_pidm = c.SZTALIAN_PIDM;

                                                                exception when others then
                                                                    null;
                                                                end;

                                                                begin

                                                                    insert into sztprono values(x.SZTPRONO_PIDM,
                                                                                                x.SZTPRONO_ID,
                                                                                                x.SZTPRONO_TERM_CODE,
                                                                                                x.SZTPRONO_PROGRAM,
                                                                                                d.materia,
                                                                                                l_secuencia,
                                                                                                x.SZTPRONO_PTRM_CODE,
                                                                                                d.materia,
                                                                                                'x',
                                                                                                x.SZTPRONO_FECHA_INICIO,
                                                                                                x.SZTPRONO_PTRM_CODE_NW,
                                                                                                x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                x.SZTPRONO_AVANCE,
                                                                                                x.SZTPRONO_NO_REGLA,
                                                                                                x.SZTPRONO_USUARIO,
                                                                                                x.SZTPRONO_STUDY_PATH,
                                                                                                x.SZTPRONO_RATE,
                                                                                                x.SZTPRONO_JORNADA,
                                                                                                x.SZTPRONO_ACTIVITY_DATE,
                                                                                                x.SZTPRONO_CUATRI,
                                                                                                x.SZTPRONO_TIPO_INICIO,
                                                                                                x.SZTPRONO_JORNADA_DOS,
                                                                                                'N',
                                                                                                'N',
                                                                                                x.SZTPRONO_ESTATUS,
                                                                                                'N',
                                                                                                null,
                                                                                                x.SZTPRONO_GRUPO_ASIG
                                                                                                );

                                                                exception when others then
                --                                                    raise_application_error (-20002,' tres Materia '||d.materia||' -->'||sqlerrm);
                                                                    dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                end;

                                                                 begin
                                                                    UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                    where 1 = 1
                                                                    and sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                    and sztalian_pidm = x.SZTPRONO_PIDM
                                                                    AND sztalian_alianza ='COLL';
                                                                exception when others then
                                                                    null;
                                                                end;


                                                                exit when l_contador = 1;

                                                            end loop;


                                          end loop;

                       end loop;

        commit;

END IF;

    end; --1483
--
--
 PROCEDURE p_cesa_pidm(p_regla   NUMBER,
                          p_pidm    NUMBER)
     is
        l_avance_mayor    number;
        l_avance          number;
        l_pidm_mayor      number;
        l_materia_alianza varchar2(10):=NULL;
        l_cuenta_nivel_li     number;
        l_cuenta_nivel_ma     number;
        l_cuenta_nivel_do     number;
        l_nivel           varchar2(2);
        l_secuencia       number;
        l_contador        number:=0;
        l_contar_alumnos  number;
        l_materias_para   number;
        l_materias_alianza number;
        l_cuenta_materias number;
        l_si_unicef       number;
        l_peirod_uni      varchar2(2);
        l_ptrm_pi         varchar2(3);
        l_cuenta_qali     number;
        l_chk_ind           number:=1;
    begin

p_no_carrusel_pidm(p_regla,'CESA',p_pidm);

if l_chk_ind = 0 Then

        begin

            select count(*)
            into l_cuenta_nivel_li
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_ma
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_do
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma > 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  if;

        delete sztalian
        where 1 = 1
        and sztalian_no_regla = p_regla
        and sztalian_pidm = p_pidm
        and SZTALIAN_ALIANZA ='CESA'
        AND sztalian_FLEX ='PR';

        for c in ( select distinct (select  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            from SMRPRLE
                            where 1 = 1
                            and SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'CESA' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
            from sztprono
            where 1 = 1
            and sztprono_no_regla = p_regla
            and sztprono_pidm = p_pidm
            AND EXISTS (SELECT NULL
                        FROM GORADID
                        WHERE 1 = 1
                        AND GORADID_PIDM = SZTPRONO_PIDM
                        AND  GORADID_ADID_CODE ='CESA')
            )loop


                begin

                  SELECT MAX(zstpara_param_id)
                  INTO l_avance
                  FROM ZSTPARA
                  WHERE 1 = 1
                  and zstpara_mapa_id ='INSCRIPCIONES'
                  and zstpara_param_valor = c.avance
                  and zstpara_param_desc = c.tipo_inicio;

                exception when others then
                    null;
                end;


                BEGIN

                 --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                  INSERT INTO sztalian VALUES (c.pidm,
                                               c.matricula,
                                               c.programa,
                                               c.alianza,
                                               l_avance,
                                               c.regla,
                                               'N',
                                               nvl(l_materias_para,0),
                                               nvl(l_materias_alianza,0),
                                               c.tipo_inicio,
                                               'PR'
                                               );

                EXCEPTION WHEN OTHERS THEN
                 NULL;
                END;

                COMMIT;


            end loop;

             FOR c IN (SELECT *
                       FROM sztalian
                       where 1 = 1
                       AND sztalian_flex ='PR'
                       AND sztalian_no_regla = p_regla
                       AND sztalian_pidm = p_pidm
                       and SZTALIAN_ALIANZA ='CESA'
                       )loop

                              dbms_output.put_line( 'Entra a Cesa   --> ' );

                                        for d in
                                      (
                                          select distinct SZTPRONO_MATERIA_LEGAL materia,
                                                          sztprono_no_regla regla
                                          from SZTPRONO a
                                          join SZTALMT b on a.SZTPRONO_MATERIA_LEGAL = b.SZTALMT_MATERIA
                                                          AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                          where 1 = 1
                                          and sztprono_no_regla = c.SZTALIAN_NO_REGLA
                                          and sztprono_materia_legal like 'CESA%'
                                          and exists(select null
                                                     from goradid
                                                     where 1 = 1
                                                     and goradid_pidm=SZTPRONO_PIDM
                                                     and GORADID_ADID_CODE ='CESA' )
                                          union
                                          select distinct SZTGPME_SUBJ_CRSE materia,
                                                        SZTGPME_no_regla regla
                                                 from sztgpme a
                                                 join SZTALMT b on a.SZTGPME_SUBJ_CRSE = b.SZTALMT_MATERIA
                                                 --                AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                                 where 1 = 1
                                                 and SZTGPME_no_regla = p_regla
                                                 and SZTGPME_SUBJ_CRSE like 'CESA%'
                                          order by 1
                                          )loop

                                                  l_contador:=0;

                                                  for x in (select *
                                                            from sztprono
                                                            where 1 = 1
                                                            and sztprono_no_regla = c.sztalian_no_regla
                                                            and sztprono_pidm = c.sztalian_pidm
                    --                                        and sztprono_id ='010000758'
                                                            )loop

                                                              l_contador:=l_contador+1;

                                                                begin

                                                                  SELECT nvl(max(sztprono_secuencia),0)+1
                                                                  INTO l_secuencia
                                                                  FROM sztprono
                                                                  where 1 = 1
                                                                  and sztprono_no_regla = c.sztalian_no_regla
                                                                  and sztprono_pidm = c.SZTALIAN_PIDM;

                                                                exception when others then
                                                                    null;
                                                                end;

                                                                begin

                                                                    insert into sztprono values(x.SZTPRONO_PIDM,
                                                                                                x.SZTPRONO_ID,
                                                                                                x.SZTPRONO_TERM_CODE,
                                                                                                x.SZTPRONO_PROGRAM,
                                                                                                d.materia,
                                                                                                l_secuencia,
                                                                                                x.SZTPRONO_PTRM_CODE,
                                                                                                d.materia,
                                                                                                'x',
                                                                                                x.SZTPRONO_FECHA_INICIO,
                                                                                                x.SZTPRONO_PTRM_CODE_NW,
                                                                                                x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                x.SZTPRONO_AVANCE,
                                                                                                x.SZTPRONO_NO_REGLA,
                                                                                                x.SZTPRONO_USUARIO,
                                                                                                x.SZTPRONO_STUDY_PATH,
                                                                                                x.SZTPRONO_RATE,
                                                                                                x.SZTPRONO_JORNADA,
                                                                                                x.SZTPRONO_ACTIVITY_DATE,
                                                                                                x.SZTPRONO_CUATRI,
                                                                                                x.SZTPRONO_TIPO_INICIO,
                                                                                                x.SZTPRONO_JORNADA_DOS,
                                                                                                'N',
                                                                                                'N',
                                                                                                x.SZTPRONO_ESTATUS,
                                                                                                'N',
                                                                                                null,
                                                                                                x.SZTPRONO_GRUPO_ASIG
                                                                                                );

                                                                exception when others then
                                                                    dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                end;

                                                                BEGIN
                                                                    UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                    WHERE 1 = 1
                                                                    AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                    AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                    AND sztalian_alianza ='CESA';
                                                                EXCEPTION WHEN OTHERS THEN
                                                                    NULL;
                                                                END;


                                                                exit when l_contador = 1;

                                                            end loop;


                                          end loop;

                       end loop;
        commit;
end if;
    end; --1708
--
--


     PROCEDURE p_ssen_pidm(p_regla   NUMBER,
                          p_pidm    NUMBER)
     is
        l_avance_mayor    number;
        l_avance          number;
        l_pidm_mayor      number;
        l_materia_alianza varchar2(10):=NULL;
        l_cuenta_nivel_li     number;
        l_cuenta_nivel_ma     number;
        l_cuenta_nivel_do     number;
        l_nivel           varchar2(2);
        l_secuencia       number;
        l_contador        number:=0;
        l_contar_alumnos  number;
        l_materias_para   number;
        l_materias_alianza number;
        l_cuenta_materias number;
        l_si_unicef       number;
        l_peirod_uni      varchar2(2);
        l_ptrm_pi         varchar2(3);
        l_cuenta_qali     number;
        l_chk_ind           number:=1;
    begin

p_NO_carrusel_pidm(p_regla,'SENI',p_pidm);

if l_chk_ind = 0 Then
        begin

            select count(*)
            into l_cuenta_nivel_li
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_ma
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_do
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma > 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  if;

        delete sztalian
        where 1 = 1
        and sztalian_no_regla = p_regla
        and sztalian_pidm = p_pidm
        and SZTALIAN_ALIANZA ='SENI'
        AND sztalian_FLEX ='PR';

        for c in ( select distinct (select  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            from SMRPRLE
                            where 1 = 1
                            and SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'SENI' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
            from sztprono
            where 1 = 1
            and sztprono_no_regla = p_regla
            and sztprono_pidm = p_pidm
            AND EXISTS (SELECT NULL
                        FROM GORADID
                        WHERE 1 = 1
                        AND GORADID_PIDM = SZTPRONO_PIDM
                        AND  GORADID_ADID_CODE ='SENI')
            )loop


                begin

                  SELECT MAX(zstpara_param_id)
                  INTO l_avance
                  FROM ZSTPARA
                  WHERE 1 = 1
                  and zstpara_mapa_id ='INSCRIPCIONES'
                  and zstpara_param_valor = c.avance
                  and zstpara_param_desc = c.tipo_inicio;

                exception when others then
                    null;
                end;


                BEGIN

                 --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                  INSERT INTO sztalian VALUES (c.pidm,
                                               c.matricula,
                                               c.programa,
                                               c.alianza,
                                               l_avance,
                                               c.regla,
                                               'N',
                                               nvl(l_materias_para,0),
                                               nvl(l_materias_alianza,0),
                                               c.tipo_inicio,
                                               'PR'
                                               );

                EXCEPTION WHEN OTHERS THEN
                 NULL;
                END;

                COMMIT;


            end loop;

             FOR c IN (SELECT *
                       FROM sztalian
                       where 1 = 1
                       AND sztalian_flex ='PR'
                       AND sztalian_no_regla = p_regla
                       AND sztalian_pidm = p_pidm
                       and SZTALIAN_ALIANZA ='SENI'
                       )loop

                              for d in
                                      (
                                          select distinct SZTPRONO_MATERIA_LEGAL materia,
                                                          sztprono_no_regla regla
                                          from SZTPRONO a
                                          join SZTALMT b on a.SZTPRONO_MATERIA_LEGAL = b.SZTALMT_MATERIA
                                                          AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                          where 1 = 1
                                          and sztprono_no_regla = c.SZTALIAN_NO_REGLA
                                          and sztprono_materia_legal like 'SSEN%'
                                          and exists(select null
                                                     from goradid
                                                     where 1 = 1
                                                     and goradid_pidm=SZTPRONO_PIDM
                                                     and GORADID_ADID_CODE ='SENI' )
                                          UNION
                                          select distinct SZTGPME_SUBJ_CRSE materia,
                                                        SZTGPME_no_regla regla
                                                 from sztgpme a
                                                 join SZTALMT b on a.SZTGPME_SUBJ_CRSE = b.SZTALMT_MATERIA
                                                 --                AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                                 where 1 = 1
                                                 and SZTGPME_no_regla = p_regla
                                                 and SZTGPME_SUBJ_CRSE like 'SSE%'
                                          order by 1
                                          )loop

                                                  l_contador:=0;

                                                  for x in (select *
                                                            from sztprono
                                                            where 1 = 1
                                                            and sztprono_no_regla = c.sztalian_no_regla
                                                            and sztprono_pidm = c.sztalian_pidm
                    --                                        and sztprono_id ='010000758'
                                                            )loop

                                                              l_contador:=l_contador+1;

                                                                begin

                                                                  SELECT nvl(max(sztprono_secuencia),0)+1
                                                                  INTO l_secuencia
                                                                  FROM sztprono
                                                                  where 1 = 1
                                                                  and sztprono_no_regla = c.sztalian_no_regla
                                                                  and sztprono_pidm = c.SZTALIAN_PIDM;

                                                                exception when others then
                                                                    null;
                                                                end;

                                                                begin

                                                                    insert into sztprono values(x.SZTPRONO_PIDM,
                                                                                                x.SZTPRONO_ID,
                                                                                                x.SZTPRONO_TERM_CODE,
                                                                                                x.SZTPRONO_PROGRAM,
                                                                                                d.materia,
                                                                                                l_secuencia,
                                                                                                x.SZTPRONO_PTRM_CODE,
                                                                                                d.materia,
                                                                                                'x',
                                                                                                x.SZTPRONO_FECHA_INICIO,
                                                                                                x.SZTPRONO_PTRM_CODE_NW,
                                                                                                x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                x.SZTPRONO_AVANCE,
                                                                                                x.SZTPRONO_NO_REGLA,
                                                                                                x.SZTPRONO_USUARIO,
                                                                                                x.SZTPRONO_STUDY_PATH,
                                                                                                x.SZTPRONO_RATE,
                                                                                                x.SZTPRONO_JORNADA,
                                                                                                x.SZTPRONO_ACTIVITY_DATE,
                                                                                                x.SZTPRONO_CUATRI,
                                                                                                x.SZTPRONO_TIPO_INICIO,
                                                                                                x.SZTPRONO_JORNADA_DOS,
                                                                                                'N',
                                                                                                'N',
                                                                                                x.SZTPRONO_ESTATUS,
                                                                                                'N',
                                                                                                null,
                                                                                                x.SZTPRONO_GRUPO_ASIG
                                                                                                );

                                                                exception when others then
                --                                                    raise_application_error (-20002,' tres Materia '||d.materia||' -->'||sqlerrm);
                                                                    dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                end;

                                                                 begin
                                                                    UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                    where 1 = 1
                                                                    and sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                    and sztalian_pidm = x.SZTPRONO_PIDM
                                                                    and sztalian_alianza ='SSEN';
                                                                exception when others then
                                                                    null;
                                                                end;


                                                                exit when l_contador = 1;

                                                            end loop;


                                          end loop;

                       end loop;
        commit;
END IF;
    end; --2253
--
--
        PROCEDURE p_cifa_pidm(p_regla   NUMBER,
                          p_pidm    NUMBER)
     is
        l_avance_mayor    number;
        l_avance          number;
        l_pidm_mayor      number;
        l_materia_alianza varchar2(10):=NULL;
        l_cuenta_nivel_li     number;
        l_cuenta_nivel_ma     number;
        l_cuenta_nivel_do     number;
        l_nivel           varchar2(2);
        l_secuencia       number;
        l_contador        number:=0;
        l_contar_alumnos  number;
        l_materias_para   number;
        l_materias_alianza number;
        l_cuenta_materias number;
        l_si_unicef       number;
        l_peirod_uni      varchar2(2);
        l_ptrm_pi         varchar2(3);
        l_cuenta_qali     number;
        l_chk_ind           number:=1;
    begin

p_carrusel_pidm(p_regla,'CIFA',p_pidm);

if l_chk_ind = 0 Then
        begin

            select count(*)
            into l_cuenta_nivel_li
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_ma
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_do
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma > 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  if;

        delete sztalian
        where 1 = 1
        and sztalian_no_regla = p_regla
        and sztalian_pidm = p_pidm
        and SZTALIAN_ALIANZA ='CIFA'
        AND sztalian_FLEX ='PR';

        for c in ( select distinct (select  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            from SMRPRLE
                            where 1 = 1
                            and SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'CIFA' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
            from sztprono
            where 1 = 1
            and sztprono_no_regla = p_regla
            and sztprono_pidm = p_pidm
            AND EXISTS (SELECT NULL
                        FROM GORADID
                        WHERE 1 = 1
                        AND GORADID_PIDM = SZTPRONO_PIDM
                        AND  GORADID_ADID_CODE ='CIFA')
            )loop

                dbms_output.put_line('Entra a coursera -->'||2);


                begin

                  SELECT MAX(zstpara_param_id)
                  INTO l_avance
                  FROM ZSTPARA
                  WHERE 1 = 1
                  and zstpara_mapa_id ='INSCRIPCIONES'
                  and zstpara_param_valor = c.avance
                  and zstpara_param_desc = c.tipo_inicio;

                exception when others then
                    null;
                end;


                BEGIN

                  dbms_output.put_line (' PImd '||c.pidm||' Matricula '||c.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||c.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||c.tipo_inicio);

                  INSERT INTO sztalian VALUES (c.pidm,
                                               c.matricula,
                                               c.programa,
                                               c.alianza,
                                               l_avance,
                                               c.regla,
                                               'N',
                                               nvl(l_materias_para,0),
                                               nvl(l_materias_alianza,0),
                                               c.tipo_inicio,
                                               'PR'
                                               );

                EXCEPTION WHEN OTHERS THEN
                 NULL;
                END;

                COMMIT;


            end loop;

            FOR c IN (SELECT *
                               FROM sztalian
                               where 1 = 1
                               AND sztalian_flex ='PR'
                               AND sztalian_no_regla = p_regla
                               AND sztalian_pidm = p_pidm
                               AND sztalian_alianza ='CIFA'
                              )loop

                                dbms_output.put_line( 'Entra a COURSERA   --> 2' );

                                        for d in
                                      (
                                          select distinct SZTPRONO_MATERIA_LEGAL materia,
                                                          sztprono_no_regla regla
                                          from SZTPRONO a
                                          join SZTALMT b on a.SZTPRONO_MATERIA_LEGAL = b.SZTALMT_MATERIA
                                                          AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                          where 1 = 1
                                          and sztprono_no_regla = c.SZTALIAN_NO_REGLA
                                          and sztprono_materia_legal like 'CC%'
                                          and exists(select null
                                                     from goradid
                                                     where 1 = 1
                                                     and goradid_pidm=SZTPRONO_PIDM
                                                     and GORADID_ADID_CODE ='CIFA' )
                                          union
                                          select distinct SZTGPME_SUBJ_CRSE materia,
                                                        SZTGPME_no_regla regla
                                                 from sztgpme a
                                                 join SZTALMT b on a.SZTGPME_SUBJ_CRSE = b.SZTALMT_MATERIA
                                                 --                AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                                 where 1 = 1
                                                 and SZTGPME_no_regla = p_regla
                                                 and SZTGPME_SUBJ_CRSE like 'CC%'
                                          order by 1
                                          )loop

                                                  l_contador:=0;

                                                  for x in (select *
                                                            from sztprono
                                                            where 1 = 1
                                                            and sztprono_no_regla = c.sztalian_no_regla
                                                            and sztprono_pidm = c.sztalian_pidm
                                                            )loop

                                                                l_contador:=l_contador+1;

                                                                if l_nivel ='MA' then
                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);

                                                                    begin

                                                                        select count(*)
                                                                        into l_cuenta_qali
                                                                        from SZTQALI
                                                                        where 1 = 1
                                                                        and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                        AND SZTQALI_PTRM =l_ptrm_pi
                                                                        AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                        AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                    exception when others then
                                                                        null;
                                                                    end;

                                                                    dbms_output.put_line(' Cueneta qali '||l_cuenta_qali);

                                                                    if l_cuenta_qali > 0 then

                                                                        begin

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          where 1 = 1
                                                                          and sztprono_no_regla = c.sztalian_no_regla
                                                                          and sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        begin

                                                                            insert into sztprono values(x.SZTPRONO_PIDM,
                                                                                                        x.SZTPRONO_ID,
                                                                                                        x.SZTPRONO_TERM_CODE,
                                                                                                        x.SZTPRONO_PROGRAM,
                                                                                                        d.materia,
                                                                                                        l_secuencia,
                                                                                                        x.SZTPRONO_PTRM_CODE,
                                                                                                        d.materia,
                                                                                                        'x',
                                                                                                        x.SZTPRONO_FECHA_INICIO,
                                                                                                        x.SZTPRONO_PTRM_CODE_NW,
                                                                                                        x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                        x.SZTPRONO_AVANCE,
                                                                                                        x.SZTPRONO_NO_REGLA,
                                                                                                        x.SZTPRONO_USUARIO,
                                                                                                        x.SZTPRONO_STUDY_PATH,
                                                                                                        x.SZTPRONO_RATE,
                                                                                                        x.SZTPRONO_JORNADA,
                                                                                                        x.SZTPRONO_ACTIVITY_DATE,
                                                                                                        x.SZTPRONO_CUATRI,
                                                                                                        x.SZTPRONO_TIPO_INICIO,
                                                                                                        x.SZTPRONO_JORNADA_DOS,
                                                                                                        'N',
                                                                                                        'N',
                                                                                                        x.SZTPRONO_ESTATUS,
                                                                                                        'N',
                                                                                                        null,
                                                                                                        x.SZTPRONO_GRUPO_ASIG
                                                                                                        );

                                                                        exception when others then

                                                                            dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                        end;

                                                                        begin
                                                                            UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                            where 1 = 1
                                                                            and sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                            and sztalian_pidm = x.SZTPRONO_PIDM;
                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                    end if;

                                                                else
                                                                     dbms_output.put_line( 'Entra a lic alianzas avance --> '||C.SZTALIAN_AVANCE);

                                                                   IF C.SZTALIAN_AVANCE > 1 THEN

                                                                        begin

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          where 1 = 1
                                                                          and sztprono_no_regla = c.sztalian_no_regla
                                                                          and sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        begin

                                                                            insert into sztprono values(x.SZTPRONO_PIDM,
                                                                                                        x.SZTPRONO_ID,
                                                                                                        x.SZTPRONO_TERM_CODE,
                                                                                                        x.SZTPRONO_PROGRAM,
                                                                                                        d.materia,
                                                                                                        l_secuencia,
                                                                                                        x.SZTPRONO_PTRM_CODE,
                                                                                                        d.materia,
                                                                                                        'x',
                                                                                                        x.SZTPRONO_FECHA_INICIO,
                                                                                                        x.SZTPRONO_PTRM_CODE_NW,
                                                                                                        x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                        x.SZTPRONO_AVANCE,
                                                                                                        x.SZTPRONO_NO_REGLA,
                                                                                                        x.SZTPRONO_USUARIO,
                                                                                                        x.SZTPRONO_STUDY_PATH,
                                                                                                        x.SZTPRONO_RATE,
                                                                                                        x.SZTPRONO_JORNADA,
                                                                                                        x.SZTPRONO_ACTIVITY_DATE,
                                                                                                        x.SZTPRONO_CUATRI,
                                                                                                        x.SZTPRONO_TIPO_INICIO,
                                                                                                        x.SZTPRONO_JORNADA_DOS,
                                                                                                        'N',
                                                                                                        'N',
                                                                                                        x.SZTPRONO_ESTATUS,
                                                                                                        'N',
                                                                                                        null,
                                                                                                        x.SZTPRONO_GRUPO_ASIG
                                                                                                        );

                                                                        exception when others then

                                                                            dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                        end;


                                                                        begin
                                                                            UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                            where 1 = 1
                                                                            and sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                            and sztalian_pidm = x.SZTPRONO_PIDM;
                                                                        exception when others then
                                                                            null;
                                                                        end;


                                                                   END IF;

                                                                end if;

                                                                exit when l_contador = 1;

                                                            end loop;

                                          end loop;

                              end loop;
        commit;
end if;
    end; --25038
--
--

    PROCEDURE p_cour_pidm(p_regla   NUMBER,
                          p_pidm    NUMBER)
     is
        l_avance_mayor    number;
        l_avance          number;
        l_pidm_mayor      number;
        l_materia_alianza varchar2(10):=NULL;
        l_cuenta_nivel_li     number;
        l_cuenta_nivel_ma     number;
        l_cuenta_nivel_do     number;
        l_nivel           varchar2(2);
        l_secuencia       number;
        l_contador        number:=0;
        l_contar_alumnos  number;
        l_materias_para   number;
        l_materias_alianza number;
        l_cuenta_materias number;
        l_si_unicef       number;
        l_peirod_uni      varchar2(2);
        l_ptrm_pi         varchar2(3);
        l_cuenta_qali     number;
        l_chk_ind           number:=1;
    begin

p_carrusel_pidm(p_regla,'COUR',p_pidm);

if l_chk_ind = 0 Then
      --  dbms_output.put_line('Entra a coursera -->'||1);

        begin

            select count(*)
            into l_cuenta_nivel_li
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_ma
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_do
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma > 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  if;

        delete sztalian
        where 1 = 1
        and sztalian_no_regla = p_regla
        and sztalian_pidm = p_pidm
        and SZTALIAN_ALIANZA ='COUR'
        AND sztalian_FLEX ='PR';

        for c in ( select distinct (select  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            from SMRPRLE
                            where 1 = 1
                            and SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'COUR' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
            from sztprono
            where 1 = 1
            and sztprono_no_regla = p_regla
            and sztprono_pidm = p_pidm
            AND EXISTS (SELECT NULL
                        FROM GORADID
                        WHERE 1 = 1
                        AND GORADID_PIDM = SZTPRONO_PIDM
                        AND  GORADID_ADID_CODE ='COUR')
            )loop

                dbms_output.put_line('Entra a coursera -->'||2);


                begin

                  SELECT MAX(zstpara_param_id)
                  INTO l_avance
                  FROM ZSTPARA
                  WHERE 1 = 1
                  and zstpara_mapa_id ='INSCRIPCIONES'
                  and zstpara_param_valor = c.avance
                  and zstpara_param_desc = c.tipo_inicio;

                exception when others then
                    null;
                end;


                BEGIN

                  dbms_output.put_line (' PImd '||c.pidm||' Matricula '||c.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||c.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||c.tipo_inicio);

                  INSERT INTO sztalian VALUES (c.pidm,
                                               c.matricula,
                                               c.programa,
                                               c.alianza,
                                               l_avance,
                                               c.regla,
                                               'N',
                                               nvl(l_materias_para,0),
                                               nvl(l_materias_alianza,0),
                                               c.tipo_inicio,
                                               'PR'
                                               );

                EXCEPTION WHEN OTHERS THEN
                 NULL;
                END;

                COMMIT;


            end loop;

            FOR c IN (SELECT *
                               FROM sztalian
                               where 1 = 1
                               AND sztalian_flex ='PR'
                               AND sztalian_no_regla = p_regla
                               AND sztalian_pidm = p_pidm
                               AND sztalian_alianza ='COUR'
                              )loop

                                dbms_output.put_line( 'Entra a COURSERA   --> 2' );

                                        for d in
                                      (
                                          select distinct SZTPRONO_MATERIA_LEGAL materia,
                                                          sztprono_no_regla regla
                                          from SZTPRONO a
                                          join SZTALMT b on a.SZTPRONO_MATERIA_LEGAL = b.SZTALMT_MATERIA
                                                          AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                          where 1 = 1
                                          and sztprono_no_regla = c.SZTALIAN_NO_REGLA
                                          and sztprono_materia_legal like 'COU%'
                                          and exists(select null
                                                     from goradid
                                                     where 1 = 1
                                                     and goradid_pidm=SZTPRONO_PIDM
                                                     and GORADID_ADID_CODE ='COUR' )
                                          union
                                          select distinct SZTGPME_SUBJ_CRSE materia,
                                                        SZTGPME_no_regla regla
                                                 from sztgpme a
                                                 join SZTALMT b on a.SZTGPME_SUBJ_CRSE = b.SZTALMT_MATERIA
                                                 --                AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                                 where 1 = 1
                                                 and SZTGPME_no_regla = p_regla
                                                 and SZTGPME_SUBJ_CRSE like 'COU%'
                                          order by 1
                                          )loop

                                                  l_contador:=0;

                                                  for x in (select *
                                                            from sztprono
                                                            where 1 = 1
                                                            and sztprono_no_regla = c.sztalian_no_regla
                                                            and sztprono_pidm = c.sztalian_pidm
                                                            )loop

                                                                l_contador:=l_contador+1;

                                                                if l_nivel ='MA' then
                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);

                                                                    begin
                                                                        select count(*)
                                                                        into l_cuenta_qali
                                                                        from SZTQALI
                                                                        where 1 = 1
                                                                        and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                        AND SZTQALI_PTRM =l_ptrm_pi
                                                                        AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                        AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                    exception when others then
                                                                        null;
                                                                    end;

                                                                    dbms_output.put_line(' Cueneta qali '||l_cuenta_qali);

                                                                    if l_cuenta_qali > 0 then

                                                                        begin

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          where 1 = 1
                                                                          and sztprono_no_regla = c.sztalian_no_regla
                                                                          and sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        begin

                                                                            insert into sztprono values(x.SZTPRONO_PIDM,
                                                                                                        x.SZTPRONO_ID,
                                                                                                        x.SZTPRONO_TERM_CODE,
                                                                                                        x.SZTPRONO_PROGRAM,
                                                                                                        d.materia,
                                                                                                        l_secuencia,
                                                                                                        x.SZTPRONO_PTRM_CODE,
                                                                                                        d.materia,
                                                                                                        'x',
                                                                                                        x.SZTPRONO_FECHA_INICIO,
                                                                                                        x.SZTPRONO_PTRM_CODE_NW,
                                                                                                        x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                        x.SZTPRONO_AVANCE,
                                                                                                        x.SZTPRONO_NO_REGLA,
                                                                                                        x.SZTPRONO_USUARIO,
                                                                                                        x.SZTPRONO_STUDY_PATH,
                                                                                                        x.SZTPRONO_RATE,
                                                                                                        x.SZTPRONO_JORNADA,
                                                                                                        x.SZTPRONO_ACTIVITY_DATE,
                                                                                                        x.SZTPRONO_CUATRI,
                                                                                                        x.SZTPRONO_TIPO_INICIO,
                                                                                                        x.SZTPRONO_JORNADA_DOS,
                                                                                                        'N',
                                                                                                        'N',
                                                                                                        x.SZTPRONO_ESTATUS,
                                                                                                        'N',
                                                                                                        null,
                                                                                                        x.SZTPRONO_GRUPO_ASIG
                                                                                                        );

                                                                        exception when others then

                                                                            dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                        end;

                                                                        begin
                                                                            UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                            where 1 = 1
                                                                            and sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                            and sztalian_pidm = x.SZTPRONO_PIDM;
                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                    end if;

                                                                else

                                                                     dbms_output.put_line( 'Entra a lic alianzas avance --> '||C.SZTALIAN_AVANCE);

                                                                   IF C.SZTALIAN_AVANCE >2 THEN

                                                                        begin

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          where 1 = 1
                                                                          and sztprono_no_regla = c.sztalian_no_regla
                                                                          and sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        begin

                                                                            insert into sztprono values(x.SZTPRONO_PIDM,
                                                                                                        x.SZTPRONO_ID,
                                                                                                        x.SZTPRONO_TERM_CODE,
                                                                                                        x.SZTPRONO_PROGRAM,
                                                                                                        d.materia,
                                                                                                        l_secuencia,
                                                                                                        x.SZTPRONO_PTRM_CODE,
                                                                                                        d.materia,
                                                                                                        'x',
                                                                                                        x.SZTPRONO_FECHA_INICIO,
                                                                                                        x.SZTPRONO_PTRM_CODE_NW,
                                                                                                        x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                        x.SZTPRONO_AVANCE,
                                                                                                        x.SZTPRONO_NO_REGLA,
                                                                                                        x.SZTPRONO_USUARIO,
                                                                                                        x.SZTPRONO_STUDY_PATH,
                                                                                                        x.SZTPRONO_RATE,
                                                                                                        x.SZTPRONO_JORNADA,
                                                                                                        x.SZTPRONO_ACTIVITY_DATE,
                                                                                                        x.SZTPRONO_CUATRI,
                                                                                                        x.SZTPRONO_TIPO_INICIO,
                                                                                                        x.SZTPRONO_JORNADA_DOS,
                                                                                                        'N',
                                                                                                        'N',
                                                                                                        x.SZTPRONO_ESTATUS,
                                                                                                        'N',
                                                                                                        null,
                                                                                                        x.SZTPRONO_GRUPO_ASIG
                                                                                                        );

                                                                        exception when others then

                                                                            dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                        end;


                                                                        begin
                                                                            UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                            where 1 = 1
                                                                            and sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                            and sztalian_pidm = x.SZTPRONO_PIDM;
                                                                        exception when others then
                                                                            null;
                                                                        end;


                                                                   END IF;

                                                                end if;

                                                                exit when l_contador = 1;

                                                            end loop;

                                          end loop;

                              end loop;
        commit;
END IF;
    end; --25038
--
--
    PROCEDURE p_gads_pidm(p_regla   NUMBER,
                          p_pidm    NUMBER)
     is
        l_avance_mayor    number;
        l_avance          number;
        l_pidm_mayor      number;
        l_materia_alianza varchar2(10):=NULL;
        l_cuenta_nivel_li     number;
        l_cuenta_nivel_ma     number;
        l_cuenta_nivel_do     number;
        l_nivel           varchar2(2);
        l_secuencia       number;
        l_contador        number:=0;
        l_contar_alumnos  number;
        l_materias_para   number;
        l_materias_alianza number;
        l_cuenta_materias number;
        l_si_unicef       number;
        l_peirod_uni      varchar2(2);
        l_ptrm_pi         varchar2(3);
        l_cuenta_qali     number;
        l_chk_ind           number:=1;
    begin

p_carrusel_pidm(p_regla,'GADS',p_pidm);

if l_chk_ind = 0 Then
        begin

            select count(*)
            into l_cuenta_nivel_li
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_ma
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_do
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma > 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  if;

        delete sztalian
        where 1 = 1
        and sztalian_no_regla = p_regla
        and sztalian_pidm = p_pidm
        and SZTALIAN_ALIANZA ='GADS'
        AND sztalian_FLEX ='PR';

        for c in ( select distinct (select  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            from SMRPRLE
                            where 1 = 1
                            and SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'GADS' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
            from sztprono
            where 1 = 1
            and sztprono_no_regla = p_regla
            and sztprono_pidm = p_pidm
            AND EXISTS (SELECT NULL
                        FROM GORADID
                        WHERE 1 = 1
                        AND GORADID_PIDM = SZTPRONO_PIDM
                        AND  GORADID_ADID_CODE ='GADS')
            )loop


                begin

                  SELECT MAX(zstpara_param_id)
                  INTO l_avance
                  FROM ZSTPARA
                  WHERE 1 = 1
                  and zstpara_mapa_id ='INSCRIPCIONES'
                  and zstpara_param_valor = c.avance
                  and zstpara_param_desc = c.tipo_inicio;

                exception when others then
                    null;
                end;


                BEGIN

                 --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                  INSERT INTO sztalian VALUES (c.pidm,
                                               c.matricula,
                                               c.programa,
                                               c.alianza,
                                               l_avance,
                                               c.regla,
                                               'N',
                                               nvl(l_materias_para,0),
                                               nvl(l_materias_alianza,0),
                                               c.tipo_inicio,
                                               'PR'
                                               );

                EXCEPTION WHEN OTHERS THEN
                 NULL;
                END;

                COMMIT;


            end loop;

             FOR c IN (SELECT *
                       FROM sztalian
                       where 1 = 1
                       AND sztalian_flex ='PR'
                       AND sztalian_no_regla = p_regla
                       AND sztalian_pidm = p_pidm
                       and SZTALIAN_ALIANZA ='GADS'
                       )loop

                            for d in
                                      (
                                          select distinct SZTPRONO_MATERIA_LEGAL materia,
                                                          sztprono_no_regla regla
                                          from SZTPRONO a
                                          join SZTALMT b on a.SZTPRONO_MATERIA_LEGAL = b.SZTALMT_MATERIA
                                                          AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                          where 1 = 1
                                          and sztprono_no_regla = c.SZTALIAN_NO_REGLA
                                          and sztprono_materia_legal like 'GOOG%'
                                          and exists(select null
                                                     from goradid
                                                     where 1 = 1
                                                     and goradid_pidm=SZTPRONO_PIDM
                                                     and GORADID_ADID_CODE ='GADS' )
                                          union
                                          select distinct SZTGPME_SUBJ_CRSE materia,
                                                        SZTGPME_no_regla regla
                                                 from sztgpme a
                                                 join SZTALMT b on a.SZTGPME_SUBJ_CRSE = b.SZTALMT_MATERIA
                                                 --                AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                                 where 1 = 1
                                                 and SZTGPME_no_regla = p_regla
                                                 and SZTGPME_SUBJ_CRSE like 'GOOG%'
                                          order by 1
                                          )loop

                                                  l_contador:=0;

                                                   for x in (select *
                                                            from sztprono
                                                            where 1 = 1
                                                            and sztprono_no_regla = c.sztalian_no_regla
                                                            and sztprono_pidm = c.sztalian_pidm
                    --                                        and sztprono_id ='010000758'
                                                            )loop

                                                                l_contador:=l_contador+1;

                                                                if l_nivel ='MA' then
                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);

                                                                    begin

                                                                        select count(*)
                                                                        into l_cuenta_qali
                                                                        from SZTQALI
                                                                        where 1 = 1
                                                                        and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                        AND SZTQALI_PTRM =l_ptrm_pi
                                                                        AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                        AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                    exception when others then
                                                                        null;
                                                                    end;

                                                                    dbms_output.put_line(' Cueneta qali '||l_cuenta_qali);

                                                                    if l_cuenta_qali > 0 then

                                                                        begin

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          where 1 = 1
                                                                          and sztprono_no_regla = c.sztalian_no_regla
                                                                          and sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        begin

                                                                            insert into sztprono values(x.SZTPRONO_PIDM,
                                                                                                        x.SZTPRONO_ID,
                                                                                                        x.SZTPRONO_TERM_CODE,
                                                                                                        x.SZTPRONO_PROGRAM,
                                                                                                        d.materia,
                                                                                                        l_secuencia,
                                                                                                        x.SZTPRONO_PTRM_CODE,
                                                                                                        d.materia,
                                                                                                        'x',
                                                                                                        x.SZTPRONO_FECHA_INICIO,
                                                                                                        x.SZTPRONO_PTRM_CODE_NW,
                                                                                                        x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                        x.SZTPRONO_AVANCE,
                                                                                                        x.SZTPRONO_NO_REGLA,
                                                                                                        x.SZTPRONO_USUARIO,
                                                                                                        x.SZTPRONO_STUDY_PATH,
                                                                                                        x.SZTPRONO_RATE,
                                                                                                        x.SZTPRONO_JORNADA,
                                                                                                        x.SZTPRONO_ACTIVITY_DATE,
                                                                                                        x.SZTPRONO_CUATRI,
                                                                                                        x.SZTPRONO_TIPO_INICIO,
                                                                                                        x.SZTPRONO_JORNADA_DOS,
                                                                                                        'N',
                                                                                                        'N',
                                                                                                        x.SZTPRONO_ESTATUS,
                                                                                                        'N',
                                                                                                        null,
                                                                                                        x.SZTPRONO_GRUPO_ASIG
                                                                                                        );

                                                                        exception when others then

                                                                            dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                        end;

                                                                        begin
                                                                            UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                            where 1 = 1
                                                                            and sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                            and sztalian_pidm = x.SZTPRONO_PIDM
                                                                            AND SZTALIAN_ALIANZA='FCBK';
                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                    end if;

                                                                else

                                                                   IF C.SZTALIAN_AVANCE IN (5,7) THEN

                                                                        begin

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          where 1 = 1
                                                                          and sztprono_no_regla = c.sztalian_no_regla
                                                                          and sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        begin

                                                                            insert into sztprono values(x.SZTPRONO_PIDM,
                                                                                                        x.SZTPRONO_ID,
                                                                                                        x.SZTPRONO_TERM_CODE,
                                                                                                        x.SZTPRONO_PROGRAM,
                                                                                                        d.materia,
                                                                                                        l_secuencia,
                                                                                                        x.SZTPRONO_PTRM_CODE,
                                                                                                        d.materia,
                                                                                                        'x',
                                                                                                        x.SZTPRONO_FECHA_INICIO,
                                                                                                        x.SZTPRONO_PTRM_CODE_NW,
                                                                                                        x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                        x.SZTPRONO_AVANCE,
                                                                                                        x.SZTPRONO_NO_REGLA,
                                                                                                        x.SZTPRONO_USUARIO,
                                                                                                        x.SZTPRONO_STUDY_PATH,
                                                                                                        x.SZTPRONO_RATE,
                                                                                                        x.SZTPRONO_JORNADA,
                                                                                                        x.SZTPRONO_ACTIVITY_DATE,
                                                                                                        x.SZTPRONO_CUATRI,
                                                                                                        x.SZTPRONO_TIPO_INICIO,
                                                                                                        x.SZTPRONO_JORNADA_DOS,
                                                                                                        'N',
                                                                                                        'N',
                                                                                                        x.SZTPRONO_ESTATUS,
                                                                                                        'N',
                                                                                                        null,
                                                                                                        x.SZTPRONO_GRUPO_ASIG
                                                                                                        );

                                                                        exception when others then

                                                                            dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                        end;

                                                                        begin
                                                                            UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                            where 1 = 1
                                                                            and sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                            and sztalian_pidm = x.SZTPRONO_PIDM
                                                                            AND SZTALIAN_ALIANZA='GADS';
                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                   END IF;

                                                                end if;

                                                                exit when l_contador = 1;

                                                            end loop;


                                          end loop;

                       end loop;
        commit;
END IF;
    end;
--
--
    PROCEDURE p_micr_pidm(p_regla   NUMBER,
                          p_pidm    NUMBER)
     is
        l_avance_mayor    number;
        l_avance          number;
        l_pidm_mayor      number;
        l_materia_alianza varchar2(10):=NULL;
        l_cuenta_nivel_li     number;
        l_cuenta_nivel_ma     number;
        l_cuenta_nivel_do     number;
        l_nivel           varchar2(2);
        l_secuencia       number;
        l_contador        number:=0;
        l_contar_alumnos  number;
        l_materias_para   number;
        l_materias_alianza number;
        l_cuenta_materias number;
        l_si_unicef       number;
        l_peirod_uni      varchar2(2);
        l_ptrm_pi         varchar2(3);
        l_cuenta_qali     number;
        l_chk_ind           number:=1;
    begin

p_carrusel_pidm(p_regla,'MICR',p_pidm);

if l_chk_ind = 0 Then
        begin

            select count(*)
            into l_cuenta_nivel_li
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_ma
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_do
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma > 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  if;

        delete sztalian
        where 1 = 1
        and sztalian_no_regla = p_regla
        and sztalian_pidm = p_pidm
        and SZTALIAN_ALIANZA ='MICR'
        AND sztalian_FLEX ='PR';

        for c in ( select distinct (select  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            from SMRPRLE
                            where 1 = 1
                            and SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'MICR' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
            from sztprono
            where 1 = 1
            and sztprono_no_regla = p_regla
            and sztprono_pidm = p_pidm
            AND EXISTS (SELECT NULL
                        FROM GORADID
                        WHERE 1 = 1
                        AND GORADID_PIDM = SZTPRONO_PIDM
                        AND  GORADID_ADID_CODE ='MICR')
            )loop


                begin

                  SELECT MAX(zstpara_param_id)
                  INTO l_avance
                  FROM ZSTPARA
                  WHERE 1 = 1
                  and zstpara_mapa_id ='INSCRIPCIONES'
                  and zstpara_param_valor = c.avance
                  and zstpara_param_desc = c.tipo_inicio;

                exception when others then
                    null;
                end;


                BEGIN

                 --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                  INSERT INTO sztalian VALUES (c.pidm,
                                               c.matricula,
                                               c.programa,
                                               c.alianza,
                                               l_avance,
                                               c.regla,
                                               'N',
                                               nvl(l_materias_para,0),
                                               nvl(l_materias_alianza,0),
                                               c.tipo_inicio,
                                               'PR'
                                               );

                EXCEPTION WHEN OTHERS THEN
                 NULL;
                END;

                COMMIT;


            end loop;

             FOR c IN (SELECT *
                       FROM sztalian
                       where 1 = 1
                       AND sztalian_flex ='PR'
                       AND sztalian_no_regla = p_regla
                       AND sztalian_pidm = p_pidm
                       and SZTALIAN_ALIANZA ='MICR'
                       )loop

                            for d in
                                      (
                                          select distinct SZTPRONO_MATERIA_LEGAL materia,
                                                          sztprono_no_regla regla
                                          from SZTPRONO a
                                          join SZTALMT b on a.SZTPRONO_MATERIA_LEGAL = b.SZTALMT_MATERIA
                                                          AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                          where 1 = 1
                                          and sztprono_no_regla = c.SZTALIAN_NO_REGLA
                                          and sztprono_materia_legal like 'MO%'
                                          and exists(select null
                                                     from goradid
                                                     where 1 = 1
                                                     and goradid_pidm=SZTPRONO_PIDM
                                                     and GORADID_ADID_CODE ='MICR' )
                                          union
                                          select distinct SZTGPME_SUBJ_CRSE materia,
                                                        SZTGPME_no_regla regla
                                                 from sztgpme a
                                                 join SZTALMT b on a.SZTGPME_SUBJ_CRSE = b.SZTALMT_MATERIA
                                                 --                AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                                 where 1 = 1
                                                 and SZTGPME_no_regla = p_regla
                                                 and SZTGPME_SUBJ_CRSE like 'MO%'
                                          order by 1
                                          )loop

                                                  l_contador:=0;

                                                   for x in (select *
                                                            from sztprono
                                                            where 1 = 1
                                                            and sztprono_no_regla = c.sztalian_no_regla
                                                            and sztprono_pidm = c.sztalian_pidm
                    --                                        and sztprono_id ='010000758'
                                                            )loop

                                                                l_contador:=l_contador+1;

                                                                if l_nivel ='MA' then
                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);
                                                                    begin

                                                                        select count(*)
                                                                        into l_cuenta_qali
                                                                        from SZTQALI
                                                                        where 1 = 1
                                                                        and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                        AND SZTQALI_PTRM =l_ptrm_pi
                                                                        AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                        AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                    exception when others then
                                                                        null;
                                                                    end;

                                                                    dbms_output.put_line(' Cueneta qali '||l_cuenta_qali);

                                                                    if l_cuenta_qali > 0 then

                                                                        begin

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          where 1 = 1
                                                                          and sztprono_no_regla = c.sztalian_no_regla
                                                                          and sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        begin

                                                                            insert into sztprono values(x.SZTPRONO_PIDM,
                                                                                                        x.SZTPRONO_ID,
                                                                                                        x.SZTPRONO_TERM_CODE,
                                                                                                        x.SZTPRONO_PROGRAM,
                                                                                                        d.materia,
                                                                                                        l_secuencia,
                                                                                                        x.SZTPRONO_PTRM_CODE,
                                                                                                        d.materia,
                                                                                                        'x',
                                                                                                        x.SZTPRONO_FECHA_INICIO,
                                                                                                        x.SZTPRONO_PTRM_CODE_NW,
                                                                                                        x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                        x.SZTPRONO_AVANCE,
                                                                                                        x.SZTPRONO_NO_REGLA,
                                                                                                        x.SZTPRONO_USUARIO,
                                                                                                        x.SZTPRONO_STUDY_PATH,
                                                                                                        x.SZTPRONO_RATE,
                                                                                                        x.SZTPRONO_JORNADA,
                                                                                                        x.SZTPRONO_ACTIVITY_DATE,
                                                                                                        x.SZTPRONO_CUATRI,
                                                                                                        x.SZTPRONO_TIPO_INICIO,
                                                                                                        x.SZTPRONO_JORNADA_DOS,
                                                                                                        'N',
                                                                                                        'N',
                                                                                                        x.SZTPRONO_ESTATUS,
                                                                                                        'N',
                                                                                                        null,
                                                                                                        x.SZTPRONO_GRUPO_ASIG
                                                                                                        );

                                                                        exception when others then

                                                                            dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                        end;

                                                                        begin
                                                                            UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                            where 1 = 1
                                                                            and sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                            and sztalian_pidm = x.SZTPRONO_PIDM
                                                                            AND SZTALIAN_ALIANZA='MICR';
                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                    end if;

                                                                else

                                                                   IF C.SZTALIAN_AVANCE IN (3) THEN

                                                                        begin

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          where 1 = 1
                                                                          and sztprono_no_regla = c.sztalian_no_regla
                                                                          and sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        begin

                                                                            insert into sztprono values(x.SZTPRONO_PIDM,
                                                                                                        x.SZTPRONO_ID,
                                                                                                        x.SZTPRONO_TERM_CODE,
                                                                                                        x.SZTPRONO_PROGRAM,
                                                                                                        d.materia,
                                                                                                        l_secuencia,
                                                                                                        x.SZTPRONO_PTRM_CODE,
                                                                                                        d.materia,
                                                                                                        'x',
                                                                                                        x.SZTPRONO_FECHA_INICIO,
                                                                                                        x.SZTPRONO_PTRM_CODE_NW,
                                                                                                        x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                        x.SZTPRONO_AVANCE,
                                                                                                        x.SZTPRONO_NO_REGLA,
                                                                                                        x.SZTPRONO_USUARIO,
                                                                                                        x.SZTPRONO_STUDY_PATH,
                                                                                                        x.SZTPRONO_RATE,
                                                                                                        x.SZTPRONO_JORNADA,
                                                                                                        x.SZTPRONO_ACTIVITY_DATE,
                                                                                                        x.SZTPRONO_CUATRI,
                                                                                                        x.SZTPRONO_TIPO_INICIO,
                                                                                                        x.SZTPRONO_JORNADA_DOS,
                                                                                                        'N',
                                                                                                        'N',
                                                                                                        x.SZTPRONO_ESTATUS,
                                                                                                        'N',
                                                                                                        null,
                                                                                                        x.SZTPRONO_GRUPO_ASIG
                                                                                                        );

                                                                        exception when others then

                                                                            dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                        end;

                                                                        begin
                                                                            UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                            where 1 = 1
                                                                            and sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                            and sztalian_pidm = x.SZTPRONO_PIDM
                                                                            AND SZTALIAN_ALIANZA='MICR';
                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                   END IF;

                                                                end if;

                                                                exit when l_contador = 1;

                                                            end loop;


                                          end loop;

                       end loop;
        commit;
END IF;
    end;
--
--
    PROCEDURE p_tabl_pidm(p_regla   NUMBER,
                          p_pidm    NUMBER)
     is
        l_avance_mayor    number;
        l_avance          number;
        l_pidm_mayor      number;
        l_materia_alianza varchar2(10):=NULL;
        l_cuenta_nivel_li     number;
        l_cuenta_nivel_ma     number;
        l_cuenta_nivel_do     number;
        l_nivel           varchar2(2);
        l_secuencia       number;
        l_contador        number:=0;
        l_contar_alumnos  number;
        l_materias_para   number;
        l_materias_alianza number;
        l_cuenta_materias number;
        l_si_unicef       number;
        l_peirod_uni      varchar2(2);
        l_ptrm_pi         varchar2(3);
        l_cuenta_qali     number;
        l_chk_ind           number:=1;
    begin

p_carrusel_pidm(p_regla,'TABL',p_pidm);

if l_chk_ind = 0 Then
        begin

            select count(*)
            into l_cuenta_nivel_li
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_ma
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_do
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma > 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  if;

        delete sztalian
        where 1 = 1
        and sztalian_no_regla = p_regla
        and sztalian_pidm = p_pidm
        and SZTALIAN_ALIANZA ='TABL'
        AND sztalian_FLEX ='PR';

        for c in ( select distinct (select  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            from SMRPRLE
                            where 1 = 1
                            and SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'TABL' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
            from sztprono
            where 1 = 1
            and sztprono_no_regla = p_regla
            and sztprono_pidm = p_pidm
            AND EXISTS (SELECT NULL
                        FROM GORADID
                        WHERE 1 = 1
                        AND GORADID_PIDM = SZTPRONO_PIDM
                        AND  GORADID_ADID_CODE ='TABL')
            )loop


                begin

                  SELECT MAX(zstpara_param_id)
                  INTO l_avance
                  FROM ZSTPARA
                  WHERE 1 = 1
                  and zstpara_mapa_id ='INSCRIPCIONES'
                  and zstpara_param_valor = c.avance
                  and zstpara_param_desc = c.tipo_inicio;

                exception when others then
                    null;
                end;


                BEGIN

                 --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                  INSERT INTO sztalian VALUES (c.pidm,
                                               c.matricula,
                                               c.programa,
                                               c.alianza,
                                               l_avance,
                                               c.regla,
                                               'N',
                                               nvl(l_materias_para,0),
                                               nvl(l_materias_alianza,0),
                                               c.tipo_inicio,
                                               'PR'
                                               );

                EXCEPTION WHEN OTHERS THEN
                 NULL;
                END;

                COMMIT;


            end loop;

             FOR c IN (SELECT *
                       FROM sztalian
                       where 1 = 1
                       AND sztalian_flex ='PR'
                       AND sztalian_no_regla = p_regla
                       AND sztalian_pidm = p_pidm
                       and SZTALIAN_ALIANZA ='TABL'
                       )loop

                            for d in
                                      (
                                          select distinct SZTPRONO_MATERIA_LEGAL materia,
                                                          sztprono_no_regla regla
                                          from SZTPRONO a
                                          join SZTALMT b on a.SZTPRONO_MATERIA_LEGAL = b.SZTALMT_MATERIA
                                                          AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                          where 1 = 1
                                          and sztprono_no_regla = c.SZTALIAN_NO_REGLA
                                          and sztprono_materia_legal like 'TAB%'
                                          and exists(select null
                                                     from goradid
                                                     where 1 = 1
                                                     and goradid_pidm=SZTPRONO_PIDM
                                                     and GORADID_ADID_CODE ='TABL' )
                                          union
                                          select distinct SZTGPME_SUBJ_CRSE materia,
                                                        SZTGPME_no_regla regla
                                                 from sztgpme a
                                                 join SZTALMT b on a.SZTGPME_SUBJ_CRSE = b.SZTALMT_MATERIA
                                                 --                AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                                 where 1 = 1
                                                 and SZTGPME_no_regla = p_regla
                                                 and SZTGPME_SUBJ_CRSE like 'TAB%'
                                          order by 1
                                          )loop

                                                  l_contador:=0;

                                                   for x in (select *
                                                            from sztprono
                                                            where 1 = 1
                                                            and sztprono_no_regla = c.sztalian_no_regla
                                                            and sztprono_pidm = c.sztalian_pidm
                    --                                        and sztprono_id ='010000758'
                                                            )loop

                                                                l_contador:=l_contador+1;

                                                                if l_nivel ='MA' then

                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);

                                                                    begin

                                                                        select count(*)
                                                                        into l_cuenta_qali
                                                                        from SZTQALI
                                                                        where 1 = 1
                                                                        and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                        AND SZTQALI_PTRM =l_ptrm_pi
                                                                        AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                        AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                    exception when others then
                                                                        null;
                                                                    end;

                                                                    dbms_output.put_line(' Cueneta qali '||l_cuenta_qali);

                                                                    if l_cuenta_qali > 0 then

                                                                        begin

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          where 1 = 1
                                                                          and sztprono_no_regla = c.sztalian_no_regla
                                                                          and sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        begin

                                                                            insert into sztprono values(x.SZTPRONO_PIDM,
                                                                                                        x.SZTPRONO_ID,
                                                                                                        x.SZTPRONO_TERM_CODE,
                                                                                                        x.SZTPRONO_PROGRAM,
                                                                                                        d.materia,
                                                                                                        l_secuencia,
                                                                                                        x.SZTPRONO_PTRM_CODE,
                                                                                                        d.materia,
                                                                                                        'x',
                                                                                                        x.SZTPRONO_FECHA_INICIO,
                                                                                                        x.SZTPRONO_PTRM_CODE_NW,
                                                                                                        x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                        x.SZTPRONO_AVANCE,
                                                                                                        x.SZTPRONO_NO_REGLA,
                                                                                                        x.SZTPRONO_USUARIO,
                                                                                                        x.SZTPRONO_STUDY_PATH,
                                                                                                        x.SZTPRONO_RATE,
                                                                                                        x.SZTPRONO_JORNADA,
                                                                                                        x.SZTPRONO_ACTIVITY_DATE,
                                                                                                        x.SZTPRONO_CUATRI,
                                                                                                        x.SZTPRONO_TIPO_INICIO,
                                                                                                        x.SZTPRONO_JORNADA_DOS,
                                                                                                        'N',
                                                                                                        'N',
                                                                                                        x.SZTPRONO_ESTATUS,
                                                                                                        'N',
                                                                                                        null,
                                                                                                        x.SZTPRONO_GRUPO_ASIG
                                                                                                        );

                                                                        exception when others then

                                                                            dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                        end;

                                                                        begin
                                                                            UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                            where 1 = 1
                                                                            and sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                            and sztalian_pidm = x.SZTPRONO_PIDM
                                                                            AND SZTALIAN_ALIANZA='TABL';
                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                    end if;

                                                                else

                                                                   IF C.SZTALIAN_AVANCE in (3,4,5,6) THEN

                                                                        begin

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          where 1 = 1
                                                                          and sztprono_no_regla = c.sztalian_no_regla
                                                                          and sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        begin

                                                                            insert into sztprono values(x.SZTPRONO_PIDM,
                                                                                                        x.SZTPRONO_ID,
                                                                                                        x.SZTPRONO_TERM_CODE,
                                                                                                        x.SZTPRONO_PROGRAM,
                                                                                                        d.materia,
                                                                                                        l_secuencia,
                                                                                                        x.SZTPRONO_PTRM_CODE,
                                                                                                        d.materia,
                                                                                                        'x',
                                                                                                        x.SZTPRONO_FECHA_INICIO,
                                                                                                        x.SZTPRONO_PTRM_CODE_NW,
                                                                                                        x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                        x.SZTPRONO_AVANCE,
                                                                                                        x.SZTPRONO_NO_REGLA,
                                                                                                        x.SZTPRONO_USUARIO,
                                                                                                        x.SZTPRONO_STUDY_PATH,
                                                                                                        x.SZTPRONO_RATE,
                                                                                                        x.SZTPRONO_JORNADA,
                                                                                                        x.SZTPRONO_ACTIVITY_DATE,
                                                                                                        x.SZTPRONO_CUATRI,
                                                                                                        x.SZTPRONO_TIPO_INICIO,
                                                                                                        x.SZTPRONO_JORNADA_DOS,
                                                                                                        'N',
                                                                                                        'N',
                                                                                                        x.SZTPRONO_ESTATUS,
                                                                                                        'N',
                                                                                                        null,
                                                                                                        x.SZTPRONO_GRUPO_ASIG
                                                                                                        );

                                                                        exception when others then

                                                                            dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                        end;

                                                                        begin
                                                                            UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                            where 1 = 1
                                                                            and sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                            and sztalian_pidm = x.SZTPRONO_PIDM
                                                                            AND SZTALIAN_ALIANZA='TABL';
                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                   END IF;

                                                                end if;

                                                                exit when l_contador = 1;

                                                            end loop;


                                          end loop;

                       end loop;
        commit;
END IF;
    end;
--
--
    PROCEDURE p_clou_pidm(p_regla   NUMBER,
                          p_pidm    NUMBER)
     is
        l_avance_mayor    number;
        l_avance          number;
        l_pidm_mayor      number;
        l_materia_alianza varchar2(10):=NULL;
        l_cuenta_nivel_li     number;
        l_cuenta_nivel_ma     number;
        l_cuenta_nivel_do     number;
        l_nivel           varchar2(2);
        l_secuencia       number;
        l_contador        number:=0;
        l_contar_alumnos  number;
        l_materias_para   number;
        l_materias_alianza number;
        l_cuenta_materias number;
        l_si_unicef       number;
        l_peirod_uni      varchar2(2);
        l_ptrm_pi         varchar2(3);
        l_cuenta_qali     number;
        l_chk_ind           number:=1;
    begin

p_carrusel_pidm(p_regla,'CLOU',p_pidm);

if l_chk_ind = 0 Then
        begin

            select count(*)
            into l_cuenta_nivel_li
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_ma
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        begin

            select count(*)
            into l_cuenta_nivel_do
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla
            and SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma > 0 and l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsif l_cuenta_nivel_li = 0 and l_cuenta_nivel_ma = 0 and l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  if;

        delete sztalian
        where 1 = 1
        and sztalian_no_regla = p_regla
        and sztalian_pidm = p_pidm
        and SZTALIAN_ALIANZA ='CLOU'
        AND sztalian_FLEX ='PR';

        for c in ( select distinct (select  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            from SMRPRLE
                            where 1 = 1
                            and SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'CLOU' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
            from sztprono
            where 1 = 1
            and sztprono_no_regla = p_regla
            and sztprono_pidm = p_pidm
            AND EXISTS (SELECT NULL
                        FROM GORADID
                        WHERE 1 = 1
                        AND GORADID_PIDM = SZTPRONO_PIDM
                        AND  GORADID_ADID_CODE ='CLOU')
            )loop


                begin

                  SELECT MAX(zstpara_param_id)
                  INTO l_avance
                  FROM ZSTPARA
                  WHERE 1 = 1
                  and zstpara_mapa_id ='INSCRIPCIONES'
                  and zstpara_param_valor = c.avance
                  and zstpara_param_desc = c.tipo_inicio;

                exception when others then
                    null;
                end;


                BEGIN

                 --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                  INSERT INTO sztalian VALUES (c.pidm,
                                               c.matricula,
                                               c.programa,
                                               c.alianza,
                                               l_avance,
                                               c.regla,
                                               'N',
                                               nvl(l_materias_para,0),
                                               nvl(l_materias_alianza,0),
                                               c.tipo_inicio,
                                               'PR'
                                               );

                EXCEPTION WHEN OTHERS THEN
                 NULL;
                END;

                COMMIT;


            end loop;

             FOR c IN (SELECT *
                       FROM sztalian
                       where 1 = 1
                       AND sztalian_flex ='PR'
                       AND sztalian_no_regla = p_regla
                       AND sztalian_pidm = p_pidm
                       and SZTALIAN_ALIANZA ='CLOU'
                       )loop

                            for d in
                                      (
                                          select distinct SZTPRONO_MATERIA_LEGAL materia,
                                                          sztprono_no_regla regla
                                          from SZTPRONO a
                                          join SZTALMT b on a.SZTPRONO_MATERIA_LEGAL = b.SZTALMT_MATERIA
                                                          AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                          where 1 = 1
                                          and sztprono_no_regla = c.SZTALIAN_NO_REGLA
                                          and sztprono_materia_legal like 'CASS%'
                                          and exists(select null
                                                     from goradid
                                                     where 1 = 1
                                                     and goradid_pidm=SZTPRONO_PIDM
                                                     and GORADID_ADID_CODE ='TABL' )
                                          union
                                          select distinct SZTGPME_SUBJ_CRSE materia,
                                                        SZTGPME_no_regla regla
                                                 from sztgpme a
                                                 join SZTALMT b on a.SZTGPME_SUBJ_CRSE = b.SZTALMT_MATERIA
                                                 --                AND substr(a.sztprono_program,4,2) = b.sztalmt_nivel
                                                 where 1 = 1
                                                 and SZTGPME_no_regla = p_regla
                                                 and SZTGPME_SUBJ_CRSE like 'CASS%'
                                          order by 1
                                          )loop

                                                  l_contador:=0;

                                                   for x in (select *
                                                            from sztprono
                                                            where 1 = 1
                                                            and sztprono_no_regla = c.sztalian_no_regla
                                                            and sztprono_pidm = c.sztalian_pidm
                    --                                        and sztprono_id ='010000758'
                                                            )loop

                                                                l_contador:=l_contador+1;

                                                                if l_nivel ='MA' then
                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);
                                                                    begin

                                                                        select count(*)
                                                                        into l_cuenta_qali
                                                                        from SZTQALI
                                                                        where 1 = 1
                                                                        and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                        AND SZTQALI_PTRM =l_ptrm_pi
                                                                        AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                        AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                    exception when others then
                                                                        null;
                                                                    end;

                                                                    dbms_output.put_line(' Cueneta qali '||l_cuenta_qali);

                                                                    if l_cuenta_qali > 0 then

                                                                        begin

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          where 1 = 1
                                                                          and sztprono_no_regla = c.sztalian_no_regla
                                                                          and sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        begin

                                                                            insert into sztprono values(x.SZTPRONO_PIDM,
                                                                                                        x.SZTPRONO_ID,
                                                                                                        x.SZTPRONO_TERM_CODE,
                                                                                                        x.SZTPRONO_PROGRAM,
                                                                                                        d.materia,
                                                                                                        l_secuencia,
                                                                                                        x.SZTPRONO_PTRM_CODE,
                                                                                                        d.materia,
                                                                                                        'x',
                                                                                                        x.SZTPRONO_FECHA_INICIO,
                                                                                                        x.SZTPRONO_PTRM_CODE_NW,
                                                                                                        x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                        x.SZTPRONO_AVANCE,
                                                                                                        x.SZTPRONO_NO_REGLA,
                                                                                                        x.SZTPRONO_USUARIO,
                                                                                                        x.SZTPRONO_STUDY_PATH,
                                                                                                        x.SZTPRONO_RATE,
                                                                                                        x.SZTPRONO_JORNADA,
                                                                                                        x.SZTPRONO_ACTIVITY_DATE,
                                                                                                        x.SZTPRONO_CUATRI,
                                                                                                        x.SZTPRONO_TIPO_INICIO,
                                                                                                        x.SZTPRONO_JORNADA_DOS,
                                                                                                        'N',
                                                                                                        'N',
                                                                                                        x.SZTPRONO_ESTATUS,
                                                                                                        'N',
                                                                                                        null,
                                                                                                        x.SZTPRONO_GRUPO_ASIG
                                                                                                        );

                                                                        exception when others then

                                                                            dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                        end;

                                                                        begin
                                                                            UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                            where 1 = 1
                                                                            and sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                            and sztalian_pidm = x.SZTPRONO_PIDM
                                                                            AND SZTALIAN_ALIANZA='CLOU';
                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                    end if;

                                                                else

                                                                   IF C.SZTALIAN_AVANCE IN (2,3) THEN

                                                                        begin

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          where 1 = 1
                                                                          and sztprono_no_regla = c.sztalian_no_regla
                                                                          and sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        begin

                                                                            insert into sztprono values(x.SZTPRONO_PIDM,
                                                                                                        x.SZTPRONO_ID,
                                                                                                        x.SZTPRONO_TERM_CODE,
                                                                                                        x.SZTPRONO_PROGRAM,
                                                                                                        d.materia,
                                                                                                        l_secuencia,
                                                                                                        x.SZTPRONO_PTRM_CODE,
                                                                                                        d.materia,
                                                                                                        'x',
                                                                                                        x.SZTPRONO_FECHA_INICIO,
                                                                                                        x.SZTPRONO_PTRM_CODE_NW,
                                                                                                        x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                        x.SZTPRONO_AVANCE,
                                                                                                        x.SZTPRONO_NO_REGLA,
                                                                                                        x.SZTPRONO_USUARIO,
                                                                                                        x.SZTPRONO_STUDY_PATH,
                                                                                                        x.SZTPRONO_RATE,
                                                                                                        x.SZTPRONO_JORNADA,
                                                                                                        x.SZTPRONO_ACTIVITY_DATE,
                                                                                                        x.SZTPRONO_CUATRI,
                                                                                                        x.SZTPRONO_TIPO_INICIO,
                                                                                                        x.SZTPRONO_JORNADA_DOS,
                                                                                                        'N',
                                                                                                        'N',
                                                                                                        x.SZTPRONO_ESTATUS,
                                                                                                        'N',
                                                                                                        null,
                                                                                                        x.SZTPRONO_GRUPO_ASIG
                                                                                                        );

                                                                        exception when others then

                                                                            dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                        end;

                                                                        begin
                                                                            UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                            where 1 = 1
                                                                            and sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                            and sztalian_pidm = x.SZTPRONO_PIDM
                                                                            AND SZTALIAN_ALIANZA='CLOU';
                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                   END IF;

                                                                end if;

                                                                exit when l_contador = 1;

                                                            end loop;


                                          end loop;

                       end loop;
        commit;
END IF;
    end;
--
--
    PROCEDURE p_iebs_regla(p_regla   NUMBER)
    is
       l_cuenta_nivel_li     number;
       l_cuenta_nivel_ma     number;
       l_cuenta_nivel_do     number;
       l_nivel               varchar2(2);
       l_avance              number;
       l_materias_alianza    number;
       l_materias_para       number;
       l_peirod_uni          varchar2(2);
       l_contador            number:=0;
       l_sec_materia         number;
       l_contador2           number:=0;
       l_secuencia           number;
       l_cuenta_alianza      number;
       l_cuenta_mh           number;
    begin

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_li
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_ma
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_do
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma > 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  IF;

        dbms_output.put_line('Nievl '||l_nivel);


        DELETE sztalian
        WHERE 1 = 1
        AND sztalian_no_regla = p_regla
        AND SZTALIAN_FLEX ='PR'
        AND SZTALIAN_ALIANZA ='IEBS';

         for c in ( SELECT distinct (SELECT  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            FROM SMRPRLE
                            WHERE 1 = 1
                            AND SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'IEBS' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
                    FROM sztprono
                    WHERE 1 = 1
                    AND sztprono_no_regla = p_regla
                    AND EXISTS (SELECT NULL
                                FROM GORADID
                                WHERE 1 = 1
                                AND GORADID_PIDM = SZTPRONO_PIDM
                                AND  GORADID_ADID_CODE ='IEBS')
                    )loop


                        BEGIN

                          SELECT MAX(zstpara_param_id)
                          INTO l_avance
                          FROM ZSTPARA
                          WHERE 1 = 1
                          AND zstpara_mapa_id ='INSCRIPCIONES'
                          AND zstpara_param_valor = c.avance
                          AND zstpara_param_desc = c.tipo_inicio;

                        exception when others then
                            null;
                        end;

                        BEGIN


                         --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                          INSERT INTO sztalian VALUES (c.pidm,
                                                       c.matricula,
                                                       c.programa,
                                                       c.alianza,
                                                       l_avance,
                                                       c.regla,
                                                       'N',
                                                       nvl(l_materias_para,0),
                                                       nvl(l_materias_alianza,0),
                                                       c.tipo_inicio,
                                                       'PR'
                                                       );

                        EXCEPTION WHEN OTHERS THEN
                         NULL;
                        END;

                        COMMIT;
                    end loop;
                    --Jpg@Modify@Ene22
                    --Obtiene la secuencia siguiente para pronosticar materias
                    l_sec_materia := get_max_materia(p_regla, 'IEBS',1 );
                    --Jpg@Modify@Ene22
                    for c in (SELECT *
                              FROM sztalian
                              WHERE 1 = 1
                              AND sztalian_no_regla = p_regla
                              AND SZTALIAN_FLEX ='PR'
                              and SZTALIAN_ALIANZA ='IEBS'
                              )loop

                                  IF c.SZTALIAN_ALIANZA ='IEBS' then

                                        --raise_application_error (-20002,'Entra a alianzas 0.0');

                                        IF l_nivel ='MA' then

                                              BEGIN

                                                SELECT COUNT(*)
                                                INTO l_cuenta_alianza
                                                FROM SZTALMT
                                                WHERE 1 = 1
                                                AND SZTALMT_NIVEL =l_nivel
                                                AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                AND SZTALMT_ACTIVO ='S'
                                                AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'IEBS%'
                                                                              AND EXISTS (SELECT NULL
                                                                                          FROM SZTALIAN
                                                                                          WHERE 1 = 1
                                                                                          AND SZTALIAN_NO_REGLA = p_regla
                                                                                          AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                          AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                          AND sztalian_flex ='PR' )
                                                                               );

                                              exception when others then
                                                null;
                                              end;

                                              IF l_cuenta_alianza > 0 then

                                                  l_contador:= 0;

                                                  FOR d IN
                                                  (
                                                      SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                      SZTALMT_BIM salida,
                                                                      SZTALMT_SECUENCIA secuencia,
                                                                      SZTALMT_ALIANZA alianza
                                                      FROM SZTALMT
                                                      WHERE 1 = 1
                                                      AND SZTALMT_NIVEL =l_nivel
                                                      AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                      AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                      AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                  FROM ssbsect
                                                                                  join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                              AND sfrstcr_crn = ssbsect_crn
                                                                                  WHERE 1 = 1
                                                                                  AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'IEBS%'
                                                                                  AND EXISTS (SELECT NULL
                                                                                              FROM SZTALIAN
                                                                                              WHERE 1 = 1
                                                                                              AND SZTALIAN_NO_REGLA = p_regla
    --                                                                                          AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                              AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                              AND sztalian_flex ='PR' )
                                                                                   )
                                                     ORDER BY SZTALMT_SECUENCIA
                                                  )loop

                                                       l_contador:=l_contador+1;

                                                      dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);




                                                           l_contador2:=0;

                                                      for x in (SELECT *
                                                                FROM sztprono
                                                                WHERE 1 = 1
                                                                AND sztprono_no_regla = c.sztalian_no_regla
                                                                AND sztprono_pidm = c.sztalian_pidm
                                                                )loop

                                                                  l_contador2:=l_contador2+1;

                                                                    BEGIN

                                                                      SELECT nvl(max(sztprono_secuencia),0)+1
                                                                      INTO l_secuencia
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                    exception when others then
                                                                        null;
                                                                    end;
                                                                    BEGIN

                                                                        SELECT COUNT(*)
                                                                        INTO l_cuenta_mh
                                                                        FROM ssbsect
                                                                        join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                    AND sfrstcr_crn = ssbsect_crn
                                                                        WHERE 1 = 1
                                                                        AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                        AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                        AND SFRSTCR_RSTS_CODE ='RE';

                                                                    exception when others then
                                                                        null;
                                                                    end;

                                                                    IF l_cuenta_mh = 0 then

                                                                        BEGIN

                                                                            INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                        x.SZTPRONO_ID,
                                                                                                        x.SZTPRONO_TERM_CODE,
                                                                                                        x.SZTPRONO_PROGRAM,
                                                                                                        d.materia,
                                                                                                        l_secuencia,
                                                                                                        x.SZTPRONO_PTRM_CODE,
                                                                                                        d.materia,
                                                                                                        'x',
                                                                                                        x.SZTPRONO_FECHA_INICIO,
                                                                                                        x.SZTPRONO_PTRM_CODE_NW,
                                                                                                        x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                        x.SZTPRONO_AVANCE,
                                                                                                        x.SZTPRONO_NO_REGLA,
                                                                                                        x.SZTPRONO_USUARIO,
                                                                                                        x.SZTPRONO_STUDY_PATH,
                                                                                                        x.SZTPRONO_RATE,
                                                                                                        x.SZTPRONO_JORNADA,
                                                                                                        x.SZTPRONO_ACTIVITY_DATE,
                                                                                                        x.SZTPRONO_CUATRI,
                                                                                                        x.SZTPRONO_TIPO_INICIO,
                                                                                                        x.SZTPRONO_JORNADA_DOS,
                                                                                                        x.SZTPRONO_ENVIO_MOODL,
                                                                                                        x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                        x.SZTPRONO_ESTATUS,
                                                                                                        x.SZTPRONO_ESTATUS_ERROR,
                                                                                                        null,
                                                                                                        x.SZTPRONO_GRUPO_ASIG
                                                                                                        );

                                                                        exception when others then
                                                                            dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                        end;

                                                                        BEGIN
                                                                            UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                            WHERE 1 = 1
                                                                            AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                            AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                            and sztalian_alianza='IEBS';
                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        exit when l_contador2 = 1;

                                                                    end IF;

                                                                END LOOP;

                                                                exit when l_contador = d.salida;

                                                  END LOOP;

                                              else

                                                  l_contador:= 0;

                                                  FOR d IN
                                                  (
                                                      SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                      SZTALMT_BIM salida,
                                                                      SZTALMT_SECUENCIA secuencia,
                                                                      SZTALMT_ALIANZA alianza
                                                      FROM SZTALMT
                                                      WHERE 1 = 1
                                                      AND SZTALMT_NIVEL =l_nivel
                                                      AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                      AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                     ORDER BY SZTALMT_SECUENCIA
                                                  )loop

                                                       l_contador:=l_contador+1;

                                                      dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);




                                                           l_contador2:=0;

                                                          for x in (SELECT *
                                                                    FROM sztprono
                                                                    WHERE 1 = 1
                                                                    AND sztprono_no_regla = c.sztalian_no_regla
                                                                    AND sztprono_pidm = c.sztalian_pidm
                                                                    )loop

                                                                      l_contador2:=l_contador2+1;

                                                                        BEGIN

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          WHERE 1 = 1
                                                                          AND sztprono_no_regla = c.sztalian_no_regla
                                                                          AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        BEGIN

                                                                            SELECT COUNT(*)
                                                                            INTO l_cuenta_mh
                                                                            FROM ssbsect
                                                                            join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                        AND sfrstcr_crn = ssbsect_crn
                                                                            WHERE 1 = 1
                                                                            AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                            AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                            AND SFRSTCR_RSTS_CODE ='RE';

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        IF l_cuenta_mh = 0 then

                                                                                BEGIN

                                                                                    INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                                x.SZTPRONO_ID,
                                                                                                                x.SZTPRONO_TERM_CODE,
                                                                                                                x.SZTPRONO_PROGRAM,
                                                                                                                d.materia,
                                                                                                                l_secuencia,
                                                                                                                x.SZTPRONO_PTRM_CODE,
                                                                                                                d.materia,
                                                                                                                'x',
                                                                                                                x.SZTPRONO_FECHA_INICIO,
                                                                                                                x.SZTPRONO_PTRM_CODE_NW,
                                                                                                                x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                                x.SZTPRONO_AVANCE,
                                                                                                                x.SZTPRONO_NO_REGLA,
                                                                                                                x.SZTPRONO_USUARIO,
                                                                                                                x.SZTPRONO_STUDY_PATH,
                                                                                                                x.SZTPRONO_RATE,
                                                                                                                x.SZTPRONO_JORNADA,
                                                                                                                x.SZTPRONO_ACTIVITY_DATE,
                                                                                                                x.SZTPRONO_CUATRI,
                                                                                                                x.SZTPRONO_TIPO_INICIO,
                                                                                                                x.SZTPRONO_JORNADA_DOS,
                                                                                                                x.SZTPRONO_ENVIO_MOODL,
                                                                                                                x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                                x.SZTPRONO_ESTATUS,
                                                                                                                x.SZTPRONO_ESTATUS_ERROR,
                                                                                                                null,
                                                                                                                x.SZTPRONO_GRUPO_ASIG
                                                                                                                );

                                                                                exception when others then
                                                                                    dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                                end;

                                                                                BEGIN
                                                                                    UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                    WHERE 1 = 1
                                                                                    AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                    AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                    and sztalian_alianza='IEBS';
                                                                                exception when others then
                                                                                    null;
                                                                                end;

                                                                                exit when l_contador2 = 1;

                                                                        end IF;

                                                                    END LOOP;


                                                           exit when l_contador = d.salida;


                                                  END LOOP;

                                              end IF;

                                        elsIF l_nivel ='LI' then

                                        --      raise_application_error (-20002,'Entra a alianzas 0.1');

                                              BEGIN

                                                SELECT COUNT(*)
                                                INTO l_cuenta_alianza
                                                FROM SZTALMT
                                                WHERE 1 = 1
                                                AND SZTALMT_NIVEL =l_nivel
                                                AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                AND SZTALMT_ACTIVO ='S'
                                                AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'IEBS%'
                                                                              AND EXISTS (SELECT NULL
                                                                                          FROM SZTALIAN
                                                                                          WHERE 1 = 1
                                                                                          AND SZTALIAN_NO_REGLA = p_regla
                                                                                          AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                          AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                          AND sztalian_flex ='PR' )
                                                                               );

                                              exception when others then
                                                null;
                                              end;

                                              IF l_cuenta_alianza > 0 then

                                               --   raise_application_error (-20002,'Entra a alianzas 0.1');

                                                  l_contador:= 0;

                                                  FOR d IN
                                                  (
                                                      SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                      SZTALMT_BIM salida,
                                                                      SZTALMT_SECUENCIA secuencia,
                                                                      SZTALMT_ALIANZA alianza
                                                      FROM SZTALMT
                                                      WHERE 1 = 1
                                                      AND SZTALMT_NIVEL =l_nivel
                                                      AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                      AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                      AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                  FROM ssbsect
                                                                                  join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                              AND sfrstcr_crn = ssbsect_crn
                                                                                  WHERE 1 = 1
                                                                                  AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'IEBS%'
                                                                                  AND EXISTS (SELECT NULL
                                                                                              FROM SZTALIAN
                                                                                              WHERE 1 = 1
                                                                                              AND SZTALIAN_NO_REGLA = p_regla
                                                                                              AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                              AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                              AND sztalian_flex ='PR' )
                                                                                   )
                                                     ORDER BY SZTALMT_SECUENCIA
                                                  )loop


                                                       -- raise_application_error (-20002,'Entra a alianzas 0.1');

                                                       l_contador:=l_contador+1;

                                                      dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);




                                                           l_contador2:=0;

                                                      for x in (SELECT *
                                                                FROM sztprono
                                                                WHERE 1 = 1
                                                                AND sztprono_no_regla = c.sztalian_no_regla
                                                                AND sztprono_pidm = c.sztalian_pidm
                                                                )loop

                                                                  l_contador2:=l_contador2+1;

                                                                 --   raise_application_error (-20002,'Entra a alianzas 0.1');

                                                                    BEGIN

                                                                      SELECT nvl(max(sztprono_secuencia),0)+1
                                                                      INTO l_secuencia
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                    exception when others then
                                                                        null;
                                                                    end;
                                                                    BEGIN

                                                                        SELECT COUNT(*)
                                                                        INTO l_cuenta_mh
                                                                        FROM ssbsect
                                                                        join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                    AND sfrstcr_crn = ssbsect_crn
                                                                        WHERE 1 = 1
                                                                        AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                        AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                        AND SFRSTCR_RSTS_CODE ='RE';

                                                                    exception when others then
                                                                        null;
                                                                    end;

                                                                    IF l_cuenta_mh = 0 then

                                                                        IF x.sztprono_ptrm_code in ('L1E','L1A','L0A','L2A') then

                                                                            BEGIN

                                                                                INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                            x.SZTPRONO_ID,
                                                                                                            x.SZTPRONO_TERM_CODE,
                                                                                                            x.SZTPRONO_PROGRAM,
                                                                                                            d.materia,
                                                                                                            l_secuencia,
                                                                                                            x.SZTPRONO_PTRM_CODE,
                                                                                                            d.materia,
                                                                                                            'x',
                                                                                                            x.SZTPRONO_FECHA_INICIO,
                                                                                                            x.SZTPRONO_PTRM_CODE_NW,
                                                                                                            x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                            x.SZTPRONO_AVANCE,
                                                                                                            x.SZTPRONO_NO_REGLA,
                                                                                                            x.SZTPRONO_USUARIO,
                                                                                                            x.SZTPRONO_STUDY_PATH,
                                                                                                            x.SZTPRONO_RATE,
                                                                                                            x.SZTPRONO_JORNADA,
                                                                                                            x.SZTPRONO_ACTIVITY_DATE,
                                                                                                            x.SZTPRONO_CUATRI,
                                                                                                            x.SZTPRONO_TIPO_INICIO,
                                                                                                            x.SZTPRONO_JORNADA_DOS,
                                                                                                            x.SZTPRONO_ENVIO_MOODL,
                                                                                                            x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                            x.SZTPRONO_ESTATUS,
                                                                                                            x.SZTPRONO_ESTATUS_ERROR,
                                                                                                            null,
                                                                                                            x.SZTPRONO_GRUPO_ASIG
                                                                                                            );

                                                                            exception when others then
                                                                                dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                            end;

                                                                        elsIF x.sztprono_ptrm_code in ('L0B','L0D','L1B','L1D') then

                                                                              for c1 in (SELECT *
                                                                                         FROM table (PKG_FUNCIONES_PIPELINED.f_mate_alian_a(p_regla =>x.SZTPRONO_NO_REGLA))
                                                                                         WHERE 1 = 1
                                                                                         AND alianza = c.SZTALIAN_ALIANZA
                                                                                         )loop

    --                                                                                          raise_application_error (-20002,'Entra a alianzas 0');

                                                                                              BEGIN

                                                                                                    INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                                                x.SZTPRONO_ID,
                                                                                                                                x.SZTPRONO_TERM_CODE,
                                                                                                                                x.SZTPRONO_PROGRAM,
                                                                                                                                c1.MATERIA_LEGAL,
                                                                                                                                l_secuencia,
                                                                                                                                x.SZTPRONO_PTRM_CODE,
                                                                                                                                c1.MATERIA_LEGAL,
                                                                                                                                'x',
                                                                                                                                x.SZTPRONO_FECHA_INICIO,
                                                                                                                                x.SZTPRONO_PTRM_CODE_NW,
                                                                                                                                x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                                                x.SZTPRONO_AVANCE,
                                                                                                                                x.SZTPRONO_NO_REGLA,
                                                                                                                                x.SZTPRONO_USUARIO,
                                                                                                                                x.SZTPRONO_STUDY_PATH,
                                                                                                                                x.SZTPRONO_RATE,
                                                                                                                                x.SZTPRONO_JORNADA,
                                                                                                                                x.SZTPRONO_ACTIVITY_DATE,
                                                                                                                                x.SZTPRONO_CUATRI,
                                                                                                                                x.SZTPRONO_TIPO_INICIO,
                                                                                                                                x.SZTPRONO_JORNADA_DOS,
                                                                                                                                x.SZTPRONO_ENVIO_MOODL,
                                                                                                                                x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                                                x.SZTPRONO_ESTATUS,
                                                                                                                                x.SZTPRONO_ESTATUS_ERROR,
                                                                                                                                null,
                                                                                                                                x.SZTPRONO_GRUPO_ASIG
                                                                                                                                );

                                                                                              exception when others then
                                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                                              end;

                                                                                         END LOOP;

                                                                        end IF;

                                                                        BEGIN
                                                                            UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                            WHERE 1 = 1
                                                                            AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                            AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                            and sztalian_alianza='IEBS';
                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        exit when l_contador2 = 1;

                                                                    end IF;

                                                                END LOOP;

                                                                exit when l_contador = d.salida;

                                                  END LOOP;

                                              else

                                                  l_contador:= 0;

                                                  FOR d IN
                                                  (
                                                      SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                      SZTALMT_BIM salida,
                                                                      SZTALMT_SECUENCIA secuencia,
                                                                      SZTALMT_ALIANZA alianza
                                                      FROM SZTALMT
                                                      WHERE 1 = 1
                                                      AND SZTALMT_NIVEL =l_nivel
                                                      AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                      AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                     ORDER BY SZTALMT_SECUENCIA
                                                  )loop

                                                       l_contador:=l_contador+1;

                                                      dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);




                                                           l_contador2:=0;

                                                          for x in (SELECT *
                                                                    FROM sztprono
                                                                    WHERE 1 = 1
                                                                    AND sztprono_no_regla = c.sztalian_no_regla
                                                                    AND sztprono_pidm = c.sztalian_pidm
                                                                    )loop

                                                                      l_contador2:=l_contador2+1;

                                                                        BEGIN

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          WHERE 1 = 1
                                                                          AND sztprono_no_regla = c.sztalian_no_regla
                                                                          AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        BEGIN

                                                                            SELECT COUNT(*)
                                                                            INTO l_cuenta_mh
                                                                            FROM ssbsect
                                                                            join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                        AND sfrstcr_crn = ssbsect_crn
                                                                            WHERE 1 = 1
                                                                            AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                            AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                            AND SFRSTCR_RSTS_CODE ='RE';

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        IF l_cuenta_mh = 0 then

                                                                                IF x.sztprono_ptrm_code in ('L1E','L1A','L0A','L2A') then

                                                                                BEGIN

                                                                                    INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                                x.SZTPRONO_ID,
                                                                                                                x.SZTPRONO_TERM_CODE,
                                                                                                                x.SZTPRONO_PROGRAM,
                                                                                                                d.materia,
                                                                                                                l_secuencia,
                                                                                                                x.SZTPRONO_PTRM_CODE,
                                                                                                                d.materia,
                                                                                                                'x',
                                                                                                                x.SZTPRONO_FECHA_INICIO,
                                                                                                                x.SZTPRONO_PTRM_CODE_NW,
                                                                                                                x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                                x.SZTPRONO_AVANCE,
                                                                                                                x.SZTPRONO_NO_REGLA,
                                                                                                                x.SZTPRONO_USUARIO,
                                                                                                                x.SZTPRONO_STUDY_PATH,
                                                                                                                x.SZTPRONO_RATE,
                                                                                                                x.SZTPRONO_JORNADA,
                                                                                                                x.SZTPRONO_ACTIVITY_DATE,
                                                                                                                x.SZTPRONO_CUATRI,
                                                                                                                x.SZTPRONO_TIPO_INICIO,
                                                                                                                x.SZTPRONO_JORNADA_DOS,
                                                                                                                x.SZTPRONO_ENVIO_MOODL,
                                                                                                                x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                                x.SZTPRONO_ESTATUS,
                                                                                                                x.SZTPRONO_ESTATUS_ERROR,
                                                                                                                null,
                                                                                                                x.SZTPRONO_GRUPO_ASIG
                                                                                                                );

                                                                                exception when others then
                                                                                    dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                                end;

                                                                            elsIF x.sztprono_ptrm_code in ('L1B','L1D') then

                                                                                  for c1 in (SELECT *
                                                                                             FROM table (PKG_FUNCIONES_PIPELINED.f_mate_alian_a(p_regla =>x.SZTPRONO_NO_REGLA))
                                                                                             WHERE 1 = 1
                                                                                             AND alianza = c.SZTALIAN_ALIANZA
                                                                                             )loop

    --                                                                                              raise_application_error (-20002,'Entra a alianzas 1');

                                                                                                  BEGIN

                                                                                                        INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                                                    x.SZTPRONO_ID,
                                                                                                                                    x.SZTPRONO_TERM_CODE,
                                                                                                                                    x.SZTPRONO_PROGRAM,
                                                                                                                                    c1.MATERIA_LEGAL,
                                                                                                                                    l_secuencia,
                                                                                                                                    x.SZTPRONO_PTRM_CODE,
                                                                                                                                    c1.MATERIA_LEGAL,
                                                                                                                                    'x',
                                                                                                                                    x.SZTPRONO_FECHA_INICIO,
                                                                                                                                    x.SZTPRONO_PTRM_CODE_NW,
                                                                                                                                    x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                                                    x.SZTPRONO_AVANCE,
                                                                                                                                    x.SZTPRONO_NO_REGLA,
                                                                                                                                    x.SZTPRONO_USUARIO,
                                                                                                                                    x.SZTPRONO_STUDY_PATH,
                                                                                                                                    x.SZTPRONO_RATE,
                                                                                                                                    x.SZTPRONO_JORNADA,
                                                                                                                                    x.SZTPRONO_ACTIVITY_DATE,
                                                                                                                                    x.SZTPRONO_CUATRI,
                                                                                                                                    x.SZTPRONO_TIPO_INICIO,
                                                                                                                                    x.SZTPRONO_JORNADA_DOS,
                                                                                                                                    x.SZTPRONO_ENVIO_MOODL,
                                                                                                                                    x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                                                    x.SZTPRONO_ESTATUS,
                                                                                                                                    x.SZTPRONO_ESTATUS_ERROR,
                                                                                                                                    null,
                                                                                                                                    x.SZTPRONO_GRUPO_ASIG
                                                                                                                                    );

                                                                                                  exception when others then
                                                                                                      dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                                                  end;

                                                                                             END LOOP;

                                                                            end IF;

                                                                                BEGIN
                                                                                    UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                    WHERE 1 = 1
                                                                                    AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                    AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                    and sztalian_alianza='IEBS';
                                                                                exception when others then
                                                                                    null;
                                                                                end;

                                                                                exit when l_contador2 = 1;

                                                                        end IF;

                                                                    END LOOP;


                                                           exit when l_contador = d.salida;


                                                  END LOOP;

                                              end IF;

                                        elsIF l_nivel ='DO' then

                                              BEGIN

                                                SELECT COUNT(*)
                                                INTO l_cuenta_alianza
                                                FROM SZTALMT
                                                WHERE 1 = 1
                                                AND SZTALMT_NIVEL =l_nivel
                                                AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                AND SZTALMT_ACTIVO ='S'
                                                AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'IEBS%'
                                                                              AND EXISTS (SELECT NULL
                                                                                          FROM SZTALIAN
                                                                                          WHERE 1 = 1
                                                                                          AND SZTALIAN_NO_REGLA = p_regla
                                                                                          AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                          AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                          AND sztalian_flex ='PR' )
                                                                               );

                                              exception when others then
                                                null;
                                              end;

                                              IF l_cuenta_alianza > 0 then

                                                  l_contador:= 0;

                                                  FOR d IN
                                                  (
                                                      SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                      SZTALMT_BIM salida,
                                                                      SZTALMT_SECUENCIA secuencia,
                                                                      SZTALMT_ALIANZA alianza
                                                      FROM SZTALMT
                                                      WHERE 1 = 1
                                                      AND SZTALMT_NIVEL =l_nivel
                                                      AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                      AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                      AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                  FROM ssbsect
                                                                                  join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                              AND sfrstcr_crn = ssbsect_crn
                                                                                  WHERE 1 = 1
                                                                                  AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'IEBS%'
                                                                                  AND EXISTS (SELECT NULL
                                                                                              FROM SZTALIAN
                                                                                              WHERE 1 = 1
                                                                                              AND SZTALIAN_NO_REGLA = p_regla
                                                                                              AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                              AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                              AND sztalian_flex ='PR' )
                                                                                   )
                                                     ORDER BY SZTALMT_SECUENCIA
                                                  )loop

                                                       l_contador:=l_contador+1;

                                                      dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);




                                                           l_contador2:=0;

                                                      for x in (SELECT *
                                                                FROM sztprono
                                                                WHERE 1 = 1
                                                                AND sztprono_no_regla = c.sztalian_no_regla
                                                                AND sztprono_pidm = c.sztalian_pidm
                                                                )loop

                                                                  l_contador2:=l_contador2+1;

                                                                    BEGIN

                                                                      SELECT nvl(max(sztprono_secuencia),0)+1
                                                                      INTO l_secuencia
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                    exception when others then
                                                                        null;
                                                                    end;
                                                                    BEGIN

                                                                        SELECT COUNT(*)
                                                                        INTO l_cuenta_mh
                                                                        FROM ssbsect
                                                                        join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                    AND sfrstcr_crn = ssbsect_crn
                                                                        WHERE 1 = 1
                                                                        AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                        AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                        AND SFRSTCR_RSTS_CODE ='RE';

                                                                    exception when others then
                                                                        null;
                                                                    end;

                                                                    IF l_cuenta_mh = 0 then

                                                                        BEGIN

                                                                            INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                        x.SZTPRONO_ID,
                                                                                                        x.SZTPRONO_TERM_CODE,
                                                                                                        x.SZTPRONO_PROGRAM,
                                                                                                        d.materia,
                                                                                                        l_secuencia,
                                                                                                        x.SZTPRONO_PTRM_CODE,
                                                                                                        d.materia,
                                                                                                        'x',
                                                                                                        x.SZTPRONO_FECHA_INICIO,
                                                                                                        x.SZTPRONO_PTRM_CODE_NW,
                                                                                                        x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                        x.SZTPRONO_AVANCE,
                                                                                                        x.SZTPRONO_NO_REGLA,
                                                                                                        x.SZTPRONO_USUARIO,
                                                                                                        x.SZTPRONO_STUDY_PATH,
                                                                                                        x.SZTPRONO_RATE,
                                                                                                        x.SZTPRONO_JORNADA,
                                                                                                        x.SZTPRONO_ACTIVITY_DATE,
                                                                                                        x.SZTPRONO_CUATRI,
                                                                                                        x.SZTPRONO_TIPO_INICIO,
                                                                                                        x.SZTPRONO_JORNADA_DOS,
                                                                                                        x.SZTPRONO_ENVIO_MOODL,
                                                                                                        x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                        x.SZTPRONO_ESTATUS,
                                                                                                        x.SZTPRONO_ESTATUS_ERROR,
                                                                                                        null,
                                                                                                        x.SZTPRONO_GRUPO_ASIG
                                                                                                        );

                                                                        exception when others then
                                                                            dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                        end;

                                                                        BEGIN
                                                                            UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                            WHERE 1 = 1
                                                                            AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                            AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                            and sztalian_alianza='IEBS';
                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        exit when l_contador2 = 1;

                                                                    end IF;

                                                                END LOOP;

                                                                exit when l_contador = d.salida;

                                                  END LOOP;

                                              else

                                                  l_contador:= 0;

                                                  FOR d IN
                                                  (
                                                      SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                      SZTALMT_BIM salida,
                                                                      SZTALMT_SECUENCIA secuencia,
                                                                      SZTALMT_ALIANZA alianza
                                                      FROM SZTALMT
                                                      WHERE 1 = 1
                                                      AND SZTALMT_NIVEL =l_nivel
                                                      AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                      AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                   ORDER BY SZTALMT_SECUENCIA
                                                  )loop

                                                       l_contador:=l_contador+1;

                                                      dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);




                                                           l_contador2:=0;

                                                          for x in (SELECT *
                                                                    FROM sztprono
                                                                    WHERE 1 = 1
                                                                    AND sztprono_no_regla = c.sztalian_no_regla
                                                                    AND sztprono_pidm = c.sztalian_pidm
                                                                    )loop

                                                                      l_contador2:=l_contador2+1;

                                                                        BEGIN

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          WHERE 1 = 1
                                                                          AND sztprono_no_regla = c.sztalian_no_regla
                                                                          AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        BEGIN

                                                                            SELECT COUNT(*)
                                                                            INTO l_cuenta_mh
                                                                            FROM ssbsect
                                                                            join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                        AND sfrstcr_crn = ssbsect_crn
                                                                            WHERE 1 = 1
                                                                            AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                            AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                            AND SFRSTCR_RSTS_CODE ='RE';

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        IF l_cuenta_mh = 0 then

                                                                                BEGIN

                                                                                    INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                                x.SZTPRONO_ID,
                                                                                                                x.SZTPRONO_TERM_CODE,
                                                                                                                x.SZTPRONO_PROGRAM,
                                                                                                                d.materia,
                                                                                                                l_secuencia,
                                                                                                                x.SZTPRONO_PTRM_CODE,
                                                                                                                d.materia,
                                                                                                                'x',
                                                                                                                x.SZTPRONO_FECHA_INICIO,
                                                                                                                x.SZTPRONO_PTRM_CODE_NW,
                                                                                                                x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                                x.SZTPRONO_AVANCE,
                                                                                                                x.SZTPRONO_NO_REGLA,
                                                                                                                x.SZTPRONO_USUARIO,
                                                                                                                x.SZTPRONO_STUDY_PATH,
                                                                                                                x.SZTPRONO_RATE,
                                                                                                                x.SZTPRONO_JORNADA,
                                                                                                                x.SZTPRONO_ACTIVITY_DATE,
                                                                                                                x.SZTPRONO_CUATRI,
                                                                                                                x.SZTPRONO_TIPO_INICIO,
                                                                                                                x.SZTPRONO_JORNADA_DOS,
                                                                                                                x.SZTPRONO_ENVIO_MOODL,
                                                                                                                x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                                x.SZTPRONO_ESTATUS,
                                                                                                                x.SZTPRONO_ESTATUS_ERROR,
                                                                                                                null,
                                                                                                                x.SZTPRONO_GRUPO_ASIG
                                                                                                                );

                                                                                exception when others then
                                                                                    dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                                end;

                                                                                BEGIN
                                                                                    UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                    WHERE 1 = 1
                                                                                    AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                    AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                    and sztalian_alianza='IEBS';
                                                                                exception when others then
                                                                                    null;
                                                                                end;

                                                                                exit when l_contador2 = 1;

                                                                        end IF;

                                                                    END LOOP;

                                                           exit when l_contador = d.salida;

                                                  END LOOP;

                                              end IF;

                                        end IF;

                                  END IF;

                              end loop;

        commit;
    end;
--
--
    PROCEDURE p_unic_regla(p_regla   NUMBER)
    is
       l_cuenta_nivel_li     number;
       l_cuenta_nivel_ma     number;
       l_cuenta_nivel_do     number;
       l_nivel               varchar2(2);
       l_avance              number;
       l_materias_alianza    number;
       l_materias_para       number;
       l_peirod_uni          varchar2(2);
       l_contador            number:=0;
       l_sec_materia           number;
       l_contador2           number:=0;
       l_secuencia           number;
       l_cuenta_alianza      number;
       l_cuenta_mh           number;
       l_cuenta_qali         number;
       l_ptrm_pi             varchar2(3);
    begin

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_li
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_ma
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_do
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma > 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  IF;

        dbms_output.put_line('Nievl '||l_nivel);


        DELETE sztalian
        WHERE 1 = 1
        AND sztalian_no_regla = p_regla
        AND SZTALIAN_FLEX ='PR'
        AND SZTALIAN_ALIANZA ='UNIC';

         for c in ( SELECT distinct (SELECT  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            FROM SMRPRLE
                            WHERE 1 = 1
                            AND SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'UNIC' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
                    FROM sztprono
                    WHERE 1 = 1
                    AND sztprono_no_regla = p_regla
--                    and sztprono_id ='010385772'
                    AND EXISTS (SELECT NULL
                                FROM GORADID
                                WHERE 1 = 1
                                AND GORADID_PIDM = SZTPRONO_PIDM
                                AND  GORADID_ADID_CODE ='UNIC')
                    )loop


                        BEGIN

                          SELECT MAX(zstpara_param_id)
                          INTO l_avance
                          FROM ZSTPARA
                          WHERE 1 = 1
                          AND zstpara_mapa_id ='INSCRIPCIONES'
                          AND zstpara_param_valor = c.avance
                          AND zstpara_param_desc = c.tipo_inicio;

                        exception when others then
                            null;
                        end;

                        BEGIN


                         --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                          INSERT INTO sztalian VALUES (c.pidm,
                                                       c.matricula,
                                                       c.programa,
                                                       c.alianza,
                                                       l_avance,
                                                       c.regla,
                                                       'N',
                                                       nvl(l_materias_para,0),
                                                       nvl(l_materias_alianza,0),
                                                       c.tipo_inicio,
                                                       'PR'
                                                       );

                        EXCEPTION WHEN OTHERS THEN
                         NULL;
                        END;

                        COMMIT;


                    end loop;

                    --Jpg@Modify@Ene22
                    --Obtiene la secuencia siguiente para pronosticar materias
                    l_sec_materia := get_max_materia(p_regla, 'UNIC',1 );
                    --Jpg@Modify@Ene22

                    for c in (SELECT *
                              FROM sztalian
                              WHERE 1 = 1
                              AND sztalian_no_regla = p_regla
                              AND SZTALIAN_FLEX ='PR'
                              and SZTALIAN_ALIANZA ='UNIC'
                              )loop

                                  IF c.SZTALIAN_ALIANZA ='UNIC' then

                                      IF l_nivel ='MA'  then

                                            BEGIN


                                                SELECT COUNT(*)
                                                INTO l_cuenta_alianza
                                                FROM SZTALMT
                                                WHERE 1 = 1
                                                AND SZTALMT_NIVEL = l_nivel
                                                AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                AND SZTALMT_ACTIVO ='S'
                                                AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'UNIC%'
                                                                                    AND SZSTUME_PIDM = c.SZTALIAN_PIDM
                                                                             );

                                            exception when others then
                                                null;
                                            end;

                                            IF l_cuenta_alianza > 0 then

                                                l_contador:= 0;

                                                FOR d IN
                                                (
                                                    SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                    SZTALMT_BIM salida,
                                                                    SZTALMT_SECUENCIA secuencia,
                                                                    SZTALMT_ALIANZA alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL =l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'UNIC%'
                                                                                    AND SZSTUME_PIDM = c.SZTALIAN_PIDM
                                                                                     )
                                                ORDER BY SZTALMT_SECUENCIA
                                                )loop

                                                     l_contador:=l_contador+1;

                                                    dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                    IF C.SZTALIAN_AVANCE > 0 THEN

                                                        l_contador2:=0;

                                                        for x in (SELECT *
                                                                  FROM sztprono
                                                                  WHERE 1 = 1
                                                                  AND sztprono_no_regla = c.sztalian_no_regla
                                                                  AND sztprono_pidm = c.sztalian_pidm
                                                                  )loop

                                                                      begin

                                                                          select count(*)
                                                                          into l_cuenta_qali
                                                                          from SZTQALI
                                                                          where 1 = 1
                                                                          and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                          AND SZTQALI_PTRM =l_ptrm_pi
                                                                          AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                          AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                      exception when others then
                                                                          null;
                                                                      end;

                                                                      l_contador2:=l_contador2+1;

                                                                      BEGIN

                                                                        SELECT nvl(max(sztprono_secuencia),0)+1
                                                                        INTO l_secuencia
                                                                        FROM sztprono
                                                                        WHERE 1 = 1
                                                                        AND sztprono_no_regla = c.sztalian_no_regla
                                                                        AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                      exception when others then
                                                                          null;
                                                                      end;

                                         --                             IF l_cuenta_qali > 0 then

                                                                          BEGIN

                                                                              INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                          x.SZTPRONO_ID,
                                                                                                          x.SZTPRONO_TERM_CODE,
                                                                                                          x.SZTPRONO_PROGRAM,
                                                                                                          d.materia,
                                                                                                          l_secuencia,
                                                                                                          x.SZTPRONO_PTRM_CODE,
                                                                                                          d.materia,
                                                                                                          'x',
                                                                                                          x.SZTPRONO_FECHA_INICIO,
                                                                                                          x.SZTPRONO_PTRM_CODE_NW,
                                                                                                          x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                          x.SZTPRONO_AVANCE,
                                                                                                          x.SZTPRONO_NO_REGLA,
                                                                                                          x.SZTPRONO_USUARIO,
                                                                                                          x.SZTPRONO_STUDY_PATH,
                                                                                                          x.SZTPRONO_RATE,
                                                                                                          x.SZTPRONO_JORNADA,
                                                                                                          x.SZTPRONO_ACTIVITY_DATE,
                                                                                                          x.SZTPRONO_CUATRI,
                                                                                                          x.SZTPRONO_TIPO_INICIO,
                                                                                                          x.SZTPRONO_JORNADA_DOS,
                                                                                                          x.SZTPRONO_ENVIO_MOODL,
                                                                                                          x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                          x.SZTPRONO_ESTATUS,
                                                                                                          x.SZTPRONO_ESTATUS_ERROR,
                                                                                                          null,
                                                                                                          x.SZTPRONO_GRUPO_ASIG
                                                                                                          );

                                                                          exception when others then
                                                                              dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                          end;

                                                                          BEGIN
                                                                              UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                              WHERE 1 = 1
                                                                              AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                              AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                              AND SZTALIAN_ALIANZA ='UNIC';
                                                                          exception when others then
                                                                              null;
                                                                          end;


                                                                          exit when l_contador2 = 1;

                                           --                           end IF;

                                                                  END LOOP;


                                                         exit when l_contador = d.salida;

                                                    end IF;

                                                END LOOP;

                                            else
                                                 l_contador:= 0;

                                                FOR d IN
                                                (
                                                    SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                    SZTALMT_BIM salida,
                                                                    SZTALMT_SECUENCIA secuencia,
                                                                    SZTALMT_ALIANZA alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL =l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                    AND SZTALMT_ACTIVO ='S'
                                                ORDER BY SZTALMT_SECUENCIA
                                                )loop

                                                     l_contador:=l_contador+1;

                                                    dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);




                                                         l_contador2:=0;

                                                        for x in (SELECT *
                                                                  FROM sztprono
                                                                  WHERE 1 = 1
                                                                  AND sztprono_no_regla = c.sztalian_no_regla
                                                                  AND sztprono_pidm = c.sztalian_pidm
                                                                  )loop

                                                                    begin

                                                                          select count(*)
                                                                          into l_cuenta_qali
                                                                          from SZTQALI
                                                                          where 1 = 1
                                                                          and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                          AND SZTQALI_PTRM =l_ptrm_pi
                                                                          AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                          AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                      exception when others then
                                                                          null;
                                                                      end;

                                                                      l_contador2:=l_contador2+1;

                                                                      BEGIN

                                                                        SELECT nvl(max(sztprono_secuencia),0)+1
                                                                        INTO l_secuencia
                                                                        FROM sztprono
                                                                        WHERE 1 = 1
                                                                        AND sztprono_no_regla = c.sztalian_no_regla
                                                                        AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                      exception when others then
                                                                          null;
                                                                      end;

                                                                      IF l_cuenta_qali > 0 then

                                                                          BEGIN

                                                                              INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                          x.SZTPRONO_ID,
                                                                                                          x.SZTPRONO_TERM_CODE,
                                                                                                          x.SZTPRONO_PROGRAM,
                                                                                                          d.materia,
                                                                                                          l_secuencia,
                                                                                                          x.SZTPRONO_PTRM_CODE,
                                                                                                          d.materia,
                                                                                                          'x',
                                                                                                          x.SZTPRONO_FECHA_INICIO,
                                                                                                          x.SZTPRONO_PTRM_CODE_NW,
                                                                                                          x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                          x.SZTPRONO_AVANCE,
                                                                                                          x.SZTPRONO_NO_REGLA,
                                                                                                          x.SZTPRONO_USUARIO,
                                                                                                          x.SZTPRONO_STUDY_PATH,
                                                                                                          x.SZTPRONO_RATE,
                                                                                                          x.SZTPRONO_JORNADA,
                                                                                                          x.SZTPRONO_ACTIVITY_DATE,
                                                                                                          x.SZTPRONO_CUATRI,
                                                                                                          x.SZTPRONO_TIPO_INICIO,
                                                                                                          x.SZTPRONO_JORNADA_DOS,
                                                                                                          x.SZTPRONO_ENVIO_MOODL,
                                                                                                          x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                          x.SZTPRONO_ESTATUS,
                                                                                                          x.SZTPRONO_ESTATUS_ERROR,
                                                                                                          null,
                                                                                                          x.SZTPRONO_GRUPO_ASIG
                                                                                                          );

                                                                          exception when others then
                                                                              dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                          end;

                                                                          BEGIN
                                                                              UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                              WHERE 1 = 1
                                                                              AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                              AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                              AND SZTALIAN_ALIANZA ='UNIC';
                                                                          exception when others then
                                                                              null;
                                                                          end;


                                                                          exit when l_contador2 = 1;

                                                                      end IF;

                                                                  END LOOP;


                                                         exit when l_contador = d.salida;



                                                END LOOP;


                                            end IF;


                                      elsIF l_nivel ='LI' then

                                            BEGIN


                                                SELECT COUNT(*)
                                                INTO l_cuenta_alianza
                                                FROM SZTALMT
                                                WHERE 1 = 1
                                                AND SZTALMT_NIVEL = l_nivel
                                                AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                AND SZTALMT_ACTIVO ='S'
                                                AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'UNIC%'
                                                                                    AND SZSTUME_PIDM = c.SZTALIAN_PIDM
                                                                                     );

                                            exception when others then
                                                null;
                                            end;

                                            IF l_cuenta_alianza > 0 then

                                                l_contador:= 0;

                                                FOR d IN
                                                (
                                                    SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                    SZTALMT_BIM salida,
                                                                    SZTALMT_SECUENCIA secuencia,
                                                                    SZTALMT_ALIANZA alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL =l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'UNIC%'
                                                                                    AND SZSTUME_PIDM = c.SZTALIAN_PIDM
                                                                                     )
                                                ORDER BY SZTALMT_SECUENCIA
                                                )loop

                                                     l_contador:=l_contador+1;

                                                    dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                    IF C.SZTALIAN_AVANCE > 1 THEN

                                                        l_contador2:=0;

                                                        for x in (SELECT *
                                                                  FROM sztprono
                                                                  WHERE 1 = 1
                                                                  AND sztprono_no_regla = c.sztalian_no_regla
                                                                  AND sztprono_pidm = c.sztalian_pidm
                                                                  )loop

                                                                    l_contador2:=l_contador2+1;

                                                                      BEGIN

                                                                        SELECT nvl(max(sztprono_secuencia),0)+1
                                                                        INTO l_secuencia
                                                                        FROM sztprono
                                                                        WHERE 1 = 1
                                                                        AND sztprono_no_regla = c.sztalian_no_regla
                                                                        AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                      exception when others then
                                                                          null;
                                                                      end;

                                                                      BEGIN

                                                                          SELECT COUNT(*)
                                                                          INTO l_cuenta_mh
                                                                          FROM ssbsect
                                                                          join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                      AND sfrstcr_crn = ssbsect_crn
                                                                          WHERE 1 = 1
                                                                          AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                          AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                          AND SFRSTCR_RSTS_CODE ='RE';

                                                                      exception when others then
                                                                          null;
                                                                      end;

                                                                      --IF l_cuenta_mh = 0 then

                                                                          BEGIN

                                                                              INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                          x.SZTPRONO_ID,
                                                                                                          x.SZTPRONO_TERM_CODE,
                                                                                                          x.SZTPRONO_PROGRAM,
                                                                                                          d.materia,
                                                                                                          l_secuencia,
                                                                                                          x.SZTPRONO_PTRM_CODE,
                                                                                                          d.materia,
                                                                                                          'x',
                                                                                                          x.SZTPRONO_FECHA_INICIO,
                                                                                                          x.SZTPRONO_PTRM_CODE_NW,
                                                                                                          x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                          x.SZTPRONO_AVANCE,
                                                                                                          x.SZTPRONO_NO_REGLA,
                                                                                                          x.SZTPRONO_USUARIO,
                                                                                                          x.SZTPRONO_STUDY_PATH,
                                                                                                          x.SZTPRONO_RATE,
                                                                                                          x.SZTPRONO_JORNADA,
                                                                                                          x.SZTPRONO_ACTIVITY_DATE,
                                                                                                          x.SZTPRONO_CUATRI,
                                                                                                          x.SZTPRONO_TIPO_INICIO,
                                                                                                          x.SZTPRONO_JORNADA_DOS,
                                                                                                          x.SZTPRONO_ENVIO_MOODL,
                                                                                                          x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                          x.SZTPRONO_ESTATUS,
                                                                                                          x.SZTPRONO_ESTATUS_ERROR,
                                                                                                          null,
                                                                                                          x.SZTPRONO_GRUPO_ASIG
                                                                                                          );

                                                                          exception when others then
                                                                              dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                          end;

                                                                          BEGIN
                                                                              UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                              WHERE 1 = 1
                                                                              AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                              AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                              and sztalian_alianza='UNIC';
                                                                          exception when others then
                                                                              null;
                                                                          end;


                                                                          exit when l_contador2 = 1;

                                                                      -- IF;

                                                                  END LOOP;


                                                         exit when l_contador = d.salida;

                                                    end IF;

                                                END LOOP;

                                            else
                                                 l_contador:= 0;

                                                FOR d IN
                                                (
                                                    SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                    SZTALMT_BIM salida,
                                                                    SZTALMT_SECUENCIA secuencia,
                                                                    SZTALMT_ALIANZA alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL =l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                ORDER BY SZTALMT_SECUENCIA
                                                )loop

                                                     l_contador:=l_contador+1;

                                                    dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                    IF C.SZTALIAN_AVANCE > 1 THEN

                                                         l_contador2:=0;

                                                        for x in (SELECT *
                                                                  FROM sztprono
                                                                  WHERE 1 = 1
                                                                  AND sztprono_no_regla = c.sztalian_no_regla
                                                                  AND sztprono_pidm = c.sztalian_pidm
                                                                  )loop

                                                                    l_contador2:=l_contador2+1;

                                                                      BEGIN

                                                                        SELECT nvl(max(sztprono_secuencia),0)+1
                                                                        INTO l_secuencia
                                                                        FROM sztprono
                                                                        WHERE 1 = 1
                                                                        AND sztprono_no_regla = c.sztalian_no_regla
                                                                        AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                      exception when others then
                                                                          null;
                                                                      end;

                                                                      BEGIN

                                                                          SELECT COUNT(*)
                                                                          INTO l_cuenta_mh
                                                                          FROM ssbsect
                                                                          join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                      AND sfrstcr_crn = ssbsect_crn
                                                                          WHERE 1 = 1
                                                                          AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                          AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                          AND SFRSTCR_RSTS_CODE ='RE';

                                                                      exception when others then
                                                                          null;
                                                                      end;

                                                                      --IF l_cuenta_mh = 0 then

                                                                          BEGIN

                                                                              INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                          x.SZTPRONO_ID,
                                                                                                          x.SZTPRONO_TERM_CODE,
                                                                                                          x.SZTPRONO_PROGRAM,
                                                                                                          d.materia,
                                                                                                          l_secuencia,
                                                                                                          x.SZTPRONO_PTRM_CODE,
                                                                                                          d.materia,
                                                                                                          'x',
                                                                                                          x.SZTPRONO_FECHA_INICIO,
                                                                                                          x.SZTPRONO_PTRM_CODE_NW,
                                                                                                          x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                          x.SZTPRONO_AVANCE,
                                                                                                          x.SZTPRONO_NO_REGLA,
                                                                                                          x.SZTPRONO_USUARIO,
                                                                                                          x.SZTPRONO_STUDY_PATH,
                                                                                                          x.SZTPRONO_RATE,
                                                                                                          x.SZTPRONO_JORNADA,
                                                                                                          x.SZTPRONO_ACTIVITY_DATE,
                                                                                                          x.SZTPRONO_CUATRI,
                                                                                                          x.SZTPRONO_TIPO_INICIO,
                                                                                                          x.SZTPRONO_JORNADA_DOS,
                                                                                                          x.SZTPRONO_ENVIO_MOODL,
                                                                                                          x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                          x.SZTPRONO_ESTATUS,
                                                                                                          x.SZTPRONO_ESTATUS_ERROR,
                                                                                                          null,
                                                                                                          x.SZTPRONO_GRUPO_ASIG
                                                                                                          );

                                                                          exception when others then
                                                                              dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                          end;

                                                                          BEGIN
                                                                              UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                              WHERE 1 = 1
                                                                              AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                              AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                              and sztalian_alianza='UNIC';
                                                                          exception when others then
                                                                              null;
                                                                          end;


                                                                          exit when l_contador2 = 1;

                                                                     -- end IF;

                                                                  END LOOP;


                                                         exit when l_contador = d.salida;

                                                    end IF;

                                                END LOOP;


                                            end IF;

                                      elsIF l_nivel ='DO'  then

                                            BEGIN


                                                SELECT COUNT(*)
                                                INTO l_cuenta_alianza
                                                FROM SZTALMT
                                                WHERE 1 = 1
                                                AND SZTALMT_NIVEL = l_nivel
                                                AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                AND SZTALMT_ACTIVO ='S'
                                                AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                            FROM ssbsect
                                                                            join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                        AND sfrstcr_crn = ssbsect_crn
                                                                            WHERE 1 = 1
                                                                            AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'UNIC%'
                                                                            AND EXISTS (SELECT NULL
                                                                                        FROM SZTALIAN
                                                                                        WHERE 1 = 1
                                                                                        AND SZTALIAN_NO_REGLA = p_regla
                                                                                        AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                        AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                        AND sztalian_flex ='PR' )
                                                                             );

                                            exception when others then
                                                null;
                                            end;

                                            IF l_cuenta_alianza > 0 then

                                                l_contador:= 0;

                                                FOR d IN
                                                (
                                                    SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                    SZTALMT_BIM salida,
                                                                    SZTALMT_SECUENCIA secuencia,
                                                                    SZTALMT_ALIANZA alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL =l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                FROM ssbsect
                                                                                join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                            AND sfrstcr_crn = ssbsect_crn
                                                                                WHERE 1 = 1
                                                                                AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'UNIC%'
                                                                                AND EXISTS (SELECT NULL
                                                                                            FROM SZTALIAN
                                                                                            WHERE 1 = 1
                                                                                            AND SZTALIAN_NO_REGLA = p_regla
                                                                                            AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                            AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                            AND sztalian_flex ='PR' )
                                                                                 )
                                                ORDER BY SZTALMT_SECUENCIA
                                                )loop

                                                     l_contador:=l_contador+1;

                                                    dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                    IF C.SZTALIAN_AVANCE > 2 THEN

                                                        l_contador2:=0;

                                                        for x in (SELECT *
                                                                  FROM sztprono
                                                                  WHERE 1 = 1
                                                                  AND sztprono_no_regla = c.sztalian_no_regla
                                                                  AND sztprono_pidm = c.sztalian_pidm
                                                                  )loop

                                                                    l_contador2:=l_contador2+1;

                                                                      BEGIN

                                                                        SELECT nvl(max(sztprono_secuencia),0)+1
                                                                        INTO l_secuencia
                                                                        FROM sztprono
                                                                        WHERE 1 = 1
                                                                        AND sztprono_no_regla = c.sztalian_no_regla
                                                                        AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                      exception when others then
                                                                          null;
                                                                      end;

                                                                      BEGIN

                                                                          SELECT COUNT(*)
                                                                          INTO l_cuenta_mh
                                                                          FROM ssbsect
                                                                          join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                      AND sfrstcr_crn = ssbsect_crn
                                                                          WHERE 1 = 1
                                                                          AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                          AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                          AND SFRSTCR_RSTS_CODE ='RE';

                                                                      exception when others then
                                                                          null;
                                                                      end;

                                                                      IF l_cuenta_mh = 0 then

                                                                          BEGIN

                                                                              INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                          x.SZTPRONO_ID,
                                                                                                          x.SZTPRONO_TERM_CODE,
                                                                                                          x.SZTPRONO_PROGRAM,
                                                                                                          d.materia,
                                                                                                          l_secuencia,
                                                                                                          x.SZTPRONO_PTRM_CODE,
                                                                                                          d.materia,
                                                                                                          'x',
                                                                                                          x.SZTPRONO_FECHA_INICIO,
                                                                                                          x.SZTPRONO_PTRM_CODE_NW,
                                                                                                          x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                          x.SZTPRONO_AVANCE,
                                                                                                          x.SZTPRONO_NO_REGLA,
                                                                                                          x.SZTPRONO_USUARIO,
                                                                                                          x.SZTPRONO_STUDY_PATH,
                                                                                                          x.SZTPRONO_RATE,
                                                                                                          x.SZTPRONO_JORNADA,
                                                                                                          x.SZTPRONO_ACTIVITY_DATE,
                                                                                                          x.SZTPRONO_CUATRI,
                                                                                                          x.SZTPRONO_TIPO_INICIO,
                                                                                                          x.SZTPRONO_JORNADA_DOS,
                                                                                                          x.SZTPRONO_ENVIO_MOODL,
                                                                                                          x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                          x.SZTPRONO_ESTATUS,
                                                                                                          x.SZTPRONO_ESTATUS_ERROR,
                                                                                                          null,
                                                                                                          x.SZTPRONO_GRUPO_ASIG
                                                                                                          );

                                                                          exception when others then
                                                                              dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                          end;

                                                                          BEGIN
                                                                              UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                              WHERE 1 = 1
                                                                              AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                              AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                              and sztalian_alianza='UNIC';
                                                                          exception when others then
                                                                              null;
                                                                          end;


                                                                          exit when l_contador2 = 1;

                                                                      end IF;

                                                                  END LOOP;


                                                         exit when l_contador = d.salida;

                                                    end IF;

                                                END LOOP;

                                            else
                                                 l_contador:= 0;

                                                FOR d IN
                                                (
                                                    SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                    SZTALMT_BIM salida,
                                                                    SZTALMT_SECUENCIA secuencia,
                                                                    SZTALMT_ALIANZA alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL =l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                ORDER BY SZTALMT_SECUENCIA
                                                )loop

                                                     l_contador:=l_contador+1;

                                                    dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                    IF C.SZTALIAN_AVANCE > 2 THEN

                                                         l_contador2:=0;

                                                        for x in (SELECT *
                                                                  FROM sztprono
                                                                  WHERE 1 = 1
                                                                  AND sztprono_no_regla = c.sztalian_no_regla
                                                                  AND sztprono_pidm = c.sztalian_pidm
                                                                  )loop

                                                                    l_contador2:=l_contador2+1;

                                                                      BEGIN

                                                                        SELECT nvl(max(sztprono_secuencia),0)+1
                                                                        INTO l_secuencia
                                                                        FROM sztprono
                                                                        WHERE 1 = 1
                                                                        AND sztprono_no_regla = c.sztalian_no_regla
                                                                        AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                      exception when others then
                                                                          null;
                                                                      end;

                                                                      BEGIN

                                                                          SELECT COUNT(*)
                                                                          INTO l_cuenta_mh
                                                                          FROM ssbsect
                                                                          join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                      AND sfrstcr_crn = ssbsect_crn
                                                                          WHERE 1 = 1
                                                                          AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                          AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                          AND SFRSTCR_RSTS_CODE ='RE';

                                                                      exception when others then
                                                                          null;
                                                                      end;

                                                                      IF l_cuenta_mh = 0 then

                                                                          BEGIN

                                                                              INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                          x.SZTPRONO_ID,
                                                                                                          x.SZTPRONO_TERM_CODE,
                                                                                                          x.SZTPRONO_PROGRAM,
                                                                                                          d.materia,
                                                                                                          l_secuencia,
                                                                                                          x.SZTPRONO_PTRM_CODE,
                                                                                                          d.materia,
                                                                                                          'x',
                                                                                                          x.SZTPRONO_FECHA_INICIO,
                                                                                                          x.SZTPRONO_PTRM_CODE_NW,
                                                                                                          x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                          x.SZTPRONO_AVANCE,
                                                                                                          x.SZTPRONO_NO_REGLA,
                                                                                                          x.SZTPRONO_USUARIO,
                                                                                                          x.SZTPRONO_STUDY_PATH,
                                                                                                          x.SZTPRONO_RATE,
                                                                                                          x.SZTPRONO_JORNADA,
                                                                                                          x.SZTPRONO_ACTIVITY_DATE,
                                                                                                          x.SZTPRONO_CUATRI,
                                                                                                          x.SZTPRONO_TIPO_INICIO,
                                                                                                          x.SZTPRONO_JORNADA_DOS,
                                                                                                          x.SZTPRONO_ENVIO_MOODL,
                                                                                                          x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                          x.SZTPRONO_ESTATUS,
                                                                                                          x.SZTPRONO_ESTATUS_ERROR,
                                                                                                          null,
                                                                                                          x.SZTPRONO_GRUPO_ASIG
                                                                                                          );

                                                                          exception when others then
                                                                              dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                          end;

                                                                          BEGIN
                                                                              UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                              WHERE 1 = 1
                                                                              AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                              AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                              and sztalian_alianza='UNIC';
                                                                          exception when others then
                                                                              null;
                                                                          end;


                                                                          exit when l_contador2 = 1;

                                                                      end IF;

                                                                  END LOOP;


                                                         exit when l_contador = d.salida;

                                                    end IF;

                                                END LOOP;


                                            end IF;

                                      END IF;

                                  END IF;

                              end loop;

        commit;
    end;
--
--
    PROCEDURE p_monu_regla(p_regla   NUMBER)
    is
       l_cuenta_nivel_li     number;
       l_cuenta_nivel_ma     number;
       l_cuenta_nivel_do     number;
       l_nivel               varchar2(2);
       l_avance              number;
       l_materias_alianza    number;
       l_materias_para       number;
       l_peirod_uni          varchar2(2);
       l_contador            number:=0;
       l_avance_pidm         number;
       l_contador2           number:=0;
       l_secuencia           number;
       l_cuenta_alianza      number;
       l_cuenta_mh           number;
    begin

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_li
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_ma
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_do
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma > 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  IF;

        dbms_output.put_line('Nievl '||l_nivel);


        DELETE sztalian
        WHERE 1 = 1
        AND sztalian_no_regla = p_regla
        AND SZTALIAN_FLEX ='PR'
        AND SZTALIAN_ALIANZA ='MONU';

         for c in ( SELECT distinct (SELECT  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            FROM SMRPRLE
                            WHERE 1 = 1
                            AND SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'MONU' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
                    FROM sztprono
                    WHERE 1 = 1
                    AND sztprono_no_regla = p_regla
                    AND EXISTS (SELECT NULL
                                FROM GORADID
                                WHERE 1 = 1
                                AND GORADID_PIDM = SZTPRONO_PIDM
                                AND  GORADID_ADID_CODE ='MONU')
                    )loop


                        BEGIN

                          SELECT MAX(zstpara_param_id)
                          INTO l_avance
                          FROM ZSTPARA
                          WHERE 1 = 1
                          AND zstpara_mapa_id ='INSCRIPCIONES'
                          AND zstpara_param_valor = c.avance
                          AND zstpara_param_desc = c.tipo_inicio;

                        exception when others then
                            null;
                        end;

                        BEGIN


                         --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                          INSERT INTO sztalian VALUES (c.pidm,
                                                       c.matricula,
                                                       c.programa,
                                                       c.alianza,
                                                       l_avance,
                                                       c.regla,
                                                       'N',
                                                       nvl(l_materias_para,0),
                                                       nvl(l_materias_alianza,0),
                                                       c.tipo_inicio,
                                                       'PR'
                                                       );

                        EXCEPTION WHEN OTHERS THEN
                         NULL;
                        END;

                        COMMIT;


                    end loop;

                    for c in (SELECT *
                              FROM sztalian
                              WHERE 1 = 1
                              AND sztalian_no_regla = p_regla
                              AND SZTALIAN_FLEX ='PR'
                              and SZTALIAN_ALIANZA ='MONU'
                              )loop

                                  IF c.SZTALIAN_ALIANZA ='MONU' then

                                        IF l_nivel ='MA'  then

                                              l_contador:= 0;

                                              BEGIN


                                                  SELECT COUNT(*)
                                                  INTO l_cuenta_alianza
                                                  FROM SZTALMT
                                                  WHERE 1 = 1
                                                  AND SZTALMT_NIVEL =l_nivel
                                                  AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                  AND SZTALMT_ACTIVO ='S'
                                                  AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'ONU%'
                                                                              AND EXISTS (SELECT NULL
                                                                                          FROM SZTALIAN
                                                                                          WHERE 1 = 1
                                                                                          AND SZTALIAN_NO_REGLA = p_regla
                                                                                          AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                          AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                          AND sztalian_flex ='PR' )
                                                                               );

                                              exception when others then
                                                  null;
                                              end;

                                              IF l_cuenta_alianza > 0 then

                                                      FOR d IN
                                                      (
                                                          SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                          SZTALMT_BIM salida,
                                                                          SZTALMT_SECUENCIA secuencia,
                                                                          SZTALMT_ALIANZA alianza
                                                          FROM SZTALMT
                                                          WHERE 1 = 1
                                                          AND SZTALMT_NIVEL =l_nivel
                                                          AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                          AND SZTALMT_ACTIVO ='S'
                                                          AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                      FROM ssbsect
                                                                                      join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                                  AND sfrstcr_crn = ssbsect_crn
                                                                                      WHERE 1 = 1
                                                                                      AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'ONU%'
                                                                                      AND EXISTS (SELECT NULL
                                                                                                  FROM SZTALIAN
                                                                                                  WHERE 1 = 1
                                                                                                  AND SZTALIAN_NO_REGLA = p_regla
                                                                                                  AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                                  AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                  AND sztalian_flex ='PR' )
                                                                                       )
                                                      ORDER BY SZTALMT_SECUENCIA
                                                      )loop

                                                           l_contador:=l_contador+1;

                                                          dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);

                                                          l_contador2:=0;

                                                          for x in (SELECT *
                                                                    FROM sztprono
                                                                    WHERE 1 = 1
                                                                    AND sztprono_no_regla = c.sztalian_no_regla
                                                                    AND sztprono_pidm = c.sztalian_pidm
                                                                    )loop

                                                                      l_contador2:=l_contador2+1;

                                                                        BEGIN

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          WHERE 1 = 1
                                                                          AND sztprono_no_regla = c.sztalian_no_regla
                                                                          AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        BEGIN

                                                                            SELECT COUNT(*)
                                                                            INTO l_cuenta_mh
                                                                            FROM ssbsect
                                                                            join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                        AND sfrstcr_crn = ssbsect_crn
                                                                            WHERE 1 = 1
                                                                            AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                            AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                            AND SFRSTCR_RSTS_CODE ='RE';

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        IF l_cuenta_mh = 0 then


                                                                            BEGIN

                                                                                INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                            x.SZTPRONO_ID,
                                                                                                            x.SZTPRONO_TERM_CODE,
                                                                                                            x.SZTPRONO_PROGRAM,
                                                                                                            d.materia,
                                                                                                            l_secuencia,
                                                                                                            x.SZTPRONO_PTRM_CODE,
                                                                                                            d.materia,
                                                                                                            'x',
                                                                                                            x.SZTPRONO_FECHA_INICIO,
                                                                                                            x.SZTPRONO_PTRM_CODE_NW,
                                                                                                            x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                            x.SZTPRONO_AVANCE,
                                                                                                            x.SZTPRONO_NO_REGLA,
                                                                                                            x.SZTPRONO_USUARIO,
                                                                                                            x.SZTPRONO_STUDY_PATH,
                                                                                                            x.SZTPRONO_RATE,
                                                                                                            x.SZTPRONO_JORNADA,
                                                                                                            x.SZTPRONO_ACTIVITY_DATE,
                                                                                                            x.SZTPRONO_CUATRI,
                                                                                                            x.SZTPRONO_TIPO_INICIO,
                                                                                                            x.SZTPRONO_JORNADA_DOS,
                                                                                                            x.SZTPRONO_ENVIO_MOODL,
                                                                                                            x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                            x.SZTPRONO_ESTATUS,
                                                                                                            x.SZTPRONO_ESTATUS_ERROR,
                                                                                                            null,
                                                                                                            x.SZTPRONO_GRUPO_ASIG
                                                                                                            );

                                                                            exception when others then
                                                                                dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                            end;

                                                                            BEGIN
                                                                                UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                WHERE 1 = 1
                                                                                AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                and sztalian_alianza='MONU';
                                                                            exception when others then
                                                                                null;
                                                                            end;


                                                                            exit when l_contador2 = 1;

                                                                        end IF;

                                                                    END LOOP;

                                                               exit when l_contador = d.salida;

                                                      END LOOP;

                                              else

                                                      FOR d IN
                                                      (
                                                          SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                          SZTALMT_BIM salida,
                                                                          SZTALMT_SECUENCIA secuencia,
                                                                          SZTALMT_ALIANZA alianza
                                                          FROM SZTALMT
                                                          WHERE 1 = 1
                                                          AND SZTALMT_NIVEL =l_nivel
                                                          AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                          AND SZTALMT_ACTIVO ='S'
                                                          ORDER BY SZTALMT_SECUENCIA
                                                      )loop

                                                           l_contador:=l_contador+1;

                                                          dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);

                                                          l_contador2:=0;

                                                          for x in (SELECT *
                                                                    FROM sztprono
                                                                    WHERE 1 = 1
                                                                    AND sztprono_no_regla = c.sztalian_no_regla
                                                                    AND sztprono_pidm = c.sztalian_pidm
                                                                    )loop

                                                                      l_contador2:=l_contador2+1;

                                                                        BEGIN

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          WHERE 1 = 1
                                                                          AND sztprono_no_regla = c.sztalian_no_regla
                                                                          AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        BEGIN

                                                                            SELECT COUNT(*)
                                                                            INTO l_cuenta_mh
                                                                            FROM ssbsect
                                                                            join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                        AND sfrstcr_crn = ssbsect_crn
                                                                            WHERE 1 = 1
                                                                            AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                            AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                            AND SFRSTCR_RSTS_CODE ='RE';

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        IF l_cuenta_mh = 0 then


                                                                            BEGIN

                                                                                INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                            x.SZTPRONO_ID,
                                                                                                            x.SZTPRONO_TERM_CODE,
                                                                                                            x.SZTPRONO_PROGRAM,
                                                                                                            d.materia,
                                                                                                            l_secuencia,
                                                                                                            x.SZTPRONO_PTRM_CODE,
                                                                                                            d.materia,
                                                                                                            'x',
                                                                                                            x.SZTPRONO_FECHA_INICIO,
                                                                                                            x.SZTPRONO_PTRM_CODE_NW,
                                                                                                            x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                            x.SZTPRONO_AVANCE,
                                                                                                            x.SZTPRONO_NO_REGLA,
                                                                                                            x.SZTPRONO_USUARIO,
                                                                                                            x.SZTPRONO_STUDY_PATH,
                                                                                                            x.SZTPRONO_RATE,
                                                                                                            x.SZTPRONO_JORNADA,
                                                                                                            x.SZTPRONO_ACTIVITY_DATE,
                                                                                                            x.SZTPRONO_CUATRI,
                                                                                                            x.SZTPRONO_TIPO_INICIO,
                                                                                                            x.SZTPRONO_JORNADA_DOS,
                                                                                                            x.SZTPRONO_ENVIO_MOODL,
                                                                                                            x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                            x.SZTPRONO_ESTATUS,
                                                                                                            x.SZTPRONO_ESTATUS_ERROR,
                                                                                                            null,
                                                                                                            x.SZTPRONO_GRUPO_ASIG
                                                                                                            );

                                                                            exception when others then
                                                                                dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                            end;

                                                                            BEGIN
                                                                                UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                WHERE 1 = 1
                                                                                AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                and sztalian_alianza='MONU';
                                                                            exception when others then
                                                                                null;
                                                                            end;


                                                                            exit when l_contador2 = 1;

                                                                        end IF;

                                                                    END LOOP;

                                                               exit when l_contador = d.salida;

                                                      END LOOP;

                                              end IF;

                                        elsIF l_nivel ='LI' then

                                           l_contador:= 0;

                                              BEGIN


                                                  SELECT COUNT(*)
                                                  INTO l_cuenta_alianza
                                                  FROM SZTALMT
                                                  WHERE 1 = 1
                                                  AND SZTALMT_NIVEL =l_nivel
                                                  AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                  AND SZTALMT_ACTIVO ='S'
                                                  AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'ONU%'
                                                                              AND EXISTS (SELECT NULL
                                                                                          FROM SZTALIAN
                                                                                          WHERE 1 = 1
                                                                                          AND SZTALIAN_NO_REGLA = p_regla
                                                                                          AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                          AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                          AND sztalian_flex ='PR' )
                                                                               );

                                              exception when others then
                                                  null;
                                              end;

                                              IF l_cuenta_alianza > 0 then

                                                      FOR d IN
                                                      (
                                                          SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                          SZTALMT_BIM salida,
                                                                          SZTALMT_SECUENCIA secuencia,
                                                                          SZTALMT_ALIANZA alianza
                                                          FROM SZTALMT
                                                          WHERE 1 = 1
                                                          AND SZTALMT_NIVEL =l_nivel
                                                          AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                          AND SZTALMT_ACTIVO ='S'
                                                          AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                      FROM ssbsect
                                                                                      join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                                  AND sfrstcr_crn = ssbsect_crn
                                                                                      WHERE 1 = 1
                                                                                      AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'ONU%'
                                                                                      AND EXISTS (SELECT NULL
                                                                                                  FROM SZTALIAN
                                                                                                  WHERE 1 = 1
                                                                                                  AND SZTALIAN_NO_REGLA = p_regla
                                                                                                  AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                                  AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                  AND sztalian_flex ='PR' )
                                                                                       )
                                                      ORDER BY SZTALMT_SECUENCIA
                                                      )loop

                                                           l_contador:=l_contador+1;

                                                          dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);

                                                          l_contador2:=0;

                                                          for x in (SELECT *
                                                                    FROM sztprono
                                                                    WHERE 1 = 1
                                                                    AND sztprono_no_regla = c.sztalian_no_regla
                                                                    AND sztprono_pidm = c.sztalian_pidm
                                                                    )loop

                                                                      l_contador2:=l_contador2+1;

                                                                        BEGIN

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          WHERE 1 = 1
                                                                          AND sztprono_no_regla = c.sztalian_no_regla
                                                                          AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        BEGIN

                                                                            SELECT COUNT(*)
                                                                            INTO l_cuenta_mh
                                                                            FROM ssbsect
                                                                            join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                        AND sfrstcr_crn = ssbsect_crn
                                                                            WHERE 1 = 1
                                                                            AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                            AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                            AND SFRSTCR_RSTS_CODE ='RE';

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        IF l_cuenta_mh = 0 then


                                                                            BEGIN

                                                                                INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                            x.SZTPRONO_ID,
                                                                                                            x.SZTPRONO_TERM_CODE,
                                                                                                            x.SZTPRONO_PROGRAM,
                                                                                                            d.materia,
                                                                                                            l_secuencia,
                                                                                                            x.SZTPRONO_PTRM_CODE,
                                                                                                            d.materia,
                                                                                                            'x',
                                                                                                            x.SZTPRONO_FECHA_INICIO,
                                                                                                            x.SZTPRONO_PTRM_CODE_NW,
                                                                                                            x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                            x.SZTPRONO_AVANCE,
                                                                                                            x.SZTPRONO_NO_REGLA,
                                                                                                            x.SZTPRONO_USUARIO,
                                                                                                            x.SZTPRONO_STUDY_PATH,
                                                                                                            x.SZTPRONO_RATE,
                                                                                                            x.SZTPRONO_JORNADA,
                                                                                                            x.SZTPRONO_ACTIVITY_DATE,
                                                                                                            x.SZTPRONO_CUATRI,
                                                                                                            x.SZTPRONO_TIPO_INICIO,
                                                                                                            x.SZTPRONO_JORNADA_DOS,
                                                                                                            x.SZTPRONO_ENVIO_MOODL,
                                                                                                            x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                            x.SZTPRONO_ESTATUS,
                                                                                                            x.SZTPRONO_ESTATUS_ERROR,
                                                                                                            null,
                                                                                                            x.SZTPRONO_GRUPO_ASIG
                                                                                                            );

                                                                            exception when others then
                                                                                dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                            end;

                                                                            BEGIN
                                                                                UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                WHERE 1 = 1
                                                                                AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                and sztalian_alianza='MONU';
                                                                            exception when others then
                                                                                null;
                                                                            end;


                                                                            exit when l_contador2 = 1;

                                                                        end IF;

                                                                    END LOOP;

                                                               exit when l_contador = d.salida;

                                                      END LOOP;

                                              else

                                                      FOR d IN
                                                      (
                                                          SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                          SZTALMT_BIM salida,
                                                                          SZTALMT_SECUENCIA secuencia,
                                                                          SZTALMT_ALIANZA alianza
                                                          FROM SZTALMT
                                                          WHERE 1 = 1
                                                          AND SZTALMT_NIVEL =l_nivel
                                                          AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                          AND SZTALMT_ACTIVO ='S'
                                                          ORDER BY SZTALMT_SECUENCIA
                                                      )loop

                                                           l_contador:=l_contador+1;

                                                          dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);

                                                          l_contador2:=0;

                                                          for x in (SELECT *
                                                                    FROM sztprono
                                                                    WHERE 1 = 1
                                                                    AND sztprono_no_regla = c.sztalian_no_regla
                                                                    AND sztprono_pidm = c.sztalian_pidm
                                                                    )loop

                                                                      l_contador2:=l_contador2+1;

                                                                        BEGIN

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          WHERE 1 = 1
                                                                          AND sztprono_no_regla = c.sztalian_no_regla
                                                                          AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        BEGIN

                                                                            SELECT COUNT(*)
                                                                            INTO l_cuenta_mh
                                                                            FROM ssbsect
                                                                            join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                        AND sfrstcr_crn = ssbsect_crn
                                                                            WHERE 1 = 1
                                                                            AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                            AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                            AND SFRSTCR_RSTS_CODE ='RE';

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        IF l_cuenta_mh = 0 then


                                                                            BEGIN

                                                                                INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                            x.SZTPRONO_ID,
                                                                                                            x.SZTPRONO_TERM_CODE,
                                                                                                            x.SZTPRONO_PROGRAM,
                                                                                                            d.materia,
                                                                                                            l_secuencia,
                                                                                                            x.SZTPRONO_PTRM_CODE,
                                                                                                            d.materia,
                                                                                                            'x',
                                                                                                            x.SZTPRONO_FECHA_INICIO,
                                                                                                            x.SZTPRONO_PTRM_CODE_NW,
                                                                                                            x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                            x.SZTPRONO_AVANCE,
                                                                                                            x.SZTPRONO_NO_REGLA,
                                                                                                            x.SZTPRONO_USUARIO,
                                                                                                            x.SZTPRONO_STUDY_PATH,
                                                                                                            x.SZTPRONO_RATE,
                                                                                                            x.SZTPRONO_JORNADA,
                                                                                                            x.SZTPRONO_ACTIVITY_DATE,
                                                                                                            x.SZTPRONO_CUATRI,
                                                                                                            x.SZTPRONO_TIPO_INICIO,
                                                                                                            x.SZTPRONO_JORNADA_DOS,
                                                                                                            x.SZTPRONO_ENVIO_MOODL,
                                                                                                            x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                            x.SZTPRONO_ESTATUS,
                                                                                                            x.SZTPRONO_ESTATUS_ERROR,
                                                                                                            null,
                                                                                                            x.SZTPRONO_GRUPO_ASIG
                                                                                                            );

                                                                            exception when others then
                                                                                dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                            end;

                                                                            BEGIN
                                                                                UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                WHERE 1 = 1
                                                                                AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                and sztalian_alianza='MONU';
                                                                            exception when others then
                                                                                null;
                                                                            end;


                                                                            exit when l_contador2 = 1;

                                                                        end IF;

                                                                    END LOOP;

                                                               exit when l_contador = d.salida;

                                                      END LOOP;

                                              end IF;

                                        elsIF l_nivel ='DO' then

                                              l_contador:= 0;

                                              BEGIN


                                                  SELECT COUNT(*)
                                                  INTO l_cuenta_alianza
                                                  FROM SZTALMT
                                                  WHERE 1 = 1
                                                  AND SZTALMT_NIVEL =l_nivel
                                                  AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                  AND SZTALMT_ACTIVO ='S'
                                                  AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'ONU%'
                                                                              AND EXISTS (SELECT NULL
                                                                                          FROM SZTALIAN
                                                                                          WHERE 1 = 1
                                                                                          AND SZTALIAN_NO_REGLA = p_regla
                                                                                          AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                          AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                          AND sztalian_flex ='PR' )
                                                                               );

                                              exception when others then
                                                  null;
                                              end;

                                              IF l_cuenta_alianza > 0 then

                                                      FOR d IN
                                                      (
                                                          SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                          SZTALMT_BIM salida,
                                                                          SZTALMT_SECUENCIA secuencia,
                                                                          SZTALMT_ALIANZA alianza
                                                          FROM SZTALMT
                                                          WHERE 1 = 1
                                                          AND SZTALMT_NIVEL =l_nivel
                                                          AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                          AND SZTALMT_ACTIVO ='S'
                                                          AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                      FROM ssbsect
                                                                                      join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                                  AND sfrstcr_crn = ssbsect_crn
                                                                                      WHERE 1 = 1
                                                                                      AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'ONU%'
                                                                                      AND EXISTS (SELECT NULL
                                                                                                  FROM SZTALIAN
                                                                                                  WHERE 1 = 1
                                                                                                  AND SZTALIAN_NO_REGLA = p_regla
                                                                                                  AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                                  AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                  AND sztalian_flex ='PR' )
                                                                                       )
                                                      ORDER BY SZTALMT_SECUENCIA
                                                      )loop

                                                           l_contador:=l_contador+1;

                                                          dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);

                                                          l_contador2:=0;

                                                          for x in (SELECT *
                                                                    FROM sztprono
                                                                    WHERE 1 = 1
                                                                    AND sztprono_no_regla = c.sztalian_no_regla
                                                                    AND sztprono_pidm = c.sztalian_pidm
                                                                    )loop

                                                                      l_contador2:=l_contador2+1;

                                                                        BEGIN

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          WHERE 1 = 1
                                                                          AND sztprono_no_regla = c.sztalian_no_regla
                                                                          AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        BEGIN

                                                                            SELECT COUNT(*)
                                                                            INTO l_cuenta_mh
                                                                            FROM ssbsect
                                                                            join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                        AND sfrstcr_crn = ssbsect_crn
                                                                            WHERE 1 = 1
                                                                            AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                            AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                            AND SFRSTCR_RSTS_CODE ='RE';

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        IF l_cuenta_mh = 0 then


                                                                            BEGIN

                                                                                INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                            x.SZTPRONO_ID,
                                                                                                            x.SZTPRONO_TERM_CODE,
                                                                                                            x.SZTPRONO_PROGRAM,
                                                                                                            d.materia,
                                                                                                            l_secuencia,
                                                                                                            x.SZTPRONO_PTRM_CODE,
                                                                                                            d.materia,
                                                                                                            'x',
                                                                                                            x.SZTPRONO_FECHA_INICIO,
                                                                                                            x.SZTPRONO_PTRM_CODE_NW,
                                                                                                            x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                            x.SZTPRONO_AVANCE,
                                                                                                            x.SZTPRONO_NO_REGLA,
                                                                                                            x.SZTPRONO_USUARIO,
                                                                                                            x.SZTPRONO_STUDY_PATH,
                                                                                                            x.SZTPRONO_RATE,
                                                                                                            x.SZTPRONO_JORNADA,
                                                                                                            x.SZTPRONO_ACTIVITY_DATE,
                                                                                                            x.SZTPRONO_CUATRI,
                                                                                                            x.SZTPRONO_TIPO_INICIO,
                                                                                                            x.SZTPRONO_JORNADA_DOS,
                                                                                                            x.SZTPRONO_ENVIO_MOODL,
                                                                                                            x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                            x.SZTPRONO_ESTATUS,
                                                                                                            x.SZTPRONO_ESTATUS_ERROR,
                                                                                                            null,
                                                                                                            x.SZTPRONO_GRUPO_ASIG
                                                                                                            );

                                                                            exception when others then
                                                                                dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                            end;

                                                                            BEGIN
                                                                                UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                WHERE 1 = 1
                                                                                AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                and sztalian_alianza='MONU';
                                                                            exception when others then
                                                                                null;
                                                                            end;


                                                                            exit when l_contador2 = 1;

                                                                        end IF;

                                                                    END LOOP;

                                                               exit when l_contador = d.salida;

                                                      END LOOP;

                                              else

                                                      FOR d IN
                                                      (
                                                          SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                          SZTALMT_BIM salida,
                                                                          SZTALMT_SECUENCIA secuencia,
                                                                          SZTALMT_ALIANZA alianza
                                                          FROM SZTALMT
                                                          WHERE 1 = 1
                                                          AND SZTALMT_NIVEL =l_nivel
                                                          AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                          AND SZTALMT_ACTIVO ='S'
                                                          ORDER BY SZTALMT_SECUENCIA
                                                      )loop

                                                           l_contador:=l_contador+1;

                                                          dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);

                                                          l_contador2:=0;

                                                          for x in (SELECT *
                                                                    FROM sztprono
                                                                    WHERE 1 = 1
                                                                    AND sztprono_no_regla = c.sztalian_no_regla
                                                                    AND sztprono_pidm = c.sztalian_pidm
                                                                    )loop

                                                                      l_contador2:=l_contador2+1;

                                                                        BEGIN

                                                                          SELECT nvl(max(sztprono_secuencia),0)+1
                                                                          INTO l_secuencia
                                                                          FROM sztprono
                                                                          WHERE 1 = 1
                                                                          AND sztprono_no_regla = c.sztalian_no_regla
                                                                          AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        BEGIN

                                                                            SELECT COUNT(*)
                                                                            INTO l_cuenta_mh
                                                                            FROM ssbsect
                                                                            join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                        AND sfrstcr_crn = ssbsect_crn
                                                                            WHERE 1 = 1
                                                                            AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                            AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                            AND SFRSTCR_RSTS_CODE ='RE';

                                                                        exception when others then
                                                                            null;
                                                                        end;

                                                                        IF l_cuenta_mh = 0 then


                                                                            BEGIN

                                                                                INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                            x.SZTPRONO_ID,
                                                                                                            x.SZTPRONO_TERM_CODE,
                                                                                                            x.SZTPRONO_PROGRAM,
                                                                                                            d.materia,
                                                                                                            l_secuencia,
                                                                                                            x.SZTPRONO_PTRM_CODE,
                                                                                                            d.materia,
                                                                                                            'x',
                                                                                                            x.SZTPRONO_FECHA_INICIO,
                                                                                                            x.SZTPRONO_PTRM_CODE_NW,
                                                                                                            x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                            x.SZTPRONO_AVANCE,
                                                                                                            x.SZTPRONO_NO_REGLA,
                                                                                                            x.SZTPRONO_USUARIO,
                                                                                                            x.SZTPRONO_STUDY_PATH,
                                                                                                            x.SZTPRONO_RATE,
                                                                                                            x.SZTPRONO_JORNADA,
                                                                                                            x.SZTPRONO_ACTIVITY_DATE,
                                                                                                            x.SZTPRONO_CUATRI,
                                                                                                            x.SZTPRONO_TIPO_INICIO,
                                                                                                            x.SZTPRONO_JORNADA_DOS,
                                                                                                            x.SZTPRONO_ENVIO_MOODL,
                                                                                                            x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                            x.SZTPRONO_ESTATUS,
                                                                                                            x.SZTPRONO_ESTATUS_ERROR,
                                                                                                            null,
                                                                                                            x.SZTPRONO_GRUPO_ASIG
                                                                                                            );

                                                                            exception when others then
                                                                                dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                            end;

                                                                            BEGIN
                                                                                UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                WHERE 1 = 1
                                                                                AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                and sztalian_alianza='MONU';
                                                                            exception when others then
                                                                                null;
                                                                            end;


                                                                            exit when l_contador2 = 1;

                                                                        end IF;

                                                                    END LOOP;

                                                               exit when l_contador = d.salida;

                                                      END LOOP;

                                              end IF;

                                        END IF;

                                  end if;

                              END LOOP;

        commit;
    end;
--
--
    PROCEDURE p_muba_regla(p_regla   NUMBER)
    is
       l_cuenta_nivel_li     number;
       l_cuenta_nivel_ma     number;
       l_cuenta_nivel_do     number;
       l_nivel               varchar2(2);
       l_avance              number;
       l_materias_alianza    number;
       l_materias_para       number;
       l_peirod_uni          varchar2(2);
       l_contador            number:=0;
       l_sec_materia         number;
       l_contador2           number:=0;
       l_secuencia           number;
       l_cuenta_alianza      number;
       l_cuenta_mh           number;
       l_cuenta_qali         number;
       l_ptrm_pi             varchar2(3);
       l_cont_stume          number;
    begin

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_li
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_ma
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_do
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma > 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  IF;

        dbms_output.put_line('Nievl '||l_nivel);


        DELETE sztalian
        WHERE 1 = 1
        AND sztalian_no_regla = p_regla
        AND SZTALIAN_FLEX ='PR'
        AND SZTALIAN_ALIANZA ='MUBA';

         for c in ( SELECT distinct (SELECT  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            FROM SMRPRLE
                            WHERE 1 = 1
                            AND SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'MUBA' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
                    FROM sztprono
                    WHERE 1 = 1
--                    and sztprono_id ='010385762'
                    AND sztprono_no_regla = p_regla
                    AND EXISTS (SELECT NULL
                                FROM GORADID
                                WHERE 1 = 1
                                AND GORADID_PIDM = SZTPRONO_PIDM
                                AND  GORADID_ADID_CODE ='MUBA')
                    )loop


                        BEGIN

                          SELECT MAX(zstpara_param_id)
                          INTO l_avance
                          FROM ZSTPARA
                          WHERE 1 = 1
                          AND zstpara_mapa_id ='INSCRIPCIONES'
                          AND zstpara_param_valor = c.avance
                          AND zstpara_param_desc = c.tipo_inicio;

                        exception when others then
                            null;
                        end;

                        BEGIN


                         --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                          INSERT INTO sztalian VALUES (c.pidm,
                                                       c.matricula,
                                                       c.programa,
                                                       c.alianza,
                                                       l_avance,
                                                       c.regla,
                                                       'N',
                                                       nvl(l_materias_para,0),
                                                       nvl(l_materias_alianza,0),
                                                       c.tipo_inicio,
                                                       'PR'
                                                       );

                        EXCEPTION WHEN OTHERS THEN
                         NULL;
                        END;

                        COMMIT;
                    end loop;

                    --Jpg@Modify@Ene22
                    --Obtiene la secuencia siguiente para pronosticar materias
                    l_sec_materia := get_max_materia(p_regla, 'UBA', 1 );
                    --Jpg@Modify@Ene22

                    for c in (SELECT *
                              FROM sztalian
                              WHERE 1 = 1
                              AND sztalian_no_regla = p_regla
                              AND SZTALIAN_FLEX ='PR'
                              and SZTALIAN_ALIANZA ='MUBA'
                              )loop

                                  IF l_nivel ='MA' then
                                             BEGIN

                                               SELECT Count(SZSTUME_SUBJ_CODE)
                                               Into l_cont_stume
                                               FROM SZSTUME
                                               WHERE 1 = 1
                                               AND SZSTUME_SUBJ_CODE like 'UBA%'
                                               AND EXISTS (SELECT NULL
                                                           FROM SZTALIAN
                                                           WHERE 1 = 1
                                                           AND SZTALIAN_NO_REGLA = p_regla
                                                           AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                           AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                           AND sztalian_flex ='PR' );

                                             exception when others then
                                               l_cont_stume:=0;
                                             end;


                                             BEGIN

                                               SELECT COUNT(*)
                                               INTO l_cuenta_alianza
                                               FROM SZTALMT
                                               WHERE 1 = 1
                                               AND SZTALMT_NIVEL =l_nivel
                                               AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                               AND SZTALMT_ACTIVO ='S'
                                               AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                           FROM SZSTUME
                                                                           WHERE 1 = 1
                                                                           AND SZSTUME_SUBJ_CODE like 'UBA%'
                                                                           AND EXISTS (SELECT NULL
                                                                                       FROM SZTALIAN
                                                                                       WHERE 1 = 1
                                                                                       AND SZTALIAN_NO_REGLA = p_regla
                                                                                       AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                       AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                       AND sztalian_flex ='PR' ));

                                             exception when others then
                                               null;
                                             end;

                                             IF l_cuenta_alianza > 0 then

                                                 l_contador:= 0;

                                                 FOR d IN
                                                 (
                                                     SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                     SZTALMT_BIM salida,
                                                                     SZTALMT_SECUENCIA secuencia,
                                                                     SZTALMT_ALIANZA alianza
                                                     FROM SZTALMT
                                                     WHERE 1 = 1
                                                     AND SZTALMT_NIVEL =l_nivel
                                                     AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                     AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                     AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                           FROM SZSTUME
                                                                           WHERE 1 = 1
                                                                           AND SZSTUME_SUBJ_CODE like 'UBA%'
                                                                           AND EXISTS (SELECT NULL
                                                                                       FROM SZTALIAN
                                                                                       WHERE 1 = 1
                                                                                       AND SZTALIAN_NO_REGLA = p_regla
                                                                                       AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                       AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                       AND sztalian_flex ='PR' ))
                                                    ORDER BY SZTALMT_SECUENCIA
                                                 )loop

                                                      l_contador:=l_contador+1;

                                                     dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                      l_contador2:=0;

                                                         for x in (SELECT *
                                                                   FROM sztprono
                                                                   WHERE 1 = 1
                                                                   AND sztprono_no_regla = c.sztalian_no_regla
                                                                   AND sztprono_pidm = c.sztalian_pidm
                                                                   )loop

                                                                     l_contador2:=l_contador2+1;

                                                                       BEGIN

                                                                         SELECT nvl(max(sztprono_secuencia),0)+1
                                                                         INTO l_secuencia
                                                                         FROM sztprono
                                                                         WHERE 1 = 1
                                                                         AND sztprono_no_regla = c.sztalian_no_regla
                                                                         AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                       exception when others then
                                                                           null;
                                                                       end;

                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);

                                                                       begin

                                                                           select count(*)
                                                                           into l_cuenta_qali
                                                                           from SZTQALI
                                                                           where 1 = 1
                                                                           and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                           AND SZTQALI_PTRM =l_ptrm_pi
                                                                           AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                           AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                       exception when others then
                                                                           null;
                                                                       end;

                                                                    dbms_output.put_line(' Cueneta qali '||l_cuenta_qali);

--                                                                       if l_cuenta_qali > 0 then

                                                                           BEGIN

                                                                               INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                           x.SZTPRONO_ID,
                                                                                                           x.SZTPRONO_TERM_CODE,
                                                                                                           x.SZTPRONO_PROGRAM,
                                                                                                           d.materia,
                                                                                                           l_secuencia,
                                                                                                           x.SZTPRONO_PTRM_CODE,
                                                                                                           d.materia,
                                                                                                           'x',
                                                                                                           x.SZTPRONO_FECHA_INICIO,
                                                                                                           x.SZTPRONO_PTRM_CODE_NW,
                                                                                                           x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                           x.SZTPRONO_AVANCE,
                                                                                                           x.SZTPRONO_NO_REGLA,
                                                                                                           x.SZTPRONO_USUARIO,
                                                                                                           x.SZTPRONO_STUDY_PATH,
                                                                                                           x.SZTPRONO_RATE,
                                                                                                           x.SZTPRONO_JORNADA,
                                                                                                           x.SZTPRONO_ACTIVITY_DATE,
                                                                                                           x.SZTPRONO_CUATRI,
                                                                                                           x.SZTPRONO_TIPO_INICIO,
                                                                                                           x.SZTPRONO_JORNADA_DOS,
                                                                                                           x.SZTPRONO_ENVIO_MOODL,
                                                                                                           x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                           x.SZTPRONO_ESTATUS,
                                                                                                           x.SZTPRONO_ESTATUS_ERROR,
                                                                                                           null,
                                                                                                           x.SZTPRONO_GRUPO_ASIG
                                                                                                           );

                                                                           exception when others then
                                                                               dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                           end;

                                                                           BEGIN
                                                                               UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                               WHERE 1 = 1
                                                                               AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                               AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                               and sztalian_alianza='MUBA';
                                                                           exception when others then
                                                                               null;
                                                                           end;

                                                                           exit when l_contador2 = 1;

--                                                                       end IF;

                                                                   END LOOP;


                                                          exit when l_contador = d.salida;


                                                 END LOOP;

                                             elsif l_cont_stume = 0 Then

                                                 l_contador:= 0;

                                                 FOR d IN
                                                 (
                                                     SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                     SZTALMT_BIM salida,
                                                                     SZTALMT_SECUENCIA secuencia,
                                                                     SZTALMT_ALIANZA alianza
                                                     FROM SZTALMT
                                                     WHERE 1 = 1
                                                     AND SZTALMT_NIVEL =l_nivel
                                                     AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                     AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                 )loop

                                                      l_contador:=l_contador+1;

                                                     dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);

                                                          l_contador2:=0;

                                                         for x in (SELECT *
                                                                   FROM sztprono
                                                                   WHERE 1 = 1
                                                                   AND sztprono_no_regla = c.sztalian_no_regla
                                                                   AND sztprono_pidm = c.sztalian_pidm
                                                                   )loop

                                                                     l_contador2:=l_contador2+1;

                                                                       BEGIN

                                                                         SELECT nvl(max(sztprono_secuencia),0)+1
                                                                         INTO l_secuencia
                                                                         FROM sztprono
                                                                         WHERE 1 = 1
                                                                         AND sztprono_no_regla = c.sztalian_no_regla
                                                                         AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                       exception when others then
                                                                           null;
                                                                       end;

                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);

                                                                       begin

                                                                           select count(*)
                                                                           into l_cuenta_qali
                                                                           from SZTQALI
                                                                           where 1 = 1
                                                                           and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                           AND SZTQALI_PTRM =l_ptrm_pi
                                                                           AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                           AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                       exception when others then
                                                                           null;
                                                                       end;

                                                                    dbms_output.put_line(' Cueneta qali '||l_cuenta_qali);

--                                                                       if l_cuenta_qali > 0 then


                                                                           BEGIN

                                                                               INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                           x.SZTPRONO_ID,
                                                                                                           x.SZTPRONO_TERM_CODE,
                                                                                                           x.SZTPRONO_PROGRAM,
                                                                                                           d.materia,
                                                                                                           l_secuencia,
                                                                                                           x.SZTPRONO_PTRM_CODE,
                                                                                                           d.materia,
                                                                                                           'x',
                                                                                                           x.SZTPRONO_FECHA_INICIO,
                                                                                                           x.SZTPRONO_PTRM_CODE_NW,
                                                                                                           x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                           x.SZTPRONO_AVANCE,
                                                                                                           x.SZTPRONO_NO_REGLA,
                                                                                                           x.SZTPRONO_USUARIO,
                                                                                                           x.SZTPRONO_STUDY_PATH,
                                                                                                           x.SZTPRONO_RATE,
                                                                                                           x.SZTPRONO_JORNADA,
                                                                                                           x.SZTPRONO_ACTIVITY_DATE,
                                                                                                           x.SZTPRONO_CUATRI,
                                                                                                           x.SZTPRONO_TIPO_INICIO,
                                                                                                           x.SZTPRONO_JORNADA_DOS,
                                                                                                           x.SZTPRONO_ENVIO_MOODL,
                                                                                                           x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                           x.SZTPRONO_ESTATUS,
                                                                                                           x.SZTPRONO_ESTATUS_ERROR,
                                                                                                           null,
                                                                                                           x.SZTPRONO_GRUPO_ASIG
                                                                                                           );

                                                                           exception when others then
                                                                               dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                           end;

                                                                           BEGIN
                                                                               UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                               WHERE 1 = 1
                                                                               AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                               AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                               and sztalian_alianza='MUBA';
                                                                           exception when others then
                                                                               null;
                                                                           end;

                                                                           exit when l_contador2 = 1;

--                                                                       end IF;

                                                                   END LOOP;

                                                          exit when l_contador = d.salida;

                                                 END LOOP;

                                             end IF;

                                      elsIF l_nivel ='LI' then

                                             BEGIN

                                               SELECT COUNT(*)
                                               INTO l_cuenta_alianza
                                               FROM SZTALMT
                                               WHERE 1 = 1
                                               AND SZTALMT_NIVEL =l_nivel
                                               AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                               AND SZTALMT_ACTIVO ='S'
                                               AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                           FROM SZSTUME
                                                                           WHERE 1 = 1
                                                                           AND SZSTUME_SUBJ_CODE like 'UBA%'
                                                                           AND EXISTS (SELECT NULL
                                                                                       FROM SZTALIAN
                                                                                       WHERE 1 = 1
                                                                                       AND SZTALIAN_NO_REGLA = p_regla
                                                                                       AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                       AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                       AND sztalian_flex ='PR' ));

                                             exception when others then
                                               null;
                                             end;

                                             IF l_cuenta_alianza > 0 then

                                                 l_contador:= 0;

                                                 FOR d IN
                                                 (
                                                     SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                     SZTALMT_BIM salida,
                                                                     SZTALMT_SECUENCIA secuencia,
                                                                     SZTALMT_ALIANZA alianza
                                                     FROM SZTALMT
                                                     WHERE 1 = 1
                                                     AND SZTALMT_NIVEL =l_nivel
                                                     AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                     AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                     AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                           FROM SZSTUME
                                                                           WHERE 1 = 1
                                                                           AND SZSTUME_SUBJ_CODE like 'UBA%'
                                                                           AND EXISTS (SELECT NULL
                                                                                       FROM SZTALIAN
                                                                                       WHERE 1 = 1
                                                                                       AND SZTALIAN_NO_REGLA = p_regla
                                                                                       AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                       AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                       AND sztalian_flex ='PR' ))
                                                    ORDER BY SZTALMT_SECUENCIA
                                                 )loop

                                                      l_contador:=l_contador+1;

                                                     dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                      l_contador2:=0;

                                                         for x in (SELECT *
                                                                   FROM sztprono
                                                                   WHERE 1 = 1
                                                                   AND sztprono_no_regla = c.sztalian_no_regla
                                                                   AND sztprono_pidm = c.sztalian_pidm
                                                                   )loop

                                                                     l_contador2:=l_contador2+1;

                                                                       BEGIN

                                                                         SELECT nvl(max(sztprono_secuencia),0)+1
                                                                         INTO l_secuencia
                                                                         FROM sztprono
                                                                         WHERE 1 = 1
                                                                         AND sztprono_no_regla = c.sztalian_no_regla
                                                                         AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                       exception when others then
                                                                           null;
                                                                       end;

                                                                       BEGIN

                                                                           SELECT COUNT(*)
                                                                           INTO l_cuenta_mh
                                                                           FROM ssbsect
                                                                           join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                       AND sfrstcr_crn = ssbsect_crn
                                                                           WHERE 1 = 1
                                                                           AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                           AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                           AND SFRSTCR_RSTS_CODE ='RE';

                                                                       exception when others then
                                                                           null;
                                                                       end;

                                                                       IF l_cuenta_mh = 0 then


                                                                           BEGIN

                                                                               INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                           x.SZTPRONO_ID,
                                                                                                           x.SZTPRONO_TERM_CODE,
                                                                                                           x.SZTPRONO_PROGRAM,
                                                                                                           d.materia,
                                                                                                           l_secuencia,
                                                                                                           x.SZTPRONO_PTRM_CODE,
                                                                                                           d.materia,
                                                                                                           'x',
                                                                                                           x.SZTPRONO_FECHA_INICIO,
                                                                                                           x.SZTPRONO_PTRM_CODE_NW,
                                                                                                           x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                           x.SZTPRONO_AVANCE,
                                                                                                           x.SZTPRONO_NO_REGLA,
                                                                                                           x.SZTPRONO_USUARIO,
                                                                                                           x.SZTPRONO_STUDY_PATH,
                                                                                                           x.SZTPRONO_RATE,
                                                                                                           x.SZTPRONO_JORNADA,
                                                                                                           x.SZTPRONO_ACTIVITY_DATE,
                                                                                                           x.SZTPRONO_CUATRI,
                                                                                                           x.SZTPRONO_TIPO_INICIO,
                                                                                                           x.SZTPRONO_JORNADA_DOS,
                                                                                                           x.SZTPRONO_ENVIO_MOODL,
                                                                                                           x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                           x.SZTPRONO_ESTATUS,
                                                                                                           x.SZTPRONO_ESTATUS_ERROR,
                                                                                                           null,
                                                                                                           x.SZTPRONO_GRUPO_ASIG
                                                                                                           );

                                                                           exception when others then
                                                                               dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                           end;

                                                                           BEGIN
                                                                               UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                               WHERE 1 = 1
                                                                               AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                               AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                               and sztalian_alianza='MUBA';
                                                                           exception when others then
                                                                               null;
                                                                           end;

                                                                           exit when l_contador2 = 1;

                                                                       end IF;

                                                                   END LOOP;


                                                          exit when l_contador = d.salida;


                                                 END LOOP;

                                             else

                                                 l_contador:= 0;

                                                 FOR d IN
                                                 (
                                                     SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                     SZTALMT_BIM salida,
                                                                     SZTALMT_SECUENCIA secuencia,
                                                                     SZTALMT_ALIANZA alianza
                                                     FROM SZTALMT
                                                     WHERE 1 = 1
                                                     AND SZTALMT_NIVEL =l_nivel
                                                     AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                     AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                    ORDER BY SZTALMT_SECUENCIA
                                                 )loop

                                                      l_contador:=l_contador+1;

                                                     dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);

                                                          l_contador2:=0;

                                                         for x in (SELECT *
                                                                   FROM sztprono
                                                                   WHERE 1 = 1
                                                                   AND sztprono_no_regla = c.sztalian_no_regla
                                                                   AND sztprono_pidm = c.sztalian_pidm
                                                                   )loop

                                                                     l_contador2:=l_contador2+1;

                                                                       BEGIN

                                                                         SELECT nvl(max(sztprono_secuencia),0)+1
                                                                         INTO l_secuencia
                                                                         FROM sztprono
                                                                         WHERE 1 = 1
                                                                         AND sztprono_no_regla = c.sztalian_no_regla
                                                                         AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                       exception when others then
                                                                           null;
                                                                       end;

                                                                       BEGIN

                                                                           SELECT COUNT(*)
                                                                           INTO l_cuenta_mh
                                                                           FROM ssbsect
                                                                           join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                       AND sfrstcr_crn = ssbsect_crn
                                                                           WHERE 1 = 1
                                                                           AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                           AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                           AND SFRSTCR_RSTS_CODE ='RE';

                                                                       exception when others then
                                                                           null;
                                                                       end;

                                                                       IF l_cuenta_mh = 0 then


                                                                           BEGIN

                                                                               INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                           x.SZTPRONO_ID,
                                                                                                           x.SZTPRONO_TERM_CODE,
                                                                                                           x.SZTPRONO_PROGRAM,
                                                                                                           d.materia,
                                                                                                           l_secuencia,
                                                                                                           x.SZTPRONO_PTRM_CODE,
                                                                                                           d.materia,
                                                                                                           'x',
                                                                                                           x.SZTPRONO_FECHA_INICIO,
                                                                                                           x.SZTPRONO_PTRM_CODE_NW,
                                                                                                           x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                           x.SZTPRONO_AVANCE,
                                                                                                           x.SZTPRONO_NO_REGLA,
                                                                                                           x.SZTPRONO_USUARIO,
                                                                                                           x.SZTPRONO_STUDY_PATH,
                                                                                                           x.SZTPRONO_RATE,
                                                                                                           x.SZTPRONO_JORNADA,
                                                                                                           x.SZTPRONO_ACTIVITY_DATE,
                                                                                                           x.SZTPRONO_CUATRI,
                                                                                                           x.SZTPRONO_TIPO_INICIO,
                                                                                                           x.SZTPRONO_JORNADA_DOS,
                                                                                                           x.SZTPRONO_ENVIO_MOODL,
                                                                                                           x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                           x.SZTPRONO_ESTATUS,
                                                                                                           x.SZTPRONO_ESTATUS_ERROR,
                                                                                                           null,
                                                                                                           x.SZTPRONO_GRUPO_ASIG
                                                                                                           );

                                                                           exception when others then
                                                                               dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                           end;

                                                                           BEGIN
                                                                               UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                               WHERE 1 = 1
                                                                               AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                               AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                               and sztalian_alianza='MUBA';
                                                                           exception when others then
                                                                               null;
                                                                           end;

                                                                           exit when l_contador2 = 1;

                                                                       end IF;

                                                                   END LOOP;

                                                          exit when l_contador = d.salida;

                                                 END LOOP;

                                             end IF;

                                      elsIF l_nivel ='DO' then

                                             BEGIN

                                               SELECT COUNT(*)
                                               INTO l_cuenta_alianza
                                               FROM SZTALMT
                                               WHERE 1 = 1
                                               AND SZTALMT_NIVEL =l_nivel
                                               AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                               AND SZTALMT_ACTIVO ='S'
                                               AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                           FROM SZSTUME
                                                                           WHERE 1 = 1
                                                                           AND SZSTUME_SUBJ_CODE like 'UBA%'
                                                                           AND EXISTS (SELECT NULL
                                                                                       FROM SZTALIAN
                                                                                       WHERE 1 = 1
                                                                                       AND SZTALIAN_NO_REGLA = p_regla
                                                                                       AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                       AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                       AND sztalian_flex ='PR' ));

                                             exception when others then
                                               null;
                                             end;

                                             IF l_cuenta_alianza > 0 then

                                                 l_contador:= 0;

                                                 FOR d IN
                                                 (
                                                     SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                     SZTALMT_BIM salida,
                                                                     SZTALMT_SECUENCIA secuencia,
                                                                     SZTALMT_ALIANZA alianza
                                                     FROM SZTALMT
                                                     WHERE 1 = 1
                                                     AND SZTALMT_NIVEL =l_nivel
                                                     AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                     AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                     AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                           FROM SZSTUME
                                                                           WHERE 1 = 1
                                                                           AND SZSTUME_SUBJ_CODE like 'UBA%'
                                                                           AND EXISTS (SELECT NULL
                                                                                       FROM SZTALIAN
                                                                                       WHERE 1 = 1
                                                                                       AND SZTALIAN_NO_REGLA = p_regla
                                                                                       AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                       AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                       AND sztalian_flex ='PR' ))
                                                    ORDER BY SZTALMT_SECUENCIA
                                                 )loop

                                                      l_contador:=l_contador+1;

                                                     dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                      l_contador2:=0;

                                                         for x in (SELECT *
                                                                   FROM sztprono
                                                                   WHERE 1 = 1
                                                                   AND sztprono_no_regla = c.sztalian_no_regla
                                                                   AND sztprono_pidm = c.sztalian_pidm
                                                                   )loop

                                                                     l_contador2:=l_contador2+1;

                                                                       BEGIN

                                                                         SELECT nvl(max(sztprono_secuencia),0)+1
                                                                         INTO l_secuencia
                                                                         FROM sztprono
                                                                         WHERE 1 = 1
                                                                         AND sztprono_no_regla = c.sztalian_no_regla
                                                                         AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                       exception when others then
                                                                           null;
                                                                       end;

                                                                       BEGIN

                                                                           SELECT COUNT(*)
                                                                           INTO l_cuenta_mh
                                                                           FROM ssbsect
                                                                           join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                       AND sfrstcr_crn = ssbsect_crn
                                                                           WHERE 1 = 1
                                                                           AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                           AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                           AND SFRSTCR_RSTS_CODE ='RE';

                                                                       exception when others then
                                                                           null;
                                                                       end;

                                                                       IF l_cuenta_mh = 0 then


                                                                           BEGIN

                                                                               INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                           x.SZTPRONO_ID,
                                                                                                           x.SZTPRONO_TERM_CODE,
                                                                                                           x.SZTPRONO_PROGRAM,
                                                                                                           d.materia,
                                                                                                           l_secuencia,
                                                                                                           x.SZTPRONO_PTRM_CODE,
                                                                                                           d.materia,
                                                                                                           'x',
                                                                                                           x.SZTPRONO_FECHA_INICIO,
                                                                                                           x.SZTPRONO_PTRM_CODE_NW,
                                                                                                           x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                           x.SZTPRONO_AVANCE,
                                                                                                           x.SZTPRONO_NO_REGLA,
                                                                                                           x.SZTPRONO_USUARIO,
                                                                                                           x.SZTPRONO_STUDY_PATH,
                                                                                                           x.SZTPRONO_RATE,
                                                                                                           x.SZTPRONO_JORNADA,
                                                                                                           x.SZTPRONO_ACTIVITY_DATE,
                                                                                                           x.SZTPRONO_CUATRI,
                                                                                                           x.SZTPRONO_TIPO_INICIO,
                                                                                                           x.SZTPRONO_JORNADA_DOS,
                                                                                                           x.SZTPRONO_ENVIO_MOODL,
                                                                                                           x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                           x.SZTPRONO_ESTATUS,
                                                                                                           x.SZTPRONO_ESTATUS_ERROR,
                                                                                                           null,
                                                                                                           x.SZTPRONO_GRUPO_ASIG
                                                                                                           );

                                                                           exception when others then
                                                                               dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                           end;

                                                                           BEGIN
                                                                               UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                               WHERE 1 = 1
                                                                               AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                               AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                               and sztalian_alianza='MUBA';
                                                                           exception when others then
                                                                               null;
                                                                           end;

                                                                           exit when l_contador2 = 1;

                                                                       end IF;

                                                                   END LOOP;


                                                          exit when l_contador = d.salida;


                                                 END LOOP;

                                             else

                                                 l_contador:= 0;

                                                 FOR d IN
                                                 (
                                                     SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                     SZTALMT_BIM salida,
                                                                     SZTALMT_SECUENCIA secuencia,
                                                                     SZTALMT_ALIANZA alianza
                                                     FROM SZTALMT
                                                     WHERE 1 = 1
                                                     AND SZTALMT_NIVEL =l_nivel
                                                     AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                     AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                 )loop

                                                      l_contador:=l_contador+1;

                                                     dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);

                                                          l_contador2:=0;

                                                         for x in (SELECT *
                                                                   FROM sztprono
                                                                   WHERE 1 = 1
                                                                   AND sztprono_no_regla = c.sztalian_no_regla
                                                                   AND sztprono_pidm = c.sztalian_pidm
                                                                   )loop

                                                                     l_contador2:=l_contador2+1;

                                                                       BEGIN

                                                                         SELECT nvl(max(sztprono_secuencia),0)+1
                                                                         INTO l_secuencia
                                                                         FROM sztprono
                                                                         WHERE 1 = 1
                                                                         AND sztprono_no_regla = c.sztalian_no_regla
                                                                         AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                       exception when others then
                                                                           null;
                                                                       end;

                                                                       BEGIN

                                                                           SELECT COUNT(*)
                                                                           INTO l_cuenta_mh
                                                                           FROM ssbsect
                                                                           join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                       AND sfrstcr_crn = ssbsect_crn
                                                                           WHERE 1 = 1
                                                                           AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                           AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                           AND SFRSTCR_RSTS_CODE ='RE';

                                                                       exception when others then
                                                                           null;
                                                                       end;

                                                                       IF l_cuenta_mh = 0 then


                                                                           BEGIN

                                                                               INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                           x.SZTPRONO_ID,
                                                                                                           x.SZTPRONO_TERM_CODE,
                                                                                                           x.SZTPRONO_PROGRAM,
                                                                                                           d.materia,
                                                                                                           l_secuencia,
                                                                                                           x.SZTPRONO_PTRM_CODE,
                                                                                                           d.materia,
                                                                                                           'x',
                                                                                                           x.SZTPRONO_FECHA_INICIO,
                                                                                                           x.SZTPRONO_PTRM_CODE_NW,
                                                                                                           x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                           x.SZTPRONO_AVANCE,
                                                                                                           x.SZTPRONO_NO_REGLA,
                                                                                                           x.SZTPRONO_USUARIO,
                                                                                                           x.SZTPRONO_STUDY_PATH,
                                                                                                           x.SZTPRONO_RATE,
                                                                                                           x.SZTPRONO_JORNADA,
                                                                                                           x.SZTPRONO_ACTIVITY_DATE,
                                                                                                           x.SZTPRONO_CUATRI,
                                                                                                           x.SZTPRONO_TIPO_INICIO,
                                                                                                           x.SZTPRONO_JORNADA_DOS,
                                                                                                           x.SZTPRONO_ENVIO_MOODL,
                                                                                                           x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                           x.SZTPRONO_ESTATUS,
                                                                                                           x.SZTPRONO_ESTATUS_ERROR,
                                                                                                           null,
                                                                                                           x.SZTPRONO_GRUPO_ASIG
                                                                                                           );

                                                                           exception when others then
                                                                               dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                           end;

                                                                           BEGIN
                                                                               UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                               WHERE 1 = 1
                                                                               AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                               AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                               and sztalian_alianza='MUBA';
                                                                           exception when others then
                                                                               null;
                                                                           end;

                                                                           exit when l_contador2 = 1;

                                                                       end IF;

                                                                   END LOOP;

                                                          exit when l_contador = d.salida;

                                                 END LOOP;

                                             end IF;


                                  end IF;

                              end loop;
        commit;
    end;
--
--
    PROCEDURE p_fcbk_regla(p_regla   NUMBER)
    is
       l_cuenta_nivel_li     number;
       l_cuenta_nivel_ma     number;
       l_cuenta_nivel_do     number;
       l_nivel               varchar2(2);
       l_avance              number;
       l_materias_alianza    number;
       l_materias_para       number;
       l_peirod_uni          varchar2(2);
       l_contador            number:=0;
       l_avance_pidm         number;
       l_contador2           number:=0;
       l_secuencia           number;
       l_cuenta_alianza      number;
       l_cuenta_mh           number;
       l_cuenta_qali         number;
       l_ptrm_pi             varchar2(3);
    begin

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_li
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_ma
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_do
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma > 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  IF;

        dbms_output.put_line('Nievl '||l_nivel);


        DELETE sztalian
        WHERE 1 = 1
        AND sztalian_no_regla = p_regla
        AND SZTALIAN_FLEX ='PR'
        and SZTALIAN_ALIANZA='FCBK';

         for c in ( SELECT distinct (SELECT  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            FROM SMRPRLE
                            WHERE 1 = 1
                            AND SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'FCBK' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
                    FROM sztprono
                    WHERE 1 = 1
--                    and sztprono_id='010362676'
                    AND sztprono_no_regla = p_regla
                    AND EXISTS (SELECT NULL
                                FROM GORADID
                                WHERE 1 = 1
                                AND GORADID_PIDM = SZTPRONO_PIDM
                                AND  GORADID_ADID_CODE ='FCBK')
                    )loop


                        BEGIN

                          SELECT MAX(zstpara_param_id)
                          INTO l_avance
                          FROM ZSTPARA
                          WHERE 1 = 1
                          AND zstpara_mapa_id ='INSCRIPCIONES'
                          AND zstpara_param_valor = c.avance
                          AND zstpara_param_desc = c.tipo_inicio;

                        exception when others then
                            null;
                        end;

                        BEGIN


                         --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                          INSERT INTO sztalian VALUES (c.pidm,
                                                       c.matricula,
                                                       c.programa,
                                                       c.alianza,
                                                       l_avance,
                                                       c.regla,
                                                       'N',
                                                       nvl(l_materias_para,0),
                                                       nvl(l_materias_alianza,0),
                                                       c.tipo_inicio,
                                                       'PR'
                                                       );

                        EXCEPTION WHEN OTHERS THEN
                         NULL;
                        END;

                        COMMIT;


                    end loop;

                    for c in (SELECT *
                              FROM sztalian
                              WHERE 1 = 1
                              AND sztalian_no_regla = p_regla
                              AND SZTALIAN_FLEX ='PR'
                              and SZTALIAN_ALIANZA ='FCBK'
                              )loop

                                       IF l_nivel ='MA'  then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'FACE%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ));

                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                        AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'FACE%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ))
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                            begin

                                                                                SELECT distinct PTRM_PI
                                                                                into l_ptrm_pi
                                                                                FROM TABLE(BANINST1.PKG_REPORTES_PIPELINED.F_ASIGNACION_MATERIAS(x.sztprono_no_regla))
                                                                                WHERE 1 = 1
                                                                                AND MATRICULA =x.sztprono_id
                                                                                and regla = x.sztprono_no_regla;

                                                                            exception when others then
                                                                              null;
                                                                            end;

                                                                            begin

                                                                                select count(*)
                                                                                into l_cuenta_qali
                                                                                from SZTQALI
                                                                                where 1 = 1
                                                                                and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                AND SZTQALI_PTRM =l_ptrm_pi
                                                                                AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                                AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                            exception when others then
                                                                                null;
                                                                            end;

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_qali > 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='FCBK';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          begin

                                                                              SELECT distinct PTRM_PI
                                                                              into l_ptrm_pi
                                                                              FROM TABLE(BANINST1.PKG_REPORTES_PIPELINED.F_ASIGNACION_MATERIAS(x.sztprono_no_regla))
                                                                              WHERE 1 = 1
                                                                              AND MATRICULA =x.sztprono_id
                                                                              and regla = x.sztprono_no_regla;

                                                                          exception when others then
                                                                            null;
                                                                          end;

                                                                         begin

                                                                             select count(*)
                                                                             into l_cuenta_qali
                                                                             from SZTQALI
                                                                             where 1 = 1
                                                                             and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                             AND SZTQALI_PTRM =l_ptrm_pi
                                                                             AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                             AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                         exception when others then
                                                                             null;
                                                                         end;

                                                                          IF l_cuenta_qali > 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='FCBK';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;


                                                end IF;


                                       elsIF l_nivel ='LI' then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'FACE%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ));

                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                        AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'FACE%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ))
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id||' avance '||C.SZTALIAN_AVANCE);


                                                        IF C.SZTALIAN_AVANCE IN (3,4) THEN

                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                          x.SZTPRONO_ID,
                                                                                                          x.SZTPRONO_TERM_CODE,
                                                                                                          x.SZTPRONO_PROGRAM,
                                                                                                          d.materia,
                                                                                                          l_secuencia,
                                                                                                          x.SZTPRONO_PTRM_CODE,
                                                                                                          d.materia,
                                                                                                          'x',
                                                                                                          x.SZTPRONO_FECHA_INICIO,
                                                                                                          x.SZTPRONO_PTRM_CODE_NW,
                                                                                                          x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                          x.SZTPRONO_AVANCE,
                                                                                                          x.SZTPRONO_NO_REGLA,
                                                                                                          x.SZTPRONO_USUARIO,
                                                                                                          x.SZTPRONO_STUDY_PATH,
                                                                                                          x.SZTPRONO_RATE,
                                                                                                          x.SZTPRONO_JORNADA,
                                                                                                          x.SZTPRONO_ACTIVITY_DATE,
                                                                                                          x.SZTPRONO_CUATRI,
                                                                                                          x.SZTPRONO_TIPO_INICIO,
                                                                                                          x.SZTPRONO_JORNADA_DOS,
                                                                                                          x.SZTPRONO_ENVIO_MOODL,
                                                                                                          x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                          x.SZTPRONO_ESTATUS,
                                                                                                          x.SZTPRONO_ESTATUS_ERROR,
                                                                                                          null,
                                                                                                          x.SZTPRONO_GRUPO_ASIG
                                                                                                          );

                                                                          exception when others then
                                                                              dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                          end;

                                                                          BEGIN
                                                                              UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                              WHERE 1 = 1
                                                                              AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                              AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                              AND SZTALIAN_ALIANZA ='FCBK';
                                                                          exception when others then
                                                                              null;
                                                                          end;


                                                                              exit when l_contador2 = 1;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        end IF;

                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        IF C.SZTALIAN_AVANCE in (3,4) THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          --IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='FCBK';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          --end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        end IF;

                                                    END LOOP;


                                                end IF;

                                        elsIF l_nivel ='DO'  then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'FACE%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ));

                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                        AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'FACE%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ))
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                      --  IF C.SZTALIAN_AVANCE > 2 THEN

                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA='FCBK';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                       -- end IF;

                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA='FCBK';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;


                                                end IF;

                                       END IF;

                              end loop;
        commit;
    end;
--
--
    PROCEDURE p_coll_regla(p_regla   NUMBER)
    is
       l_cuenta_nivel_li     number;
       l_cuenta_nivel_ma     number;
       l_cuenta_nivel_do     number;
       l_nivel               varchar2(2);
       l_avance              number;
       l_materias_alianza    number;
       l_materias_para       number;
       l_peirod_uni          varchar2(2);
       l_contador            number:=0;
       l_avance_pidm         number;
       l_contador2           number:=0;
       l_secuencia           number;
       l_cuenta_alianza      number;
       l_cuenta_mh           number;
       l_cuenta_qali         number;
       l_ptrm_pi             varchar2(3);
    begin

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_li
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_ma
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_do
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma > 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  IF;

        dbms_output.put_line('Nievl '||l_nivel);


        DELETE sztalian
        WHERE 1 = 1
        AND sztalian_no_regla = p_regla
        AND SZTALIAN_FLEX ='PR'
        and SZTALIAN_ALIANZA='COLL';

         for c in ( SELECT distinct (SELECT  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            FROM SMRPRLE
                            WHERE 1 = 1
                            AND SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'COLL' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
                    FROM sztprono
                    WHERE 1 = 1
                    AND sztprono_no_regla = p_regla
                    AND EXISTS (SELECT NULL
                                FROM GORADID
                                WHERE 1 = 1
                                AND GORADID_PIDM = SZTPRONO_PIDM
                                AND  GORADID_ADID_CODE ='COLL')
                    )loop


                        BEGIN

                          SELECT MAX(zstpara_param_id)
                          INTO l_avance
                          FROM ZSTPARA
                          WHERE 1 = 1
                          AND zstpara_mapa_id ='INSCRIPCIONES'
                          AND zstpara_param_valor = c.avance
                          AND zstpara_param_desc = c.tipo_inicio;

                        exception when others then
                            null;
                        end;

                        BEGIN


                         --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                          INSERT INTO sztalian VALUES (c.pidm,
                                                       c.matricula,
                                                       c.programa,
                                                       c.alianza,
                                                       l_avance,
                                                       c.regla,
                                                       'N',
                                                       nvl(l_materias_para,0),
                                                       nvl(l_materias_alianza,0),
                                                       c.tipo_inicio,
                                                       'PR'
                                                       );

                        EXCEPTION WHEN OTHERS THEN
                         NULL;
                        END;

                        COMMIT;


                    end loop;

                    for c in (SELECT *
                              FROM sztalian
                              WHERE 1 = 1
                              AND sztalian_no_regla = p_regla
                              AND SZTALIAN_FLEX ='PR'
                              and SZTALIAN_ALIANZA ='COLL'
                              )loop

                                        IF l_nivel ='MA'  then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'EXCO%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ));

                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                        AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'EXCO%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ))
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);

                                                                            begin

                                                                                select count(*)
                                                                                into l_cuenta_qali
                                                                                from SZTQALI
                                                                                where 1 = 1
                                                                                and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                AND SZTQALI_PTRM =l_ptrm_pi
                                                                                AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                                AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                            exception when others then
                                                                                null;
                                                                            end;

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_qali > 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='COLL';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;
                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);

                                                                         begin

                                                                             select count(*)
                                                                             into l_cuenta_qali
                                                                             from SZTQALI
                                                                             where 1 = 1
                                                                             and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                             AND SZTQALI_PTRM =l_ptrm_pi
                                                                             AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                             AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                         exception when others then
                                                                             null;
                                                                         end;

                                                                          IF l_cuenta_qali > 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='COLL';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;


                                                end IF;


                                       elsIF l_nivel ='LI' then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                       AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'EXCO%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ));

                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                       AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'EXCO%'
                                                                                    and SZSTUME_PIDM = c.SZTALIAN_pidm
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ))
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id||' avance '||C.SZTALIAN_AVANCE);


                                                        IF C.SZTALIAN_AVANCE >= 1 THEN

                                                        --para contar desde el segundo bimestre

                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;



                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='COLL';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        end IF;

                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        IF C.SZTALIAN_AVANCE in (3) THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                       --   IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='COLL';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                        --  end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        end IF;

                                                    END LOOP;


                                                end IF;

                                        elsIF l_nivel ='DO'  then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                       AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'EXCO%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ));

                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                          AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'EXCO%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ))
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                      --  IF C.SZTALIAN_AVANCE > 2 THEN

                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA='COLL';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                       -- end IF;

                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA='COLL';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;


                                                end IF;

                                       END IF;

                              end loop;
        commit;
    end;
--
--
    PROCEDURE p_ssen_regla(p_regla   NUMBER)
    is
       l_cuenta_nivel_li     number;
       l_cuenta_nivel_ma     number;
       l_cuenta_nivel_do     number;
       l_nivel               varchar2(2);
       l_avance              number;
       l_materias_alianza    number;
       l_materias_para       number;
       l_peirod_uni          varchar2(2);
       l_contador            number:=0;
       l_avance_pidm         number;
       l_contador2           number:=0;
       l_secuencia           number;
       l_cuenta_alianza      number;
       l_cuenta_mh           number;
       l_cuenta_qali         number;
       l_ptrm_pi             varchar2(3);
    begin

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_li
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_ma
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_do
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma > 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  IF;

        dbms_output.put_line('Nievl '||l_nivel);


        DELETE sztalian
        WHERE 1 = 1
        AND sztalian_no_regla = p_regla
        AND SZTALIAN_FLEX ='PR'
        and SZTALIAN_ALIANZA='SENI';

         for c in ( SELECT distinct (SELECT  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            FROM SMRPRLE
                            WHERE 1 = 1
                            AND SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'SENI' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
                    FROM sztprono
                    WHERE 1 = 1
                    AND sztprono_no_regla = p_regla
                    AND EXISTS (SELECT NULL
                                FROM GORADID
                                WHERE 1 = 1
                                AND GORADID_PIDM = SZTPRONO_PIDM
                                AND  GORADID_ADID_CODE ='SENI')
                    )loop


                        BEGIN

                          SELECT MAX(zstpara_param_id)
                          INTO l_avance
                          FROM ZSTPARA
                          WHERE 1 = 1
                          AND zstpara_mapa_id ='INSCRIPCIONES'
                          AND zstpara_param_valor = c.avance
                          AND zstpara_param_desc = c.tipo_inicio;

                        exception when others then
                            null;
                        end;

                        BEGIN


                         --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                          INSERT INTO sztalian VALUES (c.pidm,
                                                       c.matricula,
                                                       c.programa,
                                                       c.alianza,
                                                       l_avance,
                                                       c.regla,
                                                       'N',
                                                       nvl(l_materias_para,0),
                                                       nvl(l_materias_alianza,0),
                                                       c.tipo_inicio,
                                                       'PR'
                                                       );

                        EXCEPTION WHEN OTHERS THEN
                         NULL;
                        END;

                        COMMIT;


                    end loop;

                    for c in (SELECT *
                              FROM sztalian
                              WHERE 1 = 1
                              AND sztalian_no_regla = p_regla
                              AND SZTALIAN_FLEX ='PR'
                              and SZTALIAN_ALIANZA ='SENI'
                              )loop

                                        IF l_nivel ='MA'  then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                FROM ssbsect
                                                                                join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                            AND sfrstcr_crn = ssbsect_crn
                                                                                WHERE 1 = 1
                                                                                AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'SSEN%'
                                                                                AND EXISTS (SELECT NULL
                                                                                            FROM SZTALIAN
                                                                                            WHERE 1 = 1
                                                                                            AND SZTALIAN_NO_REGLA = p_regla
                                                                                            AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                            AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                            AND sztalian_flex ='PR' )
                                                                                 );

                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                        AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                    FROM ssbsect
                                                                                    join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                                AND sfrstcr_crn = ssbsect_crn
                                                                                    WHERE 1 = 1
                                                                                    AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'SSEN%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' )
                                                                                     )
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);

                                                                            begin

                                                                                select count(*)
                                                                                into l_cuenta_qali
                                                                                from SZTQALI
                                                                                where 1 = 1
                                                                                and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                AND SZTQALI_PTRM =l_ptrm_pi
                                                                                AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                                AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                            exception when others then
                                                                                null;
                                                                            end;

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_qali > 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='SENI';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);

                                                                         begin

                                                                             select count(*)
                                                                             into l_cuenta_qali
                                                                             from SZTQALI
                                                                             where 1 = 1
                                                                             and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                             AND SZTQALI_PTRM =l_ptrm_pi
                                                                             AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                             AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                         exception when others then
                                                                             null;
                                                                         end;

                                                                          IF l_cuenta_qali > 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='SENI';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;


                                                end IF;


                                       elsIF l_nivel ='LI' then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                FROM ssbsect
                                                                                join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                            AND sfrstcr_crn = ssbsect_crn
                                                                                WHERE 1 = 1
                                                                                AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'SSEN%'
                                                                                AND EXISTS (SELECT NULL
                                                                                            FROM SZTALIAN
                                                                                            WHERE 1 = 1
                                                                                            AND SZTALIAN_NO_REGLA = p_regla
                                                                                            AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                            AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                            AND sztalian_flex ='PR' )
                                                                                 );

                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                        AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                    FROM ssbsect
                                                                                    join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                                AND sfrstcr_crn = ssbsect_crn
                                                                                    WHERE 1 = 1
                                                                                    AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'SSEN%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' )
                                                                                     )
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id||' avance '||C.SZTALIAN_AVANCE);


                                                        --IF C.SZTALIAN_AVANCE IN (3) THEN

                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;



                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='SENI';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                       -- end IF;

                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE in (3) THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='SENI';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;


                                                end IF;

                                        elsIF l_nivel ='DO'  then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                FROM ssbsect
                                                                                join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                            AND sfrstcr_crn = ssbsect_crn
                                                                                WHERE 1 = 1
                                                                                AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'SSEN%'
                                                                                AND EXISTS (SELECT NULL
                                                                                            FROM SZTALIAN
                                                                                            WHERE 1 = 1
                                                                                            AND SZTALIAN_NO_REGLA = p_regla
                                                                                            AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                            AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                            AND sztalian_flex ='PR' )
                                                                                 );

                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                        AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                    FROM ssbsect
                                                                                    join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                                AND sfrstcr_crn = ssbsect_crn
                                                                                    WHERE 1 = 1
                                                                                    AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'SSEN%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' )
                                                                                     )
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                      --  IF C.SZTALIAN_AVANCE > 2 THEN

                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA='SENI';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                       -- end IF;

                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA='SENI';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;


                                                end IF;

                                       END IF;

                              end loop;
        commit;
    end;
--
--
    PROCEDURE p_cesa_regla(p_regla   NUMBER)
    is
       l_cuenta_nivel_li     number;
       l_cuenta_nivel_ma     number;
       l_cuenta_nivel_do     number;
       l_nivel               varchar2(2);
       l_avance              number;
       l_materias_alianza    number;
       l_materias_para       number;
       l_peirod_uni          varchar2(2);
       l_contador            number:=0;
       l_avance_pidm         number;
       l_contador2           number:=0;
       l_secuencia           number;
       l_cuenta_alianza      number;
       l_cuenta_mh           number;
       l_cuenta_qali         number;
       l_ptrm_pi             varchar2(3);
    begin

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_li
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_ma
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_do
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma > 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  IF;

        dbms_output.put_line('Nievl '||l_nivel);


        DELETE sztalian
        WHERE 1 = 1
        AND sztalian_no_regla = p_regla
        AND SZTALIAN_FLEX ='PR'
        and SZTALIAN_ALIANZA='CESA';

         for c in ( SELECT distinct (SELECT  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            FROM SMRPRLE
                            WHERE 1 = 1
                            AND SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'CESA' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
                    FROM sztprono
                    WHERE 1 = 1
                    AND sztprono_no_regla = p_regla
--                    and sztprono_id ='010385656'
                    AND EXISTS (SELECT NULL
                                FROM GORADID
                                WHERE 1 = 1
                                AND GORADID_PIDM = SZTPRONO_PIDM
                                AND  GORADID_ADID_CODE ='CESA')
                    )loop


                        BEGIN

                          SELECT MAX(zstpara_param_id)
                          INTO l_avance
                          FROM ZSTPARA
                          WHERE 1 = 1
                          AND zstpara_mapa_id ='INSCRIPCIONES'
                          AND zstpara_param_valor = c.avance
                          AND zstpara_param_desc = c.tipo_inicio;

                        exception when others then
                            null;
                        end;

                        BEGIN

                         --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                          INSERT INTO sztalian VALUES (c.pidm,
                                                       c.matricula,
                                                       c.programa,
                                                       c.alianza,
                                                       l_avance,
                                                       c.regla,
                                                       'N',
                                                       nvl(l_materias_para,0),
                                                       nvl(l_materias_alianza,0),
                                                       c.tipo_inicio,
                                                       'PR'
                                                       );
                        EXCEPTION WHEN OTHERS THEN
                         NULL;
                        END;

                        COMMIT;


                    end loop;

                    for c in (SELECT *
                              FROM sztalian
                              WHERE 1 = 1
                              AND sztalian_no_regla = p_regla
                              AND SZTALIAN_FLEX ='PR'
                              and SZTALIAN_ALIANZA ='CESA'
                              )loop

                                       IF l_nivel ='MA'  then

                                            dbms_output.put_line ('Entra a cesa');


                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                FROM ssbsect
                                                                                join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                            AND sfrstcr_crn = ssbsect_crn
                                                                                WHERE 1 = 1
                                                                                AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'CESA%'
                                                                                AND EXISTS (SELECT NULL
                                                                                            FROM SZTALIAN
                                                                                            WHERE 1 = 1
                                                                                            AND SZTALIAN_NO_REGLA = p_regla
                                                                                            AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                            AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                            AND sztalian_flex ='PR' )
                                                                                 );

                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                        AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                    FROM ssbsect
                                                                                    join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                                AND sfrstcr_crn = ssbsect_crn
                                                                                    WHERE 1 = 1
                                                                                    AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'CESA%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' )
                                                                                     )
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);
                                                                            begin

                                                                                select count(*)
                                                                                into l_cuenta_qali
                                                                                from SZTQALI
                                                                                where 1 = 1
                                                                                and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                AND SZTQALI_PTRM =l_ptrm_pi
                                                                                AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                                AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                            exception when others then
                                                                                null;
                                                                            end;

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          --IF l_cuenta_qali > 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='CESA';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          --end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);

                                                                         begin

                                                                             select count(*)
                                                                             into l_cuenta_qali
                                                                             from SZTQALI
                                                                             where 1 = 1
                                                                             and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                             AND SZTQALI_PTRM =l_ptrm_pi
                                                                             AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                             AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                         exception when others then
                                                                             null;
                                                                         end;

                                                                          --IF l_cuenta_qali > 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='CESA';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          --end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;


                                                end IF;


                                       elsIF l_nivel ='LI' then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                FROM ssbsect
                                                                                join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                            AND sfrstcr_crn = ssbsect_crn
                                                                                WHERE 1 = 1
                                                                                AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'CESA%'
                                                                                AND EXISTS (SELECT NULL
                                                                                            FROM SZTALIAN
                                                                                            WHERE 1 = 1
                                                                                            AND SZTALIAN_NO_REGLA = p_regla
                                                                                            AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                            AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                            AND sztalian_flex ='PR' )
                                                                                 );

                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                        AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                    FROM ssbsect
                                                                                    join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                                AND sfrstcr_crn = ssbsect_crn
                                                                                    WHERE 1 = 1
                                                                                    AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'CESA%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' )
                                                                                     )
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia -->1   '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id||' avance '||C.SZTALIAN_AVANCE);


                                                        --IF C.SZTALIAN_AVANCE IN (3) THEN

                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;



                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='CESA';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                       -- end IF;

                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia -->2  '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE in (3) THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='CESA';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;


                                                end IF;

                                        elsIF l_nivel ='DO'  then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                FROM ssbsect
                                                                                join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                            AND sfrstcr_crn = ssbsect_crn
                                                                                WHERE 1 = 1
                                                                                AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'CESA%'
                                                                                AND EXISTS (SELECT NULL
                                                                                            FROM SZTALIAN
                                                                                            WHERE 1 = 1
                                                                                            AND SZTALIAN_NO_REGLA = p_regla
                                                                                            AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                            AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                            AND sztalian_flex ='PR' )
                                                                                 );

                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                        AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                    FROM ssbsect
                                                                                    join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                                AND sfrstcr_crn = ssbsect_crn
                                                                                    WHERE 1 = 1
                                                                                    AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'CESA%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' )
                                                                                     )
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                      --  IF C.SZTALIAN_AVANCE > 2 THEN

                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA='CESA';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                       -- end IF;

                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA='CESA';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;


                                                end IF;

                                       END IF;

                              end loop;
        commit;
    end;

--
--
    PROCEDURE p_cour_regla(p_regla   NUMBER)
    is
       l_cuenta_nivel_li     NUMBER;
       l_cuenta_nivel_ma     NUMBER;
       l_cuenta_nivel_do     NUMBER;
       l_nivel               VARCHAR2(2);
       l_avance              NUMBER;
       l_materias_alianza    NUMBER;
       l_materias_para       NUMBER;
       l_peirod_uni          VARCHAR2(2);
       l_contador            NUMBER:=0;
       l_avance_pidm         NUMBER;
       l_contador2           NUMBER:=0;
       l_secuencia           NUMBER;
       l_cuenta_alianza      NUMBER;
       l_cuenta_mh           NUMBER;
       l_cuenta_qali         NUMBER;
       l_ptrm_pi             VARCHAR2(3);
       l_cuenta_1ss          NUMBER;
       l_fecha_new           date;
    begin

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_li
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_ma
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_do
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma > 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  IF;

         begin

            select distinct SZTALGO_FECHA_NEW
            into l_fecha_new
            from sztalgo
            where 1 = 1
            and sztalgo_no_regla = p_regla;

         exception when others then
            null;
         end;

        dbms_output.put_line('Nievl '||l_nivel);


        DELETE sztalian
        WHERE 1 = 1
        AND sztalian_no_regla = p_regla
        AND SZTALIAN_ALIANZA ='COUR'
        AND SZTALIAN_FLEX ='PR';

         for c in ( SELECT distinct (SELECT  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            FROM SMRPRLE
                            WHERE 1 = 1
                            AND SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'COUR' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
                    FROM sztprono
                    WHERE 1 = 1
                    AND sztprono_no_regla = p_regla
--                    and sztprono_id ='010385720'
                    AND EXISTS (SELECT NULL
                                FROM GORADID
                                WHERE 1 = 1
                                AND GORADID_PIDM = SZTPRONO_PIDM
                                AND  GORADID_ADID_CODE ='COUR')
                    )loop


                        BEGIN

                          SELECT MAX(zstpara_param_id)
                          INTO l_avance
                          FROM ZSTPARA
                          WHERE 1 = 1
                          AND zstpara_mapa_id ='INSCRIPCIONES'
                          AND zstpara_param_valor = c.avance
                          AND zstpara_param_desc = c.tipo_inicio;

                        exception when others then
                            null;
                        end;

                        BEGIN


                         --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                          INSERT INTO sztalian VALUES (c.pidm,
                                                       c.matricula,
                                                       c.programa,
                                                       c.alianza,
                                                       l_avance,
                                                       c.regla,
                                                       'N',
                                                       nvl(l_materias_para,0),
                                                       nvl(l_materias_alianza,0),
                                                       c.tipo_inicio,
                                                       'PR'
                                                       );

                        EXCEPTION WHEN OTHERS THEN
                         NULL;
                        END;

                        COMMIT;


                    end loop;

                    for c in (SELECT *
                              FROM sztalian
                              WHERE 1 = 1
                              AND sztalian_no_regla = p_regla
                              AND SZTALIAN_FLEX ='PR'
                              and SZTALIAN_ALIANZA ='COUR'
                              )loop

                                  begin

                                    select count(*)
                                    into l_cuenta_1ss
                                    from sztsenr
                                    where 1 = 1
                                    and SZTSENR_ESTATUS ='1'
                                    and sztsenr_pidm = c.SZTALIAN_PIDM;

                                  exception when others then
                                        null;
                                  end;

                                  if l_cuenta_1ss = 0 then

                                       IF l_nivel ='MA'  then

                                          dbms_output.put_line('Entra a coursera');

                                           BEGIN


                                               SELECT COUNT(*)
                                               INTO l_cuenta_alianza
                                               FROM SZTALMT
                                               WHERE 1 = 1
                                               AND SZTALMT_NIVEL = l_nivel
                                               AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                               AND SZTALMT_ACTIVO ='S'
                                               AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'COU%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ))
                                                    ORDER BY SZTALMT_SECUENCIA;

                                           exception when others then
                                               null;
                                           end;

                                           IF l_cuenta_alianza > 0 then

                                               l_contador:= 0;

                                               FOR d IN
                                               (
                                                   SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                   SZTALMT_BIM salida,
                                                                   SZTALMT_SECUENCIA secuencia,
                                                                   SZTALMT_ALIANZA alianza
                                                   FROM SZTALMT
                                                   WHERE 1 = 1
                                                   AND SZTALMT_NIVEL =l_nivel
                                                   AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                   AND SZTALMT_ACTIVO ='S'
                                                   AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'COU%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ))
                                                    ORDER BY SZTALMT_SECUENCIA
                                               )loop

                                                    l_contador:=l_contador+1;

                                                   dbms_output.put_line('Materia --> 1'||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                   --IF C.SZTALIAN_AVANCE > 2 THEN

                                                       l_contador2:=0;

                                                       for x in (SELECT *
                                                                 FROM sztprono
                                                                 WHERE 1 = 1
                                                                 AND sztprono_no_regla = c.sztalian_no_regla
                                                                 AND sztprono_pidm = c.sztalian_pidm
                                                                 )loop

                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);

                                                                       begin

                                                                           select count(*)
                                                                           into l_cuenta_qali
                                                                           from SZTQALI
                                                                           where 1 = 1
                                                                           and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                           AND SZTQALI_PTRM =l_ptrm_pi
                                                                           AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                           AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                       exception when others then
                                                                           null;
                                                                       end;

                                                                   l_contador2:=l_contador2+1;

                                                                     BEGIN

                                                                       SELECT nvl(max(sztprono_secuencia),0)+1
                                                                       INTO l_secuencia
                                                                       FROM sztprono
                                                                       WHERE 1 = 1
                                                                       AND sztprono_no_regla = c.sztalian_no_regla
                                                                       AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                     exception when others then
                                                                         null;
                                                                     end;

                                                                     dbms_output.put_line('Valor qali '||l_cuenta_qali);

                                                                     IF l_cuenta_qali > 0 then

                                                                         BEGIN

                                                                             INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                         x.SZTPRONO_ID,
                                                                                                         x.SZTPRONO_TERM_CODE,
                                                                                                         x.SZTPRONO_PROGRAM,
                                                                                                         d.materia,
                                                                                                         l_secuencia,
                                                                                                         x.SZTPRONO_PTRM_CODE,
                                                                                                         d.materia,
                                                                                                         'x',
                                                                                                         x.SZTPRONO_FECHA_INICIO,
                                                                                                         x.SZTPRONO_PTRM_CODE_NW,
                                                                                                         x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                         x.SZTPRONO_AVANCE,
                                                                                                         x.SZTPRONO_NO_REGLA,
                                                                                                         x.SZTPRONO_USUARIO,
                                                                                                         x.SZTPRONO_STUDY_PATH,
                                                                                                         x.SZTPRONO_RATE,
                                                                                                         x.SZTPRONO_JORNADA,
                                                                                                         x.SZTPRONO_ACTIVITY_DATE,
                                                                                                         x.SZTPRONO_CUATRI,
                                                                                                         x.SZTPRONO_TIPO_INICIO,
                                                                                                         x.SZTPRONO_JORNADA_DOS,
                                                                                                         x.SZTPRONO_ENVIO_MOODL,
                                                                                                         x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                         x.SZTPRONO_ESTATUS,
                                                                                                         x.SZTPRONO_ESTATUS_ERROR,
                                                                                                         null,
                                                                                                         x.SZTPRONO_GRUPO_ASIG
                                                                                                         );

                                                                         exception when others then
                                                                             dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                         end;

                                                                         BEGIN
                                                                             UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                             WHERE 1 = 1
                                                                             AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                             AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                             AND SZTALIAN_ALIANZA ='COUR';
                                                                         exception when others then
                                                                             null;
                                                                         end;


                                                                         exit when l_contador2 = 1;

                                                                     end IF;

                                                                 END LOOP;


                                                        exit when l_contador = d.salida;

                                                   --end IF;

                                               END LOOP;

                                           else
                                                l_contador:= 0;

                                               FOR d IN
                                               (
                                                   SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                   SZTALMT_BIM salida,
                                                                   SZTALMT_SECUENCIA secuencia,
                                                                   SZTALMT_ALIANZA alianza
                                                   FROM SZTALMT
                                                   WHERE 1 = 1
                                                   AND SZTALMT_NIVEL =l_nivel
                                                   AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                   AND SZTALMT_ACTIVO ='S'
                                               ORDER BY SZTALMT_SECUENCIA
                                               )loop

                                                    l_contador:=l_contador+1;

                                                   dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                   --IF C.SZTALIAN_AVANCE > 2 THEN

                                                        l_contador2:=0;

                                                       for x in (SELECT *
                                                                 FROM sztprono
                                                                 WHERE 1 = 1
                                                                 AND sztprono_no_regla = c.sztalian_no_regla
                                                                 AND sztprono_pidm = c.sztalian_pidm
                                                                 )loop

                                                                   l_contador2:=l_contador2+1;

                                                                     BEGIN

                                                                       SELECT nvl(max(sztprono_secuencia),0)+1
                                                                       INTO l_secuencia
                                                                       FROM sztprono
                                                                       WHERE 1 = 1
                                                                       AND sztprono_no_regla = c.sztalian_no_regla
                                                                       AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                     exception when others then
                                                                         null;
                                                                     end;

                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);

                                                                    begin

                                                                        select count(*)
                                                                        into l_cuenta_qali
                                                                        from SZTQALI
                                                                        where 1 = 1
                                                                        and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                        AND SZTQALI_PTRM =l_ptrm_pi
                                                                        AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                        AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                    exception when others then
                                                                        null;
                                                                    end;

                                                                     IF l_cuenta_qali > 0 then

                                                                         BEGIN

                                                                             INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                         x.SZTPRONO_ID,
                                                                                                         x.SZTPRONO_TERM_CODE,
                                                                                                         x.SZTPRONO_PROGRAM,
                                                                                                         d.materia,
                                                                                                         l_secuencia,
                                                                                                         x.SZTPRONO_PTRM_CODE,
                                                                                                         d.materia,
                                                                                                         'x',
                                                                                                         x.SZTPRONO_FECHA_INICIO,
                                                                                                         x.SZTPRONO_PTRM_CODE_NW,
                                                                                                         x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                         x.SZTPRONO_AVANCE,
                                                                                                         x.SZTPRONO_NO_REGLA,
                                                                                                         x.SZTPRONO_USUARIO,
                                                                                                         x.SZTPRONO_STUDY_PATH,
                                                                                                         x.SZTPRONO_RATE,
                                                                                                         x.SZTPRONO_JORNADA,
                                                                                                         x.SZTPRONO_ACTIVITY_DATE,
                                                                                                         x.SZTPRONO_CUATRI,
                                                                                                         x.SZTPRONO_TIPO_INICIO,
                                                                                                         x.SZTPRONO_JORNADA_DOS,
                                                                                                         x.SZTPRONO_ENVIO_MOODL,
                                                                                                         x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                         x.SZTPRONO_ESTATUS,
                                                                                                         x.SZTPRONO_ESTATUS_ERROR,
                                                                                                         null,
                                                                                                         x.SZTPRONO_GRUPO_ASIG
                                                                                                         );

                                                                         exception when others then
                                                                             dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                         end;

                                                                         BEGIN
                                                                             UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                             WHERE 1 = 1
                                                                             AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                             AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                             AND SZTALIAN_ALIANZA='COUR';
                                                                         exception when others then
                                                                             null;
                                                                         end;


                                                                         exit when l_contador2 = 1;

                                                                     end IF;

                                                                 END LOOP;


                                                        exit when l_contador = d.salida;

                                                   --end IF;

                                               END LOOP;


                                           end IF;


                                       elsIF l_nivel ='LI' then

                                           BEGIN


                                               SELECT COUNT(*)
                                               INTO l_cuenta_alianza
                                               FROM SZTALMT
                                               WHERE 1 = 1
                                               AND SZTALMT_NIVEL = l_nivel
                                               AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                               AND SZTALMT_ACTIVO ='S'
                                               AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'COU%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ));

                                           exception when others then
                                               null;
                                           end;

                                           IF l_cuenta_alianza > 0 then

                                               l_contador:= 0;

                                               FOR d IN
                                               (
                                                   SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                   SZTALMT_BIM salida,
                                                                   SZTALMT_SECUENCIA secuencia,
                                                                   SZTALMT_ALIANZA alianza
                                                   FROM SZTALMT
                                                   WHERE 1 = 1
                                                   AND SZTALMT_NIVEL =l_nivel
                                                   AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                   AND SZTALMT_ACTIVO ='S'
                                                   AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'COU%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ))
                                                    ORDER BY SZTALMT_SECUENCIA
                                               )loop

                                                    l_contador:=l_contador+1;

                                                   dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id||' avance '||C.SZTALIAN_AVANCE);


                                                   IF C.SZTALIAN_AVANCE IN (1,2,3,4,5,6,13,14,15,16,17,18) THEN

                                                       l_contador2:=0;

                                                       for x in (SELECT *
                                                                 FROM sztprono
                                                                 WHERE 1 = 1
                                                                 AND sztprono_no_regla = c.sztalian_no_regla
                                                                 AND sztprono_pidm = c.sztalian_pidm
                                                                 )loop

                                                                   l_contador2:=l_contador2+1;

                                                                     BEGIN

                                                                       SELECT nvl(max(sztprono_secuencia),0)+1
                                                                       INTO l_secuencia
                                                                       FROM sztprono
                                                                       WHERE 1 = 1
                                                                       AND sztprono_no_regla = c.sztalian_no_regla
                                                                       AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                     exception when others then
                                                                         null;
                                                                     end;

                                                                     --IF C.SZTALIAN_AVANCE in (3) then

                                                                         BEGIN

                                                                             INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                         x.SZTPRONO_ID,
                                                                                                         x.SZTPRONO_TERM_CODE,
                                                                                                         x.SZTPRONO_PROGRAM,
                                                                                                         d.materia,
                                                                                                         l_secuencia,
                                                                                                         x.SZTPRONO_PTRM_CODE,
                                                                                                         d.materia,
                                                                                                         'x',
                                                                                                         x.SZTPRONO_FECHA_INICIO,
                                                                                                         x.SZTPRONO_PTRM_CODE_NW,
                                                                                                         x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                         x.SZTPRONO_AVANCE,
                                                                                                         x.SZTPRONO_NO_REGLA,
                                                                                                         x.SZTPRONO_USUARIO,
                                                                                                         x.SZTPRONO_STUDY_PATH,
                                                                                                         x.SZTPRONO_RATE,
                                                                                                         x.SZTPRONO_JORNADA,
                                                                                                         x.SZTPRONO_ACTIVITY_DATE,
                                                                                                         x.SZTPRONO_CUATRI,
                                                                                                         x.SZTPRONO_TIPO_INICIO,
                                                                                                         x.SZTPRONO_JORNADA_DOS,
                                                                                                         x.SZTPRONO_ENVIO_MOODL,
                                                                                                         x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                         x.SZTPRONO_ESTATUS,
                                                                                                         x.SZTPRONO_ESTATUS_ERROR,
                                                                                                         null,
                                                                                                         x.SZTPRONO_GRUPO_ASIG
                                                                                                         );

                                                                         exception when others then
                                                                             dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                         end;

                                                                         BEGIN
                                                                             UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                             WHERE 1 = 1
                                                                             AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                             AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                             AND SZTALIAN_ALIANZA ='COUR';
                                                                         exception when others then
                                                                             null;
                                                                         end;


                                                                         exit when l_contador2 = 1;



                                                                 END LOOP;


                                                        exit when l_contador = d.salida;

                                                   end IF;

                                               END LOOP;

                                           else
                                                l_contador:= 0;

                                               FOR d IN
                                               (
                                                   SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                   SZTALMT_BIM salida,
                                                                   SZTALMT_SECUENCIA secuencia,
                                                                   SZTALMT_ALIANZA alianza
                                                   FROM SZTALMT
                                                   WHERE 1 = 1
                                                   AND SZTALMT_NIVEL =l_nivel
                                                   AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                   AND SZTALMT_ACTIVO ='S'
                                               ORDER BY SZTALMT_SECUENCIA
                                               )loop

                                                    l_contador:=l_contador+1;

                                                   dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                   IF c.sztalian_avance in (1,2,3,4,5,6,13,14,15,16,17,18) then

                                                        l_contador2:=0;

                                                       for x in (SELECT *
                                                                 FROM sztprono
                                                                 WHERE 1 = 1
                                                                 AND sztprono_no_regla = c.sztalian_no_regla
                                                                 AND sztprono_pidm = c.sztalian_pidm
                                                                 )loop

                                                                   l_contador2:=l_contador2+1;

                                                                     BEGIN

                                                                       SELECT nvl(max(sztprono_secuencia),0)+1
                                                                       INTO l_secuencia
                                                                       FROM sztprono
                                                                       WHERE 1 = 1
                                                                       AND sztprono_no_regla = c.sztalian_no_regla
                                                                       AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                     exception when others then
                                                                         null;
                                                                     end;

                                                                     BEGIN

                                                                         SELECT COUNT(*)
                                                                         INTO l_cuenta_mh
                                                                         FROM ssbsect
                                                                         join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                     AND sfrstcr_crn = ssbsect_crn
                                                                         WHERE 1 = 1
                                                                         AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                         AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                         AND SFRSTCR_RSTS_CODE ='RE';

                                                                     exception when others then
                                                                         null;
                                                                     end;

                                                                     --IF c.sztalian_avance in (2,3,4,8,9,10)

                                                                         BEGIN

                                                                             INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                         x.SZTPRONO_ID,
                                                                                                         x.SZTPRONO_TERM_CODE,
                                                                                                         x.SZTPRONO_PROGRAM,
                                                                                                         d.materia,
                                                                                                         l_secuencia,
                                                                                                         x.SZTPRONO_PTRM_CODE,
                                                                                                         d.materia,
                                                                                                         'x',
                                                                                                         x.SZTPRONO_FECHA_INICIO,
                                                                                                         x.SZTPRONO_PTRM_CODE_NW,
                                                                                                         x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                         x.SZTPRONO_AVANCE,
                                                                                                         x.SZTPRONO_NO_REGLA,
                                                                                                         x.SZTPRONO_USUARIO,
                                                                                                         x.SZTPRONO_STUDY_PATH,
                                                                                                         x.SZTPRONO_RATE,
                                                                                                         x.SZTPRONO_JORNADA,
                                                                                                         x.SZTPRONO_ACTIVITY_DATE,
                                                                                                         x.SZTPRONO_CUATRI,
                                                                                                         x.SZTPRONO_TIPO_INICIO,
                                                                                                         x.SZTPRONO_JORNADA_DOS,
                                                                                                         x.SZTPRONO_ENVIO_MOODL,
                                                                                                         x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                         x.SZTPRONO_ESTATUS,
                                                                                                         x.SZTPRONO_ESTATUS_ERROR,
                                                                                                         null,
                                                                                                         x.SZTPRONO_GRUPO_ASIG
                                                                                                         );

                                                                         exception when others then
                                                                             dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                         end;

                                                                         BEGIN
                                                                             UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                             WHERE 1 = 1
                                                                             AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                             AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                             AND SZTALIAN_ALIANZA ='COUR';
                                                                         exception when others then
                                                                             null;
                                                                         end;


                                                                         exit when l_contador2 = 1;

                                                                     --end IF;

                                                                 END LOOP;


                                                        exit when l_contador = d.salida;

                                                   end IF;

                                               END LOOP;


                                           end IF;

                                        elsIF l_nivel ='DO'  then

                                           BEGIN


                                               SELECT COUNT(*)
                                               INTO l_cuenta_alianza
                                               FROM SZTALMT
                                               WHERE 1 = 1
                                               AND SZTALMT_NIVEL = l_nivel
                                               AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                               AND SZTALMT_ACTIVO ='S'
                                               AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                           FROM ssbsect
                                                                           join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                       AND sfrstcr_crn = ssbsect_crn
                                                                           WHERE 1 = 1
                                                                           AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'EXCO%'
                                                                           AND EXISTS (SELECT NULL
                                                                                       FROM SZTALIAN
                                                                                       WHERE 1 = 1
                                                                                       AND SZTALIAN_NO_REGLA = p_regla
                                                                                       AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                       AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                       AND sztalian_flex ='PR' )
                                                                            );

                                           exception when others then
                                               null;
                                           end;

                                           IF l_cuenta_alianza > 0 then

                                               l_contador:= 0;

                                               FOR d IN
                                               (
                                                   SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                   SZTALMT_BIM salida,
                                                                   SZTALMT_SECUENCIA secuencia,
                                                                   SZTALMT_ALIANZA alianza
                                                   FROM SZTALMT
                                                   WHERE 1 = 1
                                                   AND SZTALMT_NIVEL =l_nivel
                                                   AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                   AND SZTALMT_ACTIVO ='S'
                                                   AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                               FROM ssbsect
                                                                               join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                           AND sfrstcr_crn = ssbsect_crn
                                                                               WHERE 1 = 1
                                                                               AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'COU%'
                                                                               AND EXISTS (SELECT NULL
                                                                                           FROM SZTALIAN
                                                                                           WHERE 1 = 1
                                                                                           AND SZTALIAN_NO_REGLA = p_regla
                                                                                           AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                           AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                           AND sztalian_flex ='PR' )
                                                                                )
                                               ORDER BY SZTALMT_SECUENCIA
                                               )loop

                                                    l_contador:=l_contador+1;

                                                   dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                 --  IF C.SZTALIAN_AVANCE > 2 THEN

                                                       l_contador2:=0;

                                                       for x in (SELECT *
                                                                 FROM sztprono
                                                                 WHERE 1 = 1
                                                                 AND sztprono_no_regla = c.sztalian_no_regla
                                                                 AND sztprono_pidm = c.sztalian_pidm
                                                                 )loop

                                                                   l_contador2:=l_contador2+1;

                                                                     BEGIN

                                                                       SELECT nvl(max(sztprono_secuencia),0)+1
                                                                       INTO l_secuencia
                                                                       FROM sztprono
                                                                       WHERE 1 = 1
                                                                       AND sztprono_no_regla = c.sztalian_no_regla
                                                                       AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                     exception when others then
                                                                         null;
                                                                     end;

                                                                     BEGIN

                                                                         SELECT COUNT(*)
                                                                         INTO l_cuenta_mh
                                                                         FROM ssbsect
                                                                         join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                     AND sfrstcr_crn = ssbsect_crn
                                                                         WHERE 1 = 1
                                                                         AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                         AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                         AND SFRSTCR_RSTS_CODE ='RE';

                                                                     exception when others then
                                                                         null;
                                                                     end;

                                                                     IF l_cuenta_mh = 0 then

                                                                         BEGIN

                                                                             INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                         x.SZTPRONO_ID,
                                                                                                         x.SZTPRONO_TERM_CODE,
                                                                                                         x.SZTPRONO_PROGRAM,
                                                                                                         d.materia,
                                                                                                         l_secuencia,
                                                                                                         x.SZTPRONO_PTRM_CODE,
                                                                                                         d.materia,
                                                                                                         'x',
                                                                                                         x.SZTPRONO_FECHA_INICIO,
                                                                                                         x.SZTPRONO_PTRM_CODE_NW,
                                                                                                         x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                         x.SZTPRONO_AVANCE,
                                                                                                         x.SZTPRONO_NO_REGLA,
                                                                                                         x.SZTPRONO_USUARIO,
                                                                                                         x.SZTPRONO_STUDY_PATH,
                                                                                                         x.SZTPRONO_RATE,
                                                                                                         x.SZTPRONO_JORNADA,
                                                                                                         x.SZTPRONO_ACTIVITY_DATE,
                                                                                                         x.SZTPRONO_CUATRI,
                                                                                                         x.SZTPRONO_TIPO_INICIO,
                                                                                                         x.SZTPRONO_JORNADA_DOS,
                                                                                                         x.SZTPRONO_ENVIO_MOODL,
                                                                                                         x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                         x.SZTPRONO_ESTATUS,
                                                                                                         x.SZTPRONO_ESTATUS_ERROR,
                                                                                                         null,
                                                                                                         x.SZTPRONO_GRUPO_ASIG
                                                                                                         );

                                                                         exception when others then
                                                                             dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                         end;

                                                                         BEGIN
                                                                             UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                             WHERE 1 = 1
                                                                             AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                             AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                             AND SZTALIAN_ALIANZA ='COUR';
                                                                         exception when others then
                                                                             null;
                                                                         end;


                                                                         exit when l_contador2 = 1;

                                                                     end IF;

                                                                 END LOOP;


                                                        exit when l_contador = d.salida;

                                                  -- end IF;

                                               END LOOP;

                                           else
                                                l_contador:= 0;

                                               FOR d IN
                                               (
                                                   SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                   SZTALMT_BIM salida,
                                                                   SZTALMT_SECUENCIA secuencia,
                                                                   SZTALMT_ALIANZA alianza
                                                   FROM SZTALMT
                                                   WHERE 1 = 1
                                                   AND SZTALMT_NIVEL =l_nivel
                                                   AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                   AND SZTALMT_ACTIVO ='S'
                                               ORDER BY SZTALMT_SECUENCIA
                                               )loop

                                                    l_contador:=l_contador+1;

                                                   dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                   --IF C.SZTALIAN_AVANCE > 2 THEN

                                                        l_contador2:=0;

                                                       for x in (SELECT *
                                                                 FROM sztprono
                                                                 WHERE 1 = 1
                                                                 AND sztprono_no_regla = c.sztalian_no_regla
                                                                 AND sztprono_pidm = c.sztalian_pidm
                                                                 )loop

                                                                   l_contador2:=l_contador2+1;

                                                                     BEGIN

                                                                       SELECT nvl(max(sztprono_secuencia),0)+1
                                                                       INTO l_secuencia
                                                                       FROM sztprono
                                                                       WHERE 1 = 1
                                                                       AND sztprono_no_regla = c.sztalian_no_regla
                                                                       AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                     exception when others then
                                                                         null;
                                                                     end;

                                                                     BEGIN

                                                                         SELECT COUNT(*)
                                                                         INTO l_cuenta_mh
                                                                         FROM ssbsect
                                                                         join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                     AND sfrstcr_crn = ssbsect_crn
                                                                         WHERE 1 = 1
                                                                         AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                         AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                         AND SFRSTCR_RSTS_CODE ='RE';

                                                                     exception when others then
                                                                         null;
                                                                     end;

                                                                     IF l_cuenta_mh = 0 then

                                                                         BEGIN

                                                                             INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                         x.SZTPRONO_ID,
                                                                                                         x.SZTPRONO_TERM_CODE,
                                                                                                         x.SZTPRONO_PROGRAM,
                                                                                                         d.materia,
                                                                                                         l_secuencia,
                                                                                                         x.SZTPRONO_PTRM_CODE,
                                                                                                         d.materia,
                                                                                                         'x',
                                                                                                         x.SZTPRONO_FECHA_INICIO,
                                                                                                         x.SZTPRONO_PTRM_CODE_NW,
                                                                                                         x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                         x.SZTPRONO_AVANCE,
                                                                                                         x.SZTPRONO_NO_REGLA,
                                                                                                         x.SZTPRONO_USUARIO,
                                                                                                         x.SZTPRONO_STUDY_PATH,
                                                                                                         x.SZTPRONO_RATE,
                                                                                                         x.SZTPRONO_JORNADA,
                                                                                                         x.SZTPRONO_ACTIVITY_DATE,
                                                                                                         x.SZTPRONO_CUATRI,
                                                                                                         x.SZTPRONO_TIPO_INICIO,
                                                                                                         x.SZTPRONO_JORNADA_DOS,
                                                                                                         x.SZTPRONO_ENVIO_MOODL,
                                                                                                         x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                         x.SZTPRONO_ESTATUS,
                                                                                                         x.SZTPRONO_ESTATUS_ERROR,
                                                                                                         null,
                                                                                                         x.SZTPRONO_GRUPO_ASIG
                                                                                                         );

                                                                         exception when others then
                                                                             dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                         end;

                                                                         BEGIN
                                                                             UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                             WHERE 1 = 1
                                                                             AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                             AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                             AND SZTALIAN_ALIANZA ='COUR';
                                                                         exception when others then
                                                                             null;
                                                                         end;


                                                                         exit when l_contador2 = 1;

                                                                     end IF;

                                                                 END LOOP;


                                                        exit when l_contador = d.salida;

                                                   --end IF;

                                               END LOOP;


                                           end IF;

                                       END IF;

                                  else
                                  -- autoservicio
                                  -- Pedido por fgalleme

                                    dbms_output.put_line (' entra con fer');

                                       IF l_nivel ='MA'  then

                                           BEGIN


                                               SELECT COUNT(*)
                                               INTO l_cuenta_alianza
                                               FROM SZTALMT
                                               WHERE 1 = 1
                                               AND SZTALMT_NIVEL = l_nivel
                                               AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                               AND SZTALMT_ACTIVO ='S'
                                               AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                           FROM SZSTUME
                                                                           WHERE 1 = 1
                                                                           AND SZSTUME_SUBJ_CODE like 'COU%'
                                                                           AND EXISTS (SELECT NULL
                                                                                       FROM SZTALIAN
                                                                                       WHERE 1 = 1
                                                                                       AND SZTALIAN_NO_REGLA = p_regla
                                                                                       AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                       AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                       AND sztalian_flex ='PR' ));
                                           exception when others then
                                               null;
                                           end;

                                           IF l_cuenta_alianza > 0 then

                                               l_contador:= 0;

                                               FOR d IN
                                               (
                                                   SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                   SZTALMT_BIM salida,
                                                                   SZTALMT_SECUENCIA secuencia,
                                                                   SZTALMT_ALIANZA alianza
                                                   FROM SZTALMT
                                                   WHERE 1 = 1
                                                   AND SZTALMT_NIVEL =l_nivel
                                                   AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                   AND SZTALMT_ACTIVO ='S'
                                                   AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'COU%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ))
                                               ORDER BY SZTALMT_SECUENCIA
                                               )loop

                                                    l_contador:=l_contador+1;

                                                   dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                       l_contador2:=0;

                                                       for x in (SELECT *
                                                                 FROM sztprono
                                                                 WHERE 1 = 1
                                                                 AND sztprono_no_regla = c.sztalian_no_regla
                                                                 AND sztprono_pidm = c.sztalian_pidm
                                                                 )loop

                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);


                                                                   l_contador2:=l_contador2+1;

                                                                     BEGIN

                                                                       SELECT nvl(max(sztprono_secuencia),0)+1
                                                                       INTO l_secuencia
                                                                       FROM sztprono
                                                                       WHERE 1 = 1
                                                                       AND sztprono_no_regla = c.sztalian_no_regla
                                                                       AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                     exception when others then
                                                                         null;
                                                                     end;



                                                                         BEGIN

                                                                             INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                         x.SZTPRONO_ID,
                                                                                                         x.SZTPRONO_TERM_CODE,
                                                                                                         x.SZTPRONO_PROGRAM,
                                                                                                         d.materia,
                                                                                                         l_secuencia,
                                                                                                         x.SZTPRONO_PTRM_CODE,
                                                                                                         d.materia,
                                                                                                         'x',
                                                                                                         x.SZTPRONO_FECHA_INICIO,
                                                                                                         x.SZTPRONO_PTRM_CODE_NW,
                                                                                                         x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                         x.SZTPRONO_AVANCE,
                                                                                                         x.SZTPRONO_NO_REGLA,
                                                                                                         x.SZTPRONO_USUARIO,
                                                                                                         x.SZTPRONO_STUDY_PATH,
                                                                                                         x.SZTPRONO_RATE,
                                                                                                         x.SZTPRONO_JORNADA,
                                                                                                         x.SZTPRONO_ACTIVITY_DATE,
                                                                                                         x.SZTPRONO_CUATRI,
                                                                                                         x.SZTPRONO_TIPO_INICIO,
                                                                                                         x.SZTPRONO_JORNADA_DOS,
                                                                                                         x.SZTPRONO_ENVIO_MOODL,
                                                                                                         x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                         x.SZTPRONO_ESTATUS,
                                                                                                         x.SZTPRONO_ESTATUS_ERROR,
                                                                                                         null,
                                                                                                         x.SZTPRONO_GRUPO_ASIG
                                                                                                         );

                                                                         exception when others then
                                                                             dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                         end;

                                                                         BEGIN
                                                                             UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                             WHERE 1 = 1
                                                                             AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                             AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                             AND SZTALIAN_ALIANZA ='COUR';
                                                                         exception when others then
                                                                             null;
                                                                         end;


                                                                         begin

                                                                            update sztsenr set SZTSENR_FECHA_INICIO = l_fecha_new,
                                                                                               SZTSENR_MATPADRE = d.materia
                                                                            where 1 = 1
                                                                            and sztsenr_pidm = x.SZTPRONO_PIDM;

                                                                         exception when others then
                                                                            null;
                                                                         end;

                                                                         exit when l_contador2 = 1;

                                                                 END LOOP;


                                                  exit when l_contador = d.salida;

                                               END LOOP;

                                           else
                                                l_contador:= 0;

                                               FOR d IN
                                               (
                                                   SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                   SZTALMT_BIM salida,
                                                                   SZTALMT_SECUENCIA secuencia,
                                                                   SZTALMT_ALIANZA alianza
                                                   FROM SZTALMT
                                                   WHERE 1 = 1
                                                   AND SZTALMT_NIVEL =l_nivel
                                                   AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                   AND SZTALMT_ACTIVO ='S'
                                               ORDER BY SZTALMT_SECUENCIA
                                               )loop

                                                   l_contador:=l_contador+1;

                                                   dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);

                                                   l_contador2:=0;

                                                       for x in (SELECT *
                                                                 FROM sztprono
                                                                 WHERE 1 = 1
                                                                 AND sztprono_no_regla = c.sztalian_no_regla
                                                                 AND sztprono_pidm = c.sztalian_pidm
                                                                 )loop

                                                                   l_contador2:=l_contador2+1;

                                                                     BEGIN

                                                                       SELECT nvl(max(sztprono_secuencia),0)+1
                                                                       INTO l_secuencia
                                                                       FROM sztprono
                                                                       WHERE 1 = 1
                                                                       AND sztprono_no_regla = c.sztalian_no_regla
                                                                       AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                     exception when others then
                                                                         null;
                                                                     end;
                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);

                                                                         BEGIN

                                                                             INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                         x.SZTPRONO_ID,
                                                                                                         x.SZTPRONO_TERM_CODE,
                                                                                                         x.SZTPRONO_PROGRAM,
                                                                                                         d.materia,
                                                                                                         l_secuencia,
                                                                                                         x.SZTPRONO_PTRM_CODE,
                                                                                                         d.materia,
                                                                                                         'x',
                                                                                                         x.SZTPRONO_FECHA_INICIO,
                                                                                                         x.SZTPRONO_PTRM_CODE_NW,
                                                                                                         x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                         x.SZTPRONO_AVANCE,
                                                                                                         x.SZTPRONO_NO_REGLA,
                                                                                                         x.SZTPRONO_USUARIO,
                                                                                                         x.SZTPRONO_STUDY_PATH,
                                                                                                         x.SZTPRONO_RATE,
                                                                                                         x.SZTPRONO_JORNADA,
                                                                                                         x.SZTPRONO_ACTIVITY_DATE,
                                                                                                         x.SZTPRONO_CUATRI,
                                                                                                         x.SZTPRONO_TIPO_INICIO,
                                                                                                         x.SZTPRONO_JORNADA_DOS,
                                                                                                         x.SZTPRONO_ENVIO_MOODL,
                                                                                                         x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                         x.SZTPRONO_ESTATUS,
                                                                                                         x.SZTPRONO_ESTATUS_ERROR,
                                                                                                         null,
                                                                                                         x.SZTPRONO_GRUPO_ASIG
                                                                                                         );

                                                                         exception when others then
                                                                             dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                         end;

                                                                         BEGIN
                                                                             UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                             WHERE 1 = 1
                                                                             AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                             AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                             AND SZTALIAN_ALIANZA='COUR';
                                                                         exception when others then
                                                                             null;
                                                                         end;

                                                                         begin

                                                                            update sztsenr set SZTSENR_FECHA_INICIO = l_fecha_new,
                                                                                               SZTSENR_MATPADRE = d.materia
                                                                            where 1 = 1
                                                                            and sztsenr_pidm = x.SZTPRONO_PIDM;

                                                                         exception when others then
                                                                            null;
                                                                         end;


                                                                         exit when l_contador2 = 1;


                                                                 END LOOP;


                                                        exit when l_contador = d.salida;

                                                   --end IF;

                                               END LOOP;


                                           end IF;


                                       elsIF l_nivel ='LI' then

                                          dbms_output.put_line (' entra con fer lic ');

                                           BEGIN


                                               SELECT COUNT(*)
                                               INTO l_cuenta_alianza
                                               FROM SZTALMT
                                               WHERE 1 = 1
                                               AND SZTALMT_NIVEL = l_nivel
                                               AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                               AND SZTALMT_ACTIVO ='S'
                                               AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'COU%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ));

                                           exception when others then
                                               null;
                                           end;

                                           IF l_cuenta_alianza > 0 then

                                               l_contador:= 0;

                                               FOR d IN
                                               (
                                                   SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                   SZTALMT_BIM salida,
                                                                   SZTALMT_SECUENCIA secuencia,
                                                                   SZTALMT_ALIANZA alianza
                                                   FROM SZTALMT
                                                   WHERE 1 = 1
                                                   AND SZTALMT_NIVEL =l_nivel
                                                   AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                   AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'COU%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ))
                                               ORDER BY SZTALMT_SECUENCIA
                                               )loop

                                                    l_contador:=l_contador+1;

                                                   dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id||' avance '||C.SZTALIAN_AVANCE);


                                                   --IF C.SZTALIAN_AVANCE IN (2) THEN

                                                       l_contador2:=0;

                                                       for x in (SELECT *
                                                                 FROM sztprono
                                                                 WHERE 1 = 1
                                                                 AND sztprono_no_regla = c.sztalian_no_regla
                                                                 AND sztprono_pidm = c.sztalian_pidm
                                                                 )loop

                                                                   l_contador2:=l_contador2+1;

                                                                     BEGIN

                                                                       SELECT nvl(max(sztprono_secuencia),0)+1
                                                                       INTO l_secuencia
                                                                       FROM sztprono
                                                                       WHERE 1 = 1
                                                                       AND sztprono_no_regla = c.sztalian_no_regla
                                                                       AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                     exception when others then
                                                                         null;
                                                                     end;

                                                                     --IF C.SZTALIAN_AVANCE in (3) then

                                                                         BEGIN

                                                                             INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                         x.SZTPRONO_ID,
                                                                                                         x.SZTPRONO_TERM_CODE,
                                                                                                         x.SZTPRONO_PROGRAM,
                                                                                                         d.materia,
                                                                                                         l_secuencia,
                                                                                                         x.SZTPRONO_PTRM_CODE,
                                                                                                         d.materia,
                                                                                                         'x',
                                                                                                         x.SZTPRONO_FECHA_INICIO,
                                                                                                         x.SZTPRONO_PTRM_CODE_NW,
                                                                                                         x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                         x.SZTPRONO_AVANCE,
                                                                                                         x.SZTPRONO_NO_REGLA,
                                                                                                         x.SZTPRONO_USUARIO,
                                                                                                         x.SZTPRONO_STUDY_PATH,
                                                                                                         x.SZTPRONO_RATE,
                                                                                                         x.SZTPRONO_JORNADA,
                                                                                                         x.SZTPRONO_ACTIVITY_DATE,
                                                                                                         x.SZTPRONO_CUATRI,
                                                                                                         x.SZTPRONO_TIPO_INICIO,
                                                                                                         x.SZTPRONO_JORNADA_DOS,
                                                                                                         x.SZTPRONO_ENVIO_MOODL,
                                                                                                         x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                         x.SZTPRONO_ESTATUS,
                                                                                                         x.SZTPRONO_ESTATUS_ERROR,
                                                                                                         null,
                                                                                                         x.SZTPRONO_GRUPO_ASIG
                                                                                                         );

                                                                         exception when others then
                                                                             dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                         end;

                                                                         BEGIN
                                                                             UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                             WHERE 1 = 1
                                                                             AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                             AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                             AND SZTALIAN_ALIANZA ='COUR';
                                                                         exception when others then
                                                                             null;
                                                                         end;

                                                                         begin

                                                                            update sztsenr set SZTSENR_FECHA_INICIO = l_fecha_new,
                                                                                               SZTSENR_MATPADRE = d.materia
                                                                            where 1 = 1
                                                                            and sztsenr_pidm = x.SZTPRONO_PIDM;

                                                                         exception when others then
                                                                            null;
                                                                         end;


                                                                         exit when l_contador2 = 1;



                                                                 END LOOP;


                                                        exit when l_contador = d.salida;

                                                   --end IF;

                                               END LOOP;

                                           else
                                                l_contador:= 0;

                                               FOR d IN
                                               (
                                                   SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                   SZTALMT_BIM salida,
                                                                   SZTALMT_SECUENCIA secuencia,
                                                                   SZTALMT_ALIANZA alianza
                                                   FROM SZTALMT
                                                   WHERE 1 = 1
                                                   AND SZTALMT_NIVEL =l_nivel
                                                   AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                   AND SZTALMT_ACTIVO ='S'
                                               ORDER BY SZTALMT_SECUENCIA
                                               )loop

                                                    l_contador:=l_contador+1;

                                                   dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                   --IF C.SZTALIAN_AVANCE in (3) THEN

                                                        l_contador2:=0;

                                                       for x in (SELECT *
                                                                 FROM sztprono
                                                                 WHERE 1 = 1
                                                                 AND sztprono_no_regla = c.sztalian_no_regla
                                                                 AND sztprono_pidm = c.sztalian_pidm
                                                                 )loop

                                                                   l_contador2:=l_contador2+1;

                                                                     BEGIN

                                                                       SELECT nvl(max(sztprono_secuencia),0)+1
                                                                       INTO l_secuencia
                                                                       FROM sztprono
                                                                       WHERE 1 = 1
                                                                       AND sztprono_no_regla = c.sztalian_no_regla
                                                                       AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                     exception when others then
                                                                         null;
                                                                     end;

                                                                     BEGIN

                                                                         SELECT COUNT(*)
                                                                         INTO l_cuenta_mh
                                                                         FROM ssbsect
                                                                         join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                     AND sfrstcr_crn = ssbsect_crn
                                                                         WHERE 1 = 1
                                                                         AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                         AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                         AND SFRSTCR_RSTS_CODE ='RE';

                                                                     exception when others then
                                                                         null;
                                                                     end;

                                                                     --IF l_cuenta_mh = 0 then

                                                                         BEGIN

                                                                             INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                         x.SZTPRONO_ID,
                                                                                                         x.SZTPRONO_TERM_CODE,
                                                                                                         x.SZTPRONO_PROGRAM,
                                                                                                         d.materia,
                                                                                                         l_secuencia,
                                                                                                         x.SZTPRONO_PTRM_CODE,
                                                                                                         d.materia,
                                                                                                         'x',
                                                                                                         x.SZTPRONO_FECHA_INICIO,
                                                                                                         x.SZTPRONO_PTRM_CODE_NW,
                                                                                                         x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                         x.SZTPRONO_AVANCE,
                                                                                                         x.SZTPRONO_NO_REGLA,
                                                                                                         x.SZTPRONO_USUARIO,
                                                                                                         x.SZTPRONO_STUDY_PATH,
                                                                                                         x.SZTPRONO_RATE,
                                                                                                         x.SZTPRONO_JORNADA,
                                                                                                         x.SZTPRONO_ACTIVITY_DATE,
                                                                                                         x.SZTPRONO_CUATRI,
                                                                                                         x.SZTPRONO_TIPO_INICIO,
                                                                                                         x.SZTPRONO_JORNADA_DOS,
                                                                                                         x.SZTPRONO_ENVIO_MOODL,
                                                                                                         x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                         x.SZTPRONO_ESTATUS,
                                                                                                         x.SZTPRONO_ESTATUS_ERROR,
                                                                                                         null,
                                                                                                         x.SZTPRONO_GRUPO_ASIG
                                                                                                         );

                                                                         exception when others then
                                                                             dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                         end;

                                                                         BEGIN
                                                                             UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                             WHERE 1 = 1
                                                                             AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                             AND sztalian_pidm = x.SZTPRONO_PIDM;
                                                                         exception when others then
                                                                             null;
                                                                         end;

                                                                         begin

                                                                            update sztsenr set SZTSENR_FECHA_INICIO = l_fecha_new,
                                                                                               SZTSENR_MATPADRE = d.materia
                                                                            where 1 = 1
                                                                            and sztsenr_pidm = x.SZTPRONO_PIDM;

                                                                         exception when others then
                                                                            null;
                                                                         end;

                                                                         exit when l_contador2 = 1;

                                                                     --end IF;

                                                                 END LOOP;


                                                        exit when l_contador = d.salida;

                                                   --end IF;

                                               END LOOP;


                                           end IF;

                                       elsIF l_nivel ='DO'  then

                                           BEGIN


                                               SELECT COUNT(*)
                                               INTO l_cuenta_alianza
                                               FROM SZTALMT
                                               WHERE 1 = 1
                                               AND SZTALMT_NIVEL = l_nivel
                                               AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                               AND SZTALMT_ACTIVO ='S'
                                               AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'COU%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ));

                                           exception when others then
                                               null;
                                           end;

                                           IF l_cuenta_alianza > 0 then

                                               l_contador:= 0;

                                               FOR d IN
                                               (
                                                   SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                   SZTALMT_BIM salida,
                                                                   SZTALMT_SECUENCIA secuencia,
                                                                   SZTALMT_ALIANZA alianza
                                                   FROM SZTALMT
                                                   WHERE 1 = 1
                                                   AND SZTALMT_NIVEL =l_nivel
                                                   AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                   AND SZTALMT_ACTIVO ='S'
                                                   AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'COU%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ))
                                               ORDER BY SZTALMT_SECUENCIA
                                               )loop

                                                    l_contador:=l_contador+1;

                                                   dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                 --  IF C.SZTALIAN_AVANCE > 2 THEN

                                                       l_contador2:=0;

                                                       for x in (SELECT *
                                                                 FROM sztprono
                                                                 WHERE 1 = 1
                                                                 AND sztprono_no_regla = c.sztalian_no_regla
                                                                 AND sztprono_pidm = c.sztalian_pidm
                                                                 )loop

                                                                   l_contador2:=l_contador2+1;

                                                                     BEGIN

                                                                       SELECT nvl(max(sztprono_secuencia),0)+1
                                                                       INTO l_secuencia
                                                                       FROM sztprono
                                                                       WHERE 1 = 1
                                                                       AND sztprono_no_regla = c.sztalian_no_regla
                                                                       AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                     exception when others then
                                                                         null;
                                                                     end;



                                                                         BEGIN

                                                                             INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                         x.SZTPRONO_ID,
                                                                                                         x.SZTPRONO_TERM_CODE,
                                                                                                         x.SZTPRONO_PROGRAM,
                                                                                                         d.materia,
                                                                                                         l_secuencia,
                                                                                                         x.SZTPRONO_PTRM_CODE,
                                                                                                         d.materia,
                                                                                                         'x',
                                                                                                         x.SZTPRONO_FECHA_INICIO,
                                                                                                         x.SZTPRONO_PTRM_CODE_NW,
                                                                                                         x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                         x.SZTPRONO_AVANCE,
                                                                                                         x.SZTPRONO_NO_REGLA,
                                                                                                         x.SZTPRONO_USUARIO,
                                                                                                         x.SZTPRONO_STUDY_PATH,
                                                                                                         x.SZTPRONO_RATE,
                                                                                                         x.SZTPRONO_JORNADA,
                                                                                                         x.SZTPRONO_ACTIVITY_DATE,
                                                                                                         x.SZTPRONO_CUATRI,
                                                                                                         x.SZTPRONO_TIPO_INICIO,
                                                                                                         x.SZTPRONO_JORNADA_DOS,
                                                                                                         x.SZTPRONO_ENVIO_MOODL,
                                                                                                         x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                         x.SZTPRONO_ESTATUS,
                                                                                                         x.SZTPRONO_ESTATUS_ERROR,
                                                                                                         null,
                                                                                                         x.SZTPRONO_GRUPO_ASIG
                                                                                                         );

                                                                         exception when others then
                                                                             dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                         end;

                                                                         BEGIN
                                                                             UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                             WHERE 1 = 1
                                                                             AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                             AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                             AND SZTALIAN_ALIANZA ='COUR';
                                                                         exception when others then
                                                                             null;
                                                                         end;

                                                                         begin

                                                                            update sztsenr set SZTSENR_FECHA_INICIO = l_fecha_new,
                                                                                               SZTSENR_MATPADRE = d.materia
                                                                            where 1 = 1
                                                                            and sztsenr_pidm = x.SZTPRONO_PIDM;

                                                                         exception when others then
                                                                            null;
                                                                         end;

                                                                         exit when l_contador2 = 1;



                                                                 END LOOP;


                                                        exit when l_contador = d.salida;

                                                  -- end IF;

                                               END LOOP;

                                           else
                                                l_contador:= 0;

                                               FOR d IN
                                               (
                                                   SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                   SZTALMT_BIM salida,
                                                                   SZTALMT_SECUENCIA secuencia,
                                                                   SZTALMT_ALIANZA alianza
                                                   FROM SZTALMT
                                                   WHERE 1 = 1
                                                   AND SZTALMT_NIVEL =l_nivel
                                                   AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                   AND SZTALMT_ACTIVO ='S'
                                               ORDER BY SZTALMT_SECUENCIA
                                               )loop

                                                    l_contador:=l_contador+1;

                                                   dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                   --IF C.SZTALIAN_AVANCE > 2 THEN

                                                        l_contador2:=0;

                                                       for x in (SELECT *
                                                                 FROM sztprono
                                                                 WHERE 1 = 1
                                                                 AND sztprono_no_regla = c.sztalian_no_regla
                                                                 AND sztprono_pidm = c.sztalian_pidm
                                                                 )loop

                                                                   l_contador2:=l_contador2+1;

                                                                     BEGIN

                                                                       SELECT nvl(max(sztprono_secuencia),0)+1
                                                                       INTO l_secuencia
                                                                       FROM sztprono
                                                                       WHERE 1 = 1
                                                                       AND sztprono_no_regla = c.sztalian_no_regla
                                                                       AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                     exception when others then
                                                                         null;
                                                                     end;

                                                                     BEGIN

                                                                         SELECT COUNT(*)
                                                                         INTO l_cuenta_mh
                                                                         FROM ssbsect
                                                                         join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                     AND sfrstcr_crn = ssbsect_crn
                                                                         WHERE 1 = 1
                                                                         AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                         AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                         AND SFRSTCR_RSTS_CODE ='RE';

                                                                     exception when others then
                                                                         null;
                                                                     end;

                                                                     IF l_cuenta_mh = 0 then

                                                                         BEGIN

                                                                             INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                         x.SZTPRONO_ID,
                                                                                                         x.SZTPRONO_TERM_CODE,
                                                                                                         x.SZTPRONO_PROGRAM,
                                                                                                         d.materia,
                                                                                                         l_secuencia,
                                                                                                         x.SZTPRONO_PTRM_CODE,
                                                                                                         d.materia,
                                                                                                         'x',
                                                                                                         x.SZTPRONO_FECHA_INICIO,
                                                                                                         x.SZTPRONO_PTRM_CODE_NW,
                                                                                                         x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                         x.SZTPRONO_AVANCE,
                                                                                                         x.SZTPRONO_NO_REGLA,
                                                                                                         x.SZTPRONO_USUARIO,
                                                                                                         x.SZTPRONO_STUDY_PATH,
                                                                                                         x.SZTPRONO_RATE,
                                                                                                         x.SZTPRONO_JORNADA,
                                                                                                         x.SZTPRONO_ACTIVITY_DATE,
                                                                                                         x.SZTPRONO_CUATRI,
                                                                                                         x.SZTPRONO_TIPO_INICIO,
                                                                                                         x.SZTPRONO_JORNADA_DOS,
                                                                                                         x.SZTPRONO_ENVIO_MOODL,
                                                                                                         x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                         x.SZTPRONO_ESTATUS,
                                                                                                         x.SZTPRONO_ESTATUS_ERROR,
                                                                                                         null,
                                                                                                         x.SZTPRONO_GRUPO_ASIG
                                                                                                         );

                                                                         exception when others then
                                                                             dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                         end;

                                                                         BEGIN
                                                                             UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                             WHERE 1 = 1
                                                                             AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                             AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                             AND SZTALIAN_ALIANZA ='COUR';
                                                                         exception when others then
                                                                             null;
                                                                         end;

                                                                          begin

                                                                            update sztsenr set SZTSENR_FECHA_INICIO = l_fecha_new,
                                                                                               SZTSENR_MATPADRE = d.materia
                                                                            where 1 = 1
                                                                            and sztsenr_pidm = x.SZTPRONO_PIDM;

                                                                         exception when others then
                                                                            null;
                                                                         end;


                                                                         exit when l_contador2 = 1;

                                                                     end IF;

                                                                 END LOOP;


                                                        exit when l_contador = d.salida;

                                                   --end IF;

                                               END LOOP;


                                           end IF;

                                       END IF;

                                  end if;

                              end loop;
        commit;
    end;
--
--
    PROCEDURE p_cifa_regla(p_regla   NUMBER)
    is
       l_cuenta_nivel_li     number;
       l_cuenta_nivel_ma     number;
       l_cuenta_nivel_do     number;
       l_nivel               varchar2(2);
       l_avance              number;
       l_materias_alianza    number;
       l_materias_para       number;
       l_peirod_uni          varchar2(2);
       l_contador            number:=0;
       l_sec_materia         number;
       l_contador2           number:=0;
       l_secuencia           number;
       l_cuenta_alianza      number;
       l_cuenta_mh           number;
       l_cuenta_qali         number;
       l_ptrm_pi             varchar2(3);
    begin

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_li
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_ma
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_do
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma > 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  IF;

        dbms_output.put_line('Nievl '||l_nivel);


        DELETE sztalian
        WHERE 1 = 1
        AND sztalian_no_regla = p_regla
        AND SZTALIAN_FLEX ='PR'
        AND SZTALIAN_ALIANZA ='CIFA';

         for c in ( SELECT distinct (SELECT  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            FROM SMRPRLE
                            WHERE 1 = 1
                            AND SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'CIFA' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
                    FROM sztprono
                    WHERE 1 = 1
                    AND sztprono_no_regla = p_regla
--                    and sztprono_id ='010385732'
                    AND EXISTS (SELECT NULL
                                FROM GORADID
                                WHERE 1 = 1
                                AND GORADID_PIDM = SZTPRONO_PIDM
                                AND  GORADID_ADID_CODE ='CIFA')
                    )loop


                        BEGIN

                          SELECT MAX(zstpara_param_id)
                          INTO l_avance
                          FROM ZSTPARA
                          WHERE 1 = 1
                          AND zstpara_mapa_id ='INSCRIPCIONES'
                          AND zstpara_param_valor = c.avance
                          AND zstpara_param_desc = c.tipo_inicio;

                        exception when others then
                            null;
                        end;

                        BEGIN


                         --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                          INSERT INTO sztalian VALUES (c.pidm,
                                                       c.matricula,
                                                       c.programa,
                                                       c.alianza,
                                                       l_avance,
                                                       c.regla,
                                                       'N',
                                                       nvl(l_materias_para,0),
                                                       nvl(l_materias_alianza,0),
                                                       c.tipo_inicio,
                                                       'PR'
                                                       );

                        EXCEPTION WHEN OTHERS THEN
                         NULL;
                        END;

                        COMMIT;
                    end loop;
                    --Jpg@Modify@Ene22
                    --Obtiene la secuencia siguiente para pronosticar materias
                    l_sec_materia := get_max_materia(p_regla, 'CIFA',1 );
                    --Jpg@Modify@Ene22
                    for c in (SELECT *
                              FROM sztalian
                              WHERE 1 = 1
                              AND sztalian_no_regla = p_regla
                              AND SZTALIAN_FLEX ='PR'
                              and SZTALIAN_ALIANZA ='CIFA'
                              )loop

                                        IF l_nivel ='MA'  then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'CC%'
                                                                                    AND SZSTUME_PIDM = c.SZTALIAN_PIDM
                                                                                     );

                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                        AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                        AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'CC%'
                                                                                    AND SZSTUME_PIDM = c.SZTALIAN_PIDM
                                                                                     )
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop
                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);
                                                                            begin

                                                                                select count(*)
                                                                                into l_cuenta_qali
                                                                                from SZTQALI
                                                                                where 1 = 1
                                                                                and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                AND SZTQALI_PTRM =l_ptrm_pi
                                                                                AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                                AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                            exception when others then
                                                                                null;
                                                                            end;

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_qali > 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='CIFA';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);

                                                                         begin

                                                                             select count(*)
                                                                             into l_cuenta_qali
                                                                             from SZTQALI
                                                                             where 1 = 1
                                                                             and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                             AND SZTQALI_PTRM =l_ptrm_pi
                                                                             AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                             AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                         exception when others then
                                                                             null;
                                                                         end;

                                                                          IF l_cuenta_qali > 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA='CIFA';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;


                                                end IF;


                                       elsIF l_nivel ='LI' then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'CC%'
                                                                                    AND SZSTUME_PIDM = c.SZTALIAN_PIDM
                                                                                     );

                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                        AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                        AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'CC%'
                                                                                    AND SZSTUME_PIDM = c.SZTALIAN_PIDM
                                                                                     )
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id||' avance '||C.SZTALIAN_AVANCE);




                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF C.SZTALIAN_AVANCE > 1 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='CIFA';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          END IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;


                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        IF C.SZTALIAN_AVANCE > 1 THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='CIFA';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        end IF;

                                                    END LOOP;


                                                end IF;

                                        elsIF l_nivel ='DO'  then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'CC%'
                                                                                    AND SZSTUME_PIDM = c.SZTALIAN_PIDM
                                                                                     );

                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                        AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                        AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'CC%'
                                                                                    AND SZSTUME_PIDM = c.SZTALIAN_PIDM
                                                                                     )
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                      --  IF C.SZTALIAN_AVANCE > 2 THEN

                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='CIFA';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                       -- end IF;

                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='CIFA';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;


                                                end IF;

                                       END IF;

                              end loop;
        commit;
    end;
--
--
    PROCEDURE p_gads_regla(p_regla   NUMBER)
    is
       l_cuenta_nivel_li     number;
       l_cuenta_nivel_ma     number;
       l_cuenta_nivel_do     number;
       l_nivel               varchar2(2);
       l_avance              number;
       l_materias_alianza    number;
       l_materias_para       number;
       l_peirod_uni          varchar2(2);
       l_contador            number:=0;
       l_avance_pidm         number;
       l_contador2           number:=0;
       l_secuencia           number;
       l_cuenta_alianza      number;
       l_cuenta_mh           number;
       l_cuenta_qali         number;
       l_ptrm_pi             varchar2(3);
    begin

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_li
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_ma
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_do
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma > 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  IF;

        dbms_output.put_line('Nievl '||l_nivel);


        DELETE sztalian
        WHERE 1 = 1
        AND sztalian_no_regla = p_regla
        AND SZTALIAN_FLEX ='PR'
        AND SZTALIAN_ALIANZA ='GADS';

         for c in ( SELECT distinct (SELECT  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            FROM SMRPRLE
                            WHERE 1 = 1
                            AND SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'GADS' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
                    FROM sztprono
                    WHERE 1 = 1
                    AND sztprono_no_regla = p_regla
                    AND EXISTS (SELECT NULL
                                FROM GORADID
                                WHERE 1 = 1
                                AND GORADID_PIDM = SZTPRONO_PIDM
                                AND  GORADID_ADID_CODE ='GADS')
                    )loop


                        BEGIN

                          SELECT MAX(zstpara_param_id)
                          INTO l_avance
                          FROM ZSTPARA
                          WHERE 1 = 1
                          AND zstpara_mapa_id ='INSCRIPCIONES'
                          AND zstpara_param_valor = c.avance
                          AND zstpara_param_desc = c.tipo_inicio;

                        exception when others then
                            null;
                        end;

                        BEGIN


                         --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                          INSERT INTO sztalian VALUES (c.pidm,
                                                       c.matricula,
                                                       c.programa,
                                                       c.alianza,
                                                       l_avance,
                                                       c.regla,
                                                       'N',
                                                       nvl(l_materias_para,0),
                                                       nvl(l_materias_alianza,0),
                                                       c.tipo_inicio,
                                                       'PR'
                                                       );

                        EXCEPTION WHEN OTHERS THEN
                         NULL;
                        END;

                        COMMIT;


                    end loop;

                    for c in (SELECT *
                              FROM sztalian
                              WHERE 1 = 1
                              AND sztalian_no_regla = p_regla
                              AND SZTALIAN_FLEX ='PR'
                              and SZTALIAN_ALIANZA ='GADS'
                              )loop

                                        IF l_nivel ='MA'  then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                FROM ssbsect
                                                                                join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                            AND sfrstcr_crn = ssbsect_crn
                                                                                WHERE 1 = 1
                                                                                AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'GOOG%'
                                                                                AND EXISTS (SELECT NULL
                                                                                            FROM SZTALIAN
                                                                                            WHERE 1 = 1
                                                                                            AND SZTALIAN_NO_REGLA = p_regla
                                                                                            AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                            AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                            AND sztalian_flex ='PR' )
                                                                                 );

                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                        AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                    FROM ssbsect
                                                                                    join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                                AND sfrstcr_crn = ssbsect_crn
                                                                                    WHERE 1 = 1
                                                                                    AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'GOOG%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' )
                                                                                     )
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);
                                                                            begin

                                                                                select count(*)
                                                                                into l_cuenta_qali
                                                                                from SZTQALI
                                                                                where 1 = 1
                                                                                and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                AND SZTQALI_PTRM =l_ptrm_pi
                                                                                AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                                AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                            exception when others then
                                                                                null;
                                                                            end;

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_qali > 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='GADS';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);
                                                                         begin

                                                                             select count(*)
                                                                             into l_cuenta_qali
                                                                             from SZTQALI
                                                                             where 1 = 1
                                                                             and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                             AND SZTQALI_PTRM =l_ptrm_pi
                                                                             AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                             AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                         exception when others then
                                                                             null;
                                                                         end;

                                                                          IF l_cuenta_qali > 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA='GADS';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;


                                                end IF;


                                       elsIF l_nivel ='LI' then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                FROM ssbsect
                                                                                join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                            AND sfrstcr_crn = ssbsect_crn
                                                                                WHERE 1 = 1
                                                                                AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'GOOG%'
                                                                                AND EXISTS (SELECT NULL
                                                                                            FROM SZTALIAN
                                                                                            WHERE 1 = 1
                                                                                            AND SZTALIAN_NO_REGLA = p_regla
                                                                                            AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                            AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                            AND sztalian_flex ='PR' )
                                                                                 );

                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                        AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                    FROM ssbsect
                                                                                    join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                                AND sfrstcr_crn = ssbsect_crn
                                                                                    WHERE 1 = 1
                                                                                    AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'GOOG%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' )
                                                                                     )
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id||' avance '||C.SZTALIAN_AVANCE);




                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF C.SZTALIAN_AVANCE IN (5,7) then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='GADS';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          END IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;


                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        IF C.SZTALIAN_AVANCE IN (5,7) THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='CIFA';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        end IF;

                                                    END LOOP;


                                                end IF;

                                        elsIF l_nivel ='DO'  then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                FROM ssbsect
                                                                                join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                            AND sfrstcr_crn = ssbsect_crn
                                                                                WHERE 1 = 1
                                                                                AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'GOOG%'
                                                                                AND EXISTS (SELECT NULL
                                                                                            FROM SZTALIAN
                                                                                            WHERE 1 = 1
                                                                                            AND SZTALIAN_NO_REGLA = p_regla
                                                                                            AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                            AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                            AND sztalian_flex ='PR' )
                                                                                 );

                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                        AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB
                                                                                    FROM ssbsect
                                                                                    join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                                AND sfrstcr_crn = ssbsect_crn
                                                                                    WHERE 1 = 1
                                                                                    AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB like 'GOOG%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = SFRSTCR_PIDM
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' )
                                                                                     )
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                      --  IF C.SZTALIAN_AVANCE > 2 THEN

                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='GADS';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                       -- end IF;

                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='GADS';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;


                                                end IF;

                                       END IF;

                              end loop;
        commit;
    end;
--
--
    PROCEDURE p_micr_regla(p_regla   NUMBER)
    is
       l_cuenta_nivel_li     number;
       l_cuenta_nivel_ma     number;
       l_cuenta_nivel_do     number;
       l_nivel               varchar2(2);
       l_avance              number;
       l_materias_alianza    number;
       l_materias_para       number;
       l_peirod_uni          varchar2(2);
       l_contador            number:=0;
       l_avance_pidm         number;
       l_contador2           number:=0;
       l_secuencia           number;
       l_cuenta_alianza      number;
       l_cuenta_mh           number;
       l_cuenta_qali         number;
       l_ptrm_pi             varchar2(3);
    begin

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_li
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_ma
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_do
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma > 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  IF;

        dbms_output.put_line('Nievl '||l_nivel);


        DELETE sztalian
        WHERE 1 = 1
        AND sztalian_no_regla = p_regla
        AND SZTALIAN_FLEX ='PR'
        AND SZTALIAN_ALIANZA ='MICR';

         for c in ( SELECT distinct (SELECT  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            FROM SMRPRLE
                            WHERE 1 = 1
                            AND SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'MICR' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
                    FROM sztprono
                    WHERE 1 = 1
--                    and sztprono_id ='010052167'
                    AND sztprono_no_regla = p_regla
                    AND EXISTS (SELECT NULL
                                FROM GORADID
                                WHERE 1 = 1
                                AND GORADID_PIDM = SZTPRONO_PIDM
                                AND  GORADID_ADID_CODE ='MICR')
                    )loop


                        BEGIN

                          SELECT MAX(zstpara_param_id)
                          INTO l_avance
                          FROM ZSTPARA
                          WHERE 1 = 1
                          AND zstpara_mapa_id ='INSCRIPCIONES'
                          AND zstpara_param_valor = c.avance
                          AND zstpara_param_desc = c.tipo_inicio;

                        exception when others then
                            null;
                        end;

                        BEGIN


                         --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                          INSERT INTO sztalian VALUES (c.pidm,
                                                       c.matricula,
                                                       c.programa,
                                                       c.alianza,
                                                       l_avance,
                                                       c.regla,
                                                       'N',
                                                       nvl(l_materias_para,0),
                                                       nvl(l_materias_alianza,0),
                                                       c.tipo_inicio,
                                                       'PR'
                                                       );

                        EXCEPTION WHEN OTHERS THEN
                         NULL;
                        END;

                        COMMIT;


                    end loop;

                    for c in (SELECT *
                              FROM sztalian
                              WHERE 1 = 1
                              AND sztalian_no_regla = p_regla
                              AND SZTALIAN_FLEX ='PR'
                              and SZTALIAN_ALIANZA ='MICR'
                              )loop

                                     dbms_output.put_line('Entra a cursor  ');

                                        IF l_nivel ='MA'  then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                   AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'MO%'
                                                                                    AND SZSTUME_PIDM = c.SZTALIAN_PIDM
                                                                                     );

                                                exception when others then
                                                    null;
                                                end;

                                                dbms_output.put_line('Cuenta alianza ');

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                        AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'MO%'
                                                                                    AND SZSTUME_PIDM = c.SZTALIAN_PIDM
                                                                                     )
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia 1--> '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);
                                                                            begin

                                                                                select count(*)
                                                                                into l_cuenta_qali
                                                                                from SZTQALI
                                                                                where 1 = 1
                                                                                and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                AND SZTQALI_PTRM =l_ptrm_pi
                                                                                AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                                AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                            exception when others then
                                                                                null;
                                                                            end;

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_qali > 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='MICR';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia 2--> '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);
                                                                         begin

                                                                             select count(*)
                                                                             into l_cuenta_qali
                                                                             from SZTQALI
                                                                             where 1 = 1
                                                                             and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                             AND SZTQALI_PTRM =l_ptrm_pi
                                                                             AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                             AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                         exception when others then
                                                                             null;
                                                                         end;

                                                                          IF l_cuenta_qali > 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA='MICR';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;


                                                end IF;


                                       elsIF l_nivel ='LI' then

                                        dbms_output.put_line (' Entra a Lic alianza micr ');

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'MO%'
                                                                                    AND SZSTUME_PIDM = c.SZTALIAN_PIDM
                                                                                     );

                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                         AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'MO%'
                                                                                    AND SZSTUME_PIDM = c.SZTALIAN_PIDM
                                                                                     )
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia -->1 '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id||' avance '||C.SZTALIAN_AVANCE);




                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF C.SZTALIAN_AVANCE IN (3,4,5,6,7,8) then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='MICR';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          END IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;


                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia -->2 '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        IF C.SZTALIAN_AVANCE IN (3,4,5,6,7,8) THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                          --                                                IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='MICR';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                            --                                              end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        end IF;

                                                    END LOOP;


                                                end IF;

                                        elsIF l_nivel ='DO'  then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'MO%'
                                                                                    AND SZSTUME_PIDM = c.SZTALIAN_PIDM
                                                                                     );

                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                        AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'MO%'
                                                                                    AND SZSTUME_PIDM = c.SZTALIAN_PIDM
                                                                                     )
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                      --  IF C.SZTALIAN_AVANCE > 2 THEN

                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='MICR';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                       -- end IF;

                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='MICR';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;


                                                end IF;

                                       END IF;

                              end loop;
        commit;
    end;
--
--
    PROCEDURE p_tabl_regla(p_regla   NUMBER)
    is
       l_cuenta_nivel_li     number;
       l_cuenta_nivel_ma     number;
       l_cuenta_nivel_do     number;
       l_nivel               varchar2(2);
       l_avance              number;
       l_materias_alianza    number;
       l_materias_para       number;
       l_peirod_uni          varchar2(2);
       l_contador            number:=0;
       l_avance_pidm         number;
       l_contador2           number:=0;
       l_secuencia           number;
       l_cuenta_alianza      number;
       l_cuenta_mh           number;
       l_cuenta_qali         number;
       l_ptrm_pi             varchar2(3);
    begin

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_li
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_ma
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_do
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma > 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  IF;

        dbms_output.put_line('Nievl '||l_nivel);


        DELETE sztalian
        WHERE 1 = 1
        AND sztalian_no_regla = p_regla
        AND SZTALIAN_FLEX ='PR'
        AND SZTALIAN_ALIANZA ='TABL';

         for c in ( SELECT distinct (SELECT  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            FROM SMRPRLE
                            WHERE 1 = 1
                            AND SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'TABL' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
                    FROM sztprono
                    WHERE 1 = 1
                    AND sztprono_no_regla = p_regla
--                    and sztprono_id ='010385753'
                    AND EXISTS (SELECT NULL
                                FROM GORADID
                                WHERE 1 = 1
                                AND GORADID_PIDM = SZTPRONO_PIDM
                                AND  GORADID_ADID_CODE ='TABL')
                    )loop


                        BEGIN

                          SELECT MAX(zstpara_param_id)
                          INTO l_avance
                          FROM ZSTPARA
                          WHERE 1 = 1
                          AND zstpara_mapa_id ='INSCRIPCIONES'
                          AND zstpara_param_valor = c.avance
                          AND zstpara_param_desc = c.tipo_inicio;

                        exception when others then
                            null;
                        end;

                        BEGIN


                         --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                          INSERT INTO sztalian VALUES (c.pidm,
                                                       c.matricula,
                                                       c.programa,
                                                       c.alianza,
                                                       l_avance,
                                                       c.regla,
                                                       'N',
                                                       nvl(l_materias_para,0),
                                                       nvl(l_materias_alianza,0),
                                                       c.tipo_inicio,
                                                       'PR'
                                                       );

                        EXCEPTION WHEN OTHERS THEN
                         NULL;
                        END;

                        COMMIT;


                    end loop;

                    for c in (SELECT *
                              FROM sztalian
                              WHERE 1 = 1
                              AND sztalian_no_regla = p_regla
                              AND SZTALIAN_FLEX ='PR'
                              and SZTALIAN_ALIANZA ='TABL'
                              )loop

                                        IF l_nivel ='MA'  then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'TAB%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ));
                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                         AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'TAB%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ))
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);

                                                                            begin

                                                                                select count(*)
                                                                                into l_cuenta_qali
                                                                                from SZTQALI
                                                                                where 1 = 1
                                                                                and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                AND SZTQALI_PTRM =l_ptrm_pi
                                                                                AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                                AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                            exception when others then
                                                                                null;
                                                                            end;

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_qali > 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='TABL';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);

                                                                         begin

                                                                             select count(*)
                                                                             into l_cuenta_qali
                                                                             from SZTQALI
                                                                             where 1 = 1
                                                                             and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                             AND SZTQALI_PTRM =l_ptrm_pi
                                                                             AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                             AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                         exception when others then
                                                                             null;
                                                                         end;

                                                                          IF l_cuenta_qali > 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA='TABL';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;


                                                end IF;


                                       elsIF l_nivel ='LI' then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'TAB%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ));

                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                         AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'TAB%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ))
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id||' avance '||C.SZTALIAN_AVANCE);




                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF C.SZTALIAN_AVANCE IN (3,4,5,6,7,8) then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='TABL';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          END IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;


                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        IF C.SZTALIAN_AVANCE IN (3,4,5,6,7,8) THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='TABL';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        end IF;

                                                    END LOOP;


                                                end IF;

                                        elsIF l_nivel ='DO'  then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                     AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'TAB%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ));

                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                         AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'TAB%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ))
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                      --  IF C.SZTALIAN_AVANCE > 2 THEN

                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='TABL';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                       -- end IF;

                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='TABL';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;


                                                end IF;

                                       END IF;

                              end loop;

        commit;
    end;
--
--
    PROCEDURE p_clou_regla(p_regla   NUMBER)
    is
       l_cuenta_nivel_li     number;
       l_cuenta_nivel_ma     number;
       l_cuenta_nivel_do     number;
       l_nivel               varchar2(2);
       l_avance              number;
       l_materias_alianza    number;
       l_materias_para       number;
       l_peirod_uni          varchar2(2);
       l_contador            number:=0;
       l_avance_pidm         number;
       l_contador2           number:=0;
       l_secuencia           number;
       l_cuenta_alianza      number;
       l_cuenta_mh           number;
       l_cuenta_qali         number;
       l_ptrm_pi             varchar2(3);
       l_cuenta              number;
    begin

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_li
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_ma
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_do
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma > 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  IF;

        dbms_output.put_line('Nievl '||l_nivel);


        DELETE sztalian
        WHERE 1 = 1
        AND sztalian_no_regla = p_regla
        AND SZTALIAN_FLEX ='PR'
        AND SZTALIAN_ALIANZA ='CLOU';

         for c in ( SELECT distinct (SELECT  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            FROM SMRPRLE
                            WHERE 1 = 1
                            AND SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            'CLOU' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
                    FROM sztprono
                    WHERE 1 = 1
--                    and sztprono_id ='010385757'
                    AND sztprono_no_regla = p_regla
                    AND EXISTS (SELECT NULL
                                FROM GORADID
                                WHERE 1 = 1
                                AND GORADID_PIDM = SZTPRONO_PIDM
                                AND  GORADID_ADID_CODE ='CLOU')
                    )loop


                        BEGIN

                          SELECT MAX(zstpara_param_id)
                          INTO l_avance
                          FROM ZSTPARA
                          WHERE 1 = 1
                          AND zstpara_mapa_id ='INSCRIPCIONES'
                          AND zstpara_param_valor = c.avance
                          AND zstpara_param_desc = c.tipo_inicio;

                        exception when others then
                            null;
                        end;

                        BEGIN


                         --  dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                          INSERT INTO sztalian VALUES (c.pidm,
                                                       c.matricula,
                                                       c.programa,
                                                       c.alianza,
                                                       l_avance,
                                                       c.regla,
                                                       'N',
                                                       nvl(l_materias_para,0),
                                                       nvl(l_materias_alianza,0),
                                                       c.tipo_inicio,
                                                       'PR'
                                                       );

                        EXCEPTION WHEN OTHERS THEN
                         NULL;
                        END;

                        COMMIT;


                    end loop;

                    for c in (SELECT *
                              FROM sztalian
                              WHERE 1 = 1
                              AND sztalian_no_regla = p_regla
                              AND SZTALIAN_FLEX ='PR'
                              and SZTALIAN_ALIANZA ='CLOU'
                              )loop

                                dbms_output.put_line('entra a cursor alian ');

                                        IF l_nivel ='MA'  then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                FROM SZSTUME
                                                                                WHERE 1 = 1
                                                                                AND SZSTUME_SUBJ_CODE like 'CAS%'
                                                                                AND EXISTS (SELECT NULL
                                                                                            FROM SZTALIAN
                                                                                            WHERE 1 = 1
                                                                                            AND SZTALIAN_NO_REGLA = p_regla
                                                                                            AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                            AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                            AND sztalian_flex ='PR' ));

                                                exception when others then
                                                    null;
                                                end;



                                                IF l_cuenta_alianza > 0 then


                                                    dbms_output.put_line('cuenta alianza '||l_cuenta_alianza||' Alianza '||c.SZTALIAN_ALIANZA||' pidm '||c.SZTALIAN_pidm||' Nivel '||l_nivel||' cuenta '||l_cuenta);

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                        AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'CAS%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ))
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia --> 1  COUR '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);

                                                                            begin

                                                                                select count(*)
                                                                                into l_cuenta_qali
                                                                                from SZTQALI
                                                                                where 1 = 1
                                                                                and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                AND SZTQALI_PTRM =l_ptrm_pi
                                                                                AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                                AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                            exception when others then
                                                                                null;
                                                                            end;

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_qali > 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='CLOU';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                    l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);

                                                                         begin

                                                                             select count(*)
                                                                             into l_cuenta_qali
                                                                             from SZTQALI
                                                                             where 1 = 1
                                                                             and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                                                             AND SZTQALI_PTRM =l_ptrm_pi
                                                                             AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                                                             AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW;

                                                                         exception when others then
                                                                             null;
                                                                         end;

                                                                          IF l_cuenta_qali > 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA='CLOU';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;


                                                end IF;


                                       elsIF l_nivel ='LI' then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'CAS%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ));

                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                        AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'CASS%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ))
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id||' avance '||C.SZTALIAN_AVANCE);




                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF C.SZTALIAN_AVANCE IN (2,3,4,5) then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='CLOU';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          END IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;


                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        IF C.SZTALIAN_AVANCE IN (2,3,4,5) THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='CLOU';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        end IF;

                                                    END LOOP;


                                                end IF;

                                        elsIF l_nivel ='DO'  then

                                                BEGIN


                                                    SELECT COUNT(*)
                                                    INTO l_cuenta_alianza
                                                    FROM SZTALMT
                                                    WHERE 1 = 1
                                                    AND SZTALMT_NIVEL = l_nivel
                                                    AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                    AND SZTALMT_ACTIVO ='S'
                                                    AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'CASS%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ));

                                                exception when others then
                                                    null;
                                                end;

                                                IF l_cuenta_alianza > 0 then

                                                    l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                        AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                                    FROM SZSTUME
                                                                                    WHERE 1 = 1
                                                                                    AND SZSTUME_SUBJ_CODE like 'CASS%'
                                                                                    AND EXISTS (SELECT NULL
                                                                                                FROM SZTALIAN
                                                                                                WHERE 1 = 1
                                                                                                AND SZTALIAN_NO_REGLA = p_regla
                                                                                                AND SZTALIAN_PIDM = c.SZTALIAN_pidm
                                                                                                AND SZTALIAN_ALIANZA =c.SZTALIAN_ALIANZA
                                                                                                AND sztalian_flex ='PR' ))
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                      --  IF C.SZTALIAN_AVANCE > 2 THEN

                                                            l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='CLOU';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                       -- end IF;

                                                    END LOOP;

                                                else
                                                     l_contador:= 0;

                                                    FOR d IN
                                                    (
                                                        SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                        SZTALMT_BIM salida,
                                                                        SZTALMT_SECUENCIA secuencia,
                                                                        SZTALMT_ALIANZA alianza
                                                        FROM SZTALMT
                                                        WHERE 1 = 1
                                                        AND SZTALMT_NIVEL =l_nivel
                                                        AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                        AND SZTALMT_ACTIVO ='S'
                                                    ORDER BY SZTALMT_SECUENCIA
                                                    )loop

                                                         l_contador:=l_contador+1;

                                                        dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);


                                                        --IF C.SZTALIAN_AVANCE > 2 THEN

                                                             l_contador2:=0;

                                                            for x in (SELECT *
                                                                      FROM sztprono
                                                                      WHERE 1 = 1
                                                                      AND sztprono_no_regla = c.sztalian_no_regla
                                                                      AND sztprono_pidm = c.sztalian_pidm
                                                                      )loop

                                                                        l_contador2:=l_contador2+1;

                                                                          BEGIN

                                                                            SELECT nvl(max(sztprono_secuencia),0)+1
                                                                            INTO l_secuencia
                                                                            FROM sztprono
                                                                            WHERE 1 = 1
                                                                            AND sztprono_no_regla = c.sztalian_no_regla
                                                                            AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          BEGIN

                                                                              SELECT COUNT(*)
                                                                              INTO l_cuenta_mh
                                                                              FROM ssbsect
                                                                              join sfrstcr on sfrstcr_term_code = ssbsect_term_code
                                                                                          AND sfrstcr_crn = ssbsect_crn
                                                                              WHERE 1 = 1
                                                                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB = d.materia
                                                                              AND sfrstcr_pidm = x.SZTPRONO_PIDM
                                                                              AND SFRSTCR_RSTS_CODE ='RE';

                                                                          exception when others then
                                                                              null;
                                                                          end;

                                                                          IF l_cuenta_mh = 0 then

                                                                              BEGIN

                                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                                              x.SZTPRONO_ID,
                                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                                              x.SZTPRONO_PROGRAM,
                                                                                                              d.materia,
                                                                                                              l_secuencia,
                                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                                              d.materia,
                                                                                                              'x',
                                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                                              x.SZTPRONO_AVANCE,
                                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                                              x.SZTPRONO_USUARIO,
                                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                                              x.SZTPRONO_RATE,
                                                                                                              x.SZTPRONO_JORNADA,
                                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                                              x.SZTPRONO_CUATRI,
                                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                                              x.SZTPRONO_ESTATUS,
                                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                                              null,
                                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                                              );

                                                                              exception when others then
                                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                                              end;

                                                                              BEGIN
                                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                                  WHERE 1 = 1
                                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                                  AND SZTALIAN_ALIANZA ='CLOU';
                                                                              exception when others then
                                                                                  null;
                                                                              end;


                                                                              exit when l_contador2 = 1;

                                                                          end IF;

                                                                      END LOOP;


                                                             exit when l_contador = d.salida;

                                                        --end IF;

                                                    END LOOP;


                                                end IF;

                                       END IF;

                              end loop;

        commit;
    end;
--
--
--Jpg@Create@Ene22 Proceso ejecuta cualquier tipo de alianza de tipo NO carrusel
--Dichas alianzas deben estar definidas por medio de la tabla SZTQALI o forms SZFQALI
    PROCEDURE p_no_carrusel (p_regla   NUMBER, p_alianza varchar2)
    is
       l_cuenta_nivel_li     number;
       l_cuenta_nivel_ma     number;
       l_cuenta_nivel_do     number;
       l_nivel               varchar2(2);
       l_avance              number;
       l_materias_alianza    number;
       l_materias_para       number;
       l_contador            number:=0;
       l_secuencia           number;

       l_ptrm_pi             varchar2(3);
       l_cont_asig              number;
    begin

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_li
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_ma
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_do
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma > 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  IF;

        dbms_output.put_line('Nievl '||l_nivel);


        DELETE sztalian
        WHERE 1 = 1
        AND sztalian_no_regla = p_regla
        AND SZTALIAN_FLEX ='PR'
        and SZTALIAN_ALIANZA=  p_alianza; --'FCBK';

         for c in ( SELECT distinct (SELECT  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            FROM SMRPRLE
                            WHERE 1 = 1
                            AND SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            p_alianza alianza, --'FCBK' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
                    FROM sztprono
                    WHERE 1 = 1
--                    and sztprono_id='010362676'
                    AND sztprono_no_regla = p_regla
                    AND EXISTS (SELECT NULL
                                FROM GORADID
                                WHERE 1 = 1
                                AND GORADID_PIDM = SZTPRONO_PIDM
                                AND  GORADID_ADID_CODE = p_alianza) --'FCBK')
                    )loop

                        BEGIN
                          SELECT MAX(zstpara_param_id)
                          INTO l_avance
                          FROM ZSTPARA
                          WHERE 1 = 1
                          AND zstpara_mapa_id ='INSCRIPCIONES'
                          AND zstpara_param_valor = c.avance
                          AND zstpara_param_desc = c.tipo_inicio;

                        exception when others then
                            null;
                        end;

                        BEGIN
                          INSERT INTO sztalian VALUES (c.pidm,
                                                       c.matricula,
                                                       c.programa,
                                                       c.alianza,
                                                       l_avance,
                                                       c.regla,
                                                       'N',
                                                       nvl(l_materias_para,0),
                                                       nvl(l_materias_alianza,0),
                                                       c.tipo_inicio,
                                                       'PR'
                                                       );

                        EXCEPTION WHEN OTHERS THEN
                         NULL;
                        END;
                    end loop;
                    COMMIT;

                    for c in (SELECT *
                              FROM sztalian
                              WHERE 1 = 1
                              AND sztalian_no_regla = p_regla
                              AND SZTALIAN_FLEX ='PR'
                              and SZTALIAN_ALIANZA = p_alianza --'FCBK'
                              )
                    loop
                        for x in (Select *
                                  FROM sztprono
                                  WHERE 1 = 1
                                  AND sztprono_no_regla = c.sztalian_no_regla
                                  AND sztprono_pidm = c.sztalian_pidm
                                    and RowNum=1
                                  )
                        loop

                         l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);
                            l_cont_asig:=0;

                            For d in (select Distinct sztqali_MATERIA materia, sztalmt_bim salida
                                        from SZTQALI
                                            join sztalmt on sztalmt_alianza=sztqali_alianza --Add para saber # materias x asignar
                                            and sztalmt_nivel=sztqali_nivel
                                            and sztalmt_materia=sztqali_materia
                                        where 1 = 1
                                        and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                        AND NVL(SZTQALI_PTRM,l_ptrm_pi) = l_ptrm_pi
                                        AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                        AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW
                                        AND SZTQALI_NIVEL = l_nivel
                                        AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                    FROM SZSTUME ume
                                                                    WHERE 1 = 1
                                                                    AND ume.SZSTUME_SUBJ_CODE = SZTALMT_MATERIA --like 'CC%'
                                                                    AND ume.SZSTUME_PIDM = c.SZTALIAN_PIDM
                                                                    and c.SZTALIAN_ALIANZA in ('COLL','MICR','CTNU','FCBK','GADS')
                                                                    AND UME.SZSTUME_RSTS_CODE ='RE'
                                                                    And ume.SZSTUME_SEQ_NO = (select max (a1.SZSTUME_SEQ_NO)
                                                                                               from SZSTUME a1
                                                                                               Where ume.SZSTUME_PIDM = a1.SZSTUME_PIDM
                                                                                               And ume.SZSTUME_STAT_IND = a1.SZSTUME_STAT_IND
                                                                                               And ume.SZSTUME_NO_REGLA = a1.SZSTUME_NO_REGLA
                                                                                               AND ume.SZSTUME_SUBJ_CODE = a1.SZSTUME_SUBJ_CODE
                                                                                            )
                                                                   )
                                        ORDER BY  sztqali_MATERIA
                                        )
                            Loop
                                dbms_output.put_line('Materia '||d.materia||' pidm:'||x.sztprono_pidm||' id:'||c.sztalian_id||' Nivel:'|| l_nivel
                                                    ||' PTRM: '||l_ptrm_pi||' QA:'||x.SZTPRONO_CUATRI||' bim:'||x.SZTPRONO_PTRM_CODE_NW);

                              BEGIN

                                SELECT nvl(max(sztprono_secuencia),0)+1
                                INTO l_secuencia
                                FROM sztprono
                                WHERE 1 = 1
                                AND sztprono_no_regla = c.sztalian_no_regla
                                AND sztprono_pidm = c.SZTALIAN_PIDM;

                              exception when others then
                                  null;
                              end;

                              BEGIN
                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                              x.SZTPRONO_ID,
                                                              x.SZTPRONO_TERM_CODE,
                                                              x.SZTPRONO_PROGRAM,
                                                              d.materia,
                                                              l_secuencia,
                                                              x.SZTPRONO_PTRM_CODE,
                                                              d.materia,
                                                              'x',
                                                              x.SZTPRONO_FECHA_INICIO,
                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                              x.SZTPRONO_AVANCE,
                                                              x.SZTPRONO_NO_REGLA,
                                                              x.SZTPRONO_USUARIO,
                                                              x.SZTPRONO_STUDY_PATH,
                                                              x.SZTPRONO_RATE,
                                                              x.SZTPRONO_JORNADA,
                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                              x.SZTPRONO_CUATRI,
                                                              x.SZTPRONO_TIPO_INICIO,
                                                              x.SZTPRONO_JORNADA_DOS,
                                                              x.SZTPRONO_ENVIO_MOODL,
                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                              x.SZTPRONO_ESTATUS,
                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                              null,
                                                              x.SZTPRONO_GRUPO_ASIG
                                                              );

                              exception when others then
                                  dbms_output.put_line( 'Error insert prono d.materia  --> ' ||d.materia||' Contador '||l_contador);
                              end;

                              BEGIN
                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                  WHERE 1 = 1
                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                  AND SZTALIAN_ALIANZA = p_alianza; --'FCBK';
                              exception when others then
                                  null;
                              end;

                              l_cont_asig:=l_cont_asig+1;

                              Exit When l_cont_asig = d.salida;

                            END LOOP;

                        END LOOP;
                    end loop;
        commit;
    end;
--
--
    PROCEDURE p_no_carrusel_pidm (p_regla   NUMBER, p_alianza varchar2, p_pidm number, p_cant_asig number default null)
    is
       l_cuenta_nivel_li     number;
       l_cuenta_nivel_ma     number;
       l_cuenta_nivel_do     number;
       l_nivel               varchar2(2);
       l_avance              number;
       l_materias_alianza    number;
       l_materias_para       number;
       l_contador            number:=0;
       l_secuencia           number;

       l_ptrm_pi             varchar2(3);

       l_cont_asig          number;
    begin

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_li
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_ma
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_do
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma > 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  IF;

        dbms_output.put_line('Nievl '||l_nivel);


        DELETE sztalian
        WHERE 1 = 1
        AND sztalian_no_regla = p_regla
        AND SZTALIAN_FLEX ='PR'
        AND SZTALIAN_PIDM=P_PIDM
        and SZTALIAN_ALIANZA=  p_alianza; --'FCBK';

        DELETE sztprono
        WHERE 1 = 1
        AND sztprono_no_regla = p_regla
        and sztprono_pidm=p_pidm
        AND Exists(Select 1 from sztalmt
                    where sztalmt_materia = sztprono_materia_legal
                       and sztalmt_alianza= p_alianza);


         for c in ( SELECT distinct (SELECT  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            FROM SMRPRLE
                            WHERE 1 = 1
                            AND SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            p_alianza alianza, --'FCBK' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
                    FROM sztprono
                    WHERE 1 = 1
                    and sztprono_pidm = p_pidm
                    AND sztprono_no_regla = p_regla
                    AND EXISTS (SELECT NULL
                                FROM GORADID
                                WHERE 1 = 1
                                AND GORADID_PIDM = SZTPRONO_PIDM
                                AND  GORADID_ADID_CODE = p_alianza) --'FCBK')
                    )loop

dbms_output.put_line('MATRICULA '||C.MATRICULA);

                        BEGIN
                          SELECT MAX(zstpara_param_id)
                          INTO l_avance
                          FROM ZSTPARA
                          WHERE 1 = 1
                          AND zstpara_mapa_id ='INSCRIPCIONES'
                          AND zstpara_param_valor = c.avance
                          AND zstpara_param_desc = c.tipo_inicio;

                        exception when others then
                            null;
                        end;

                        BEGIN
                          INSERT INTO sztalian VALUES (c.pidm,
                                                       c.matricula,
                                                       c.programa,
                                                       c.alianza,
                                                       l_avance,
                                                       c.regla,
                                                       'N',
                                                       nvl(l_materias_para,0),
                                                       nvl(l_materias_alianza,0),
                                                       c.tipo_inicio,
                                                       'PR'
                                                       );

                        EXCEPTION WHEN OTHERS THEN
dbms_output.put_line('ERROR INSERT SZTALIAN '||SQLERRM);

                         NULL;
                        END;
                    end loop;
                    COMMIT;

                    for c in (SELECT *
                              FROM sztalian
                              WHERE 1 = 1
                              AND sztalian_no_regla = p_regla
                              AND SZTALIAN_FLEX ='PR'
                              and sztalian_pidm = p_pidm
                              and SZTALIAN_ALIANZA = p_alianza --'FCBK'
                              )
                    loop
                        for x in (Select *
                                  FROM sztprono
                                  WHERE 1 = 1
                                  AND sztprono_no_regla = c.sztalian_no_regla
                                  AND sztprono_pidm = c.sztalian_pidm
                                    and RowNum=1
                                  )
                        loop


                         l_ptrm_pi := get_prtm_pi(p_regla, x.sztprono_id);
    dbms_output.put_line('id sztalian: '||c.sztalian_id||
    ' alianza: '||c.sztalian_alianza||' cuatri:'||x.SZTPRONO_CUATRI
    ||'  x.SZTPRONO_PTRM_CODE_NW: '||x.SZTPRONO_PTRM_CODE_NW||' LPTRM_INICIO:'||l_ptrm_pi);

                            l_cont_asig :=0;

                            For d in (select Distinct SZTALMT_MATERIA materia , sztalmt_bim salida
                                        from SZTQALI
                                            join sztalmt on sztalmt_alianza=sztqali_alianza --add almt para saber # materias x asignar
                                            and sztalmt_nivel=sztqali_nivel
                                            and sztalmt_materia=sztqali_materia
                                        where 1 = 1
                                        and SZTQALI_ALIANZA =c.SZTALIAN_ALIANZA
                                        AND NVL(SZTQALI_PTRM,l_ptrm_pi) = l_ptrm_pi
                                        AND SZTQALI_QA =x.SZTPRONO_CUATRI
                                        AND SZTQALI_BIM =x.SZTPRONO_PTRM_CODE_NW
                                        AND SZTQALI_NIVEL = l_nivel
                                        AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                    FROM SZSTUME ume
                                                                    WHERE 1 = 1
                                                                    AND ume.SZSTUME_SUBJ_CODE = SZTALMT_MATERIA --like 'CC%'
                                                                    AND ume.SZSTUME_PIDM = c.SZTALIAN_PIDM
                                                                    and c.SZTALIAN_ALIANZA in ('COLL','MICR','CTNU','FCBK','GADS')
                                                                    AND UME.SZSTUME_RSTS_CODE ='RE'
                                                                    And ume.SZSTUME_SEQ_NO = (select max (a1.SZSTUME_SEQ_NO)
                                                                                               from SZSTUME a1
                                                                                               Where ume.SZSTUME_PIDM = a1.SZSTUME_PIDM
                                                                                               And ume.SZSTUME_STAT_IND = a1.SZSTUME_STAT_IND
                                                                                               And ume.SZSTUME_NO_REGLA = a1.SZSTUME_NO_REGLA
                                                                                               AND ume.SZSTUME_SUBJ_CODE = a1.SZSTUME_SUBJ_CODE
                                                                                            )
                                                                   )
                                        ORDER BY  SZTALMT_MATERIA
                                        )
                            Loop
                                dbms_output.put_line('Materia '||d.materia||' pidm:'||x.sztprono_pidm||' id:'||c.sztalian_id||' Nivel:'|| l_nivel
                                                    ||' PTRM: '||l_ptrm_pi||' QA:'||x.SZTPRONO_CUATRI||' bim:'||x.SZTPRONO_PTRM_CODE_NW);

                              BEGIN

                                SELECT nvl(max(sztprono_secuencia),0)+1
                                INTO l_secuencia
                                FROM sztprono
                                WHERE 1 = 1
                                AND sztprono_no_regla = c.sztalian_no_regla
                                AND sztprono_pidm = c.SZTALIAN_PIDM;

                              exception when others then
                                  null;
                              end;

                              BEGIN
                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                              x.SZTPRONO_ID,
                                                              x.SZTPRONO_TERM_CODE,
                                                              x.SZTPRONO_PROGRAM,
                                                              d.materia,
                                                              l_secuencia,
                                                              x.SZTPRONO_PTRM_CODE,
                                                              d.materia,
                                                              'x',
                                                              x.SZTPRONO_FECHA_INICIO,
                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                              x.SZTPRONO_AVANCE,
                                                              x.SZTPRONO_NO_REGLA,
                                                              x.SZTPRONO_USUARIO,
                                                              x.SZTPRONO_STUDY_PATH,
                                                              x.SZTPRONO_RATE,
                                                              x.SZTPRONO_JORNADA,
                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                              x.SZTPRONO_CUATRI,
                                                              x.SZTPRONO_TIPO_INICIO,
                                                              x.SZTPRONO_JORNADA_DOS,
                                                              'N',--x.SZTPRONO_ENVIO_MOODL,
                                                              'N', --x.SZTPRONO_ENVIO_HORARIOS,
                                                              x.SZTPRONO_ESTATUS,
                                                              'N',--x.SZTPRONO_ESTATUS_ERROR,
                                                              null,
                                                              x.SZTPRONO_GRUPO_ASIG
                                                              );

                              exception when others then
                                  dbms_output.put_line( 'Error insert prono d.materia  --> ' ||d.materia||' Contador '||l_contador);
                              end;

                              BEGIN
                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                  WHERE 1 = 1
                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                  AND SZTALIAN_ALIANZA = p_alianza; --'FCBK';
                              exception when others then
                                  null;
                              end;

                              l_cont_asig:=l_cont_asig+1;

                              Exit When l_cont_asig = Nvl(p_cant_asig,d.salida) ;

                            END LOOP;

                        END LOOP;
                    end loop;
        commit;
    end;
--
--
    PROCEDURE p_carrusel (p_regla   NUMBER, p_alianza varchar2)
    is
       l_cuenta_nivel_li     number;
       l_cuenta_nivel_ma     number;
       l_cuenta_nivel_do     number;
       l_nivel               varchar2(2);
       l_avance              number;
       l_materias_alianza    number;
       l_materias_para       number;
       l_contador            number:=0;
       l_sec_materia         number;
       l_contador2           number:=0;
       l_secuencia           number;
       l_cuenta_alianza      number;
       l_ptrm_pi             varchar2(10);

    begin

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_li
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_ma
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_do
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma > 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  IF;

        dbms_output.put_line('Nievl '||l_nivel);


        DELETE sztalian
        WHERE 1 = 1
        AND sztalian_no_regla = p_regla
        AND SZTALIAN_FLEX ='PR'
        AND SZTALIAN_ALIANZA = p_alianza; -- ='CIFA';

         for c in ( SELECT distinct (SELECT  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            FROM SMRPRLE
                            WHERE 1 = 1
                            AND SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            p_alianza alianza, --'CIFA' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
                    FROM sztprono
                    WHERE 1 = 1
                    AND sztprono_no_regla = p_regla
--                    and sztprono_id ='010385732'
                    AND EXISTS (SELECT NULL
                                FROM GORADID
                                WHERE 1 = 1
                                AND GORADID_PIDM = SZTPRONO_PIDM
                                AND  GORADID_ADID_CODE = p_alianza) --='CIFA')
                    )loop


                        BEGIN

                          SELECT MAX(zstpara_param_id)
                          INTO l_avance
                          FROM ZSTPARA
                          WHERE 1 = 1
                          AND zstpara_mapa_id ='INSCRIPCIONES'
                          AND zstpara_param_valor = c.avance
                          AND zstpara_param_desc = c.tipo_inicio;

                        exception when others then
                            null;
                        end;

                        BEGIN


                        -- dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                          INSERT INTO sztalian VALUES (c.pidm,
                                                       c.matricula,
                                                       c.programa,
                                                       c.alianza,
                                                       l_avance,
                                                       c.regla,
                                                       'N',
                                                       nvl(l_materias_para,0),
                                                       nvl(l_materias_alianza,0),
                                                       c.tipo_inicio,
                                                       'PR'
                                                       );

                        EXCEPTION WHEN OTHERS THEN
                         NULL;
                        END;

                        COMMIT;
                    end loop;
                    --Jpg@Modify@Ene22
                    --Obtiene la secuencia siguiente para pronosticar materias
                    l_sec_materia := get_max_materia(p_regla, p_alianza,1 );
                    --Jpg@Modify@Ene22
                    for c in (SELECT *
                              FROM sztalian
                              WHERE 1 = 1
                              AND sztalian_no_regla = p_regla
                              AND SZTALIAN_FLEX ='PR'
                              and SZTALIAN_ALIANZA = p_alianza --='CIFA'
                              )loop


                                        l_ptrm_pi := get_prtm_pi(p_regla, c.sztalian_id);

                                        If (c.SZTALIAN_ALIANZA in ('CIFA','MUBA','UNIC','IEBS','MONU','FCBK') and c.sztalian_avance < 2) Then
--                                            ((substr(l_ptrm_pi,2,1) = '0' and c.sztalian_avance < 2) OR
--                                             (substr(l_ptrm_pi,2,1) = '1' and c.sztalian_avance < 3))  Then

                                            dbms_output.put_line('Alumno Descartado para alianza matricula: '||c.sztalian_id||
                                                                 ' PTRM inicio: '||l_ptrm_pi||' avance: '||c.SZTALIAN_avance||' alianza '||c.sztalian_alianza);

                                            continue; --se valida qe alumno sea b2 para pronosticar SI ES menor se descarta

                                        End if;

                                        BEGIN
                                            SELECT COUNT(*)
                                            INTO l_cuenta_alianza
                                            FROM SZTALMT
                                            WHERE 1 = 1
                                            AND SZTALMT_NIVEL = l_nivel
                                            AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                            AND SZTALMT_ACTIVO ='S'
                                            AND SZTALMT_SECUENCIA = l_sec_materia+1
                                            AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                            FROM SZSTUME
                                                                            WHERE 1 = 1
                                                                            AND SZSTUME_SUBJ_CODE like SZTALMT_MATERIA
                                                                            AND SZSTUME_PIDM = c.SZTALIAN_PIDM
                                                                             );

                                        exception when others then
                                            null;
                                        end;

                                        IF l_cuenta_alianza > 0  then

                                            l_contador:= 0;
                                            l_contador2:=0; --controla la salida de asignacion

                                            FOR d IN
                                            (
                                                SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                SZTALMT_BIM salida,
                                                                SZTALMT_SECUENCIA secuencia,
                                                                SZTALMT_ALIANZA alianza
                                                FROM SZTALMT
                                                WHERE 1 = 1
                                                AND SZTALMT_NIVEL =l_nivel
                                                AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                AND SZTALMT_ACTIVO ='S'
                                                AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                            FROM SZSTUME ume
                                                                            WHERE 1 = 1
                                                                            AND ume.SZSTUME_SUBJ_CODE = SZTALMT_MATERIA --like 'CC%'
                                                                            AND ume.SZSTUME_PIDM = c.SZTALIAN_PIDM
                                                                            AND UME.SZSTUME_RSTS_CODE ='RE'
                                                                            And ume.SZSTUME_SEQ_NO = (select max (a1.SZSTUME_SEQ_NO)
                                                                                       from SZSTUME a1
                                                                                       Where ume.SZSTUME_PIDM = a1.SZSTUME_PIDM
                                                                                       And ume.SZSTUME_STAT_IND = a1.SZSTUME_STAT_IND
                                                                                       And ume.SZSTUME_NO_REGLA = a1.SZSTUME_NO_REGLA
                                                                                       AND ume.SZSTUME_SUBJ_CODE = a1.SZSTUME_SUBJ_CODE
                                                                                      )
                                                                             )
                                            ORDER BY SZTALMT_SECUENCIA
                                            )loop

                                                 l_contador:=l_contador+1;

                                                dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);

                                                if l_contador2 = 0 then
                                                    l_contador2:=d.salida ;
                                                end if;

                                                for x in (SELECT *
                                                          FROM sztprono
                                                          WHERE 1 = 1
                                                          AND sztprono_no_regla = c.sztalian_no_regla
                                                          AND sztprono_pidm = c.sztalian_pidm
                                                          and RowNum = 1
                                                          )
                                                loop

                                                              BEGIN

                                                                SELECT nvl(max(sztprono_secuencia),0)+1
                                                                INTO l_secuencia
                                                                FROM sztprono
                                                                WHERE 1 = 1
                                                                AND sztprono_no_regla = c.sztalian_no_regla
                                                                AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                              exception when others then
                                                                  null;
                                                              end;

                                                              BEGIN
                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                              x.SZTPRONO_ID,
                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                              x.SZTPRONO_PROGRAM,
                                                                                              d.materia,
                                                                                              l_secuencia,
                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                              d.materia,
                                                                                              'x',
                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                              x.SZTPRONO_AVANCE,
                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                              x.SZTPRONO_USUARIO,
                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                              x.SZTPRONO_RATE,
                                                                                              x.SZTPRONO_JORNADA,
                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                              x.SZTPRONO_CUATRI,
                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                              x.SZTPRONO_ENVIO_MOODL,
                                                                                              x.SZTPRONO_ENVIO_HORARIOS,
                                                                                              x.SZTPRONO_ESTATUS,
                                                                                              x.SZTPRONO_ESTATUS_ERROR,
                                                                                              null,
                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                              );

                                                              exception when others then
                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                              end;

                                                              BEGIN
                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                  WHERE 1 = 1
                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                  AND SZTALIAN_ALIANZA = p_alianza; --='CIFA';
                                                              exception when others then
                                                                  null;
                                                              end;
                                                          END LOOP;
                                                 exit when l_contador = l_contador2;

                                            END LOOP;

                                        end IF;

                    end loop;
        commit;
    end;
--
--
    PROCEDURE p_carrusel_pidm (p_regla   NUMBER, p_alianza varchar2, p_pidm number)
    is
       l_cuenta_nivel_li     number;
       l_cuenta_nivel_ma     number;
       l_cuenta_nivel_do     number;
       l_nivel               varchar2(2);
       l_avance              number;
       l_materias_alianza    number;
       l_materias_para       number;
       l_peirod_uni          varchar2(2);
       l_contador            number:=0;
       l_sec_materia         number;
       l_contador2           number:=0;
       l_secuencia           number;
       l_cuenta_alianza      number;
       l_cuenta_mh           number;
       l_cuenta_qali         number;
       l_ptrm_pi             varchar2(3);
    begin

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_li
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='LI';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_ma
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='MA';


        exception when others then
            null;
        end;

        BEGIN

            SELECT COUNT(*)
            INTO l_cuenta_nivel_do
            FROM sztalgo
            WHERE 1 = 1
            AND sztalgo_no_regla = p_regla
            AND SZTALGO_LEVL_CODE ='DO';


        exception when others then
            null;
        end;

        IF l_cuenta_nivel_li > 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='LI';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma > 0 AND l_cuenta_nivel_do = 0 Then

            l_nivel :='MA';

        elsIF l_cuenta_nivel_li = 0 AND l_cuenta_nivel_ma = 0 AND l_cuenta_nivel_do > 0 Then

            l_nivel :='DO';

        end  IF;

        dbms_output.put_line('Nievl '||l_nivel);


        DELETE sztalian
        WHERE 1 = 1
        AND sztalian_no_regla = p_regla
        AND SZTALIAN_FLEX ='PR'
        and sztalian_pidm = p_pidm
        AND SZTALIAN_ALIANZA = p_alianza; -- ='CIFA';

        DELETE sztprono
        WHERE 1 = 1
        AND sztprono_no_regla = p_regla
        and sztprono_pidm=p_pidm
        AND Exists(Select 1 from sztalmt
                    where sztalmt_materia = sztprono_materia_legal
                       and sztalmt_alianza= p_alianza);

         for c in ( SELECT distinct (SELECT  SUBSTR(SMRPRLE_PROGRAM_DESC,1,1)||lower(SUBSTR(SMRPRLE_PROGRAM_DESC,1,100))
                            FROM SMRPRLE
                            WHERE 1 = 1
                            AND SMRPRLE_PROGRAM = SZTPRONO_PROGRAM) nombre,
                            SZTPRONO_PROGRAM programa,
                            sztprono_pidm pidm,
                            sztprono_id matricula,
                             SZTPRONO_CUATRI||','||SZTPRONO_PTRM_CODE_NW avance,
                            p_alianza alianza, --'CIFA' alianza,
                            SZTPRONO_TIPO_INICIO tipo_inicio,
                            sztprono_no_regla regla
                    FROM sztprono
                    WHERE 1 = 1
                    AND sztprono_no_regla = p_regla
                    and sztprono_pidm = p_pidm
                    AND EXISTS (SELECT NULL
                                FROM GORADID
                                WHERE 1 = 1
                                AND GORADID_PIDM = SZTPRONO_PIDM
                                AND  GORADID_ADID_CODE = p_alianza) --='CIFA')
                    )loop


                        BEGIN

                          SELECT MAX(zstpara_param_id)
                          INTO l_avance
                          FROM ZSTPARA
                          WHERE 1 = 1
                          AND zstpara_mapa_id ='INSCRIPCIONES'
                          AND zstpara_param_valor = c.avance
                          AND zstpara_param_desc = c.tipo_inicio;

                        exception when others then
                            null;
                        end;

                        BEGIN


                        -- dbms_output.put_line (' PImd '||d.pidm||' Matricula '||d.matricula||'  Alianza '||c.alianza||' Avance '||l_avance||' Regla '||d.regla||' materias para '||l_materias_para||' matereias alianza '||l_materias_alianza||' Tipo Inicio '||d.tipo_inicio);

                          INSERT INTO sztalian VALUES (c.pidm,
                                                       c.matricula,
                                                       c.programa,
                                                       c.alianza,
                                                       l_avance,
                                                       c.regla,
                                                       'N',
                                                       nvl(l_materias_para,0),
                                                       nvl(l_materias_alianza,0),
                                                       c.tipo_inicio,
                                                       'PR'
                                                       );

                        EXCEPTION WHEN OTHERS THEN
                         NULL;
                        END;

                        COMMIT;
                    end loop;
                    --Jpg@Modify@Ene22
                    --Obtiene la secuencia siguiente para pronosticar materias
                    l_sec_materia := get_max_materia(p_regla, p_alianza,1 );
                    --Jpg@Modify@Ene22
                    for c in (SELECT *
                              FROM sztalian
                              WHERE 1 = 1
                              AND sztalian_no_regla = p_regla
                              AND SZTALIAN_FLEX ='PR'
                              and sztalian_pidm = p_pidm
                              and SZTALIAN_ALIANZA = p_alianza --='CIFA'
                              )loop

dbms_output.put_line('eNTRA CARRUSEL PIDM'||p_pidm);

                                        l_ptrm_pi := get_prtm_pi(p_regla, c.sztalian_id);

                                        If (c.SZTALIAN_ALIANZA in ('CIFA','MUBA','UNIC','IEBS','MONU','FCBK') and c.sztalian_avance < 2) Then
--                                            ((substr(l_ptrm_pi,2,1) = '0' and c.sztalian_avance < 2) OR
--                                             (substr(l_ptrm_pi,2,1) = '1' and c.sztalian_avance < 3))  Then

                                            dbms_output.put_line('Alumno Descartado para alianza matricula: '||c.sztalian_id||
                                                                 ' PTRM inicio: '||l_ptrm_pi||' avance: '||c.SZTALIAN_avance||' alianza '||c.sztalian_alianza);

                                            continue; --se valida qe alumno sea b2 para pronosticar SI ES menor se descarta

                                        End if;

                                        BEGIN
                                            SELECT COUNT(*)
                                            INTO l_cuenta_alianza
                                            FROM SZTALMT
                                            WHERE 1 = 1
                                            AND SZTALMT_NIVEL = l_nivel
                                            AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                            AND SZTALMT_ACTIVO ='S'
                                            AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                            FROM SZSTUME
                                                                            WHERE 1 = 1
                                                                            AND SZSTUME_PIDM = c.SZTALIAN_PIDM
                                                                            AND SZSTUME_SUBJ_CODE like SZTALMT_MATERIA
                                                                             );

                                        exception when others then
                                            null;
                                        end;
dbms_output.put_line('eNTRA CARRUSEL l_cuenta_alianza'||l_cuenta_alianza);

                                        IF l_cuenta_alianza > 0 then

                                            l_contador:= 0;
                                            l_contador2:=0; --controla la salida de asignacion

                                            FOR d IN
                                            (
                                                SELECT DISTINCT SZTALMT_MATERIA materia,
                                                                SZTALMT_BIM salida,
                                                                SZTALMT_SECUENCIA secuencia,
                                                                SZTALMT_ALIANZA alianza
                                                FROM SZTALMT
                                                WHERE 1 = 1
                                                AND SZTALMT_NIVEL =l_nivel
                                                AND SZTALMT_ALIANZA =c.SZTALIAN_ALIANZA
                                                AND SZTALMT_ACTIVO ='S'
                                                AND SZTALMT_SECUENCIA > l_sec_materia  --Jpg@Modify@Ene22 prono x secuencia max
                                                AND SZTALMT_MATERIA NOT IN (SELECT DISTINCT SZSTUME_SUBJ_CODE
                                                                            FROM SZSTUME ume
                                                                            WHERE 1 = 1
                                                                            AND ume.SZSTUME_SUBJ_CODE = SZTALMT_MATERIA --like 'CC%'
                                                                            AND ume.SZSTUME_PIDM = c.SZTALIAN_PIDM
                                                                            AND UME.SZSTUME_RSTS_CODE ='RE'
                                                                            And ume.SZSTUME_SEQ_NO = (select max (a1.SZSTUME_SEQ_NO)
                                                                                       from SZSTUME a1
                                                                                       Where ume.SZSTUME_PIDM = a1.SZSTUME_PIDM
                                                                                       And ume.SZSTUME_STAT_IND = a1.SZSTUME_STAT_IND
                                                                                       And ume.SZSTUME_NO_REGLA = a1.SZSTUME_NO_REGLA
                                                                                       AND ume.SZSTUME_SUBJ_CODE = a1.SZSTUME_SUBJ_CODE
                                                                                      )
                                                                             )
                                            ORDER BY SZTALMT_SECUENCIA
                                            )loop

                                                 l_contador:=l_contador+1;

                                                dbms_output.put_line('Materia '||d.materia||' Salida '||d.salida||' Contador '||l_contador||' Alumno '||c.sztalian_id);

                                                if l_contador2 =0 Then

                                                    l_contador2:=d.salida;
                                                end if;

                                                for x in (SELECT *
                                                          FROM sztprono
                                                          WHERE 1 = 1
                                                          AND sztprono_no_regla = c.sztalian_no_regla
                                                          AND sztprono_pidm = c.sztalian_pidm
                                                          and RowNum = 1
                                                          )
                                                loop

                                                              BEGIN

                                                                SELECT nvl(max(sztprono_secuencia),0)+1
                                                                INTO l_secuencia
                                                                FROM sztprono
                                                                WHERE 1 = 1
                                                                AND sztprono_no_regla = c.sztalian_no_regla
                                                                AND sztprono_pidm = c.SZTALIAN_PIDM;

                                                              exception when others then
                                                                  null;
                                                              end;

                                                              BEGIN
                                                                  INSERT INTO sztprono VALUES(x.SZTPRONO_PIDM,
                                                                                              x.SZTPRONO_ID,
                                                                                              x.SZTPRONO_TERM_CODE,
                                                                                              x.SZTPRONO_PROGRAM,
                                                                                              d.materia,
                                                                                              l_secuencia,
                                                                                              x.SZTPRONO_PTRM_CODE,
                                                                                              d.materia,
                                                                                              'x',
                                                                                              x.SZTPRONO_FECHA_INICIO,
                                                                                              x.SZTPRONO_PTRM_CODE_NW,
                                                                                              x.SZTPRONO_FECHA_INICIO_NW,
                                                                                              x.SZTPRONO_AVANCE,
                                                                                              x.SZTPRONO_NO_REGLA,
                                                                                              x.SZTPRONO_USUARIO,
                                                                                              x.SZTPRONO_STUDY_PATH,
                                                                                              x.SZTPRONO_RATE,
                                                                                              x.SZTPRONO_JORNADA,
                                                                                              x.SZTPRONO_ACTIVITY_DATE,
                                                                                              x.SZTPRONO_CUATRI,
                                                                                              x.SZTPRONO_TIPO_INICIO,
                                                                                              x.SZTPRONO_JORNADA_DOS,
                                                                                              'N',--x.SZTPRONO_ENVIO_MOODL,
                                                                                              'N', --x.SZTPRONO_ENVIO_HORARIOS,
                                                                                              x.SZTPRONO_ESTATUS,
                                                                                              'N',--x.SZTPRONO_ESTATUS_ERROR,
                                                                                              null,
                                                                                              x.SZTPRONO_GRUPO_ASIG
                                                                                              );

                                                              exception when others then
                                                                  dbms_output.put_line( 'd.materia  --> ' ||d.materia||' Contador '||l_contador);
                                                              end;

                                                              BEGIN
                                                                  UPDATE sztalian SET SZTALIAN_ESTATUS ='S'
                                                                  WHERE 1 = 1
                                                                  AND sztalian_no_regla = x.SZTPRONO_NO_REGLA
                                                                  AND sztalian_pidm = x.SZTPRONO_PIDM
                                                                  AND SZTALIAN_ALIANZA = p_alianza; --='CIFA';
                                                              exception when others then
                                                                  null;
                                                              end;
                                                          END LOOP;
                                                 exit when l_contador = l_contador2;

                                            END LOOP;

                                        end IF;

                    end loop;
        commit;
    end;
--
--Jpg@Create@Feb23
--Procedure pronostica las alianzas con prioridades
Procedure p_prono_ali(p_regla number, p_id varchar2 default null) is
    --Variables Locales
    lc_contador number;
    lc_asigna   number;


    Cursor cur_pob is
            Select pob.matricula, pob.pidm, pob.nivel, Ejecutiva, Senior, College, Alianza
            From (
                    --Alumnos Con Alianzas
                    Select  Distinct id_alumno matricula,
                                    SGBSTDN_PIDM pidm,
                                    Case When nivel = 'MS' then 'MA' Else nivel end nivel
                    from sztalgo
                    join REL_PROGRAMAXALUMNO p on p.REL_PROGRAMAXALUMNO_no_regla=sztalgo_no_regla
                    join goradid on goradid_pidm = SGBSTDN_PIDM
                    join sztalia on sztalia_code = goradid_adid_code
                                and sztalia_lvel = Case When nivel = 'MS' then 'MA' Else nivel end
                                and SZTALIA_NUM_MATERIAS > 0  --Solo Alianzas con materias
                    where sztalgo_no_regla=NVL(p_regla,sztalgo_no_regla)
                    AND p.ID_ALUMNO = NVL(P_ID,p.ID_ALUMNO)
                    and sztalgo_levl_code = Case When nivel = 'MS' then 'MA' Else nivel end
            ) pob left join (
                    --Alumnos con Sesiones Ejecutivas
                    Select  Distinct id_alumno matricula,
                                    SGBSTDN_PIDM pidm,
                                    Case When nivel = 'MS' then 'MA' Else nivel end nivel,
                                    'X' Ejecutiva
                    from sztalgo
                    join REL_PROGRAMAXALUMNO p on p.REL_PROGRAMAXALUMNO_no_regla=sztalgo_no_regla
                    join goradid on goradid_pidm = SGBSTDN_PIDM
                    join sztalia on sztalia_code = goradid_adid_code
                                and sztalia_lvel = Case When nivel = 'MS' then 'MA' Else nivel end
                                and SZTALIA_NUM_MATERIAS > 0  --Solo Alianzas con materias
                    where sztalgo_no_regla=NVL(p_regla,sztalgo_no_regla)
                    AND p.ID_ALUMNO = NVL(P_ID,p.ID_ALUMNO)
                    and sztalgo_levl_code = Case When nivel = 'MS' then 'MA' Else nivel end
                    and sztalia_code in ('EJEC')
            ) ejec on ejec.pidm=pob.pidm and ejec.nivel = pob.nivel left join (
                    --Alumnos con Senior
                    Select  Distinct id_alumno matricula,
                                    SGBSTDN_PIDM pidm,
                                    Case When nivel = 'MS' then 'MA' Else nivel end nivel, 'X' Senior
                    from sztalgo
                    join REL_PROGRAMAXALUMNO p on p.REL_PROGRAMAXALUMNO_no_regla=sztalgo_no_regla
                    join goradid on goradid_pidm = SGBSTDN_PIDM
                    join sztalia on sztalia_code = goradid_adid_code
                                and sztalia_lvel = Case When nivel = 'MS' then 'MA' Else nivel end
                                and SZTALIA_NUM_MATERIAS > 0  --Solo Alianzas con materias
                    where sztalgo_no_regla=NVL(p_regla,sztalgo_no_regla)
                    AND p.ID_ALUMNO = NVL(P_ID,p.ID_ALUMNO)
                    and sztalgo_levl_code = Case When nivel = 'MS' then 'MA' Else nivel end
                    and sztalia_code in ('SENI','AMAY')
            ) seni on seni.pidm = pob.pidm and seni.nivel = pob.nivel left join (
                    --Alumnos con College
                    Select  Distinct id_alumno matricula,
                                    SGBSTDN_PIDM pidm,
                                    Case When nivel = 'MS' then 'MA' Else nivel end nivel, 'X' College
                    from sztalgo
                    join REL_PROGRAMAXALUMNO p on p.REL_PROGRAMAXALUMNO_no_regla=sztalgo_no_regla
                    join goradid on goradid_pidm = SGBSTDN_PIDM
                    join sztalia on sztalia_code = goradid_adid_code
                                and sztalia_lvel = Case When nivel = 'MS' then 'MA' Else nivel end
                                and SZTALIA_NUM_MATERIAS > 0  --Solo Alianzas con materias
                    where sztalgo_no_regla=NVL(p_regla,sztalgo_no_regla)
                    AND p.ID_ALUMNO = NVL(P_ID,p.ID_ALUMNO)
                    and sztalgo_levl_code = Case When nivel = 'MS' then 'MA' Else nivel end
                    and sztalia_code in ('COLL','AJOV')
             ) coll on coll.pidm = pob.pidm and coll.nivel = pob.nivel  left join(
                    --Alumnos con Otras Alianzas sin Coll, Senior, Ejecutivas
                    Select matricula, pidm,nivel, count(ali) alianza
                    from (
                        Select  Distinct id_alumno matricula,
                                SGBSTDN_PIDM pidm,
                                Case When nivel = 'MS' then 'MA' Else nivel end nivel, sztalia_code Ali
                        from sztalgo
                        join REL_PROGRAMAXALUMNO p on p.REL_PROGRAMAXALUMNO_no_regla=sztalgo_no_regla
                        join goradid on goradid_pidm = SGBSTDN_PIDM
                        join sztalia on sztalia_code = goradid_adid_code
                                    and sztalia_lvel = Case When nivel = 'MS' then 'MA' Else nivel end
                                    and SZTALIA_NUM_MATERIAS > 0  --Solo Alianzas con materias
                        where sztalgo_no_regla=NVL(p_regla,sztalgo_no_regla)
                    AND p.ID_ALUMNO = NVL(P_ID,p.ID_ALUMNO)
                        and sztalgo_levl_code = Case When nivel = 'MS' then 'MA' Else nivel end
                        and sztalia_code not in ('COLL','SENI','EJEC','UTLX','DUOL','CAM1','CAMB','UCV2','UCAM','AJOV','AMAY')
                   ) Group by matricula, pidm,nivel
             ) alia on alia.pidm = pob.pidm and alia.nivel = pob.nivel
             Where pob.matricula = NVL(p_id,pob.matricula)
            Order by matricula;

    Cursor cur_ali (p_pidm number) is
            Select  Distinct id_alumno matricula,
                    SGBSTDN_PIDM pidm,
                    Case When nivel = 'MS' then 'MA' Else nivel end nivel, sztalia_code Alianza,
                    Case When tume.pidm is null Then 'N' Else 'S' End SI,  --Revisamos si hay alguna ali activa ya en stume le damos prioridad
                    sztalia_seq seq
            from sztalgo
            join REL_PROGRAMAXALUMNO p on p.REL_PROGRAMAXALUMNO_no_regla=sztalgo_no_regla
            join goradid on goradid_pidm = SGBSTDN_PIDM
            join sztalia on sztalia_code = goradid_adid_code
                        and sztalia_lvel = Case When nivel = 'MS' then 'MA' Else nivel end
                        and SZTALIA_NUM_MATERIAS > 0  --Solo Alianzas con materias
            left join (
                        select Distinct Sztalmt_alianza ali, szstume_pidm pidm
                        from sztalmt
                        join szstume z on z.szstume_subj_code=sztalmt_materia
                        where z.szstume_pidm=p_pidm
                                 and z.szstume_rsts_code='RE'
                                 and z.SZSTUME_SEQ_NO = (Select Max(x.SZSTUME_SEQ_NO)
                                                        from SZSTUME x
                                                        where x.SZSTUME_no_regla = z.SZSTUME_no_regla
                                                        and x.SZSTUME_subj_code = z.SZSTUME_subj_code
                                                        and x.szstume_pidm = z.szstume_pidm)
                       ) tume on tume.pidm=SGBSTDN_PIDM and tume.ali=sztalia_code
            where sztalgo_no_regla=NVL(p_regla,sztalgo_no_regla)
            and sztalgo_levl_code = Case When nivel = 'MS' then 'MA' Else nivel end
            and SGBSTDN_PIDM = p_pidm
            and sztalia_code not in ('COLL','SENI','EJEC','AJOV','AMAY')
            ORDER BY SI desc, Seq;

    Cursor cur_ali_2 (p_pidm number, p_param varchar2) is
        SELECT Goradid_adid_code etiq
        FROM goradid
        WHERE goradid_pidm = p_pidm
          AND goradid_adid_code IN (
            SELECT REGEXP_SUBSTR(P_PARAM, '[^,]+', 1, LEVEL)
            FROM dual
            CONNECT BY REGEXP_SUBSTR(P_PARAM, '[^,]+', 1, LEVEL) IS NOT NULL
          );    

    Procedure delete_alianzas_pidm (pp_regla number, pp_pidm number) is

        Begin
            Delete from sztprono d
            Where (d.sztprono_no_regla, d.sztprono_pidm, d.sztprono_materia_legal, d.sztprono_secuencia)
            in ( Select  Distinct sztalgo_no_regla,
                            SGBSTDN_PIDM pidm,
                            sztprono_materia_legal materia,
                            sztprono_secuencia
                    from sztalgo
                    join REL_PROGRAMAXALUMNO p on p.REL_PROGRAMAXALUMNO_no_regla=sztalgo_no_regla
                    join goradid on goradid_pidm = SGBSTDN_PIDM
                    join sztalia on sztalia_code = goradid_adid_code
                                and sztalia_lvel = Case When nivel = 'MS' then 'MA' Else nivel end
                                and SZTALIA_NUM_MATERIAS > 0  --Solo Alianzas con materias
                    join sztprono on sztprono_no_regla=sztalgo_no_regla
                                 and sztprono_pidm=SGBSTDN_PIDM
                    join sztalmt on sztalmt_alianza=sztalia_code
                                and sztalmt_materia=sztprono_materia_legal
                    where sztalgo_no_regla= pp_regla
                    and sztalgo_levl_code = Case When nivel = 'MS' then 'MA' Else nivel end
                    and SGBSTDN_PIDM = pp_pidm
            );


        Exception When Others Then null;
    End delete_alianzas_pidm;

BEGIN


delete from umd.tmp_alum_fin where secuencia=p_regla and matricula = Nvl(p_id,matricula);

if p_id is null Then
    begin
        p_elimina_etiqueta(p_regla,1);
        commit;
    end;
end if;


    FOR pob IN cur_pob LOOP

        --Borramos alianzas en caso de haber
        delete_alianzas_pidm(p_regla,pob.pidm);

        insert into umd.tmp_alum_fin  (secuencia, matricula,  materia_legal,prog_prono  ,mathijo,    calif, estatus) Values
                             (p_regla,pob.matricula, 'Ejecutiva:'||pob.Ejecutiva, 'Senior:'||pob.Senior, 'College:'||pob.College, pob.Alianza, to_char(sysdate,'DD/MM/YYYY HH24:MI:SS') );

        --Sí trae Ejecutivas
        if (pob.ejecutiva is not null ) Then
            if (pob.alianza is not null) Then

                if (pob.alianza >= 1) Then
                    pkg_alianzas.p_no_carrusel_pidm(p_regla,'EJEC',pob.pidm,1); ---FALTA QE SOLO ASIGNE1
                    lc_asigna   :=1;
                end if;

--                if (pob.alianza > 1) Then
--                    lc_asigna   :=1;
--                end if;

                lc_contador :=0;

                for ali in cur_ali(pob.pidm) Loop
insert into umd.tmp_alum_fin  (secuencia, matricula,  materia_legal,prog_prono  ,mathijo,    calif, estatus) Values
                     (p_regla,pob.matricula, 'Sí trae Ejecutivas-> Alianza:'||ali.alianza, 'Senior:'||pob.Senior, 'College:'||pob.College, pob.Alianza, to_char(sysdate,'DD/MM/YYYY HH24:MI:SS') );

                    if ali.alianza in ('CIFA','MUBA','UNIC','IEBS','MONU','FCBK','LEGA') Then --Seagrega LEGA junio2023@Frank
                        dbms_output.put_line('CarruselAlum:'||ali.matricula||' Alianza:'||ali.alianza||' Regla:'||p_regla);
                        pkg_alianzas.p_carrusel_pidm(p_regla,ali.alianza,ali.pidm);
                    end if;
                    if ali.alianza in ('EJEC','SENI','GADS','MICR','TABL','CLOU','CESA','COUR','COLL','AJOV','AMAY') Then    --SENI, COUR, CAMB, DUOL, EJEC, CLOU
                        dbms_output.put_line('NOCarruselAlum:'||ali.matricula||' Alianza:'||ali.alianza||' Regla:'||p_regla);
                        pkg_alianzas.p_no_carrusel_pidm(p_regla,ali.alianza,ali.pidm);
                    end if;
                    lc_contador:=lc_contador+1;
                    Exit When lc_asigna=lc_contador;
                End Loop;

            else
                --Solo tiene ejecutivas
                pkg_alianzas.p_no_carrusel_pidm(p_regla,'EJEC',pob.pidm);
            end if;
        end if;

        --Sí trae SENIOR
        if (pob.senior is not null ) Then
            if (pob.alianza is not null) Then

                if (pob.alianza >= 1) Then
                    FOR c IN cur_ali_2(pob.pidm,'SENI,AMAY') LOOP
                        pkg_alianzas.p_no_carrusel_pidm(p_regla,c.etiq,pob.pidm);                
                    END LOOP;
                    lc_asigna   :=1;
                end if;

--                if (pob.alianza > 1) Then
--                    lc_asigna   :=1;
--                end if;

                lc_contador :=0;

                for ali in cur_ali(pob.pidm) Loop
insert into umd.tmp_alum_fin  (secuencia, matricula,  materia_legal,prog_prono  ,mathijo,    calif, estatus) Values
                     (p_regla,pob.matricula, 'Sí trae SENIOR-> Alianza:'||ali.alianza, 'Senior:'||pob.Senior, 'College:'||pob.College, pob.Alianza, to_char(sysdate,'DD/MM/YYYY HH24:MI:SS') );

                    if ali.alianza in ('CIFA','MUBA','UNIC','IEBS','MONU','FCBK','LEGA') Then
                        dbms_output.put_line('CarruselAlum:'||ali.matricula||' Alianza:'||ali.alianza||' Regla:'||p_regla);
                        pkg_alianzas.p_carrusel_pidm(p_regla,ali.alianza,ali.pidm);
                    end if;
                    if ali.alianza in ('EJEC','SENI','GADS','MICR','TABL','CLOU','CESA','COUR','COLL','AJOV','AMAY') Then    --SENI, COUR, CAMB, DUOL, EJEC, CLOU
                        dbms_output.put_line('NOCarruselAlum:'||ali.matricula||' Alianza:'||ali.alianza||' Regla:'||p_regla);
                        pkg_alianzas.p_no_carrusel_pidm(p_regla,ali.alianza,ali.pidm);
                    end if;
                    lc_contador:=lc_contador+1;
                    Exit When lc_asigna=lc_contador;
                End Loop;

            else
                --Solo tiene ejecutivas
                FOR c IN cur_ali_2(pob.pidm,'SENI,AMAY') LOOP
                    pkg_alianzas.p_no_carrusel_pidm(p_regla,c.etiq,pob.pidm);                
                END LOOP;
            end if;
        end if;


        --Sí trae College
        if (pob.college is not null ) Then
            if (pob.alianza is not null) Then

                if (pob.alianza >= 1) Then
                    FOR c IN cur_ali_2(pob.pidm,'COLL,AJOV') LOOP --Frank@Add@Ene25
                        pkg_alianzas.p_no_carrusel_pidm(p_regla,c.etiq,pob.pidm);                
                    END LOOP; 
                    lc_asigna   :=1;
                end if;

--                if (pob.alianza > 1) Then
--                    lc_asigna   :=1;
--                end if;

                lc_contador :=0;

                for ali in cur_ali(pob.pidm) Loop
insert into umd.tmp_alum_fin  (secuencia, matricula,  materia_legal,prog_prono  ,mathijo,    calif, estatus) Values
                     (p_regla,pob.matricula, 'Sí trae College-> Alianza:'||ali.alianza, 'Senior:'||pob.Senior, 'College:'||pob.College, pob.Alianza, to_char(sysdate,'DD/MM/YYYY HH24:MI:SS') );

                    if ali.alianza in ('CIFA','MUBA','UNIC','IEBS','MONU','FCBK','LEGA') Then

                        dbms_output.put_line('CarruselAlum:'||ali.matricula||' Alianza:'||ali.alianza||' Regla:'||p_regla);

                        pkg_alianzas.p_carrusel_pidm(p_regla,ali.alianza,ali.pidm);
                    end if;
                    if ali.alianza in ('EJEC','SENI','GADS','MICR','TABL','CLOU','CESA','COUR','COLL','AJOV','AMAY') Then    --SENI, COUR, CAMB, DUOL, EJEC, CLOU
                        dbms_output.put_line('NOCarruselAlum:'||ali.matricula||' Alianza:'||ali.alianza||' Regla:'||p_regla);

                        pkg_alianzas.p_no_carrusel_pidm(p_regla,ali.alianza,ali.pidm);
                    end if;
                    lc_contador:=lc_contador+1;
                    Exit When lc_asigna=lc_contador;
                End Loop;

            else
                --Solo tiene ejecutivas
                FOR c IN cur_ali_2(pob.pidm,'COLL,AJOV') LOOP --Frank@Add@Ene25
                    pkg_alianzas.p_no_carrusel_pidm(p_regla,c.etiq,pob.pidm);                
                END LOOP;                
            end if;
        end if;

        --No trae NI Ejecutivas, Senior, College
        if (pob.ejecutiva is null and pob.senior is null and pob.college is null ) Then
            if (pob.alianza = 1) Then lc_asigna :=1; end if;
            if (pob.alianza > 1) Then lc_asigna :=2; end if;

insert into umd.tmp_alum_fin  (secuencia, matricula,  materia_legal,prog_prono  ,mathijo,    calif, estatus) Values
                     (p_regla,pob.matricula, 'No trae NI Ejecutivas, Senior, College-> Alianza:'||pob.alianza, 'Senior:'||pob.Senior, 'College:'||pob.College, pob.Alianza, to_char(sysdate,'DD/MM/YYYY HH24:MI:SS') );

--            if (pob.alianza > 1) Then lc_asigna :=1; end if;

            lc_contador :=0;
 dbms_output.put_line('Pidm:'||pob.pidm||' pob.alianza:'||pob.alianza);

            for ali in cur_ali(pob.pidm) Loop
insert into umd.tmp_alum_fin  (secuencia, matricula,  materia_legal,prog_prono  ,mathijo,    calif, estatus) Values
                     (p_regla,pob.matricula, 'No trae NI Ejecutivas, Senior, College-> Alianza:'||ali.alianza, 'Senior:'||pob.Senior, 'College:'||pob.College, pob.Alianza, to_char(sysdate,'DD/MM/YYYY HH24:MI:SS') );

                if ali.alianza in ('CIFA','MUBA','UNIC','IEBS','MONU','FCBK','LEGA') Then
                    dbms_output.put_line('CarruselAlum:'||ali.matricula||' Alianza:'||ali.alianza||' Regla:'||p_regla);
                    pkg_alianzas.p_carrusel_pidm(p_regla,ali.alianza,ali.pidm);
                end if;
                if ali.alianza in ('EJEC','SENI','GADS','MICR','TABL','CLOU',
                                    'CESA','COUR','COLL','AJOV','AMAY','HLIC','HMAS') Then    --SENI, COUR, CAMB, DUOL, EJEC, CLOU
                    dbms_output.put_line('NOCarruselAlum:'||ali.matricula||' Alianza:'||ali.alianza||' Regla:'||p_regla);
                    pkg_alianzas.p_no_carrusel_pidm(p_regla,ali.alianza,ali.pidm);
                end if;
                lc_contador:=lc_contador+1;
                Exit When lc_asigna=lc_contador;
            End Loop;
        end if;
        
        --Frank@Modify:19-julio-2023: Se asignas las alianzas de idiomas y plataforma...
        --Alianzas que siempre se debe asignar
        for ali in cur_ali(pob.pidm) Loop

                if ali.alianza in ('UTLX','DUOL','CAM1','CAMB','UCV2','UCAM') Then    
--                if ali.alianza in ('DUOL','CAM1','CAMB') Then    
                    dbms_output.put_line('TRAE alianza por default asignar:'||ali.matricula||' Alianza:'||ali.alianza||' Regla:'||p_regla);
                    pkg_alianzas.p_no_carrusel_pidm(p_regla,ali.alianza,ali.pidm);

                    insert into umd.tmp_alum_fin  (secuencia, matricula,  materia_legal,prog_prono  ,mathijo,    calif, estatus) Values
                        (p_regla,pob.matricula, 'Sí trae idioma u otra que se asigna siempre Alianza:'||ali.alianza, 'Senior:'||pob.Senior, 
                            'College:'||pob.College, pob.Alianza, to_char(sysdate,'DD/MM/YYYY HH24:MI:SS') );
                end if;
        End Loop;        

    END LOOP;

End p_prono_ali;

--
--
--Jpg@Create@Nov24
--Procedure pronostica las alianzas con prioridades id fijo
Procedure p_prono_ali_v2(p_regla number, p_id varchar2 ) is
    --Variables Locales
    lc_contador number;
    lc_asigna   number;


    Cursor cur_pob is
            Select pob.matricula, pob.pidm, pob.nivel, Ejecutiva, Senior, College, Alianza
            From (
                    --Alumnos Con Alianzas
                    Select  Distinct id_alumno matricula,
                                    SGBSTDN_PIDM pidm,
                                    Case When nivel = 'MS' then 'MA' Else nivel end nivel
                    from sztalgo
                    join REL_PROGRAMAXALUMNO p on p.REL_PROGRAMAXALUMNO_no_regla=sztalgo_no_regla
                    join goradid on goradid_pidm = SGBSTDN_PIDM
                    join sztalia on sztalia_code = goradid_adid_code
                                and sztalia_lvel = Case When nivel = 'MS' then 'MA' Else nivel end
                                and SZTALIA_NUM_MATERIAS > 0  --Solo Alianzas con materias
                    where sztalgo_no_regla=p_regla
                    AND p.ID_ALUMNO = P_ID
                    and sztalgo_levl_code = Case When nivel = 'MS' then 'MA' Else nivel end
            ) pob left join (
                    --Alumnos con Sesiones Ejecutivas
                    Select  Distinct id_alumno matricula,
                                    SGBSTDN_PIDM pidm,
                                    Case When nivel = 'MS' then 'MA' Else nivel end nivel,
                                    'X' Ejecutiva
                    from sztalgo
                    join REL_PROGRAMAXALUMNO p on p.REL_PROGRAMAXALUMNO_no_regla=sztalgo_no_regla
                    join goradid on goradid_pidm = SGBSTDN_PIDM
                    join sztalia on sztalia_code = goradid_adid_code
                                and sztalia_lvel = Case When nivel = 'MS' then 'MA' Else nivel end
                                and SZTALIA_NUM_MATERIAS > 0  --Solo Alianzas con materias
                    where sztalgo_no_regla=p_regla
                    AND p.ID_ALUMNO = P_ID
                    and sztalgo_levl_code = Case When nivel = 'MS' then 'MA' Else nivel end
                    and sztalia_code in ('EJEC')
            ) ejec on ejec.pidm=pob.pidm and ejec.nivel = pob.nivel left join (
                    --Alumnos con Senior
                    Select  Distinct id_alumno matricula,
                                    SGBSTDN_PIDM pidm,
                                    Case When nivel = 'MS' then 'MA' Else nivel end nivel, 'X' Senior
                    from sztalgo
                    join REL_PROGRAMAXALUMNO p on p.REL_PROGRAMAXALUMNO_no_regla=sztalgo_no_regla
                    join goradid on goradid_pidm = SGBSTDN_PIDM
                    join sztalia on sztalia_code = goradid_adid_code
                                and sztalia_lvel = Case When nivel = 'MS' then 'MA' Else nivel end
                                and SZTALIA_NUM_MATERIAS > 0  --Solo Alianzas con materias
                    where sztalgo_no_regla=p_regla
                    AND p.ID_ALUMNO = P_ID
                    and sztalgo_levl_code = Case When nivel = 'MS' then 'MA' Else nivel end
                    and sztalia_code in ('SENI')
            ) seni on seni.pidm = pob.pidm and seni.nivel = pob.nivel left join (
                    --Alumnos con College
                    Select  Distinct id_alumno matricula,
                                    SGBSTDN_PIDM pidm,
                                    Case When nivel = 'MS' then 'MA' Else nivel end nivel, 'X' College
                    from sztalgo
                    join REL_PROGRAMAXALUMNO p on p.REL_PROGRAMAXALUMNO_no_regla=sztalgo_no_regla
                    join goradid on goradid_pidm = SGBSTDN_PIDM
                    join sztalia on sztalia_code = goradid_adid_code
                                and sztalia_lvel = Case When nivel = 'MS' then 'MA' Else nivel end
                                and SZTALIA_NUM_MATERIAS > 0  --Solo Alianzas con materias
                    where sztalgo_no_regla=p_regla
                    AND p.ID_ALUMNO = P_ID
                    and sztalgo_levl_code = Case When nivel = 'MS' then 'MA' Else nivel end
                    and sztalia_code in ('COLL')
             ) coll on coll.pidm = pob.pidm and coll.nivel = pob.nivel  left join(
                    --Alumnos con Otras Alianzas sin Coll, Senior, Ejecutivas
                    Select matricula, pidm,nivel, count(ali) alianza
                    from (
                        Select  Distinct id_alumno matricula,
                                SGBSTDN_PIDM pidm,
                                Case When nivel = 'MS' then 'MA' Else nivel end nivel, sztalia_code Ali
                        from sztalgo
                        join REL_PROGRAMAXALUMNO p on p.REL_PROGRAMAXALUMNO_no_regla=sztalgo_no_regla
                        join goradid on goradid_pidm = SGBSTDN_PIDM
                        join sztalia on sztalia_code = goradid_adid_code
                                    and sztalia_lvel = Case When nivel = 'MS' then 'MA' Else nivel end
                                    and SZTALIA_NUM_MATERIAS > 0  --Solo Alianzas con materias
                    where sztalgo_no_regla=p_regla
                    AND p.ID_ALUMNO = P_ID
                        and sztalgo_levl_code = Case When nivel = 'MS' then 'MA' Else nivel end
                        and sztalia_code not in ('COLL','SENI','EJEC','UTLX','DUOL','CAM1','CAMB','UCV2','UCAM')
                   ) Group by matricula, pidm,nivel
             ) alia on alia.pidm = pob.pidm and alia.nivel = pob.nivel
             Where pob.matricula = NVL(p_id,pob.matricula)
            Order by matricula;

    Cursor cur_ali (p_pidm number) is
            Select  Distinct id_alumno matricula,
                    SGBSTDN_PIDM pidm,
                    Case When nivel = 'MS' then 'MA' Else nivel end nivel, sztalia_code Alianza,
                    Case When tume.pidm is null Then 'N' Else 'S' End SI,  --Revisamos si hay alguna ali activa ya en stume le damos prioridad
                    sztalia_seq seq
            from sztalgo
            join REL_PROGRAMAXALUMNO p on p.REL_PROGRAMAXALUMNO_no_regla=sztalgo_no_regla
            join goradid on goradid_pidm = SGBSTDN_PIDM
            join sztalia on sztalia_code = goradid_adid_code
                        and sztalia_lvel = Case When nivel = 'MS' then 'MA' Else nivel end
                        and SZTALIA_NUM_MATERIAS > 0  --Solo Alianzas con materias
            left join (
                        select Distinct Sztalmt_alianza ali, szstume_pidm pidm
                        from sztalmt
                        join szstume z on z.szstume_subj_code=sztalmt_materia
                        where z.szstume_pidm=p_pidm
                                 and z.szstume_rsts_code='RE'
                                 and z.SZSTUME_SEQ_NO = (Select Max(x.SZSTUME_SEQ_NO)
                                                        from SZSTUME x
                                                        where x.SZSTUME_no_regla = z.SZSTUME_no_regla
                                                        and x.SZSTUME_subj_code = z.SZSTUME_subj_code
                                                        and x.szstume_pidm = z.szstume_pidm)
                       ) tume on tume.pidm=SGBSTDN_PIDM and tume.ali=sztalia_code
            where sztalgo_no_regla=NVL(p_regla,sztalgo_no_regla)
            and sztalgo_levl_code = Case When nivel = 'MS' then 'MA' Else nivel end
            and SGBSTDN_PIDM = p_pidm
            and sztalia_code not in ('COLL','SENI','EJEC')
            ORDER BY SI desc, Seq;

    Procedure delete_alianzas_pidm (pp_regla number, pp_pidm number) is

        Begin
            Delete from sztprono d
            Where (d.sztprono_no_regla, d.sztprono_pidm, d.sztprono_materia_legal, d.sztprono_secuencia)
            in ( Select  Distinct sztalgo_no_regla,
                            SGBSTDN_PIDM pidm,
                            sztprono_materia_legal materia,
                            sztprono_secuencia
                    from sztalgo
                    join REL_PROGRAMAXALUMNO p on p.REL_PROGRAMAXALUMNO_no_regla=sztalgo_no_regla
                    join goradid on goradid_pidm = SGBSTDN_PIDM
                    join sztalia on sztalia_code = goradid_adid_code
                                and sztalia_lvel = Case When nivel = 'MS' then 'MA' Else nivel end
                                and SZTALIA_NUM_MATERIAS > 0  --Solo Alianzas con materias
                    join sztprono on sztprono_no_regla=sztalgo_no_regla
                                 and sztprono_pidm=SGBSTDN_PIDM
                    join sztalmt on sztalmt_alianza=sztalia_code
                                and sztalmt_materia=sztprono_materia_legal
                    where sztalgo_no_regla= pp_regla
                    and sztalgo_levl_code = Case When nivel = 'MS' then 'MA' Else nivel end
                    and SGBSTDN_PIDM = pp_pidm
            );


        Exception When Others Then null;
    End delete_alianzas_pidm;

BEGIN


delete from umd.tmp_alum_fin where secuencia=p_regla and matricula = Nvl(p_id,matricula);

if p_id is null Then
    begin
        p_elimina_etiqueta(p_regla,1);
        commit;
    end;
end if;


    FOR pob IN cur_pob LOOP

        --Borramos alianzas en caso de haber
        delete_alianzas_pidm(p_regla,pob.pidm);

        insert into umd.tmp_alum_fin  (secuencia, matricula,  materia_legal,prog_prono  ,mathijo,    calif, estatus) Values
                             (p_regla,pob.matricula, 'Ejecutiva:'||pob.Ejecutiva, 'Senior:'||pob.Senior, 'College:'||pob.College, pob.Alianza, to_char(sysdate,'DD/MM/YYYY HH24:MI:SS') );

        --Sí trae Ejecutivas
        if (pob.ejecutiva is not null ) Then
            if (pob.alianza is not null) Then

                if (pob.alianza >= 1) Then
                    pkg_alianzas.p_no_carrusel_pidm(p_regla,'EJEC',pob.pidm,1); ---FALTA QE SOLO ASIGNE1
                    lc_asigna   :=1;
                end if;

--                if (pob.alianza > 1) Then
--                    lc_asigna   :=1;
--                end if;

                lc_contador :=0;

                for ali in cur_ali(pob.pidm) Loop
insert into umd.tmp_alum_fin  (secuencia, matricula,  materia_legal,prog_prono  ,mathijo,    calif, estatus) Values
                     (p_regla,pob.matricula, 'Sí trae Ejecutivas-> Alianza:'||ali.alianza, 'Senior:'||pob.Senior, 'College:'||pob.College, pob.Alianza, to_char(sysdate,'DD/MM/YYYY HH24:MI:SS') );

                    if ali.alianza in ('CIFA','MUBA','UNIC','IEBS','MONU','FCBK','LEGA') Then --Seagrega LEGA junio2023@Frank
                        dbms_output.put_line('CarruselAlum:'||ali.matricula||' Alianza:'||ali.alianza||' Regla:'||p_regla);
                        pkg_alianzas.p_carrusel_pidm(p_regla,ali.alianza,ali.pidm);
                    end if;
                    if ali.alianza in ('EJEC','SENI','GADS','MICR','TABL','CLOU','CESA','COUR','COLL') Then    --SENI, COUR, CAMB, DUOL, EJEC, CLOU
                        dbms_output.put_line('NOCarruselAlum:'||ali.matricula||' Alianza:'||ali.alianza||' Regla:'||p_regla);
                        pkg_alianzas.p_no_carrusel_pidm(p_regla,ali.alianza,ali.pidm);
                    end if;
                    lc_contador:=lc_contador+1;
                    Exit When lc_asigna=lc_contador;
                End Loop;

            else
                --Solo tiene ejecutivas
                pkg_alianzas.p_no_carrusel_pidm(p_regla,'EJEC',pob.pidm);
            end if;
        end if;

        --Sí trae SENIOR
        if (pob.senior is not null ) Then
            if (pob.alianza is not null) Then

                if (pob.alianza >= 1) Then
                    pkg_alianzas.p_no_carrusel_pidm(p_regla,'SENI',pob.pidm,1); ---FALTA QE SOLO ASIGNE1
                    lc_asigna   :=1;
                end if;

--                if (pob.alianza > 1) Then
--                    lc_asigna   :=1;
--                end if;

                lc_contador :=0;

                for ali in cur_ali(pob.pidm) Loop
insert into umd.tmp_alum_fin  (secuencia, matricula,  materia_legal,prog_prono  ,mathijo,    calif, estatus) Values
                     (p_regla,pob.matricula, 'Sí trae SENIOR-> Alianza:'||ali.alianza, 'Senior:'||pob.Senior, 'College:'||pob.College, pob.Alianza, to_char(sysdate,'DD/MM/YYYY HH24:MI:SS') );

                    if ali.alianza in ('CIFA','MUBA','UNIC','IEBS','MONU','FCBK','LEGA') Then
                        dbms_output.put_line('CarruselAlum:'||ali.matricula||' Alianza:'||ali.alianza||' Regla:'||p_regla);
                        pkg_alianzas.p_carrusel_pidm(p_regla,ali.alianza,ali.pidm);
                    end if;
                    if ali.alianza in ('EJEC','SENI','GADS','MICR','TABL','CLOU','CESA','COUR','COLL') Then    --SENI, COUR, CAMB, DUOL, EJEC, CLOU
                        dbms_output.put_line('NOCarruselAlum:'||ali.matricula||' Alianza:'||ali.alianza||' Regla:'||p_regla);
                        pkg_alianzas.p_no_carrusel_pidm(p_regla,ali.alianza,ali.pidm);
                    end if;
                    lc_contador:=lc_contador+1;
                    Exit When lc_asigna=lc_contador;
                End Loop;

            else
                --Solo tiene ejecutivas
                pkg_alianzas.p_no_carrusel_pidm(p_regla,'SENI',pob.pidm);
            end if;
        end if;


        --Sí trae College
        if (pob.college is not null ) Then
            if (pob.alianza is not null) Then

                if (pob.alianza >= 1) Then
                    pkg_alianzas.p_no_carrusel_pidm(p_regla,'COLL',pob.pidm,1); ---FALTA QE SOLO ASIGNE1
                    lc_asigna   :=1;
                end if;

--                if (pob.alianza > 1) Then
--                    lc_asigna   :=1;
--                end if;

                lc_contador :=0;

                for ali in cur_ali(pob.pidm) Loop
insert into umd.tmp_alum_fin  (secuencia, matricula,  materia_legal,prog_prono  ,mathijo,    calif, estatus) Values
                     (p_regla,pob.matricula, 'Sí trae College-> Alianza:'||ali.alianza, 'Senior:'||pob.Senior, 'College:'||pob.College, pob.Alianza, to_char(sysdate,'DD/MM/YYYY HH24:MI:SS') );

                    if ali.alianza in ('CIFA','MUBA','UNIC','IEBS','MONU','FCBK','LEGA') Then

                        dbms_output.put_line('CarruselAlum:'||ali.matricula||' Alianza:'||ali.alianza||' Regla:'||p_regla);

                        pkg_alianzas.p_carrusel_pidm(p_regla,ali.alianza,ali.pidm);
                    end if;
                    if ali.alianza in ('EJEC','SENI','GADS','MICR','TABL','CLOU','CESA','COUR','COLL') Then    --SENI, COUR, CAMB, DUOL, EJEC, CLOU
                        dbms_output.put_line('NOCarruselAlum:'||ali.matricula||' Alianza:'||ali.alianza||' Regla:'||p_regla);

                        pkg_alianzas.p_no_carrusel_pidm(p_regla,ali.alianza,ali.pidm);
                    end if;
                    lc_contador:=lc_contador+1;
                    Exit When lc_asigna=lc_contador;
                End Loop;

            else
                --Solo tiene ejecutivas
                pkg_alianzas.p_no_carrusel_pidm(p_regla,'COLL',pob.pidm);
            end if;
        end if;

        --No trae NI Ejecutivas, Senior, College
        if (pob.ejecutiva is null and pob.senior is null and pob.college is null ) Then
            if (pob.alianza = 1) Then lc_asigna :=1; end if;
            if (pob.alianza > 1) Then lc_asigna :=2; end if;

insert into umd.tmp_alum_fin  (secuencia, matricula,  materia_legal,prog_prono  ,mathijo,    calif, estatus) Values
                     (p_regla,pob.matricula, 'No trae NI Ejecutivas, Senior, College-> Alianza:'||pob.alianza, 'Senior:'||pob.Senior, 'College:'||pob.College, pob.Alianza, to_char(sysdate,'DD/MM/YYYY HH24:MI:SS') );

--            if (pob.alianza > 1) Then lc_asigna :=1; end if;

            lc_contador :=0;
 dbms_output.put_line('Pidm:'||pob.pidm||' pob.alianza:'||pob.alianza);

            for ali in cur_ali(pob.pidm) Loop
insert into umd.tmp_alum_fin  (secuencia, matricula,  materia_legal,prog_prono  ,mathijo,    calif, estatus) Values
                     (p_regla,pob.matricula, 'No trae NI Ejecutivas, Senior, College-> Alianza:'||ali.alianza, 'Senior:'||pob.Senior, 'College:'||pob.College, pob.Alianza, to_char(sysdate,'DD/MM/YYYY HH24:MI:SS') );

                if ali.alianza in ('CIFA','MUBA','UNIC','IEBS','MONU','FCBK','LEGA') Then
                    dbms_output.put_line('CarruselAlum:'||ali.matricula||' Alianza:'||ali.alianza||' Regla:'||p_regla);
                    pkg_alianzas.p_carrusel_pidm(p_regla,ali.alianza,ali.pidm);
                end if;
                if ali.alianza in ('EJEC','SENI','GADS','MICR','TABL','CLOU','CESA','COUR','COLL') Then    --SENI, COUR, CAMB, DUOL, EJEC, CLOU
                    dbms_output.put_line('NOCarruselAlum:'||ali.matricula||' Alianza:'||ali.alianza||' Regla:'||p_regla);
                    pkg_alianzas.p_no_carrusel_pidm(p_regla,ali.alianza,ali.pidm);
                end if;
                lc_contador:=lc_contador+1;
                Exit When lc_asigna=lc_contador;
            End Loop;
        end if;
        
        --Frank@Modify:19-julio-2023: Se asignas las alianzas de idiomas y plataforma...
        --Alianzas que siempre se debe asignar
        for ali in cur_ali(pob.pidm) Loop

                if ali.alianza in ('UTLX','DUOL','CAM1','CAMB','UCV2','UCAM') Then    
--                if ali.alianza in ('DUOL','CAM1','CAMB') Then    
                    dbms_output.put_line('TRAE alianza por default asignar:'||ali.matricula||' Alianza:'||ali.alianza||' Regla:'||p_regla);
                    pkg_alianzas.p_no_carrusel_pidm(p_regla,ali.alianza,ali.pidm);

                    insert into umd.tmp_alum_fin  (secuencia, matricula,  materia_legal,prog_prono  ,mathijo,    calif, estatus) Values
                        (p_regla,pob.matricula, 'Sí trae idioma u otra que se asigna siempre Alianza:'||ali.alianza, 'Senior:'||pob.Senior, 
                            'College:'||pob.College, pob.Alianza, to_char(sysdate,'DD/MM/YYYY HH24:MI:SS') );
                end if;
        End Loop;        

    END LOOP;

End p_prono_ali_v2;

end pkg_alianzas;
/

DROP PUBLIC SYNONYM PKG_ALIANZAS;

CREATE OR REPLACE PUBLIC SYNONYM PKG_ALIANZAS FOR BANINST1.PKG_ALIANZAS;


GRANT EXECUTE, DEBUG ON BANINST1.PKG_ALIANZAS TO PUBLIC;
