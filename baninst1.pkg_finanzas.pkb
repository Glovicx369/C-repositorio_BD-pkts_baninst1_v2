DROP PACKAGE BODY BANINST1.PKG_FINANZAS;

CREATE OR REPLACE PACKAGE BODY BANINST1."PKG_FINANZAS" AS

PROCEDURE P_RECARGOS (p_pidm in number default null) IS

/*  SE ACTUALIZA FUNCION PARA REPLICAR STUDY, PARTE DE PERIODO Y FECHA INICION
    02/10/2019 JESUS REZA OLIVERA                   */

DIA_MES         NUMBER;
RECARGO         NUMBER;
MESES           NUMBER :=0;
TRANSACCION     NUMBER;
PERIODO         VARCHAR2(6);
VL_DESCRIPCION  VARCHAR2(30);
VL_SALVENC      NUMBER;
VL_STUDY        NUMBER;
VL_FECHA_INI    DATE;
VL_PARTEPER     VARCHAR2(5);

----------------
vl_existe number:=0;
v_moneda      varchar2(5);


CURSOR C1 IS

SELECT DISTINCT SPRIDEN_ID IDEN, TBRACCD_PIDM PIDM, TBBDETC_DCAT_CODE DCAT,
(SELECT  ZSTPARA_PARAM_VALOR FROM ZSTPARA
 WHERE ZSTPARA_MAPA_ID='INTERESES' AND ZSTPARA_PARAM_ID='PORCENTAJE' AND ZSTPARA_PARAM_DESC LIKE '%'||TBBDETC_DCAT_CODE||'%') PORCENTAJE,
(SELECT  ZSTPARA_PARAM_VALOR FROM ZSTPARA
 WHERE ZSTPARA_MAPA_ID='INTERESES' AND ZSTPARA_PARAM_ID='NUM_MESES' AND ZSTPARA_PARAM_DESC LIKE '%'||TBBDETC_DCAT_CODE||'%') MESES,
(SELECT  ZSTPARA_PARAM_VALOR FROM ZSTPARA
 WHERE ZSTPARA_MAPA_ID='INTERESES' AND ZSTPARA_PARAM_ID='NUM_DIAS' AND ZSTPARA_PARAM_DESC LIKE '%'||TBBDETC_DCAT_CODE||'%') DIAS,
(SELECT  ZSTPARA_PARAM_VALOR FROM ZSTPARA
 WHERE ZSTPARA_MAPA_ID='INTERESES' AND ZSTPARA_PARAM_ID='CON_SEMBRAR' AND ZSTPARA_PARAM_DESC LIKE '%'||TBBDETC_DCAT_CODE||'%') CONCEPTO,
 TBRACCD_TERM_CODE  PERIODO, TBRACCD_RECEIPT_NUMBER ORDEN
FROM TBRACCD, TBBDETC, SPRIDEN, ZSTPARA
WHERE TBRACCD_PIDM=SPRIDEN_PIDM AND SPRIDEN_CHANGE_IND IS NULL
AND     TBRACCD_BALANCE > 0 AND TBBDETC_DETAIL_CODE=TBRACCD_DETAIL_CODE AND TBBDETC_DCAT_CODE=ZSTPARA_PARAM_VALOR
AND     ZSTPARA_MAPA_ID='INTERESES' AND ZSTPARA_PARAM_ID='CATEGORIA'
AND TBRACCD_EFFECTIVE_DATE < TRUNC(SYSDATE)
AND TBRACCD_EFFECTIVE_DATE >= TRUNC(SYSDATE-90)
AND SUBSTR(TBRACCD_DETAIL_CODE,3,2) NOT IN (SELECT ZSTPARA_PARAM_VALOR
                                    FROM ZSTPARA
                                    WHERE 1=1
                                    AND ZSTPARA_MAPA_ID='INTERESES'
                                    AND ZSTPARA_PARAM_ID = ('CODIGO'))
and substr(spriden_id,1,2)not in(select ZSTPARA_PARAM_VALOR
                            from ZSTPARA
                            where 1=1
                            and ZSTPARA_MAPA_ID='SIN_INTERESES')
/*and tbraccd_detail_code not in (select ZSTPARA_PARAM_VALOR
                                    from ZSTPARA
                                    where 1=1
                                    and zstpara_mapa_id='INTERES_EXC'
                                    ) */
AND SPRIDEN_PIDM NOT IN (SELECT GORADID_PIDM
                        FROM GORADID
                        WHERE 1=1
                        AND GORADID_ADID_CODE = 'RECU'
                        AND GORADID_PIDM = SPRIDEN_PIDM)
AND SUBSTR(SPRIDEN_ID,1,2) not IN  ('47','48','49','50', '55')
and spriden_pidm  = nvl (p_pidm, spriden_pidm)
UNION
SELECT DISTINCT SPRIDEN_ID IDEN, TBRACCD_PIDM PIDM, TBBDETC_DETAIL_CODE DCAT,
        (SELECT  ZSTPARA_PARAM_VALOR FROM ZSTPARA
         WHERE ZSTPARA_MAPA_ID='INTERESES' AND ZSTPARA_PARAM_ID='PORCENTAJE' AND ZSTPARA_PARAM_DESC LIKE '%'||SUBSTR(TBBDETC_DETAIL_CODE,3,2)) PORCENTAJE,
        (SELECT  ZSTPARA_PARAM_VALOR FROM ZSTPARA
         WHERE ZSTPARA_MAPA_ID='INTERESES' AND ZSTPARA_PARAM_ID='NUM_MESES' AND ZSTPARA_PARAM_DESC LIKE '%'||SUBSTR(TBBDETC_DETAIL_CODE,3,2)) MESES,
        (SELECT  ZSTPARA_PARAM_VALOR FROM ZSTPARA
         WHERE ZSTPARA_MAPA_ID='INTERESES' AND ZSTPARA_PARAM_ID='NUM_DIAS' AND ZSTPARA_PARAM_DESC LIKE '%'||SUBSTR(TBBDETC_DETAIL_CODE,3,2)) DIAS,
        (SELECT  ZSTPARA_PARAM_VALOR FROM ZSTPARA
         WHERE ZSTPARA_MAPA_ID='INTERESES' AND ZSTPARA_PARAM_ID='CON_SEMBRAR' AND ZSTPARA_PARAM_DESC LIKE '%'||SUBSTR(TBBDETC_DETAIL_CODE,3,2)) CONCEPTO,
          TBRACCD_TERM_CODE PERIODO, TBRACCD_RECEIPT_NUMBER ORDEN
FROM TBRACCD, TBBDETC, SPRIDEN, ZSTPARA
WHERE TBRACCD_PIDM=SPRIDEN_PIDM
AND SPRIDEN_CHANGE_IND IS NULL
AND TBRACCD_BALANCE > 0
AND TBBDETC_DETAIL_CODE=TBRACCD_DETAIL_CODE
AND SUBSTR(TBBDETC_DETAIL_CODE,3,2)=ZSTPARA_PARAM_VALOR
AND ZSTPARA_MAPA_ID='INTERESES'
AND ZSTPARA_PARAM_ID = ('CODIGO')
AND TBRACCD_EFFECTIVE_DATE < TRUNC(SYSDATE)
AND TBRACCD_EFFECTIVE_DATE >= TRUNC(SYSDATE-90)
and substr(spriden_id,1,2)not in(select ZSTPARA_PARAM_VALOR
                            from ZSTPARA
                            where 1=1
                            and ZSTPARA_MAPA_ID='SIN_INTERESES')
/*and tbraccd_detail_code not in (select ZSTPARA_PARAM_VALOR
                                    from ZSTPARA
                                    where 1=1
                                    and zstpara_mapa_id='INTERES_EXC'
                                    )*/
AND SPRIDEN_PIDM NOT IN (SELECT GORADID_PIDM
                        FROM GORADID
                        WHERE 1=1
                        AND GORADID_ADID_CODE = 'RECU'
                        AND GORADID_PIDM = SPRIDEN_PIDM)
AND SUBSTR(SPRIDEN_ID,1,2) IN  ('47','48','49','50', '55')
and spriden_pidm  = nvl (p_pidm, spriden_pidm)
ORDER BY IDEN;



CURSOR W1(PIDM NUMBER, DCAT VARCHAR2, PORC DECIMAL,MESES NUMBER, DIAS NUMBER, CONCEPTO VARCHAR2, DIA_MES NUMBER)   IS
SELECT TBBDETC_DESC CODIGO, SUM(TBRACCD_BALANCE) IMPORTE,TBRACCD_EFFECTIVE_DATE FECHA
FROM TBRACCD A, TBBDETC
WHERE A.TBRACCD_PIDM= PIDM
AND A.TBRACCD_BALANCE > 0 AND TBRACCD_DETAIL_CODE=TBBDETC_DETAIL_CODE
AND (TBBDETC_DCAT_CODE=DCAT
     AND SUBSTR(TBBDETC_DETAIL_CODE,3,2) NOT IN (SELECT ZSTPARA_PARAM_VALOR
                                                 FROM ZSTPARA
                                                 WHERE 1=1
                                                 AND ZSTPARA_MAPA_ID='INTERESES'
                                                 AND ZSTPARA_PARAM_ID = 'CODIGO')
      OR
      TBBDETC_DETAIL_CODE =DCAT)
AND (SELECT EXTRACT (MONTH FROM TRUNC(TBRACCD_EFFECTIVE_DATE)) FROM DUAL) >=(SELECT DECODE (EXTRACT (MONTH FROM(ADD_MONTHS(TRUNC(SYSDATE)-(DIA_MES),-MESES))),12,1,(EXTRACT (MONTH FROM(ADD_MONTHS(TRUNC(SYSDATE)-(DIA_MES),-MESES)))))FROM DUAL)
AND (SELECT EXTRACT (YEAR FROM TRUNC(TBRACCD_EFFECTIVE_DATE)) FROM DUAL) >= (SELECT EXTRACT (YEAR FROM(ADD_MONTHS(TRUNC(SYSDATE)-(DIA_MES),-MESES)))FROM DUAL)
AND TRUNC(A.TBRACCD_EFFECTIVE_DATE)+DIAS + NVL((SELECT  ZSTPARA_PARAM_VALOR - TO_NUMBER(TO_CHAR(A.TBRACCD_EFFECTIVE_DATE,'DD'))
                                                  FROM ZSTPARA
                                                 WHERE     ZSTPARA_MAPA_ID = 'INTERES_VIG'
                                                       AND SUBSTR(ZSTPARA_PARAM_ID,1,2) = SUBSTR(A.TBRACCD_TERM_CODE,1,2)
                                                       AND TO_NUMBER(ZSTPARA_PARAM_DESC) = TO_NUMBER(TO_CHAR(A.TBRACCD_EFFECTIVE_DATE,'DD'))),0) < TRUNC(SYSDATE)
AND TRUNC(A.TBRACCD_EFFECTIVE_DATE)+DIAS + NVL((SELECT  ZSTPARA_PARAM_VALOR - TO_NUMBER(TO_CHAR(A.TBRACCD_EFFECTIVE_DATE,'DD'))
                                                  FROM ZSTPARA
                                                 WHERE     ZSTPARA_MAPA_ID = 'INTERES_VIG'
                                                       AND SUBSTR(ZSTPARA_PARAM_ID,1,2) = SUBSTR(A.TBRACCD_TERM_CODE,1,2)
                                                       AND TO_NUMBER(ZSTPARA_PARAM_DESC) = TO_NUMBER(TO_CHAR(A.TBRACCD_EFFECTIVE_DATE,'DD'))),0) >= TRUNC(SYSDATE-90)
AND A.TBRACCD_PIDM NOT IN (SELECT DISTINCT TBRACCD_PIDM
                             FROM TBRACCD
                            WHERE     TBRACCD_PIDM = A.TBRACCD_PIDM
                                  AND TBRACCD_DETAIL_CODE LIKE '%X2'
                                  AND TBRACCD_EFFECTIVE_DATE >=
                                      CASE (SELECT COUNT(DISTINCT ZSTPARA_PARAM_ID) FROM ZSTPARA WHERE ZSTPARA_MAPA_ID = 'INTERES_VIG' AND SUBSTR(ZSTPARA_PARAM_ID,1,2) = SUBSTR(A.TBRACCD_DETAIL_CODE,1,2))
                                        WHEN 1 THEN LAST_DAY(TRUNC(A.TBRACCD_EFFECTIVE_DATE))+1
                                        WHEN 0 THEN TRUNC(A.TBRACCD_EFFECTIVE_DATE)+5
                                      END )
AND A.TBRACCD_TRAN_NUMBER NOT IN ( SELECT TZTINTE_TRAN_NUMBER
                                     FROM TZTINTE
                                    WHERE    TZTINTE_PIDM = TBRACCD_PIDM
                                         AND TZTINTE_TRAN_NUMBER = TBRACCD_TRAN_NUMBER)
GROUP BY TBBDETC_DESC,TBRACCD_EFFECTIVE_DATE;



CURSOR Z1(PIDM NUMBER, DCAT VARCHAR2, PORC DECIMAL,MESES NUMBER, DIAS NUMBER, CONCEPTO VARCHAR2, DIA_MES NUMBER)   IS
SELECT TBRACCD_TRAN_NUMBER TRAN, TBRACCD_BALANCE IMPORTE, TBRACCD_EFFECTIVE_DATE FECHA
FROM TBRACCD A, TBBDETC
WHERE A.TBRACCD_PIDM=PIDM AND TBRACCD_BALANCE > 0
AND A.TBRACCD_DETAIL_CODE=TBBDETC_DETAIL_CODE
AND (TBBDETC_DCAT_CODE=DCAT
     AND SUBSTR(TBBDETC_DETAIL_CODE,3,2) NOT IN (SELECT ZSTPARA_PARAM_VALOR
                                                 FROM ZSTPARA
                                                 WHERE 1=1
                                                 AND ZSTPARA_MAPA_ID='INTERESES'
                                                 AND ZSTPARA_PARAM_ID = 'CODIGO')
      OR
      TBBDETC_DETAIL_CODE =DCAT)
AND (SELECT EXTRACT (MONTH FROM TRUNC(A.TBRACCD_EFFECTIVE_DATE)) FROM DUAL) >=(SELECT DECODE (EXTRACT (MONTH FROM(ADD_MONTHS(TRUNC(SYSDATE)-(DIA_MES),-MESES))),12,1,(EXTRACT (MONTH FROM(ADD_MONTHS(TRUNC(SYSDATE)-(DIA_MES),-MESES)))))FROM DUAL)
AND (SELECT EXTRACT (YEAR FROM TRUNC(A.TBRACCD_EFFECTIVE_DATE)) FROM DUAL) >= (SELECT EXTRACT (YEAR FROM(ADD_MONTHS(TRUNC(SYSDATE)-(DIA_MES),-MESES)))FROM DUAL)
AND TRUNC(A.TBRACCD_EFFECTIVE_DATE)+DIAS + NVL((SELECT  ZSTPARA_PARAM_VALOR - TO_NUMBER(TO_CHAR(A.TBRACCD_EFFECTIVE_DATE,'DD'))
                                                  FROM ZSTPARA
                                                 WHERE     ZSTPARA_MAPA_ID = 'INTERES_VIG'
                                                       AND SUBSTR(ZSTPARA_PARAM_ID,1,2) = SUBSTR(A.TBRACCD_TERM_CODE,1,2)
                                                       AND TO_NUMBER(ZSTPARA_PARAM_DESC) = TO_NUMBER(TO_CHAR(A.TBRACCD_EFFECTIVE_DATE,'DD'))),0) < TRUNC(SYSDATE)
AND TRUNC(A.TBRACCD_EFFECTIVE_DATE)+DIAS + NVL((SELECT  ZSTPARA_PARAM_VALOR - TO_NUMBER(TO_CHAR(A.TBRACCD_EFFECTIVE_DATE,'DD'))
                                                  FROM ZSTPARA
                                                 WHERE     ZSTPARA_MAPA_ID = 'INTERES_VIG'
                                                       AND SUBSTR(ZSTPARA_PARAM_ID,1,2) = SUBSTR(A.TBRACCD_TERM_CODE,1,2)
                                                       AND TO_NUMBER(ZSTPARA_PARAM_DESC) = TO_NUMBER(TO_CHAR(A.TBRACCD_EFFECTIVE_DATE,'DD'))),0) >= TRUNC(SYSDATE-90)
AND A.TBRACCD_TRAN_NUMBER NOT IN ( SELECT TZTINTE_TRAN_NUMBER
                                     FROM TZTINTE
                                    WHERE     TZTINTE_PIDM = TBRACCD_PIDM
                                          AND TZTINTE_TRAN_NUMBER = TBRACCD_TRAN_NUMBER);


BEGIN

FOR C IN C1 LOOP

      --DBMS_OUTPUT.PUT_LINE('pidm:'||c.pidm||' categoria:'||c.dcat||'*'||c.concepto);
      SELECT TO_NUMBER(TO_CHAR(SYSDATE,'dd')) INTO DIA_MES FROM DUAL;

    BEGIN

      SELECT TBBDETC_DESC
        INTO VL_DESCRIPCION
        FROM TBBDETC
       WHERE TBBDETC_DETAIL_CODE = SUBSTR(C.IDEN,1,2)||C.CONCEPTO;

    EXCEPTION
    WHEN OTHERS THEN
       VL_DESCRIPCION := 'N/A';

    END;

    BEGIN
      SELECT SUM(D.TBRACCD_BALANCE)
        INTO VL_SALVENC
        FROM TBRACCD D
       WHERE      1=1
              AND TRUNC(D.TBRACCD_EFFECTIVE_DATE)<=TRUNC(SYSDATE)
              AND D.TBRACCD_PIDM= C.PIDM ;

    EXCEPTION
    WHEN OTHERS THEN
    VL_SALVENC:= 0;
    END;

    IF C.MESES=99 THEN
         MESES:=1000;
    ELSE
         MESES:=C.MESES;
    END IF;

    IF VL_SALVENC>0 THEN

       FOR W IN W1(C.PIDM, C.DCAT , C.PORCENTAJE ,C.MESES , C.DIAS, C.CONCEPTO , DIA_MES) LOOP
               RECARGO:=ROUND(W.IMPORTE*(C.PORCENTAJE/100));
               IF RECARGO > 0 THEN

               --------------------- Valido que no exista un cargo de intereses en el mes para el alumno ---------------------------
                    vl_existe :=0;
                    Begin

                        Select count(*)
                         Into vl_existe
                        from tbraccd
                        where 1=1
                        and tbraccd_pidm = c.PIDM
                        And tbraccd_detail_code = SUBSTR(C.IDEN,1,2)||C.CONCEPTO
                        And TBRACCD_EFFECTIVE_DATE between TRUNC(SYSDATE, 'MM') and LAST_DAY(TRUNC(SYSDATE)); 
                    Exception
                        When Others then 
                         vl_existe:=0;
                    end;

                    If vl_existe = 0 then  ---> Haga el Insert del cargo en el estado de cuenta 

                       Begin

                            SELECT MAX(TBRACCD_TRAN_NUMBER) +1 
                                INTO TRANSACCION
                            FROM TBRACCD
                            WHERE TBRACCD_PIDM=C.PIDM;                       
                       Exception
                        When Others then 
                            TRANSACCION :=1;
                       End;

                       Begin

                           SELECT FGET_PERIODO_GENERAL(SUBSTR(C.IDEN,1,2)) 
                            INTO PERIODO 
                           FROM DUAL;
                       Exception
                        When Others then
                            null;
                       End;

                        Begin
                                SELECT TVRDCTX_CURR_CODE
                                    INTO v_moneda
                                FROM TAISMGR.TVRDCTX
                                WHERE TVRDCTX_DETC_CODE  = SUBSTR(C.IDEN,1,2)||C.CONCEPTO;
                        Exception
                        When Others then
                        v_moneda  := 'MXN';
                        End;



                       IF TRUNC (w.fecha)>'01/01/2020' then
                                    Begin

                                           INSERT INTO TBRACCD VALUES(C.PIDM, TRANSACCION, C.PERIODO, SUBSTR(C.IDEN,1,2)||C.CONCEPTO, USER, SYSDATE, RECARGO, RECARGO, SYSDATE, NULL, NULL, VL_DESCRIPCION, C.ORDEN, NULL, NULL, NULL, NULL, 'T', 'Y', SYSDATE, 0,NULL, NULL, NULL, NULL, NULL,NULL, NULL, NULL,
                                            SYSDATE, NULL, NULL, NULL, NULL, v_moneda, NULL, NULL, NULL, NULL, NULL,NULL, NULL, NULL, NULL, NULL,NULL, NULL, NULL, NULL, NULL,NULL, NULL, NULL, 'INTERES', 'Banner', NULL, NULL, NULL, NULL, NULL,NULL, USER, NULL);
                                 Exception
                                    When Others then
                                         null;
                                         --dbms_output.put_line('Error en pidm:'||c.pidm||' categoria:'||c.dcat||'*'|| SUBSTR(C.IDEN,1,2)||C.CONCEPTO);
                                 End;

                       end if;

                    End if;

               END IF;

       END LOOP;

       RECARGO:=0;

       FOR Z IN Z1(C.PIDM, C.DCAT , C.PORCENTAJE ,C.MESES , C.DIAS, C.CONCEPTO , DIA_MES) LOOP

          RECARGO:=ROUND(Z.IMPORTE*(C.PORCENTAJE/100));
               --dbms_output.put_line('pidm:'||c.pidm||' tran:'||z.tran);
          IF RECARGO > 0 THEN

             IF Z.fecha > '01/01/2020' then

                -------------------- Valido que no este el registro en la bitacora ---------------------------------
                vl_existe:=0;
                Begin
                    Select count(*)
                        Into vl_existe
                    from TZTINTE
                    Where TZTINTE_PIDM = c.PIDM
                    And TZTINTE_EFFECTIVE_DATE between TRUNC(SYSDATE, 'MM') and LAST_DAY(TRUNC(SYSDATE)); 
                Exception
                    When others then 
                     vl_existe:=0;

                End;

                If vl_existe = 0 then 

                        Begin
                            INSERT INTO TZTINTE VALUES(C.PIDM, Z.TRAN, Z.IMPORTE, Z.FECHA, RECARGO,TO_NUMBER(TO_CHAR(SYSDATE,'mm')),TO_NUMBER(TO_CHAR(SYSDATE,'yyyy')) , SYSDATE, USER);

                        Exception
                            When Others then 
                                null;
                        End;

                        BEGIN

                          SELECT DISTINCT TBRACCD_STSP_KEY_SEQUENCE,TBRACCD_FEED_DATE,TBRACCD_PERIOD
                            INTO VL_STUDY,VL_FECHA_INI,VL_PARTEPER
                            FROM  TBRACCD
                                WHERE 1=1
                                AND TBRACCD_PERIOD IS NOT NULL
                                AND TBRACCD_PIDM=C.PIDM
                                AND TBRACCD_TRAN_NUMBER = Z.TRAN;
                        EXCEPTION
                        WHEN OTHERS THEN
                        VL_STUDY:=NULL;
                        VL_FECHA_INI:=NULL;
                        VL_PARTEPER:=NULL;
                        END;


                        BEGIN
                             UPDATE TBRACCD
                                SET TBRACCD_STSP_KEY_SEQUENCE=VL_STUDY,
                                    TBRACCD_FEED_DATE=VL_FECHA_INI,
                                    TBRACCD_PERIOD=VL_PARTEPER
                                WHERE 1=1
                                AND TBRACCD_PIDM=C.PIDM
                                AND TBRACCD_TRAN_NUMBER = TRANSACCION;
                        Exception
                           When Others then 
                            null;
                        End;

                        Begin
                             UPDATE TVRACCD
                                SET TVRACCD_STSP_KEY_SEQUENCE=VL_STUDY,
                                    TVRACCD_FEED_DATE=VL_FECHA_INI,
                                    TVRACCD_PERIOD=VL_PARTEPER
                                WHERE 1=1
                                AND TVRACCD_PIDM=C.PIDM
                                AND TVRACCD_ACCD_TRAN_NUMBER = TRANSACCION;

                        EXCEPTION
                            WHEN OTHERS THEN
                            NULL;
                        END;

                End If; --- Existe

            END IF;  ---- Fecha

          END IF;  ---- Recargos

       END LOOP;

    END IF;

END LOOP;

COMMIT;

END P_RECARGOS;
--
--
Procedure P_INCREMENTO_ANUAL(P_FECHA DATE, p_id_aumento IN out varchar2)  Is


VL_TZCARRE NUMBER;
VL_TZDOCTR NUMBER;
VL_ERROR VARCHAR2(500);
vl_porcentaje number:=0;
--Decrecientes ESIN
ln_count NUMBER(19);
BEGIN


    FOR ALUMNO IN (

                    SELECT CAMP,
                           NIVEL,
                           ID,
                           PIDM,
                           PROGRAMA,
                           RATE,
                           STUDY,
                           FECHA_MATE,
                           FECHA_CXC,
                           FECHA_INICIO,
                            NVL( CASE
                                WHEN nvl (x.MESES,1) < 0 THEN 1
                                WHEN nvl (x.MESES,1) > 0 THEN nvl (x.MESES,1)
                           END,1)meses,
                           PKG_FINANZAS.F_MONTO_INCREMENTO(CAMP,NIVEL,NVL( CASE
                                                                                                                    WHEN nvl (x.MESES,1) < 0 THEN 1
                                                                                                                    WHEN nvl (x.MESES,1) > 0 THEN nvl (x.MESES,1)
                                                                                                               END,1), FECHA_MATE) PORCENTAJE,
                           PKG_FINANZAS.F_TIPO_INCREMENTO(CAMP,NIVEL,NVL( CASE
                                                                                                                    WHEN nvl (x.MESES,1) < 0 THEN 1
                                                                                                                    WHEN nvl (x.MESES,1) > 0 THEN nvl (x.MESES,1)
                                                                                                               END,1), FECHA_MATE) Acumula,
                          PKG_FINANZAS.F_FECHA_INCREMENTO(CAMP,NIVEL,NVL( CASE
                                                                                                                    WHEN nvl (x.MESES,1) < 0 THEN 1
                                                                                                                    WHEN nvl (x.MESES,1) > 0 THEN nvl (x.MESES,1)
                                                                                                               END,1), FECHA_MATE) Fecha_Vence,
                          PKG_FINANZAS.F_PORC_INCREMENTO(PIDM, PROGRAMA,FECHA_INICIO) Acumulado,
                          PKG_FINANZAS.F_NUM_INCREMENTO(PIDM, PROGRAMA,FECHA_INICIO) Numero_Incr,
                          PKG_FINANZAS.F_MES_INCREMENTO(CAMP,NIVEL,NVL( CASE
                                                                                                                WHEN nvl (x.MESES,1) < 0 THEN 1
                                                                                                                WHEN nvl (x.MESES,1) > 0 THEN nvl (x.MESES,1)
                                                                                                           END,1), FECHA_MATE) Vigencia,
                         round ( NVL( CASE
                                WHEN nvl (x.MESES,1) < 0 THEN 1
                                WHEN nvl (x.MESES,1) > 0 THEN nvl (x.MESES,1)
                           END,0)/PKG_FINANZAS.F_NUM_INCREMENTO(PIDM, PROGRAMA,FECHA_INICIO))  Multip,
                           PKG_FINANZAS.F_NUM_MESES (PIDM, PROGRAMA,FECHA_INICIO) Meses_nuevos,
                           PKG_FINANZAS.F_NUM_MINIMO(CAMP,NIVEL,FECHA_MATE) Minimo,
                            PKG_FINANZAS.F_PORC_MINIMO(CAMP,NIVEL,FECHA_MATE) Porc_Minimo,
                            PKG_FINANZAS.f_exite_puni(PIDM) Puni
                    FROM(
                    SELECT CAMP,
                           NIVEL,
                           ID,
                           PIDM,
                           PROGRAMA,
                           RATE,
                           STUDY,
                           FECHA_MATE,
                           FECHA_CXC,
                           FECHA_INICIO,
                           (CASE
                                 WHEN FECHA_CXC IS NOT NULL THEN (SELECT ROUND(MONTHS_BETWEEN(TO_DATE(FECHA_INICIO),TO_DATE(FECHA_CXC)))FROM DUAL)
                                 WHEN FECHA_CXC IS NULL THEN (SELECT ROUND(MONTHS_BETWEEN(TO_DATE(FECHA_INICIO),TO_DATE(FECHA_MATE)))FROM DUAL)
                           END) MESES
                    FROM (
                    SELECT DISTINCT
                           SORLCUR_CAMP_CODE CAMP,
                           SORLCUR_LEVL_CODE NIVEL,
                           SORLCUR_PROGRAM PROGRAMA,
                           SPRIDEN_ID ID,
                           SFRSTCR_PIDM PIDM,
                           SPRIDEN_FIRST_NAME||' '||SPRIDEN_LAST_NAME ALUMNO,
                           (SELECT TO_DATE(TRUNC(MIN (SSBSECT_PTRM_START_DATE+12),'MONTH'))
                            FROM SFRSTCR F1,SSBSECT T1
                            WHERE SFRSTCR_CRN = SSBSECT_CRN
                            AND SFRSTCR_TERM_CODE = SSBSECT_TERM_CODE
                            AND SFRSTCR_PTRM_CODE = SSBSECT_PTRM_CODE
                            AND SFRSTCR_PIDM = CUR.SORLCUR_PIDM
                            AND SFRSTCR_STSP_KEY_SEQUENCE = CUR.SORLCUR_KEY_SEQNO
                            AND (SFRSTCR_DATA_ORIGIN != 'CONVALIDACION' OR SFRSTCR_DATA_ORIGIN IS NULL)
                            AND (SFRSTCR_DATA_ORIGIN != 'EXCLUIR' OR SFRSTCR_DATA_ORIGIN IS NULL)
                            AND SUBSTR(F1.SFRSTCR_TERM_CODE,5,1) NOT IN (8,9)
                            AND SFRSTCR_RSTS_CODE = 'RE')FECHA_MATE,
                           (SELECT MAX(TZTINCR_START_DATE)
                            FROM TZTINCR
                            WHERE TZTINCR_PIDM = CUR.SORLCUR_PIDM
                            AND TZTINCR_STUDY = CUR.SORLCUR_KEY_SEQNO)FECHA_CXC,
                           SORLCUR_START_DATE FECHA_INICIO,
                           SORLCUR_KEY_SEQNO STUDY,
                           SORLCUR_RATE_CODE RATE
                    FROM SFRSTCR HST,
                         SORLCUR CUR,
                         SPRIDEN
                    WHERE 1 = 1
                    AND HST.SFRSTCR_PIDM=CUR.SORLCUR_PIDM
                    AND SPRIDEN_PIDM = SORLCUR_PIDM
                    AND SPRIDEN_CHANGE_IND IS NULL
                    AND SPRIDEN_ID = NVL(p_id_aumento,SPRIDEN_ID)
                    AND CUR.SORLCUR_LMOD_CODE = 'LEARNER'
                    AND CUR.SORLCUR_ROLL_IND  = 'Y'
                    AND CUR.SORLCUR_CACT_CODE = 'ACTIVE'
                    AND CUR.SORLCUR_SEQNO = (SELECT MAX(CUR2.SORLCUR_SEQNO)
                                              FROM SORLCUR CUR2
                                              WHERE 1 = 1
                                              AND CUR2.SORLCUR_PIDM=CUR.SORLCUR_PIDM
                                              AND CUR2.SORLCUR_LMOD_CODE = CUR.SORLCUR_LMOD_CODE
                                              AND CUR2.SORLCUR_ROLL_IND = CUR.SORLCUR_ROLL_IND
                                              AND CUR2.SORLCUR_CACT_CODE = CUR.SORLCUR_CACT_CODE)
                    AND CUR.SORLCUR_KEY_SEQNO = HST.SFRSTCR_STSP_KEY_SEQUENCE
                    AND HST.SFRSTCR_RSTS_CODE = 'RE'
                    AND SPRIDEN_PIDM NOT IN (SELECT TBRACCD_PIDM
                                                FROM TBRACCD CCD
                                               WHERE     CCD.TBRACCD_PIDM = CUR.SORLCUR_PIDM
                                                     AND SUBSTR(CCD.TBRACCD_DETAIL_CODE,3,2) IN ('RM','RN','RP')
                                                     AND CCD.TBRACCD_STSP_KEY_SEQUENCE = CUR.SORLCUR_KEY_SEQNO)
                    AND (HST.SFRSTCR_DATA_ORIGIN != 'CONVALIDACION' OR HST.SFRSTCR_DATA_ORIGIN IS NULL)
                    AND (HST.SFRSTCR_DATA_ORIGIN != 'EXCLUIR' OR HST.SFRSTCR_DATA_ORIGIN IS NULL)
--                    AND SORLCUR_CAMP_CODE||SORLCUR_LEVL_CODE IN ( SELECT ZSTPARA_PARAM_ID
--                                                                    FROM ZSTPARA
--                                                                    WHERE ZSTPARA_MAPA_ID = 'INC_COLE')
                    AND CUR.SORLCUR_START_DATE = P_FECHA
                    AND CUR.SORLCUR_PIDM NOT IN (SELECT GORADID_PIDM
                                             FROM GORADID
                                             WHERE GORADID_ADID_CODE in ('INBE','INBC'))
                    )ALUMNO
                    WHERE 1=1)X
                    WHERE 1=1
     )LOOP
---Validacion Decrecientes ESIN
  SELECT COUNT(1)
    INTO ln_count
    FROM GORADID WHERE GORADID_PIDM =ALUMNO.PIDM AND  GORADID_ADID_CODE ='ESIN';

   IF ln_count = 0 THEN
--


       If alumno.Acumula = 'S' then
            vl_porcentaje := alumno.porcentaje + alumno.ACUMULADO;
       End if;

       If alumno.meses_nuevos >= alumno.Minimo then
                vl_porcentaje:= ALUMNO.PORCENTAJE;
       Elsif alumno.meses_nuevos < alumno.Minimo and alumno.acumulado > 0  then
                 vl_porcentaje:= ALUMNO.acumulado;
       Elsif alumno.meses >= alumno.vigencia and alumno.acumulado = 0 and alumno.meses_nuevos < alumno.minimo and alumno.porcentaje >0 then
         vl_porcentaje:= ALUMNO.Porc_Minimo;
       Else
           vl_porcentaje:=0;
       END IF;

       If alumno.puni >= 1 then
            If alumno.meses between 0 and 11 then
                vl_porcentaje:= 0;
            Elsif alumno.meses between 12 and 23 then
                vl_porcentaje:= 5;
            Elsif alumno.meses between 24 and 100 then
                vl_porcentaje:= 10;
            End if;
       End if;


       IF vl_porcentaje != 0 THEN

            FOR X IN (

                        SELECT DISTINCT
                                SORLCUR_PIDM PIDM,
                                SORLCUR_KEY_SEQNO STUDY,
                                SORLCUR_PROGRAM PROGRAMA,
                                SORLCUR_RATE_CODE RATE,
                                SORLCUR_CAMP_CODE CAMPUS,
                                SORLCUR_START_DATE,
                                SORLCUR_LEVL_CODE NIVEL,
                                SFRSTCR_TERM_CODE PERIODO,
                                SFRSTCR_PTRM_CODE PPARTE,
                                SSBSECT_PTRM_START_DATE FECHA,
                                (SELECT A.SGBSTDN_STST_CODE
                                FROM SGBSTDN A
                                WHERE A.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(SGBSTDN_TERM_CODE_EFF)
                                                                FROM SGBSTDN
                                                                WHERE SGBSTDN_PIDM = A.SGBSTDN_PIDM)
                                AND A.SGBSTDN_PIDM = A.SORLCUR_PIDM)STST_CODE,
                                (SELECT A.SGBSTDN_STYP_CODE
                                FROM SGBSTDN A
                                WHERE A.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(SGBSTDN_TERM_CODE_EFF)
                                                                FROM SGBSTDN
                                                                WHERE SGBSTDN_PIDM = A.SGBSTDN_PIDM)
                                AND A.SGBSTDN_PIDM = A.SORLCUR_PIDM)TIPO
                        FROM SORLCUR A, SFRSTCR F, SSBSECT G, SZTDTEC E
                        WHERE 1 = 1
                        AND A.SORLCUR_LMOD_CODE = 'LEARNER'
                        AND A.SORLCUR_ROLL_IND  = 'Y'
                        AND A.SORLCUR_CACT_CODE = 'ACTIVE'
                        AND A.SORLCUR_SEQNO IN (SELECT MAX (A1.SORLCUR_SEQNO)
                                               FROM SORLCUR A1
                                               WHERE A1.SORLCUR_PIDM = A.SORLCUR_PIDM
                                               AND A1.SORLCUR_ROLL_IND  = A.SORLCUR_ROLL_IND
                                               AND A1.SORLCUR_CACT_CODE = A.SORLCUR_CACT_CODE
                                               AND A1.SORLCUR_PROGRAM = A.SORLCUR_PROGRAM
                                               AND A1.SORLCUR_LMOD_CODE = A.SORLCUR_LMOD_CODE)
                        AND A.SORLCUR_TERM_CODE_CTLG = E.SZTDTEC_TERM_CODE
                        AND F.SFRSTCR_PIDM = A.SORLCUR_PIDM
                        --AND F.SFRSTCR_RSTS_CODE = 'RE'
                        AND F.SFRSTCR_STSP_KEY_SEQUENCE = A.SORLCUR_KEY_SEQNO
                        AND F.SFRSTCR_TERM_CODE = G.SSBSECT_TERM_CODE
                        AND SUBSTR(F.SFRSTCR_TERM_CODE,5,1) NOT IN (8,9)
                        AND (F.SFRSTCR_RESERVED_KEY != 'M1HB401' OR SFRSTCR_RESERVED_KEY IS NULL )
                        AND (F.SFRSTCR_DATA_ORIGIN != 'CONVALIDACION' OR F.SFRSTCR_DATA_ORIGIN IS NULL)
                        AND (F.SFRSTCR_DATA_ORIGIN != 'EXCLUIR' OR SFRSTCR_DATA_ORIGIN IS NULL)
                        AND F.SFRSTCR_CRN = G.SSBSECT_CRN
                        AND F.SFRSTCR_PTRM_CODE = G.SSBSECT_PTRM_CODE
                        AND TRUNC (G.SSBSECT_PTRM_START_DATE) = ALUMNO.FECHA_INICIO
                        AND A.SORLCUR_PIDM = ALUMNO.PIDM
            )LOOP


                VL_TZCARRE:= NULL;
                VL_TZDOCTR:= NULL;

                BEGIN

                    SELECT COUNT(*)
                    INTO VL_TZDOCTR
                    FROM TZDOCTR
                    WHERE TZDOCTR_PIDM = X.PIDM
                    AND TZDOCTR_PROGRAM = X.PROGRAMA
                    AND TZDOCTR_TERM_CODE = X.PERIODO
                    AND TZDOCTR_START_DATE = X.FECHA
                    AND TZDOCTR_TIPO_PROC = 'AUME'
                    ;

                EXCEPTION
                WHEN OTHERS THEN
                VL_TZDOCTR:=0;
                END;


                IF VL_TZDOCTR = 0 THEN

                    BEGIN
                          INSERT INTO  TZDOCTR
                                      (TZDOCTR_PIDM,
                                       TZDOCTR_PROGRAM,
                                       TZDOCTR_STST_CODE,
                                       TZDOCTR_STYP_CODE,
                                       TZDOCTR_CAMP_CODE,
                                       TZDOCTR_LEVL_CODE,
                                       TZDOCTR_TERM_CODE,
                                       TZDOCTR_START_DATE,
                                       TZDOCTR_PTRM_CODE,
                                       TZDOCTR_STUDY_PATH,
                                       FECHA_PROCESO,
                                       TZDOCTR_ID,
                                       TZDOCTR_TIPO_PROC,
                                       TZDOCTR_DESCUENTO,
                                       TZDOCTR_PERIODOS_CURSADOS,
                                       TZDOCTR_PORC_INCREM)
                          VALUES (
                                  X.PIDM,
                                  X.PROGRAMA,
                                  X.STST_CODE,
                                  X.TIPO,
                                  ALUMNO.CAMP,
                                  ALUMNO.NIVEL,
                                  X.PERIODO,
                                  X.FECHA,
                                  X.PPARTE,
                                  X.STUDY,
                                  SYSDATE,
                                  ALUMNO.ID,
                                  'AUME',
                                  0,
                                  ALUMNO.MESES,
                                  vl_porcentaje
                                  );


                    EXCEPTION
                    WHEN OTHERS THEN
                    VL_ERROR:=('Error 1 TZDOCTR '|| ALUMNO.PIDM ||'*'||SQLERRM);
                    END;

                ELSE

                    BEGIN

                        DELETE TZDOCTR
                        WHERE TZDOCTR_PIDM = X.PIDM
                        AND TZDOCTR_PROGRAM = X.PROGRAMA
                        AND TZDOCTR_TERM_CODE = X.PERIODO
                        AND TZDOCTR_START_DATE = X.FECHA
                        AND TZDOCTR_TIPO_PROC = 'AUME'
                        ;

                    END;

                    BEGIN
                          INSERT INTO  TZDOCTR
                                      (TZDOCTR_PIDM,
                                       TZDOCTR_PROGRAM,
                                       TZDOCTR_STST_CODE,
                                       TZDOCTR_STYP_CODE,
                                       TZDOCTR_CAMP_CODE,
                                       TZDOCTR_LEVL_CODE,
                                       TZDOCTR_TERM_CODE,
                                       TZDOCTR_START_DATE,
                                       TZDOCTR_PTRM_CODE,
                                       TZDOCTR_STUDY_PATH,
                                       FECHA_PROCESO,
                                       TZDOCTR_ID,
                                       TZDOCTR_TIPO_PROC,
                                       TZDOCTR_DESCUENTO,
                                       TZDOCTR_PERIODOS_CURSADOS,
                                       TZDOCTR_PORC_INCREM)
                          VALUES (
                                  X.PIDM,
                                  X.PROGRAMA,
                                  X.STST_CODE,
                                  X.TIPO,
                                  ALUMNO.CAMP,
                                  ALUMNO.NIVEL,
                                  X.PERIODO,
                                  X.FECHA,
                                  X.PPARTE,
                                  X.STUDY,
                                  SYSDATE,
                                  ALUMNO.ID,
                                  'AUME',
                                  0,
                                  ALUMNO.MESES,
                                  vl_porcentaje
                                  );


                    EXCEPTION
                    WHEN OTHERS THEN
                    VL_ERROR:=('Error 2 TZDOCTR '|| ALUMNO.PIDM ||'*'||SQLERRM);
                    END;

                END IF;

            END LOOP;

         End if;

---decrecientes
    ELSE
    EXIT;

    END IF;
----

     END LOOP;

    p_id_aumento:= NULL;

     COMMIT;

END P_INCREMENTO_ANUAL;
--
--
FUNCTION  F_UNICA_CARGO (P_MATRICULA IN VARCHAR2
                        ,P_FECHA     IN DATE    )RETURN VARCHAR2 IS
/******************************************************************************
   NAME:       F_UNICA_CARGO
   PURPOSE:    Aplicar cargos al Edo. de Cta., a partir de la generación de
               cartera. (Solo para los que cursan las materias de Proyecto
               Empresarial I y II para el campus 11 (UNI)).

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        27/06/2023  FND@Create       1. Creación de la función.

   NOTES:     La función comienza a trabajar a partir de la llamada de
              BANINST1.PKG_FINANZAS.P_GEN_CART_CONF (VL_UNICA).

******************************************************************************
   MARCAS DE CAMBIO:
   No. 1
   Clave de cambio: 001-DDMMYYYY-(Autor-inciales)
   Autor: (Autor-Iniciales)@(Create, Update, Delete)
   Descripción: (Describir el ajuste/modificación al código)
******************************************************************************
   No. 2
   Clave de cambio: 002-DDMMYYYY-(Autor-inciales)
   Autor: (Autor-Iniciales)@(Create, Update, Delete)
   Descripción: (Describir el ajuste/modificación al código)
******************************************************************************

******************************************************************************/

-- Variables del proceso.
VL_MONTO            NUMBER         := 0;
VL_SECUENCIA        NUMBER         := 0;
VL_DESCRIPCION      VARCHAR2(250)  := NULL;
VL_CODIGO           VARCHAR2(4)    := NULL;
VL_DIA              NUMBER;
VL_MES              NUMBER;
VL_ANO              NUMBER;
VL_ERROR            VARCHAR2(2000) := 'EXITO';
VL_RATE             VARCHAR2(8);
VL_FECHA            DATE;
VL_PIDM             NUMBER         := 0;


BEGIN
-- Consulta de Pidm del alumno.
    BEGIN
        SELECT SPRIDEN_PIDM
          INTO VL_PIDM
          FROM SPRIDEN
         WHERE 1 = 1
           AND SPRIDEN_CHANGE_IND IS NULL
           AND SPRIDEN_ID = P_MATRICULA;

    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            VL_ERROR := 'No se encontró el PIDM para la matrícula : '||P_MATRICULA||'... Favor de revisar...'||CHR(10)||'SQLCODE: '||SQLCODE||CHR(10)||SQLERRM;
    END;

-- Incia cursor para obtención de información de las materias del alumno.
    FOR CX IN (
                SELECT SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB MATERIA,
                       SFRSTCR_PIDM PIDM ,
                       SSBSECT_PTRM_START_DATE FECHA_INICIO,
                       SFRSTCR_TERM_CODE PERIODO,
                       SFRSTCR_PTRM_CODE PPERIDO,
                       SFRSTCR_VPDI_CODE ORDEN,
                       SFRSTCR_STSP_KEY_SEQUENCE SP
                  FROM SFRSTCR
                  JOIN SSBSECT ON SSBSECT_TERM_CODE = SFRSTCR_TERM_CODE
                              AND SSBSECT_CRN = SFRSTCR_CRN
                              AND TRUNC(SSBSECT_PTRM_START_DATE) = P_FECHA
                              AND SSBSECT_SUBJ_CODE||SSBSECT_CRSE_NUMB IN (SELECT ZSTPARA_PARAM_ID
                                                                             FROM ZSTPARA
                                                                            WHERE 1 = 1
                                                                              AND ZSTPARA_MAPA_ID = 'MAT_PROYEM')
                 WHERE 1 = 1
                   AND SFRSTCR_PIDM = VL_PIDM
                   AND SFRSTCR_RSTS_CODE ='RE'
                ) LOOP

                -- Seteo de variables.
                    VL_MONTO       := 0;
                    VL_DESCRIPCION := NULL;
                    VL_CODIGO      := NULL;

                -- Obtención del Monto, Descripcion del concepto y cod. detalle del concepto. por el agrupador MAT_PROYEM
                    BEGIN
                        SELECT DISTINCT TBBDETC_AMOUNT
                              ,TBBDETC_DESC
                              ,TBBDETC_DETAIL_CODE
                          INTO VL_MONTO
                              ,VL_DESCRIPCION
                              ,VL_CODIGO
                          FROM TBBDETC
                         WHERE 1 = 1
                           AND TBBDETC_DETAIL_CODE IN  (SELECT ZSTPARA_PARAM_DESC
                                                          FROM ZSTPARA
                                                         WHERE 1 = 1
                                                           AND ZSTPARA_MAPA_ID = 'MAT_PROYEM'
                                                           AND ZSTPARA_PARAM_ID = CX.MATERIA);

                    EXCEPTION
                        WHEN OTHERS THEN
                            VL_MONTO       := 0;
                            VL_DESCRIPCION := NULL;
                    END;

                -- La variable fecha será igual a la fecha del sistema.
                    VL_FECHA := TRUNC(SYSDATE);

                -- Obtención del plan(Rate).
                    BEGIN
                        SELECT A.SORLCUR_RATE_CODE
                          INTO VL_RATE
                          FROM SORLCUR A
                         WHERE 1 = 1
                           AND A.SORLCUR_LMOD_CODE = 'LEARNER'
                           AND A.SORLCUR_ROLL_IND = 'Y'
                           AND A.SORLCUR_CACT_CODE = 'ACTIVE'
                           AND A.SORLCUR_PIDM = FGET_PIDM(P_MATRICULA)
                           And trunc (a.SORLCUR_START_DATE) = P_FECHA
                           AND A.SORLCUR_RATE_CODE IS NOT NULL
                           AND A.SORLCUR_SEQNO IN (SELECT MAX(A1.SORLCUR_SEQNO)
                                                     FROM SORLCUR A1
                                                    WHERE 1 = 1
                                                      AND A1.SORLCUR_PIDM = A.SORLCUR_PIDM
                                                      AND A1.SORLCUR_ROLL_IND  = A.SORLCUR_ROLL_IND
                                                      AND A1.SORLCUR_CACT_CODE = A.SORLCUR_CACT_CODE
                                                      AND A1.SORLCUR_PROGRAM = A.SORLCUR_PROGRAM
                                                      AND A1.SORLCUR_KEY_SEQNO = A.SORLCUR_KEY_SEQNO
                                                      AND A1.SORLCUR_RATE_CODE IS NOT NULL
                                                      AND A1.SORLCUR_LMOD_CODE = A.SORLCUR_LMOD_CODE);
                    EXCEPTION
                        WHEN OTHERS THEN
                            VL_RATE := NULL;
                    END;

                -- Si no hay monto, entonces...
                    IF VL_MONTO > 0 THEN

                    -- Inicializa la secuencia del Edo. de Cta. del alumno a 0.
                        VL_SECUENCIA := 0;

                    -- Obtención de la máxima secuencia de registros del Edo. de Cta. del alumno más 1.
                        BEGIN
                            SELECT MAX(TBRACCD_TRAN_NUMBER) + 1
                              INTO VL_SECUENCIA
                              FROM TBRACCD
                             WHERE 1 = 1
                               AND  TBRACCD_PIDM = CX.PIDM;

                        EXCEPTION
                            WHEN OTHERS THEN
                                VL_SECUENCIA := 0;
                        END;

                    -- Seteo de variables de la fecha (día, mes y año) a vacio o nulo.
                        VL_DIA := NULL;
                        VL_MES := NULL;
                        VL_ANO := NULL;

                    -- Cálculo de fecha para la obtención de la nueva fecha de vencimiento a pagar.
                        VL_DIA := CASE SUBSTR(VL_RATE,4,1) WHEN 'A' THEN 15 WHEN 'B' THEN 30 WHEN 'C ' THEN 10 END;
                        VL_MES := SUBSTR (TO_CHAR(VL_FECHA, 'dd/mm/rrrr'), 4, 2);
                        VL_ANO := SUBSTR (TO_CHAR(VL_FECHA, 'dd/mm/rrrr'), 7, 4);

                    -- Si el calculo del nuevo día de vencimiento es 30 para el mes de febrero, entonces...
                        IF VL_DIA = '30' THEN

                        -- La fecha de vencimiento será para 28 de Febrero.
                            VL_FECHA := TO_DATE((CASE LPAD(VL_MES,2,'0') WHEN '02' THEN '28' ELSE VL_DIA END||'/'||LPAD(VL_MES,2,'0')||'/'||VL_ANO),'DD/MM/YYYY');

                    -- Si no...
                        ELSE

                        -- Se toma como fecha nueva.
                            VL_FECHA := TO_DATE((VL_DIA||'/'||LPAD(VL_MES,2,'0')||'/'||VL_ANO),'DD/MM/YYYY');

                        END IF;

                    -- Proceso de registro de nuevos cargos en el Edo. de Cta. del alumno. (Se registrará dos cargos).
                        BEGIN
                            INSERT INTO TBRACCD(TBRACCD_PIDM
                                               ,TBRACCD_TRAN_NUMBER
                                               ,TBRACCD_TERM_CODE
                                               ,TBRACCD_DETAIL_CODE
                                               ,TBRACCD_USER
                                               ,TBRACCD_ENTRY_DATE
                                               ,TBRACCD_AMOUNT
                                               ,TBRACCD_BALANCE
                                               ,TBRACCD_EFFECTIVE_DATE
                                               ,TBRACCD_BILL_DATE
                                               ,TBRACCD_DUE_DATE
                                               ,TBRACCD_DESC
                                               ,TBRACCD_RECEIPT_NUMBER
                                               ,TBRACCD_TRAN_NUMBER_PAID
                                               ,TBRACCD_CROSSREF_PIDM
                                               ,TBRACCD_CROSSREF_NUMBER
                                               ,TBRACCD_CROSSREF_DETAIL_CODE
                                               ,TBRACCD_SRCE_CODE
                                               ,TBRACCD_ACCT_FEED_IND
                                               ,TBRACCD_ACTIVITY_DATE
                                               ,TBRACCD_SESSION_NUMBER
                                               ,TBRACCD_CSHR_END_DATE
                                               ,TBRACCD_CRN
                                               ,TBRACCD_CROSSREF_SRCE_CODE
                                               ,TBRACCD_LOC_MDT
                                               ,TBRACCD_LOC_MDT_SEQ
                                               ,TBRACCD_RATE
                                               ,TBRACCD_UNITS
                                               ,TBRACCD_DOCUMENT_NUMBER
                                               ,TBRACCD_TRANS_DATE
                                               ,TBRACCD_PAYMENT_ID
                                               ,TBRACCD_INVOICE_NUMBER
                                               ,TBRACCD_STATEMENT_DATE
                                               ,TBRACCD_INV_NUMBER_PAID
                                               ,TBRACCD_CURR_CODE
                                               ,TBRACCD_EXCHANGE_DIFF
                                               ,TBRACCD_FOREIGN_AMOUNT
                                               ,TBRACCD_LATE_DCAT_CODE
                                               ,TBRACCD_FEED_DATE
                                               ,TBRACCD_FEED_DOC_CODE
                                               ,TBRACCD_ATYP_CODE
                                               ,TBRACCD_ATYP_SEQNO
                                               ,TBRACCD_CARD_TYPE_VR
                                               ,TBRACCD_CARD_EXP_DATE_VR
                                               ,TBRACCD_CARD_AUTH_NUMBER_VR
                                               ,TBRACCD_CROSSREF_DCAT_CODE
                                               ,TBRACCD_ORIG_CHG_IND
                                               ,TBRACCD_CCRD_CODE
                                               ,TBRACCD_MERCHANT_ID
                                               ,TBRACCD_TAX_REPT_YEAR
                                               ,TBRACCD_TAX_REPT_BOX
                                               ,TBRACCD_TAX_AMOUNT
                                               ,TBRACCD_TAX_FUTURE_IND
                                               ,TBRACCD_DATA_ORIGIN
                                               ,TBRACCD_CREATE_SOURCE
                                               ,TBRACCD_CPDT_IND
                                               ,TBRACCD_AIDY_CODE
                                               ,TBRACCD_STSP_KEY_SEQUENCE
                                               ,TBRACCD_PERIOD
                                               ,TBRACCD_SURROGATE_ID
                                               ,TBRACCD_VERSION
                                               ,TBRACCD_USER_ID
                                               ,TBRACCD_VPDI_CODE)
                                         VALUES(CX.PIDM,
                                                VL_SECUENCIA,
                                                CX.PERIODO,
                                                VL_CODIGO,
                                                USER,
                                                SYSDATE,
                                                NVL(VL_MONTO,0),
                                                NVL(VL_MONTO,0),
                                                VL_FECHA,
                                                NULL,
                                                NULL,
                                                VL_DESCRIPCION,
                                                CX.ORDEN,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                'T',
                                                'Y',
                                                SYSDATE,
                                                0,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                VL_FECHA,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                'MXN',
                                                NULL,
                                                NULL,
                                                NULL,
                                                CX.FECHA_INICIO,
                                                1,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                'TZFEDCA(EDCA)',
                                                'TZFEDCA(EDCA)',
                                                NULL,
                                                NULL,
                                                CX.SP,
                                                CX.PERIODO,
                                                NULL,
                                                NULL,
                                                USER,
                                                NULL);

                            INSERT INTO TBRACCD(TBRACCD_PIDM
                                               ,TBRACCD_TRAN_NUMBER
                                               ,TBRACCD_TERM_CODE
                                               ,TBRACCD_DETAIL_CODE
                                               ,TBRACCD_USER
                                               ,TBRACCD_ENTRY_DATE
                                               ,TBRACCD_AMOUNT
                                               ,TBRACCD_BALANCE
                                               ,TBRACCD_EFFECTIVE_DATE
                                               ,TBRACCD_BILL_DATE
                                               ,TBRACCD_DUE_DATE
                                               ,TBRACCD_DESC
                                               ,TBRACCD_RECEIPT_NUMBER
                                               ,TBRACCD_TRAN_NUMBER_PAID
                                               ,TBRACCD_CROSSREF_PIDM
                                               ,TBRACCD_CROSSREF_NUMBER
                                               ,TBRACCD_CROSSREF_DETAIL_CODE
                                               ,TBRACCD_SRCE_CODE
                                               ,TBRACCD_ACCT_FEED_IND
                                               ,TBRACCD_ACTIVITY_DATE
                                               ,TBRACCD_SESSION_NUMBER
                                               ,TBRACCD_CSHR_END_DATE
                                               ,TBRACCD_CRN
                                               ,TBRACCD_CROSSREF_SRCE_CODE
                                               ,TBRACCD_LOC_MDT
                                               ,TBRACCD_LOC_MDT_SEQ
                                               ,TBRACCD_RATE
                                               ,TBRACCD_UNITS
                                               ,TBRACCD_DOCUMENT_NUMBER
                                               ,TBRACCD_TRANS_DATE
                                               ,TBRACCD_PAYMENT_ID
                                               ,TBRACCD_INVOICE_NUMBER
                                               ,TBRACCD_STATEMENT_DATE
                                               ,TBRACCD_INV_NUMBER_PAID
                                               ,TBRACCD_CURR_CODE
                                               ,TBRACCD_EXCHANGE_DIFF
                                               ,TBRACCD_FOREIGN_AMOUNT
                                               ,TBRACCD_LATE_DCAT_CODE
                                               ,TBRACCD_FEED_DATE
                                               ,TBRACCD_FEED_DOC_CODE
                                               ,TBRACCD_ATYP_CODE
                                               ,TBRACCD_ATYP_SEQNO
                                               ,TBRACCD_CARD_TYPE_VR
                                               ,TBRACCD_CARD_EXP_DATE_VR
                                               ,TBRACCD_CARD_AUTH_NUMBER_VR
                                               ,TBRACCD_CROSSREF_DCAT_CODE
                                               ,TBRACCD_ORIG_CHG_IND
                                               ,TBRACCD_CCRD_CODE
                                               ,TBRACCD_MERCHANT_ID
                                               ,TBRACCD_TAX_REPT_YEAR
                                               ,TBRACCD_TAX_REPT_BOX
                                               ,TBRACCD_TAX_AMOUNT
                                               ,TBRACCD_TAX_FUTURE_IND
                                               ,TBRACCD_DATA_ORIGIN
                                               ,TBRACCD_CREATE_SOURCE
                                               ,TBRACCD_CPDT_IND
                                               ,TBRACCD_AIDY_CODE
                                               ,TBRACCD_STSP_KEY_SEQUENCE
                                               ,TBRACCD_PERIOD
                                               ,TBRACCD_SURROGATE_ID
                                               ,TBRACCD_VERSION
                                               ,TBRACCD_USER_ID
                                               ,TBRACCD_VPDI_CODE)
                                         VALUES(CX.PIDM,
                                                VL_SECUENCIA + 1,
                                                CX.PERIODO,
                                                VL_CODIGO,
                                                USER,
                                                SYSDATE,
                                                NVL(VL_MONTO,0),
                                                NVL(VL_MONTO,0),
                                                ADD_MONTHS(VL_FECHA,1),
                                                NULL,
                                                NULL,
                                                VL_DESCRIPCION,
                                                CX.ORDEN,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                'T',
                                                'Y',
                                                SYSDATE,
                                                0,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                ADD_MONTHS(VL_FECHA,1),
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                'MXN',
                                                NULL,
                                                NULL,
                                                NULL,
                                                CX.FECHA_INICIO,
                                                1,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                NULL,
                                                'TZFEDCA(EDCA)',
                                                'TZFEDCA(EDCA)',
                                                NULL,
                                                NULL,
                                                CX.SP,
                                                CX.PERIODO,
                                                NULL,
                                                NULL,
                                                USER,
                                                NULL);

                        EXCEPTION
                            WHEN OTHERS THEN
                                VL_ERROR := 'Error al insertar el (los) cargo(s) en el Edo. de Cta.... Favor de revisar... '||CHR(10)||'SQLCODE: '||SQLCODE||CHR(10)||SQLERRM;
                        END;

                    END IF;

                END LOOP;

            -- Si hay error en el proceso, entonces...
                IF VL_ERROR != 'EXITO' THEN

                -- Se reversa todas las operaciones/movimientos dentro de la función. (Rollback).
                    ROLLBACK;

                    RETURN VL_ERROR;

            -- Si no...
                ELSE

                -- Confirma todas las operaciones/movimientos dentro de la función. (Commit);
                    COMMIT;

                    RETURN VL_ERROR;

                END IF;


END F_UNICA_CARGO;--
--
--
--
FUNCTION F_BAJA_ECONOMICA (PN_PIDM IN NUMBER,
                           PN_CAMPUS IN VARCHAR2,
                           PN_NIVEL IN VARCHAR2,
                           PN_ESTATUS IN VARCHAR2 ,
                           PN_PROGRAMA VARCHAR2 DEFAULT NULL,
                           PN_PERIODO VARCHAR2,
                           PN_FECHA_BAJA DATE,
                           PN_FECHA_INICIO DATE,
                           PN_FECHA_FIN DATE,
                           PN_KEYSEQNO NUMBER) RETURN VARCHAR2
IS

/* Actualizado 08/10/2021 por jrezaoli
    se agrega cancelacion de accesorios por código especifico
*/

VL_ERROR                    VARCHAR2(1000):= 'EXITO';
VL_EXISTE_CONF              NUMBER:=0;
VL_PAGO_BAJA                NUMBER :=0;
VL_CARGO_BAJA               NUMBER :=0;
VL_SEMANA                   VARCHAR2(3):= NULL;
VL_INSCRIP_CODE             VARCHAR2(4);
VL_DESCRIPCION              VARCHAR2(250):= NULL;
VL_TRANSACCION              NUMBER :=0;
VL_PERIODO                  VARCHAR2(6):= NULL;
VL_PARCIAL_CODE             VARCHAR2(4);
VC_CONTA                    NUMBER:=0;
VL_PARTE                    VARCHAR(4):= NULL;
VL_RATE                     VARCHAR2(6);
VL_NUMPAG                   NUMBER :=0;
VL_EXISTE_DETAIL            VARCHAR2(6);
VL_PERIODO_A                VARCHAR2(9);
VL_EXIS_CONTRA              VARCHAR(6);
VL_MONTO_PAGADO             VARCHAR(6);
VL_CODIGO_AJ                VARCHAR(6);
VL_EXIS_AJUST               VARCHAR(6);
VL_COD_CONTRA               VARCHAR(9);
VL_DESC_CONTRA              VARCHAR(50);
VL_EXISTE_CSH               VARCHAR(9);
VL_CSH_MONTO                VARCHAR(9);
VL_CSH_PAG                  VARCHAR(9);
VL_AJUSTA_CSH               VARCHAR(9);
VL_CARGO_TRAM               VARCHAR(50);
VL_MONTO_TRAM               VARCHAR(10);
VL_VALIDA_TRAM              VARCHAR(10);
VL_ENTRA                    VARCHAR (10);
VL_EXIS_CONTRA_2            VARCHAR2(10);
VL_AJUSTE                   VARCHAR(500);
VL_CONDONACION              VARCHAR2 (4);
VL_CONDONACION_DESC         VARCHAR2(50);
VL_ENTRA_COND               VARCHAR2(3);
VL_ENTRA_COND_2             NUMBER;
VL_EXI_CONF                 NUMBER;
VL_1SS                      NUMBER;
VL_1SS_NUM                  NUMBER;
VL_1SS_PPER                 VARCHAR2(4);
VL_1SS_2                    NUMBER;
VL_1SS_PPL                  VARCHAR2(11);
VL_MATRICULA                VARCHAR2(11);
VL_MESCONTENCION            NUMBER;
VL_PROGR                    VARCHAR2(11);
VL_FUNCION                  VARCHAR2(200);
VL_PROMOCION                NUMBER;
VL_PROMOCION_MONTO          NUMBER;
VL_PROMOCION_TRAN           NUMBER;
VL_PROMOCION_VIG            DATE;
VL_PROMOCION_PERIODO        VARCHAR2(11);
VL_APL_AJUSTE               VARCHAR2(500);
VL_CART_UTL                 VARCHAR2(500);
VL_DIAS_AJUSTE              NUMBER;
VL_AJUSTA                   NUMBER;
VL_CAN_BECA                 VARCHAR2(500);
VL_COD_CANCELA              VARCHAR2(5);
vl_utelx                    VARCHAR2(5);
vl_53                       Number:=0;

CURSOR C_CONF IS
           ----- Se busca que exista la configuracion en la tabla de SZVBAEC  -----
          SELECT  COUNT(*),SZVBAEC_SEMANA_INI, SZVBAEC_SEMANA_FIN, SZVBAEC_PAGO_REQ, SZVBAEC_CONCEPTO_CARGO
                     , SZVBAEC_AJUSTE_TUI, SZVBAEC_CONCEPTO_TUI, SZVBAEC_PORCENT_TUI
                     , SZVBAEC_AJUSTE_PARC_VEN, SZVBAEC_CONCEPTO_PARC_VEN, SZVBAEC_PORCENT_PARC_VEN
                     , SZVBAEC_AJUSTE_PARC_XVEN, SZVBAEC_CONCEPTO_PARC_XVEN, SZVBAEC_PORCENT_PARC_XVEN
                     , SZVBAEC_AJUSTE_ACCE, SZVBAEC_CONCEPTO_ACCE, SZVBAEC_PORCENT_ACCE
                     , SZVBAEC_AJUSTE_BECA, SZVBAEC_CONCEPTO_BECA, SZVBAEC_PORCENT_BECA
                     , SZVBAEC_AJUSTE_DESCTO, SZVBAEC_CONCEPTO_DESCTO, SZVBAEC_PORCENT_DESCTO
                     , SZVBAEC_AJUSTE_INTERES, SZVBAEC_CONCEPTO_INTERES, SZVBAEC_PORCENT_INTERES
                     , SZVBAEC_AJUSTE_PLAN_VEN, SZVBAEC_CONCEPTO_PLAN_VEN, SZVBAEC_PORCENT_PLAN_VEN
                     , SZVBAEC_AJUSTE_PLAN_XVEN, SZVBAEC_CONCEPTO_PLAN_XVEN, SZVBAEC_PORCENT_PLAN_XVEN
            FROM SZVBAEC
            WHERE SZVBAEC_CAMP_CODE = PN_CAMPUS
            AND SZVBAEC_LEVL_CODE = PN_NIVEL
            AND SZVBAEC_STST_CODE = PN_ESTATUS
           -- AND NVL(SZVBAEC_PROGRAM_CODE,'0') = NVL(PN_PROGRAMA,NVL(SZVBAEC_PROGRAM_CODE,'0'))
            GROUP BY
                       SZVBAEC_SEMANA_INI, SZVBAEC_SEMANA_FIN, SZVBAEC_PAGO_REQ, SZVBAEC_CONCEPTO_CARGO
                     , SZVBAEC_AJUSTE_TUI, SZVBAEC_CONCEPTO_TUI, SZVBAEC_PORCENT_TUI
                     , SZVBAEC_AJUSTE_PARC_VEN, SZVBAEC_CONCEPTO_PARC_VEN, SZVBAEC_PORCENT_PARC_VEN
                     , SZVBAEC_AJUSTE_PARC_XVEN, SZVBAEC_CONCEPTO_PARC_XVEN, SZVBAEC_PORCENT_PARC_XVEN
                     , SZVBAEC_AJUSTE_ACCE, SZVBAEC_CONCEPTO_ACCE, SZVBAEC_PORCENT_ACCE
                     , SZVBAEC_AJUSTE_BECA, SZVBAEC_CONCEPTO_BECA, SZVBAEC_PORCENT_BECA
                     , SZVBAEC_AJUSTE_DESCTO, SZVBAEC_CONCEPTO_DESCTO, SZVBAEC_PORCENT_DESCTO
                     , SZVBAEC_AJUSTE_INTERES, SZVBAEC_CONCEPTO_INTERES, SZVBAEC_PORCENT_INTERES
                     , SZVBAEC_AJUSTE_PLAN_VEN, SZVBAEC_CONCEPTO_PLAN_VEN, SZVBAEC_PORCENT_PLAN_VEN
                     , SZVBAEC_AJUSTE_PLAN_XVEN, SZVBAEC_CONCEPTO_PLAN_XVEN, SZVBAEC_PORCENT_PLAN_XVEN;

BEGIN

 FOR  CF IN C_CONF LOOP

    DBMS_OUTPUT.PUT_LINE('ECONOMICA '||
                           PN_PIDM ||' '||
                           PN_CAMPUS||' '||
                           PN_NIVEL ||' '||
                           PN_ESTATUS ||' '||
                           PN_PROGRAMA ||' '||
                           PN_PERIODO ||' '||
                           PN_FECHA_BAJA ||' '||
                           PN_FECHA_INICIO ||' '||
                           PN_FECHA_FIN ||' '||
                           PN_KEYSEQNO);
    VL_ERROR := 'EXITO';
    VL_PARTE := NULL;

   BEGIN
     SELECT MAX (SFRSTCR_PTRM_CODE)
       INTO VL_PARTE
       FROM SFRSTCR A
      WHERE     A.SFRSTCR_PIDM = PN_PIDM
            AND A.SFRSTCR_STSP_KEY_SEQUENCE = PN_KEYSEQNO
            AND SUBSTR (A.SFRSTCR_TERM_CODE, 5, 1)  != '8'
            AND A.SFRSTCR_TERM_CODE = (SELECT MAX (A1.SFRSTCR_TERM_CODE)
                                         FROM SFRSTCR A1
                                        WHERE     A.SFRSTCR_PIDM = A1.SFRSTCR_PIDM
                                              AND A.SFRSTCR_STSP_KEY_SEQUENCE = A1.SFRSTCR_STSP_KEY_SEQUENCE)
            AND A.SFRSTCR_CRN IN (SELECT (SSBSECT_CRN)
                                    FROM SSBSECT
                                   WHERE SSBSECT_PTRM_START_DATE = PN_FECHA_INICIO);
   EXCEPTION
    WHEN OTHERS THEN
   VL_PARTE:=NULL;
   END;

   BEGIN
     SELECT  COUNT(*)
       INTO VL_EXI_CONF
       FROM SZVBAEC
      WHERE     SZVBAEC_CAMP_CODE = PN_CAMPUS
            AND SZVBAEC_LEVL_CODE = PN_NIVEL
            AND SZVBAEC_STST_CODE = PN_ESTATUS;
            --AND NVL(SZVBAEC_PROGRAM_CODE,'0') = NVL(PN_PROGRAMA,NVL(SZVBAEC_PROGRAM_CODE,'0'));
   EXCEPTION
   WHEN OTHERS THEN
   VL_EXISTE_CONF:=0;
   END;

   IF  VL_EXI_CONF > 0 THEN
       DBMS_OUTPUT.PUT_LINE(CF.SZVBAEC_SEMANA_INI||'-'||CF.SZVBAEC_SEMANA_FIN);
     BEGIN
       IF CF.SZVBAEC_PAGO_REQ = 'S' THEN
          BEGIN
            SELECT SUM (TBRAPPL_AMOUNT) PAGADO, X.PAGO CARGO
              INTO VL_PAGO_BAJA ,VL_CARGO_BAJA
              FROM TBRAPPL B , (SELECT A1.TBRACCD_AMOUNT PAGO, A1.TBRACCD_TRAN_NUMBER
                                  FROM TBRACCD A1
                                 WHERE      A1.TBRACCD_PIDM = PN_PIDM
                                        AND A1.TBRACCD_DETAIL_CODE = CF.SZVBAEC_CONCEPTO_CARGO
                                        AND A1.TBRACCD_TRAN_NUMBER IN (SELECT MAX (A2.TBRACCD_TRAN_NUMBER)
                                                                         FROM TBRACCD A2
                                                                        WHERE     A1.TBRACCD_PIDM = A2.TBRACCD_PIDM
                                                                              AND A1.TBRACCD_DETAIL_CODE = A2.TBRACCD_DETAIL_CODE)) X
             WHERE     B.TBRAPPL_PIDM = PN_PIDM
                   AND B.TBRAPPL_CHG_TRAN_NUMBER = (SELECT A.TBRACCD_TRAN_NUMBER
                                                      FROM TBRACCD A
                                                     WHERE     A.TBRACCD_PIDM = B.TBRAPPL_PIDM
                                                           AND A.TBRACCD_DETAIL_CODE = CF.SZVBAEC_CONCEPTO_CARGO)
                   AND B.TBRAPPL_CHG_TRAN_NUMBER = X.TBRACCD_TRAN_NUMBER
                   AND B.TBRAPPL_REAPPL_IND IS NULL
             GROUP BY X.PAGO;
          EXCEPTION
          WHEN OTHERS THEN
          VL_PAGO_BAJA :=0;
          VL_CARGO_BAJA :=0;
          END;

          IF  VL_PAGO_BAJA < VL_CARGO_BAJA  OR  VL_CARGO_BAJA = 0 THEN
           VL_ERROR := 'No se a liquidado el 100%  del pago por parte del alumno para el proceso de Baja ';
          END IF;

       END IF;

     END;

     VL_SEMANA:=ROUND ((PN_FECHA_BAJA - PN_FECHA_INICIO)  / 7);

     DBMS_OUTPUT.PUT_LINE('Aqui valida las semanas ggc<<<<'||VL_SEMANA||'----'||PN_FECHA_BAJA||'----'||PN_FECHA_INICIO||'**'||CF.SZVBAEC_SEMANA_INI ||'**'||CF.SZVBAEC_SEMANA_FIN );

     IF VL_SEMANA >= 0 THEN
            DBMS_OUTPUT.PUT_LINE('entra ggc');
       IF VL_SEMANA BETWEEN CF.SZVBAEC_SEMANA_INI AND (CF.SZVBAEC_SEMANA_FIN) THEN
            DBMS_OUTPUT.PUT_LINE('entra ggc tambien ');
          ---------------------------------------------------------------------------------------------------------------
          ----Inicia el proceso para los ajustes de cada concepto marcado------------------------------------------------
          ---- Valida que se tenga que ajustar la Colegiatura -----------------------------------------------------------

         IF CF.SZVBAEC_AJUSTE_TUI = 'S' THEN

           BEGIN
             SELECT DISTINCT ZSTPARA_PARAM_VALOR
               INTO VL_INSCRIP_CODE
               FROM ZSTPARA
              WHERE ZSTPARA_MAPA_ID = 'CONFIGURA_BAJA' AND ZSTPARA_PARAM_ID = 'INSCRIPCION_CARGO';
           EXCEPTION
           WHEN OTHERS THEN
             VL_INSCRIP_CODE := NULL;
           END;

           BEGIN
             SELECT DISTINCT TBBDETC_DESC
               INTO VL_DESCRIPCION
               FROM TBBDETC
              WHERE TBBDETC_DETAIL_CODE = CF.SZVBAEC_CONCEPTO_TUI;
           EXCEPTION
           WHEN OTHERS THEN
             VL_DESCRIPCION := NULL;
           END;

           IF VL_INSCRIP_CODE IS NOT NULL THEN

             FOR COLEG IN (

                  SELECT  B.TBRACCD_PIDM PIDM,
                          B.TBRACCD_BALANCE MONTO,
                          B.TBRACCD_TRAN_NUMBER SECUENCIA,
                          B.TBRACCD_BALANCE*(CF.SZVBAEC_PORCENT_TUI/*vp_inscrip_porc*//100) DESCUENTO,
                          SPRIDEN_ID ID,
                          TBRACCD_STSP_KEY_SEQUENCE, TBRACCD_PERIOD, --RLS20180131
                          TBRACCD_TERM_CODE PERIODO,
                          TBRACCD_DETAIL_CODE Codigo
                    FROM TBRACCD B, SPRIDEN
                   WHERE     B.TBRACCD_PIDM = PN_PIDM
                         AND B.TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                                         FROM TBBDETC
                                                        WHERE TBBDETC_DCAT_CODE = VL_INSCRIP_CODE
                                                              AND SUBSTR (TBBDETC_DETAIL_CODE,1,2) = SUBSTR (B.TBRACCD_TERM_CODE,1,2)
                                                              AND TBBDETC_DETC_ACTIVE_IND = 'Y'
                                                              AND TBBDETC_TAXT_CODE = PN_NIVEL)
                         AND B.TBRACCD_BALANCE > 0
                         AND B.TBRACCD_PIDM = SPRIDEN_PIDM
                         AND SPRIDEN_CHANGE_IND IS NULL
             ) LOOP

                DBMS_OUTPUT.PUT_LINE('Entra a los registros de Colegiatura '||COLEG.secuencia ||'*'||COLEG.Codigo);


               BEGIN
                 SELECT NVL(MAX(TBRACCD_TRAN_NUMBER),0) +1
                   INTO VL_TRANSACCION
                   FROM TBRACCD
                  WHERE TBRACCD_PIDM=COLEG.PIDM;
               EXCEPTION
               WHEN OTHERS THEN
               VL_TRANSACCION:=0;
               END;

               BEGIN
                SELECT FGET_PERIODO_GENERAL(SUBSTR(COLEG.ID,1,2))
                  INTO VL_PERIODO FROM DUAL;
               EXCEPTION
               WHEN OTHERS THEN
               VL_PERIODO := '000000';
               END;

               BEGIN
                   INSERT
                     INTO TBRACCD
                   VALUES (
                           COLEG.PIDM,                                         -- TBRACCD_PIDM
                           VL_TRANSACCION,                                     -- TBRACCD_TRAN_NUMBER
                           COLEG.PERIODO,                                      -- TBRACCD_TERM_CODE
                           CF.SZVBAEC_CONCEPTO_TUI,                            -- TBRACCD_DETAIL_CODE
                           USER,                                               -- TBRACCD_USER
                           SYSDATE,                                            -- TBRACCD_ENTRY_DATE
                           NVL(COLEG.DESCUENTO,0)* -1,                         -- TBRACCD_AMOUNT
                           NVL(COLEG.DESCUENTO,0) * -1,                        -- TBRACCD_BALANCE
                           SYSDATE,                                            -- TBRACCD_EFFECTIVE_DATE
                           NULL,                                               -- TBRACCD_BILL_DATE
                           NULL,                                               -- TBRACCD_DUE_DATE
                           VL_DESCRIPCION,                                     -- TBRACCD_DESC
                           NULL,                                               -- TBRACCD_RECEIPT_NUMBER
                           COLEG.SECUENCIA,                                    -- TBRACCD_TRAN_NUMBER_PAID
                           NULL,                                               -- TBRACCD_CROSSREF_PIDM
                           NULL,                                               -- TBRACCD_CROSSREF_NUMBER
                           NULL,                                               -- TBRACCD_CROSSREF_DETAIL_CODE
                           'T',                                                -- TBRACCD_SRCE_CODE
                           'Y',                                                -- TBRACCD_ACCT_FEED_IND
                           SYSDATE,                                            -- TBRACCD_ACTIVITY_DATE
                           0,                                                  -- TBRACCD_SESSION_NUMBER
                           NULL,                                               -- TBRACCD_CSHR_END_DATE
                           NULL,                                               -- TBRACCD_CRN
                           NULL,                                               -- TBRACCD_CROSSREF_SRCE_CODE
                           NULL,                                               -- TBRACCD_LOC_MDT
                           NULL,                                               -- TBRACCD_LOC_MDT_SEQ
                           NULL,                                               -- TBRACCD_RATE
                           NULL,                                               -- TBRACCD_UNITS
                           NULL,                                               -- TBRACCD_DOCUMENT_NUMBER
                           SYSDATE,                                            -- TBRACCD_TRANS_DATE
                           NULL,                                               -- TBRACCD_PAYMENT_ID
                           NULL,                                               -- TBRACCD_INVOICE_NUMBER
                           NULL,                                               -- TBRACCD_STATEMENT_DATE
                           NULL,                                               -- TBRACCD_INV_NUMBER_PAID
                           'MXN',                                              -- TBRACCD_CURR_CODE
                           NULL,                                               -- TBRACCD_EXCHANGE_DIFF
                           NULL,                                               -- TBRACCD_FOREIGN
                           NULL,                                               -- TBRACCD_LATE_DCAT_CODE
                           PN_FECHA_INICIO,                                    -- TBRACCD_FEED_DATE
                           NULL,                                               -- TBRACCD_FEED_DOC_CODE
                           NULL,                                               -- TBRACCD_ATYP_CODE
                           NULL,                                               -- TBRACCD_ATYP_SEQNO
                           NULL,                                               -- TBRACCD_CARD_TYPE_VR
                           NULL,                                               -- TBRACCD_CARD_EXP_DATE_VR
                           NULL,                                               -- TBRACCD_CARD_AUTH_NUMBER_VR
                           NULL,                                               -- TBRACCD_CROSSREF_DCAT_CODE
                           NULL,                                               -- TBRACCD_ORIG_CHG_IND
                           NULL,                                               -- TBRACCD_CCRD_CODE
                           NULL,                                               -- TBRACCD_MERCHANT_ID
                           NULL,                                               -- TBRACCD_TAX_REPT_YEAR
                           NULL,                                               -- TBRACCD_TAX_REPT_BOX
                           NULL,                                               -- TBRACCD_TAX_AMOUNT
                           NULL,                                               -- TBRACCD_TAX_FUTURE_IND
                           'AUTOMATICO',                                       -- TBRACCD_DATA_ORIGIN
                           'AUTOMATICO',                                       -- TBRACCD_CREATE_SOURCE
                           NULL,                                               -- TBRACCD_CPDT_IND
                           NULL,                                               -- TBRACCD_AIDY_CODE
                           NVL (COLEG.TBRACCD_STSP_KEY_SEQUENCE,PN_KEYSEQNO),  -- TBRACCD_STSP_KEY_SEQUENCE
                           NVL(COLEG.TBRACCD_PERIOD,VL_PARTE),                 -- TBRACCD_PERIOD
                           NULL,                                               -- TBRACCD_SURROGATE_ID
                           NULL,                                               -- TBRACCD_VERSION
                           USER,                                               -- TBRACCD_USER_ID
                           NULL );                                             -- TBRACCD_VPDI_CODE
                           
                           DBMS_OUTPUT.PUT_LINE('Genera los cargos de Colegiatura '||CF.SZVBAEC_CONCEPTO_TUI ||'*'||VL_TRANSACCION);

                           
               EXCEPTION
               WHEN OTHERS THEN
               VL_ERROR := 'Se presento el siguiente error al momento de insertar ajuste para colegiatura en TBRACCD '||SQLERRM;
               END;

             END LOOP COLEG;

             VL_TRANSACCION :=0;
             VL_PERIODO := NULL;
             VL_DESCRIPCION:=NULL;

             BEGIN
                SELECT DISTINCT TBBDETC_DESC
                  INTO VL_DESCRIPCION
                  FROM TBBDETC
                 WHERE TBBDETC_DETAIL_CODE = 'PLPA';
             EXCEPTION
             WHEN OTHERS THEN
             VL_DESCRIPCION := NULL;
             END;

              FOR PPAGOS IN (
                             SELECT DISTINCT ZSTPARA_PARAM_VALOR CATEGORIA
                               FROM ZSTPARA
                               WHERE ZSTPARA_MAPA_ID = 'CONFIGURA_BAJA' AND ZSTPARA_PARAM_ID = 'INSCRIP_CARGO_PPL'
             ) LOOP

                  FOR PPAGO IN (

                      SELECT  B.TBRACCD_PIDM PIDM,
                              B.TBRACCD_BALANCE MONTO,
                              B.TBRACCD_TRAN_NUMBER SECUENCIA,
                              ROUND(B.TBRACCD_BALANCE*(CF.SZVBAEC_PORCENT_TUI/*vp_inscrip_porc*//100)) DESCUENTO,
                              SPRIDEN_ID ID,
                              b.TBRACCD_STSP_KEY_SEQUENCE,
                              b.TBRACCD_PERIOD, --RLS20180131
                              b.TBRACCD_TERM_CODE PERIODO,
                              b.TBRACCD_DETAIL_CODE codigo
                        FROM TBRACCD B, SPRIDEN
                       WHERE      B.TBRACCD_PIDM = PN_PIDM
                              AND B.TBRACCD_BALANCE < 0
                              AND B.TBRACCD_PIDM = SPRIDEN_PIDM
                              AND SPRIDEN_CHANGE_IND IS NULL
                              AND B.TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                                              FROM TBBDETC
                                                             WHERE     TBBDETC_DCAT_CODE = PPAGOS.CATEGORIA
                                                                   AND TBBDETC_DETC_ACTIVE_IND = 'Y')
                              AND B.TBRACCD_TRAN_NUMBER NOT IN (SELECT TBRAPPL_PAY_TRAN_NUMBER
                                                                  FROM TBRAPPL
                                                                 WHERE     TBRAPPL_PIDM = B.TBRACCD_PIDM
                                                                       AND TBRAPPL_REAPPL_IND IS NULL)

               )LOOP

                    DBMS_OUTPUT.PUT_LINE('Entra a los registros de PPAGO '||PPAGO.secuencia ||'*'||PPAGO.Codigo);

                 BEGIN
                    SELECT NVL(MAX(TBRACCD_TRAN_NUMBER),0) +1
                      INTO VL_TRANSACCION
                      FROM TBRACCD
                     WHERE TBRACCD_PIDM=PPAGO.PIDM;
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_TRANSACCION:=0;
                 END;

                 BEGIN
                    INSERT
                      INTO TBRACCD
                    VALUES (
                            PPAGO.PIDM,                                         -- TBRACCD_PIDM
                            VL_TRANSACCION,                                     -- TBRACCD_TRAN_NUMBER
                            PPAGO.PERIODO,                                      -- TBRACCD_TERM_CODE
                            'PLPA',                                             -- TBRACCD_DETAIL_CODE
                            USER,                                               -- TBRACCD_USER
                            SYSDATE,                                            -- TBRACCD_ENTRY_DATE
                            NVL(PPAGO.DESCUENTO,0) ,                            -- TBRACCD_AMOUNT
                            NVL(PPAGO.DESCUENTO,0)*-1 ,                         -- TBRACCD_BALANCE
                            SYSDATE,                                            -- TBRACCD_EFFECTIVE_DATE
                            NULL,                                               -- TBRACCD_BILL_DATE
                            NULL,                                               -- TBRACCD_DUE_DATE
                            VL_DESCRIPCION,                                     -- TBRACCD_DESC
                            NULL,                                               -- TBRACCD_RECEIPT_NUMBER
                            PPAGO.SECUENCIA,                                    -- TBRACCD_TRAN_NUMBER_PAID
                            NULL,                                               -- TBRACCD_CROSSREF_PIDM
                            NULL,                                               -- TBRACCD_CROSSREF_NUMBER
                            NULL,                                               -- TBRACCD_CROSSREF_DETAIL_CODE
                            'T',                                                -- TBRACCD_SRCE_CODE
                            'Y',                                                -- TBRACCD_ACCT_FEED_IND
                            SYSDATE,                                            -- TBRACCD_ACTIVITY_DATE
                            0,                                                  -- TBRACCD_SESSION_NUMBER
                            NULL,                                               -- TBRACCD_CSHR_END_DATE
                            NULL,                                               -- TBRACCD_CRN
                            NULL,                                               -- TBRACCD_CROSSREF_SRCE_CODE
                            NULL,                                               -- TBRACCD_LOC_MDT
                            NULL,                                               -- TBRACCD_LOC_MDT_SEQ
                            NULL,                                               -- TBRACCD_RATE
                            NULL,                                               -- TBRACCD_UNITS
                            NULL,                                               -- TBRACCD_DOCUMENT_NUMBER
                            SYSDATE,                                            -- TBRACCD_TRANS_DATE
                            NULL,                                               -- TBRACCD_PAYMENT_ID
                            NULL,                                               -- TBRACCD_INVOICE_NUMBER
                            NULL,                                               -- TBRACCD_STATEMENT_DATE
                            NULL,                                               -- TBRACCD_INV_NUMBER_PAID
                            'MXN',                                              -- TBRACCD_CURR_CODE
                            NULL,                                               -- TBRACCD_EXCHANGE_DIFF
                            NULL,                                               -- TBRACCD_FOREIGN
                            NULL,                                               -- TBRACCD_LATE_DCAT_CODE
                            PN_FECHA_INICIO,                                    -- TBRACCD_FEED_DATE
                            NULL,                                               -- TBRACCD_FEED_DOC_CODE
                            NULL,                                               -- TBRACCD_ATYP_CODE
                            NULL,                                               -- TBRACCD_ATYP_SEQNO
                            NULL,                                               -- TBRACCD_CARD_TYPE_VR
                            NULL,                                               -- TBRACCD_CARD_EXP_DATE_VR
                            NULL,                                               -- TBRACCD_CARD_AUTH_NUMBER_VR
                            NULL,                                               -- TBRACCD_CROSSREF_DCAT_CODE
                            NULL,                                               -- TBRACCD_ORIG_CHG_IND
                            NULL,                                               -- TBRACCD_CCRD_CODE
                            NULL,                                               -- TBRACCD_MERCHANT_ID
                            NULL,                                               -- TBRACCD_TAX_REPT_YEAR
                            NULL,                                               -- TBRACCD_TAX_REPT_BOX
                            NULL,                                               -- TBRACCD_TAX_AMOUNT
                            NULL,                                               -- TBRACCD_TAX_FUTURE_IND
                            'AUTOMATICO',                                       -- TBRACCD_DATA_ORIGIN
                            'AUTOMATICO',                                       -- TBRACCD_CREATE_SOURCE
                            NULL,                                               -- TBRACCD_CPDT_IND
                            NULL,                                               -- TBRACCD_AIDY_CODE
                            NVL (PPAGO.TBRACCD_STSP_KEY_SEQUENCE,PN_KEYSEQNO),  -- TBRACCD_STSP_KEY_SEQUENCE
                            NVL (PPAGO.TBRACCD_PERIOD,VL_PARTE) ,               -- TBRACCD_PERIOD
                            NULL,                                               -- TBRACCD_SURROGATE_ID
                            NULL,                                               -- TBRACCD_VERSION
                            USER,                                               -- TBRACCD_USER_ID
                            NULL );                                             -- TBRACCD_VPDI_CODE
                            
                            DBMS_OUTPUT.PUT_LINE('Genera los cargos de Colegiatura '||'PLPA' ||'*'||VL_TRANSACCION);
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_ERROR := 'Se presento el siguiente error al momento de insertar ajuste para Plan de Pagos de Colegiatura  en TBRACCD '||SQLERRM;
                 END;

               END LOOP PPAGO;
             END LOOP PPAGOS;
           END IF;
         END IF;
        ---------------------------------------------------------------------------------------------------------
        --------------------------------- Proceso de Parcialidades VENCIDAS--------------------------------------
        ---------------------------------------------------------------------------------------------------------
         VL_RATE := NULL;

         BEGIN
           SELECT DISTINCT SUBSTR (SGBSTDN_RATE_CODE, 1, 1) RATE
             INTO VL_RATE
             FROM SGBSTDN A,   SPRIDEN C
            WHERE     A.SGBSTDN_PIDM = C.SPRIDEN_PIDM
                  AND C.SPRIDEN_CHANGE_IND IS NULL
                  AND C.SPRIDEN_PIDM = PN_PIDM
                  AND A.SGBSTDN_TERM_CODE_EFF IN ( SELECT MAX (A1.SGBSTDN_TERM_CODE_EFF)
                                                     FROM SGBSTDN A1
                                                    WHERE     A.SGBSTDN_PIDM = A1.SGBSTDN_PIDM
                                                          AND A.SGBSTDN_PROGRAM_1 = A1.SGBSTDN_PROGRAM_1);
         EXCEPTION
         WHEN OTHERS THEN
         VL_RATE :=NULL;
         END;

         DBMS_OUTPUT.PUT_LINE('PN_ESTATUS  '||PN_ESTATUS);

         IF VL_RATE = 'P'  THEN
           IF CF.SZVBAEC_AJUSTE_PLAN_VEN = 'S' AND PN_ESTATUS != 'BA' THEN

             BEGIN
               SELECT DISTINCT TBBDETC_DESC
                 INTO VL_DESCRIPCION
                 FROM TBBDETC
                WHERE TBBDETC_DETAIL_CODE = CF.SZVBAEC_CONCEPTO_PLAN_VEN;
             EXCEPTION
             WHEN OTHERS THEN
             VL_DESCRIPCION := NULL;
             END;

             FOR PLANES_VEN IN (

                        SELECT DISTINCT ZSTPARA_PARAM_VALOR CATEGORIA
                          FROM ZSTPARA
                         WHERE ZSTPARA_MAPA_ID = 'CONFIGURA_BAJA' AND ZSTPARA_PARAM_ID = 'PLAN_VEN_CARGO'
             ) LOOP
              ---------------------------------------------------------------------------------------------------------
              ------------------ valida que se tenga la categoria correcta para Planes Vencidos  ----------------------
              ---------------------------------------------------------------------------------------------------------
              FOR CARGO IN (

                      SELECT  B.TBRACCD_PIDM PIDM,
                              B.TBRACCD_AMOUNT MONTO,
                              B.TBRACCD_TRAN_NUMBER SECUENCIA,
                              (B.TBRACCD_AMOUNT- NVL((SELECT SUM(TBRACCD_AMOUNT)
                                                       FROM TBRACCD
                                                      WHERE     TBRACCD_PIDM = B.TBRACCD_PIDM
                                                            AND TBRACCD_CREATE_SOURCE = 'CANCELA DINA'
                                                            AND TBRACCD_TRAN_NUMBER_PAID = B.TBRACCD_TRAN_NUMBER
                                                            ),0))*(CF.SZVBAEC_PORCENT_PLAN_VEN/100) DESCUENTO,
                              SPRIDEN_ID ID,
                              TBRACCD_STSP_KEY_SEQUENCE ,
                              TBRACCD_PERIOD, --RLS20180131
                              TBRACCD_TERM_CODE PERIODO,
                              TBRACCD_EFFECTIVE_DATE FECHA_EFFECTIVA,
                              TBRACCD_RECEIPT_NUMBER,
                              b.TBRACCD_DETAIL_CODE Codigo
                        FROM TBRACCD B, SPRIDEN
                       WHERE     B.TBRACCD_PIDM = PN_PIDM
                             AND B.TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                                             FROM TBBDETC
                                                            WHERE     TBBDETC_DCAT_CODE = PLANES_VEN.CATEGORIA
                                                                  AND SUBSTR (TBBDETC_DETAIL_CODE,1,2) = SUBSTR (B.TBRACCD_TERM_CODE,1,2)
                                                                  AND TBBDETC_DETC_ACTIVE_IND = 'Y' )
                             AND TO_CHAR(TRUNC(B.TBRACCD_EFFECTIVE_DATE),'MM/RRRR') < TO_CHAR(TO_DATE(PN_FECHA_BAJA,'DD/MM/YY'),'MM/RRRR')
                             AND B.TBRACCD_EFFECTIVE_DATE >= PN_FECHA_INICIO
                             AND (SELECT EXTRACT(YEAR FROM TRUNC(B.TBRACCD_EFFECTIVE_DATE))FROM DUAL) <= (SELECT EXTRACT(YEAR FROM PN_FECHA_BAJA) FROM DUAL)
                             AND B.TBRACCD_TRAN_NUMBER NOT IN (SELECT TBRAPPL_PAY_TRAN_NUMBER
                                                                 FROM TBRAPPL
                                                                WHERE TBRAPPL_PIDM = B.TBRACCD_PIDM AND TBRAPPL_REAPPL_IND IS NULL)
                             AND TRUNC(B.TBRACCD_ENTRY_DATE) = (SELECT MAX(TRUNC(A2.TBRACCD_ENTRY_DATE))
                                                                  FROM TBRACCD A2
                                                                 WHERE     A2.TBRACCD_PIDM = B.TBRACCD_PIDM
                                                                       AND A2.TBRACCD_DETAIL_CODE = B.TBRACCD_DETAIL_CODE)
                             AND B.TBRACCD_PIDM = SPRIDEN_PIDM
                             AND SPRIDEN_CHANGE_IND IS NULL
                       ORDER BY B.TBRACCD_TRAN_NUMBER

               ) LOOP

                    DBMS_OUTPUT.PUT_LINE('Entra a los registros de Cargos '||CARGO.secuencia ||'*'||CARGO.Codigo);

                 BEGIN
                   SELECT A1.TBRAPPL_PAY_TRAN_NUMBER
                     INTO VL_NUMPAG
                     FROM TBRAPPL A1
                    WHERE     A1.TBRAPPL_PIDM = CARGO.PIDM
                          AND A1.TBRAPPL_CHG_TRAN_NUMBER =  CARGO.SECUENCIA
                          AND A1.TBRAPPL_ACTIVITY_DATE = (SELECT MAX (A.TBRAPPL_ACTIVITY_DATE)
                                                            FROM TBRAPPL A
                                                           WHERE     A.TBRAPPL_PIDM = A1.TBRAPPL_PIDM
                                                                 AND A.TBRAPPL_CHG_TRAN_NUMBER =  A1.TBRAPPL_CHG_TRAN_NUMBER);
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_NUMPAG :=0;
                 END;

                 BEGIN
                   SELECT B.TBRACCD_DETAIL_CODE
                     INTO VL_EXISTE_DETAIL
                     FROM TBRACCD B
                    WHERE     B.TBRACCD_PIDM = CARGO.PIDM
                          AND B.TBRACCD_TRAN_NUMBER = VL_NUMPAG;
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_EXISTE_DETAIL :=0;
                 END;

                 BEGIN

                   IF CF.SZVBAEC_CONCEPTO_PLAN_VEN <> VL_EXISTE_DETAIL THEN

                     BEGIN
                       SELECT COUNT (ZSTPARA_PARAM_VALOR)
                         INTO VL_EXIS_CONTRA_2
                         FROM ZSTPARA
                        WHERE ZSTPARA_MAPA_ID = 'DET_CODE_CART'
                              AND ZSTPARA_PARAM_ID = 'PARC_ANTERIOR'
                              AND ZSTPARA_PARAM_VALOR = SUBSTR(VL_EXISTE_DETAIL,3,2);
                     EXCEPTION
                     WHEN OTHERS THEN
                     VL_EXIS_CONTRA_2:=0;
                     END;

                     IF VL_EXIS_CONTRA_2 = 0 THEN

                       PKG_FINANZAS.P_DESAPLICA_PAGOS (CARGO.PIDM, CARGO.SECUENCIA) ;

                       DBMS_OUTPUT.PUT_LINE('cargo ' ||CARGO.MONTO ||'*'||CARGO.SECUENCIA ||'*'||CARGO.DESCUENTO );

                       VL_TRANSACCION :=0;
                       VL_PERIODO     := NULL;
                       VL_AJUSTA      := NULL;

                      /* VALIDACION EN VASE A LOS 20 DIAS DESPUES DE LA FECHA DE INICIO
                         ACTUALIZADO: JREZAOLI
                         FECHA: 04/09/2020  */

                       BEGIN
                         SELECT TO_NUMBER(ZSTPARA_PARAM_VALOR)
                           INTO VL_DIAS_AJUSTE
                           FROM ZSTPARA
                          WHERE     ZSTPARA_MAPA_ID = 'DIAS_BAJADT'
                                AND ZSTPARA_PARAM_ID = 'GENERAL';

                       END;

                       IF PN_ESTATUS IN ('BD','BT') THEN

                         IF LAST_DAY(TRUNC(SYSDATE)) > LAST_DAY(TRUNC(CARGO.FECHA_EFFECTIVA)) THEN
                           VL_AJUSTA:= 0;
                         ELSE

                           IF LAST_DAY(TRUNC(SYSDATE)) < LAST_DAY(TRUNC(CARGO.FECHA_EFFECTIVA)) THEN
                             VL_AJUSTA:= 1;
                           ELSE

                             IF LAST_DAY(TRUNC(SYSDATE)) = LAST_DAY(TRUNC(PN_FECHA_INICIO)) THEN

                               IF TRUNC(SYSDATE) <= TRUNC(PN_FECHA_INICIO)+VL_DIAS_AJUSTE THEN
                                 VL_AJUSTA:= 1;
                               ELSE
                                 VL_AJUSTA:= 0;
                               END IF;

                             ELSE

                               IF TRUNC(SYSDATE) <= TRUNC(TRUNC(SYSDATE)-(TO_CHAR(TRUNC(SYSDATE),'DD')-1))+VL_DIAS_AJUSTE THEN
                                 VL_AJUSTA:= 1;
                               ELSE
                                 VL_AJUSTA:= 0;
                               END IF;

                             END IF;

                           END IF;

                         END IF;

                       ELSE
                         VL_AJUSTA:= 1;
                       END IF;

                       IF VL_AJUSTA = 1 THEN

                           BEGIN
                              SELECT NVL(MAX(TBRACCD_TRAN_NUMBER),0) +1
                                INTO VL_TRANSACCION
                                FROM TBRACCD
                               WHERE TBRACCD_PIDM=CARGO.PIDM;
                           EXCEPTION
                           WHEN OTHERS THEN
                           VL_TRANSACCION:=0;
                           END;

                           BEGIN
                             INSERT
                               INTO TBRACCD
                             VALUES (
                                    CARGO.PIDM,   -- TBRACCD_PIDM
                                    VL_TRANSACCION,     --TBRACCD_TRAN_NUMBER
                                    CARGO.PERIODO,    -- TBRACCD_TERM_CODE
                                    CF.SZVBAEC_CONCEPTO_PLAN_VEN,--??vp_acceso_code,     ---TBRACCD_DETAIL_CODE
                                    USER,     ---TBRACCD_USER
                                    SYSDATE,     --TBRACCD_ENTRY_DATE
                                    NVL(CARGO.DESCUENTO,0),
                                    NVL(CARGO.DESCUENTO,0) * -1,    ---TBRACCD_BALANCE
                                    SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                                    NULL,    --TBRACCD_BILL_DATE
                                    NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                                    VL_DESCRIPCION,    -- TBRACCD_DESC
                                    CARGO.TBRACCD_RECEIPT_NUMBER,     --TBRACCD_RECEIPT_NUMBER
                                    CARGO.SECUENCIA,     --TBRACCD_TRAN_NUMBER_PAID
                                    NULL,     --TBRACCD_CROSSREF_PIDM
                                    NULL,    --TBRACCD_CROSSREF_NUMBER
                                    NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                                    'T',    --TBRACCD_SRCE_CODE
                                    'Y',    --TBRACCD_ACCT_FEED_IND
                                    SYSDATE,  --TBRACCD_ACTIVITY_DATE
                                    0,        --TBRACCD_SESSION_NUMBER
                                    NULL,    -- TBRACCD_CSHR_END_DATE
                                    NULL,     --TBRACCD_CRN
                                    NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                                    NULL,     -- TBRACCD_LOC_MDT
                                    NULL,     --TBRACCD_LOC_MDT_SEQ
                                    NULL,     -- TBRACCD_RATE
                                    NULL,     --TBRACCD_UNITS
                                    NULL,     -- TBRACCD_DOCUMENT_NUMBER
                                    SYSDATE,  -- TBRACCD_TRANS_DATE
                                    NULL,        -- TBRACCD_PAYMENT_ID
                                    NULL,     -- TBRACCD_INVOICE_NUMBER
                                    NULL,     -- TBRACCD_STATEMENT_DATE
                                    NULL,     -- TBRACCD_INV_NUMBER_PAID
                                    'MXN',     -- TBRACCD_CURR_CODE
                                    NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                                    NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                                    NULL,     -- TBRACCD_LATE_DCAT_CODE
                                    PN_FECHA_INICIO,     -- TBRACCD_FEED_DATE
                                    NULL,     -- TBRACCD_FEED_DOC_CODE
                                    NULL,     -- TBRACCD_ATYP_CODE
                                    NULL,     -- TBRACCD_ATYP_SEQNO
                                    NULL,     -- TBRACCD_CARD_TYPE_VR
                                    NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                                    NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                                    NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                                    NULL,     -- TBRACCD_ORIG_CHG_IND
                                    NULL,     -- TBRACCD_CCRD_CODE
                                    NULL,     -- TBRACCD_MERCHANT_ID
                                    NULL,     -- TBRACCD_TAX_REPT_YEAR
                                    NULL,     -- TBRACCD_TAX_REPT_BOX
                                    NULL,     -- TBRACCD_TAX_AMOUNT
                                    NULL,     -- TBRACCD_TAX_FUTURE_IND
                                    'AUTOMATICOp',     -- TBRACCD_DATA_ORIGIN
                                    'AUTOMATICOp',   -- TBRACCD_CREATE_SOURCE
                                    NULL,     -- TBRACCD_CPDT_IND
                                    NULL,     --TBRACCD_AIDY_CODE
                                    NVL(CARGO.TBRACCD_STSP_KEY_SEQUENCE , PN_KEYSEQNO),    --TBRACCD_STSP_KEY_SEQUENCE
                                    NVL(CARGO.TBRACCD_PERIOD ,VL_PARTE),     --TBRACCD_PERIOD
                                    NULL,    --TBRACCD_SURROGATE_ID
                                    NULL,     -- TBRACCD_VERSION
                                    USER,     --TBRACCD_USER_ID
                                    NULL );     --TBRACCD_VPDI_CODE
                                    
                                    DBMS_OUTPUT.PUT_LINE('Genera los cargos de Cargos '||CF.SZVBAEC_CONCEPTO_PLAN_VEN ||'*'||VL_TRANSACCION);
                                    
                           EXCEPTION
                           WHEN OTHERS THEN
                           VL_ERROR := 'Se presento el siguiente error al momento de insertar ajuste para planes vencidos en TBRACCD '||SQLERRM;
                           END;

                           BEGIN
                             SELECT COUNT(*)
                               INTO VL_PROMOCION
                               FROM TBRACCD
                              WHERE     TBRACCD_PIDM = CARGO.PIDM
                                    AND SUBSTR (TBRACCD_DETAIL_CODE,3,2) = 'M3'
                                    AND TBRACCD_TRAN_NUMBER_PAID = CARGO.SECUENCIA;
                           END;

                           IF VL_PROMOCION > 0 AND PN_ESTATUS NOT IN ('CC','CF') THEN

                             BEGIN
                               SELECT TBRACCD_AMOUNT,TBRACCD_TRAN_NUMBER,TBRACCD_EFFECTIVE_DATE,TBRACCD_TERM_CODE
                                 INTO VL_PROMOCION_MONTO,VL_PROMOCION_TRAN,VL_PROMOCION_VIG,VL_PROMOCION_PERIODO
                                 FROM TBRACCD
                                WHERE     TBRACCD_PIDM = CARGO.PIDM
                                      AND SUBSTR (TBRACCD_DETAIL_CODE,3,2) = 'M3'
                                      AND TBRACCD_TRAN_NUMBER_PAID = CARGO.SECUENCIA;
                             END;

                             IF VL_PROMOCION_VIG <= TRUNC(SYSDATE) THEN
                                  VL_PROMOCION_VIG:= TRUNC(SYSDATE);
                             ELSE
                                  VL_PROMOCION_VIG:=VL_PROMOCION_VIG;
                             END IF;

                             VL_APL_AJUSTE := PKG_FINANZAS.SP_APLICA_AJUSTE ( CARGO.PIDM,
                                                                              VL_PROMOCION_TRAN,
                                                                              SUBSTR(CARGO.PERIODO,1,2)||'ON',
                                                                              VL_PROMOCION_MONTO,
                                                                              VL_PROMOCION_PERIODO,
                                                                              'CANCELACION DE PROMOCION',
                                                                              SYSDATE,
                                                                              NULL,
                                                                              NULL,
                                                                              NULL,
                                                                              'SZFABCC');

                             BEGIN
                                UPDATE TBRACCD
                                   SET TBRACCD_DOCUMENT_NUMBER = 'SZFABCC'
                                 WHERE     TBRACCD_PIDM = CARGO.PIDM
                                       AND TBRACCD_DETAIL_CODE = SUBSTR(CARGO.PERIODO,1,2)||'ON'
                                       AND TBRACCD_USER = 'SZFABCC'
                                       AND TRUNC(TBRACCD_EFFECTIVE_DATE) = VL_PROMOCION_VIG;
                             EXCEPTION
                             WHEN OTHERS THEN
                             VL_ERROR :=' Errror al actualizar saldo Saldo>>  ' || SQLERRM ;
                             END;

                           END IF;

                           IF  CARGO.DESCUENTO = CARGO.MONTO THEN

                             BEGIN
                               UPDATE TBRACCD
                                  SET TBRACCD_DOCUMENT_NUMBER = 'SZFABCC'
                                WHERE     TBRACCD_PIDM = CARGO.PIDM
                                      AND TBRACCD_TRAN_NUMBER = VL_TRANSACCION;
                             EXCEPTION
                              WHEN OTHERS THEN
                                VL_ERROR :=' Errror al actualizar saldo Pago>>  ' || SQLERRM ;
                             END;

                             BEGIN
                               UPDATE TBRACCD
                                  SET TBRACCD_DOCUMENT_NUMBER = 'SZFABCC',
                                      TBRACCD_TRAN_NUMBER_PAID = NULL
                                WHERE     TBRACCD_PIDM = CARGO.PIDM
                                      AND TBRACCD_TRAN_NUMBER = CARGO.SECUENCIA;
                             EXCEPTION
                             WHEN OTHERS THEN
                             VL_ERROR :=' Errror al actualizar saldo Saldo>>  ' || SQLERRM ;
                             END;

                             BEGIN
                               UPDATE TBRACCD
                                  SET TBRACCD_TRAN_NUMBER_PAID = NULL
                                WHERE     TBRACCD_PIDM = CARGO.PIDM
                                      AND TBRACCD_TRAN_NUMBER_PAID = CARGO.SECUENCIA
                                      AND (TBRACCD_CREATE_SOURCE != 'CANCELA DINA' OR TBRACCD_CREATE_SOURCE IS NULL)
                                      AND TBRACCD_TRAN_NUMBER != VL_TRANSACCION;
                             EXCEPTION
                             WHEN OTHERS THEN
                             VL_ERROR :=' Errror al actualizar saldo Saldo>>  ' || SQLERRM ;
                             END;

                           END IF;
                       END IF;
                     END IF;
                   END IF;
                 END;
               END LOOP CARGO;
             END LOOP PLANES_VEN;
           END IF;

         ELSE
            
           DBMS_OUTPUT.PUT_LINE('Entra para hacer los ajustes por JORNADA');

           VL_DESCRIPCION := NULL;
           VL_PARCIAL_CODE := NULL;

           IF CF.SZVBAEC_AJUSTE_PARC_VEN = 'S' THEN

            DBMS_OUTPUT.PUT_LINE('XX1' ||CF.SZVBAEC_AJUSTE_PARC_VEN);

             BEGIN
               SELECT DISTINCT ZSTPARA_PARAM_VALOR
                 INTO VL_PARCIAL_CODE
                 FROM ZSTPARA
                WHERE ZSTPARA_MAPA_ID = 'CONFIGURA_BAJA' AND ZSTPARA_PARAM_ID = 'PARC_VEN_CARGO';
             EXCEPTION
             WHEN OTHERS THEN
               VL_PARCIAL_CODE := NULL;
             END;

             BEGIN
               SELECT DISTINCT TBBDETC_DESC
                 INTO VL_DESCRIPCION
                 FROM TBBDETC
                WHERE TBBDETC_DETAIL_CODE = CF.SZVBAEC_CONCEPTO_PARC_VEN;
             EXCEPTION
             WHEN OTHERS THEN
               VL_DESCRIPCION := NULL;
             END;
               ---------------------------------------------------------------------------------------------------------
               ------------------ valida que se tenga la categoria  correcta para parcialidades  -----------------------
               ---------------------------------------------------------------------------------------------------------
             IF VL_PARCIAL_CODE IS NOT NULL AND PN_ESTATUS != 'BA' THEN

               DBMS_OUTPUT.PUT_LINE('Entra 1***' ||PN_PIDM || '***'||VL_PARCIAL_CODE|| '***'||PN_FECHA_BAJA||'***'||PN_FECHA_INICIO||'***'||PN_FECHA_FIN);

               FOR PARCIAL IN (

                       SELECT B.TBRACCD_PIDM PIDM,
                              B.TBRACCD_AMOUNT MONTO,
                              B.TBRACCD_TRAN_NUMBER SECUENCIA,
                              (B.TBRACCD_AMOUNT- NVL((SELECT SUM(TBRACCD_AMOUNT)
                                                       FROM TBRACCD
                                                      WHERE     TBRACCD_PIDM = B.TBRACCD_PIDM
                                                            AND TBRACCD_CREATE_SOURCE = 'CANCELA DINA'
                                                            AND TBRACCD_TRAN_NUMBER_PAID = B.TBRACCD_TRAN_NUMBER
                                                            ),0))*(CF.SZVBAEC_PORCENT_PARC_VEN/100) DESCUENTO,
                              SPRIDEN_ID ID,
                              TBRACCD_STSP_KEY_SEQUENCE,
                              TBRACCD_PERIOD, --RLS20180131,
                              TBRACCD_TERM_CODE PERIODO,
                              TBRACCD_EFFECTIVE_DATE FECHA_EFFECTIVA,
                              TBRACCD_RECEIPT_NUMBER
                         FROM TBRACCD B, SPRIDEN
                        WHERE     B.TBRACCD_PIDM = PN_PIDM
                              AND B.TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                                              FROM TBBDETC
                                                             WHERE     TBBDETC_DCAT_CODE = VL_PARCIAL_CODE
                                                                   AND SUBSTR (TBBDETC_DETAIL_CODE,1,2)  = SUBSTR (B.TBRACCD_TERM_CODE,1,2)
                                                                   AND TBBDETC_DETC_ACTIVE_IND = 'Y' )
                              AND TRUNC(B.TBRACCD_EFFECTIVE_DATE) < (SELECT TRUNC(TO_DATE(PN_FECHA_BAJA))-(TO_NUMBER(TO_CHAR(TO_DATE(PN_FECHA_BAJA),'DD'))-1)FROM DUAL)
                              AND B.TBRACCD_EFFECTIVE_DATE >= PN_FECHA_INICIO
                              AND B.TBRACCD_PIDM = SPRIDEN_PIDM
                              AND SPRIDEN_CHANGE_IND IS NULL
                              AND TBRACCD_DOCUMENT_NUMBER IS NULL
                        ORDER BY B.TBRACCD_TRAN_NUMBER

               )LOOP

                 DBMS_OUTPUT.PUT_LINE('CURSOR***PARCIALIDADES VENCIDAS');

                     BEGIN
                       SELECT NVL(MAX(A1.TBRAPPL_PAY_TRAN_NUMBER),0)
                         INTO VL_NUMPAG
                         FROM TBRAPPL A1
                        WHERE A1.TBRAPPL_PIDM = PARCIAL.PIDM
                          AND A1.TBRAPPL_CHG_TRAN_NUMBER =  PARCIAL.SECUENCIA
                          AND A1.TBRAPPL_ACTIVITY_DATE = (SELECT MAX (A.TBRAPPL_ACTIVITY_DATE)
                                                           FROM TBRAPPL A
                                                          WHERE A.TBRAPPL_PIDM = A1.TBRAPPL_PIDM
                                                            AND A.TBRAPPL_CHG_TRAN_NUMBER =  A1.TBRAPPL_CHG_TRAN_NUMBER);
                     EXCEPTION
                     WHEN OTHERS THEN
                     VL_NUMPAG :=0;
                     END;

                 DBMS_OUTPUT.PUT_LINE(PARCIAL.PIDM||'-'||PARCIAL.SECUENCIA||'/'||VL_NUMPAG);

                     BEGIN
                       SELECT B.TBRACCD_DETAIL_CODE
                         INTO VL_EXISTE_DETAIL
                         FROM TBRACCD B
                        WHERE B.TBRACCD_PIDM = PARCIAL.PIDM
                          AND B.TBRACCD_TRAN_NUMBER = VL_NUMPAG;

                     EXCEPTION
                     WHEN OTHERS THEN
                     VL_EXISTE_DETAIL :=0;
                     END;

                 DBMS_OUTPUT.PUT_LINE(VL_EXISTE_DETAIL);

                 BEGIN
                  DBMS_OUTPUT.PUT_LINE(CF.SZVBAEC_CONCEPTO_PARC_VEN||'/'||VL_EXISTE_DETAIL);

                   IF CF.SZVBAEC_CONCEPTO_PARC_VEN <> VL_EXISTE_DETAIL THEN

                         BEGIN
                           SELECT COUNT (ZSTPARA_PARAM_VALOR)
                             INTO VL_EXIS_CONTRA_2
                             FROM ZSTPARA
                            WHERE     ZSTPARA_MAPA_ID = 'DET_CODE_CART'
                                  AND ZSTPARA_PARAM_ID = 'PARC_ANTERIOR'
                                  AND ZSTPARA_PARAM_VALOR = SUBSTR(VL_EXISTE_DETAIL,3,2);
                         EXCEPTION
                         WHEN OTHERS THEN
                         VL_EXIS_CONTRA_2:=0;
                         END;

                     IF VL_EXIS_CONTRA_2 = 0 THEN

                       DBMS_OUTPUT.PUT_LINE(CF.SZVBAEC_CONCEPTO_PARC_VEN||'/'||VL_EXISTE_DETAIL);

                       VL_TRANSACCION :=0;
                       VL_PERIODO     := NULL;
                       VL_AJUSTA      := NULL;

                       BEGIN
                         SELECT TO_NUMBER(ZSTPARA_PARAM_VALOR)
                           INTO VL_DIAS_AJUSTE
                           FROM ZSTPARA
                          WHERE     ZSTPARA_MAPA_ID = 'DIAS_BAJADT'
                                AND ZSTPARA_PARAM_ID = 'GENERAL';

                       END;

                       IF PN_ESTATUS IN ('BD','BT') THEN

                         IF LAST_DAY(TRUNC(SYSDATE)) > LAST_DAY(TRUNC(PARCIAL.FECHA_EFFECTIVA)) THEN
                           VL_AJUSTA:= 0;
                         ELSE

                           IF LAST_DAY(TRUNC(SYSDATE)) < LAST_DAY(TRUNC(PARCIAL.FECHA_EFFECTIVA)) THEN
                             VL_AJUSTA:= 1;
                           ELSE

                             IF LAST_DAY(TRUNC(SYSDATE)) = LAST_DAY(TRUNC(PN_FECHA_INICIO)) THEN

                               IF TRUNC(SYSDATE) <= TRUNC(PN_FECHA_INICIO)+VL_DIAS_AJUSTE THEN
                                 VL_AJUSTA:= 1;
                               ELSE
                                 VL_AJUSTA:= 0;
                               END IF;

                             ELSE

                               IF TRUNC(SYSDATE) <= TRUNC(TRUNC(SYSDATE)-(TO_CHAR(TRUNC(SYSDATE),'DD')-1))+VL_DIAS_AJUSTE THEN
                                 VL_AJUSTA:= 1;
                               ELSE
                                 VL_AJUSTA:= 0;
                               END IF;

                             END IF;

                           END IF;

                         END IF;

                       ELSE
                         VL_AJUSTA:= 1;
                       END IF;

                       IF VL_AJUSTA = 1 THEN

                           VL_CAN_BECA:= PKG_FINANZAS_REZA.F_AJ_CAN_BECA ( PN_PIDM,
                                                                           PARCIAL.SECUENCIA,
                                                                           PN_FECHA_INICIO,
                                                                           'CANCELACION');

                           BEGIN
                             SELECT NVL(MAX(TBRACCD_TRAN_NUMBER),0) +1
                               INTO VL_TRANSACCION
                               FROM TBRACCD
                              WHERE TBRACCD_PIDM=PARCIAL.PIDM;
                           EXCEPTION
                           WHEN OTHERS THEN
                           VL_TRANSACCION:=0;
                           END;

                           BEGIN
                             SELECT FGET_PERIODO_GENERAL(SUBSTR(PARCIAL.ID,1,2))
                               INTO VL_PERIODO
                               FROM DUAL;
                           EXCEPTION
                           WHEN OTHERS THEN
                           VL_PERIODO := '000000';
                           END;

                           DBMS_OUTPUT.PUT_LINE(VL_PERIODO||'<<<<'||PARCIAL.ID);

                           PKG_FINANZAS.P_DESAPLICA_PAGOS (PARCIAL.PIDM, PARCIAL.SECUENCIA) ;

                           DBMS_OUTPUT.PUT_LINE('entra desaplica pagos');

                           BEGIN
                             INSERT
                               INTO TBRACCD
                             VALUES (
                                        PARCIAL.PIDM,   -- TBRACCD_PIDM
                                        VL_TRANSACCION,     --TBRACCD_TRAN_NUMBER
                                        PARCIAL.PERIODO,    -- TBRACCD_TERM_CODE
                                        CF.SZVBAEC_CONCEPTO_PARC_VEN,--vp_parcial_code,     ---TBRACCD_DETAIL_CODE
                                        USER,     ---TBRACCD_USER
                                        SYSDATE,     --TBRACCD_ENTRY_DATE
                                        NVL(PARCIAL.DESCUENTO,0),
                                        NVL(PARCIAL.DESCUENTO,0) * -1,    ---TBRACCD_BALANCE
                                        SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                                        NULL,    --TBRACCD_BILL_DATE
                                        NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                                        VL_DESCRIPCION,    -- TBRACCD_DESC
                                        PARCIAL.TBRACCD_RECEIPT_NUMBER,     --TBRACCD_RECEIPT_NUMBER
                                        PARCIAL.SECUENCIA,     --TBRACCD_TRAN_NUMBER_PAID
                                        NULL,     --TBRACCD_CROSSREF_PIDM
                                        NULL,    --TBRACCD_CROSSREF_NUMBER
                                        NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                                        'T',    --TBRACCD_SRCE_CODE
                                        'Y',    --TBRACCD_ACCT_FEED_IND
                                        SYSDATE,  --TBRACCD_ACTIVITY_DATE
                                        0,        --TBRACCD_SESSION_NUMBER
                                        NULL,    -- TBRACCD_CSHR_END_DATE
                                        NULL,     --TBRACCD_CRN
                                        NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                                        NULL,     -- TBRACCD_LOC_MDT
                                        NULL,     --TBRACCD_LOC_MDT_SEQ
                                        NULL,     -- TBRACCD_RATE
                                        NULL,     --TBRACCD_UNITS
                                        NULL,     -- TBRACCD_DOCUMENT_NUMBER
                                        SYSDATE,  -- TBRACCD_TRANS_DATE
                                        NULL,        -- TBRACCD_PAYMENT_ID
                                        NULL,     -- TBRACCD_INVOICE_NUMBER
                                        NULL,     -- TBRACCD_STATEMENT_DATE
                                        NULL,     -- TBRACCD_INV_NUMBER_PAID
                                        'MXN',     -- TBRACCD_CURR_CODE
                                        NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                                        NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                                        NULL,     -- TBRACCD_LATE_DCAT_CODE
                                        PN_FECHA_INICIO,     -- TBRACCD_FEED_DATE
                                        NULL,     -- TBRACCD_FEED_DOC_CODE
                                        NULL,     -- TBRACCD_ATYP_CODE
                                        NULL,     -- TBRACCD_ATYP_SEQNO
                                        NULL,     -- TBRACCD_CARD_TYPE_VR
                                        NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                                        NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                                        NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                                        NULL,     -- TBRACCD_ORIG_CHG_IND
                                        NULL,     -- TBRACCD_CCRD_CODE
                                        NULL,     -- TBRACCD_MERCHANT_ID
                                        NULL,     -- TBRACCD_TAX_REPT_YEAR
                                        NULL,     -- TBRACCD_TAX_REPT_BOX
                                        NULL,     -- TBRACCD_TAX_AMOUNT
                                        NULL,     -- TBRACCD_TAX_FUTURE_IND
                                        'AUTOMATICOa',     -- TBRACCD_DATA_ORIGIN
                                        'AUTOMATICOa',   -- TBRACCD_CREATE_SOURCE
                                        NULL,     -- TBRACCD_CPDT_IND
                                        NULL,     --TBRACCD_AIDY_CODE
                                        NVL (PARCIAL.TBRACCD_STSP_KEY_SEQUENCE,PN_KEYSEQNO),     --TBRACCD_STSP_KEY_SEQUENCE
                                        NVL (PARCIAL.TBRACCD_PERIOD,VL_PARTE),     --TBRACCD_PERIOD
                                        NULL,    --TBRACCD_SURROGATE_ID
                                        NULL,     -- TBRACCD_VERSION
                                        USER,     --TBRACCD_USER_ID
                                        NULL );     --TBRACCD_VPDI_CODE

                           EXCEPTION
                           WHEN OTHERS THEN
                           VL_ERROR := 'Se presento el siguiente error al momento de insertar ajuste para Parcialidad en TBRACCD '||SQLERRM;
                           END;

                          DBMS_OUTPUT.PUT_LINE('EXITO TBRACCD PRCIALIDADES VENCIDAS');

                           BEGIN
                             SELECT COUNT(*)
                               INTO VL_PROMOCION
                               FROM TBRACCD
                              WHERE     TBRACCD_PIDM = PARCIAL.PIDM
                                    AND SUBSTR (TBRACCD_DETAIL_CODE,3,2) = 'M3'
                                    AND TBRACCD_TRAN_NUMBER_PAID = PARCIAL.SECUENCIA;
                           END;

                           IF VL_PROMOCION > 0 AND PN_ESTATUS NOT IN ('CC','CF') THEN

                             BEGIN
                               SELECT TBRACCD_AMOUNT,TBRACCD_TRAN_NUMBER,TBRACCD_EFFECTIVE_DATE,TBRACCD_TERM_CODE
                                 INTO VL_PROMOCION_MONTO,VL_PROMOCION_TRAN,VL_PROMOCION_VIG,VL_PROMOCION_PERIODO
                                 FROM TBRACCD
                                WHERE     TBRACCD_PIDM = PARCIAL.PIDM
                                      AND SUBSTR (TBRACCD_DETAIL_CODE,3,2) = 'M3'
                                      AND TBRACCD_TRAN_NUMBER_PAID = PARCIAL.SECUENCIA;
                             END;

                             IF VL_PROMOCION_VIG <= TRUNC(SYSDATE) THEN
                                 VL_PROMOCION_VIG:= TRUNC(SYSDATE);
                             ELSE
                                 VL_PROMOCION_VIG:=VL_PROMOCION_VIG;
                             END IF;

                             VL_APL_AJUSTE:= PKG_FINANZAS.SP_APLICA_AJUSTE ( PARCIAL.PIDM,
                                                                             VL_PROMOCION_TRAN,
                                                                             SUBSTR(PARCIAL.PERIODO,1,2)||'ON',
                                                                             VL_PROMOCION_MONTO,
                                                                             VL_PROMOCION_PERIODO,
                                                                             'CANCELACION DE PROMOCION',
                                                                             SYSDATE,
                                                                             NULL,
                                                                             NULL,
                                                                             NULL,
                                                                             'SZFABCC');

                             BEGIN
                               UPDATE TBRACCD
                                  SET TBRACCD_DOCUMENT_NUMBER = 'SZFABCC'
                                WHERE     TBRACCD_PIDM = PARCIAL.PIDM
                                      AND TBRACCD_DETAIL_CODE = SUBSTR(PARCIAL.PERIODO,1,2)||'ON'
                                      AND TBRACCD_USER = 'SZFABCC'
                                      AND TRUNC(TBRACCD_EFFECTIVE_DATE) = VL_PROMOCION_VIG;
                             EXCEPTION
                             WHEN OTHERS THEN
                              VL_ERROR :=' Errror al actualizar saldo Saldo>>  ' || SQLERRM ;
                             END;

                           END IF;

                           IF  PARCIAL.DESCUENTO = PARCIAL.MONTO THEN

                             BEGIN
                               UPDATE TBRACCD
                                  SET TBRACCD_DOCUMENT_NUMBER = 'SZFABCC'
                                WHERE     TBRACCD_PIDM = PARCIAL.PIDM
                                      AND TBRACCD_TRAN_NUMBER = VL_TRANSACCION;
                             END;

                             BEGIN
                               UPDATE TBRACCD
                                  SET TBRACCD_DOCUMENT_NUMBER = 'SZFABCC',
                                      TBRACCD_TRAN_NUMBER_PAID = NULL
                                WHERE     TBRACCD_PIDM = PARCIAL.PIDM
                                      AND TBRACCD_TRAN_NUMBER = PARCIAL.SECUENCIA;
                             END;

                             BEGIN
                               UPDATE TBRACCD
                                  SET TBRACCD_TRAN_NUMBER_PAID = NULL
                                WHERE     TBRACCD_PIDM = PARCIAL.PIDM
                                      AND TBRACCD_TRAN_NUMBER_PAID = PARCIAL.SECUENCIA
                                      AND (TBRACCD_CREATE_SOURCE != 'CANCELA DINA' OR TBRACCD_CREATE_SOURCE IS NULL)
                                      AND TBRACCD_TRAN_NUMBER != VL_TRANSACCION;
                             END;

                           END IF;

                       END IF;
                     END IF;
                   END IF;
                 END;
               END LOOP PARCIAL;
             END IF;
           END IF;
         END IF;
         ---------------------------------------------------------------------------------------------------------
         --------------------------------- Proceso de Parcialidades POR VENCER------------------------------------
         ---------------------------------------------------------------------------------------------------------
         IF VL_RATE = 'P' THEN

           IF CF.SZVBAEC_AJUSTE_PLAN_XVEN = 'S' AND PN_ESTATUS != 'BA' THEN

             BEGIN
               SELECT DISTINCT TBBDETC_DESC
                 INTO VL_DESCRIPCION
                 FROM TBBDETC
                WHERE TBBDETC_DETAIL_CODE = CF.SZVBAEC_CONCEPTO_PLAN_XVEN;--??vP_acceso_code;
             EXCEPTION
             WHEN OTHERS THEN
             VL_DESCRIPCION := NULL;
             END;

              FOR PLANES_XVEN IN (
                                  SELECT DISTINCT ZSTPARA_PARAM_VALOR CATEGORIA
                                    FROM ZSTPARA
                                   WHERE ZSTPARA_MAPA_ID = 'CONFIGURA_BAJA' AND ZSTPARA_PARAM_ID = 'PLAN_XVEN_CARGO'
             )LOOP
              ---------------------------------------------------------------------------------------------------------
              ------------------ valida que se tenga la categoria correcta para Planes Por Vencer ---------------------
              ---------------------------------------------------------------------------------------------------------
                FOR CARGO IN (
                                  SELECT  B.TBRACCD_PIDM PIDM,
                                          B.TBRACCD_AMOUNT MONTO,
                                          B.TBRACCD_TRAN_NUMBER SECUENCIA,
                                          (B.TBRACCD_AMOUNT- NVL((SELECT SUM(TBRACCD_AMOUNT)
                                                       FROM TBRACCD
                                                      WHERE     TBRACCD_PIDM = B.TBRACCD_PIDM
                                                            AND TBRACCD_CREATE_SOURCE = 'CANCELA DINA'
                                                            AND TBRACCD_TRAN_NUMBER_PAID = B.TBRACCD_TRAN_NUMBER
                                                            ),0))*(CF.SZVBAEC_PORCENT_PLAN_XVEN/100) DESCUENTO,
                                          SPRIDEN_ID ID,
                                          TBRACCD_STSP_KEY_SEQUENCE ,
                                          TBRACCD_PERIOD, --RLS20180131
                                          TBRACCD_TERM_CODE PERIODO,
                                          TBRACCD_EFFECTIVE_DATE FECHA_EFFECTIVA,
                                          TBRACCD_RECEIPT_NUMBER
                                    FROM TBRACCD B, SPRIDEN
                                   WHERE     B.TBRACCD_PIDM = PN_PIDM
                                         AND B.TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                                                         FROM TBBDETC
                                                                        WHERE     TBBDETC_DCAT_CODE = PLANES_XVEN.CATEGORIA
                                                                              AND SUBSTR (TBBDETC_DETAIL_CODE,1,2) = SUBSTR (B.TBRACCD_TERM_CODE,1,2)
                                                                              AND TBBDETC_DETC_ACTIVE_IND = 'Y')
                                         AND TRUNC(B.TBRACCD_EFFECTIVE_DATE) >= TO_DATE('01'||SUBSTR(PN_FECHA_BAJA,3,10))
                                         AND B.TBRACCD_TRAN_NUMBER NOT IN (SELECT TBRAPPL_PAY_TRAN_NUMBER
                                                                             FROM TBRAPPL
                                                                            WHERE     TBRAPPL_PIDM = B.TBRACCD_PIDM
                                                                                  AND TBRAPPL_REAPPL_IND IS NULL)
                                         AND TRUNC(B.TBRACCD_ENTRY_DATE) = (SELECT MAX(TRUNC(A2.TBRACCD_ENTRY_DATE))
                                                                              FROM TBRACCD A2
                                                                             WHERE     A2.TBRACCD_PIDM = B.TBRACCD_PIDM
                                                                                   AND A2.TBRACCD_DETAIL_CODE = B.TBRACCD_DETAIL_CODE)
                                         AND B.TBRACCD_PIDM = SPRIDEN_PIDM
                                         AND SPRIDEN_CHANGE_IND IS NULL
                                   ORDER BY B.TBRACCD_TRAN_NUMBER

               ) LOOP
                  DBMS_OUTPUT.PUT_LINE('POR VENCER PLAN'||'---'||'CURSOR');

                 BEGIN
                   SELECT NVL(MAX(A1.TBRAPPL_PAY_TRAN_NUMBER),0)
                     INTO VL_NUMPAG
                     FROM TBRAPPL A1
                    WHERE     A1.TBRAPPL_PIDM = CARGO.PIDM
                          AND A1.TBRAPPL_CHG_TRAN_NUMBER =  CARGO.SECUENCIA
                          AND A1.TBRAPPL_ACTIVITY_DATE = (SELECT MAX (A.TBRAPPL_ACTIVITY_DATE)
                                                            FROM TBRAPPL A
                                                           WHERE     A.TBRAPPL_PIDM = A1.TBRAPPL_PIDM
                                                                 AND A.TBRAPPL_CHG_TRAN_NUMBER =  A1.TBRAPPL_CHG_TRAN_NUMBER);
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_NUMPAG :=0;
                 END;

                 DBMS_OUTPUT.PUT_LINE('POR VENCER PLAN 1'||'---'||VL_NUMPAG);

                 BEGIN
                   SELECT B.TBRACCD_DETAIL_CODE
                     INTO VL_EXISTE_DETAIL
                     FROM TBRACCD B
                    WHERE     B.TBRACCD_PIDM = CARGO.PIDM
                          AND B.TBRACCD_TRAN_NUMBER = VL_NUMPAG;
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_EXISTE_DETAIL :=0;
                 END;

                 DBMS_OUTPUT.PUT_LINE('POR VENCER PLAN 2'||'---'||VL_EXISTE_DETAIL);

                 BEGIN

                   DBMS_OUTPUT.PUT_LINE('ENTRA POR VENCER PLAN'||CF.SZVBAEC_CONCEPTO_PLAN_XVEN||'***'||VL_EXISTE_DETAIL);

                   IF CF.SZVBAEC_CONCEPTO_PLAN_XVEN <> VL_EXISTE_DETAIL THEN

                     BEGIN
                       SELECT COUNT (ZSTPARA_PARAM_VALOR)
                         INTO VL_EXIS_CONTRA_2
                         FROM ZSTPARA
                        WHERE     ZSTPARA_MAPA_ID = 'DET_CODE_CART'
                              AND ZSTPARA_PARAM_ID = 'PARC_ANTERIOR'
                              AND ZSTPARA_PARAM_VALOR = SUBSTR(VL_EXISTE_DETAIL,3,2);
                     EXCEPTION
                     WHEN OTHERS THEN
                     VL_EXIS_CONTRA_2:=0;
                     END;

                     IF VL_EXIS_CONTRA_2 = 0 THEN
                       DBMS_OUTPUT.PUT_LINE('ENTRA POR VENCER PLAN 2'||CF.SZVBAEC_CONCEPTO_PLAN_XVEN||'***'||VL_EXISTE_DETAIL);

                       VL_TRANSACCION :=0;
                       VL_PERIODO     := NULL;
                       VL_AJUSTA      :=NULL;

                       BEGIN
                         SELECT TO_NUMBER(ZSTPARA_PARAM_VALOR)
                           INTO VL_DIAS_AJUSTE
                           FROM ZSTPARA
                          WHERE     ZSTPARA_MAPA_ID = 'DIAS_BAJADT'
                                AND ZSTPARA_PARAM_ID = 'GENERAL';

                       END;

                       IF PN_ESTATUS IN ('BD','BT') THEN

                         IF LAST_DAY(TRUNC(SYSDATE)) > LAST_DAY(TRUNC(CARGO.FECHA_EFFECTIVA)) THEN
                           VL_AJUSTA:= 0;
                         ELSE

                           IF LAST_DAY(TRUNC(SYSDATE)) < LAST_DAY(TRUNC(CARGO.FECHA_EFFECTIVA)) THEN
                             VL_AJUSTA:= 1;
                           ELSE

                             IF LAST_DAY(TRUNC(SYSDATE)) = LAST_DAY(TRUNC(PN_FECHA_INICIO)) THEN

                               IF TRUNC(SYSDATE) <= TRUNC(PN_FECHA_INICIO)+VL_DIAS_AJUSTE THEN
                                 VL_AJUSTA:= 1;
                               ELSE
                                 VL_AJUSTA:= 0;
                               END IF;

                             ELSE

                               IF TRUNC(SYSDATE) <= TRUNC(TRUNC(SYSDATE)-(TO_CHAR(TRUNC(SYSDATE),'DD')-1))+VL_DIAS_AJUSTE THEN
                                 VL_AJUSTA:= 1;
                               ELSE
                                 VL_AJUSTA:= 0;
                               END IF;

                             END IF;

                           END IF;

                         END IF;

                       ELSE
                         VL_AJUSTA:= 1;
                       END IF;

                       IF VL_AJUSTA = 1 THEN

                           BEGIN
                              SELECT NVL(MAX(TBRACCD_TRAN_NUMBER),0) +1
                                INTO VL_TRANSACCION
                                FROM TBRACCD
                               WHERE TBRACCD_PIDM=CARGO.PIDM;
                           EXCEPTION
                           WHEN OTHERS THEN
                           VL_TRANSACCION:=0;
                           END;

                           BEGIN
                             SELECT FGET_PERIODO_GENERAL(SUBSTR(CARGO.ID,1,2))
                               INTO VL_PERIODO
                               FROM DUAL;
                           EXCEPTION
                           WHEN OTHERS THEN
                           VL_PERIODO := '000000';
                           END;

                           BEGIN
                             INSERT
                               INTO TBRACCD
                             VALUES (
                                      CARGO.PIDM,   -- TBRACCD_PIDM
                                      VL_TRANSACCION,     --TBRACCD_TRAN_NUMBER
                                      CARGO.PERIODO,    -- TBRACCD_TERM_CODE
                                      CF.SZVBAEC_CONCEPTO_PLAN_XVEN,--??vp_acceso_code,     ---TBRACCD_DETAIL_CODE
                                      USER,     ---TBRACCD_USER
                                      SYSDATE,     --TBRACCD_ENTRY_DATE
                                      NVL(CARGO.DESCUENTO,0),
                                      NVL(CARGO.DESCUENTO,0) * -1,    ---TBRACCD_BALANCE
                                      SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                                      NULL,    --TBRACCD_BILL_DATE
                                      NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                                      VL_DESCRIPCION,    -- TBRACCD_DESC
                                      CARGO.TBRACCD_RECEIPT_NUMBER,     --TBRACCD_RECEIPT_NUMBER
                                      CARGO.SECUENCIA,     --TBRACCD_TRAN_NUMBER_PAID
                                      NULL,     --TBRACCD_CROSSREF_PIDM
                                      NULL,    --TBRACCD_CROSSREF_NUMBER
                                      NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                                      'T',    --TBRACCD_SRCE_CODE
                                      'Y',    --TBRACCD_ACCT_FEED_IND
                                      SYSDATE,  --TBRACCD_ACTIVITY_DATE
                                      0,        --TBRACCD_SESSION_NUMBER
                                      NULL,    -- TBRACCD_CSHR_END_DATE
                                      NULL,     --TBRACCD_CRN
                                      NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                                      NULL,     -- TBRACCD_LOC_MDT
                                      NULL,     --TBRACCD_LOC_MDT_SEQ
                                      NULL,     -- TBRACCD_RATE
                                      NULL,     --TBRACCD_UNITS
                                      NULL,     -- TBRACCD_DOCUMENT_NUMBER
                                      SYSDATE,  -- TBRACCD_TRANS_DATE
                                      NULL,        -- TBRACCD_PAYMENT_ID
                                      NULL,     -- TBRACCD_INVOICE_NUMBER
                                      NULL,     -- TBRACCD_STATEMENT_DATE
                                      NULL,     -- TBRACCD_INV_NUMBER_PAID
                                      'MXN',     -- TBRACCD_CURR_CODE
                                      NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                                      NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                                      NULL,     -- TBRACCD_LATE_DCAT_CODE
                                      PN_FECHA_INICIO,     -- TBRACCD_FEED_DATE
                                      NULL,     -- TBRACCD_FEED_DOC_CODE
                                      NULL,     -- TBRACCD_ATYP_CODE
                                      NULL,     -- TBRACCD_ATYP_SEQNO
                                      NULL,     -- TBRACCD_CARD_TYPE_VR
                                      NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                                      NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                                      NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                                      NULL,     -- TBRACCD_ORIG_CHG_IND
                                      NULL,     -- TBRACCD_CCRD_CODE
                                      NULL,     -- TBRACCD_MERCHANT_ID
                                      NULL,     -- TBRACCD_TAX_REPT_YEAR
                                      NULL,     -- TBRACCD_TAX_REPT_BOX
                                      NULL,     -- TBRACCD_TAX_AMOUNT
                                      NULL,     -- TBRACCD_TAX_FUTURE_IND
                                      'AUTOMATICOb',     -- TBRACCD_DATA_ORIGIN
                                      'AUTOMATICOb',   -- TBRACCD_CREATE_SOURCE
                                      NULL,     -- TBRACCD_CPDT_IND
                                      NULL,     --TBRACCD_AIDY_CODE
                                      NVL(CARGO.TBRACCD_STSP_KEY_SEQUENCE ,PN_KEYSEQNO),     --TBRACCD_STSP_KEY_SEQUENCE
                                      NVL(CARGO.TBRACCD_PERIOD , VL_PARTE),     --TBRACCD_PERIOD
                                      NULL,    --TBRACCD_SURROGATE_ID
                                      NULL,     -- TBRACCD_VERSION
                                      USER,     --TBRACCD_USER_ID
                                      NULL );     --TBRACCD_VPDI_CODE
                           EXCEPTION
                           WHEN OTHERS THEN
                           VL_ERROR := 'Se presento el siguiente error al momento de insertar ajuste para Planes en TBRACCD '||SQLERRM;
                           END;

                           BEGIN
                             SELECT COUNT(*)
                               INTO VL_PROMOCION
                               FROM TBRACCD
                              WHERE     TBRACCD_PIDM = CARGO.PIDM
                                    AND SUBSTR (TBRACCD_DETAIL_CODE,3,2) = 'M3'
                                    AND TBRACCD_TRAN_NUMBER_PAID = CARGO.SECUENCIA;
                           END;

                           IF VL_PROMOCION > 0 AND PN_ESTATUS NOT IN ('CC','CF') THEN

                             BEGIN
                               SELECT TBRACCD_AMOUNT,TBRACCD_TRAN_NUMBER,TBRACCD_EFFECTIVE_DATE,TBRACCD_TERM_CODE
                                 INTO VL_PROMOCION_MONTO,VL_PROMOCION_TRAN,VL_PROMOCION_VIG,VL_PROMOCION_PERIODO
                                 FROM TBRACCD
                                WHERE     TBRACCD_PIDM = CARGO.PIDM
                                      AND SUBSTR (TBRACCD_DETAIL_CODE,3,2) = 'M3'
                                      AND TBRACCD_TRAN_NUMBER_PAID = CARGO.SECUENCIA;
                             END;

                             IF VL_PROMOCION_VIG <= TRUNC(SYSDATE) THEN
                                  VL_PROMOCION_VIG:= TRUNC(SYSDATE);
                             ELSE
                                  VL_PROMOCION_VIG:=VL_PROMOCION_VIG;
                             END IF;

                              VL_APL_AJUSTE:= PKG_FINANZAS.SP_APLICA_AJUSTE ( CARGO.PIDM,
                                                                              VL_PROMOCION_TRAN,
                                                                              SUBSTR(CARGO.PERIODO,1,2)||'ON',
                                                                              VL_PROMOCION_MONTO,
                                                                              VL_PROMOCION_PERIODO,
                                                                              'CANCELACION DE PROMOCION',
                                                                              SYSDATE,
                                                                              NULL,
                                                                              NULL,
                                                                              NULL,
                                                                              'SZFABCC');

                             BEGIN
                               UPDATE TBRACCD
                                  SET TBRACCD_DOCUMENT_NUMBER = 'SZFABCC'
                                WHERE     TBRACCD_PIDM = CARGO.PIDM
                                      AND TBRACCD_DETAIL_CODE = SUBSTR(CARGO.PERIODO,1,2)||'ON'
                                      AND TBRACCD_USER = 'SZFABCC'
                                       AND TRUNC(TBRACCD_EFFECTIVE_DATE) = VL_PROMOCION_VIG;

                             EXCEPTION
                             WHEN OTHERS THEN
                             VL_ERROR :=' Errror al actualizar saldo Saldo>>  ' || SQLERRM ;
                             END;

                           END IF;

                           IF CARGO.DESCUENTO = CARGO.MONTO THEN

                             BEGIN
                               UPDATE TBRACCD
                                  SET TBRACCD_DOCUMENT_NUMBER = 'SZFABCC'
                                WHERE     TBRACCD_PIDM = CARGO.PIDM
                                      AND TBRACCD_TRAN_NUMBER = VL_TRANSACCION;
                             END;

                              BEGIN
                                UPDATE TBRACCD
                                   SET TBRACCD_DOCUMENT_NUMBER = 'SZFABCC',
                                       TBRACCD_TRAN_NUMBER_PAID = NULL
                                 WHERE     TBRACCD_PIDM = CARGO.PIDM
                                       AND TBRACCD_TRAN_NUMBER = CARGO.SECUENCIA;
                              END;

                              BEGIN
                                 UPDATE TBRACCD
                                    SET TBRACCD_TRAN_NUMBER_PAID = NULL
                                  WHERE     TBRACCD_PIDM = CARGO.PIDM
                                        AND TBRACCD_TRAN_NUMBER_PAID = CARGO.SECUENCIA
                                        AND (TBRACCD_CREATE_SOURCE != 'CANCELA DINA' OR TBRACCD_CREATE_SOURCE IS NULL)
                                        AND TBRACCD_TRAN_NUMBER != VL_TRANSACCION;
                              END;

                           END IF;
                       END IF;
                     END IF;
                   END IF;
                 END;
               END LOOP CARGO;
             END LOOP PLANES_XVEN;
           END IF;

         ELSE
             DBMS_OUTPUT.PUT_LINE('Entra para hacer los Ajustes por JORNADA Bloque 2');

           VL_DESCRIPCION := NULL;
           VL_PARCIAL_CODE := NULL;

           DBMS_OUTPUT.PUT_LINE(CF.SZVBAEC_AJUSTE_PARC_XVEN);

           IF CF.SZVBAEC_AJUSTE_PARC_XVEN = 'S' THEN

             BEGIN
                 SELECT DISTINCT ZSTPARA_PARAM_VALOR
                     INTO VL_PARCIAL_CODE
                 FROM ZSTPARA
                 WHERE ZSTPARA_MAPA_ID = 'CONFIGURA_BAJA'
                 AND ZSTPARA_PARAM_ID = 'PARC_XVEN_CARGO';
             EXCEPTION
             WHEN OTHERS THEN
               VL_PARCIAL_CODE := NULL;
             END;

             DBMS_OUTPUT.PUT_LINE(VL_PARCIAL_CODE);


             BEGIN
                     SELECT DISTINCT TBBDETC_DESC
                         INTO VL_DESCRIPCION
                     FROM TBBDETC
                     WHERE TBBDETC_DETAIL_CODE = CF.SZVBAEC_CONCEPTO_PARC_XVEN;--vp_parcial_code;
             EXCEPTION
             WHEN OTHERS THEN
               VL_DESCRIPCION := NULL;
             END;
             ---------------------------------------------------------------------------------------------------------
             ------------------ valida que se tenga la categoria  correcta para parcialidades  -----------------------
             ---------------------------------------------------------------------------------------------------------
             IF VL_PARCIAL_CODE IS NOT NULL AND PN_ESTATUS != 'BA' THEN  
                DBMS_OUTPUT.PUT_LINE('ENTRA POR VENCER JORNADA ' ||PN_PIDM || '*'||VL_PARCIAL_CODE|| '*'||PN_NIVEL||'*'||PN_PERIODO||'*'||PN_FECHA_BAJA);

                FOR PARCIAL IN (

                          SELECT  B.TBRACCD_PIDM PIDM,
                                  B.TBRACCD_AMOUNT- NVL((SELECT NVL(SUM(TBRACCD_AMOUNT),0)
                                                       FROM TBRACCD
                                                      WHERE     TBRACCD_PIDM = B.TBRACCD_PIDM
                                                            AND TBRACCD_CREATE_SOURCE = 'CANCELA DINA'
                                                            AND TBRACCD_TRAN_NUMBER_PAID = B.TBRACCD_TRAN_NUMBER
                                                            ),0) MONTO,
                                  B.TBRACCD_TRAN_NUMBER SECUENCIA,
                                  (B.TBRACCD_AMOUNT- NVL((SELECT NVL(SUM(TBRACCD_AMOUNT),0)
                                                       FROM TBRACCD
                                                      WHERE     TBRACCD_PIDM = B.TBRACCD_PIDM
                                                            AND TBRACCD_CREATE_SOURCE = 'CANCELA DINA'
                                                            AND TBRACCD_TRAN_NUMBER_PAID = B.TBRACCD_TRAN_NUMBER
                                                            ),0))*(CF.SZVBAEC_PORCENT_PARC_XVEN/100) DESCUENTO,
                                  SPRIDEN_ID ID,
                                  TBRACCD_EFFECTIVE_DATE,
                                  TBRACCD_STSP_KEY_SEQUENCE,
                                  TBRACCD_PERIOD, --RLS20180131
                                  TBRACCD_TERM_CODE PERIODO,
                                  TBRACCD_EFFECTIVE_DATE FECHA_EFFECTIVA,
                                  TBRACCD_RECEIPT_NUMBER
                            FROM TBRACCD B, SPRIDEN
                           WHERE     B.TBRACCD_PIDM = PN_PIDM
                                 AND B.TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                                                 FROM TBBDETC
                                                                WHERE     TBBDETC_DCAT_CODE = VL_PARCIAL_CODE
                                                                      AND SUBSTR (TBBDETC_DETAIL_CODE, 1, 2 )  = SUBSTR (B.TBRACCD_TERM_CODE, 1, 2)
                                                                      AND TBBDETC_DETC_ACTIVE_IND = 'Y')
                                 AND TRUNC(B.TBRACCD_EFFECTIVE_DATE) >= TO_DATE('01/'||TO_CHAR(TO_DATE(PN_FECHA_INICIO,'DD/MM/YY')+12,'MM/YYYY'),'DD/MM/YYYY')
                                 AND TRUNC(B.TBRACCD_EFFECTIVE_DATE) >= TO_DATE('01/'||TO_CHAR(TO_DATE(PN_FECHA_BAJA,'DD/MM/YY'),'MM/YYYY'),'DD/MM/YYYY')
                                 AND TBRACCD_DOCUMENT_NUMBER IS NULL
                                 AND B.TBRACCD_PIDM = SPRIDEN_PIDM
                                 AND SPRIDEN_CHANGE_IND IS NULL
                           ORDER BY B.TBRACCD_TRAN_NUMBER

               )LOOP

                 DBMS_OUTPUT.PUT_LINE('POR VENCER JORNADA CURSOR   -'||PARCIAL.SECUENCIA
                                                                    ||'-'||PARCIAL.PIDM
                                                                    ||'-'||CF.SZVBAEC_CONCEPTO_PARC_XVEN
                                                                    ||'-'||PARCIAL.DESCUENTO
                                                                    ||'-'||PN_FECHA_INICIO
                                                                    ||'-'||PN_FECHA_BAJA);

                 BEGIN
                   SELECT NVL(MAX(A1.TBRAPPL_PAY_TRAN_NUMBER),0)
                     INTO VL_NUMPAG
                     FROM TBRAPPL A1
                    WHERE     A1.TBRAPPL_PIDM = PARCIAL.PIDM
                          AND A1.TBRAPPL_CHG_TRAN_NUMBER =  PARCIAL.SECUENCIA
                          AND A1.TBRAPPL_ACTIVITY_DATE = (SELECT MAX (A.TBRAPPL_ACTIVITY_DATE)
                                                            FROM TBRAPPL A
                                                           WHERE     A.TBRAPPL_PIDM = A1.TBRAPPL_PIDM
                                                                 AND A.TBRAPPL_CHG_TRAN_NUMBER =  A1.TBRAPPL_CHG_TRAN_NUMBER);
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_NUMPAG :=0;
                 END;

                 DBMS_OUTPUT.PUT_LINE('POR VENCER JORNADA 1'||'---'||VL_NUMPAG);

                 BEGIN
                   SELECT B.TBRACCD_DETAIL_CODE
                     INTO VL_EXISTE_DETAIL
                     FROM TBRACCD B
                    WHERE     B.TBRACCD_PIDM = PARCIAL.PIDM
                          AND B.TBRACCD_TRAN_NUMBER = VL_NUMPAG;
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_EXISTE_DETAIL :=0;
                 END;

                 DBMS_OUTPUT.PUT_LINE('POR VENCER JORNADA 2'||'---'||VL_EXISTE_DETAIL);

                 BEGIN

                   DBMS_OUTPUT.PUT_LINE('POR VENCER JORNADA 3'||'---'||CF.SZVBAEC_CONCEPTO_PARC_XVEN||'---'||VL_EXISTE_DETAIL);

                   IF CF.SZVBAEC_CONCEPTO_PARC_XVEN <> NVL(VL_EXISTE_DETAIL,0) THEN

                     DBMS_OUTPUT.PUT_LINE(CF.SZVBAEC_CONCEPTO_PARC_XVEN||'-'||VL_EXISTE_DETAIL);

                     BEGIN

                             SELECT COUNT (ZSTPARA_PARAM_VALOR)
                             INTO VL_EXIS_CONTRA_2
                             FROM ZSTPARA
                             WHERE ZSTPARA_MAPA_ID = 'DET_CODE_CART'
                             AND ZSTPARA_PARAM_ID = 'PARC_ANTERIOR'
                             AND ZSTPARA_PARAM_VALOR = SUBSTR(VL_EXISTE_DETAIL,3,2);

                     EXCEPTION
                     WHEN OTHERS THEN
                     VL_EXIS_CONTRA_2:=0;
                     END;

                     IF VL_EXIS_CONTRA_2 = 0 THEN

                       VL_TRANSACCION :=0;
                       VL_PERIODO := NULL;

                       BEGIN
                         SELECT TO_NUMBER(ZSTPARA_PARAM_VALOR)
                           INTO VL_DIAS_AJUSTE
                           FROM ZSTPARA
                          WHERE     ZSTPARA_MAPA_ID = 'DIAS_BAJADT'
                                AND ZSTPARA_PARAM_ID = 'GENERAL';

                       END;

                       IF PN_ESTATUS IN ('BD','BT') THEN

                         IF LAST_DAY(TRUNC(SYSDATE)) > LAST_DAY(TRUNC(PARCIAL.FECHA_EFFECTIVA)) THEN
                           VL_AJUSTA:= 0;
                         ELSE

                           IF LAST_DAY(TRUNC(SYSDATE)) < LAST_DAY(TRUNC(PARCIAL.FECHA_EFFECTIVA)) THEN
                             VL_AJUSTA:= 1;
                           ELSE

                             IF LAST_DAY(TRUNC(SYSDATE)) = LAST_DAY(TRUNC(PN_FECHA_INICIO)) THEN

                               IF TRUNC(SYSDATE) <= TRUNC(PN_FECHA_INICIO)+VL_DIAS_AJUSTE THEN
                                 VL_AJUSTA:= 1;
                               ELSE
                                 VL_AJUSTA:= 0;
                               END IF;

                             ELSE

                               IF TRUNC(SYSDATE) <= TRUNC(TRUNC(SYSDATE)-(TO_CHAR(TRUNC(SYSDATE),'DD')-1))+VL_DIAS_AJUSTE THEN
                                 VL_AJUSTA:= 1;
                               ELSE
                                 VL_AJUSTA:= 0;
                               END IF;

                             END IF;

                           END IF;

                         END IF;

                       ELSE
                         VL_AJUSTA:= 1;
                       END IF;

                       IF VL_AJUSTA = 1 THEN

                           VL_CAN_BECA:= PKG_FINANZAS_REZA.F_AJ_CAN_BECA ( PN_PIDM,
                                                                           PARCIAL.SECUENCIA,
                                                                           PN_FECHA_INICIO,
                                                                           'CANCELACION');

                           BEGIN
                              SELECT NVL(MAX(TBRACCD_TRAN_NUMBER),0) +1
                                INTO VL_TRANSACCION
                                FROM TBRACCD
                               WHERE TBRACCD_PIDM=PARCIAL.PIDM;
                           EXCEPTION
                           WHEN OTHERS THEN
                           VL_TRANSACCION:=0;
                           END;

                           DBMS_OUTPUT.PUT_LINE('Entra ' ||PN_PIDM || '*'||PARCIAL.SECUENCIA|| '*'||PARCIAL.TBRACCD_EFFECTIVE_DATE||'*'||PARCIAL.TBRACCD_PERIOD||'*'||PARCIAL.MONTO);

                           PKG_FINANZAS.P_DESAPLICA_PAGOS (PARCIAL.PIDM, PARCIAL.SECUENCIA) ;

                           DBMS_OUTPUT.PUT_LINE('DESAPLICA PAGOS POR VENCER JORNADA');

                           BEGIN
                               INSERT INTO TBRACCD
                               VALUES (
                                       PARCIAL.PIDM,   -- TBRACCD_PIDM
                                       VL_TRANSACCION,     --TBRACCD_TRAN_NUMBER
                                       PARCIAL.PERIODO,    -- TBRACCD_TERM_CODE
                                       CF.SZVBAEC_CONCEPTO_PARC_XVEN,--vp_parcial_code,     ---TBRACCD_DETAIL_CODE
                                       USER,     ---TBRACCD_USER
                                       SYSDATE,     --TBRACCD_ENTRY_DATE
                                       NVL(PARCIAL.DESCUENTO,0),
                                       NVL(PARCIAL.DESCUENTO,0) * -1,    ---TBRACCD_BALANCE
                                       SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                                       NULL,    --TBRACCD_BILL_DATE
                                       NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                                       VL_DESCRIPCION,    -- TBRACCD_DESC
                                       PARCIAL.TBRACCD_RECEIPT_NUMBER,     --TBRACCD_RECEIPT_NUMBER
                                       PARCIAL.SECUENCIA,     --TBRACCD_TRAN_NUMBER_PAID
                                       NULL,     --TBRACCD_CROSSREF_PIDM
                                       NULL,    --TBRACCD_CROSSREF_NUMBER
                                       NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                                       'T',    --TBRACCD_SRCE_CODE
                                       'Y',    --TBRACCD_ACCT_FEED_IND
                                       SYSDATE,  --TBRACCD_ACTIVITY_DATE
                                       0,        --TBRACCD_SESSION_NUMBER
                                       NULL,    -- TBRACCD_CSHR_END_DATE
                                       NULL,     --TBRACCD_CRN
                                       NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                                       NULL,     -- TBRACCD_LOC_MDT
                                       NULL,     --TBRACCD_LOC_MDT_SEQ
                                       NULL,     -- TBRACCD_RATE
                                       NULL,     --TBRACCD_UNITS
                                       NULL,     -- TBRACCD_DOCUMENT_NUMBER
                                       SYSDATE,  -- TBRACCD_TRANS_DATE
                                       NULL,        -- TBRACCD_PAYMENT_ID
                                       NULL,     -- TBRACCD_INVOICE_NUMBER
                                       NULL,     -- TBRACCD_STATEMENT_DATE
                                       NULL,     -- TBRACCD_INV_NUMBER_PAID
                                       'MXN',     -- TBRACCD_CURR_CODE
                                       NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                                       NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                                       NULL,     -- TBRACCD_LATE_DCAT_CODE
                                       PN_FECHA_INICIO,     -- TBRACCD_FEED_DATE
                                       NULL,     -- TBRACCD_FEED_DOC_CODE
                                       NULL,     -- TBRACCD_ATYP_CODE
                                       NULL,     -- TBRACCD_ATYP_SEQNO
                                       NULL,     -- TBRACCD_CARD_TYPE_VR
                                       NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                                       NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                                       NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                                       NULL,     -- TBRACCD_ORIG_CHG_IND
                                       NULL,     -- TBRACCD_CCRD_CODE
                                       NULL,     -- TBRACCD_MERCHANT_ID
                                       NULL,     -- TBRACCD_TAX_REPT_YEAR
                                       NULL,     -- TBRACCD_TAX_REPT_BOX
                                       NULL,     -- TBRACCD_TAX_AMOUNT
                                       NULL,     -- TBRACCD_TAX_FUTURE_IND
                                       'AUTOMATICOc',     -- TBRACCD_DATA_ORIGIN
                                       'AUTOMATICOc',   -- TBRACCD_CREATE_SOURCE
                                       NULL,     -- TBRACCD_CPDT_IND
                                       NULL,     --TBRACCD_AIDY_CODE
                                       NVL (PARCIAL.TBRACCD_STSP_KEY_SEQUENCE,PN_KEYSEQNO),     --TBRACCD_STSP_KEY_SEQUENCE
                                       NVL(PARCIAL.TBRACCD_PERIOD,VL_PARTE),     --TBRACCD_PERIOD
                                       NULL,    --TBRACCD_SURROGATE_ID
                                       NULL,     -- TBRACCD_VERSION
                                       USER,     --TBRACCD_USER_ID
                                       NULL );     --TBRACCD_VPDI_CODE
                           EXCEPTION
                           WHEN OTHERS THEN
                           VL_ERROR := 'Se presento el siguiente error al momento de insertar ajuste para Parcialidad en TBRACCD '||SQLERRM;
                           END;


                           IF PARCIAL.DESCUENTO = PARCIAL.MONTO THEN

                             BEGIN
                              SELECT COUNT(*)
                                INTO VL_PROMOCION
                                FROM TBRACCD
                               WHERE     TBRACCD_PIDM = PARCIAL.PIDM
                                     AND SUBSTR (TBRACCD_DETAIL_CODE,3,2) = 'M3'
                                     AND TBRACCD_TRAN_NUMBER_PAID = PARCIAL.SECUENCIA;
                             END;

                             IF VL_PROMOCION > 0 AND PN_ESTATUS NOT IN ('CC','CF') THEN

                                 BEGIN
                                   SELECT TBRACCD_AMOUNT,TBRACCD_TRAN_NUMBER,TBRACCD_EFFECTIVE_DATE,TBRACCD_TERM_CODE
                                     INTO VL_PROMOCION_MONTO,VL_PROMOCION_TRAN,VL_PROMOCION_VIG,VL_PROMOCION_PERIODO
                                     FROM TBRACCD
                                    WHERE     TBRACCD_PIDM = PARCIAL.PIDM
                                          AND SUBSTR (TBRACCD_DETAIL_CODE,3,2) = 'M3'
                                          AND TBRACCD_TRAN_NUMBER_PAID = PARCIAL.SECUENCIA;
                                 END;

                                IF VL_PROMOCION_VIG <= TRUNC(SYSDATE) THEN
                                    VL_PROMOCION_VIG:= TRUNC(SYSDATE);
                                ELSE
                                    VL_PROMOCION_VIG:=VL_PROMOCION_VIG;
                                END IF;

                                VL_APL_AJUSTE:= PKG_FINANZAS.SP_APLICA_AJUSTE ( PARCIAL.PIDM,
                                                                                VL_PROMOCION_TRAN,
                                                                                SUBSTR(PARCIAL.PERIODO,1,2)||'ON',
                                                                                VL_PROMOCION_MONTO,
                                                                                VL_PROMOCION_PERIODO,
                                                                                'CANCELACION DE PROMOCION',
                                                                                SYSDATE,
                                                                                NULL,
                                                                                NULL,
                                                                                NULL,
                                                                                'SZFABCC');

                                 BEGIN
                                   UPDATE TBRACCD
                                      SET TBRACCD_DOCUMENT_NUMBER = 'SZFABCC'
                                    WHERE     TBRACCD_PIDM = PARCIAL.PIDM
                                          AND TBRACCD_DETAIL_CODE = SUBSTR(PARCIAL.PERIODO,1,2)||'ON'
                                          AND TBRACCD_USER = 'SZFABCC'
                                          AND TRUNC(TBRACCD_EFFECTIVE_DATE) = VL_PROMOCION_VIG;
                                 END;

                             END IF;

                             BEGIN
                               UPDATE TBRACCD
                                  SET TBRACCD_DOCUMENT_NUMBER = 'SZFABCC'
                                WHERE     TBRACCD_PIDM = PARCIAL.PIDM
                                      AND TBRACCD_TRAN_NUMBER = VL_TRANSACCION;
                             END;

                             BEGIN
                               UPDATE TBRACCD
                                  SET TBRACCD_DOCUMENT_NUMBER = 'SZFABCC',
                                      TBRACCD_TRAN_NUMBER_PAID = NULL
                                WHERE     TBRACCD_PIDM = PARCIAL.PIDM
                                      AND TBRACCD_TRAN_NUMBER = PARCIAL.SECUENCIA;
                             END;

                             BEGIN
                                UPDATE TBRACCD
                                   SET TBRACCD_TRAN_NUMBER_PAID = NULL
                                 WHERE     TBRACCD_PIDM = PARCIAL.PIDM
                                       AND TBRACCD_TRAN_NUMBER_PAID = PARCIAL.SECUENCIA
                                       AND (TBRACCD_CREATE_SOURCE != 'CANCELA DINA' OR TBRACCD_CREATE_SOURCE IS NULL)
                                       AND TBRACCD_TRAN_NUMBER != VL_TRANSACCION;
                             END;

                           END IF;
                       END IF;
                     END IF;
                   END IF;
                 END;
               END LOOP PARCIAL;
             END IF;
           END IF;
         END IF;
         ---------------------------------------------------------------------------------------------------------
         ---------------------------------Proceso par aplicar ajustes status BA regla de finanzas-----------------
         ---------------------------------------------------------------------------------------------------------
      DBMS_OUTPUT.PUT_LINE('antes PRIMER IF ='||PN_ESTATUS);

       IF PN_ESTATUS = 'BA' THEN
             DBMS_OUTPUT.PUT_LINE('ENTRA PRIMER IF ='||PN_ESTATUS);
             DBMS_OUTPUT.PUT_LINE('PIDM ='||PN_PIDM);
             DBMS_OUTPUT.PUT_LINE('FECHA INICIO ='||PN_FECHA_INICIO);

            FOR ADEUDO IN (

                    SELECT B.TBRACCD_PIDM PIDM,
                                       B.TBRACCD_AMOUNT MONTO,
                                       B.TBRACCD_TRAN_NUMBER SECUENCIA,
                                       (B.TBRACCD_AMOUNT- NVL((SELECT SUM(TBRACCD_AMOUNT)
                                                                FROM TBRACCD
                                                               WHERE     TBRACCD_PIDM = B.TBRACCD_PIDM
                                                                     AND TBRACCD_CREATE_SOURCE = 'CANCELA DINA'
                                                                     AND TBRACCD_TRAN_NUMBER_PAID = B.TBRACCD_TRAN_NUMBER
                                                                     ),0))*(100/100) DESCUENTO, ----AGREGAR DATO A LA TABLA
                                       SPRIDEN_ID ID,
                                       TBRACCD_STSP_KEY_SEQUENCE,
                                       TBRACCD_PERIOD PARTE, --RLS20180131,
                                       TBRACCD_TERM_CODE PERIODO,
                                       TBRACCD_EFFECTIVE_DATE FECHA_EFFECTIVA,
                                       TBRACCD_RECEIPT_NUMBER
                                  FROM TBRACCD B, SPRIDEN
                                 WHERE     B.TBRACCD_PIDM = PN_PIDM
                                       AND B.TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                                                       FROM TBBDETC
                                                                      WHERE     TBBDETC_DCAT_CODE = 'COL'
                                                                            AND SUBSTR (TBBDETC_DETAIL_CODE,1,2)  = SUBSTR (B.TBRACCD_TERM_CODE,1,2)
                                                                            AND TBBDETC_DETC_ACTIVE_IND = 'Y' )
---        -                               AND TRUNC(B.TBRACCD_EFFECTIVE_DATE) < (SELECT TRUNC(TO_DATE('30/12/2021'))-(TO_NUMBER(TO_CHAR(TO_DATE('30/12/2021'),'DD'))-1)FROM DUAL)
                                       AND B.TBRACCD_EFFECTIVE_DATE >= PN_FECHA_INICIO
--                                       AND B.TBRACCD_FEED_DATE = PN_FECHA_INICIO
                                       AND B.TBRACCD_PIDM = SPRIDEN_PIDM
                                       AND SPRIDEN_CHANGE_IND IS NULL
                                       AND TBRACCD_DOCUMENT_NUMBER IS NULL
                                       AND B.TBRACCD_TRAN_NUMBER = (SELECT MAX (TBRACCD_TRAN_NUMBER)
                                                                   FROM TBRACCD
                                                                  WHERE TBRACCD_PIDM = B.TBRACCD_PIDM
                                                                        AND TBRACCD_CREATE_SOURCE = B.TBRACCD_CREATE_SOURCE
--                                                                        AND TBRACCD_FEED_DATE = B.TBRACCD_FEED_DATE
                                                                        AND TBRACCD_DOCUMENT_NUMBER IS NULL)
         ORDER BY B.TBRACCD_TRAN_NUMBER



         )LOOP


         DBMS_OUTPUT.PUT_LINE('POR VENCER -'||ADEUDO.SECUENCIA
                                                ||'-'||ADEUDO.PIDM
                                                ||'-'||CF.SZVBAEC_CONCEPTO_PARC_XVEN
                                                ||'-'||ADEUDO.DESCUENTO
                                                ||'-'||ADEUDO.FECHA_EFFECTIVA);

           BEGIN
             SELECT NVL(MAX(A1.TBRAPPL_PAY_TRAN_NUMBER),0)
               INTO VL_NUMPAG
               FROM TBRAPPL A1
              WHERE A1.TBRAPPL_PIDM = PN_PIDM
                AND A1.TBRAPPL_CHG_TRAN_NUMBER = ADEUDO.SECUENCIA
                AND A1.TBRAPPL_ACTIVITY_DATE = (SELECT MAX (A.TBRAPPL_ACTIVITY_DATE)
                                                 FROM TBRAPPL A
                                                WHERE A.TBRAPPL_PIDM = A1.TBRAPPL_PIDM
                                                  AND A.TBRAPPL_CHG_TRAN_NUMBER =  A1.TBRAPPL_CHG_TRAN_NUMBER);
           EXCEPTION
           WHEN OTHERS THEN
           VL_NUMPAG :=0;
           END;

           DBMS_OUTPUT.PUT_LINE(ADEUDO.PIDM||'-'||ADEUDO.SECUENCIA||'/'||VL_NUMPAG);

           BEGIN
             SELECT B.TBRACCD_DETAIL_CODE
               INTO VL_EXISTE_DETAIL
               FROM TBRACCD B
              WHERE B.TBRACCD_PIDM = ADEUDO.PIDM
                AND B.TBRACCD_TRAN_NUMBER = VL_NUMPAG;

           EXCEPTION
           WHEN OTHERS THEN
           VL_EXISTE_DETAIL :=0;
           END;

              DBMS_OUTPUT.PUT_LINE(VL_EXISTE_DETAIL);

---        -      BEGIN
              DBMS_OUTPUT.PUT_LINE(CF.SZVBAEC_CONCEPTO_PARC_VEN||'/'||VL_EXISTE_DETAIL);

           IF CF.SZVBAEC_CONCEPTO_PARC_XVEN <> VL_EXISTE_DETAIL THEN
---        -      IF '01Y4' <> '01M3' THEN
              DBMS_OUTPUT.PUT_LINE ('ENTRA AL IF =' ||VL_EXISTE_DETAIL);
             BEGIN
               SELECT COUNT (ZSTPARA_PARAM_VALOR)
                 INTO VL_EXIS_CONTRA_2
                 FROM ZSTPARA
                WHERE     ZSTPARA_MAPA_ID = 'DET_CODE_CART'
                      AND ZSTPARA_PARAM_ID = 'PARC_ANTERIOR'
                      AND ZSTPARA_PARAM_VALOR = SUBSTR(VL_EXISTE_DETAIL,3,2);
             EXCEPTION
             WHEN OTHERS THEN
             VL_EXIS_CONTRA_2:=0;
             END;

             DBMS_OUTPUT.PUT_LINE ('VL_EXIS_CONTRA_2 =' ||VL_EXIS_CONTRA_2);

             IF VL_EXIS_CONTRA_2 = 0 THEN
             DBMS_OUTPUT.PUT_LINE ('VL_EXIS_CONTRA_2 =' ||VL_EXIS_CONTRA_2);
            DBMS_OUTPUT.PUT_LINE(CF.SZVBAEC_CONCEPTO_PARC_VEN||'/'||VL_EXISTE_DETAIL);

               VL_TRANSACCION :=0;
               VL_PERIODO     := NULL;
               VL_AJUSTA      := NULL;

               BEGIN
                 SELECT TO_NUMBER(ZSTPARA_PARAM_VALOR)
                   INTO VL_DIAS_AJUSTE
                   FROM ZSTPARA
                  WHERE     ZSTPARA_MAPA_ID = 'DIAS_BAJADT'
                        AND ZSTPARA_PARAM_ID = 'GENERAL';

               END;
              DBMS_OUTPUT.PUT_LINE ('VL_DIAS_AJUSTE =' ||VL_DIAS_AJUSTE);

               IF TRUNC(SYSDATE) <= TRUNC(TRUNC(SYSDATE)-(TO_CHAR(TRUNC(SYSDATE),'DD')-1))+VL_DIAS_AJUSTE THEN
                 VL_AJUSTA:= 1;
                 ELSE
                 VL_AJUSTA:= 0;
               END IF;

              DBMS_OUTPUT.PUT_LINE ('VL_AJUSTA_4=' ||VL_AJUSTA);

             END IF;

           END IF;


           IF VL_AJUSTA = 1 THEN
           DBMS_OUTPUT.PUT_LINE ('VL_AJUSTA_5=' ||VL_AJUSTA);

               VL_CAN_BECA:= PKG_FINANZAS_REZA.F_AJ_CAN_BECA ( PN_PIDM,
                                                               ADEUDO.SECUENCIA,
                                                               PN_FECHA_INICIO,
                                                               'CANCELACION');

             BEGIN
               SELECT NVL(MAX(TBRACCD_TRAN_NUMBER),0) +1
                 INTO VL_TRANSACCION
                 FROM TBRACCD
                WHERE TBRACCD_PIDM=ADEUDO.PIDM;
             EXCEPTION
             WHEN OTHERS THEN
             VL_TRANSACCION:=0;
             END;

             BEGIN
               SELECT FGET_PERIODO_GENERAL(SUBSTR(ADEUDO.ID,1,2))
                 INTO VL_PERIODO
                 FROM DUAL;
             EXCEPTION
             WHEN OTHERS THEN
             VL_PERIODO := '000000';
             END;

             DBMS_OUTPUT.PUT_LINE(VL_PERIODO||'<<<<'||ADEUDO.ID);

             PKG_FINANZAS.P_DESAPLICA_PAGOS (ADEUDO.PIDM, ADEUDO.SECUENCIA) ;

             DBMS_OUTPUT.PUT_LINE('entra desaplica pagos');

             BEGIN

              FOR I IN 1..1 LOOP

               INSERT
                 INTO TBRACCD
               VALUES (
                          ADEUDO.PIDM,   -- TBRACCD_PIDM
                          VL_TRANSACCION,     --TBRACCD_TRAN_NUMBER
                          ADEUDO.PERIODO,    -- TBRACCD_TERM_CODE
---        -                  CF.SZVBAEC_CONCEPTO_PARC_XVEN,--vp_ADEUDO_code,     ---TBRACCD_DETAIL_CODE
                          SUBSTR(ADEUDO.PERIODO,1,2)||'Y4',
                          USER,     ---TBRACCD_USER
                          SYSDATE,     --TBRACCD_ENTRY_DATE
                          NVL(ADEUDO.DESCUENTO,0),
                          NVL(ADEUDO.DESCUENTO,0) * -1,    ---TBRACCD_BALANCE
                          SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                          NULL,    --TBRACCD_BILL_DATE
                          NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
---        -                VL_DESCRIPCION,    -- TBRACCD_DESC
                          'AJUSTE BAJA TEMPORAL',
                          ADEUDO.TBRACCD_RECEIPT_NUMBER,     --TBRACCD_RECEIPT_NUMBER
                          ADEUDO.SECUENCIA,     --TBRACCD_TRAN_NUMBER_PAID
                          NULL,     --TBRACCD_CROSSREF_PIDM
                          NULL,    --TBRACCD_CROSSREF_NUMBER
                          NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                          'T',    --TBRACCD_SRCE_CODE
                          'Y',    --TBRACCD_ACCT_FEED_IND
                          SYSDATE,  --TBRACCD_ACTIVITY_DATE
                          0,        --TBRACCD_SESSION_NUMBER
                          NULL,    -- TBRACCD_CSHR_END_DATE
                          NULL,     --TBRACCD_CRN
                          NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                          NULL,     -- TBRACCD_LOC_MDT
                          NULL,     --TBRACCD_LOC_MDT_SEQ
                          NULL,     -- TBRACCD_RATE
                          NULL,     --TBRACCD_UNITS
                          NULL,     -- TBRACCD_DOCUMENT_NUMBER
                          SYSDATE,  -- TBRACCD_TRANS_DATE
                          NULL,        -- TBRACCD_PAYMENT_ID
                          NULL,     -- TBRACCD_INVOICE_NUMBER
                          NULL,     -- TBRACCD_STATEMENT_DATE
                          NULL,     -- TBRACCD_INV_NUMBER_PAID
                          'MXN',     -- TBRACCD_CURR_CODE
                          NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                          NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                          NULL,     -- TBRACCD_LATE_DCAT_CODE
                          PN_FECHA_INICIO,     -- TBRACCD_FEED_DATE
                          NULL,     -- TBRACCD_FEED_DOC_CODE
                          NULL,     -- TBRACCD_ATYP_CODE
                          NULL,     -- TBRACCD_ATYP_SEQNO
                          NULL,     -- TBRACCD_CARD_TYPE_VR
                          NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                          NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                          NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                          NULL,     -- TBRACCD_ORIG_CHG_IND
                          NULL,     -- TBRACCD_CCRD_CODE
                          NULL,     -- TBRACCD_MERCHANT_ID
                          NULL,     -- TBRACCD_TAX_REPT_YEAR
                          NULL,     -- TBRACCD_TAX_REPT_BOX
                          NULL,     -- TBRACCD_TAX_AMOUNT
                          NULL,     -- TBRACCD_TAX_FUTURE_IND
                          'AUTOMATICOa',     -- TBRACCD_DATA_ORIGIN
                          'AUTOMATICOa',   -- TBRACCD_CREATE_SOURCE
                          NULL,     -- TBRACCD_CPDT_IND
                          NULL,     --TBRACCD_AIDY_CODE
                          ADEUDO.TBRACCD_STSP_KEY_SEQUENCE,  -- TBRACCD_STSP_KEY_SEQUENCE
                          ADEUDO.PARTE,                 -- TBRACCD_PERIOD
                          NULL,    --TBRACCD_SURROGATE_ID
                          NULL,     -- TBRACCD_VERSION
                          USER,     --TBRACCD_USER_ID
                          NULL );     --TBRACCD_VPDI_CODE

             END LOOP;

             EXCEPTION
             WHEN OTHERS THEN
             VL_ERROR := 'Se presento el siguiente error al momento de insertar ajuste para ADEUDOidad en TBRACCD '||SQLERRM;
             END;

             DBMS_OUTPUT.PUT_LINE('EXITO TBRACCD PRCIALIDADES VENCIDAS');

             BEGIN
               SELECT COUNT(*)
                 INTO VL_PROMOCION
                 FROM TBRACCD
                WHERE     TBRACCD_PIDM = ADEUDO.PIDM
                      AND SUBSTR (TBRACCD_DETAIL_CODE,3,2) = 'M3'
                      AND TBRACCD_TRAN_NUMBER_PAID = ADEUDO.SECUENCIA;
             END;

             IF VL_PROMOCION > 0 AND PN_ESTATUS NOT IN ('CC','CF') THEN

             VL_PROMOCION_MONTO:=NULL;
             VL_PROMOCION_TRAN:=NULL;
             VL_PROMOCION_VIG:=NULL;
             VL_PROMOCION_PERIODO:=NULL;


               BEGIN
                 SELECT TBRACCD_AMOUNT,TBRACCD_TRAN_NUMBER,TBRACCD_EFFECTIVE_DATE,TBRACCD_TERM_CODE
                   INTO VL_PROMOCION_MONTO,VL_PROMOCION_TRAN,VL_PROMOCION_VIG,VL_PROMOCION_PERIODO
                   FROM TBRACCD
                  WHERE     TBRACCD_PIDM = ADEUDO.PIDM
                        AND SUBSTR (TBRACCD_DETAIL_CODE,3,2) = 'M3'
                        AND TBRACCD_TRAN_NUMBER_PAID = ADEUDO.SECUENCIA;
               END;

               IF VL_PROMOCION_VIG <= TRUNC(SYSDATE) THEN
                   VL_PROMOCION_VIG:= TRUNC(SYSDATE);
               ELSE
                   VL_PROMOCION_VIG:=VL_PROMOCION_VIG;
               END IF;

               VL_APL_AJUSTE:= PKG_FINANZAS.SP_APLICA_AJUSTE ( ADEUDO.PIDM,
                                                               VL_PROMOCION_TRAN,
                                                               SUBSTR(ADEUDO.PERIODO,1,2)||'ON',
                                                               VL_PROMOCION_MONTO,
                                                               VL_PROMOCION_PERIODO,
                                                               'CANCELACION DE PROMOCION',
                                                               SYSDATE,
                                                               NULL,
                                                               NULL,
                                                               NULL,
                                                               'SZFABCC');

               BEGIN
                 UPDATE TBRACCD
                    SET TBRACCD_DOCUMENT_NUMBER = 'SZFABCC'
                  WHERE     TBRACCD_PIDM = ADEUDO.PIDM
                        AND TBRACCD_DETAIL_CODE = SUBSTR(ADEUDO.PERIODO,1,2)||'ON'
                        AND TBRACCD_USER = 'SZFABCC'
                        AND TRUNC(TBRACCD_EFFECTIVE_DATE) = VL_PROMOCION_VIG;
               EXCEPTION
               WHEN OTHERS THEN
                VL_ERROR :=' Errror al actualizar saldo Saldo>>  ' || SQLERRM ;
               END;

             END IF;

                 IF  ADEUDO.DESCUENTO = ADEUDO.MONTO THEN

                   BEGIN
                     UPDATE TBRACCD
                        SET TBRACCD_DOCUMENT_NUMBER = 'SZFABCC'
                      WHERE     TBRACCD_PIDM = ADEUDO.PIDM
                            AND TBRACCD_TRAN_NUMBER = VL_TRANSACCION;
                   END;

                   BEGIN
                     UPDATE TBRACCD
                        SET TBRACCD_DOCUMENT_NUMBER = 'SZFABCC',
                            TBRACCD_TRAN_NUMBER_PAID = NULL
                      WHERE     TBRACCD_PIDM = ADEUDO.PIDM
                            AND TBRACCD_TRAN_NUMBER = ADEUDO.SECUENCIA;
                   END;

                   BEGIN
                     UPDATE TBRACCD
                        SET TBRACCD_TRAN_NUMBER_PAID = NULL
                      WHERE     TBRACCD_PIDM = ADEUDO.PIDM
                            AND TBRACCD_TRAN_NUMBER_PAID = ADEUDO.SECUENCIA
                            AND (TBRACCD_CREATE_SOURCE != 'CANCELA DINA' OR TBRACCD_CREATE_SOURCE IS NULL)
                            AND TBRACCD_TRAN_NUMBER != VL_TRANSACCION;
                   END;

                 END IF;

           END IF;

            END LOOP ADEUDO;

        END IF;




         ---------------------------------------------------------------------------------------------------------
         --------------------------------- Proceso de Accesorios--------------------------------------------------
         ---------------------------------------------------------------------------------------------------------
         IF CF.SZVBAEC_AJUSTE_ACCE = 'S' THEN

           FOR ACCESO IN (
                          SELECT DISTINCT ZSTPARA_PARAM_VALOR CATEGORIA
                            FROM ZSTPARA
                           WHERE ZSTPARA_MAPA_ID = 'CONFIGURA_BAJA' AND ZSTPARA_PARAM_ID = 'ACCESORIO_CARGO'
           )LOOP
             ---------------------------------------------------------------------------------------------------------
             ------------------ valida que se tenga la categoria correcta para Accesorios  ---------------------------
             ---------------------------------------------------------------------------------------------------------
             FOR CARGO IN (
                            SELECT B.TBRACCD_PIDM PIDM,
                                   B.TBRACCD_AMOUNT MONTO,
                                   B.TBRACCD_TRAN_NUMBER SECUENCIA,
                                   B.TBRACCD_DETAIL_CODE CODIGO,
                                   B.TBRACCD_AMOUNT*(CF.SZVBAEC_PORCENT_ACCE/*vp_acceso_porc*//100) DESCUENTO,
                                   SPRIDEN_ID ID,
                                   TBRACCD_STSP_KEY_SEQUENCE,
                                   TBRACCD_PERIOD, --RLS20180131
                                   TBRACCD_TERM_CODE PERIODO,
                                   TBRACCD_RECEIPT_NUMBER
                              FROM TBRACCD B, SPRIDEN
                             WHERE     B.TBRACCD_PIDM = PN_PIDM
                                   AND SUBSTR(B.TBRACCD_DETAIL_CODE,3,2) != 'QI'
                                   AND B.TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                                                   FROM TBBDETC
                                                                  WHERE     TBBDETC_DCAT_CODE IN ACCESO.CATEGORIA
                                                                        AND SUBSTR (TBBDETC_DETAIL_CODE, 1, 2 )  = SUBSTR (B.TBRACCD_TERM_CODE, 1, 2)
                                                                        AND TBBDETC_DETC_ACTIVE_IND = 'Y' )
                                   AND B.TBRACCD_BALANCE > 0
                                   AND TRUNC(B.TBRACCD_EFFECTIVE_DATE) >= TO_CHAR (TO_DATE(PN_FECHA_INICIO,'dd/mm/yyyy'))
                                   AND B.TBRACCD_PIDM = SPRIDEN_PIDM
                                   AND SPRIDEN_CHANGE_IND IS NULL

             ) LOOP
             
              DBMS_OUTPUT.PUT_LINE('Entra a los registros de CARGO Bloque 3'||CARGO.secuencia ||'*'||CARGO.Codigo);
             
               BEGIN
                 SELECT MAX(A1.TBRAPPL_PAY_TRAN_NUMBER)
                   INTO VL_NUMPAG
                   FROM TBRAPPL A1
                  WHERE      A1.TBRAPPL_PIDM = CARGO.PIDM
                         AND A1.TBRAPPL_CHG_TRAN_NUMBER =  CARGO.SECUENCIA
                         AND A1.TBRAPPL_ACTIVITY_DATE = (SELECT MAX (A.TBRAPPL_ACTIVITY_DATE)
                                                           FROM TBRAPPL A
                                                          WHERE     A.TBRAPPL_PIDM = A1.TBRAPPL_PIDM
                                                                AND A.TBRAPPL_CHG_TRAN_NUMBER =  A1.TBRAPPL_CHG_TRAN_NUMBER);
               EXCEPTION
               WHEN OTHERS THEN
               VL_NUMPAG :=0;
               END;


               BEGIN
                 SELECT B.TBRACCD_DETAIL_CODE
                   INTO VL_EXISTE_DETAIL
                   FROM TBRACCD B
                  WHERE     B.TBRACCD_PIDM = CARGO.PIDM
                        AND B.TBRACCD_TRAN_NUMBER = VL_NUMPAG;
               EXCEPTION
               WHEN OTHERS THEN
               VL_EXISTE_DETAIL :=0;
               END;

               BEGIN

                 IF CF.SZVBAEC_CONCEPTO_ACCE <> VL_EXISTE_DETAIL THEN

                   VL_TRANSACCION :=0;
                   VL_PERIODO := NULL;

                   BEGIN
                     SELECT NVL(MAX(TBRACCD_TRAN_NUMBER),0) +1
                       INTO VL_TRANSACCION
                       FROM TBRACCD
                      WHERE TBRACCD_PIDM=CARGO.PIDM;
                   EXCEPTION
                       WHEN OTHERS THEN
                         VL_TRANSACCION:=0;
                   END;

                   BEGIN
                     SELECT FGET_PERIODO_GENERAL(SUBSTR(CARGO.ID,1,2))
                       INTO VL_PERIODO
                       FROM DUAL;
                   EXCEPTION
                   WHEN OTHERS THEN
                      VL_PERIODO := '000000';
                   END;

                   BEGIN
                      SELECT SUBSTR(CARGO.CODIGO,1,2)||ZSTPARA_PARAM_VALOR
                        INTO VL_COD_CANCELA
                        FROM ZSTPARA
                       WHERE     ZSTPARA_MAPA_ID = 'ABCC_DIFERIDO'
                             AND ZSTPARA_PARAM_ID = SUBSTR(CARGO.CODIGO,3,2);
                   EXCEPTION
                   WHEN OTHERS THEN
                   VL_COD_CANCELA:=CF.SZVBAEC_CONCEPTO_ACCE;
                   END;

                   BEGIN
                     SELECT DISTINCT TBBDETC_DESC
                       INTO VL_DESCRIPCION
                       FROM TBBDETC
                      WHERE TBBDETC_DETAIL_CODE = VL_COD_CANCELA;
                   EXCEPTION
                   WHEN OTHERS THEN
                     VL_DESCRIPCION := NULL;
                   END;

                   BEGIN
                     INSERT
                       INTO TBRACCD
                     VALUES (
                            CARGO.PIDM,   -- TBRACCD_PIDM
                            VL_TRANSACCION,     --TBRACCD_TRAN_NUMBER
                            CARGO.PERIODO,    -- TBRACCD_TERM_CODE
                            VL_COD_CANCELA , ---TBRACCD_DETAIL_CODE
                            USER,     ---TBRACCD_USER
                            SYSDATE,     --TBRACCD_ENTRY_DATE
                            NVL(CARGO.DESCUENTO,0),
                            NVL(CARGO.DESCUENTO,0) * -1,    ---TBRACCD_BALANCE
                            SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                            NULL,    --TBRACCD_BILL_DATE
                            NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                            VL_DESCRIPCION,    -- TBRACCD_DESC
                            CARGO.TBRACCD_RECEIPT_NUMBER,     --TBRACCD_RECEIPT_NUMBER
                            CARGO.SECUENCIA,     --TBRACCD_TRAN_NUMBER_PAID
                            NULL,     --TBRACCD_CROSSREF_PIDM
                            NULL,    --TBRACCD_CROSSREF_NUMBER
                            NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                            'T',    --TBRACCD_SRCE_CODE
                            'Y',    --TBRACCD_ACCT_FEED_IND
                            SYSDATE,  --TBRACCD_ACTIVITY_DATE
                            0,        --TBRACCD_SESSION_NUMBER
                            NULL,    -- TBRACCD_CSHR_END_DATE
                            NULL,     --TBRACCD_CRN
                            NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                            NULL,     -- TBRACCD_LOC_MDT
                            NULL,     --TBRACCD_LOC_MDT_SEQ
                            NULL,     -- TBRACCD_RATE
                            NULL,     --TBRACCD_UNITS
                            NULL,     -- TBRACCD_DOCUMENT_NUMBER
                            SYSDATE,  -- TBRACCD_TRANS_DATE
                            NULL,        -- TBRACCD_PAYMENT_ID
                            NULL,     -- TBRACCD_INVOICE_NUMBER
                            NULL,     -- TBRACCD_STATEMENT_DATE
                            NULL,     -- TBRACCD_INV_NUMBER_PAID
                            'MXN',     -- TBRACCD_CURR_CODE
                            NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                            NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                            NULL,     -- TBRACCD_LATE_DCAT_CODE
                            PN_FECHA_INICIO,     -- TBRACCD_FEED_DATE
                            NULL,     -- TBRACCD_FEED_DOC_CODE
                            NULL,     -- TBRACCD_ATYP_CODE
                            NULL,     -- TBRACCD_ATYP_SEQNO
                            NULL,     -- TBRACCD_CARD_TYPE_VR
                            NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                            NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                            NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                            NULL,     -- TBRACCD_ORIG_CHG_IND
                            NULL,     -- TBRACCD_CCRD_CODE
                            NULL,     -- TBRACCD_MERCHANT_ID
                            NULL,     -- TBRACCD_TAX_REPT_YEAR
                            NULL,     -- TBRACCD_TAX_REPT_BOX
                            NULL,     -- TBRACCD_TAX_AMOUNT
                            NULL,     -- TBRACCD_TAX_FUTURE_IND
                            'AUTOMATICO',     -- TBRACCD_DATA_ORIGIN
                            'AUTOMATICO',   -- TBRACCD_CREATE_SOURCE
                            NULL,     -- TBRACCD_CPDT_IND
                            NULL,     --TBRACCD_AIDY_CODE
                            NVL(CARGO.TBRACCD_STSP_KEY_SEQUENCE,PN_KEYSEQNO),    --TBRACCD_STSP_KEY_SEQUENCE
                            NVL(CARGO.TBRACCD_PERIOD,VL_PARTE),    --TBRACCD_PERIOD
                            NULL,    --TBRACCD_SURROGATE_ID
                            NULL,     -- TBRACCD_VERSION
                            USER,     --TBRACCD_USER_ID
                            NULL );     --TBRACCD_VPDI_CODE
                            
                            DBMS_OUTPUT.PUT_LINE('Genera los cargos de Cargo Bloque 3 '||VL_COD_CANCELA ||'*'||vl_transaccion);
                            
                   EXCEPTION
                       WHEN OTHERS THEN
                         VL_ERROR := 'Se presento el siguiente error al momento de insertar ajuste para Accesorios en TBRACCD '||SQLERRM;
                   END;

                   IF CARGO.DESCUENTO = CARGO.MONTO THEN

                     BEGIN
                       INSERT
                         INTO TBRAPPL
                       VALUES (
                                CARGO.PIDM,               --TBRAPPL_PIDM
                                VL_TRANSACCION,               --TBRAPPL_PAY_TRAN_NUMBER
                                CARGO.SECUENCIA,               --TBRAPPL_CHG_TRAN_NUMBER
                                CARGO.DESCUENTO,              --TBRAPPL_AMOUNT
                                NULL,             --TBRAPPL_DIRECT_PAY_IND
                                NULL,              --TBRAPPL_REAPPL_IND
                                USER,              --TBRAPPL_USER
                                'Y',              --TBRAPPL_ACCT_FEED_IND
                                SYSDATE,              --TBRAPPL_ACTIVITY_DATE
                                NULL,              --TBRAPPL_FEED_DATE
                                'Y',              --TBRAPPL_FEED_DOC_CODE
                                NULL,              --TBRAPPL_CPDT_TRAN_NUMBER
                                NULL,              --TBRAPPL_DIRECT_PAY_TYPE
                                NULL,              --TBRAPPL_INV_NUMBER_PAID
                                NULL,              --TBRAPPL_SURROGATE_ID
                                NULL,              --TBRAPPL_VERSION
                                USER,              --TBRAPPL_USER_ID
                                'AJ',              --TBRAPPL_DATA_ORIGIN
                                NULL);              --TBRAPPL_VPDI_CODE
                     EXCEPTION
                     WHEN OTHERS THEN
                     VL_TRANSACCION :=' Errror al Insertar aplicacion de pagos 1  ' || SQLERRM ;
                     END;

                     BEGIN
                       UPDATE TBRACCD
                          SET TBRACCD_BALANCE = 0
                        WHERE     TBRACCD_PIDM = CARGO.PIDM
                              AND TBRACCD_TRAN_NUMBER = VL_TRANSACCION;
                     END;

                     BEGIN
                       UPDATE TBRACCD
                          SET TBRACCD_BALANCE = 0
                        WHERE     TBRACCD_PIDM = CARGO.PIDM
                              AND TBRACCD_TRAN_NUMBER = CARGO.SECUENCIA;
                     END;

                   END IF;
                 END IF;
               END;
             END LOOP CARGO;
           END LOOP ACCESO;
         END IF;
         ---------------------------------------------------------------------------------------------------------
         --------------------------------- Proceso de BECAS------ ------------------------------------------------
         ---------------------------------------------------------------------------------------------------------
         IF CF.SZVBAEC_AJUSTE_BECA = 'S' THEN

           BEGIN
             SELECT DISTINCT TBBDETC_DESC
               INTO VL_DESCRIPCION
               FROM TBBDETC
              WHERE TBBDETC_DETAIL_CODE = CF.SZVBAEC_CONCEPTO_BECA;--??vP_acceso_code;
           EXCEPTION
           WHEN OTHERS THEN
             VL_DESCRIPCION := NULL;
           END;

           FOR DESCU IN (
                         SELECT DISTINCT ZSTPARA_PARAM_VALOR CATEGORIA
                           FROM ZSTPARA
                          WHERE ZSTPARA_MAPA_ID = 'CONFIGURA_BAJA' AND ZSTPARA_PARAM_ID = 'BECA_CARGO'
           )LOOP
             ---------------------------------------------------------------------------------------------------------
             ------------------ valida que se tenga la categoria correcta para BECAS --------- ---------------
             ---------------------------------------------------------------------------------------------------------
             FOR CARGO IN (
                            SELECT B.TBRACCD_PIDM PIDM,
                                   B.TBRACCD_BALANCE MONTO,
                                   B.TBRACCD_TRAN_NUMBER SECUENCIA,
                                   b.tbraccd_detail_code CODIGO,
                                   B.TBRACCD_BALANCE*(CF.SZVBAEC_PORCENT_BECA/*vp_descuento_porc*//100) DESCUENTO,
                                   SPRIDEN_ID ID,
                                   TBRACCD_STSP_KEY_SEQUENCE,
                                   TBRACCD_PERIOD, --RLS20180131
                                   TBRACCD_TERM_CODE PERIODO,
                                   TBRACCD_RECEIPT_NUMBER
                              FROM TBRACCD B, SPRIDEN
                             WHERE     B.TBRACCD_PIDM = PN_PIDM
                                   AND B.TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                                                          FROM TBBDETC
                                                                          WHERE TBBDETC_DCAT_CODE = DESCU.CATEGORIA
                                                                         AND SUBSTR (TBBDETC_DETAIL_CODE, 1, 2 )  = SUBSTR (B.TBRACCD_TERM_CODE, 1, 2)
                                                                         AND TBBDETC_DETC_ACTIVE_IND = 'Y'
                                                                         AND TBBDETC_TAXT_CODE = PN_NIVEL
                                                                          )
                                   AND B.TBRACCD_BALANCE < 0
                                   AND TRUNC(B.TBRACCD_EFFECTIVE_DATE) <= TO_CHAR (TO_DATE(PN_FECHA_BAJA,'dd/mm/yyyy'))
                                   AND TRUNC(B.TBRACCD_EFFECTIVE_DATE) >= TO_CHAR (TO_DATE(PN_FECHA_INICIO,'dd/mm/yyyy'))
                                   AND B.TBRACCD_TERM_CODE = PN_PERIODO
                                   AND B.TBRACCD_TRAN_NUMBER NOT IN (SELECT TBRAPPL_PAY_TRAN_NUMBER
                                                                                               FROM TBRAPPL
                                                                                               WHERE TBRAPPL_PIDM = B.TBRACCD_PIDM
                                                                                               AND TBRAPPL_REAPPL_IND IS NULL)
                                   AND B.TBRACCD_PIDM = SPRIDEN_PIDM
                                   AND SPRIDEN_CHANGE_IND IS NULL

             )LOOP
             
              DBMS_OUTPUT.PUT_LINE('Entra a los registros de CARGO Bloque 4 '||CARGO.secuencia ||'*'||CARGO.Codigo);
             
               BEGIN
                 SELECT MAX(A1.TBRAPPL_CHG_TRAN_NUMBER)
                   INTO VL_NUMPAG
                   FROM TBRAPPL A1
                  WHERE     A1.TBRAPPL_PIDM = CARGO.PIDM
                        AND A1.TBRAPPL_PAY_TRAN_NUMBER =  CARGO.SECUENCIA
                        AND A1.TBRAPPL_ACTIVITY_DATE = (SELECT MAX (A.TBRAPPL_ACTIVITY_DATE)
                                                          FROM TBRAPPL A
                                                         WHERE     A.TBRAPPL_PIDM = A1.TBRAPPL_PIDM
                                                               AND A.TBRAPPL_PAY_TRAN_NUMBER =  A1.TBRAPPL_PAY_TRAN_NUMBER);
               EXCEPTION
               WHEN OTHERS THEN
               VL_NUMPAG :=NULL;
               END;

               BEGIN
                 SELECT B.TBRACCD_DETAIL_CODE
                   INTO VL_EXISTE_DETAIL
                   FROM TBRACCD B
                  WHERE     B.TBRACCD_PIDM = CARGO.PIDM
                        AND B.TBRACCD_TRAN_NUMBER = VL_NUMPAG;
               EXCEPTION
               WHEN OTHERS THEN
               VL_EXISTE_DETAIL :=NULL;
               END;

               BEGIN

                 IF CF.SZVBAEC_CONCEPTO_BECA <> VL_EXISTE_DETAIL THEN

                   DBMS_OUTPUT.PUT_LINE('cargo bloque 4' ||CARGO.MONTO ||'*'||CARGO.SECUENCIA ||'*'||CARGO.DESCUENTO );

                   VL_TRANSACCION :=0;
                   VL_PERIODO := NULL;

                   BEGIN
                          SELECT NVL(MAX(TBRACCD_TRAN_NUMBER),0) +1
                           INTO VL_TRANSACCION
                          FROM TBRACCD
                          WHERE TBRACCD_PIDM=CARGO.PIDM;
                   EXCEPTION
                       WHEN OTHERS THEN
                         VL_TRANSACCION:=0;
                   END;

                   BEGIN
                    SELECT FGET_PERIODO_GENERAL(SUBSTR(CARGO.ID,1,2))
                           INTO VL_PERIODO
                    FROM DUAL;
                   EXCEPTION
                   WHEN OTHERS THEN
                      VL_PERIODO := '000000';
                   END;


                   BEGIN
                     INSERT
                       INTO TBRACCD
                     VALUES (
                            CARGO.PIDM,   -- TBRACCD_PIDM
                            VL_TRANSACCION,     --TBRACCD_TRAN_NUMBER
                            CARGO.PERIODO,    -- TBRACCD_TERM_CODE
                            CF.SZVBAEC_CONCEPTO_BECA,--??vp_acceso_code,     ---TBRACCD_DETAIL_CODE
                            USER,     ---TBRACCD_USER
                            SYSDATE,     --TBRACCD_ENTRY_DATE
                            NVL(CARGO.DESCUENTO,0),
                            NVL(CARGO.DESCUENTO,0) * -1,    ---TBRACCD_BALANCE
                            SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                            NULL,    --TBRACCD_BILL_DATE
                            NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                            VL_DESCRIPCION,    -- TBRACCD_DESC
                            CARGO.TBRACCD_RECEIPT_NUMBER,     --TBRACCD_RECEIPT_NUMBER
                            CARGO.SECUENCIA,     --TBRACCD_TRAN_NUMBER_PAID
                            NULL,     --TBRACCD_CROSSREF_PIDM
                            NULL,    --TBRACCD_CROSSREF_NUMBER
                            NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                            'T',    --TBRACCD_SRCE_CODE
                            'Y',    --TBRACCD_ACCT_FEED_IND
                            SYSDATE,  --TBRACCD_ACTIVITY_DATE
                            0,        --TBRACCD_SESSION_NUMBER
                            NULL,    -- TBRACCD_CSHR_END_DATE
                            NULL,     --TBRACCD_CRN
                            NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                            NULL,     -- TBRACCD_LOC_MDT
                            NULL,     --TBRACCD_LOC_MDT_SEQ
                            NULL,     -- TBRACCD_RATE
                            NULL,     --TBRACCD_UNITS
                            NULL,     -- TBRACCD_DOCUMENT_NUMBER
                            SYSDATE,  -- TBRACCD_TRANS_DATE
                            NULL,        -- TBRACCD_PAYMENT_ID
                            NULL,     -- TBRACCD_INVOICE_NUMBER
                            NULL,     -- TBRACCD_STATEMENT_DATE
                            NULL,     -- TBRACCD_INV_NUMBER_PAID
                            'MXN',     -- TBRACCD_CURR_CODE
                            NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                            NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                            NULL,     -- TBRACCD_LATE_DCAT_CODE
                            PN_FECHA_INICIO,     -- TBRACCD_FEED_DATE
                            NULL,     -- TBRACCD_FEED_DOC_CODE
                            NULL,     -- TBRACCD_ATYP_CODE
                            NULL,     -- TBRACCD_ATYP_SEQNO
                            NULL,     -- TBRACCD_CARD_TYPE_VR
                            NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                            NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                            NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                            NULL,     -- TBRACCD_ORIG_CHG_IND
                            NULL,     -- TBRACCD_CCRD_CODE
                            NULL,     -- TBRACCD_MERCHANT_ID
                            NULL,     -- TBRACCD_TAX_REPT_YEAR
                            NULL,     -- TBRACCD_TAX_REPT_BOX
                            NULL,     -- TBRACCD_TAX_AMOUNT
                            NULL,     -- TBRACCD_TAX_FUTURE_IND
                            'AUTOMATICO',     -- TBRACCD_DATA_ORIGIN
                            'AUTOMATICO',   -- TBRACCD_CREATE_SOURCE
                            NULL,     -- TBRACCD_CPDT_IND
                            NULL,     --TBRACCD_AIDY_CODE
                            NVL(CARGO.TBRACCD_STSP_KEY_SEQUENCE, PN_KEYSEQNO),   --TBRACCD_STSP_KEY_SEQUENCE
                            NVL (CARGO.TBRACCD_PERIOD, VL_PARTE),    --TBRACCD_PERIOD
                            NULL,    --TBRACCD_SURROGATE_ID
                            NULL,     -- TBRACCD_VERSION
                            USER,     --TBRACCD_USER_ID
                            NULL );     --TBRACCD_VPDI_CODE
                            
                             DBMS_OUTPUT.PUT_LINE('Entra a los registros de Colegiatura bloque 4'||VL_TRANSACCION ||'*'||CF.SZVBAEC_CONCEPTO_BECA);
                            
                   EXCEPTION
                   WHEN OTHERS THEN
                   VL_ERROR := 'Se presento el siguiente error al momento de insertar ajuste para BECAS en TBRACCD '||SQLERRM;
                   END;

                 END IF;
               END;
             END LOOP CARGO;
           END LOOP DESCU;
         END IF;
         ---------------------------------------------------------------------------------------------------------
         --------------------------------- Proceso de Descuentos -------------------------------------------------
         ---------------------------------------------------------------------------------------------------------
         IF CF.SZVBAEC_AJUSTE_DESCTO = 'S' THEN

           BEGIN
             SELECT DISTINCT TBBDETC_DESC
               INTO VL_DESCRIPCION
               FROM TBBDETC
              WHERE TBBDETC_DETAIL_CODE = CF.SZVBAEC_CONCEPTO_DESCTO;
           EXCEPTION
           WHEN OTHERS THEN
           VL_DESCRIPCION := NULL;
           END;

           FOR DESCU IN (
                         SELECT DISTINCT ZSTPARA_PARAM_VALOR CATEGORIA
                           FROM ZSTPARA
                          WHERE ZSTPARA_MAPA_ID = 'CONFIGURA_BAJA' AND ZSTPARA_PARAM_ID = 'DESCUENTO_CARGO'
           )LOOP
             ---------------------------------------------------------------------------------------------------------
             ------------------ valida que se tenga la categoria correcta para Descuentos  ---------------------------
             ---------------------------------------------------------------------------------------------------------
             FOR CARGO IN (
                          SELECT B.TBRACCD_PIDM PIDM,
                                 B.TBRACCD_AMOUNT MONTO,
                                 B.TBRACCD_TRAN_NUMBER SECUENCIA,
                                 B.TBRACCD_AMOUNT*(CF.SZVBAEC_PORCENT_DESCTO/*vp_descuento_porc*//100) DESCUENTO,
                                 SPRIDEN_ID ID,
                                 TBRACCD_STSP_KEY_SEQUENCE,
                                 TBRACCD_PERIOD, --RLS20180131
                                 TBRACCD_TERM_CODE PERIODO,
                                 TBRACCD_RECEIPT_NUMBER
                            FROM TBRACCD B, SPRIDEN
                           WHERE     B.TBRACCD_PIDM = PN_PIDM
                                 AND B.TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                                                 FROM TBBDETC
                                                                WHERE     TBBDETC_DCAT_CODE IN DESCU.CATEGORIA
                                                                      AND SUBSTR (TBBDETC_DETAIL_CODE,1,2) = SUBSTR (B.TBRACCD_TERM_CODE,1,2)
                                                                      AND TBBDETC_DETC_ACTIVE_IND = 'Y')
                                 AND B.TBRACCD_TERM_CODE = PN_PERIODO
                                 AND B.TBRACCD_PIDM = SPRIDEN_PIDM
                                 AND SPRIDEN_CHANGE_IND IS NULL

             )LOOP

               BEGIN
                 SELECT MAX(A1.TBRAPPL_CHG_TRAN_NUMBER)
                   INTO VL_NUMPAG
                   FROM TBRAPPL A1
                  WHERE     A1.TBRAPPL_PIDM = CARGO.PIDM
                        AND A1.TBRAPPL_PAY_TRAN_NUMBER =  CARGO.SECUENCIA
                        AND A1.TBRAPPL_ACTIVITY_DATE = (SELECT MAX (A.TBRAPPL_ACTIVITY_DATE)
                                                          FROM TBRAPPL A
                                                         WHERE     A.TBRAPPL_PIDM = A1.TBRAPPL_PIDM
                                                               AND A.TBRAPPL_PAY_TRAN_NUMBER =  A1.TBRAPPL_PAY_TRAN_NUMBER);
               EXCEPTION
               WHEN OTHERS THEN
               VL_NUMPAG :=NULL;
               END;

               BEGIN
                 SELECT B.TBRACCD_DETAIL_CODE
                   INTO VL_EXISTE_DETAIL
                   FROM TBRACCD B
                  WHERE     B.TBRACCD_PIDM = PN_PIDM
                        AND B.TBRACCD_TRAN_NUMBER = VL_NUMPAG;
               EXCEPTION
               WHEN OTHERS THEN
               VL_EXISTE_DETAIL :=NULL;
               END;

               BEGIN

                 IF CF.SZVBAEC_CONCEPTO_DESCTO <> VL_EXISTE_DETAIL THEN

                   VL_TRANSACCION :=0;
                   VL_PERIODO := NULL;

                   BEGIN
                          SELECT NVL(MAX(TBRACCD_TRAN_NUMBER),0) +1
                           INTO VL_TRANSACCION
                          FROM TBRACCD
                          WHERE TBRACCD_PIDM=CARGO.PIDM;
                   EXCEPTION
                       WHEN OTHERS THEN
                         VL_TRANSACCION:=0;
                   END;

                   BEGIN
                    SELECT FGET_PERIODO_GENERAL(SUBSTR(CARGO.ID,1,2))
                           INTO VL_PERIODO
                    FROM DUAL;
                   EXCEPTION
                   WHEN OTHERS THEN
                      VL_PERIODO := '000000';
                   END;


                   BEGIN
                     INSERT
                       INTO TBRACCD
                     VALUES (
                            CARGO.PIDM,   -- TBRACCD_PIDM
                            VL_TRANSACCION,     --TBRACCD_TRAN_NUMBER
                            CARGO.PERIODO,    -- TBRACCD_TERM_CODE
                            CF.SZVBAEC_CONCEPTO_DESCTO,--??vp_acceso_code,     ---TBRACCD_DETAIL_CODE
                            USER,     ---TBRACCD_USER
                            SYSDATE,     --TBRACCD_ENTRY_DATE
                            NVL(CARGO.DESCUENTO,0),
                            NVL(CARGO.DESCUENTO,0),    ---TBRACCD_BALANCE
                            SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                            NULL,    --TBRACCD_BILL_DATE
                            NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                            VL_DESCRIPCION,    -- TBRACCD_DESC
                            CARGO.TBRACCD_RECEIPT_NUMBER,     --TBRACCD_RECEIPT_NUMBER
                            CARGO.SECUENCIA,     --TBRACCD_TRAN_NUMBER_PAID
                            NULL,     --TBRACCD_CROSSREF_PIDM
                            NULL,    --TBRACCD_CROSSREF_NUMBER
                            NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                            'T',    --TBRACCD_SRCE_CODE
                            'Y',    --TBRACCD_ACCT_FEED_IND
                            SYSDATE,  --TBRACCD_ACTIVITY_DATE
                            0,        --TBRACCD_SESSION_NUMBER
                            NULL,    -- TBRACCD_CSHR_END_DATE
                            NULL,     --TBRACCD_CRN
                            NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                            NULL,     -- TBRACCD_LOC_MDT
                            NULL,     --TBRACCD_LOC_MDT_SEQ
                            NULL,     -- TBRACCD_RATE
                            NULL,     --TBRACCD_UNITS
                            NULL,     -- TBRACCD_DOCUMENT_NUMBER
                            SYSDATE,  -- TBRACCD_TRANS_DATE
                            NULL,        -- TBRACCD_PAYMENT_ID
                            NULL,     -- TBRACCD_INVOICE_NUMBER
                            NULL,     -- TBRACCD_STATEMENT_DATE
                            NULL,     -- TBRACCD_INV_NUMBER_PAID
                            'MXN',     -- TBRACCD_CURR_CODE
                            NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                            NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                            NULL,     -- TBRACCD_LATE_DCAT_CODE
                            PN_FECHA_INICIO,     -- TBRACCD_FEED_DATE
                            NULL,     -- TBRACCD_FEED_DOC_CODE
                            NULL,     -- TBRACCD_ATYP_CODE
                            NULL,     -- TBRACCD_ATYP_SEQNO
                            NULL,     -- TBRACCD_CARD_TYPE_VR
                            NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                            NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                            NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                            NULL,     -- TBRACCD_ORIG_CHG_IND
                            NULL,     -- TBRACCD_CCRD_CODE
                            NULL,     -- TBRACCD_MERCHANT_ID
                            NULL,     -- TBRACCD_TAX_REPT_YEAR
                            NULL,     -- TBRACCD_TAX_REPT_BOX
                            NULL,     -- TBRACCD_TAX_AMOUNT
                            NULL,     -- TBRACCD_TAX_FUTURE_IND
                            'AUTOMATICO',     -- TBRACCD_DATA_ORIGIN
                            'AUTOMATICO',   -- TBRACCD_CREATE_SOURCE
                            NULL,     -- TBRACCD_CPDT_IND
                            NULL,     --TBRACCD_AIDY_CODE
                            NVL( CARGO.TBRACCD_STSP_KEY_SEQUENCE ,PN_KEYSEQNO),     --TBRACCD_STSP_KEY_SEQUENCE
                            NVL(CARGO.TBRACCD_PERIOD , VL_PARTE),    --TBRACCD_PERIOD
                            NULL,    --TBRACCD_SURROGATE_ID
                            NULL,     -- TBRACCD_VERSION
                            USER,     --TBRACCD_USER_ID
                            NULL );     --TBRACCD_VPDI_CODE
                   EXCEPTION
                   WHEN OTHERS THEN
                   VL_ERROR := 'Se presento el siguiente error al momento de insertar ajuste para Descuento en TBRACCD '||SQLERRM;
                   END;

                   IF  CARGO.DESCUENTO = CARGO.MONTO THEN

                     BEGIN
                       INSERT
                         INTO TBRAPPL
                       VALUES (
                                CARGO.PIDM,               --TBRAPPL_PIDM
                                CARGO.SECUENCIA,               --TBRAPPL_PAY_TRAN_NUMBER
                                VL_TRANSACCION,               --TBRAPPL_CHG_TRAN_NUMBER
                                CARGO.DESCUENTO,              --TBRAPPL_AMOUNT
                                'Y',             --TBRAPPL_DIRECT_PAY_IND
                                NULL,              --TBRAPPL_REAPPL_IND
                                USER,              --TBRAPPL_USER
                                'Y',              --TBRAPPL_ACCT_FEED_IND
                                SYSDATE,              --TBRAPPL_ACTIVITY_DATE
                                NULL,              --TBRAPPL_FEED_DATE
                                NULL,              --TBRAPPL_FEED_DOC_CODE
                                NULL,              --TBRAPPL_CPDT_TRAN_NUMBER
                                'T',              --TBRAPPL_DIRECT_PAY_TYPE
                                NULL,              --TBRAPPL_INV_NUMBER_PAID
                                NULL,              --TBRAPPL_SURROGATE_ID
                                NULL,              --TBRAPPL_VERSION
                                USER,              --TBRAPPL_USER_ID
                                'AJ',              --TBRAPPL_DATA_ORIGIN
                                NULL);              --TBRAPPL_VPDI_CODE
                     EXCEPTION
                     WHEN OTHERS THEN
                     VL_TRANSACCION :=' Errror al Insertar aplicacion de pagos 1  ' || SQLERRM ;
                     END;

                     BEGIN
                       UPDATE TBRACCD
                          SET TBRACCD_BALANCE = 0
                        WHERE     TBRACCD_PIDM = CARGO.PIDM
                              AND TBRACCD_TRAN_NUMBER = VL_TRANSACCION;
                     END;

                     BEGIN
                       UPDATE TBRACCD
                          SET TBRACCD_BALANCE = 0,TBRACCD_TRAN_NUMBER_PAID = VL_TRANSACCION
                        WHERE     TBRACCD_PIDM = CARGO.PIDM
                              AND TBRACCD_TRAN_NUMBER = CARGO.SECUENCIA;
                     END;

                   END IF;
                 END IF;
               END;
             END LOOP CARGO;
           END LOOP DESCU;

           BEGIN
            UPDATE TBBESTU A
               SET A.TBBESTU_DEL_IND = 'D',
                   A.TBBESTU_STUDENT_EXPT_ROLL_IND = 'N'
             WHERE     A.TBBESTU_PIDM = PN_PIDM
                   AND A.TBBESTU_EXEMPTION_CODE IN (SELECT MAX (A1.TBBESTU_EXEMPTION_CODE)
                                                      FROM TBBESTU A1
                                                     WHERE A.TBBESTU_PIDM = A1.TBBESTU_PIDM)
                   AND TBBESTU_DEL_IND IS NULL;
           EXCEPTION
           WHEN OTHERS THEN
              VL_ERROR := 'Se presento el error al actualizar el descuento' || SQLERRM;

           END;

         END IF;
         ---------------------------------------------------------------------------------------------------------
         --------------------------------- Proceso INTERESES------------------------------------------------------
         ---------------------------------------------------------------------------------------------------------
         DBMS_OUTPUT.PUT_LINE('VALIDACION_1 = '||PN_ESTATUS);
         DBMS_OUTPUT.PUT_LINE('VALIDACION_2 = '||PN_FECHA_BAJA);
         DBMS_OUTPUT.PUT_LINE('VALIDACION_3 = '||PN_FECHA_FIN);
         DBMS_OUTPUT.PUT_LINE('VALIDACION_4 = '||PN_FECHA_INICIO);
         --DBMS_OUTPUT.PUT_LINE('VALIDACION_4 = '||DESCU.CATEGORIA);

         IF CF.SZVBAEC_AJUSTE_INTERES = 'S' AND PN_ESTATUS != 'BA' THEN
         DBMS_OUTPUT.PUT_LINE('ENTRA AL PRIMER IF_5 = ');
           BEGIN
             SELECT DISTINCT TBBDETC_DESC
               INTO VL_DESCRIPCION
               FROM TBBDETC
              WHERE TBBDETC_DETAIL_CODE = CF.SZVBAEC_CONCEPTO_INTERES;--??vP_acceso_code;
           EXCEPTION
           WHEN OTHERS THEN
           VL_DESCRIPCION := NULL;
           END;

           FOR DESCU IN (
                         SELECT DISTINCT ZSTPARA_PARAM_VALOR CATEGORIA
                           FROM ZSTPARA
                          WHERE ZSTPARA_MAPA_ID = 'CONFIGURA_BAJA' AND ZSTPARA_PARAM_ID = 'INTERES_CARGO'
           )LOOP
                ---------------------------------------------------------------------------------------------------------
                ------------------ valida que se tenga la categoria correcta para INTERES  ------------------------------
                ---------------------------------------------------------------------------------------------------------
             FOR CARGO IN (
                         SELECT  B.TBRACCD_PIDM PIDM,
                                 B.TBRACCD_AMOUNT MONTO,
                                 B.TBRACCD_TRAN_NUMBER SECUENCIA,
                                 B.TBRACCD_AMOUNT*(CF.SZVBAEC_PORCENT_INTERES/*vp_descuento_porc*//100) DESCUENTO,
                                 SPRIDEN_ID ID,
                                 TBRACCD_STSP_KEY_SEQUENCE ,
                                 TBRACCD_PERIOD, --RLS20180131
                                 TBRACCD_TERM_CODE PERIODO,
                                 TBRACCD_RECEIPT_NUMBER,
                                 tbraccd_detail_code codigo
                           FROM TBRACCD B, SPRIDEN
                          WHERE     B.TBRACCD_PIDM = PN_PIDM
                                AND B.TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                                                FROM TBBDETC
                                                               WHERE TBBDETC_DCAT_CODE = DESCU.CATEGORIA
                                                                     AND SUBSTR (TBBDETC_DETAIL_CODE, 1, 2 )  = SUBSTR (B.TBRACCD_TERM_CODE, 1, 2)
                                                                     AND TBBDETC_DETC_ACTIVE_IND = 'Y')
                                AND TO_CHAR(TRUNC(B.TBRACCD_EFFECTIVE_DATE),'MM/YY') <= TO_CHAR(TO_DATE(PN_FECHA_BAJA,'DD/MM/YY'),'MM/YY')
                                AND TRUNC(B.TBRACCD_EFFECTIVE_DATE) >= TO_CHAR (TO_DATE(PN_FECHA_INICIO,'dd/mm/yy'))
                                AND B.TBRACCD_EFFECTIVE_DATE IN (SELECT(B1.TBRACCD_EFFECTIVE_DATE)
                                                                   FROM TBRACCD B1
                                                                  WHERE     TRUNC(B.TBRACCD_EFFECTIVE_DATE) >= TO_CHAR (TO_DATE(PN_FECHA_INICIO,'dd/mm/yy'))
                                                                        AND TO_CHAR(TRUNC(B.TBRACCD_EFFECTIVE_DATE),'MM/YY') <= TO_CHAR(TO_DATE(PN_FECHA_FIN,'DD/MM/YY'),'MM/YY'))
                                AND B.TBRACCD_TRAN_NUMBER NOT IN (SELECT TBRAPPL_PAY_TRAN_NUMBER
                                                                    FROM TBRAPPL
                                                                   WHERE     TBRAPPL_PIDM = B.TBRACCD_PIDM
                                                                         AND TBRAPPL_REAPPL_IND IS NULL)
                                AND B.TBRACCD_PIDM = SPRIDEN_PIDM
                                AND SPRIDEN_CHANGE_IND IS NULL
                          ORDER BY B.TBRACCD_TRAN_NUMBER

             )LOOP

                    DBMS_OUTPUT.PUT_LINE('Entra a los registros de Colegiatura bloque 6'||CARGO.secuencia ||'*'||CARGO.Codigo);

               BEGIN
                 SELECT MAX(A1.TBRAPPL_PAY_TRAN_NUMBER)
                   INTO VL_NUMPAG
                   FROM TBRAPPL A1
                  WHERE     A1.TBRAPPL_PIDM = PN_PIDM
                        AND A1.TBRAPPL_CHG_TRAN_NUMBER =  CARGO.SECUENCIA
                        AND A1.TBRAPPL_ACTIVITY_DATE = (SELECT MAX (A.TBRAPPL_ACTIVITY_DATE)
                                                          FROM TBRAPPL A
                                                         WHERE     A.TBRAPPL_PIDM = A1.TBRAPPL_PIDM
                                                               AND A.TBRAPPL_CHG_TRAN_NUMBER =  A1.TBRAPPL_CHG_TRAN_NUMBER);
               EXCEPTION
               WHEN OTHERS THEN
               VL_NUMPAG :=0;
               END;

               BEGIN
                 SELECT B.TBRACCD_DETAIL_CODE
                   INTO VL_EXISTE_DETAIL
                   FROM TBRACCD B
                  WHERE     B.TBRACCD_PIDM = PN_PIDM
                        AND B.TBRACCD_TRAN_NUMBER = VL_NUMPAG;
               EXCEPTION
               WHEN OTHERS THEN
               VL_EXISTE_DETAIL :=0;
               END;

               BEGIN

                 IF CF.SZVBAEC_CONCEPTO_INTERES <> VL_EXISTE_DETAIL THEN

                   VL_TRANSACCION :=0;
                   VL_PERIODO := NULL;

                   BEGIN
                     SELECT NVL(MAX(TBRACCD_TRAN_NUMBER),0) +1
                       INTO VL_TRANSACCION
                       FROM TBRACCD
                      WHERE TBRACCD_PIDM=CARGO.PIDM;
                   EXCEPTION
                       WHEN OTHERS THEN
                         VL_TRANSACCION:=0;
                   END;

                   BEGIN
                     SELECT FGET_PERIODO_GENERAL(SUBSTR(CARGO.ID,1,2))
                       INTO VL_PERIODO
                       FROM DUAL;
                   EXCEPTION
                   WHEN OTHERS THEN
                      VL_PERIODO := '000000';
                   END;

                   PKG_FINANZAS.P_DESAPLICA_PAGOS (CARGO.PIDM, CARGO.SECUENCIA) ;

                    BEGIN
                       INSERT
                         INTO TBRACCD
                       VALUES (
                                CARGO.PIDM,   -- TBRACCD_PIDM
                                VL_TRANSACCION,     --TBRACCD_TRAN_NUMBER
                                CARGO.PERIODO,    -- TBRACCD_TERM_CODE
                                CF.SZVBAEC_CONCEPTO_INTERES,--??vp_acceso_code,     ---TBRACCD_DETAIL_CODE
                                USER,     ---TBRACCD_USER
                                SYSDATE,     --TBRACCD_ENTRY_DATE
                                NVL(CARGO.DESCUENTO,0),
                                NVL(CARGO.DESCUENTO,0) * -1,    ---TBRACCD_BALANCE
                                SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                                NULL,    --TBRACCD_BILL_DATE
                                NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                                VL_DESCRIPCION,    -- TBRACCD_DESC
                                CARGO.TBRACCD_RECEIPT_NUMBER,     --TBRACCD_RECEIPT_NUMBER
                                CARGO.SECUENCIA,     --TBRACCD_TRAN_NUMBER_PAID
                                NULL,     --TBRACCD_CROSSREF_PIDM
                                NULL,    --TBRACCD_CROSSREF_NUMBER
                                NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                                'T',    --TBRACCD_SRCE_CODE
                                'Y',    --TBRACCD_ACCT_FEED_IND
                                SYSDATE,  --TBRACCD_ACTIVITY_DATE
                                0,        --TBRACCD_SESSION_NUMBER
                                NULL,    -- TBRACCD_CSHR_END_DATE
                                NULL,     --TBRACCD_CRN
                                NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                                NULL,     -- TBRACCD_LOC_MDT
                                NULL,     --TBRACCD_LOC_MDT_SEQ
                                NULL,     -- TBRACCD_RATE
                                NULL,     --TBRACCD_UNITS
                                NULL,     -- TBRACCD_DOCUMENT_NUMBER
                                SYSDATE,  -- TBRACCD_TRANS_DATE
                                NULL,        -- TBRACCD_PAYMENT_ID
                                NULL,     -- TBRACCD_INVOICE_NUMBER
                                NULL,     -- TBRACCD_STATEMENT_DATE
                                NULL,     -- TBRACCD_INV_NUMBER_PAID
                                'MXN',     -- TBRACCD_CURR_CODE
                                NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                                NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                                NULL,     -- TBRACCD_LATE_DCAT_CODE
                                PN_FECHA_INICIO,     -- TBRACCD_FEED_DATE
                                NULL,     -- TBRACCD_FEED_DOC_CODE
                                NULL,     -- TBRACCD_ATYP_CODE
                                NULL,     -- TBRACCD_ATYP_SEQNO
                                NULL,     -- TBRACCD_CARD_TYPE_VR
                                NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                                NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                                NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                                NULL,     -- TBRACCD_ORIG_CHG_IND
                                NULL,     -- TBRACCD_CCRD_CODE
                                NULL,     -- TBRACCD_MERCHANT_ID
                                NULL,     -- TBRACCD_TAX_REPT_YEAR
                                NULL,     -- TBRACCD_TAX_REPT_BOX
                                NULL,     -- TBRACCD_TAX_AMOUNT
                                NULL,     -- TBRACCD_TAX_FUTURE_IND
                                'AUTOMATICO',     -- TBRACCD_DATA_ORIGIN
                                'AUTOMATICO',   -- TBRACCD_CREATE_SOURCE
                                NULL,     -- TBRACCD_CPDT_IND
                                NULL,     --TBRACCD_AIDY_CODE
                                NVL (CARGO.TBRACCD_STSP_KEY_SEQUENCE,PN_KEYSEQNO) ,     --TBRACCD_STSP_KEY_SEQUENCE
                                NVL (CARGO.TBRACCD_PERIOD ,VL_PARTE),     --TBRACCD_PERIOD
                                NULL,    --TBRACCD_SURROGATE_ID
                                NULL,     -- TBRACCD_VERSION
                                USER,     --TBRACCD_USER_ID
                                NULL );     --TBRACCD_VPDI_CODE
                   EXCEPTION
                   WHEN OTHERS THEN
                   VL_ERROR := 'Se presento el siguiente error al momento de insertar ajuste para INTERESES en TBRACCD '||SQLERRM;
                   END;


                   IF  CARGO.DESCUENTO = CARGO.MONTO THEN

                     BEGIN
                       INSERT
                         INTO TBRAPPL
                       VALUES (
                                CARGO.PIDM,               --TBRAPPL_PIDM
                                VL_TRANSACCION,               --TBRAPPL_PAY_TRAN_NUMBER
                                CARGO.SECUENCIA,               --TBRAPPL_CHG_TRAN_NUMBER
                                CARGO.DESCUENTO,              --TBRAPPL_AMOUNT
                                NULL,             --TBRAPPL_DIRECT_PAY_IND
                                NULL,              --TBRAPPL_REAPPL_IND
                                USER,              --TBRAPPL_USER
                                'Y',              --TBRAPPL_ACCT_FEED_IND
                                SYSDATE,              --TBRAPPL_ACTIVITY_DATE
                                NULL,              --TBRAPPL_FEED_DATE
                                'Y',              --TBRAPPL_FEED_DOC_CODE
                                NULL,              --TBRAPPL_CPDT_TRAN_NUMBER
                                NULL,              --TBRAPPL_DIRECT_PAY_TYPE
                                NULL,              --TBRAPPL_INV_NUMBER_PAID
                                NULL,              --TBRAPPL_SURROGATE_ID
                                NULL,              --TBRAPPL_VERSION
                                USER,              --TBRAPPL_USER_ID
                                'AJ',              --TBRAPPL_DATA_ORIGIN
                                NULL);              --TBRAPPL_VPDI_CODE
                     EXCEPTION
                     WHEN OTHERS THEN
                       VL_TRANSACCION :=' Errror al Insertar aplicacion de pagos 1  ' || SQLERRM ;
                     END;

                     BEGIN
                       UPDATE TBRACCD
                          SET TBRACCD_BALANCE = 0
                        WHERE     TBRACCD_PIDM = CARGO.PIDM
                              AND TBRACCD_TRAN_NUMBER = VL_TRANSACCION;
                     END;

                     BEGIN
                       UPDATE TBRACCD
                          SET TBRACCD_BALANCE = 0
                        WHERE     TBRACCD_PIDM = CARGO.PIDM
                              AND TBRACCD_TRAN_NUMBER = CARGO.SECUENCIA;
                     END;

                   END IF;
                 END IF;
               END;
             END LOOP CARGO;
           END LOOP DESCU;

         ELSIF CF.SZVBAEC_AJUSTE_INTERES = 'S' AND PN_ESTATUS = 'BA' THEN
--         DBMS_OUTPUT.PUT_LINE('ENTRA AL SEGUNDO IF_6 = ');
           BEGIN
               SELECT DISTINCT TBBDETC_DESC
                 INTO VL_DESCRIPCION
                 FROM TBBDETC
                WHERE TBBDETC_DETAIL_CODE = CF.SZVBAEC_CONCEPTO_INTERES;--??vP_acceso_code;
           EXCEPTION
           WHEN OTHERS THEN
           VL_DESCRIPCION := NULL;
           END;

               FOR DESCU IN (
                             SELECT DISTINCT ZSTPARA_PARAM_VALOR CATEGORIA
                               FROM ZSTPARA
                              WHERE ZSTPARA_MAPA_ID = 'CONFIGURA_BAJA' AND ZSTPARA_PARAM_ID = 'INTERES_CARGO'
           )LOOP
                ---------------------------------------------------------------------------------------------------------
                ------------------ valida que se tenga la categoria correcta para INTERES  ------------------------------
                ---------------------------------------------------------------------------------------------------------
             FOR CARGO IN (
                         SELECT  B.TBRACCD_PIDM PIDM,
                                 B.TBRACCD_AMOUNT MONTO,
                                 B.TBRACCD_TRAN_NUMBER SECUENCIA,
                                 B.TBRACCD_AMOUNT*(CF.SZVBAEC_PORCENT_INTERES/*vp_descuento_porc*//100) DESCUENTO,
                                 SPRIDEN_ID ID,
                                 TBRACCD_STSP_KEY_SEQUENCE ,
                                 TBRACCD_PERIOD, --RLS20180131
                                 TBRACCD_TERM_CODE PERIODO,
                                 TBRACCD_RECEIPT_NUMBER
                           FROM TBRACCD B, SPRIDEN
                          WHERE     B.TBRACCD_PIDM = PN_PIDM
                                AND B.TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                                                FROM TBBDETC
                                                               WHERE TBBDETC_DCAT_CODE = DESCU.CATEGORIA
                                                                     AND SUBSTR (TBBDETC_DETAIL_CODE, 1, 2 )  = SUBSTR (B.TBRACCD_TERM_CODE, 1, 2)
                                                                     AND TBBDETC_DETC_ACTIVE_IND = 'Y')
                                AND TO_CHAR(TRUNC(B.TBRACCD_EFFECTIVE_DATE),'MM/YY') >= TO_CHAR(TO_DATE(PN_FECHA_FIN,'DD/MM/YY'),'MM/YY')
                                AND TRUNC(B.TBRACCD_EFFECTIVE_DATE) >= TO_CHAR (TO_DATE(PN_FECHA_INICIO,'dd/mm/yy'))
--                                AND B.TBRACCD_EFFECTIVE_DATE IN (SELECT(B1.TBRACCD_EFFECTIVE_DATE)
--                                                                   FROM TBRACCD B1
--                                                                  WHERE     TRUNC(B.TBRACCD_EFFECTIVE_DATE) >= TO_CHAR (TO_DATE(PN_FECHA_INICIO,'dd/mm/yy'))
--                                                                        AND TO_CHAR(TRUNC(B.TBRACCD_EFFECTIVE_DATE),'MM/YY') <= TO_CHAR(TO_DATE(PN_FECHA_FIN,'DD/MM/YY'),'MM/YY'))
                                AND B.TBRACCD_TRAN_NUMBER NOT IN (SELECT TBRAPPL_PAY_TRAN_NUMBER
                                                                    FROM TBRAPPL
                                                                   WHERE     TBRAPPL_PIDM = B.TBRACCD_PIDM
                                                                         AND TBRAPPL_REAPPL_IND IS NULL)
                                AND B.TBRACCD_PIDM = SPRIDEN_PIDM
                                AND SPRIDEN_CHANGE_IND IS NULL
                          ORDER BY B.TBRACCD_TRAN_NUMBER

             )LOOP

               BEGIN
                 SELECT MAX(A1.TBRAPPL_PAY_TRAN_NUMBER)
                   INTO VL_NUMPAG
                   FROM TBRAPPL A1
                  WHERE     A1.TBRAPPL_PIDM = PN_PIDM
                        AND A1.TBRAPPL_CHG_TRAN_NUMBER =  CARGO.SECUENCIA
                        AND A1.TBRAPPL_ACTIVITY_DATE = (SELECT MAX (A.TBRAPPL_ACTIVITY_DATE)
                                                          FROM TBRAPPL A
                                                         WHERE     A.TBRAPPL_PIDM = A1.TBRAPPL_PIDM
                                                               AND A.TBRAPPL_CHG_TRAN_NUMBER =  A1.TBRAPPL_CHG_TRAN_NUMBER);
               EXCEPTION
               WHEN OTHERS THEN
               VL_NUMPAG :=0;
               END;

               BEGIN
                 SELECT B.TBRACCD_DETAIL_CODE
                   INTO VL_EXISTE_DETAIL
                   FROM TBRACCD B
                  WHERE     B.TBRACCD_PIDM = PN_PIDM
                        AND B.TBRACCD_TRAN_NUMBER = VL_NUMPAG;
               EXCEPTION
               WHEN OTHERS THEN
               VL_EXISTE_DETAIL :=0;
               END;

               BEGIN

                 IF CF.SZVBAEC_CONCEPTO_INTERES <> VL_EXISTE_DETAIL THEN

                   VL_TRANSACCION :=0;
                   VL_PERIODO := NULL;

                   BEGIN
                     SELECT NVL(MAX(TBRACCD_TRAN_NUMBER),0) +1
                       INTO VL_TRANSACCION
                       FROM TBRACCD
                      WHERE TBRACCD_PIDM=CARGO.PIDM;
                   EXCEPTION
                       WHEN OTHERS THEN
                         VL_TRANSACCION:=0;
                   END;

                   BEGIN
                     SELECT FGET_PERIODO_GENERAL(SUBSTR(CARGO.ID,1,2))
                       INTO VL_PERIODO
                       FROM DUAL;
                   EXCEPTION
                   WHEN OTHERS THEN
                      VL_PERIODO := '000000';
                   END;

                   PKG_FINANZAS.P_DESAPLICA_PAGOS (CARGO.PIDM, CARGO.SECUENCIA) ;

                    BEGIN
                       INSERT
                         INTO TBRACCD
                       VALUES (
                                CARGO.PIDM,   -- TBRACCD_PIDM
                                VL_TRANSACCION,     --TBRACCD_TRAN_NUMBER
                                CARGO.PERIODO,    -- TBRACCD_TERM_CODE
                                CF.SZVBAEC_CONCEPTO_INTERES,--??vp_acceso_code,     ---TBRACCD_DETAIL_CODE
                                USER,     ---TBRACCD_USER
                                SYSDATE,     --TBRACCD_ENTRY_DATE
                                NVL(CARGO.DESCUENTO,0),
                                NVL(CARGO.DESCUENTO,0) * -1,    ---TBRACCD_BALANCE
                                SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                                NULL,    --TBRACCD_BILL_DATE
                                NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                                VL_DESCRIPCION,    -- TBRACCD_DESC
                                CARGO.TBRACCD_RECEIPT_NUMBER,     --TBRACCD_RECEIPT_NUMBER
                                CARGO.SECUENCIA,     --TBRACCD_TRAN_NUMBER_PAID
                                NULL,     --TBRACCD_CROSSREF_PIDM
                                NULL,    --TBRACCD_CROSSREF_NUMBER
                                NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                                'T',    --TBRACCD_SRCE_CODE
                                'Y',    --TBRACCD_ACCT_FEED_IND
                                SYSDATE,  --TBRACCD_ACTIVITY_DATE
                                0,        --TBRACCD_SESSION_NUMBER
                                NULL,    -- TBRACCD_CSHR_END_DATE
                                NULL,     --TBRACCD_CRN
                                NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                                NULL,     -- TBRACCD_LOC_MDT
                                NULL,     --TBRACCD_LOC_MDT_SEQ
                                NULL,     -- TBRACCD_RATE
                                NULL,     --TBRACCD_UNITS
                                NULL,     -- TBRACCD_DOCUMENT_NUMBER
                                SYSDATE,  -- TBRACCD_TRANS_DATE
                                NULL,        -- TBRACCD_PAYMENT_ID
                                NULL,     -- TBRACCD_INVOICE_NUMBER
                                NULL,     -- TBRACCD_STATEMENT_DATE
                                NULL,     -- TBRACCD_INV_NUMBER_PAID
                                'MXN',     -- TBRACCD_CURR_CODE
                                NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                                NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                                NULL,     -- TBRACCD_LATE_DCAT_CODE
                                PN_FECHA_INICIO,     -- TBRACCD_FEED_DATE
                                NULL,     -- TBRACCD_FEED_DOC_CODE
                                NULL,     -- TBRACCD_ATYP_CODE
                                NULL,     -- TBRACCD_ATYP_SEQNO
                                NULL,     -- TBRACCD_CARD_TYPE_VR
                                NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                                NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                                NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                                NULL,     -- TBRACCD_ORIG_CHG_IND
                                NULL,     -- TBRACCD_CCRD_CODE
                                NULL,     -- TBRACCD_MERCHANT_ID
                                NULL,     -- TBRACCD_TAX_REPT_YEAR
                                NULL,     -- TBRACCD_TAX_REPT_BOX
                                NULL,     -- TBRACCD_TAX_AMOUNT
                                NULL,     -- TBRACCD_TAX_FUTURE_IND
                                'AUTOMATICO',     -- TBRACCD_DATA_ORIGIN
                                'AUTOMATICO',   -- TBRACCD_CREATE_SOURCE
                                NULL,     -- TBRACCD_CPDT_IND
                                NULL,     --TBRACCD_AIDY_CODE
                                NVL (CARGO.TBRACCD_STSP_KEY_SEQUENCE,PN_KEYSEQNO) ,     --TBRACCD_STSP_KEY_SEQUENCE
                                NVL (CARGO.TBRACCD_PERIOD ,VL_PARTE),     --TBRACCD_PERIOD
                                NULL,    --TBRACCD_SURROGATE_ID
                                NULL,     -- TBRACCD_VERSION
                                USER,     --TBRACCD_USER_ID
                                NULL );     --TBRACCD_VPDI_CODE
                   EXCEPTION
                   WHEN OTHERS THEN
                   VL_ERROR := 'Se presento el siguiente error al momento de insertar ajuste para INTERESES en TBRACCD '||SQLERRM;
                   END;


                   IF  CARGO.DESCUENTO = CARGO.MONTO THEN

                     BEGIN
                       INSERT
                         INTO TBRAPPL
                       VALUES (
                                CARGO.PIDM,               --TBRAPPL_PIDM
                                VL_TRANSACCION,               --TBRAPPL_PAY_TRAN_NUMBER
                                CARGO.SECUENCIA,               --TBRAPPL_CHG_TRAN_NUMBER
                                CARGO.DESCUENTO,              --TBRAPPL_AMOUNT
                                NULL,             --TBRAPPL_DIRECT_PAY_IND
                                NULL,              --TBRAPPL_REAPPL_IND
                                USER,              --TBRAPPL_USER
                                'Y',              --TBRAPPL_ACCT_FEED_IND
                                SYSDATE,              --TBRAPPL_ACTIVITY_DATE
                                NULL,              --TBRAPPL_FEED_DATE
                                'Y',              --TBRAPPL_FEED_DOC_CODE
                                NULL,              --TBRAPPL_CPDT_TRAN_NUMBER
                                NULL,              --TBRAPPL_DIRECT_PAY_TYPE
                                NULL,              --TBRAPPL_INV_NUMBER_PAID
                                NULL,              --TBRAPPL_SURROGATE_ID
                                NULL,              --TBRAPPL_VERSION
                                USER,              --TBRAPPL_USER_ID
                                'AJ',              --TBRAPPL_DATA_ORIGIN
                                NULL);              --TBRAPPL_VPDI_CODE
                     EXCEPTION
                     WHEN OTHERS THEN
                       VL_TRANSACCION :=' Errror al Insertar aplicacion de pagos 1  ' || SQLERRM ;
                     END;

                     BEGIN
                       UPDATE TBRACCD
                          SET TBRACCD_BALANCE = 0
                        WHERE     TBRACCD_PIDM = CARGO.PIDM
                              AND TBRACCD_TRAN_NUMBER = VL_TRANSACCION;
                     END;

                     BEGIN
                       UPDATE TBRACCD
                          SET TBRACCD_BALANCE = 0
                        WHERE     TBRACCD_PIDM = CARGO.PIDM
                              AND TBRACCD_TRAN_NUMBER = CARGO.SECUENCIA;
                     END;

                   END IF;
                 END IF;
               END;
             END LOOP CARGO;
           END LOOP DESCU;
         END IF;

         DBMS_OUTPUT.PUT_LINE('pn_estatus  INICIO---'||PN_ESTATUS );

         IF PN_ESTATUS IN ('CC','CF') THEN

           BEGIN
             SELECT COUNT (*)
               INTO VL_ENTRA
               FROM TBRACCD A
              WHERE     A.TBRACCD_PIDM = PN_PIDM
                    AND SUBSTR (A.TBRACCD_DETAIL_CODE ,3,4 ) IN (SELECT(ZSTPARA_PARAM_ID)
                                                                    FROM ZSTPARA
                                                                   WHERE ZSTPARA_MAPA_ID = 'CANC_CAMCFV')
                     AND A.TBRACCD_DOCUMENT_NUMBER IS NULL;
           EXCEPTION
           WHEN OTHERS THEN
           VL_ENTRA:=0;
           END;

           IF VL_ENTRA > 0 THEN

             FOR ALUMNO IN (

                           SELECT  A.TBRACCD_TRAN_NUMBER TRANS,
                                   B.SPRIDEN_ID,
                                   A.TBRACCD_PIDM,
                                   A.TBRACCD_TRAN_NUMBER_PAID PAGA,
                                   A.TBRACCD_TERM_CODE,
                                   A.TBRACCD_DETAIL_CODE CODIGO_DETALLE,
                                   A.TBRACCD_DESC,
                                   A.TBRACCD_AMOUNT,
                                   A.TBRACCD_BALANCE,
                                   C.TBBDETC_TYPE_IND TIPO,
                                   A.TBRACCD_DOCUMENT_NUMBER,
                                   TBRACCD_RECEIPT_NUMBER
                             FROM TBRACCD A,SPRIDEN B,TBBDETC C
                            WHERE     A.TBRACCD_PIDM = B.SPRIDEN_PIDM
                                  AND B.SPRIDEN_CHANGE_IND IS NULL
                                  AND TBRACCD_DOCUMENT_NUMBER IS NULL
                                  AND C.TBBDETC_DETAIL_CODE = A.TBRACCD_DETAIL_CODE
                                  AND SUBSTR (A.TBRACCD_DETAIL_CODE ,3,4 ) IN (SELECT(ZSTPARA_PARAM_ID)
                                                                                 FROM ZSTPARA
                                                                                WHERE ZSTPARA_MAPA_ID = 'CANC_CAMCFV')
                                  AND A.TBRACCD_PIDM = PN_PIDM
                                  AND TRUNC(TBRACCD_EFFECTIVE_DATE) >= PN_FECHA_INICIO
                            ORDER BY 1

             )LOOP

               BEGIN
                 SELECT ZSTPARA_PARAM_VALOR
                   INTO VL_EXIS_CONTRA
                   FROM ZSTPARA
                  WHERE     ZSTPARA_PARAM_ID = SUBSTR (ALUMNO.CODIGO_DETALLE,3,4 )
                        AND ZSTPARA_MAPA_ID = 'CANC_CAMCFV';
               EXCEPTION
               WHEN OTHERS THEN
               VL_EXIS_CONTRA := 0;
               END;

               IF ALUMNO.TIPO = 'C' THEN
                 BEGIN
                   SELECT A1.TBRAPPL_PAY_TRAN_NUMBER
                     INTO VL_NUMPAG
                     FROM TBRAPPL A1
                    WHERE     A1.TBRAPPL_PIDM = PN_PIDM
                          AND A1.TBRAPPL_CHG_TRAN_NUMBER =  ALUMNO.TRANS
                          AND A1.TBRAPPL_ACTIVITY_DATE = (SELECT MAX (A.TBRAPPL_ACTIVITY_DATE)
                                                            FROM TBRAPPL A
                                                           WHERE     A.TBRAPPL_PIDM = A1.TBRAPPL_PIDM
                                                                 AND A.TBRAPPL_CHG_TRAN_NUMBER =  A1.TBRAPPL_CHG_TRAN_NUMBER);
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_NUMPAG:=0;
                 END;
               ELSIF ALUMNO.TIPO = 'P' THEN
                 BEGIN
                   SELECT A1.TBRAPPL_CHG_TRAN_NUMBER
                     INTO VL_NUMPAG
                     FROM TBRAPPL A1
                    WHERE     A1.TBRAPPL_PIDM = PN_PIDM
                          AND A1.TBRAPPL_PAY_TRAN_NUMBER =  ALUMNO.TRANS
                          AND A1.TBRAPPL_ACTIVITY_DATE = (SELECT MAX (A.TBRAPPL_ACTIVITY_DATE)
                                                            FROM TBRAPPL A
                                                           WHERE     A.TBRAPPL_PIDM = A1.TBRAPPL_PIDM
                                                                 AND A.TBRAPPL_PAY_TRAN_NUMBER =  A1.TBRAPPL_PAY_TRAN_NUMBER);
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_NUMPAG:=0;
                 END;
               END IF;

               BEGIN
                 SELECT TBRACCD_AMOUNT,TBRACCD_DETAIL_CODE
                   INTO VL_MONTO_PAGADO,VL_CODIGO_AJ
                   FROM TBRACCD
                  WHERE     TBRACCD_PIDM = PN_PIDM
                        AND TBRACCD_TRAN_NUMBER = VL_NUMPAG;
               EXCEPTION
                WHEN OTHERS THEN
                VL_MONTO_PAGADO :=0;
                VL_CODIGO_AJ := '0000';
               END;

               IF SUBSTR(VL_CODIGO_AJ,3,2) <> VL_EXIS_CONTRA THEN

                 BEGIN
                   SELECT COUNT (ZSTPARA_PARAM_VALOR)
                     INTO VL_EXIS_CONTRA_2
                     FROM ZSTPARA
                    WHERE     ZSTPARA_MAPA_ID = 'DET_CODE_CART'
                          AND ZSTPARA_PARAM_ID = 'PARC_ANTERIOR'
                          AND ZSTPARA_PARAM_VALOR = SUBSTR(VL_EXISTE_DETAIL,3,2);
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_EXIS_CONTRA_2:=0;
                 END;

                 IF VL_EXIS_CONTRA_2 = 0 THEN

                   PKG_FINANZAS.P_DESAPLICA_PAGOS (ALUMNO.TBRACCD_PIDM, ALUMNO.TRANS);

                   DBMS_OUTPUT.PUT_LINE('INSERTA CONTRA PARTE'||'/'||VL_EXIS_CONTRA||'/'||VL_MONTO_PAGADO);

                   BEGIN
                     SELECT NVL (MAX(TBRACCD_TRAN_NUMBER) , 0)+1
                       INTO VL_TRANSACCION
                       FROM TBRACCD
                      WHERE TBRACCD_PIDM =  ALUMNO.TBRACCD_PIDM;
                   EXCEPTION
                   WHEN OTHERS THEN
                   VL_TRANSACCION := 1;
                   END;

                   DBMS_OUTPUT.PUT_LINE('Secuencia '||VL_TRANSACCION);

                   BEGIN
                     SELECT TBBDETC_DETAIL_CODE, TBBDETC_DESC
                       INTO VL_COD_CONTRA, VL_DESC_CONTRA
                       FROM TBBDETC
                      WHERE SUBSTR(TBBDETC_DETAIL_CODE,1,2) = SUBSTR(ALUMNO.SPRIDEN_ID,1,2)
                           AND SUBSTR (TBBDETC_DETAIL_CODE,3,4) = VL_EXIS_CONTRA;
                   EXCEPTION
                   WHEN OTHERS THEN
                       VL_COD_CONTRA:= NULL;
                       VL_DESC_CONTRA := NULL;
                   END;

                   DBMS_OUTPUT.PUT_LINE(VL_COD_CONTRA||'/'||VL_DESC_CONTRA||'/'||VL_EXIS_CONTRA);

                   IF ALUMNO.TIPO = 'C' THEN

                     INSERT
                       INTO TBRACCD
                     VALUES (
                              ALUMNO.TBRACCD_PIDM,   -- TBRACCD_PIDM
                              VL_TRANSACCION,     --TBRACCD_TRAN_NUMBER
                              ALUMNO.TBRACCD_TERM_CODE,    -- TBRACCD_TERM_CODE
                              VL_COD_CONTRA,     ---TBRACCD_DETAIL_CODE
                              USER,     ---TBRACCD_USER
                              SYSDATE,     --TBRACCD_ENTRY_DATE
                              ALUMNO.TBRACCD_AMOUNT,
                              (ALUMNO.TBRACCD_AMOUNT)*-1,    ---TBRACCD_BALANCE
                              SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                              NULL,    --TBRACCD_BILL_DATE
                              NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                              VL_DESC_CONTRA,    -- TBRACCD_DESC
                              ALUMNO.TBRACCD_RECEIPT_NUMBER,     --TBRACCD_RECEIPT_NUMBER
                              ALUMNO.TRANS,     --TBRACCD_TRAN_NUMBER_PAID
                              NULL,     --TBRACCD_CROSSREF_PIDM
                              NULL,    --TBRACCD_CROSSREF_NUMBER
                              NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                              'T',    --TBRACCD_SRCE_CODE
                              'Y',    --TBRACCD_ACCT_FEED_IND
                              SYSDATE,  --TBRACCD_ACTIVITY_DATE
                              0,        --TBRACCD_SESSION_NUMBER
                              NULL,    -- TBRACCD_CSHR_END_DATE
                              NULL,     --TBRACCD_CRN
                              NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                              NULL,     -- TBRACCD_LOC_MDT
                              NULL,     --TBRACCD_LOC_MDT_SEQ
                              NULL,     -- TBRACCD_RATE
                              NULL,     --TBRACCD_UNITS
                              'SZFABCC',     -- TBRACCD_DOCUMENT_NUMBER
                              SYSDATE,  -- TBRACCD_TRANS_DATE
                              NULL,        -- TBRACCD_PAYMENT_ID
                              NULL,     -- TBRACCD_INVOICE_NUMBER
                              NULL,     -- TBRACCD_STATEMENT_DATE
                              NULL,     -- TBRACCD_INV_NUMBER_PAID
                              'MXN',     -- TBRACCD_CURR_CODE
                              NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                              NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                              NULL,     -- TBRACCD_LATE_DCAT_CODE
                              PN_FECHA_INICIO,     -- TBRACCD_FEED_DATE
                              NULL,     -- TBRACCD_FEED_DOC_CODE
                              NULL,     -- TBRACCD_ATYP_CODE
                              NULL,     -- TBRACCD_ATYP_SEQNO
                              NULL,     -- TBRACCD_CARD_TYPE_VR
                              NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                              NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                              NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                              NULL,     -- TBRACCD_ORIG_CHG_IND
                              NULL,     -- TBRACCD_CCRD_CODE
                              NULL,     -- TBRACCD_MERCHANT_ID
                              NULL,     -- TBRACCD_TAX_REPT_YEAR
                              NULL,     -- TBRACCD_TAX_REPT_BOX
                              NULL,     -- TBRACCD_TAX_AMOUNT
                              NULL,     -- TBRACCD_TAX_FUTURE_IND
                              'Banner',     -- TBRACCD_DATA_ORIGIN
                              'AUTOM',   -- TBRACCD_CREATE_SOURCE
                              NULL,     -- TBRACCD_CPDT_IND
                              NULL,     --TBRACCD_AIDY_CODE
                              PN_KEYSEQNO,     --TBRACCD_STSP_KEY_SEQUENCE
                              VL_PARTE,     --TBRACCD_PERIOD
                              NULL,    --TBRACCD_SURROGATE_ID
                              NULL,     -- TBRACCD_VERSION
                              USER,     --TBRACCD_USER_ID
                              NULL );     --TBRACCD_VPDI_CODE

                     DBMS_OUTPUT.PUT_LINE('1'||'/'||VL_ERROR);

                   ELSIF ALUMNO.TIPO = 'P' THEN

                     INSERT
                       INTO TBRACCD
                     VALUES (
                              ALUMNO.TBRACCD_PIDM,   -- TBRACCD_PIDM
                              VL_TRANSACCION,     --TBRACCD_TRAN_NUMBER
                              ALUMNO.TBRACCD_TERM_CODE,    -- TBRACCD_TERM_CODE
                              VL_COD_CONTRA,     ---TBRACCD_DETAIL_CODE
                              USER,     ---TBRACCD_USER
                              SYSDATE,     --TBRACCD_ENTRY_DATE
                              ALUMNO.TBRACCD_AMOUNT,
                              ALUMNO.TBRACCD_AMOUNT,    ---TBRACCD_BALANCE
                              SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                              NULL,    --TBRACCD_BILL_DATE
                              NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                              VL_DESC_CONTRA,    -- TBRACCD_DESC
                              ALUMNO.TBRACCD_RECEIPT_NUMBER,     --TBRACCD_RECEIPT_NUMBER
                              NULL,     --TBRACCD_TRAN_NUMBER_PAID
                              NULL,     --TBRACCD_CROSSREF_PIDM
                              NULL,    --TBRACCD_CROSSREF_NUMBER
                              NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                              'T',    --TBRACCD_SRCE_CODE
                              'Y',    --TBRACCD_ACCT_FEED_IND
                              SYSDATE,  --TBRACCD_ACTIVITY_DATE
                              0,        --TBRACCD_SESSION_NUMBER
                              NULL,    -- TBRACCD_CSHR_END_DATE
                              NULL,     --TBRACCD_CRN
                              NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                              NULL,     -- TBRACCD_LOC_MDT
                              NULL,     --TBRACCD_LOC_MDT_SEQ
                              NULL,     -- TBRACCD_RATE
                              NULL,     --TBRACCD_UNITS
                              'SZFABCC',     -- TBRACCD_DOCUMENT_NUMBER
                              SYSDATE,  -- TBRACCD_TRANS_DATE
                              NULL,        -- TBRACCD_PAYMENT_ID
                              NULL,     -- TBRACCD_INVOICE_NUMBER
                              NULL,     -- TBRACCD_STATEMENT_DATE
                              NULL,     -- TBRACCD_INV_NUMBER_PAID
                              'MXN',     -- TBRACCD_CURR_CODE
                              NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                              NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                              NULL,     -- TBRACCD_LATE_DCAT_CODE
                              PN_FECHA_INICIO,     -- TBRACCD_FEED_DATE
                              NULL,     -- TBRACCD_FEED_DOC_CODE
                              NULL,     -- TBRACCD_ATYP_CODE
                              NULL,     -- TBRACCD_ATYP_SEQNO
                              NULL,     -- TBRACCD_CARD_TYPE_VR
                              NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                              NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                              NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                              NULL,     -- TBRACCD_ORIG_CHG_IND
                              NULL,     -- TBRACCD_CCRD_CODE
                              NULL,     -- TBRACCD_MERCHANT_ID
                              NULL,     -- TBRACCD_TAX_REPT_YEAR
                              NULL,     -- TBRACCD_TAX_REPT_BOX
                              NULL,     -- TBRACCD_TAX_AMOUNT
                              NULL,     -- TBRACCD_TAX_FUTURE_IND
                              'Banner',     -- TBRACCD_DATA_ORIGIN
                              'AUTOM',   -- TBRACCD_CREATE_SOURCE
                              NULL,     -- TBRACCD_CPDT_IND
                              NULL,     --TBRACCD_AIDY_CODE
                              PN_KEYSEQNO,     --TBRACCD_STSP_KEY_SEQUENCE
                              VL_PARTE,     --TBRACCD_PERIOD
                              NULL,    --TBRACCD_SURROGATE_ID
                              NULL,     -- TBRACCD_VERSION
                              USER,     --TBRACCD_USER_ID
                              NULL );     --TBRACCD_VPDI_CODE

                   END IF;

                   BEGIN
                     UPDATE TBRACCD
                        SET TBRACCD_DOCUMENT_NUMBER = 'SZFABCC',
                            TBRACCD_TRAN_NUMBER_PAID = NULL
                      WHERE     TBRACCD_PIDM = PN_PIDM
                            AND TBRACCD_TRAN_NUMBER IN (ALUMNO.TRANS,VL_TRANSACCION);
                   EXCEPTION
                   WHEN OTHERS THEN
                   VL_ERROR :=' Errror al actualizar saldo Pago>>  ' || SQLERRM ;
                   END;

                   IF ALUMNO.TIPO = 'P' THEN

                        UPDATE TBRACCD
                           SET TBRACCD_TRAN_NUMBER_PAID =  VL_TRANSACCION
                         WHERE     TBRACCD_PIDM = ALUMNO.TBRACCD_PIDM
                               AND TBRACCD_TRAN_NUMBER =  ALUMNO.TRANS;
                   ELSE

                        UPDATE TBRACCD
                           SET TBRACCD_TRAN_NUMBER_PAID = ALUMNO.TRANS
                         WHERE     TBRACCD_PIDM = ALUMNO.TBRACCD_PIDM
                               AND TBRACCD_TRAN_NUMBER = VL_TRANSACCION;

                   END IF;

                   DBMS_OUTPUT.PUT_LINE('Termina AJUSTES CAMBIO CICLO Y CAMBIO FECHA');

                 END IF;
               END IF;
             END LOOP;
           END IF;
            DBMS_OUTPUT.PUT_LINE('pn_estatus  1---'||PN_ESTATUS );
        ELSIF PN_ESTATUS = 'CV' THEN

           DBMS_OUTPUT.PUT_LINE('pn_estatus  2---'||PN_ESTATUS );
           DBMS_OUTPUT.PUT_LINE('llega al bloque 7 '||PN_ESTATUS );

           BEGIN
             SELECT COUNT(*)
               INTO VL_ENTRA
               FROM TBRACCD A,SPRIDEN B,TBBDETC C
              WHERE A.TBRACCD_PIDM = B.SPRIDEN_PIDM
                    AND B.SPRIDEN_CHANGE_IND IS NULL
                    AND C.TBBDETC_DETAIL_CODE = A.TBRACCD_DETAIL_CODE
                    AND SUBSTR (A.TBRACCD_DETAIL_CODE ,3,4 ) IN (SELECT(ZSTPARA_PARAM_ID)
                                                                   FROM ZSTPARA
                                                                  WHERE ZSTPARA_MAPA_ID = 'CANC_DEC40')
                    AND C.TBBDETC_DCAT_CODE NOT IN ('TUI','DSP','LPC')
                    AND A.TBRACCD_DESC NOT LIKE ('DSI COLE%')
                    AND A.TBRACCD_PIDM = PN_PIDM;
           EXCEPTION
           WHEN OTHERS THEN
           VL_ENTRA:=0;
           END;

--------------------------------------- Apago este codigo para la cancelacion de Ajustes Victor --------------------------------- inicio 
/*
           IF VL_ENTRA > 0 THEN

             FOR ALUMNO IN (

                           SELECT A.TBRACCD_TRAN_NUMBER TRANS,
                                  B.SPRIDEN_ID,
                                  A.TBRACCD_PIDM,
                                  A.TBRACCD_TRAN_NUMBER_PAID PAGA,
                                  A.TBRACCD_TERM_CODE,
                                  A.TBRACCD_DETAIL_CODE CODIGO_DETALLE,
                                  A.TBRACCD_DESC,
                                  A.TBRACCD_AMOUNT,
                                  A.TBRACCD_BALANCE,
                                  C.TBBDETC_TYPE_IND TIPO,
                                  A.TBRACCD_DOCUMENT_NUMBER,
                                  TBRACCD_RECEIPT_NUMBER
                             FROM TBRACCD A,SPRIDEN B,TBBDETC C
                            WHERE     A.TBRACCD_PIDM = B.SPRIDEN_PIDM
                                  AND B.SPRIDEN_CHANGE_IND IS NULL
                                  AND C.TBBDETC_DETAIL_CODE = A.TBRACCD_DETAIL_CODE
                                  AND SUBSTR (A.TBRACCD_DETAIL_CODE ,3,4 ) IN (SELECT ZSTPARA_PARAM_ID
                                                                                 FROM ZSTPARA
                                                                                WHERE ZSTPARA_MAPA_ID = 'CANC_DEC40')
                                  AND C.TBBDETC_DCAT_CODE NOT IN ('TUI','DSP','LPC')
                                  AND A.TBRACCD_DESC NOT LIKE ('DSI COLE%')
                                  AND A.TBRACCD_PIDM = PN_PIDM
                                  AND a.TBRACCD_DOCUMENT_NUMBER IS NULL
                            ORDER BY 1


             ) LOOP

               BEGIN
                 SELECT ZSTPARA_PARAM_VALOR
                   INTO VL_EXIS_CONTRA
                   FROM ZSTPARA
                  WHERE     ZSTPARA_PARAM_ID = SUBSTR (ALUMNO.CODIGO_DETALLE,3,4 )
                        AND ZSTPARA_MAPA_ID = 'CANC_DEC40';
               EXCEPTION
               WHEN OTHERS THEN
               VL_EXIS_CONTRA := 0;
               END;

               DBMS_OUTPUT.PUT_LINE('vl_exis_contra'||'/'||VL_EXIS_CONTRA||'/'||ALUMNO.TRANS);

               IF ALUMNO.TIPO = 'C' THEN
                 BEGIN
                   SELECT A1.TBRAPPL_PAY_TRAN_NUMBER
                     INTO VL_NUMPAG
                     FROM TBRAPPL A1
                    WHERE     A1.TBRAPPL_PIDM = ALUMNO.TBRACCD_PIDM
                          AND A1.TBRAPPL_CHG_TRAN_NUMBER =  ALUMNO.TRANS
                          AND A1.TBRAPPL_ACTIVITY_DATE = (SELECT MAX (A.TBRAPPL_ACTIVITY_DATE)
                                                            FROM TBRAPPL A
                                                           WHERE     A.TBRAPPL_PIDM = A1.TBRAPPL_PIDM
                                                                 AND A.TBRAPPL_CHG_TRAN_NUMBER =  A1.TBRAPPL_CHG_TRAN_NUMBER);
                 END;
               ELSIF ALUMNO.TIPO = 'P' THEN
                 BEGIN
                   SELECT A1.TBRAPPL_CHG_TRAN_NUMBER
                     INTO VL_NUMPAG
                     FROM TBRAPPL A1
                    WHERE     A1.TBRAPPL_PIDM = ALUMNO.TBRACCD_PIDM
                          AND A1.TBRAPPL_PAY_TRAN_NUMBER =  ALUMNO.TRANS
                          AND A1.TBRAPPL_ACTIVITY_DATE = (SELECT MAX (A.TBRAPPL_ACTIVITY_DATE)
                                                            FROM TBRAPPL A
                                                           WHERE     A.TBRAPPL_PIDM = A1.TBRAPPL_PIDM
                                                                 AND A.TBRAPPL_PAY_TRAN_NUMBER =  A1.TBRAPPL_PAY_TRAN_NUMBER);
                 END;
               END IF;

               DBMS_OUTPUT.PUT_LINE('vl_numpag'||'/'||VL_NUMPAG||'/'||VL_EXIS_CONTRA);

               BEGIN
                 SELECT TBRACCD_AMOUNT,TBRACCD_DETAIL_CODE
                   INTO VL_MONTO_PAGADO,VL_CODIGO_AJ
                   FROM TBRACCD
                  WHERE     TBRACCD_PIDM = ALUMNO.TBRACCD_PIDM
                        AND TBRACCD_TRAN_NUMBER = VL_NUMPAG;
               EXCEPTION
                WHEN OTHERS THEN
                VL_MONTO_PAGADO :=0;
                VL_CODIGO_AJ := '0000';
               END;

               DBMS_OUTPUT.PUT_LINE('INCERTA CONTRA PARTE'||'/'||VL_EXIS_CONTRA||'+++'||VL_CODIGO_AJ);

               IF VL_EXIS_CONTRA <> SUBSTR (VL_CODIGO_AJ,3,4 ) THEN

                 BEGIN
                   SELECT COUNT (ZSTPARA_PARAM_VALOR)
                     INTO VL_EXIS_CONTRA_2
                     FROM ZSTPARA
                    WHERE     ZSTPARA_MAPA_ID = 'DET_CODE_CART'
                          AND ZSTPARA_PARAM_ID = 'PARC_ANTERIOR'
                          AND ZSTPARA_PARAM_VALOR = SUBSTR(VL_EXISTE_DETAIL,3,2);
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_EXIS_CONTRA_2:=0;
                 END;

                 IF VL_EXIS_CONTRA_2 = 0 THEN

                   PKG_FINANZAS.P_DESAPLICA_PAGOS (ALUMNO.TBRACCD_PIDM, ALUMNO.TRANS);

                   DBMS_OUTPUT.PUT_LINE('INSERTA CONTRA PARTE'||'/'||VL_EXIS_CONTRA||'/'||VL_MONTO_PAGADO);

                   BEGIN
                     SELECT NVL (MAX(TBRACCD_TRAN_NUMBER) , 0)+1
                       INTO VL_TRANSACCION
                       FROM TBRACCD
                      WHERE TBRACCD_PIDM =  ALUMNO.TBRACCD_PIDM;
                   EXCEPTION
                   WHEN OTHERS THEN
                   VL_TRANSACCION := 1;
                   END;

                   DBMS_OUTPUT.PUT_LINE('Secuencia '||VL_TRANSACCION||'----'|| ALUMNO.SPRIDEN_ID||'----'|| VL_EXIS_CONTRA);

                   VL_EXIS_CONTRA := (SUBSTR(ALUMNO.SPRIDEN_ID,1,2)||VL_EXIS_CONTRA);

                   DBMS_OUTPUT.PUT_LINE(VL_EXIS_CONTRA);

                   BEGIN
                     SELECT TBBDETC_DETAIL_CODE,TBBDETC_DESC
                       INTO VL_COD_CONTRA, VL_DESC_CONTRA
                       FROM TBBDETC
                      WHERE TBBDETC_DETAIL_CODE = VL_EXIS_CONTRA;
                   EXCEPTION
                   WHEN OTHERS THEN
                   RAISE_APPLICATION_ERROR (-20002,'Contando ><'||VL_EXIS_CONTRA||'ZZZZZZZZZ'||SQLERRM);
                   END;

                   DBMS_OUTPUT.PUT_LINE(VL_COD_CONTRA||'/'||VL_DESC_CONTRA||'/'||VL_EXIS_CONTRA);

                   IF ALUMNO.TIPO = 'C' THEN
                     BEGIN
                         INSERT
                           INTO TBRACCD
                         VALUES (
                                  ALUMNO.TBRACCD_PIDM,   -- TBRACCD_PIDM
                                  VL_TRANSACCION,     --TBRACCD_TRAN_NUMBER
                                  ALUMNO.TBRACCD_TERM_CODE,    -- TBRACCD_TERM_CODE
                                  VL_COD_CONTRA,     ---TBRACCD_DETAIL_CODE
                                  USER,     ---TBRACCD_USER
                                  SYSDATE,     --TBRACCD_ENTRY_DATE
                                  ALUMNO.TBRACCD_AMOUNT,
                                  (ALUMNO.TBRACCD_AMOUNT)*-1,    ---TBRACCD_BALANCE
                                  SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                                  NULL,    --TBRACCD_BILL_DATE
                                  NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                                  VL_DESC_CONTRA,    -- TBRACCD_DESC
                                  ALUMNO.TBRACCD_RECEIPT_NUMBER,     --TBRACCD_RECEIPT_NUMBER
                                  ALUMNO.TRANS,     --TBRACCD_TRAN_NUMBER_PAID
                                  NULL,     --TBRACCD_CROSSREF_PIDM
                                  NULL,    --TBRACCD_CROSSREF_NUMBER
                                  NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                                  'T',    --TBRACCD_SRCE_CODE
                                  'Y',    --TBRACCD_ACCT_FEED_IND
                                  SYSDATE,  --TBRACCD_ACTIVITY_DATE
                                  0,        --TBRACCD_SESSION_NUMBER
                                  NULL,    -- TBRACCD_CSHR_END_DATE
                                  NULL,     --TBRACCD_CRN
                                  NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                                  NULL,     -- TBRACCD_LOC_MDT
                                  NULL,     --TBRACCD_LOC_MDT_SEQ
                                  NULL,     -- TBRACCD_RATE
                                  NULL,     --TBRACCD_UNITS
                                  NULL,     -- TBRACCD_DOCUMENT_NUMBER
                                  SYSDATE,  -- TBRACCD_TRANS_DATE
                                  NULL,        -- TBRACCD_PAYMENT_ID
                                  NULL,     -- TBRACCD_INVOICE_NUMBER
                                  NULL,     -- TBRACCD_STATEMENT_DATE
                                  NULL,     -- TBRACCD_INV_NUMBER_PAID
                                  'MXN',     -- TBRACCD_CURR_CODE
                                  NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                                  NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                                  NULL,     -- TBRACCD_LATE_DCAT_CODE
                                  PN_FECHA_INICIO,     -- TBRACCD_FEED_DATE
                                  NULL,     -- TBRACCD_FEED_DOC_CODE
                                  NULL,     -- TBRACCD_ATYP_CODE
                                  NULL,     -- TBRACCD_ATYP_SEQNO
                                  NULL,     -- TBRACCD_CARD_TYPE_VR
                                  NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                                  NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                                  NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                                  NULL,     -- TBRACCD_ORIG_CHG_IND
                                  NULL,     -- TBRACCD_CCRD_CODE
                                  NULL,     -- TBRACCD_MERCHANT_ID
                                  NULL,     -- TBRACCD_TAX_REPT_YEAR
                                  NULL,     -- TBRACCD_TAX_REPT_BOX
                                  NULL,     -- TBRACCD_TAX_AMOUNT
                                  NULL,     -- TBRACCD_TAX_FUTURE_IND
                                  'Banner',     -- TBRACCD_DATA_ORIGIN
                                  'AUTOM',   -- TBRACCD_CREATE_SOURCE
                                  NULL,     -- TBRACCD_CPDT_IND
                                  NULL,     --TBRACCD_AIDY_CODE
                                  PN_KEYSEQNO,     --TBRACCD_STSP_KEY_SEQUENCE
                                  VL_PARTE,     --TBRACCD_PERIOD
                                  NULL,    --TBRACCD_SURROGATE_ID
                                  NULL,     -- TBRACCD_VERSION
                                  USER,     --TBRACCD_USER_ID
                                  NULL );     --TBRACCD_VPDI_CODE
                     END;

                     BEGIN
                       INSERT
                         INTO TBRAPPL
                       VALUES (
                                 ALUMNO.TBRACCD_PIDM,               --TBRAPPL_PIDM
                                 VL_TRANSACCION,               --TBRAPPL_PAY_TRAN_NUMBER
                                 ALUMNO.TRANS,               --TBRAPPL_CHG_TRAN_NUMBER
                                 ALUMNO.TBRACCD_AMOUNT ,              --TBRAPPL_AMOUNT
                                 NULL,             --TBRAPPL_DIRECT_PAY_IND
                                 NULL,              --TBRAPPL_REAPPL_IND
                                 USER,              --TBRAPPL_USER
                                 'Y',              --TBRAPPL_ACCT_FEED_IND
                                 SYSDATE,              --TBRAPPL_ACTIVITY_DATE
                                 NULL,              --TBRAPPL_FEED_DATE
                                 'Y',              --TBRAPPL_FEED_DOC_CODE
                                 NULL,              --TBRAPPL_CPDT_TRAN_NUMBER
                                 NULL,              --TBRAPPL_DIRECT_PAY_TYPE
                                 NULL,              --TBRAPPL_INV_NUMBER_PAID
                                 NULL,              --TBRAPPL_SURROGATE_ID
                                 NULL,              --TBRAPPL_VERSION
                                 USER,              --TBRAPPL_USER_ID
                                 'AJ',              --TBRAPPL_DATA_ORIGIN
                                 NULL);              --TBRAPPL_VPDI_CODE
                     EXCEPTION
                     WHEN OTHERS THEN
                     VL_TRANSACCION :=' Errror al Insertar aplicacion de pagos 1  ' || SQLERRM ;
                     END;

                   ELSIF ALUMNO.TIPO = 'P' THEN

                     BEGIN
                       INSERT
                         INTO TBRACCD
                       VALUES (
                                ALUMNO.TBRACCD_PIDM,   -- TBRACCD_PIDM
                                VL_TRANSACCION,     --TBRACCD_TRAN_NUMBER
                                ALUMNO.TBRACCD_TERM_CODE,    -- TBRACCD_TERM_CODE
                                VL_COD_CONTRA,     ---TBRACCD_DETAIL_CODE
                                USER,     ---TBRACCD_USER
                                SYSDATE,     --TBRACCD_ENTRY_DATE
                                ALUMNO.TBRACCD_AMOUNT,
                                ALUMNO.TBRACCD_AMOUNT,    ---TBRACCD_BALANCE
                                SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                                NULL,    --TBRACCD_BILL_DATE
                                NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                                VL_DESC_CONTRA,    -- TBRACCD_DESC
                                ALUMNO.TBRACCD_RECEIPT_NUMBER,     --TBRACCD_RECEIPT_NUMBER
                                NULL,     --TBRACCD_TRAN_NUMBER_PAID
                                NULL,     --TBRACCD_CROSSREF_PIDM
                                NULL,    --TBRACCD_CROSSREF_NUMBER
                                NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                                'T',    --TBRACCD_SRCE_CODE
                                'Y',    --TBRACCD_ACCT_FEED_IND
                                SYSDATE,  --TBRACCD_ACTIVITY_DATE
                                0,        --TBRACCD_SESSION_NUMBER
                                NULL,    -- TBRACCD_CSHR_END_DATE
                                NULL,     --TBRACCD_CRN
                                NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                                NULL,     -- TBRACCD_LOC_MDT
                                NULL,     --TBRACCD_LOC_MDT_SEQ
                                NULL,     -- TBRACCD_RATE
                                NULL,     --TBRACCD_UNITS
                                NULL,     -- TBRACCD_DOCUMENT_NUMBER
                                SYSDATE,  -- TBRACCD_TRANS_DATE
                                NULL,        -- TBRACCD_PAYMENT_ID
                                NULL,     -- TBRACCD_INVOICE_NUMBER
                                NULL,     -- TBRACCD_STATEMENT_DATE
                                NULL,     -- TBRACCD_INV_NUMBER_PAID
                                'MXN',     -- TBRACCD_CURR_CODE
                                NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                                NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                                NULL,     -- TBRACCD_LATE_DCAT_CODE
                                PN_FECHA_INICIO,     -- TBRACCD_FEED_DATE
                                NULL,     -- TBRACCD_FEED_DOC_CODE
                                NULL,     -- TBRACCD_ATYP_CODE
                                NULL,     -- TBRACCD_ATYP_SEQNO
                                NULL,     -- TBRACCD_CARD_TYPE_VR
                                NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                                NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                                NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                                NULL,     -- TBRACCD_ORIG_CHG_IND
                                NULL,     -- TBRACCD_CCRD_CODE
                                NULL,     -- TBRACCD_MERCHANT_ID
                                NULL,     -- TBRACCD_TAX_REPT_YEAR
                                NULL,     -- TBRACCD_TAX_REPT_BOX
                                NULL,     -- TBRACCD_TAX_AMOUNT
                                NULL,     -- TBRACCD_TAX_FUTURE_IND
                                'Banner',     -- TBRACCD_DATA_ORIGIN
                                'AUTOM',   -- TBRACCD_CREATE_SOURCE
                                NULL,     -- TBRACCD_CPDT_IND
                                NULL,     --TBRACCD_AIDY_CODE
                                PN_KEYSEQNO,     --TBRACCD_STSP_KEY_SEQUENCE
                                VL_PARTE,     --TBRACCD_PERIOD
                                NULL,    --TBRACCD_SURROGATE_ID
                                NULL,     -- TBRACCD_VERSION
                                USER,     --TBRACCD_USER_ID
                                NULL );     --TBRACCD_VPDI_CODE
                     END;
                     DBMS_OUTPUT.PUT_LINE('Termina contra parte CARGO');

                     BEGIN
                       INSERT
                         INTO TBRAPPL
                       VALUES (
                                ALUMNO.TBRACCD_PIDM,               --TBRAPPL_PIDM
                                ALUMNO.TRANS,               --TBRAPPL_PAY_TRAN_NUMBER
                                VL_TRANSACCION,               --TBRAPPL_CHG_TRAN_NUMBER
                                ALUMNO.TBRACCD_AMOUNT ,              --TBRAPPL_AMOUNT
                                NULL,             --TBRAPPL_DIRECT_PAY_IND
                                NULL,              --TBRAPPL_REAPPL_IND
                                USER,              --TBRAPPL_USER
                                'Y',              --TBRAPPL_ACCT_FEED_IND
                                SYSDATE,              --TBRAPPL_ACTIVITY_DATE
                                NULL,              --TBRAPPL_FEED_DATE
                                'Y',              --TBRAPPL_FEED_DOC_CODE
                                NULL,              --TBRAPPL_CPDT_TRAN_NUMBER
                                NULL,              --TBRAPPL_DIRECT_PAY_TYPE
                                NULL,              --TBRAPPL_INV_NUMBER_PAID
                                NULL,              --TBRAPPL_SURROGATE_ID
                                NULL,              --TBRAPPL_VERSION
                                USER,              --TBRAPPL_USER_ID
                                'AJ',              --TBRAPPL_DATA_ORIGIN
                                NULL);              --TBRAPPL_VPDI_CODE
                     EXCEPTION
                     WHEN OTHERS THEN
                       VL_TRANSACCION :=' Errror al Insertar aplicacion de pagos>>  ' || SQLERRM ;
                     END;

                   END IF;

                   BEGIN
                     UPDATE TBRACCD
                        SET TBRACCD_BALANCE = 0
                      WHERE     TBRACCD_PIDM = PN_PIDM
                            AND TBRACCD_TRAN_NUMBER = ALUMNO.TRANS;
                   END;

                   BEGIN
                     UPDATE TBRACCD
                        SET TBRACCD_BALANCE = 0
                      WHERE     TBRACCD_PIDM = PN_PIDM
                            AND TBRACCD_TRAN_NUMBER = VL_TRANSACCION;
                   END;

                   IF ALUMNO.TIPO = 'P' THEN
                      UPDATE TBRACCD
                         SET TBRACCD_TRAN_NUMBER_PAID =  VL_TRANSACCION
                       WHERE     TBRACCD_PIDM = ALUMNO.TBRACCD_PIDM
                             AND TBRACCD_TRAN_NUMBER =  ALUMNO.TRANS;
                   END IF;
                   DBMS_OUTPUT.PUT_LINE('Termina AJUSTES');
                 END IF;
               END IF;
             END LOOP;
           END IF;

*/
--------------------------------------- Apago este codigo para la cancelacion de Ajustes Victor --------------------------------- FIn 


--------------------------------------- Apago este codigo para la cancelacion de Ajustes de los Pagos para CV  Victor --------------------------------- INICIO 

/*

           BEGIN
             SELECT COUNT (*)
               INTO VL_ENTRA
               FROM TBRACCD
              WHERE     TBRACCD_PIDM = PN_PIDM
                    AND TBRACCD_DETAIL_CODE IN (SELECT(TBBDETC_DETAIL_CODE)
                                                  FROM TBBDETC
                                                 WHERE TBBDETC_DCAT_CODE = 'CSH')
                    AND TBRACCD_DESC NOT LIKE ('%CTRACGO%');
           EXCEPTION
           WHEN OTHERS THEN
           VL_ENTRA:=0;
           END;

           DBMS_OUTPUT.PUT_LINE('VL_ENTRA 1<<<'||VL_ENTRA);

           IF VL_ENTRA > 0 THEN

             DBMS_OUTPUT.PUT_LINE('VL_ENTRA 2<<<'||VL_ENTRA);
             FOR CASH IN (
                          SELECT TBRACCD_DETAIL_CODE CODIGO,TBRACCD_AMOUNT MONTO, TBRACCD_TRAN_NUMBER TRANS,TBRACCD_TERM_CODE
                            FROM TBRACCD
                           WHERE     TBRACCD_PIDM = PN_PIDM
                                 AND TBRACCD_DETAIL_CODE IN (SELECT(TBBDETC_DETAIL_CODE)
                                                               FROM TBBDETC
                                                              WHERE TBBDETC_DCAT_CODE = 'CSH')
                                 AND TBRACCD_DESC NOT LIKE ('%CTRACGO%')

             )LOOP

               BEGIN
                 SELECT NVL(MAX(A.TBRAPPL_CHG_TRAN_NUMBER),0)
                   INTO VL_CSH_PAG
                   FROM TBRAPPL A
                  WHERE     A.TBRAPPL_PIDM = PN_PIDM
                        AND A.TBRAPPL_PAY_TRAN_NUMBER = CASH.TRANS
                        AND A.TBRAPPL_ACTIVITY_DATE = (SELECT MAX (B.TBRAPPL_ACTIVITY_DATE)
                                                         FROM TBRAPPL B
                                                        WHERE     B.TBRAPPL_PIDM = A.TBRAPPL_PIDM
                                                              AND B.TBRAPPL_PAY_TRAN_NUMBER = A.TBRAPPL_PAY_TRAN_NUMBER);
               EXCEPTION
               WHEN OTHERS THEN
               VL_ERROR :=' Errror CASH 1>>  ' || SQLERRM ;
               END;

               DBMS_OUTPUT.PUT_LINE('CASH 1---'||VL_CSH_PAG);

               BEGIN
                 SELECT TBRACCD_DETAIL_CODE
                   INTO VL_AJUSTA_CSH
                   FROM TBRACCD
                  WHERE TBRACCD_PIDM =  PN_PIDM
                        AND TBRACCD_TRAN_NUMBER = VL_CSH_PAG
                        AND TBRACCD_DETAIL_CODE IN (SELECT(TBBDETC_DETAIL_CODE)
                                                      FROM TBBDETC
                                                     WHERE TBBDETC_DCAT_CODE IN ('CSH','PYG'));
               EXCEPTION
               WHEN OTHERS THEN
               VL_AJUSTA_CSH := NULL;
               END;

               DBMS_OUTPUT.PUT_LINE('CASH 2---'||VL_AJUSTA_CSH);

               IF VL_AJUSTA_CSH IS  NULL THEN

                 PKG_FINANZAS.P_DESAPLICA_PAGOS (PN_PIDM, CASH.TRANS);

                 DBMS_OUTPUT.PUT_LINE('INSERTA CONTRA PARTE CASH'||'/'||VL_EXIS_CONTRA||'/'||VL_MONTO_PAGADO);

                 BEGIN

                       SELECT NVL (MAX(TBRACCD_TRAN_NUMBER) , 0)+1
                       INTO VL_TRANSACCION
                       FROM TBRACCD
                       WHERE TBRACCD_PIDM =  PN_PIDM;

                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_TRANSACCION := 1;
                 END;

                 BEGIN
                   INSERT
                     INTO TBRACCD
                   VALUES (
                            PN_PIDM,   -- TBRACCD_PIDM
                            VL_TRANSACCION,     --TBRACCD_TRAN_NUMBER
                            CASH.TBRACCD_TERM_CODE,    -- TBRACCD_TERM_CODE
                            SUBSTR(CASH.TBRACCD_TERM_CODE,1,2)||'1F',     ---TBRACCD_DETAIL_CODE
                            USER,     ---TBRACCD_USER
                            SYSDATE,     --TBRACCD_ENTRY_DATE
                            CASH.MONTO,
                            CASH.MONTO,    ---TBRACCD_BALANCE
                            SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                            NULL,    --TBRACCD_BILL_DATE
                            NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                            'OTROS INGRESOS A RESULTADOS',    -- TBRACCD_DESC
                            NULL,     --TBRACCD_RECEIPT_NUMBER
                            NULL,     --TBRACCD_TRAN_NUMBER_PAID
                            NULL,     --TBRACCD_CROSSREF_PIDM
                            NULL,    --TBRACCD_CROSSREF_NUMBER
                            NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                            'T',    --TBRACCD_SRCE_CODE
                            'Y',    --TBRACCD_ACCT_FEED_IND
                            SYSDATE,  --TBRACCD_ACTIVITY_DATE
                            0,        --TBRACCD_SESSION_NUMBER
                            NULL,    -- TBRACCD_CSHR_END_DATE
                            NULL,     --TBRACCD_CRN
                            NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                            NULL,     -- TBRACCD_LOC_MDT
                            NULL,     --TBRACCD_LOC_MDT_SEQ
                            NULL,     -- TBRACCD_RATE
                            NULL,     --TBRACCD_UNITS
                            NULL,     -- TBRACCD_DOCUMENT_NUMBER
                            SYSDATE,  -- TBRACCD_TRANS_DATE
                            NULL,        -- TBRACCD_PAYMENT_ID
                            NULL,     -- TBRACCD_INVOICE_NUMBER
                            NULL,     -- TBRACCD_STATEMENT_DATE
                            NULL,     -- TBRACCD_INV_NUMBER_PAID
                            'MXN',     -- TBRACCD_CURR_CODE
                            NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                            NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                            NULL,     -- TBRACCD_LATE_DCAT_CODE
                            PN_FECHA_INICIO,     -- TBRACCD_FEED_DATE
                            NULL,     -- TBRACCD_FEED_DOC_CODE
                            NULL,     -- TBRACCD_ATYP_CODE
                            NULL,     -- TBRACCD_ATYP_SEQNO
                            NULL,     -- TBRACCD_CARD_TYPE_VR
                            NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                            NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                            NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                            NULL,     -- TBRACCD_ORIG_CHG_IND
                            NULL,     -- TBRACCD_CCRD_CODE
                            NULL,     -- TBRACCD_MERCHANT_ID
                            NULL,     -- TBRACCD_TAX_REPT_YEAR
                            NULL,     -- TBRACCD_TAX_REPT_BOX
                            NULL,     -- TBRACCD_TAX_AMOUNT
                            NULL,     -- TBRACCD_TAX_FUTURE_IND
                            'Banner',     -- TBRACCD_DATA_ORIGIN
                            'AUTOM',   -- TBRACCD_CREATE_SOURCE
                            NULL,     -- TBRACCD_CPDT_IND
                            NULL,     --TBRACCD_AIDY_CODE
                            PN_KEYSEQNO,     --TBRACCD_STSP_KEY_SEQUENCE
                            VL_PARTE,     --TBRACCD_PERIOD
                            NULL,    --TBRACCD_SURROGATE_ID
                            NULL,     -- TBRACCD_VERSION
                            USER,     --TBRACCD_USER_ID
                            NULL );     --TBRACCD_VPDI_CODE
                 END;

                 BEGIN
                   INSERT
                     INTO TBRAPPL
                   VALUES (
                           PN_PIDM,               --TBRAPPL_PIDM
                           CASH.TRANS,               --TBRAPPL_PAY_TRAN_NUMBER
                           VL_TRANSACCION,               --TBRAPPL_CHG_TRAN_NUMBER
                           CASH.MONTO,              --TBRAPPL_AMOUNT
                           NULL,             --TBRAPPL_DIRECT_PAY_IND
                           NULL,              --TBRAPPL_REAPPL_IND
                           USER,              --TBRAPPL_USER
                           'Y',              --TBRAPPL_ACCT_FEED_IND
                           SYSDATE,              --TBRAPPL_ACTIVITY_DATE
                           NULL,              --TBRAPPL_FEED_DATE
                           'Y',              --TBRAPPL_FEED_DOC_CODE
                           NULL,              --TBRAPPL_CPDT_TRAN_NUMBER
                           NULL,              --TBRAPPL_DIRECT_PAY_TYPE
                           NULL,              --TBRAPPL_INV_NUMBER_PAID
                           NULL,              --TBRAPPL_SURROGATE_ID
                           NULL,              --TBRAPPL_VERSION
                           USER,              --TBRAPPL_USER_ID
                           'AJ',              --TBRAPPL_DATA_ORIGIN
                           NULL);              --TBRAPPL_VPDI_CODE
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_TRANSACCION :=' Errror al Insertar aplicacion de pagos>>  ' || SQLERRM ;
                 END;

                 BEGIN
                   UPDATE TBRACCD
                      SET TBRACCD_BALANCE = 0
                    WHERE     TBRACCD_PIDM = PN_PIDM
                          AND TBRACCD_TRAN_NUMBER = CASH.TRANS;
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_ERROR :=' Errror CASH 3 >>  ' || SQLERRM ;
                 END;

                 BEGIN
                   UPDATE TBRACCD
                      SET TBRACCD_BALANCE = 0
                    WHERE     TBRACCD_PIDM = PN_PIDM
                          AND TBRACCD_TRAN_NUMBER = VL_TRANSACCION;
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_ERROR :=' Errror CASH 4 >>  ' || SQLERRM ;
                 END;

                 BEGIN
                   UPDATE TBRACCD
                      SET TBRACCD_TRAN_NUMBER_PAID = VL_TRANSACCION
                    WHERE     TBRACCD_PIDM = PN_PIDM
                          AND TBRACCD_TRAN_NUMBER = CASH.TRANS;
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_ERROR :=' Errror al actualizar saldo Saldo>>  ' || SQLERRM ;
                 END;

               END IF;
             END LOOP;
           END IF;
           
           */
             DBMS_OUTPUT.PUT_LINE('VL_ENTRA 3<<<'||VL_ENTRA);
         END IF;




--------------------------------------- Apago este codigo para la cancelacion de Ajustes de los Pagos para CV  Victor --------------------------------- FIN


         ----------------- Se agrega la validacion para la decision 53 y no cobrar la baja ------------------
         vl_53 :=0;
         Begin
                    select distinct count(*)
                        into vl_53
                     from sarappd b 
                     join saradap c on c.saradap_pidm = b.sarappd_pidm and c.SARADAP_TERM_CODE_ENTRY = b.SARAPPD_TERM_CODE_ENTRY And c.SARADAP_APPL_NO = SARAPPD_APPL_NO
                    where 1=1 
                    And b.sarappd_pidm = PN_PIDM
                    And c.SARADAP_CAMP_CODE = pn_campus
                    And c.SARADAP_LEVL_CODE = pn_nivel
                    And c.SARADAP_PROGRAM_1 = nvl (pn_programa,c.SARADAP_PROGRAM_1)
                    And b.SARAPPD_APDC_CODE = '53'
                    And b.SARAPPD_SEQ_NO = (select max (b1.SARAPPD_SEQ_NO)
                                             from sarappd b1
                                            Where 1=1
                                            And b.sarappd_pidm = b1.sarappd_pidm
                                            );         
         Exception
            When Others then
            vl_53:=0;
         End;

          DBMS_OUTPUT.PUT_LINE('Muestra valor 53 <<<'||vl_53);

         -- SE INSERTA EL TRAMITE DE CAMBIO DE CICLO, CAMBIO FECHA INICIO, BAJA DEFINITIVA O BAJA TEMPORAL ---
         IF PN_ESTATUS = 'CC' THEN VL_CARGO_TRAM := (SUBSTR(PN_PERIODO,1,2)||'AM'); END IF;
         IF PN_ESTATUS = 'CF' THEN VL_CARGO_TRAM := (SUBSTR(PN_PERIODO,1,2)||'AO'); END IF;
         IF PN_ESTATUS = 'BD' THEN VL_CARGO_TRAM := (SUBSTR(PN_PERIODO,1,2)||'AH'); END IF;
         IF PN_ESTATUS = 'BT' AND vl_53 = 0 THEN VL_CARGO_TRAM := (SUBSTR(PN_PERIODO,1,2)||'AI'); END IF;  ---> Se valida que no sea Decision 53 
         IF PN_ESTATUS = 'BT' AND vl_53 >= 1 THEN VL_CARGO_TRAM := NULL; END IF;                            ---> Se valida que sea Decision 53 
         IF PN_ESTATUS = 'CV' THEN VL_CARGO_TRAM := (SUBSTR(PN_PERIODO,1,2)||'G7'); END IF;
         IF PN_ESTATUS = 'CP' THEN VL_CARGO_TRAM := (SUBSTR(PN_PERIODO,1,2)||'AR'); END IF;
         IF PN_ESTATUS = 'BI' THEN VL_CARGO_TRAM := (SUBSTR(PN_PERIODO,1,2)||'N7'); END IF;
--         IF PN_ESTATUS = 'BA' THEN VL_CARGO_TRAM := (SUBSTR(PN_PERIODO,1,2)||'AI'); END IF;-------SE DESCARTA CARGO DE BAJA TEMPORAL A PETICION DE FINANZAS

         DBMS_OUTPUT.PUT_LINE('VL_ENTRA 4<<<'||'TRAMITe BI '||PN_ESTATUS ||'*'||VL_CARGO_TRAM);

       IF PN_ESTATUS IN ('CC','CF','BD','BT','CV','CP', 'BI') THEN----------------------SE ELIMINA STATUS 'BA' PARA EVITAR CARGO DE LA BAJA

           BEGIN
             SELECT COUNT(ZSTPARA_PARAM_VALOR)
               INTO VL_ENTRA_COND_2
               FROM ZSTPARA
              WHERE     ZSTPARA_MAPA_ID = 'COND_TRAMI'
                    AND ZSTPARA_PARAM_ID = PN_CAMPUS
                    AND ZSTPARA_PARAM_VALOR = PN_NIVEL;
           EXCEPTION
           WHEN OTHERS THEN
           VL_ENTRA_COND:=0;
           END;
           --- VALIDA SI EL TRAMITE ES GRATIS PARA EL CAMPUS Y NIVEL ---------
           -------------------------------------------------------------------
           IF VL_ENTRA_COND_2 = 0 and vl_53 = 0 THEN  ---> Se valida que no sea 53 para cobrar el accesorio
             DBMS_OUTPUT.PUT_LINE('VL_ENTRA Valor 1 <<<'||VL_ENTRA_COND_2 ||'*'||vl_53);

             BEGIN
               SELECT TBBDETC_DESC,TBBDETC_AMOUNT
                 INTO VL_DESC_CONTRA,VL_MONTO_TRAM
                 FROM TBBDETC
                WHERE TBBDETC_DETAIL_CODE = VL_CARGO_TRAM;
             EXCEPTION
             WHEN OTHERS THEN
             NULL;
             END;

             DBMS_OUTPUT.PUT_LINE('vl_valida_tram 2<<<'||VL_DESC_CONTRA||'ZZZZZZZZZ'||VL_VALIDA_TRAM);

             BEGIN
               SELECT NVL (MAX(TBRACCD_TRAN_NUMBER) , 0)+1
                 INTO VL_TRANSACCION
                 FROM TBRACCD
                WHERE TBRACCD_PIDM =  PN_PIDM;
             EXCEPTION
             WHEN OTHERS THEN
             VL_TRANSACCION := 1;
             END;

             BEGIN
               SELECT COUNT (TBRACCD_DETAIL_CODE)
                 INTO VL_1SS
                 FROM TBRACCD
                WHERE     TBRACCD_PIDM = PN_PIDM
                      AND TBRACCD_DETAIL_CODE = VL_CARGO_TRAM
                      AND TBRACCD_USER =  'WWW_USER'
                      AND TBRACCD_TERM_CODE = PN_PERIODO;
             EXCEPTION
             WHEN OTHERS THEN
             VL_1SS:= 0;
             END;
             --- VALIDA SI YA EXISTE EL TRAMITE SOLICITADO POR EL AUTOSERVICIO ---
             ---------------------------------------------------------------------
             IF VL_1SS = 0 THEN

                DBMS_OUTPUT.PUT_LINE('LLEGA a INSERTAR TBRA1 <<<'||VL_ENTRA_COND_2 ||'*'||VL_1SS);

               BEGIN
                 INSERT
                   INTO TBRACCD
                 VALUES (
                         PN_PIDM,   -- TBRACCD_PIDM
                         VL_TRANSACCION,     --TBRACCD_TRAN_NUMBER
                         PN_PERIODO,    -- TBRACCD_TERM_CODE
                         VL_CARGO_TRAM,     ---TBRACCD_DETAIL_CODE
                         USER,     ---TBRACCD_USER
                         SYSDATE,     --TBRACCD_ENTRY_DATE
                         VL_MONTO_TRAM,
                         VL_MONTO_TRAM,    ---TBRACCD_BALANCE
                         SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                         NULL,    --TBRACCD_BILL_DATE
                         NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                         VL_DESC_CONTRA,    -- TBRACCD_DESC
                         NULL,     --TBRACCD_RECEIPT_NUMBER
                         NULL,     --TBRACCD_TRAN_NUMBER_PAID
                         NULL,     --TBRACCD_CROSSREF_PIDM
                         NULL,    --TBRACCD_CROSSREF_NUMBER
                         NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                         'T',    --TBRACCD_SRCE_CODE
                         'Y',    --TBRACCD_ACCT_FEED_IND
                         SYSDATE,  --TBRACCD_ACTIVITY_DATE
                         0,        --TBRACCD_SESSION_NUMBER
                         NULL,    -- TBRACCD_CSHR_END_DATE
                         NULL,     --TBRACCD_CRN
                         NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                         NULL,     -- TBRACCD_LOC_MDT
                         NULL,     --TBRACCD_LOC_MDT_SEQ
                         NULL,     -- TBRACCD_RATE
                         NULL,     --TBRACCD_UNITS
                         NULL,     -- TBRACCD_DOCUMENT_NUMBER
                         SYSDATE,  -- TBRACCD_TRANS_DATE
                         NULL,        -- TBRACCD_PAYMENT_ID
                         NULL,     -- TBRACCD_INVOICE_NUMBER
                         NULL,     -- TBRACCD_STATEMENT_DATE
                         NULL,     -- TBRACCD_INV_NUMBER_PAID
                         'MXN',     -- TBRACCD_CURR_CODE
                         NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                         NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                         NULL,     -- TBRACCD_LATE_DCAT_CODE
                         PN_FECHA_INICIO,     -- TBRACCD_FEED_DATE
                         NULL,     -- TBRACCD_FEED_DOC_CODE
                         NULL,     -- TBRACCD_ATYP_CODE
                         NULL,     -- TBRACCD_ATYP_SEQNO
                         NULL,     -- TBRACCD_CARD_TYPE_VR
                         NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                         NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                         NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                         NULL,     -- TBRACCD_ORIG_CHG_IND
                         NULL,     -- TBRACCD_CCRD_CODE
                         NULL,     -- TBRACCD_MERCHANT_ID
                         NULL,     -- TBRACCD_TAX_REPT_YEAR
                         NULL,     -- TBRACCD_TAX_REPT_BOX
                         NULL,     -- TBRACCD_TAX_AMOUNT
                         NULL,     -- TBRACCD_TAX_FUTURE_IND
                         'Banner',     -- TBRACCD_DATA_ORIGIN
                         'AUTOM',   -- TBRACCD_CREATE_SOURCE
                         NULL,     -- TBRACCD_CPDT_IND
                         NULL,     --TBRACCD_AIDY_CODE
                         PN_KEYSEQNO,     --TBRACCD_STSP_KEY_SEQUENCE
                         VL_PARTE,     --TBRACCD_PERIOD
                         NULL,    --TBRACCD_SURROGATE_ID
                         NULL,     -- TBRACCD_VERSION
                         USER,     --TBRACCD_USER_ID
                         NULL );     --TBRACCD_VPDI_CODE
               EXCEPTION
               WHEN OTHERS THEN
               RAISE_APPLICATION_ERROR (-20002,'Contando BB'||SQLERRM||'<>'|| PN_CAMPUS||'<>'||PN_NIVEL||'<>'||PN_ESTATUS||'<>'||PN_PERIODO||'<>'||PN_FECHA_BAJA||'<>'||PN_FECHA_INICIO||'<>'||PN_FECHA_FIN||'<>'||PN_KEYSEQNO);
               END;

             END IF;

           ELSIF VL_ENTRA_COND_2 > 0 and vl_53 = 0 THEN
            DBMS_OUTPUT.PUT_LINE('VL_ENTRA Valor 2 <<<'||VL_ENTRA_COND_2 ||'*'||vl_53);

             BEGIN
               SELECT COUNT(ZSTPARA_PARAM_ID)
                 INTO VL_ENTRA_COND
                 FROM ZSTPARA
                WHERE     ZSTPARA_MAPA_ID = 'COND_TRAMI'
                      AND ZSTPARA_PARAM_ID = PN_ESTATUS;
             EXCEPTION
             WHEN OTHERS THEN
             VL_ENTRA_COND:=0;
             END;

             IF VL_ENTRA_COND >= 1 THEN

               BEGIN
                 SELECT (SUBSTR(PN_PERIODO,1,2)||ZSTPARA_PARAM_VALOR)
                   INTO VL_CONDONACION
                   FROM ZSTPARA
                  WHERE     ZSTPARA_MAPA_ID = 'COND_TRAMI'
                        AND ZSTPARA_PARAM_ID = PN_ESTATUS;
               EXCEPTION
               WHEN OTHERS THEN
               RAISE_APPLICATION_ERROR (-20002,'Contando vl_condonacion'||VL_CARGO_TRAM||'<>'||SQLERRM);
               END;

               BEGIN
                 SELECT COUNT(A.TBRACCD_DETAIL_CODE)
                   INTO VL_VALIDA_TRAM
                   FROM TBRACCD A
                  WHERE     A.TBRACCD_PIDM = PN_PIDM
                        AND SUBSTR(A.TBRACCD_DETAIL_CODE,3,2) IN ('AM','AO')
                        AND TBRACCD_USER != 'WWW_USER';
               EXCEPTION
               WHEN OTHERS THEN
               RAISE_APPLICATION_ERROR (-20002,'Contando vl_valida_tram'||VL_CARGO_TRAM||'<>'||SQLERRM);
               END;

               DBMS_OUTPUT.PUT_LINE('vl_valida_tram 1 REZA<<<'||VL_VALIDA_TRAM);

               --- VALIDA SI ES SU PRIMER TRAMITE PARA CONDONAR ---------------------------
               -----------------------------------------------------------------------------

               IF VL_VALIDA_TRAM = 0 THEN

                 BEGIN
                   SELECT TBBDETC_DESC,TBBDETC_AMOUNT
                     INTO VL_DESC_CONTRA,VL_MONTO_TRAM
                     FROM TBBDETC
                    WHERE TBBDETC_DETAIL_CODE = VL_CARGO_TRAM;
                 EXCEPTION
                 WHEN OTHERS THEN
                 NULL;
                 END;

                 DBMS_OUTPUT.PUT_LINE('vl_valida_tram 2<<<'||VL_DESC_CONTRA||'ZZZZZZZZZ'||VL_VALIDA_TRAM);

                 BEGIN
                   SELECT NVL (MAX(TBRACCD_TRAN_NUMBER) , 0)+1
                     INTO VL_TRANSACCION
                     FROM TBRACCD
                    WHERE TBRACCD_PIDM =  PN_PIDM;
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_TRANSACCION := 1;
                 END;

                 BEGIN
                   SELECT COUNT (TBRACCD_DETAIL_CODE)
                     INTO VL_1SS
                     FROM TBRACCD
                    WHERE     TBRACCD_PIDM = PN_PIDM
                          AND TBRACCD_DETAIL_CODE = VL_CARGO_TRAM
                          AND TBRACCD_USER =  'WWW_USER'
                          AND TBRACCD_TERM_CODE = PN_PERIODO;
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_1SS:= 0;
                 END;

                 --- VALIDA SI TIENE TRAMITE SOLICITADO POR EL AUTOSERVICIO-----------
                 ---------------------------------------------------------------------
                 IF VL_1SS = 0 THEN

                   BEGIN
                     SELECT COUNT (TBRACCD_DETAIL_CODE)
                       INTO VL_1SS_2
                       FROM TBRACCD
                      WHERE     TBRACCD_PIDM = PN_PIDM
                            AND TBRACCD_DETAIL_CODE = VL_CARGO_TRAM
                            AND TBRACCD_USER =  'WWW_USER';
                   EXCEPTION
                   WHEN OTHERS THEN
                   VL_1SS_2:= 0;
                   END;

                   IF VL_1SS_2 = 0 THEN
                      DBMS_OUTPUT.PUT_LINE('LLEGA a INSERTAR TBRA2 <<<'||VL_ENTRA_COND_2 ||'*'||VL_1SS_2);

                     BEGIN
                       INSERT
                         INTO TBRACCD
                       VALUES (
                               PN_PIDM,   -- TBRACCD_PIDM
                               VL_TRANSACCION,     --TBRACCD_TRAN_NUMBER
                               PN_PERIODO,    -- TBRACCD_TERM_CODE
                               VL_CARGO_TRAM,     ---TBRACCD_DETAIL_CODE
                               USER,     ---TBRACCD_USER
                               SYSDATE,     --TBRACCD_ENTRY_DATE
                               VL_MONTO_TRAM,
                               VL_MONTO_TRAM,    ---TBRACCD_BALANCE
                               SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                               NULL,    --TBRACCD_BILL_DATE
                               NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                               VL_DESC_CONTRA,    -- TBRACCD_DESC
                               NULL,     --TBRACCD_RECEIPT_NUMBER
                               NULL,     --TBRACCD_TRAN_NUMBER_PAID
                               NULL,     --TBRACCD_CROSSREF_PIDM
                               NULL,    --TBRACCD_CROSSREF_NUMBER
                               NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                               'T',    --TBRACCD_SRCE_CODE
                               'Y',    --TBRACCD_ACCT_FEED_IND
                               SYSDATE,  --TBRACCD_ACTIVITY_DATE
                               0,        --TBRACCD_SESSION_NUMBER
                               NULL,    -- TBRACCD_CSHR_END_DATE
                               NULL,     --TBRACCD_CRN
                               NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                               NULL,     -- TBRACCD_LOC_MDT
                               NULL,     --TBRACCD_LOC_MDT_SEQ
                               NULL,     -- TBRACCD_RATE
                               NULL,     --TBRACCD_UNITS
                               NULL,     -- TBRACCD_DOCUMENT_NUMBER
                               SYSDATE,  -- TBRACCD_TRANS_DATE
                               NULL,        -- TBRACCD_PAYMENT_ID
                               NULL,     -- TBRACCD_INVOICE_NUMBER
                               NULL,     -- TBRACCD_STATEMENT_DATE
                               NULL,     -- TBRACCD_INV_NUMBER_PAID
                               'MXN',     -- TBRACCD_CURR_CODE
                               NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                               NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                               NULL,     -- TBRACCD_LATE_DCAT_CODE
                               PN_FECHA_INICIO,     -- TBRACCD_FEED_DATE
                               NULL,     -- TBRACCD_FEED_DOC_CODE
                               NULL,     -- TBRACCD_ATYP_CODE
                               NULL,     -- TBRACCD_ATYP_SEQNO
                               NULL,     -- TBRACCD_CARD_TYPE_VR
                               NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                               NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                               NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                               NULL,     -- TBRACCD_ORIG_CHG_IND
                               NULL,     -- TBRACCD_CCRD_CODE
                               NULL,     -- TBRACCD_MERCHANT_ID
                               NULL,     -- TBRACCD_TAX_REPT_YEAR
                               NULL,     -- TBRACCD_TAX_REPT_BOX
                               NULL,     -- TBRACCD_TAX_AMOUNT
                               NULL,     -- TBRACCD_TAX_FUTURE_IND
                               'Banner',     -- TBRACCD_DATA_ORIGIN
                               'AUTOM',   -- TBRACCD_CREATE_SOURCE
                               NULL,     -- TBRACCD_CPDT_IND
                               NULL,     --TBRACCD_AIDY_CODE
                               PN_KEYSEQNO,     --TBRACCD_STSP_KEY_SEQUENCE
                               VL_PARTE,     --TBRACCD_PERIOD
                               NULL,    --TBRACCD_SURROGATE_ID
                               NULL,     -- TBRACCD_VERSION
                               USER,     --TBRACCD_USER_ID
                               NULL );     --TBRACCD_VPDI_CODE
                     EXCEPTION
                     WHEN OTHERS THEN
                     RAISE_APPLICATION_ERROR (-20002,'Contando BB'||SQLERRM||'<>'|| PN_CAMPUS||'<>'||PN_NIVEL||'<>'||PN_ESTATUS||'<>'||PN_PERIODO||'<>'||PN_FECHA_BAJA||'<>'||PN_FECHA_INICIO||'<>'||PN_FECHA_FIN||'<>'||PN_KEYSEQNO);
                     END;

                     DBMS_OUTPUT.PUT_LINE('AQUI AQUI AQUI AQUI<<<'||VL_VALIDA_TRAM);

                     BEGIN
                       SELECT TBBDETC_DESC
                         INTO VL_CONDONACION_DESC
                         FROM TBBDETC
                        WHERE TBBDETC_DETAIL_CODE = VL_CONDONACION;
                     EXCEPTION
                     WHEN OTHERS THEN
                     RAISE_APPLICATION_ERROR (-20002,'Contando CC'||SQLERRM);
                     END;

                     VL_AJUSTE:= PKG_FINANZAS.SP_APLICA_AJUSTE ( PN_PIDM, VL_TRANSACCION, VL_CONDONACION, VL_MONTO_TRAM, PN_PERIODO, VL_CONDONACION_DESC, SYSDATE, PN_KEYSEQNO, PN_FECHA_INICIO, VL_PARTE, USER );

                     DBMS_OUTPUT.PUT_LINE('AQUI VL_AJUSTE<<<'||VL_AJUSTE);

                   ELSIF VL_1SS_2 > 0 THEN
                      DBMS_OUTPUT.PUT_LINE('LLEGA a INSERTAR TBRA3 <<<'||VL_ENTRA_COND_2 ||'*'||VL_1SS_2);

                     BEGIN
                       INSERT
                         INTO TBRACCD
                       VALUES (
                               PN_PIDM,   -- TBRACCD_PIDM
                               VL_TRANSACCION,     --TBRACCD_TRAN_NUMBER
                               PN_PERIODO,    -- TBRACCD_TERM_CODE
                               VL_CARGO_TRAM,     ---TBRACCD_DETAIL_CODE
                               USER,     ---TBRACCD_USER
                               SYSDATE,     --TBRACCD_ENTRY_DATE
                               VL_MONTO_TRAM,
                               VL_MONTO_TRAM,    ---TBRACCD_BALANCE
                               SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                               NULL,    --TBRACCD_BILL_DATE
                               NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                               VL_DESC_CONTRA,    -- TBRACCD_DESC
                               NULL,     --TBRACCD_RECEIPT_NUMBER
                               NULL,     --TBRACCD_TRAN_NUMBER_PAID
                               NULL,     --TBRACCD_CROSSREF_PIDM
                               NULL,    --TBRACCD_CROSSREF_NUMBER
                               NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                               'T',    --TBRACCD_SRCE_CODE
                               'Y',    --TBRACCD_ACCT_FEED_IND
                               SYSDATE,  --TBRACCD_ACTIVITY_DATE
                               0,        --TBRACCD_SESSION_NUMBER
                               NULL,    -- TBRACCD_CSHR_END_DATE
                               NULL,     --TBRACCD_CRN
                               NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                               NULL,     -- TBRACCD_LOC_MDT
                               NULL,     --TBRACCD_LOC_MDT_SEQ
                               NULL,     -- TBRACCD_RATE
                               NULL,     --TBRACCD_UNITS
                               NULL,     -- TBRACCD_DOCUMENT_NUMBER
                               SYSDATE,  -- TBRACCD_TRANS_DATE
                               NULL,        -- TBRACCD_PAYMENT_ID
                               NULL,     -- TBRACCD_INVOICE_NUMBER
                               NULL,     -- TBRACCD_STATEMENT_DATE
                               NULL,     -- TBRACCD_INV_NUMBER_PAID
                               'MXN',     -- TBRACCD_CURR_CODE
                               NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                               NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                               NULL,     -- TBRACCD_LATE_DCAT_CODE
                               PN_FECHA_INICIO,     -- TBRACCD_FEED_DATE
                               NULL,     -- TBRACCD_FEED_DOC_CODE
                               NULL,     -- TBRACCD_ATYP_CODE
                               NULL,     -- TBRACCD_ATYP_SEQNO
                               NULL,     -- TBRACCD_CARD_TYPE_VR
                               NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                               NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                               NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                               NULL,     -- TBRACCD_ORIG_CHG_IND
                               NULL,     -- TBRACCD_CCRD_CODE
                               NULL,     -- TBRACCD_MERCHANT_ID
                               NULL,     -- TBRACCD_TAX_REPT_YEAR
                               NULL,     -- TBRACCD_TAX_REPT_BOX
                               NULL,     -- TBRACCD_TAX_AMOUNT
                               NULL,     -- TBRACCD_TAX_FUTURE_IND
                               'Banner',     -- TBRACCD_DATA_ORIGIN
                               'AUTOM',   -- TBRACCD_CREATE_SOURCE
                               NULL,     -- TBRACCD_CPDT_IND
                               NULL,     --TBRACCD_AIDY_CODE
                               PN_KEYSEQNO,     --TBRACCD_STSP_KEY_SEQUENCE
                               VL_PARTE,     --TBRACCD_PERIOD
                               NULL,    --TBRACCD_SURROGATE_ID
                               NULL,     -- TBRACCD_VERSION
                               USER,     --TBRACCD_USER_ID
                               NULL );     --TBRACCD_VPDI_CODE

                              DBMS_OUTPUT.PUT_LINE('AQUI AQUI AQUI AQUI 1 <<<'||VL_VALIDA_TRAM);


                     EXCEPTION
                     WHEN OTHERS THEN
                     RAISE_APPLICATION_ERROR (-20002,'Contando BB'||SQLERRM||'<>'|| PN_CAMPUS||'<>'||PN_NIVEL||'<>'||PN_ESTATUS||'<>'||PN_PERIODO||'<>'||PN_FECHA_BAJA||'<>'||PN_FECHA_INICIO||'<>'||PN_FECHA_FIN||'<>'||PN_KEYSEQNO);
                     END;

                 END IF;

                 ELSIF VL_1SS > 0 THEN
                   --- VALIDA SI ES EL PRIMER TRAMITE SOLICITADO POR EL AUTOSERVICIO --
                   --------------------------------------------------------------------
                   BEGIN
                     SELECT COUNT(TBRACCD_DETAIL_CODE)
                       INTO VL_1SS_2
                       FROM TBRACCD
                      WHERE     TBRACCD_PIDM = PN_PIDM
                            AND TBRACCD_DETAIL_CODE = VL_CARGO_TRAM
                            AND TBRACCD_USER =  'WWW_USER';
                   EXCEPTION
                   WHEN OTHERS THEN
                   VL_1SS:= 0;
                   END;

                   IF VL_1SS = 1 THEN
                     --- VALIDA SI EL TRAMITE DEL AUTOSERVICIO TIENE CONDONACION -----
                     -----------------------------------------------------------------
                     BEGIN
                        SELECT NVL((SELECT TBRACCD_DETAIL_CODE
                                    FROM TBRACCD
                                    WHERE TBRACCD_PIDM = PPL.TBRAPPL_PIDM
                                    AND TBRACCD_TRAN_NUMBER = PPL.TBRAPPL_PAY_TRAN_NUMBER
                                    AND TBRACCD_DETAIL_CODE = VL_CONDONACION),'SIN AJUSTE')
                          INTO VL_1SS_PPL
                          FROM TBRAPPL PPL
                         WHERE     PPL.TBRAPPL_PIDM = PN_PIDM
                               AND PPL.TBRAPPL_CHG_TRAN_NUMBER = (SELECT TBRACCD_TRAN_NUMBER
                                                                    FROM TBRACCD
                                                                   WHERE     TBRACCD_PIDM = PPL.TBRAPPL_PIDM
                                                                         AND TBRACCD_DETAIL_CODE = VL_CARGO_TRAM
                                                                         AND TBRACCD_USER =  'WWW_USER')
                               AND PPL.TBRAPPL_ACTIVITY_DATE = (SELECT MAX(A1.TBRAPPL_ACTIVITY_DATE)
                                                                  FROM TBRAPPL A1
                                                                 WHERE A1.TBRAPPL_PIDM = PPL.TBRAPPL_PIDM
                                                                       AND A1.TBRAPPL_CHG_TRAN_NUMBER= PPL.TBRAPPL_CHG_TRAN_NUMBER);
                     EXCEPTION
                     WHEN OTHERS THEN
                     VL_1SS_PPL:= 'SIN AJUSTE';
                     END;

                     IF VL_1SS_PPL = 'SIN AJUSTE' THEN

                       BEGIN
                         SELECT TBRACCD_TRAN_NUMBER,TBRACCD_PERIOD
                           INTO VL_1SS_NUM,VL_1SS_PPER
                           FROM TBRACCD
                          WHERE     TBRACCD_PIDM = PN_PIDM
                                AND TBRACCD_DETAIL_CODE = VL_CARGO_TRAM
                                AND TBRACCD_USER =  'WWW_USER';
                       EXCEPTION
                       WHEN OTHERS THEN
                       VL_1SS_NUM:= NULL;
                       VL_1SS_PPER:= NULL;
                       END;

                       PKG_FINANZAS.P_DESAPLICA_PAGOS (PN_PIDM, VL_1SS_NUM);

                       BEGIN
                         SELECT TBBDETC_DESC
                           INTO VL_CONDONACION_DESC
                           FROM TBBDETC
                          WHERE TBBDETC_DETAIL_CODE = VL_CONDONACION;
                       EXCEPTION
                       WHEN OTHERS THEN
                       RAISE_APPLICATION_ERROR (-20002,'Contando CC'||SQLERRM);
                       END;

                       VL_AJUSTE:= PKG_FINANZAS.SP_APLICA_AJUSTE ( PN_PIDM,
                                                                   VL_1SS_NUM,
                                                                   VL_CONDONACION,
                                                                   VL_MONTO_TRAM,
                                                                   PN_PERIODO,
                                                                   VL_CONDONACION_DESC,
                                                                   SYSDATE,
                                                                   PN_KEYSEQNO,
                                                                   PN_FECHA_INICIO,
                                                                   VL_1SS_PPER,
                                                                   USER );

                     ELSE

                        DBMS_OUTPUT.PUT_LINE('LLEGA a INSERTAR TBRA3 <<<'||VL_ENTRA_COND_2 ||'*'||VL_1SS_2);

                       BEGIN
                         INSERT
                           INTO TBRACCD
                         VALUES (
                                  PN_PIDM,   -- TBRACCD_PIDM
                                  VL_TRANSACCION,     --TBRACCD_TRAN_NUMBER
                                  PN_PERIODO,    -- TBRACCD_TERM_CODE
                                  VL_CARGO_TRAM,     ---TBRACCD_DETAIL_CODE
                                  USER,     ---TBRACCD_USER
                                  SYSDATE,     --TBRACCD_ENTRY_DATE
                                  VL_MONTO_TRAM,
                                  VL_MONTO_TRAM,    ---TBRACCD_BALANCE
                                  SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                                  NULL,    --TBRACCD_BILL_DATE
                                  NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                                  VL_DESC_CONTRA,    -- TBRACCD_DESC
                                  NULL,     --TBRACCD_RECEIPT_NUMBER
                                  NULL,     --TBRACCD_TRAN_NUMBER_PAID
                                  NULL,     --TBRACCD_CROSSREF_PIDM
                                  NULL,    --TBRACCD_CROSSREF_NUMBER
                                  NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                                  'T',    --TBRACCD_SRCE_CODE
                                  'Y',    --TBRACCD_ACCT_FEED_IND
                                  SYSDATE,  --TBRACCD_ACTIVITY_DATE
                                  0,        --TBRACCD_SESSION_NUMBER
                                  NULL,    -- TBRACCD_CSHR_END_DATE
                                  NULL,     --TBRACCD_CRN
                                  NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                                  NULL,     -- TBRACCD_LOC_MDT
                                  NULL,     --TBRACCD_LOC_MDT_SEQ
                                  NULL,     -- TBRACCD_RATE
                                  NULL,     --TBRACCD_UNITS
                                  NULL,     -- TBRACCD_DOCUMENT_NUMBER
                                  SYSDATE,  -- TBRACCD_TRANS_DATE
                                  NULL,        -- TBRACCD_PAYMENT_ID
                                  NULL,     -- TBRACCD_INVOICE_NUMBER
                                  NULL,     -- TBRACCD_STATEMENT_DATE
                                  NULL,     -- TBRACCD_INV_NUMBER_PAID
                                  'MXN',     -- TBRACCD_CURR_CODE
                                  NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                                  NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                                  NULL,     -- TBRACCD_LATE_DCAT_CODE
                                  PN_FECHA_INICIO,     -- TBRACCD_FEED_DATE
                                  NULL,     -- TBRACCD_FEED_DOC_CODE
                                  NULL,     -- TBRACCD_ATYP_CODE
                                  NULL,     -- TBRACCD_ATYP_SEQNO
                                  NULL,     -- TBRACCD_CARD_TYPE_VR
                                  NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                                  NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                                  NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                                  NULL,     -- TBRACCD_ORIG_CHG_IND
                                  NULL,     -- TBRACCD_CCRD_CODE
                                  NULL,     -- TBRACCD_MERCHANT_ID
                                  NULL,     -- TBRACCD_TAX_REPT_YEAR
                                  NULL,     -- TBRACCD_TAX_REPT_BOX
                                  NULL,     -- TBRACCD_TAX_AMOUNT
                                  NULL,     -- TBRACCD_TAX_FUTURE_IND
                                  'Banner',     -- TBRACCD_DATA_ORIGIN
                                  'AUTOM',   -- TBRACCD_CREATE_SOURCE
                                  NULL,     -- TBRACCD_CPDT_IND
                                  NULL,     --TBRACCD_AIDY_CODE
                                  PN_KEYSEQNO,     --TBRACCD_STSP_KEY_SEQUENCE
                                  VL_PARTE,     --TBRACCD_PERIOD
                                  NULL,    --TBRACCD_SURROGATE_ID
                                  NULL,     -- TBRACCD_VERSION
                                  USER,     --TBRACCD_USER_ID
                                  NULL );     --TBRACCD_VPDI_CODE
                       EXCEPTION
                       WHEN OTHERS THEN
                       RAISE_APPLICATION_ERROR (-20002,'Contando BB'||SQLERRM||'<>'|| PN_CAMPUS||'<>'||PN_NIVEL||'<>'||PN_ESTATUS||'<>'||PN_PERIODO||'<>'||PN_FECHA_BAJA||'<>'||PN_FECHA_INICIO||'<>'||PN_FECHA_FIN||'<>'||PN_KEYSEQNO);
                       END;

                     END IF;
                   END IF;
                 END IF;

               ELSIF VL_VALIDA_TRAM > 0 THEN

                 DBMS_OUTPUT.PUT_LINE('vl_valida_tram 1.1 <<<'||VL_VALIDA_TRAM);

                 BEGIN
                   SELECT TBBDETC_DESC,TBBDETC_AMOUNT
                     INTO VL_DESC_CONTRA,VL_MONTO_TRAM
                     FROM TBBDETC
                    WHERE TBBDETC_DETAIL_CODE = VL_CARGO_TRAM;
                 EXCEPTION
                 WHEN OTHERS THEN
                 RAISE_APPLICATION_ERROR (-20002,'Contando DD'||SQLERRM);
                 END;

                 DBMS_OUTPUT.PUT_LINE('vl_valida_tram 2<<<'||VL_DESC_CONTRA);

                 BEGIN
                   SELECT NVL (MAX(TBRACCD_TRAN_NUMBER) , 0)+1
                     INTO VL_TRANSACCION
                     FROM TBRACCD
                    WHERE TBRACCD_PIDM =  PN_PIDM;
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_TRANSACCION := 1;
                 END;

                 BEGIN
                   SELECT COUNT (TBRACCD_DETAIL_CODE)
                     INTO VL_1SS
                     FROM TBRACCD
                    WHERE     TBRACCD_PIDM = PN_PIDM
                          AND TBRACCD_DETAIL_CODE = VL_CARGO_TRAM
                          AND TBRACCD_USER =  'WWW_USER'
                          AND TBRACCD_TERM_CODE = PN_PERIODO;
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_1SS:= 0;
                 END;

                 IF VL_1SS = 0 THEN
                 DBMS_OUTPUT.PUT_LINE('LLEGA a INSERTAR TBRA4 <<<'||VL_ENTRA_COND_2 ||'*'||VL_1SS_2);

                   BEGIN
                     INSERT
                       INTO TBRACCD
                     VALUES (
                              PN_PIDM,   -- TBRACCD_PIDM
                              VL_TRANSACCION,     --TBRACCD_TRAN_NUMBER
                              PN_PERIODO,    -- TBRACCD_TERM_CODE
                              VL_CARGO_TRAM,     ---TBRACCD_DETAIL_CODE
                              USER,     ---TBRACCD_USER
                              SYSDATE,     --TBRACCD_ENTRY_DATE
                              VL_MONTO_TRAM,
                              VL_MONTO_TRAM,    ---TBRACCD_BALANCE
                              SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                              NULL,    --TBRACCD_BILL_DATE
                              NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                              VL_DESC_CONTRA,    -- TBRACCD_DESC
                              NULL,     --TBRACCD_RECEIPT_NUMBER
                              NULL,     --TBRACCD_TRAN_NUMBER_PAID
                              NULL,     --TBRACCD_CROSSREF_PIDM
                              NULL,    --TBRACCD_CROSSREF_NUMBER
                              NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                              'T',    --TBRACCD_SRCE_CODE
                              'Y',    --TBRACCD_ACCT_FEED_IND
                              SYSDATE,  --TBRACCD_ACTIVITY_DATE
                              0,        --TBRACCD_SESSION_NUMBER
                              NULL,    -- TBRACCD_CSHR_END_DATE
                              NULL,     --TBRACCD_CRN
                              NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                              NULL,     -- TBRACCD_LOC_MDT
                              NULL,     --TBRACCD_LOC_MDT_SEQ
                              NULL,     -- TBRACCD_RATE
                              NULL,     --TBRACCD_UNITS
                              NULL,     -- TBRACCD_DOCUMENT_NUMBER
                              SYSDATE,  -- TBRACCD_TRANS_DATE
                              NULL,        -- TBRACCD_PAYMENT_ID
                              NULL,     -- TBRACCD_INVOICE_NUMBER
                              NULL,     -- TBRACCD_STATEMENT_DATE
                              NULL,     -- TBRACCD_INV_NUMBER_PAID
                              'MXN',     -- TBRACCD_CURR_CODE
                              NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                              NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                              NULL,     -- TBRACCD_LATE_DCAT_CODE
                              PN_FECHA_INICIO,     -- TBRACCD_FEED_DATE
                              NULL,     -- TBRACCD_FEED_DOC_CODE
                              NULL,     -- TBRACCD_ATYP_CODE
                              NULL,     -- TBRACCD_ATYP_SEQNO
                              NULL,     -- TBRACCD_CARD_TYPE_VR
                              NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                              NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                              NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                              NULL,     -- TBRACCD_ORIG_CHG_IND
                              NULL,     -- TBRACCD_CCRD_CODE
                              NULL,     -- TBRACCD_MERCHANT_ID
                              NULL,     -- TBRACCD_TAX_REPT_YEAR
                              NULL,     -- TBRACCD_TAX_REPT_BOX
                              NULL,     -- TBRACCD_TAX_AMOUNT
                              NULL,     -- TBRACCD_TAX_FUTURE_IND
                              'Banner',     -- TBRACCD_DATA_ORIGIN
                              'AUTOM',   -- TBRACCD_CREATE_SOURCE
                              NULL,     -- TBRACCD_CPDT_IND
                              NULL,     --TBRACCD_AIDY_CODE
                              PN_KEYSEQNO,     --TBRACCD_STSP_KEY_SEQUENCE
                              VL_PARTE,     --TBRACCD_PERIOD
                              NULL,    --TBRACCD_SURROGATE_ID
                              NULL,     -- TBRACCD_VERSION
                              USER,     --TBRACCD_USER_ID
                              NULL );     --TBRACCD_VPDI_CODE
                   EXCEPTION
                   WHEN OTHERS THEN
                   RAISE_APPLICATION_ERROR (-20002,'Contando EE'||SQLERRM||'<>'|| PN_CAMPUS||'<>'||PN_NIVEL||'<>'||PN_ESTATUS||'<>'||PN_PERIODO||'<>'||PN_FECHA_BAJA||'<>'||PN_FECHA_INICIO||'<>'||PN_FECHA_FIN||'<>'||PN_KEYSEQNO);
                   END;
                 END IF;
               END IF;

             ELSIF VL_ENTRA_COND = 0 THEN

               BEGIN
                 SELECT TBBDETC_DESC,TBBDETC_AMOUNT
                   INTO VL_DESC_CONTRA,VL_MONTO_TRAM
                   FROM TBBDETC
                  WHERE TBBDETC_DETAIL_CODE = VL_CARGO_TRAM;
               EXCEPTION
               WHEN OTHERS THEN
               RAISE_APPLICATION_ERROR (-20002,'Contando FF'||SQLERRM);
               END;

               DBMS_OUTPUT.PUT_LINE('vl_valida_tram 2<<<'||VL_DESC_CONTRA);

               BEGIN
                 SELECT NVL (MAX(TBRACCD_TRAN_NUMBER) , 0)+1
                   INTO VL_TRANSACCION
                   FROM TBRACCD
                  WHERE TBRACCD_PIDM =  PN_PIDM;
               EXCEPTION
               WHEN OTHERS THEN
               VL_TRANSACCION := 1;
               END;

               BEGIN
                 SELECT COUNT (TBRACCD_DETAIL_CODE)
                   INTO VL_1SS
                   FROM TBRACCD
                  WHERE     TBRACCD_PIDM = PN_PIDM
                        AND TBRACCD_DETAIL_CODE = VL_CARGO_TRAM
                        AND TBRACCD_USER =  'WWW_USER'
                        AND TBRACCD_TERM_CODE = PN_PERIODO;
               EXCEPTION
               WHEN OTHERS THEN
               VL_1SS:= 0;
               END;

               IF VL_1SS = 0 And vl_53 = 0 THEN
                    DBMS_OUTPUT.PUT_LINE('LLEGA a INSERTAR TBRA5 <<<'||VL_ENTRA_COND_2 ||'*'||VL_1SS_2 ||'*'||vl_53);

                 BEGIN
                   INSERT
                     INTO TBRACCD
                   VALUES (
                             PN_PIDM,   -- TBRACCD_PIDM
                             VL_TRANSACCION,     --TBRACCD_TRAN_NUMBER
                             PN_PERIODO,    -- TBRACCD_TERM_CODE
                             VL_CARGO_TRAM,     ---TBRACCD_DETAIL_CODE
                             USER,     ---TBRACCD_USER
                             SYSDATE,     --TBRACCD_ENTRY_DATE
                             VL_MONTO_TRAM,
                             VL_MONTO_TRAM,    ---TBRACCD_BALANCE
                             SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                             NULL,    --TBRACCD_BILL_DATE
                             NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                             VL_DESC_CONTRA,    -- TBRACCD_DESC
                             NULL,     --TBRACCD_RECEIPT_NUMBER
                             NULL,     --TBRACCD_TRAN_NUMBER_PAID
                             NULL,     --TBRACCD_CROSSREF_PIDM
                             NULL,    --TBRACCD_CROSSREF_NUMBER
                             NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                             'T',    --TBRACCD_SRCE_CODE
                             'Y',    --TBRACCD_ACCT_FEED_IND
                             SYSDATE,  --TBRACCD_ACTIVITY_DATE
                             0,        --TBRACCD_SESSION_NUMBER
                             NULL,    -- TBRACCD_CSHR_END_DATE
                             NULL,     --TBRACCD_CRN
                             NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                             NULL,     -- TBRACCD_LOC_MDT
                             NULL,     --TBRACCD_LOC_MDT_SEQ
                             NULL,     -- TBRACCD_RATE
                             NULL,     --TBRACCD_UNITS
                             NULL,     -- TBRACCD_DOCUMENT_NUMBER
                             SYSDATE,  -- TBRACCD_TRANS_DATE
                             NULL,        -- TBRACCD_PAYMENT_ID
                             NULL,     -- TBRACCD_INVOICE_NUMBER
                             NULL,     -- TBRACCD_STATEMENT_DATE
                             NULL,     -- TBRACCD_INV_NUMBER_PAID
                             'MXN',     -- TBRACCD_CURR_CODE
                             NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                             NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                             NULL,     -- TBRACCD_LATE_DCAT_CODE
                             PN_FECHA_INICIO,     -- TBRACCD_FEED_DATE
                             NULL,     -- TBRACCD_FEED_DOC_CODE
                             NULL,     -- TBRACCD_ATYP_CODE
                             NULL,     -- TBRACCD_ATYP_SEQNO
                             NULL,     -- TBRACCD_CARD_TYPE_VR
                             NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                             NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                             NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                             NULL,     -- TBRACCD_ORIG_CHG_IND
                             NULL,     -- TBRACCD_CCRD_CODE
                             NULL,     -- TBRACCD_MERCHANT_ID
                             NULL,     -- TBRACCD_TAX_REPT_YEAR
                             NULL,     -- TBRACCD_TAX_REPT_BOX
                             NULL,     -- TBRACCD_TAX_AMOUNT
                             NULL,     -- TBRACCD_TAX_FUTURE_IND
                             'Banner',     -- TBRACCD_DATA_ORIGIN
                             'AUTOM',   -- TBRACCD_CREATE_SOURCE
                             NULL,     -- TBRACCD_CPDT_IND
                             NULL,     --TBRACCD_AIDY_CODE
                             PN_KEYSEQNO,     --TBRACCD_STSP_KEY_SEQUENCE
                             VL_PARTE,     --TBRACCD_PERIOD
                             NULL,    --TBRACCD_SURROGATE_ID
                             NULL,     -- TBRACCD_VERSION
                             USER,     --TBRACCD_USER_ID
                             NULL );     --TBRACCD_VPDI_CODE

                 EXCEPTION
                 WHEN OTHERS THEN
                 RAISE_APPLICATION_ERROR (-20002,'Contando GG'||SQLERRM||'<>'|| PN_CAMPUS||'<>'||PN_NIVEL||'<>'||PN_ESTATUS||'<>'||PN_PERIODO||'<>'||PN_FECHA_BAJA||'<>'||PN_FECHA_INICIO||'<>'||PN_FECHA_FIN||'<>'||PN_KEYSEQNO);
                 END;

               END IF;
             END IF;
           END IF;

         ELSIF PN_ESTATUS = 'BK' THEN ------INSERTA EL CARGO DE MES CONTENCION--03/01/2022 SE CAMBIO INDICADOR BI PARA EVITAR EL CARGO A SOLICITUD DE FINANZAS

          DBMS_OUTPUT.PUT_LINE('MES CONTENCION VALIDACION '||PN_PIDM);

           BEGIN
             SELECT A.TBRACCD_AMOUNT
               INTO VL_MESCONTENCION
               FROM TBRACCD A
              WHERE     A.TBRACCD_PIDM = PN_PIDM
                    AND A.TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                                    FROM TBBDETC
                                                   WHERE     TBBDETC_DCAT_CODE = 'COL'
                                                         AND TBBDETC_DESC LIKE'COLEGIATURA %'
                                                         AND TBBDETC_DESC NOT LIKE'%NOTA%'
                                                         AND TBBDETC_DESC  != 'COLEGIATURA EXTRAORDINARIO')
                    AND A.TBRACCD_TRAN_NUMBER = (SELECT MAX (A1.TBRACCD_TRAN_NUMBER)
                                                   FROM TBRACCD A1
                                                  WHERE     A1.TBRACCD_PIDM = A.TBRACCD_PIDM
                                                        AND A1.TBRACCD_DETAIL_CODE = A.TBRACCD_DETAIL_CODE);
           EXCEPTION
           WHEN OTHERS THEN
           VL_MESCONTENCION:= NULL;
           END;

           DBMS_OUTPUT.PUT_LINE('MES CONTENCION VALIDACION 2 '||VL_MESCONTENCION);

           BEGIN
             SELECT DISTINCT SPRIDEN_ID
               INTO VL_MATRICULA
               FROM SPRIDEN
              WHERE     SPRIDEN_PIDM = PN_PIDM
                    AND SPRIDEN_CHANGE_IND IS NULL;
           EXCEPTION
           WHEN OTHERS THEN
           VL_MATRICULA:= 'ERROR';
           END;

           BEGIN
             SELECT DISTINCT SORLCUR_PROGRAM
               INTO VL_PROGR
               FROM SORLCUR A
              WHERE     A.SORLCUR_PIDM = PN_PIDM
                    AND A.SORLCUR_LMOD_CODE = 'LEARNER'
                    AND A.SORLCUR_KEY_SEQNO = PN_KEYSEQNO;
           EXCEPTION
           WHEN OTHERS THEN
           VL_PROGR:= NULL;
           END;

           DBMS_OUTPUT.PUT_LINE('MES CONTENCION VALIDACION 3 '||VL_MATRICULA||' =  '||VL_PROGR);

           IF VL_MESCONTENCION IS NOT NULL
              AND VL_MATRICULA != 'ERROR'
              THEN

             DBMS_OUTPUT.PUT_LINE('MES CONTENCION VALIDACION 3.1 '||VL_MATRICULA);
             BEGIN

               VL_FUNCION:= PKG_FINANZAS.FN_INSER_TRAM (VL_MATRICULA,
                                                        VL_MESCONTENCION,
                                                        SUBSTR(VL_MATRICULA,1,2)||'34',
                                                        'MES CONTENCION',
                                                        SYSDATE,
                                                        USER,
                                                        'CARGO MES CONTENCION BTI',
                                                        'MXN',
                                                        'SZFCABA',
                                                        VL_PROGR );

             END;
             DBMS_OUTPUT.PUT_LINE('MES CONTENCION VALIDACION 4 '||SUBSTR(VL_MATRICULA,1,2)||'34');
           END IF;
         END IF;

       ELSE
         DBMS_OUTPUT.PUT_LINE('FINALIZA GGC EL MARRULLERO');
         VL_ERROR := 'El Numero de Semanas cursadas por el alumno ('||VL_SEMANA ||') no esta dentro del Rango de Semanas para la aplicacion de la Baja configurada en SZFBAEC';

       END IF;

     ELSIF VL_SEMANA < 0 THEN
        VL_ERROR:= 'EXITO';
     ELSE

       VL_ERROR :='Fecha Inicio:'||PN_FECHA_INICIO||'. No Semanas:'||VL_SEMANA||'. No Existe la configuración para procesar esta baja por no contar con numero de semanas';
     END IF;

   ELSIF VL_EXI_CONF = 0 THEN
     VL_ERROR := 'No Existe la configuración para procesar esta baja Campus ' ||PN_CAMPUS ||' Nivel ' ||PN_NIVEL ||' Estatus3 '|| PN_ESTATUS ||' Programa '|| PN_PROGRAMA;
   END IF;

   VC_CONTA:=VC_CONTA+1;

   DBMS_OUTPUT.PUT_LINE(VL_ERROR);

   IF PN_ESTATUS IN ('BD','BT','CV','BI','BA') THEN

     BEGIN
       DELETE GORADID
        WHERE GORADID_ADID_CODE = 'UTLX' AND GORADID_PIDM = PN_PIDM;
     END;

    ----------------- Se valida que este activa la membresia de Utelx --------------
    vl_utelx:= null;
    Begin
            Select SZTUTLX_DISABLE_IND
                Into vl_utelx
            from SZTUTLX a
            Where 1=1
            And a.SZTUTLX_PIDM = PN_PIDM
            And a.SZTUTLX_SEQ_NO = (select max ( a1.SZTUTLX_SEQ_NO)
                                    from SZTUTLX a1
                                    Where 1=1
                                    And a.SZTUTLX_PIDM = a1.SZTUTLX_PIDM);
    Exception
        When Others then
            vl_utelx:= null;
    End;

    If vl_utelx = 'A' then
        Begin
             Insert into SZTUTLX
                  Select a.SZTUTLX_PIDM, a.SZTUTLX_ID, a.SZTUTLX_TERM_CODE, a.SZTUTLX_CAMP_CODE, a.SZTUTLX_LEVL_CODE, a.SZTUTLX_SEQ_NO+1 SZTUTLX_SEQ_NO,
                         0 SZTUTLX_STAT_IND, null SZTUTLX_OBS, 'I' SZTUTLX_DISABLE_IND, a.SZTUTLX_PWD, a.SZTUTLX_MDL_ID, user SZTUTLX_USER_INSERT,
                         sysdate SZTUTLX_ACTIVITY_DATE, null SZTUTLX_USER_UPDATE, null SZTUTLX_DATE_UPDATE, a.SZTUTLX_ROW1, a.SZTUTLX_ROW2, a.SZTUTLX_ROW3,
                         a.SZTUTLX_ROW4, a.SZTUTLX_ROW5 , user SZTUTLX_USER_BLOQUEO,  sysdate SZTUTLX_ACTIVITY_BLOQUEO, a.SZTUTLX_GRATIS, 
                         a.SZTUTLX_GRATIS_APLI, SZTUTLX_FREC_PAGO, SZTUTLX_MONTO_DESC, SZTUTLX_NUM_DESC, SZTUTLX_NUM_DESC_APLIC
                  from SZTUTLX a
                        Where 1=1
                        And a.SZTUTLX_PIDM = PN_PIDM
                        And a.SZTUTLX_SEQ_NO = (select max ( a1.SZTUTLX_SEQ_NO)
                                                from SZTUTLX a1
                                                Where 1=1
                                                And a.SZTUTLX_PIDM = a1.SZTUTLX_PIDM);
        Exception
            When Others then
                null;
        End;

    End if;



     BEGIN
       SELECT DISTINCT SPRIDEN_ID
         INTO VL_MATRICULA
         FROM SPRIDEN
        WHERE SPRIDEN_PIDM = PN_PIDM AND SPRIDEN_CHANGE_IND IS NULL;
     EXCEPTION
     WHEN OTHERS THEN
     VL_MATRICULA:= 'ERROR';
     END;

     VL_CART_UTL:= PKG_FINANZAS.F_MEMBRESIA_UTLX( VL_MATRICULA,
                                                  'CANCELA',
                                                  NULL,
                                                  NULL,
                                                  NULL,
                                                  NULL,
                                                  NULL);

   END IF;

   IF VL_ERROR != 'EXITO' THEN
      RETURN VL_ERROR;
      ROLLBACK;
   ELSE
      RETURN VL_ERROR;
      COMMIT;
      EXIT;
   END IF;

 END LOOP;

 DBMS_OUTPUT.PUT_LINE(VL_ERROR);
 EXCEPTION
 WHEN OTHERS THEN
 VL_ERROR:= 'GGC ERROR GENERAL '||SQLERRM;
 RETURN VL_ERROR;
END F_BAJA_ECONOMICA;



FUNCTION F_BAJA_ACADEMICA ( P_ID VARCHAR,
                            P_PROGRAMA VARCHAR2,
                            P_NVO_ESTATUS VARCHAR2,
                            P_FECHA_BAJA DATE,
                            P_MOTIVO_BAJA VARCHAR2,
                            P_CODE_BAJA VARCHAR2 DEFAULT NULL ) RETURN VARCHAR2
IS
-- AJUSTE SE AGREGO UN PARAMETRO NUEVO P_CODE_BAJA QUE SE INSERTA O ACTUALIZA EN SFBETRM:: GLOVICX 27/10/2023 
-- se duplica flujo para que se inserte el parametro p_code_baja a todos los eststus regla miryam  glovicx 23.11.23
  CONT              NUMBER:=0;
  VC_PERIODO        VARCHAR2(10);
  VN_INSERTA        NUMBER;
  CONSE_SORLCUR     NUMBER;
  CDE               VARCHAR2(1);
  VC_ERR            VARCHAR2(200);
  VC_RETURN         VARCHAR2(2000);
  VL_ERROR          VARCHAR2(500):= 'EXITO';
  VC_PTRM_CODE      VARCHAR2(5);
  VC_EN_RANGO       NUMBER;
  VD_FECHA_FIN      DATE;
  LV_EXISTE         NUMBER;
  L_RETORNA_AULA    VARCHAR2(500);
  L_PIDM            NUMBER;

BEGIN

  VC_PERIODO      :=NULL;
  VN_INSERTA      :=0;
  CONSE_SORLCUR   :=0;
  CDE             :=NULL;
  CONT            :=0;
  VD_FECHA_FIN    :=NULL;
  --DBMS_OUTPUT.PUT_LINE('ENTRA INICIO 1 = '||P_ID||'-'||P_CODE_BAJA );

  FOR MINI_PERFIL IN (
     SELECT *
       FROM (
            SELECT DISTINCT
                    D.SPRIDEN_ID MATRICULA,
                    D.SPRIDEN_FIRST_NAME || ' ' || D.SPRIDEN_LAST_NAME NOMBRE,
                    B.SGBSTDN_TERM_CODE_EFF PERIODO,
                    A.SORLCUR_START_DATE FECHA_INICIO,
                    A.SORLCUR_PROGRAM PROGRAMA,
                    E.SZTDTEC_PROGRAMA_COMP DESC_PROGRAMA,
                    B.SGBSTDN_STST_CODE ESTATUS,
                    B.SGBSTDN_STYP_CODE TIPO_ALUMNO,
                    B.SGBSTDN_RATE_CODE RATE,
                    JOR.JORNADA,
                    JOR.DESC_JORNADA,
                    A.SORLCUR_PIDM PIDM,
                    A.SORLCUR_SEQNO SEQNO,
                    A.SORLCUR_KEY_SEQNO KEY_SEQNO,
                    B.SGBSTDN_LEVL_CODE NIVEL,
                    B.SGBSTDN_CAMP_CODE CAMPUS
              FROM SORLCUR A,
                   SGBSTDN B,
                   SPRIDEN D,
                   SZTDTEC E,
                   (SELECT J1.SGRSATT_TERM_CODE_EFF,
                           J1.SGRSATT_ATTS_CODE JORNADA,
                           J2.STVATTS_DESC DESC_JORNADA,
                           J1.SGRSATT_PIDM ATTS_PIDM,
                           J1.SGRSATT_STSP_KEY_SEQUENCE
                      FROM SGRSATT J1, STVATTS J2
                     WHERE     J2.STVATTS_CODE = J1.SGRSATT_ATTS_CODE
                           AND REGEXP_LIKE (J2.STVATTS_CODE, '^[0-9]')
                           AND J1.SGRSATT_TERM_CODE_EFF IN  (SELECT MAX (C2.SGRSATT_TERM_CODE_EFF)
                                                               FROM SGRSATT C2
                                                              WHERE     C2.SGRSATT_PIDM = J1.SGRSATT_PIDM
                                                                    AND C2.SGRSATT_STSP_KEY_SEQUENCE = J1.SGRSATT_STSP_KEY_SEQUENCE)) JOR
           WHERE     JOR.ATTS_PIDM = A.SORLCUR_PIDM
                 --AND JOR.SGRSATT_TERM_CODE_EFF(+) = b.sgbstdn_term_code_eff
                 AND SGRSATT_STSP_KEY_SEQUENCE = A.SORLCUR_KEY_SEQNO
                 AND A.SORLCUR_LMOD_CODE = 'LEARNER'
                 AND A.SORLCUR_CACT_CODE = 'ACTIVE' --RLS20180118
                 AND A.SORLCUR_ROLL_IND = 'Y' --RLS20180118
                 AND A.SORLCUR_SEQNO IN (SELECT MAX (A1.SORLCUR_SEQNO)
                                           FROM SORLCUR A1
                                          WHERE     A.SORLCUR_PIDM = A1.SORLCUR_PIDM
                                                AND A.SORLCUR_PROGRAM = A1.SORLCUR_PROGRAM
                                                AND A.SORLCUR_LMOD_CODE = A1.SORLCUR_LMOD_CODE)
                 AND A.SORLCUR_PIDM = B.SGBSTDN_PIDM
                 AND A.SORLCUR_PROGRAM = B.SGBSTDN_PROGRAM_1
                 AND B.SGBSTDN_TERM_CODE_EFF IN (SELECT MAX (B1.SGBSTDN_TERM_CODE_EFF)
                                                   FROM SGBSTDN B1
                                                  WHERE B.SGBSTDN_PIDM = B1.SGBSTDN_PIDM
                                                        AND B.SGBSTDN_PROGRAM_1 = B1.SGBSTDN_PROGRAM_1)
                 AND E.SZTDTEC_PROGRAM = B.SGBSTDN_PROGRAM_1
                 AND A.SORLCUR_TERM_CODE_CTLG = E.SZTDTEC_TERM_CODE
                 AND D.SPRIDEN_PIDM = SGBSTDN_PIDM
                 AND D.SPRIDEN_CHANGE_IND IS NULL
                 )
        WHERE MATRICULA = P_ID
        AND PROGRAMA = P_PROGRAMA
        ORDER BY MATRICULA, KEY_SEQNO DESC, PERIODO
        )
  LOOP

    VL_ERROR:= 'EXITO';
    CONT:= CONT+1;

    DBMS_OUTPUT.PUT_LINE('ENTRA INICIO LOOP = '||P_ID);

    IF MINI_PERFIL.ESTATUS IN ('PR','MA','AS', 'RE') THEN --SI YA TIENE ALGÚN ESTATUS DE BAJA, NO PROCESAR

      BEGIN

        IF P_NVO_ESTATUS  IN ( 'BD', 'BT', 'BI', 'CM', 'CV') THEN

          --DBMS_OUTPUT.PUT_LINE('REZA 2 = '||P_NVO_ESTATUS);

          IF P_NVO_ESTATUS <> MINI_PERFIL.ESTATUS THEN

            --DBMS_OUTPUT.PUT_LINE('REZA 3 = '||P_NVO_ESTATUS);

            VC_PERIODO :=NULL;
            VC_PTRM_CODE := NULL;

            BEGIN
              SELECT DISTINCT A.SFRSTCR_TERM_CODE, A.SFRSTCR_PTRM_CODE, SSBSECT_PTRM_END_DATE
                INTO VC_PERIODO, VC_PTRM_CODE, VD_FECHA_FIN
                FROM SSBSECT, SFRSTCR A
               WHERE SSBSECT_TERM_CODE = A.SFRSTCR_TERM_CODE
                     AND SSBSECT_CRN    = A.SFRSTCR_CRN
                     AND SSBSECT_PTRM_CODE= A.SFRSTCR_PTRM_CODE
                     AND A.SFRSTCR_STSP_KEY_SEQUENCE = MINI_PERFIL.KEY_SEQNO
                     AND A.SFRSTCR_PIDM= MINI_PERFIL.PIDM
                     AND  TRUNC(SSBSECT_PTRM_START_DATE) = MINI_PERFIL.FECHA_INICIO
                     AND SUBSTR (SFRSTCR_TERM_CODE,5,1) !='8'
                     AND A.SFRSTCR_PTRM_CODE <> 'SS1'
                     AND SFRSTCR_TERM_CODE = (SELECT MAX(SFRSTCR_TERM_CODE)
                                                FROM SSBSECT A1, SFRSTCR A1
                                               WHERE     A1.SSBSECT_TERM_CODE = A1.SFRSTCR_TERM_CODE
                                                     AND A1.SSBSECT_CRN    = A1.SFRSTCR_CRN
                                                     AND A1.SSBSECT_PTRM_CODE= A1.SFRSTCR_PTRM_CODE
                                                     AND A1.SFRSTCR_STSP_KEY_SEQUENCE = A.SFRSTCR_STSP_KEY_SEQUENCE
                                                     AND A1.SFRSTCR_PIDM = A.SFRSTCR_PIDM
                                                     AND TRUNC(A1.SSBSECT_PTRM_START_DATE) = MINI_PERFIL.FECHA_INICIO
                                                     AND SUBSTR (A1.SFRSTCR_TERM_CODE,5,1) !='8'
                                                     AND A1.SFRSTCR_PTRM_CODE <> 'SS1');
            EXCEPTION
            WHEN NO_DATA_FOUND THEN
                VC_ERR := SQLERRM;
                VC_PERIODO :=NULL;
                VC_PTRM_CODE :=NULL;
                VL_ERROR:='Error al buscar parte de periodo1:'||SQLERRM;
            WHEN OTHERS THEN
                VC_ERR := SQLERRM;
                VC_PERIODO :=NULL;
                VC_PTRM_CODE :=NULL;
                VL_ERROR:='Error al buscar parte de periodo2:'||SQLERRM;
            END;

            --DBMS_OUTPUT.PUT_LINE('REZA 4 = '||VC_ERR);

            IF VC_PERIODO IS NOT NULL AND VC_PTRM_CODE IS NOT NULL THEN

              IF NVL(VC_PERIODO ,MINI_PERFIL.PERIODO) <= MINI_PERFIL.PERIODO THEN
                  VN_INSERTA := 0;
                  VC_PERIODO := MINI_PERFIL.PERIODO;
              ELSIF NVL(VC_PERIODO ,MINI_PERFIL.PERIODO) > MINI_PERFIL.PERIODO THEN
                 VN_INSERTA := 1;
              END IF;

              BEGIN
                SELECT COUNT(*)
                  INTO VC_EN_RANGO
                  FROM SFRRSTS
                 WHERE     SFRRSTS_RSTS_CODE = 'BD'
                       AND SFRRSTS_TERM_CODE  = VC_PERIODO
                       AND SFRRSTS_PTRM_CODE  = VC_PTRM_CODE
                       AND TRUNC(P_FECHA_BAJA) BETWEEN TRUNC(SFRRSTS_START_DATE) AND TRUNC(SFRRSTS_END_DATE) ;

              END;

              IF  VC_EN_RANGO > 0 THEN

                MATERIAS_AB( P_PIDM        => MINI_PERFIL.PIDM,
                             P_PERIODO     => VC_PERIODO,
                             P_CODE_NEW    => CASE P_NVO_ESTATUS WHEN 'BI' THEN 'BD' ELSE 'DD' END,
                             P_CODE_HOLD   => NULL,--'RE',
                             P_KEY_SEQNO   => MINI_PERFIL.KEY_SEQNO);

                ESTATUS_RAZON ( P_PIDM            => MINI_PERFIL.PIDM,
                                P_PERIODO         => VC_PERIODO,
                                P_ESTS_CODE_NEW   => 'NE',
                                P_KEY_SEQNO       => MINI_PERFIL.KEY_SEQNO);

                FOR I IN 1..2 LOOP

                  FOR C IN (

                    SELECT SORLCUR_PIDM,
                           SORLCUR_SEQNO,
                           SORLCUR_LMOD_CODE,
                           SORLCUR_KEY_SEQNO,
                           SORLCUR_PRIORITY_NO,
                           SORLCUR_ROLL_IND,
                           SORLCUR_DATA_ORIGIN,
                           SORLCUR_LEVL_CODE,
                           SORLCUR_COLL_CODE,
                           SORLCUR_DEGC_CODE,
                           SORLCUR_TERM_CODE_CTLG,
                           SORLCUR_TERM_CODE_END,
                           SORLCUR_TERM_CODE_MATRIC,
                           SORLCUR_TERM_CODE_ADMIT,
                           SORLCUR_ADMT_CODE,
                           SORLCUR_CAMP_CODE,
                           SORLCUR_PROGRAM,
                           SORLCUR_START_DATE,
                           SORLCUR_END_DATE,
                           SORLCUR_CURR_RULE
                      FROM SORLCUR S
                     WHERE     SORLCUR_PIDM = MINI_PERFIL.PIDM
                           AND SORLCUR_PROGRAM = MINI_PERFIL.PROGRAMA
                           AND SORLCUR_LMOD_CODE = 'LEARNER'
                           AND SORLCUR_CACT_CODE = 'ACTIVE'
                           AND SORLCUR_SEQNO = MINI_PERFIL.SEQNO

                  ) LOOP
                    BEGIN
                      SELECT NVL(MAX(SORLCUR_SEQNO),0) +1 INTO CONSE_SORLCUR
                        FROM SORLCUR
                       WHERE SORLCUR_PIDM= C.SORLCUR_PIDM;
                    END;

                    IF I=1 THEN CDE:=NULL;
                              INSERT INTO SORLCUR VALUES(
                              C.SORLCUR_PIDM,  CONSE_SORLCUR, C.SORLCUR_LMOD_CODE, VC_PERIODO, C.SORLCUR_KEY_SEQNO
                            , C.SORLCUR_PRIORITY_NO, 'N'/*c.sorlcur_roll_ind*/, 'INACTIVE', USER, USER
                            , SYSDATE, C.SORLCUR_LEVL_CODE, C.SORLCUR_COLL_CODE, C.SORLCUR_DEGC_CODE, C.SORLCUR_TERM_CODE_CTLG
                            , VC_PERIODO,  C.SORLCUR_TERM_CODE_MATRIC, C.SORLCUR_TERM_CODE_ADMIT, C.SORLCUR_ADMT_CODE, C.SORLCUR_CAMP_CODE
                            , C.SORLCUR_PROGRAM, C.SORLCUR_START_DATE, C.SORLCUR_END_DATE, C.SORLCUR_CURR_RULE, NULL
                            , NULL, NULL, NULL, NULL, NULL
                            , NULL, NULL, NULL, NULL, NULL
                            , NULL, USER, SYSDATE, NULL, CDE
                            , NULL, NULL, NULL);
                    ELSE CDE:='Y';
                              INSERT INTO SORLCUR VALUES(
                              C.SORLCUR_PIDM,  CONSE_SORLCUR, C.SORLCUR_LMOD_CODE,VC_PERIODO, C.SORLCUR_KEY_SEQNO
                            , C.SORLCUR_PRIORITY_NO, 'N'/*c.sorlcur_roll_ind*/, 'INACTIVE', USER, USER
                            , SYSDATE, C.SORLCUR_LEVL_CODE,C.SORLCUR_COLL_CODE, C.SORLCUR_DEGC_CODE, C.SORLCUR_TERM_CODE_CTLG
                            , VC_PERIODO ,  C.SORLCUR_TERM_CODE_MATRIC, C.SORLCUR_TERM_CODE_ADMIT, C.SORLCUR_ADMT_CODE, C.SORLCUR_CAMP_CODE
                            , C.SORLCUR_PROGRAM,C.SORLCUR_START_DATE, C.SORLCUR_END_DATE, C.SORLCUR_CURR_RULE, NULL
                            , NULL, NULL, NULL, NULL, NULL
                            , NULL, NULL, NULL, NULL, NULL
                            , NULL, USER, SYSDATE, NULL, CDE
                            , NULL, NULL, NULL);

                    END IF;

                    FOR W IN (

                    SELECT SORLFOS_PIDM,
                           SORLFOS_LCUR_SEQNO,
                           SORLFOS_SEQNO,
                           SORLFOS_LFST_CODE,
                           SORLFOS_PRIORITY_NO,
                           SORLFOS_DATA_ORIGIN,
                           SORLFOS_USER_ID,
                           SORLFOS_MAJR_CODE,
                           SORLFOS_TERM_CODE_CTLG,
                           SORLFOS_MAJR_CODE_ATTACH,
                           SORLFOS_LFOS_RULE,
                           SORLFOS_CONC_ATTACH_RULE,
                           SORLFOS_CURRENT_CDE
                      FROM SORLFOS
                     WHERE     SORLFOS_PIDM=C.SORLCUR_PIDM
                           AND SORLFOS_LCUR_SEQNO=C.SORLCUR_SEQNO
                     ORDER BY SORLFOS_SEQNO

                    ) LOOP

                        IF I=1 THEN
                          INSERT INTO SORLFOS VALUES(
                           W.SORLFOS_PIDM, CONSE_SORLCUR, W.SORLFOS_SEQNO, W.SORLFOS_LFST_CODE, VC_PERIODO
                         , W.SORLFOS_PRIORITY_NO, 'CHANGED', 'INACTIVE', USER/*w.sorlfos_data_origin*/, USER
                         , SYSDATE,W.SORLFOS_MAJR_CODE, W.SORLFOS_TERM_CODE_CTLG, VC_PERIODO, NULL
                         , W.SORLFOS_MAJR_CODE_ATTACH, W.SORLFOS_LFOS_RULE, W.SORLFOS_CONC_ATTACH_RULE, NULL, NULL
                         , NULL, NULL, USER, SYSDATE, CDE
                         , NULL, NULL, NULL);
                        ELSE
                          INSERT INTO SORLFOS VALUES(
                           W.SORLFOS_PIDM, CONSE_SORLCUR, W.SORLFOS_SEQNO, W.SORLFOS_LFST_CODE, VC_PERIODO
                        ,  W.SORLFOS_PRIORITY_NO, 'INACTIVE', 'INACTIVE', USER/*w.sorlfos_data_origin*/, USER
                        , SYSDATE,W.SORLFOS_MAJR_CODE, W.SORLFOS_TERM_CODE_CTLG, VC_PERIODO, NULL
                        , W.SORLFOS_MAJR_CODE_ATTACH, W.SORLFOS_LFOS_RULE, W.SORLFOS_CONC_ATTACH_RULE, NULL, NULL
                        , NULL, NULL, USER, SYSDATE, CDE
                        , NULL, NULL, NULL);
                        END IF;

                    END LOOP;

                  END LOOP;

                END LOOP;

                UPDATE SORLCUR SET SORLCUR_CACT_CODE='INACTIVE' ,  SORLCUR_ROLL_IND = 'N',
                       SORLCUR_TERM_CODE_END = VC_PERIODO,
                       SORLCUR_DATA_ORIGIN = USER,
                       SORLCUR_ACTIVITY_DATE = SYSDATE,
                       SORLCUR_ACTIVITY_DATE_UPDATE = SYSDATE,
                       SORLCUR_USER_ID = USER
                 WHERE      SORLCUR_PIDM=MINI_PERFIL.PIDM
                        AND SORLCUR_PROGRAM=MINI_PERFIL.PROGRAMA
                        AND SORLCUR_LMOD_CODE='LEARNER'
                        AND SORLCUR_CACT_CODE='ACTIVE'
                        AND SORLCUR_ROLL_IND = 'Y'
                        AND SORLCUR_SEQNO = MINI_PERFIL.SEQNO;

                IF VN_INSERTA = 1 THEN

                  BITACORA (P_PIDM        => MINI_PERFIL.PIDM ,
                            P_PERIODO     => MINI_PERFIL.PERIODO ,
                            P_FECHA       => MINI_PERFIL.FECHA_INICIO,
                            P_KEY_SEQNO   => MINI_PERFIL.KEY_SEQNO,
                            P_MOTIVO_BAJA =>P_MOTIVO_BAJA);

                  INSERT INTO SGBSTDN (
                        SGBSTDN_PIDM               , SGBSTDN_TERM_CODE_EFF       , SGBSTDN_LEVL_CODE   , SGBSTDN_STYP_CODE     , SGBSTDN_TERM_CODE_MATRIC
                            , SGBSTDN_TERM_CODE_ADMIT    , SGBSTDN_CAMP_CODE           , SGBSTDN_RESD_CODE   , SGBSTDN_COLL_CODE_1   , SGBSTDN_DEGC_CODE_1
                            , SGBSTDN_MAJR_CODE_1        , SGBSTDN_MAJR_CODE_CONC_1    , SGBSTDN_RATE_CODE   , SGBSTDN_ADMT_CODE     , SGBSTDN_PRIM_ROLL_IND
                            , SGBSTDN_PROGRAM_1          , SGBSTDN_TERM_CODE_CTLG_1    , SGBSTDN_CURR_RULE_1 , SGBSTDN_CMJR_RULE_1_1 , SGBSTDN_CCON_RULE_11_1
                            , SGBSTDN_DATA_ORIGIN        , SGBSTDN_STST_CODE           , SGBSTDN_ACTIVITY_DATE,SGBSTDN_SURROGATE_ID  ,SGBSTDN_VERSION
                            , SGBSTDN_USER_ID)
                     SELECT SGBSTDN_PIDM, VC_PERIODO         , SGBSTDN_LEVL_CODE   , 'D'     , SGBSTDN_TERM_CODE_MATRIC
                            , SGBSTDN_TERM_CODE_ADMIT    , SGBSTDN_CAMP_CODE           , SGBSTDN_RESD_CODE   , SGBSTDN_COLL_CODE_1   , SGBSTDN_DEGC_CODE_1
                            , SGBSTDN_MAJR_CODE_1        , SGBSTDN_MAJR_CODE_CONC_1    , SGBSTDN_RATE_CODE   , SGBSTDN_ADMT_CODE     , SGBSTDN_PRIM_ROLL_IND
                            , SGBSTDN_PROGRAM_1          , SGBSTDN_TERM_CODE_CTLG_1    , SGBSTDN_CURR_RULE_1 , SGBSTDN_CMJR_RULE_1_1 , SGBSTDN_CCON_RULE_11_1
                            , USER                          , P_NVO_ESTATUS/*CONTROL.CAMBIAR_ESTATUS*/    , SYSDATE , SGBSTDN_SURROGATE_ID  ,SGBSTDN_VERSION
                            , USER
                     FROM SGBSTDN
                     WHERE SGBSTDN_PIDM = MINI_PERFIL.PIDM
                     AND SGBSTDN_TERM_CODE_EFF = MINI_PERFIL.PERIODO
                     AND SGBSTDN_PROGRAM_1=MINI_PERFIL.PROGRAMA;

                END IF;

                IF VN_INSERTA = 0 THEN

                   BITACORA (P_PIDM  => MINI_PERFIL.PIDM ,
                             P_PERIODO  => MINI_PERFIL.PERIODO ,
                             P_FECHA    => MINI_PERFIL.FECHA_INICIO,
                             P_KEY_SEQNO=> MINI_PERFIL.KEY_SEQNO,
                             P_MOTIVO_BAJA =>P_MOTIVO_BAJA);

                  UPDATE SGBSTDN
                     SET SGBSTDN_STST_CODE = P_NVO_ESTATUS,
                         SGBSTDN_ACTIVITY_DATE = SYSDATE,
                         SGBSTDN_STYP_CODE ='D'
                     WHERE SGBSTDN_PIDM=MINI_PERFIL.PIDM
                     AND SGBSTDN_PROGRAM_1=MINI_PERFIL.PROGRAMA
                     AND SGBSTDN_TERM_CODE_EFF=MINI_PERFIL.PERIODO;

                END IF;

                          --Se inactiva ALumno
                UPDATE GOZTPAC
                   SET GOZTPAC_STAT_IND = '2',
                       GOZTPAC_PIN_DISABLED_IND = 'Y'
                 WHERE GOZTPAC_PIDM = MINI_PERFIL.PIDM;--:GOBTPAC_PIDM;


               /*Se agrega la inhabilitacion del Study Path solo para BD y CV*/

                IF P_NVO_ESTATUS IN ( 'BD', 'CV') THEN
                   UPDATE SGRSTSP
                      SET SGRSTSP_STSP_CODE= 'IN'
                    WHERE SGRSTSP_PIDM    = MINI_PERFIL.PIDM
                    AND SGRSTSP_KEY_SEQNO = MINI_PERFIL.KEY_SEQNO;
                END IF;

                --DBMS_OUTPUT.PUT_LINE('cuantos ' ||MINI_PERFIL.PIDM ||'*'||TO_DATE(P_FECHA_BAJA,'dd/mm/yyyy') ||'*'|| TO_DATE(VD_FECHA_FIN,'dd/mm/yyyy'));

                VC_RETURN:= PKG_FINANZAS.F_BAJA_ECONOMICA ( PN_PIDM         =>MINI_PERFIL.PIDM,
                                                            PN_CAMPUS       =>MINI_PERFIL.CAMPUS,
                                                            PN_NIVEL        =>MINI_PERFIL.NIVEL,
                                                            PN_ESTATUS      =>P_NVO_ESTATUS,
                                                            PN_PROGRAMA     =>NULL,--MINI_PERFIL.PROGRAMA
                                                            PN_PERIODO      => VC_PERIODO,
                                                            PN_FECHA_BAJA   =>TO_DATE(P_FECHA_BAJA,'dd/mm/yyyy'),
                                                            PN_FECHA_INICIO =>TO_DATE(MINI_PERFIL.FECHA_INICIO,'dd/mm/yyyy'),
                                                            PN_FECHA_FIN    =>TO_DATE(VD_FECHA_FIN,'dd/mm/yyyy'),
                                                            PN_KEYSEQNO     => MINI_PERFIL.KEY_SEQNO);

                IF VC_RETURN = 'EXITO' THEN
                   COMMIT;
                ELSE
                   ROLLBACK;
                   VL_ERROR:= VC_RETURN;
                END IF;

              ELSE
               VL_ERROR:='Fecha fuera del rango para realizar Bajas. Validar fechas: SFRRSTS_START_DATE y SFRRSTS_END_DATE (SFARSTS)';
               ROLLBACK;
              END IF;

            END IF;
             --DBMS_OUTPUT.PUT_LINE('REZA_FINAL 1 = '||VL_ERROR);
             --- se duplica este flujo de datos para insertar el nuevo código de baja glovicx 23.11.23
             BEGIN

                  IF (SB_ENROLLMENT.F_EXISTS( MINI_PERFIL.PIDM,VC_PERIODO ) <> 'Y')  THEN
                       DBMS_OUTPUT.PUT_LINE('AQUI EN INSERT SFBETRM NEW PARAM 1.A'|| P_CODE_BAJA);

                    BEGIN    ----- SE AJUSTA EL CODIGO DE BAJA X EL QUE TRAE EL PARAMETRO GLOVICX 27.10.2023
                        INSERT
                          INTO SFBETRM (SFBETRM_TERM_CODE, SFBETRM_PIDM, SFBETRM_ESTS_CODE, SFBETRM_ESTS_DATE, SFBETRM_MHRS_OVER,
                                        SFBETRM_AR_IND,SFBETRM_ASSESSMENT_DATE,SFBETRM_ADD_DATE,SFBETRM_ACTIVITY_DATE,
                                        SFBETRM_RGRE_CODE,SFBETRM_TMST_CODE, SFBETRM_TMST_DATE, SFBETRM_TMST_MAINT_IND,
                                        SFBETRM_USER, SFBETRM_REFUND_DATE,SFBETRM_DATA_ORIGIN, SFBETRM_INITIAL_REG_DATE,
                                        SFBETRM_MIN_HRS, SFBETRM_MINH_SRCE_CDE, SFBETRM_MAXH_SRCE_CDE,SFBETRM_SURROGATE_ID,
                                        SFBETRM_VERSION, SFBETRM_USER_ID, SFBETRM_VPDI_CODE)
                        VALUES ( VC_PERIODO,
                                 MINI_PERFIL.PIDM,
                                 'NE',
                                 SYSDATE,
                                 999999.999,
                                 'N',
                                 NULL,
                                 SYSDATE,
                                 SYSDATE,
                                 P_CODE_BAJA,
                                 '',
                                 NULL,
                                 '',
                                 USER,
                                 NULL,
                                 USER,
                                 SYSDATE,
                                 0.000,
                                 'M',
                                 'M',
                                 NULL,
                                 NULL,
                                 NULL,
                                 NULL);
                    END;

                    BEGIN
                        INSERT
                          INTO SFRENSP (SFRENSP_TERM_CODE, SFRENSP_PIDM,SFRENSP_KEY_SEQNO, SFRENSP_ESTS_CODE, SFRENSP_ESTS_DATE,
                                        SFRENSP_ADD_DATE, SFRENSP_ACTIVITY_DATE,SFRENSP_USER, SFRENSP_DATA_ORIGIN,
                                        SFRENSP_SURROGATE_ID,SFRENSP_VERSION, SFRENSP_USER_ID, SFRENSP_VPDI_CODE)
                        VALUES (VC_PERIODO,
                                MINI_PERFIL.PIDM,
                                MINI_PERFIL.KEY_SEQNO,
                                'NE',
                                SYSDATE,
                                SYSDATE,
                                SYSDATE,
                                USER,
                                USER,
                                NULL,
                                NULL,
                                NULL,
                                NULL);
                    END;

                  ELSE

                    FOR TRM IN (

                                SELECT C.SFBETRM_ESTS_DATE, C.SFBETRM_ADD_DATE, C.SFBETRM_ESTS_CODE, C.SFBETRM_TERM_CODE
                                  FROM SFBETRM C
                                 WHERE     C.SFBETRM_PIDM = MINI_PERFIL.PIDM
                                       AND C.SFBETRM_TERM_CODE = VC_PERIODO

                    ) LOOP
                      BEGIN
                             DBMS_OUTPUT.PUT_LINE('AQUI EN UPDATE  SFBETRM NEW PARAM 1.A '|| P_CODE_BAJA);
                             ----- SE AGREGA EL NUEVO PARAMETRO AL UPDATE GLOVICX 27/10/2023
                        UPDATE SFBETRM
                           SET SFBETRM_ESTS_CODE = 'NE',
                               SFBETRM_RGRE_CODE = P_CODE_BAJA,
                               SFBETRM_ACTIVITY_DATE = SYSDATE,
                               SFBETRM_DATA_ORIGIN = USER,
                               SFBETRM_USER_ID = USER
                         WHERE     SFBETRM_PIDM = MINI_PERFIL.PIDM
                               AND SFBETRM_TERM_CODE = TRM.SFBETRM_TERM_CODE
                               AND SFBETRM_ESTS_CODE = TRM.SFBETRM_ESTS_CODE;
                      END;

                      BEGIN
                        SELECT COUNT (*)
                          INTO LV_EXISTE
                          FROM SFRENSP
                         WHERE     SFRENSP_PIDM = MINI_PERFIL.PIDM
                               AND SFRENSP_TERM_CODE = TRM.SFBETRM_TERM_CODE
                               AND SFRENSP_KEY_SEQNO = MINI_PERFIL.KEY_SEQNO;
                      END;

                      IF LV_EXISTE >= 1 THEN

                        BEGIN
                          UPDATE SFRENSP
                             SET SFRENSP_ESTS_CODE = 'NE',
                                 SFRENSP_ACTIVITY_DATE = SYSDATE,
                                 SFRENSP_DATA_ORIGIN = USER,
                                 SFRENSP_USER_ID = USER
                           WHERE     SFRENSP_PIDM = MINI_PERFIL.PIDM
                                 AND SFRENSP_TERM_CODE = TRM.SFBETRM_TERM_CODE
                                 AND SFRENSP_KEY_SEQNO = MINI_PERFIL.KEY_SEQNO;
                        EXCEPTION
                        WHEN OTHERS THEN
                          NULL;
                        END;

                      ELSIF LV_EXISTE = 0 THEN

                        BEGIN
                          INSERT
                            INTO SFRENSP
                          VALUES (  TRM.SFBETRM_TERM_CODE,
                                    MINI_PERFIL.PIDM,
                                    MINI_PERFIL.KEY_SEQNO,
                                    'NE'/*'EL'*/,
                                    TRM.SFBETRM_ESTS_DATE,--vd_ESTS_DATE,
                                    TRM.SFBETRM_ADD_DATE,--vd_ADD_DATE,
                                    SYSDATE,
                                    USER,--'MIGRA',
                                    USER,--'UTEL',
                                    NULL,
                                    NULL,
                                    USER,--'MIGRA',
                                    NULL);
                        END;

                      END IF;

                    END LOOP;

                  END IF;

                END;



          ELSE
           VL_ERROR:='El alumno ya esta con el estatus: '||P_NVO_ESTATUS;
           --DBMS_OUTPUT.PUT_LINE('REZA_FINAL 2 = '||VL_ERROR);
          END IF;

        ELSIF P_NVO_ESTATUS = 'BA' THEN    ------------------------------------------------------------------------------------------------------------------------------------------------------

          IF P_NVO_ESTATUS <> MINI_PERFIL.ESTATUS THEN
            --DBMS_OUTPUT.PUT_LINE('REZA 3 = '||P_NVO_ESTATUS);
            VC_PERIODO :=NULL;
            VC_PTRM_CODE := NULL;

            BEGIN
              SELECT DISTINCT A.SFRSTCR_TERM_CODE, A.SFRSTCR_PTRM_CODE, SSBSECT_PTRM_END_DATE
                INTO VC_PERIODO, VC_PTRM_CODE, VD_FECHA_FIN
                FROM SSBSECT, SFRSTCR A
               WHERE     SSBSECT_TERM_CODE = A.SFRSTCR_TERM_CODE
                     AND SSBSECT_CRN    = A.SFRSTCR_CRN
                     AND SSBSECT_PTRM_CODE= A.SFRSTCR_PTRM_CODE
                     AND A.SFRSTCR_STSP_KEY_SEQUENCE = MINI_PERFIL.KEY_SEQNO
                     AND A.SFRSTCR_PIDM= MINI_PERFIL.PIDM
                     AND TRUNC(SSBSECT_PTRM_START_DATE) = MINI_PERFIL.FECHA_INICIO
                     AND SUBSTR (SFRSTCR_TERM_CODE,5,1) !='8'
                     AND A.SFRSTCR_PTRM_CODE <> 'SS1'
                     AND SFRSTCR_TERM_CODE = (SELECT MAX(SFRSTCR_TERM_CODE)
                                                FROM SFRSTCR B
                                               WHERE     B.SFRSTCR_PIDM=A.SFRSTCR_PIDM
                                                     AND B.SFRSTCR_PTRM_CODE  = A.SFRSTCR_PTRM_CODE) ;
            EXCEPTION
            WHEN NO_DATA_FOUND THEN
                VC_ERR := SQLERRM;
                VC_PERIODO :=NULL;
                VC_PTRM_CODE :=NULL;
                VL_ERROR:='Error al buscar parte de periodo3:'||SQLERRM;
            WHEN OTHERS THEN
                VC_ERR := SQLERRM;
                VC_PERIODO :=NULL;
                VC_PTRM_CODE :=NULL;
                VL_ERROR:='Error al buscar parte de periodo4:'||SQLERRM;
            END;

            --DBMS_OUTPUT.PUT_LINE('REZA 4 = '||VC_ERR);

            IF VC_PERIODO IS NOT NULL AND VC_PTRM_CODE IS NOT NULL THEN

              IF NVL(VC_PERIODO ,MINI_PERFIL.PERIODO) <= MINI_PERFIL.PERIODO THEN
                  VN_INSERTA := 0;
                  VC_PERIODO := MINI_PERFIL.PERIODO;
              ELSIF NVL(VC_PERIODO ,MINI_PERFIL.PERIODO) > MINI_PERFIL.PERIODO THEN
                 VN_INSERTA := 1;
              END IF;

              BEGIN
                SELECT COUNT(*)
                  INTO VC_EN_RANGO
                  FROM SFRRSTS
                 WHERE     SFRRSTS_RSTS_CODE = 'DD'
                       AND SFRRSTS_TERM_CODE  = VC_PERIODO
                       AND SFRRSTS_PTRM_CODE  = VC_PTRM_CODE
                       AND TRUNC(P_FECHA_BAJA) BETWEEN TRUNC(SFRRSTS_START_DATE) AND TRUNC(SFRRSTS_END_DATE) ;
              END;

              IF  VC_EN_RANGO > 0 THEN

                BEGIN
                  FOR CAL IN (
                               SELECT COUNT(SFRSTCR_GRDE_CODE) CALIF, SFRSTCR_CRN,SFRSTCR_TERM_CODE
                                 FROM SSBSECT, SFRSTCR
                                WHERE     SSBSECT_TERM_CODE = SFRSTCR_TERM_CODE
                                      AND SSBSECT_CRN    = SFRSTCR_CRN
                                      AND SSBSECT_PTRM_CODE=SFRSTCR_PTRM_CODE
                                      AND SUBSTR (SFRSTCR_TERM_CODE, 5, 1) != '8'
                                      AND SFRSTCR_STSP_KEY_SEQUENCE = MINI_PERFIL.KEY_SEQNO
                                      AND SFRSTCR_PIDM= MINI_PERFIL.PIDM
                                      AND SFRSTCR_TERM_CODE = NVL(VC_PERIODO,SFRSTCR_TERM_CODE)
                                GROUP BY SFRSTCR_CRN,SFRSTCR_TERM_CODE
                  ) LOOP

                    IF CAL.CALIF = 0 THEN

                      BEGIN
                        UPDATE SFRSTCR
                           SET SFRSTCR_RSTS_CODE='DD',
                               SFRSTCR_ACTIVITY_DATE = SYSDATE,
                               SFRSTCR_USER_ID = USER,
                               SFRSTCR_BILL_HR  = 0,
                               SFRSTCR_CREDIT_HR = 0,
                               SFRSTCR_BILL_HR_HOLD = 0,
                               SFRSTCR_CREDIT_HR_HOLD = 0
                        WHERE     SFRSTCR_PIDM = MINI_PERFIL.PIDM
                              AND SFRSTCR_TERM_CODE = CAL.SFRSTCR_TERM_CODE
                              AND SFRSTCR_CRN = CAL.SFRSTCR_CRN
                              AND SFRSTCR_GRDE_CODE IS NULL;
                      END;

                      BEGIN
                        UPDATE SFRAREG
                           SET SFRAREG_RSTS_CODE= 'DD',
                               SFRAREG_ACTIVITY_DATE = SYSDATE,
                               SFRAREG_USER_ID = USER
                         WHERE     SFRAREG_PIDM = MINI_PERFIL.PIDM
                               AND SFRAREG_TERM_CODE = CAL.SFRSTCR_TERM_CODE
                               AND SFRAREG_CRN = CAL.SFRSTCR_CRN;
                      END;
                    END IF;

                    IF VC_PERIODO IS NULL THEN

                      ESTATUS_RAZON ( P_PIDM            => MINI_PERFIL.PIDM,--:MINI_PERFIL.PIDM,
                                      P_PERIODO         => CAL.SFRSTCR_TERM_CODE,
                                      P_ESTS_CODE_NEW   => 'NE',
                                      P_KEY_SEQNO       => MINI_PERFIL.KEY_SEQNO--:MINI_PERFIL.KEY_SEQNO
                         );

                    END IF;
                  END LOOP;
                END;

                BEGIN

                  IF (SB_ENROLLMENT.F_EXISTS( MINI_PERFIL.PIDM,VC_PERIODO ) <> 'Y')  THEN
                       DBMS_OUTPUT.PUT_LINE('AQUI EN INSERT SFBETRM NEW PARAM '|| P_CODE_BAJA);

                    BEGIN    ----- SE AJUSTA EL CODIGO DE BAJA X EL QUE TRAE EL PARAMETRO GLOVICX 27.10.2023
                        INSERT
                          INTO SFBETRM (SFBETRM_TERM_CODE, SFBETRM_PIDM, SFBETRM_ESTS_CODE, SFBETRM_ESTS_DATE, SFBETRM_MHRS_OVER,
                                        SFBETRM_AR_IND,SFBETRM_ASSESSMENT_DATE,SFBETRM_ADD_DATE,SFBETRM_ACTIVITY_DATE,
                                        SFBETRM_RGRE_CODE,SFBETRM_TMST_CODE, SFBETRM_TMST_DATE, SFBETRM_TMST_MAINT_IND,
                                        SFBETRM_USER, SFBETRM_REFUND_DATE,SFBETRM_DATA_ORIGIN, SFBETRM_INITIAL_REG_DATE,
                                        SFBETRM_MIN_HRS, SFBETRM_MINH_SRCE_CDE, SFBETRM_MAXH_SRCE_CDE,SFBETRM_SURROGATE_ID,
                                        SFBETRM_VERSION, SFBETRM_USER_ID, SFBETRM_VPDI_CODE)
                        VALUES ( VC_PERIODO,
                                 MINI_PERFIL.PIDM,
                                 'NE',
                                 SYSDATE,
                                 999999.999,
                                 'N',
                                 NULL,
                                 SYSDATE,
                                 SYSDATE,
                                 P_CODE_BAJA,
                                 '',
                                 NULL,
                                 '',
                                 USER,
                                 NULL,
                                 USER,
                                 SYSDATE,
                                 0.000,
                                 'M',
                                 'M',
                                 NULL,
                                 NULL,
                                 NULL,
                                 NULL);
                    END;

                    BEGIN
                        INSERT
                          INTO SFRENSP (SFRENSP_TERM_CODE, SFRENSP_PIDM,SFRENSP_KEY_SEQNO, SFRENSP_ESTS_CODE, SFRENSP_ESTS_DATE,
                                        SFRENSP_ADD_DATE, SFRENSP_ACTIVITY_DATE,SFRENSP_USER, SFRENSP_DATA_ORIGIN,
                                        SFRENSP_SURROGATE_ID,SFRENSP_VERSION, SFRENSP_USER_ID, SFRENSP_VPDI_CODE)
                        VALUES (VC_PERIODO,
                                MINI_PERFIL.PIDM,
                                MINI_PERFIL.KEY_SEQNO,
                                'NE',
                                SYSDATE,
                                SYSDATE,
                                SYSDATE,
                                USER,
                                USER,
                                NULL,
                                NULL,
                                NULL,
                                NULL);
                    END;

                  ELSE

                    FOR TRM IN (

                                SELECT C.SFBETRM_ESTS_DATE, C.SFBETRM_ADD_DATE, C.SFBETRM_ESTS_CODE, C.SFBETRM_TERM_CODE
                                  FROM SFBETRM C
                                 WHERE     C.SFBETRM_PIDM = MINI_PERFIL.PIDM
                                       AND C.SFBETRM_TERM_CODE = VC_PERIODO

                    ) LOOP
                      BEGIN
                             DBMS_OUTPUT.PUT_LINE('AQUI EN UPDATE  SFBETRM NEW PARAM '|| P_CODE_BAJA);
                             ----- SE AGREGA EL NUEVO PARAMETRO AL UPDATE GLOVICX 27/10/2023
                        UPDATE SFBETRM
                           SET SFBETRM_ESTS_CODE = 'NE',
                               SFBETRM_RGRE_CODE = P_CODE_BAJA,
                               SFBETRM_ACTIVITY_DATE = SYSDATE,
                               SFBETRM_DATA_ORIGIN = USER,
                               SFBETRM_USER_ID = USER
                         WHERE     SFBETRM_PIDM = MINI_PERFIL.PIDM
                               AND SFBETRM_TERM_CODE = TRM.SFBETRM_TERM_CODE
                               AND SFBETRM_ESTS_CODE = TRM.SFBETRM_ESTS_CODE;
                      END;

                      BEGIN
                        SELECT COUNT (*)
                          INTO LV_EXISTE
                          FROM SFRENSP
                         WHERE     SFRENSP_PIDM = MINI_PERFIL.PIDM
                               AND SFRENSP_TERM_CODE = TRM.SFBETRM_TERM_CODE
                               AND SFRENSP_KEY_SEQNO = MINI_PERFIL.KEY_SEQNO;
                      END;

                      IF LV_EXISTE >= 1 THEN

                        BEGIN
                          UPDATE SFRENSP
                             SET SFRENSP_ESTS_CODE = 'NE',
                                 SFRENSP_ACTIVITY_DATE = SYSDATE,
                                 SFRENSP_DATA_ORIGIN = USER,
                                 SFRENSP_USER_ID = USER
                           WHERE     SFRENSP_PIDM = MINI_PERFIL.PIDM
                                 AND SFRENSP_TERM_CODE = TRM.SFBETRM_TERM_CODE
                                 AND SFRENSP_KEY_SEQNO = MINI_PERFIL.KEY_SEQNO;
                        EXCEPTION
                        WHEN OTHERS THEN
                          NULL;
                        END;

                      ELSIF LV_EXISTE = 0 THEN

                        BEGIN
                          INSERT
                            INTO SFRENSP
                          VALUES (  TRM.SFBETRM_TERM_CODE,
                                    MINI_PERFIL.PIDM,
                                    MINI_PERFIL.KEY_SEQNO,
                                    'NE'/*'EL'*/,
                                    TRM.SFBETRM_ESTS_DATE,--vd_ESTS_DATE,
                                    TRM.SFBETRM_ADD_DATE,--vd_ADD_DATE,
                                    SYSDATE,
                                    USER,--'MIGRA',
                                    USER,--'UTEL',
                                    NULL,
                                    NULL,
                                    USER,--'MIGRA',
                                    NULL);
                        END;

                      END IF;

                    END LOOP;

                  END IF;

                END;

                FOR I IN 1..2 LOOP

                  FOR C IN (

                           SELECT SORLCUR_PIDM,
                                  SORLCUR_SEQNO,
                                  SORLCUR_LMOD_CODE,
                                  SORLCUR_KEY_SEQNO,
                                  SORLCUR_PRIORITY_NO,
                                  SORLCUR_ROLL_IND,
                                  SORLCUR_DATA_ORIGIN,
                                  SORLCUR_LEVL_CODE,
                                  SORLCUR_COLL_CODE,
                                  SORLCUR_DEGC_CODE,
                                  SORLCUR_TERM_CODE_CTLG,
                                  SORLCUR_TERM_CODE_END,
                                  SORLCUR_TERM_CODE_MATRIC,
                                  SORLCUR_TERM_CODE_ADMIT,
                                  SORLCUR_ADMT_CODE,
                                  SORLCUR_CAMP_CODE,
                                  SORLCUR_PROGRAM,
                                  SORLCUR_START_DATE,
                                  SORLCUR_END_DATE,
                                  SORLCUR_CURR_RULE
                             FROM SORLCUR S
                            WHERE     SORLCUR_PIDM=MINI_PERFIL.PIDM
                                  AND SORLCUR_PROGRAM = MINI_PERFIL.PROGRAMA
                                  AND SORLCUR_LMOD_CODE = 'LEARNER'
                                  AND SORLCUR_CACT_CODE = 'ACTIVE'
                                  AND SORLCUR_SEQNO = MINI_PERFIL.SEQNO

                  ) LOOP

                    BEGIN
                      SELECT NVL(MAX(SORLCUR_SEQNO),0) +1
                        INTO CONSE_SORLCUR
                        FROM SORLCUR
                       WHERE SORLCUR_PIDM= C.SORLCUR_PIDM;
                    END;

                    IF I=1 THEN
                      CDE:=NULL;
                              INSERT INTO SORLCUR VALUES(
                              C.SORLCUR_PIDM,  CONSE_SORLCUR, C.SORLCUR_LMOD_CODE, VC_PERIODO, C.SORLCUR_KEY_SEQNO
                            , C.SORLCUR_PRIORITY_NO, 'N'/*c.sorlcur_roll_ind*/, 'INACTIVE', USER, USER
                            , SYSDATE, C.SORLCUR_LEVL_CODE, C.SORLCUR_COLL_CODE, C.SORLCUR_DEGC_CODE, C.SORLCUR_TERM_CODE_CTLG
                            , VC_PERIODO,  C.SORLCUR_TERM_CODE_MATRIC, C.SORLCUR_TERM_CODE_ADMIT, C.SORLCUR_ADMT_CODE, C.SORLCUR_CAMP_CODE
                            , C.SORLCUR_PROGRAM, C.SORLCUR_START_DATE, C.SORLCUR_END_DATE, C.SORLCUR_CURR_RULE, NULL
                            , NULL, NULL, NULL, NULL, NULL
                            , NULL, NULL, NULL, NULL, NULL
                            , NULL, USER, SYSDATE, NULL, CDE
                            , NULL, NULL, NULL);
                    ELSE
                      CDE:='Y';
                              INSERT INTO SORLCUR VALUES(
                              C.SORLCUR_PIDM,  CONSE_SORLCUR, C.SORLCUR_LMOD_CODE,VC_PERIODO, C.SORLCUR_KEY_SEQNO
                            , C.SORLCUR_PRIORITY_NO, 'N'/*c.sorlcur_roll_ind*/, 'INACTIVE', USER, USER
                            , SYSDATE, C.SORLCUR_LEVL_CODE,C.SORLCUR_COLL_CODE, C.SORLCUR_DEGC_CODE, C.SORLCUR_TERM_CODE_CTLG
                            , VC_PERIODO ,  C.SORLCUR_TERM_CODE_MATRIC, C.SORLCUR_TERM_CODE_ADMIT, C.SORLCUR_ADMT_CODE, C.SORLCUR_CAMP_CODE
                            , C.SORLCUR_PROGRAM,C.SORLCUR_START_DATE, C.SORLCUR_END_DATE, C.SORLCUR_CURR_RULE, NULL
                            , NULL, NULL, NULL, NULL, NULL
                            , NULL, NULL, NULL, NULL, NULL
                            , NULL, USER, SYSDATE, NULL, CDE
                            , NULL, NULL, NULL);

                    END IF;

                    FOR W IN (

                          SELECT SORLFOS_PIDM,
                                 SORLFOS_LCUR_SEQNO,
                                 SORLFOS_SEQNO,
                                 SORLFOS_LFST_CODE,
                                 SORLFOS_PRIORITY_NO,
                                 SORLFOS_DATA_ORIGIN,
                                 SORLFOS_USER_ID,
                                 SORLFOS_MAJR_CODE,
                                 SORLFOS_TERM_CODE_CTLG,
                                 SORLFOS_MAJR_CODE_ATTACH,
                                 SORLFOS_LFOS_RULE,
                                 SORLFOS_CONC_ATTACH_RULE,
                                 SORLFOS_CURRENT_CDE
                            FROM SORLFOS
                           WHERE     SORLFOS_PIDM=C.SORLCUR_PIDM
                                 AND SORLFOS_LCUR_SEQNO=C.SORLCUR_SEQNO
                           ORDER BY SORLFOS_SEQNO

                    ) LOOP

                      IF I=1 THEN
                        INSERT INTO SORLFOS VALUES(
                         W.SORLFOS_PIDM, CONSE_SORLCUR, W.SORLFOS_SEQNO, W.SORLFOS_LFST_CODE, VC_PERIODO
                       , W.SORLFOS_PRIORITY_NO, 'CHANGED', 'INACTIVE', USER/*w.sorlfos_data_origin*/, USER
                       , SYSDATE,W.SORLFOS_MAJR_CODE, W.SORLFOS_TERM_CODE_CTLG, VC_PERIODO, NULL
                       , W.SORLFOS_MAJR_CODE_ATTACH, W.SORLFOS_LFOS_RULE, W.SORLFOS_CONC_ATTACH_RULE, NULL, NULL
                       , NULL, NULL, USER, SYSDATE, CDE
                       , NULL, NULL, NULL);
                      ELSE
                        INSERT INTO SORLFOS VALUES(
                         W.SORLFOS_PIDM, CONSE_SORLCUR, W.SORLFOS_SEQNO, W.SORLFOS_LFST_CODE, VC_PERIODO
                       , W.SORLFOS_PRIORITY_NO, 'INACTIVE', 'INACTIVE', USER/*w.sorlfos_data_origin*/, USER
                       , SYSDATE,W.SORLFOS_MAJR_CODE, W.SORLFOS_TERM_CODE_CTLG, VC_PERIODO, NULL
                       , W.SORLFOS_MAJR_CODE_ATTACH, W.SORLFOS_LFOS_RULE, W.SORLFOS_CONC_ATTACH_RULE, NULL, NULL
                       , NULL, NULL, USER, SYSDATE, CDE
                       , NULL, NULL, NULL);
                      END IF;

                    END LOOP;

                  END LOOP;

                END LOOP;

                BEGIN
                  UPDATE SORLCUR
                     SET SORLCUR_CACT_CODE = 'INACTIVE' ,
                         SORLCUR_ROLL_IND = 'N',
                         SORLCUR_TERM_CODE_END = VC_PERIODO,
                         SORLCUR_DATA_ORIGIN = USER,
                         SORLCUR_ACTIVITY_DATE = SYSDATE,
                         SORLCUR_ACTIVITY_DATE_UPDATE = SYSDATE,
                         SORLCUR_USER_ID = USER
                   WHERE     SORLCUR_PIDM=MINI_PERFIL.PIDM
                         AND SORLCUR_PROGRAM=MINI_PERFIL.PROGRAMA
                         AND SORLCUR_LMOD_CODE='LEARNER'
                         AND SORLCUR_CACT_CODE='ACTIVE'
                         AND SORLCUR_ROLL_IND = 'Y'
                         AND SORLCUR_SEQNO = MINI_PERFIL.SEQNO;
                END;

                IF VN_INSERTA = 1 THEN

                  BITACORA ( P_PIDM         => MINI_PERFIL.PIDM ,
                             P_PERIODO      => MINI_PERFIL.PERIODO ,
                             P_FECHA        => MINI_PERFIL.FECHA_INICIO,
                             P_KEY_SEQNO    => MINI_PERFIL.KEY_SEQNO,
                             P_MOTIVO_BAJA  => P_MOTIVO_BAJA);

                     INSERT
                       INTO SGBSTDN (
                              SGBSTDN_PIDM               , SGBSTDN_TERM_CODE_EFF       , SGBSTDN_LEVL_CODE   , SGBSTDN_STYP_CODE     , SGBSTDN_TERM_CODE_MATRIC
                            , SGBSTDN_TERM_CODE_ADMIT    , SGBSTDN_CAMP_CODE           , SGBSTDN_RESD_CODE   , SGBSTDN_COLL_CODE_1   , SGBSTDN_DEGC_CODE_1
                            , SGBSTDN_MAJR_CODE_1        , SGBSTDN_MAJR_CODE_CONC_1    , SGBSTDN_RATE_CODE   , SGBSTDN_ADMT_CODE     , SGBSTDN_PRIM_ROLL_IND
                            , SGBSTDN_PROGRAM_1          , SGBSTDN_TERM_CODE_CTLG_1    , SGBSTDN_CURR_RULE_1 , SGBSTDN_CMJR_RULE_1_1 , SGBSTDN_CCON_RULE_11_1
                            , SGBSTDN_DATA_ORIGIN        , SGBSTDN_STST_CODE           , SGBSTDN_ACTIVITY_DATE,SGBSTDN_SURROGATE_ID  ,SGBSTDN_VERSION
                            , SGBSTDN_USER_ID)
                     SELECT
                              SGBSTDN_PIDM               , VC_PERIODO                  , SGBSTDN_LEVL_CODE   , SGBSTDN_STYP_CODE     , SGBSTDN_TERM_CODE_MATRIC
                            , SGBSTDN_TERM_CODE_ADMIT    , SGBSTDN_CAMP_CODE           , SGBSTDN_RESD_CODE   , SGBSTDN_COLL_CODE_1   , SGBSTDN_DEGC_CODE_1
                            , SGBSTDN_MAJR_CODE_1        , SGBSTDN_MAJR_CODE_CONC_1    , SGBSTDN_RATE_CODE   , SGBSTDN_ADMT_CODE     , SGBSTDN_PRIM_ROLL_IND
                            , SGBSTDN_PROGRAM_1          , SGBSTDN_TERM_CODE_CTLG_1    , SGBSTDN_CURR_RULE_1 , SGBSTDN_CMJR_RULE_1_1 , SGBSTDN_CCON_RULE_11_1
                            , USER                         , 'BT'/*CONTROL.CAMBIAR_ESTATUS*/    , SYSDATE , SGBSTDN_SURROGATE_ID  ,SGBSTDN_VERSION
                            , USER
                      FROM SGBSTDN
                     WHERE     SGBSTDN_PIDM = MINI_PERFIL.PIDM
                           AND SGBSTDN_TERM_CODE_EFF = MINI_PERFIL.PERIODO
                           AND SGBSTDN_PROGRAM_1=MINI_PERFIL.PROGRAMA;

                END IF;

                IF VN_INSERTA = 0 THEN

                   BITACORA (P_PIDM         => MINI_PERFIL.PIDM ,
                             P_PERIODO      => MINI_PERFIL.PERIODO ,
                             P_FECHA        => MINI_PERFIL.FECHA_INICIO,
                             P_KEY_SEQNO    => MINI_PERFIL.KEY_SEQNO,
                             P_MOTIVO_BAJA  =>P_MOTIVO_BAJA);

                  BEGIN
                    UPDATE SGBSTDN
                       SET SGBSTDN_STST_CODE= 'BT',
                           SGBSTDN_ACTIVITY_DATE = SYSDATE,
                           SGBSTDN_STYP_CODE = 'D'
                     WHERE     SGBSTDN_PIDM=MINI_PERFIL.PIDM
                           AND SGBSTDN_PROGRAM_1=MINI_PERFIL.PROGRAMA
                           AND SGBSTDN_TERM_CODE_EFF=MINI_PERFIL.PERIODO;
                  END;

                END IF;

                BEGIN
                  UPDATE GOZTPAC
                     SET GOZTPAC_STAT_IND = '2',
                         GOZTPAC_PIN_DISABLED_IND = 'Y'
                   WHERE GOZTPAC_PIDM = MINI_PERFIL.PIDM;
                END;

                IF P_NVO_ESTATUS IN ( 'BD', 'CV') THEN
                  UPDATE SGRSTSP
                     SET SGRSTSP_STSP_CODE= 'IN'
                   WHERE     SGRSTSP_PIDM    = MINI_PERFIL.PIDM
                         AND SGRSTSP_KEY_SEQNO = MINI_PERFIL.KEY_SEQNO;
                END IF;

               DBMS_OUTPUT.PUT_LINE('cuantos ' ||MINI_PERFIL.PIDM ||'*'||TO_DATE(P_FECHA_BAJA,'dd/mm/yyyy') ||'*'|| TO_DATE(VD_FECHA_FIN,'dd/mm/yyyy'));
---GOG 24012023
        BEGIN
            UPDATE TZFACCE SET TZFACCE_FLAG = 1
            WHERE TZFACCE_PIDM =MINI_PERFIL.PIDM
            AND TZFACCE_FLAG = 0;
            COMMIT;
            END;


            BEGIN
            UPDATE TZTPADI SET TZTPADI_FLAG = 1, TZTPADI_ACTIVITY_DATE =SYSDATE
            WHERE TZTPADI_PIDM =MINI_PERFIL.PIDM
            AND TZTPADI_FLAG = 0;
            COMMIT;
            END;
----
                VC_RETURN:= PKG_FINANZAS.F_BAJA_ECONOMICA ( PN_PIDM             =>MINI_PERFIL.PIDM,
                                                            PN_CAMPUS           =>MINI_PERFIL.CAMPUS,
                                                            PN_NIVEL            =>MINI_PERFIL.NIVEL,
                                                            PN_ESTATUS          =>'BA',
                                                            PN_PROGRAMA         =>NULL,--MINI_PERFIL.PROGRAMA
                                                            PN_PERIODO          =>VC_PERIODO,
                                                            PN_FECHA_BAJA       =>TO_DATE(P_FECHA_BAJA,'dd/mm/yyyy'),
                                                            PN_FECHA_INICIO     =>TO_DATE(MINI_PERFIL.FECHA_INICIO,'dd/mm/yyyy'),
                                                            PN_FECHA_FIN        =>TO_DATE(VD_FECHA_FIN,'dd/mm/yyyy'),
                                                            PN_KEYSEQNO         => MINI_PERFIL.KEY_SEQNO);

                IF VC_RETURN = 'EXITO' THEN
                   COMMIT;
                ELSE
                   ROLLBACK;
                   VL_ERROR:= VC_RETURN;
                END IF;

              ELSE
                 VL_ERROR:='Fecha fuera del rango para realizar Bajas. Validar fechas: SFRRSTS_START_DATE y SFRRSTS_END_DATE (SFARSTS)';
                 ROLLBACK;
              END IF;

            END IF;

            --DBMS_OUTPUT.PUT_LINE('REZA_FINAL 1 = '||VL_ERROR);

          ELSE
            VL_ERROR:='El alumno ya esta con el estatus: '||P_NVO_ESTATUS;

            --DBMS_OUTPUT.PUT_LINE('REZA_FINAL 2 = '||VL_ERROR);

          END IF;

        ELSE

          VL_ERROR:='Solo se permiten estatus tipo Baja. Estatus no válido: '||P_NVO_ESTATUS;

           --DBMS_OUTPUT.PUT_LINE('REZA_FINAL 3 = '||VL_ERROR);

        END IF;

        --DBMS_OUTPUT.PUT_LINE('REZA_FINAL 4 = '||VL_ERROR);

      EXCEPTION
      WHEN OTHERS THEN
      ROLLBACK;
      VC_ERR := SQLERRM;
      VL_ERROR:='ERROR: '||VC_ERR;
      END;

    ELSE
    VL_ERROR:='Estatus no válido. Solo se permiten estatus AS,PR y MA, para realizar una baja';
    END IF;
  END LOOP;

  IF VL_ERROR ='EXITO' THEN

    BEGIN
      SELECT SPRIDEN_PIDM
        INTO L_PIDM
        FROM SPRIDEN
       WHERE     SPRIDEN_CHANGE_IND IS NULL
             AND SPRIDEN_ID = P_ID;
    EXCEPTION WHEN OTHERS THEN
    NULL;
    END;

    L_RETORNA_AULA:=BANINST1.PKG_JORNADAS_ABCC.F_BAJA_ABCC ( P_NVO_ESTATUS, L_PIDM);

  END IF;

  IF CONT = 0 THEN

   VL_ERROR:=VL_ERROR||'. No se encuentra el registro con estos datos. Validar matricula activa, Jornada (SGASADD), ...';

  END IF;

 COMMIT;

 RETURN VL_ERROR;

END F_BAJA_ACADEMICA;

PROCEDURE ESTATUS_RAZON (P_PIDM VARCHAR2,
                         P_PERIODO VARCHAR2,
                         P_ESTS_CODE_NEW VARCHAR2,
                         P_KEY_SEQNO  VARCHAR2
                         )IS

  LV_EXISTE NUMBER;

BEGIN
  IF (SB_ENROLLMENT.F_EXISTS( P_PIDM,P_PERIODO )<>'Y')  THEN

    BEGIN
      INSERT
        INTO SFBETRM
            (SFBETRM_TERM_CODE,
             SFBETRM_PIDM,
             SFBETRM_ESTS_CODE,
             SFBETRM_ESTS_DATE,
             SFBETRM_MHRS_OVER,
             SFBETRM_AR_IND,
             SFBETRM_ASSESSMENT_DATE,
             SFBETRM_ADD_DATE,
             SFBETRM_ACTIVITY_DATE,
             SFBETRM_RGRE_CODE,
             SFBETRM_TMST_CODE,
             SFBETRM_TMST_DATE,
             SFBETRM_TMST_MAINT_IND,
             SFBETRM_USER,
             SFBETRM_REFUND_DATE,
             SFBETRM_DATA_ORIGIN,
             SFBETRM_INITIAL_REG_DATE,
             SFBETRM_MIN_HRS,
             SFBETRM_MINH_SRCE_CDE,
             SFBETRM_MAXH_SRCE_CDE,
             SFBETRM_SURROGATE_ID,
             SFBETRM_VERSION,
             SFBETRM_USER_ID,
             SFBETRM_VPDI_CODE)
      VALUES (P_PERIODO,
              P_PIDM,
              P_ESTS_CODE_NEW,
              SYSDATE,
              999999.999,
              'N',
              NULL,
              SYSDATE,
              SYSDATE,
              DECODE (P_ESTS_CODE_NEW, 'EL', NULL, 'AC'),
              '',
              NULL,
              '',
              USER,
              NULL,
              USER,
              SYSDATE,
              0.000,
              'M',
              'M',
              NULL,
              NULL,
              NULL,
              NULL);
    END;

    BEGIN
      INSERT
        INTO SFRENSP
            (SFRENSP_TERM_CODE,
             SFRENSP_PIDM,
             SFRENSP_KEY_SEQNO,
             SFRENSP_ESTS_CODE,
             SFRENSP_ESTS_DATE,
             SFRENSP_ADD_DATE,
             SFRENSP_ACTIVITY_DATE,
             SFRENSP_USER,
             SFRENSP_DATA_ORIGIN,
             SFRENSP_SURROGATE_ID,
             SFRENSP_VERSION,
             SFRENSP_USER_ID,
             SFRENSP_VPDI_CODE)
      VALUES (P_PERIODO,
              P_PIDM,
              P_KEY_SEQNO,
              P_ESTS_CODE_NEW,
              SYSDATE,
              SYSDATE,
              SYSDATE,
              USER,
              USER,
              NULL,
              NULL,
              NULL,
              NULL);
    END;

  ELSE

    FOR TRM IN (
                SELECT C.SFBETRM_ESTS_DATE,
                       C.SFBETRM_ADD_DATE,
                       C.SFBETRM_ESTS_CODE,
                       C.SFBETRM_TERM_CODE
                  FROM SFBETRM C
                 WHERE     C.SFBETRM_PIDM = P_PIDM
                       AND C.SFBETRM_TERM_CODE = P_PERIODO
    ) LOOP
      BEGIN
        UPDATE SFBETRM
           SET SFBETRM_ESTS_CODE = P_ESTS_CODE_NEW,
               SFBETRM_RGRE_CODE = DECODE(P_ESTS_CODE_NEW,'EL',NULL,'AC'),
               SFBETRM_ACTIVITY_DATE = SYSDATE,
               SFBETRM_DATA_ORIGIN = USER,
               SFBETRM_USER_ID = USER
         WHERE     SFBETRM_PIDM = P_PIDM
               AND SFBETRM_TERM_CODE = TRM.SFBETRM_TERM_CODE
               AND SFBETRM_ESTS_CODE = TRM.SFBETRM_ESTS_CODE;
      END;

      BEGIN
        SELECT COUNT (*)
          INTO LV_EXISTE
          FROM SFRENSP
         WHERE     SFRENSP_PIDM = P_PIDM
               AND SFRENSP_TERM_CODE = TRM.SFBETRM_TERM_CODE
               AND SFRENSP_KEY_SEQNO = P_KEY_SEQNO;
      END;

      IF LV_EXISTE >= 1 THEN

        BEGIN
          UPDATE SFRENSP
             SET SFRENSP_ESTS_CODE = P_ESTS_CODE_NEW,
                 SFRENSP_ACTIVITY_DATE = SYSDATE,
                 SFRENSP_DATA_ORIGIN = USER,
                 SFRENSP_USER_ID = USER
           WHERE     SFRENSP_PIDM = P_PIDM
                 AND SFRENSP_TERM_CODE = TRM.SFBETRM_TERM_CODE
                 AND SFRENSP_KEY_SEQNO = P_KEY_SEQNO;
        EXCEPTION
        WHEN OTHERS THEN
          NULL;
        END;

      ELSIF LV_EXISTE = 0 THEN

        BEGIN
            INSERT
              INTO SFRENSP
           VALUES (TRM.SFBETRM_TERM_CODE,
                   P_PIDM,
                   P_KEY_SEQNO,
                   P_ESTS_CODE_NEW,
                   TRM.SFBETRM_ESTS_DATE,
                   TRM.SFBETRM_ADD_DATE,
                   SYSDATE,
                   USER,
                   USER,
                   NULL,
                   NULL,
                   USER,
                   NULL);
        END;

      END IF;
    END LOOP;
  END IF;
END ESTATUS_RAZON;

PROCEDURE MATERIAS_AB(  P_PIDM NUMBER,
                        P_PERIODO  VARCHAR2,
                        P_CODE_NEW VARCHAR2,
                        P_CODE_HOLD VARCHAR2,
                        P_KEY_SEQNO NUMBER
                       )IS
BEGIN

  for cal in (
                select count(SFRSTCR_GRDE_CODE) calif, sfrstcr_crn,SFRSTCR_TERM_CODE
                            from ssbsect, sfrstcr
                            where SSBSECT_TERM_CODE = SFRSTCR_TERM_CODE
                            and SSBSECT_CRN    = SFRSTCR_CRN
                            and SSBSECT_PTRM_CODE=SFRSTCR_PTRM_CODE
                            And substr (SFRSTCR_TERM_CODE, 5, 1) != '8'
                            and SFRSTCR_RSTS_CODE = NVL(P_CODE_HOLD,SFRSTCR_RSTS_CODE)--'DD'
                            and SFRSTCR_STSP_KEY_SEQUENCE = P_KEY_SEQNO--:MINI_PERFIL.KEY_SEQNO
                            and sfrstcr_pidm= P_PIDM--:MINI_PERFIL.PIDM
                            and SFRSTCR_TERM_CODE = NVL(P_PERIODO,SFRSTCR_TERM_CODE)
                            group by sfrstcr_crn,SFRSTCR_TERM_CODE
                            ) loop

               if cal.calif = 0 then

                    if P_CODE_NEW in ('BD', 'DD') then
                        update sfrstcr set sfrstcr_rsts_code=P_CODE_NEW,-- 'RE'
                                           SFRSTCR_ACTIVITY_DATE = SYSDATE,
                                           SFRSTCR_USER_ID = USER,
                                           SFRSTCR_BILL_HR  = 0,
                                           SFRSTCR_CREDIT_HR = 0,
                                           SFRSTCR_BILL_HR_HOLD = 0,
                                           SFRSTCR_CREDIT_HR_HOLD = 0,
                                           SFRSTCR_DATA_ORIGIN='FINANZAS'
                        where sfrstcr_pidm=P_PIDM
                        and sfrstcr_term_code= cal.SFRSTCR_TERM_CODE--P_PERIODO
                        and sfrstcr_crn = cal.sfrstcr_crn
                        AND SFRSTCR_GRDE_CODE IS NULL;
                        else

                                          update sfrstcr set sfrstcr_rsts_code=P_CODE_NEW,-- 'RE'
                                                             SFRSTCR_ACTIVITY_DATE = SYSDATE,
                                                             SFRSTCR_USER_ID = USER,
                                                             SFRSTCR_DATA_ORIGIN='FINANZAS'
                                          where sfrstcr_pidm=P_PIDM--:MINI_PERFIL.PIDM
                                          and sfrstcr_term_code= cal.SFRSTCR_TERM_CODE--P_PERIODO
                                          and sfrstcr_crn = cal.sfrstcr_crn
                                          AND SFRSTCR_GRDE_CODE IS NULL;
                    end if;

                    --cOD vIC
                    update sfrareg
                    set sfrareg_rsts_code= P_CODE_NEW,--'RE'
                    SFRAREG_ACTIVITY_DATE = SYSDATE,
                    SFRAREG_USER_ID = USER,
                    SFRAREG_DATA_ORIGIN ='FINANZAS'
                    where sfrareg_pidm=P_PIDM--:MINI_PERFIL.PIDM--c.pidm
                    and sfrareg_term_code= cal.SFRSTCR_TERM_CODE--P_PERIODO --c.term
                    and sfrareg_crn=cal.sfrstcr_crn;--c.crn;

               end if;

               IF P_PERIODO IS NULL THEN

                    ESTATUS_RAZON (
                    P_PIDM            => P_PIDM,--:MINI_PERFIL.PIDM,
                    P_PERIODO                  => cal.SFRSTCR_TERM_CODE,
                    P_ESTS_CODE_NEW   => CASE P_CODE_NEW WHEN 'DD' THEN 'NE' ELSE 'EL' END,
                    --P_ESTS_CODE_HOLD  => CASE P_CODE_HOLD WHEN 'RE' THEN 'EL' ELSE 'NE' END,
                    P_KEY_SEQNO       => P_KEY_SEQNO--:MINI_PERFIL.KEY_SEQNO
                    );

               END IF;

     end loop;

END MATERIAS_AB;

PROCEDURE BITACORA (P_PIDM NUMBER,
                  P_PERIODO VARCHAR2,
                  P_FECHA DATE,
                  P_KEY_SEQNO NUMBER,
                  P_MOTIVO_BAJA VARCHAR2) IS

  vn_sec_SGRSCMT number;

BEGIN

   SELECT NVL(MAX(SGRSCMT_SEQ_NO),0)+1
        INTO vn_sec_SGRSCMT
      FROM SGRSCMT
      WHERE SGRSCMT_PIDM  = P_PIDM--:MINI_PERFIL.PIDM
      AND SGRSCMT_TERM_CODE = P_PERIODO;--:MINI_PERFIL.PERIODO;

     INSERT INTO SGBSTDB
                   SELECT N.*,P_FECHA/*:MINI_PERFIL.FECHA_INICIO*/, vn_sec_SGRSCMT, P_KEY_SEQNO/* :MINI_PERFIL.KEY_SEQNO*/
                   FROM SGBSTDN N
                   WHERE N.SGBSTDN_PIDM = P_PIDM--:MINI_PERFIL.PIDM
                   AND N.SGBSTDN_TERM_CODE_EFF = P_PERIODO;--:MINI_PERFIL.PERIODO;



     INSERT INTO SGRSCMT (
        SGRSCMT_PIDM
    , SGRSCMT_SEQ_NO
    , SGRSCMT_TERM_CODE
    , SGRSCMT_COMMENT_TEXT
    , SGRSCMT_ACTIVITY_DATE
    , SGRSCMT_DATA_ORIGIN
     )
     VALUES (
        P_PIDM--:MINI_PERFIL.PIDM
      , vn_sec_SGRSCMT
      , P_PERIODO--:MINI_PERFIL.PERIODO
      , P_MOTIVO_BAJA --:SZCARBA_MOTIVO_BAJA--:CURRENT_TAB||': '||:CONTROL.MOTIVO_CAMBIO
      , SYSDATE
      , user
     );

END BITACORA;

/**
NUEVO PROCESO DE GENERACIONDE CARTERA APARTIR DE DESCUENTOS CONFIGURADOS
**/
PROCEDURE P_GEN_CART_CONF (       P_LLAMADA    VARCHAR2
                                , P_FECHA      DATE
                                , P_MATRICULA  VARCHAR2
                                , P_CAMPUS     VARCHAR2
                                , P_NIVEL      VARCHAR2
                                ) IS

/*  Actualizado: 24/11/2020
    Por JREZAOLI
*/

/******************************************************************************
   Marcas de cambio:
   No. 1
   Clave de cambio: 001-27062023-FND
   Autor: FND@Update
   Descripción: Llama a la funcion BANINST1.PKG_FINANZAS.F_UNICA_CARGO para
                generar cargos de materias de Proyecto Empresarial I y II
                (UNICA) para el campus 11 (UNI).
******************************************************************************/

    VL_SOLICITUD            NUMBER;
    VL_DIF_DSI              NUMBER;
    VL_EXISTE_MAT           NUMBER:=0;
    VL_EXISTE_CART          NUMBER:=0;
    VL_EXISTE_DESC          NUMBER:=0;
    VL_EXISTE_PPLAN         NUMBER:=0;
    VL_EXISTE_PARC          NUMBER:=0;
    VL_EXISTE_BITA          NUMBER:=0;
    VL_SECUENCIA            NUMBER:=0;
    VL_SECUENCIACOL         NUMBER :=0;
    VL_SECUENCIA_PADRE      NUMBER:=0;
    VL_CODIGO               VARCHAR2(6) := NULL;
    VL_CODIGO_AFEC          VARCHAR2(6) := NULL;
    VL_DESCRIPCION          VARCHAR2(50) :=NULL;
    VL_ERROR                VARCHAR2 (1000);
    VL_CADENAERROR          VARCHAR2 (1000);
    VL_ERROR1               VARCHAR2 (1000);
    VL_DIA                  VARCHAR2 (2);
    VL_MES                  VARCHAR2 (2);
    VL_ANO                  VARCHAR2 (4);
    VL_VENCIMIENTO          VARCHAR2 (10);
    VL_MONTO                NUMBER:=0;
    VL_MONTO_PERCENT        NUMBER:=0;
    VL_MONTO_AMOUNT         NUMBER:=0;
    VL_TRAN_NUM             NUMBER:=0;
    VL_NUM_PARC             NUMBER:=0;
    VL_COLEGIATURA          NUMBER:=0;
    VL_DESCUENTO            NUMBER:=0;
    VL_DESCUENTODSI         NUMBER:=0;
    VL_PLAN_PAGO            NUMBER:=0;
    VL_PARCIALIDAD          NUMBER:=0;
    VL_VUELTA               NUMBER:=0;
    VL_FECHA_PARC           DATE := NULL;
    VL_PLAN_BITA            NUMBER :=0;
    VL_SFRRGFE_RATE_CODE    VARCHAR2 (6);
    VD_FECHA_INICIO         DATE;
    AL_BUTTON               NUMBER;
    VC_JORNADA              VARCHAR2 (10);
    VN_PROPE                NUMBER;
    VN_EXISTE_DSP           NUMBER:=0;
    VN_AUMEN                NUMBER:=0;
    VN_PERIODOS             NUMBER:=0;
    VN_PORC_INCREM          NUMBER;
    VN_PERIODOS_CURSADOS    NUMBER;
    VN_TZDOCTR_COLEG_1      NUMBER (12,2);
    VN_TZDOCTR_DESC_1       NUMBER (12,2);
    VN_TZDOCTR_PPAGO_1      NUMBER (12,2);
    VN_TZDOCTR_PARCI_1      NUMBER (12,2);
    VN_NUM_PAGOS            NUMBER;
    VL_STUDY_PH             NUMBER;
    VL_CODIGO2              VARCHAR2(4);
    BANDERADSI              NUMBER;
    VDSI_CODE               VARCHAR2(8);
    VDSI_MTO                NUMBER;
    VDSI_DESCR              VARCHAR2(50);
    VDSI_STUDY              VARCHAR2(1);
    VL_ULT_COL              NUMBER;
    VL_NUMPAG               NUMBER;
    VL_CODIGO_AJ            VARCHAR2 (4);
    VL_COD_EXCLU            NUMBER;
    V_ENTRA                 NUMBER;
    VL_NUINGR_PLAN          NUMBER;
    VL_NEWPERIODO           VARCHAR2(11);
    LV_TRAN_NUM             NUMBER;
    VL_FECHA_FUTU_2         VARCHAR2(10);
    VL_PAGO_ANTERIOR        NUMBER;
    VL_ROLA_DSI             NUMBER;
    VL_SIN_ORDEN            VARCHAR2(60);
    VL_MIGRA                NUMBER;
    VL_MIGRA2               NUMBER;
    VL_SECUEN               NUMBER;
    VL_CODEXEMTION          VARCHAR2(10);
    VL_ENTDESC              NUMBER;
    VL_LPC                  VARCHAR2(5);
    VL_PROSPECTO            NUMBER;
    VL_ESCA                 NUMBER;
    VL_BIME                 VARCHAR2(500);
    VL_PAGOUNICO            VARCHAR2(500);
    VL_BECA_COLABO          VARCHAR2(500);
    VL_BESP                 VARCHAR2(500);
    VL_COL_NUEVO            NUMBER;
    VL_UTLX                 VARCHAR2(500);
/********************************************
*    MARCA DE CAMBIO: 001-20062022-FND.     *
********************************************/
    VL_UNICA                VARCHAR2(500);
/***********************************************
*    FIN MARCA DE CAMBIO: 001-20062022-FND.    *
***********************************************/
    VL_CART_UTL             VARCHAR2(900);
    VL_COMPLEMENTO          VARCHAR2(900);
    VL_RESP_PAGOCUATRI      VARCHAR2(900);
    VL_UPSE                 NUMBER;
    VL_CONDONACION_UTLX     VARCHAR2(900);
    VL_RESP_UPSELLING       VARCHAR2(900);
  --  VL_CONDONACION_UTLX     VARCHAR2(900);
    VL_ROLA_ACC             NUMBER;
    VL_INCR                 NUMBER;
    VL_PARC_ANTE            NUMBER;
    VL_RECURRENTE           VARCHAR2(900);
    VL_COMPLE_FILI          VARCHAR2(900);
    VL_COMPLE_INICIO        NUMBER;
    VL_NOAPL_COM            NUMBER;
    VL_ENTRA_DINA          NUMBER;
    VL_DINAMICOS            VARCHAR2(900);
    VL_MATRICULA            VARCHAR2(12):= P_MATRICULA;
    VL_FECHA                DATE:=P_FECHA;
    vl_colegiatura_uin      number;
    vl_PRE_ACTUALIZADO      varchar2(3);
    --- ******************************************
        --- Reduccion de Beca por TyC ---
    --- ******************************************

    vl_monto_tyc number:=0;
    vl_porcentaje_tyc varchar2(10):=null;

 BEGIN

    --------------- Valida el proceso de membreisia de Salud para no generar los cargos en estado de cuenta  ---------

    PKG_FINANZAS.alinea_mebresia_salud; commit;


   IF P_FECHA IS NOT NULL THEN
    VL_FECHA := P_FECHA;
    VL_MATRICULA:= P_MATRICULA;
    

    

         --DBMS_OUTPUT.PUT_LINE ('Antes For:'|| VL_ERROR);

     FOR ALUMNO IN (
                 SELECT DISTINCT
                        D.SPRIDEN_ID MATRICULA,
                        A.SORLCUR_PIDM PIDM,
                        A.SORLCUR_PROGRAM PROGRAMA,
                        E.SZTDTEC_PROGRAMA_COMP PROGRAMA_DESC,
                        B.SGBSTDN_STST_CODE ESTATUS,
                        B.SGBSTDN_STYP_CODE TIPO_ALUMNO,
                        B.SGBSTDN_CAMP_CODE CAMPUS,
                        B.SGBSTDN_LEVL_CODE NIVEL,
                        F.SFRSTCR_TERM_CODE PERIODO,
                        G.SSBSECT_PTRM_START_DATE FECHA_INICIO,
                        F.SFRSTCR_PTRM_CODE PARTE_PERIODO,
                        A.SORLCUR_KEY_SEQNO STUDY_PATH,
                        F.SFRSTCR_VPDI_CODE FOLIO,
                        CASE
                          SUBSTR (B.SGBSTDN_RATE_CODE, 1, 1)
                          WHEN  ('P') THEN SUBSTR (B.SGBSTDN_RATE_CODE, 2, 2)
                          WHEN  ('C') THEN SUBSTR (B.SGBSTDN_RATE_CODE, 2, 2)
                          WHEN  ('J') THEN SUBSTR (B.SGBSTDN_RATE_CODE, 3, 1)
                        END  NUM_PAGOS,
                        (DECODE (SUBSTR (B.SGBSTDN_RATE_CODE, 4, 1), 'A', 15, 'B', '30','C', '10')) VENCIMIENTO,
                        SUBSTR (B.SGBSTDN_RATE_CODE, 1, 1) TIPO_PAGO,
                        B.SGBSTDN_RATE_CODE RATE,
                        DECODE (E.SZTDTEC_PERIODICIDAD, 1, 'Bime', 2, 'Cuatri', 3, 'Semes', 4, 'Anual') PERIODICIDAD,
                        (SELECT DISTINCT (SORLCUR_SITE_CODE)
                           FROM SORLCUR CUR
                          WHERE     CUR.SORLCUR_PIDM = A.SORLCUR_PIDM
                                AND CUR.SORLCUR_LMOD_CODE = 'ADMISSIONS'
                                And cur.sorlcur_camp_code = p_campus
                                And cur.sorlcur_levl_code = p_nivel
                              --  And cur.SORLCUR_PROGRAM = a.SORLCUR_PROGRAM
                                AND CUR.SORLCUR_SEQNO = (SELECT MAX (SORLCUR_SEQNO)
                                                           FROM SORLCUR CUR2
                                                          WHERE     CUR2.SORLCUR_PIDM = CUR.SORLCUR_PIDM
                                                                AND CUR2.SORLCUR_LMOD_CODE = CUR.SORLCUR_LMOD_CODE
                                                                And cur2.SORLCUR_camp_code = cur.SORLCUR_camp_code
                                                                And cur2.SORLCUR_levl_code = cur.SORLCUR_levl_code
                                                                --And cur2.SORLCUR_PROGRAM = cur.SORLCUR_PROGRAM
                                                                 ))PRE_ACTUALIZADO,
                        DECODE (A.SORLCUR_DEGC_CODE, 'DIPL', 'COLEGIATURA DIPLOMADO', 'CURS', 'COLEGIATURA CURSO')DEGC_CODE,
                        (SELECT DISTINCT TZTCJOR_ATTS_CODE
                         FROM TZTCJOR R
                        WHERE     R.TZTCJOR_PIDM = A.SORLCUR_PIDM
                              AND R.TZTCJOR_STUDY_PAHT = A.SORLCUR_KEY_SEQNO
                              AND R.TZTCJOR_START_DATE = (SELECT TZTCJOR_START_DATE
                                                            FROM TZTCJOR
                                                           WHERE     TZTCJOR_PIDM = R.TZTCJOR_PIDM
                                                                 AND TZTCJOR_STUDY_PAHT = R.TZTCJOR_STUDY_PAHT))CAM_JOR
                   FROM SORLCUR A, SGBSTDN B, SPRIDEN D, SFRSTCR F, SSBSECT G, SZTDTEC E
                  WHERE     A.SORLCUR_LMOD_CODE = 'LEARNER'
                        AND A.SORLCUR_ROLL_IND  = 'Y'
                        AND A.SORLCUR_CACT_CODE = 'ACTIVE' --Va?
                        AND A.SORLCUR_SEQNO = (SELECT MAX (A1.SORLCUR_SEQNO)
                                    FROM SORLCUR A1
                                    WHERE A1.SORLCUR_PIDM = A.SORLCUR_PIDM
                                    AND A1.SORLCUR_ROLL_IND  = A.SORLCUR_ROLL_IND
                                    AND A1.SORLCUR_CACT_CODE = A.SORLCUR_CACT_CODE
                                    AND A1.SORLCUR_PROGRAM = A.SORLCUR_PROGRAM
                                    AND A1.SORLCUR_LMOD_CODE = A.SORLCUR_LMOD_CODE)
                        AND A.SORLCUR_PIDM =  B.SGBSTDN_PIDM
                        AND A.SORLCUR_PROGRAM = B.SGBSTDN_PROGRAM_1
                        AND B.SGBSTDN_TERM_CODE_EFF IN (SELECT MAX (B1.SGBSTDN_TERM_CODE_EFF)
                                                          FROM SGBSTDN B1
                                                         WHERE     B.SGBSTDN_PIDM = B1.SGBSTDN_PIDM
                                                               AND B.SGBSTDN_PROGRAM_1 = B1.SGBSTDN_PROGRAM_1)
                        AND E.SZTDTEC_PROGRAM = B.SGBSTDN_PROGRAM_1
                        AND A.SORLCUR_TERM_CODE_CTLG = E.SZTDTEC_TERM_CODE
                        AND D.SPRIDEN_PIDM = SGBSTDN_PIDM
                        AND D.SPRIDEN_CHANGE_IND IS NULL
                        AND F.SFRSTCR_PIDM = A.SORLCUR_PIDM
                        AND F.SFRSTCR_RSTS_CODE = 'RE'
                        AND F.SFRSTCR_STSP_KEY_SEQUENCE = A.SORLCUR_KEY_SEQNO
                        AND F.SFRSTCR_TERM_CODE = G.SSBSECT_TERM_CODE
                        AND SUBSTR(F.SFRSTCR_TERM_CODE,5,2) NOT IN (81,82,83)
                        AND F.SFRSTCR_CRN = G.SSBSECT_CRN
                        AND F.SFRSTCR_PTRM_CODE = G.SSBSECT_PTRM_CODE
                        AND (SFRSTCR_RESERVED_KEY NOT IN ('M1HB401','CP001','CPB13001') OR SFRSTCR_RESERVED_KEY IS NULL )
                        AND (SFRSTCR_DATA_ORIGIN != 'EXCLUIR' OR SFRSTCR_DATA_ORIGIN IS NULL)
                        AND TRUNC (G.SSBSECT_PTRM_START_DATE) = TRUNC (A.SORLCUR_START_DATE)
                        AND A.SORLCUR_PIDM NOT IN (SELECT TZDOCTR_PIDM
                                                     FROM TZDOCTR
                                                    WHERE     TZDOCTR_PROGRAM = A.SORLCUR_PROGRAM
                                                          AND TZDOCTR_TERM_CODE = F.SFRSTCR_TERM_CODE
                                                          AND TZDOCTR_PTRM_CODE = F.SFRSTCR_PTRM_CODE
                                                          AND TZDOCTR_STUDY_PATH = A.SORLCUR_KEY_SEQNO
                                                          AND TRUNC (TZDOCTR_START_DATE) = TRUNC (G.SSBSECT_PTRM_START_DATE)
                                                          AND TZDOCTR_IND = 1
                                                          AND TZDOCTR_TIPO_PROC IN ('CART', 'EDCA'))
                        AND TRUNC (G.SSBSECT_PTRM_START_DATE)  = P_FECHA
                        AND D.SPRIDEN_ID = NVL(P_MATRICULA,D.SPRIDEN_ID)
--                        AND D.SPRIDEN_ID !='010385623'
                        AND A.SORLCUR_CAMP_CODE  = NVL(P_CAMPUS,A.SORLCUR_CAMP_CODE)
                        AND A.SORLCUR_LEVL_CODE  = NVL(P_NIVEL,A.SORLCUR_LEVL_CODE)
                        And A.SORLCUR_CAMP_CODE||A.SORLCUR_LEVL_CODE not in ('UTSEC','UTSID')
                        AND A.SORLCUR_PIDM NOT IN (SELECT GORADID_PIDM
                                                     FROM GORADID
                                                    WHERE     GORADID_PIDM = A.SORLCUR_PIDM
                                                          AND GORADID_ADID_CODE IN (SELECT ZSTPARA_PARAM_VALOR
                                                                                      FROM ZSTPARA
                                                                                     WHERE ZSTPARA_MAPA_ID = 'FREEMIUM_ADID'))
                        AND D.SPRIDEN_ID NOT IN (SELECT SUBSTR(ZSTPARA_PARAM_VALOR,1,9)
                                                   FROM ZSTPARA
                                                  WHERE     ZSTPARA_MAPA_ID = 'ALUM_CONV'
                                                        AND SUBSTR(ZSTPARA_PARAM_ID,1,3) = B.SGBSTDN_CAMP_CODE
                                                        AND SUBSTR(ZSTPARA_PARAM_ID,4,2) = B.SGBSTDN_LEVL_CODE
                                                        AND SUBSTR(ZSTPARA_PARAM_VALOR,1,9) = D.SPRIDEN_ID
                                                        AND SUBSTR(ZSTPARA_PARAM_VALOR,11,2) = A.SORLCUR_KEY_SEQNO)
                       And a.sorlcur_pidm not in (select goradid_pidm
                                                    from GORADID
                                                    Where 1=1
                                                    And GORADID_ADID_CODE in ('SBTD','SBTI') ----> Se excluyen a los alumnos que cuenten con la etiqueta de Retencion 
                                                    )                                                        
                  UNION
                 SELECT DISTINCT
                        D.SPRIDEN_ID MATRICULA,
                        A.SORLCUR_PIDM PIDM,
                        A.SORLCUR_PROGRAM PROGRAMA,
                        E.SZTDTEC_PROGRAMA_COMP PROGRAMA_DESC,
                        B.SGBSTDN_STST_CODE ESTATUS,
                        B.SGBSTDN_STYP_CODE TIPO_ALUMNO,
                        B.SGBSTDN_CAMP_CODE CAMPUS,
                        B.SGBSTDN_LEVL_CODE NIVEL,
                        B.SGBSTDN_TERM_CODE_EFF PERIODO,
                        A.SORLCUR_START_DATE FECHA_INICIO,
                        A.SORLCUR_VPDI_CODE PARTE_PERIODO,
                        A.SORLCUR_KEY_SEQNO STUDY_PATH,
                        '' FOLIO,
                        CASE
                         SUBSTR (B.SGBSTDN_RATE_CODE, 1, 1)
                             WHEN  ('P') THEN SUBSTR (B.SGBSTDN_RATE_CODE, 2, 2)
                             WHEN  ('C') THEN SUBSTR (B.SGBSTDN_RATE_CODE, 2, 2)-- Se agrega
                             WHEN  ('J') THEN SUBSTR (B.SGBSTDN_RATE_CODE, 3, 1)
                        END  NUM_PAGOS,
                        (DECODE (SUBSTR (B.SGBSTDN_RATE_CODE, 4, 1), 'A', 15, 'B', '30', 'C', '10')) VENCIMIENTO,
                        SUBSTR (B.SGBSTDN_RATE_CODE, 1, 1) TIPO_PAGO,
                        B.SGBSTDN_RATE_CODE RATE,
                        DECODE (E.SZTDTEC_PERIODICIDAD, 1, 'Bime', 2, 'Cuatri', 3, 'Semes', 4, 'Anual') PERIODICIDAD,
                        (SELECT DISTINCT (SORLCUR_SITE_CODE)
                           FROM SORLCUR CUR
                          WHERE     CUR.SORLCUR_PIDM = A.SORLCUR_PIDM
                                AND CUR.SORLCUR_LMOD_CODE = 'ADMISSIONS'
                                And cur.sorlcur_camp_code = p_campus
                                And cur.sorlcur_levl_code = p_nivel
                              --  And cur.SORLCUR_PROGRAM = a.SORLCUR_PROGRAM
                                AND CUR.SORLCUR_SEQNO = (SELECT MAX (SORLCUR_SEQNO)
                                                           FROM SORLCUR CUR2
                                                          WHERE     CUR2.SORLCUR_PIDM = CUR.SORLCUR_PIDM
                                                                AND CUR2.SORLCUR_LMOD_CODE = CUR.SORLCUR_LMOD_CODE
                                                                And cur2.SORLCUR_camp_code = cur.SORLCUR_camp_code
                                                                And cur2.SORLCUR_levl_code = cur.SORLCUR_levl_code
                                                                --And cur2.SORLCUR_PROGRAM = cur.SORLCUR_PROGRAM
                                                                 ))PRE_ACTUALIZADO,
                        DECODE (A.SORLCUR_DEGC_CODE, 'DIPL', 'COLEGIATURA DIPLOMADO', 'CURS', 'COLEGIATURA CURSO')DEGC_CODE,
                        (SELECT DISTINCT TZTCJOR_ATTS_CODE
                         FROM TZTCJOR R
                        WHERE     R.TZTCJOR_PIDM = A.SORLCUR_PIDM
                              AND R.TZTCJOR_STUDY_PAHT = A.SORLCUR_KEY_SEQNO
                              AND R.TZTCJOR_START_DATE = (SELECT TZTCJOR_START_DATE
                                                            FROM TZTCJOR
                                                           WHERE     TZTCJOR_PIDM = R.TZTCJOR_PIDM
                                                                 AND TZTCJOR_STUDY_PAHT = R.TZTCJOR_STUDY_PAHT))CAM_JOR
                   FROM SORLCUR A, SGBSTDN B, SPRIDEN D, SZTDTEC E
                  WHERE     A.SORLCUR_LMOD_CODE = 'LEARNER'
                        AND A.SORLCUR_ROLL_IND  = 'Y'
                        AND A.SORLCUR_CACT_CODE = 'ACTIVE' --Va?
                        AND A.SORLCUR_SEQNO = (SELECT MAX (A1.SORLCUR_SEQNO)
                                                 FROM SORLCUR A1
                                                WHERE     A1.SORLCUR_PIDM = A.SORLCUR_PIDM
                                                      AND A1.SORLCUR_ROLL_IND  = A.SORLCUR_ROLL_IND
                                                      AND A1.SORLCUR_CACT_CODE = A.SORLCUR_CACT_CODE
                                                      AND A1.SORLCUR_PROGRAM = A.SORLCUR_PROGRAM
                                                      AND A1.SORLCUR_LMOD_CODE = A.SORLCUR_LMOD_CODE)
                        AND A.SORLCUR_PIDM =  B.SGBSTDN_PIDM
                        AND A.SORLCUR_PROGRAM = B.SGBSTDN_PROGRAM_1
                        AND B.SGBSTDN_TERM_CODE_EFF IN (SELECT MAX (B1.SGBSTDN_TERM_CODE_EFF)
                                                          FROM SGBSTDN B1
                                                         WHERE     B.SGBSTDN_PIDM = B1.SGBSTDN_PIDM
                                                               AND B.SGBSTDN_PROGRAM_1 = B1.SGBSTDN_PROGRAM_1)
                        AND E.SZTDTEC_PROGRAM = B.SGBSTDN_PROGRAM_1
                        AND A.SORLCUR_TERM_CODE_CTLG = E.SZTDTEC_TERM_CODE
                        AND D.SPRIDEN_PIDM = SGBSTDN_PIDM
                        AND D.SPRIDEN_CHANGE_IND IS NULL
                        AND A.SORLCUR_PIDM NOT IN (SELECT TZDOCTR_PIDM
                                                     FROM TZDOCTR
                                                    WHERE TZDOCTR_PROGRAM = A.SORLCUR_PROGRAM
                                                          AND TZDOCTR_TERM_CODE = B.SGBSTDN_TERM_CODE_EFF
                                                          AND TZDOCTR_PTRM_CODE = A.SORLCUR_VPDI_CODE
                                                          AND TRUNC (TZDOCTR_START_DATE) = TRUNC (A.SORLCUR_START_DATE)
                                                          AND TZDOCTR_IND = 1
                                                          AND TZDOCTR_TIPO_PROC != 'AUME'
                                                          AND TZDOCTR_TIPO_PROC IN ('CART', 'EDCA'))
                        AND (   A.SORLCUR_CAMP_CODE IN (SELECT ZSTPARA_PARAM_ID
                                                          FROM ZSTPARA
                                                         WHERE ZSTPARA_MAPA_ID = 'CART_SINMA')
                             OR
                                A.SORLCUR_CAMP_CODE||A.SORLCUR_LEVL_CODE IN (SELECT ZSTPARA_PARAM_ID
                                                                               FROM ZSTPARA
                                                                              WHERE ZSTPARA_MAPA_ID = 'CART_SINMA')
                            AND '01'||SUBSTR(D.SPRIDEN_ID,3,7) NOT IN (SELECT SPRIDEN_ID
                                                                         FROM SPRIDEN,SGBSTDN
                                                                        WHERE     SPRIDEN_PIDM = SGBSTDN_PIDM
                                                                              AND SPRIDEN_CHANGE_IND IS NULL
                                                                              AND SPRIDEN_ID = '01'||SUBSTR(D.SPRIDEN_ID,3,7))
                             OR
                                A.SORLCUR_PIDM IN (SELECT SZTUTLX_PIDM
                                                     FROM SZTUTLX
                                                    WHERE     SZTUTLX_PIDM = A.SORLCUR_PIDM
                                                          AND SZTUTLX_DISABLE_IND = 'A'
                                                          AND SUBSTR(A.SORLCUR_RATE_CODE,1,1) = 'C'
                                                          AND SUBSTR(SZTUTLX_ID,1,2) = '02'
                                                          AND SZTUTLX_PIDM NOT IN (SELECT Z.TZFACCE_PIDM
                                                                                     FROM TZFACCE Z
                                                                                    WHERE     1=1
                                                                                          AND Z.TZFACCE_PIDM = A.SORLCUR_PIDM
                                                                                          AND SUBSTR(Z.TZFACCE_DETAIL_CODE,3,2) = 'QI'
                                                                                          AND Z.TZFACCE_STUDY = (SELECT MAX(TZFACCE_STUDY)
                                                                                                                   FROM TZFACCE
                                                                                                                  WHERE TZFACCE_PIDM = Z.TZFACCE_PIDM))))
                        AND A.SORLCUR_START_DATE = P_FECHA
                        AND D.SPRIDEN_ID = NVL(P_MATRICULA,D.SPRIDEN_ID)
                        AND A.SORLCUR_CAMP_CODE  = NVL(P_CAMPUS,A.SORLCUR_CAMP_CODE)
                        AND A.SORLCUR_LEVL_CODE  = NVL(P_NIVEL,A.SORLCUR_LEVL_CODE)
                        And A.SORLCUR_CAMP_CODE||A.SORLCUR_LEVL_CODE not in ('UTSEC','UTSID')
                       And a.sorlcur_pidm not in (select goradid_pidm
                                                    from GORADID
                                                    Where 1=1
                                                    And GORADID_ADID_CODE in ('SBTD','SBTI')    ----> Se excluyen a los alumnos que cuenten con la etiqueta de Retencion 
                                                    )                       
                      ORDER BY 1, 8, 9
     ) LOOP

     -- Seteo de Variables
       VL_SOLICITUD            :=NULL;
       VL_DIF_DSI              :=NULL;
       VL_EXISTE_MAT           :=NULL;
       VL_EXISTE_CART          :=NULL;
       VL_EXISTE_DESC          :=NULL;
       VL_EXISTE_PPLAN         :=NULL;
       VL_EXISTE_PARC          :=NULL;
       VL_EXISTE_BITA          :=NULL;
       VL_SECUENCIA            :=NULL;
       VL_SECUENCIACOL         :=NULL;
       VL_SECUENCIA_PADRE      :=NULL;
       VL_CODIGO               :=NULL;
       VL_CODIGO_AFEC          :=NULL;
       VL_DESCRIPCION          :=NULL;
       VL_ERROR                :=NULL;
       VL_CADENAERROR          :=NULL;
       VL_ERROR1               :=NULL;
       VL_DIA                  :=NULL;
       VL_MES                  :=NULL;
       VL_ANO                  :=NULL;
       VL_VENCIMIENTO          :=NULL;
       VL_MONTO                :=NULL;
       VL_MONTO_PERCENT        :=NULL;
       VL_MONTO_AMOUNT         :=NULL;
       VL_TRAN_NUM             :=NULL;
       VL_NUM_PARC             :=NULL;
       VL_COLEGIATURA          :=NULL;
       VL_DESCUENTO            :=NULL;
       VL_DESCUENTODSI         :=NULL;
       VL_PLAN_PAGO            :=NULL;
       VL_PARCIALIDAD          :=NULL;
       VL_VUELTA               :=NULL;
       VL_FECHA_PARC           :=NULL;
       VL_PLAN_BITA            :=NULL;
       VL_SFRRGFE_RATE_CODE    :=NULL;
       VD_FECHA_INICIO         :=NULL;
       AL_BUTTON               :=NULL;
       VC_JORNADA              :=NULL;
       VN_PROPE                :=NULL;
       VN_EXISTE_DSP           :=NULL;
       VN_AUMEN                :=NULL;
       VN_PERIODOS             :=NULL;
       VN_PORC_INCREM          :=NULL;
       VN_PERIODOS_CURSADOS    :=NULL;
       VN_TZDOCTR_COLEG_1      :=NULL;
       VN_TZDOCTR_DESC_1       :=NULL;
       VN_TZDOCTR_PPAGO_1      :=NULL;
       VN_TZDOCTR_PARCI_1      :=NULL;
       VN_NUM_PAGOS            :=NULL;
       VL_STUDY_PH             :=NULL;
       VL_CODIGO2              :=NULL;
       BANDERADSI              :=NULL;
       VDSI_CODE               :=NULL;
       VDSI_MTO                :=NULL;
       VDSI_DESCR              :=NULL;
       VDSI_STUDY              :=NULL;
       VL_ULT_COL              :=NULL;
       VL_NUMPAG               :=NULL;
       VL_CODIGO_AJ            :=NULL;
       VL_COD_EXCLU            :=NULL;
       V_ENTRA                 :=NULL;
       VL_NUINGR_PLAN          :=NULL;
       VL_NEWPERIODO           :=NULL;
       LV_TRAN_NUM             :=NULL;
       VL_FECHA_FUTU_2         :=NULL;
       VL_PAGO_ANTERIOR        :=NULL;
       VL_ROLA_DSI             :=NULL;
       VL_SIN_ORDEN            :=NULL;
       VL_MIGRA                :=NULL;
       VL_MIGRA2               :=NULL;
       VL_SECUEN               :=NULL;
       VL_CODEXEMTION          :=NULL;
       VL_ENTDESC              :=NULL;
       VL_LPC                  :=NULL;
       VL_PROSPECTO            :=NULL;
       VL_ESCA                 :=NULL;
       VL_BIME                 :=NULL;
       VL_PAGOUNICO            :=NULL;
       VL_BECA_COLABO          :=NULL;
       VL_BESP                 :=NULL;
       VL_COL_NUEVO            :=NULL;
       VL_UTLX                 :=NULL;
       VL_CART_UTL             :=NULL;
       VL_COMPLEMENTO          :=NULL;
       VL_RESP_PAGOCUATRI      :=NULL;
       VL_UPSE                 :=NULL;
       VL_CONDONACION_UTLX     :=NULL;
       VL_RESP_UPSELLING       :=NULL;
       VL_ENTRA_DINA           :=NULL;
       VL_DINAMICOS            :=NULL;
       VL_ROLA_ACC             :=NULL;
       VL_INCR                 :=NULL;
       VL_PARC_ANTE            :=NULL;
       VL_RECURRENTE           :=NULL;
       VL_COMPLE_FILI          :=NULL;
       VL_COMPLE_INICIO        :=NULL;
       VL_NOAPL_COM            :=NULL;

       VD_FECHA_INICIO := ALUMNO.FECHA_INICIO;
       vl_PRE_ACTUALIZADO := null;

       --DBMS_OUTPUT.PUT_LINE ('En Forty:'|| VL_ERROR||' -- '||ALUMNO.PRE_ACTUALIZADO||' - '||ALUMNO.PIDM);

        If alumno.PRE_ACTUALIZADO is not null then 

            vl_PRE_ACTUALIZADO:= alumno.PRE_ACTUALIZADO;

        Else

               Begin
                
                    SELECT DISTINCT (SORLCUR_SITE_CODE)
                        Into vl_PRE_ACTUALIZADO
                    FROM SORLCUR CUR
                    WHERE CUR.SORLCUR_PIDM = ALUMNO.PIDM
                    AND CUR.SORLCUR_LMOD_CODE = 'ADMISSIONS'
                    And cur.sorlcur_camp_code = alumno.campus
                    And cur.sorlcur_levl_code = alumno.nivel
                    AND CUR.SORLCUR_SEQNO = (SELECT MAX (SORLCUR_SEQNO)
                                               FROM SORLCUR CUR2
                                              WHERE     CUR2.SORLCUR_PIDM = CUR.SORLCUR_PIDM
                                                    AND CUR2.SORLCUR_LMOD_CODE = CUR.SORLCUR_LMOD_CODE
                                                    And cur2.SORLCUR_camp_code = cur.SORLCUR_camp_code
                                                    And cur2.SORLCUR_levl_code = cur.SORLCUR_levl_code
                                                     );
                Exception
                    When others then 
                        vl_PRE_ACTUALIZADO:= null;
                End;

         End if;

         ------------------ Crea el proceso de Incrementos ------------------
        ---- PKG_FINANZAS.P_INCREMENTO_ANUAL(alumno.fecha_inicio, alumno.matricula);

         ------------------ Crea el proceso de Incrementos nuevo para 2024 ------------------
         Begin 
   
                 PKG_FINANZAS.p_incremento_anual_new (alumno.matricula, 
                                                      alumno.programa, 
                                                      ALUMNO.PERIODO, 
                                                      ALUMNO.PARTE_PERIODO, 
                                                      trunc (ALUMNO.FECHA_INICIO), 
                                                      alumno.estatus, 
                                                      alumno.TIPO_ALUMNO,
                                                      alumno.STUDY_PATH);        
         Exception
            When Others then 
                null;
         End;

          ------------------------- Se busca que no exista la cartera en periodo de las inscripciones --------------------------
       VL_EXISTE_CART:=PKG_FINANZAS.F_VALIDA_EXIST_CARTERA ( P_PIDM =>  ALUMNO.PIDM
                                              , P_PERIODO =>ALUMNO.PERIODO
                                              , P_PARTE_PERIODO =>  ALUMNO.PARTE_PERIODO
                                              , P_NIVEL =>  ALUMNO.NIVEL
                                              , P_CAT_CODE =>  'TUI'
                                              , P_DETAIL_CODE => NULL
                                              , P_STUDY => ALUMNO.STUDY_PATH);
          ------------------------- Se busca que no exista el descuento en periodo de las inscripciones --------------------------
       VL_EXISTE_DESC:=PKG_FINANZAS.F_VALIDA_EXIST_CARTERA ( P_PIDM =>  ALUMNO.PIDM
                                              , P_PERIODO =>ALUMNO.PERIODO
                                              , P_PARTE_PERIODO =>  ALUMNO.PARTE_PERIODO
                                              , P_NIVEL =>  ALUMNO.NIVEL
                                              , P_CAT_CODE =>  'DSP'
                                              , P_DETAIL_CODE => NULL
                                              , P_STUDY => ALUMNO.STUDY_PATH);
          ------------------------- Se busca que no exista el plan de pagos  en periodo de las inscripciones --------------------------
       VL_EXISTE_PPLAN:=PKG_FINANZAS.F_VALIDA_EXIST_CARTERA (P_PIDM =>  ALUMNO.PIDM
                                              , P_PERIODO =>ALUMNO.PERIODO
                                              , P_PARTE_PERIODO =>  ALUMNO.PARTE_PERIODO
                                              , P_NIVEL =>  ALUMNO.NIVEL
                                              , P_CAT_CODE =>  'LPC'
                                              , P_DETAIL_CODE => 'PLPA'
                                              , P_STUDY => ALUMNO.STUDY_PATH);
          ------------------------- Se busca que no existan parcialidades  en periodo de las inscripciones --------------------------
       VL_EXISTE_PARC:=PKG_FINANZAS.F_VALIDA_EXIST_CARTERA ( P_PIDM =>  ALUMNO.PIDM
                                              , P_PERIODO =>ALUMNO.PERIODO
                                              , P_PARTE_PERIODO =>  ALUMNO.PARTE_PERIODO
                                              , P_NIVEL =>  ALUMNO.NIVEL
                                              , P_CAT_CODE =>  'COL'
                                              , P_DETAIL_CODE => NULL
                                              , P_STUDY => ALUMNO.STUDY_PATH);

--          DBMS_OUTPUT.PUT_LINE ('VALIDACION PARCIALIDADES = '||ALUMNO.PIDM
--                                              ||' = '||ALUMNO.PERIODO
--                                              ||' = '||ALUMNO.PARTE_PERIODO
--                                              ||' = '||ALUMNO.NIVEL
--                                              ||' = '||'COL'
--                                              ||' = '||ALUMNO.STUDY_PATH
--                                              ||' VL_EXISTE_PARC '||VL_EXISTE_PARC);


         ----------------- VALIDA SI ES UPSELLING ------------------------

       BEGIN
          SELECT COUNT(*)
            INTO VL_UPSE
            FROM SZTALOL
           WHERE     SZTALOL_PIDM = ALUMNO.PIDM
                 AND SZTALOL_ESTATUS = 'A'
                 And trunc (SZTALOL_FECHA_COMPRA) <= trunc (ALUMNO.FECHA_INICIO);
       Exception
        When Others then 
            VL_UPSE:= 0;
       END;

          -------------- VALIDA SI EXISTE CODIGO EXCLUIDO Y GENERA CARTERA -----------------------

       If alumno.campus = 'UIN' then 

               BEGIN
                 SELECT DISTINCT TBRACCD_RECEIPT_NUMBER
                   INTO VL_SIN_ORDEN
                   FROM TBRACCD
                  WHERE     TBRACCD_PIDM = ALUMNO.PIDM
                        AND TBRACCD_RECEIPT_NUMBER = ALUMNO.FOLIO
                        And TBRACCD_FEED_DATE = alumno.fecha_inicio
                        AND TBRACCD_STSP_KEY_SEQUENCE = ALUMNO.STUDY_PATH

						-- OMS 09/Mayo/2024 (Incluye conceptos BACHELORS & MASTER & COLEGIATURA & TUITION)
                        AND TBRACCD_DETAIL_CODE IN (SELECT z.TZTNCD_CODE
													  FROM tztncd z, tbbdetc b
													 WHERE z.TZTNCD_concepto         = 'Venta'    
                                                       AND b.TBBDETC_detail_code     = z.TZTNCD_CODE   
                                                       AND b.TBBDETC_type_ind        = 'C'     
                                                       AND b.TBBDETC_detc_active_ind = 'Y'
                                                       AND b.TBBDETC_dcat_code       = 'COL'    
                                                       AND b.TBBDETC_taxt_code NOT IN ('GN','EC','CU','ES','ID','BA')
						                           );

												   /* Version Anterior al 09/Mayo/2024
												   (SELECT TBBDETC_DETAIL_CODE
                                                      FROM TBBDETC
                                                     WHERE     TBBDETC_DCAT_CODE = 'COL'              -- OMS 30/Enero/2024
                                                           AND ( TBBDETC_DESC LIKE 'COLEGIATURA %' OR TBBDETC_DESC LIKE 'BACHELORS TUITION%' )
                                                           AND TBBDETC_DESC != 'COLEGIATURA LIC NOTA'
                                                           AND TBBDETC_DESC != 'COLEGIATURA EXTRAORDINARIO'); */
               EXCEPTION
               WHEN OTHERS THEN
                VL_SIN_ORDEN:= NULL;
               END;       

       Else   

               BEGIN
                 SELECT DISTINCT TBRACCD_RECEIPT_NUMBER
                   INTO VL_SIN_ORDEN
                   FROM TBRACCD
                  WHERE     TBRACCD_PIDM = ALUMNO.PIDM
                        AND TBRACCD_RECEIPT_NUMBER = ALUMNO.FOLIO
                        AND TBRACCD_STSP_KEY_SEQUENCE = ALUMNO.STUDY_PATH

						-- OMS 09/Mayo/2024 (Incluye conceptos BACHELORS & MASTER & COLEGIATURA & TUITION)
                        AND TBRACCD_DETAIL_CODE IN (SELECT z.TZTNCD_CODE
													  FROM tztncd z, tbbdetc b
													 WHERE z.TZTNCD_concepto         = 'Venta'    
                                                       AND b.TBBDETC_detail_code     = z.TZTNCD_CODE   
                                                       AND b.TBBDETC_type_ind        = 'C'     
                                                       AND b.TBBDETC_detc_active_ind = 'Y'
                                                       AND b.TBBDETC_dcat_code       = 'COL'    
                                                       AND b.TBBDETC_taxt_code NOT IN ('GN','EC','CU','ES','ID','BA')
                                                   );						

						                            /* Version Anterior al 09/Mayo/2024
												   (SELECT TBBDETC_DETAIL_CODE
                                                      FROM TBBDETC
                                                     WHERE     TBBDETC_DCAT_CODE = 'COL'              -- OMS 30/Enero/2024
                                                           AND ( TBBDETC_DESC LIKE 'COLEGIATURA %' OR TBBDETC_DESC LIKE 'BACHELORS TUITION%' )
                                                           AND TBBDETC_DESC != 'COLEGIATURA LIC NOTA'
                                                           AND TBBDETC_DESC != 'COLEGIATURA EXTRAORDINARIO'); */
               EXCEPTION
               WHEN OTHERS THEN
                VL_SIN_ORDEN:= NULL;
               END;

        End if;

       BEGIN
   	     -- OMS 09/Mayo/2024 (Incluye conceptos BACHELORS & MASTER & COLEGIATURA & TUITION)
         SELECT COUNT (*)
           INTO VL_COL_NUEVO
           FROM TBRACCD -- ,TBBDETC
          WHERE 1 = 1
            AND TBRACCD_PIDM              = ALUMNO.PIDM
            AND TBRACCD_STSP_KEY_SEQUENCE = ALUMNO.STUDY_PATH
            AND TBRACCD_DOCUMENT_NUMBER  IS NULL
            AND TBRACCD_DETAIL_CODE = (SELECT DISTINCT z.TZTNCD_CODE
                                         FROM tztncd z, tbbdetc b
                                        WHERE 1 = 1
                                          AND z.TZTNCD_CODE = TBRACCD_DETAIL_CODE
                                          AND z.TZTNCD_concepto         = 'Venta'    
                                          AND b.TBBDETC_detail_code     = z.TZTNCD_CODE   
                                          AND b.TBBDETC_type_ind        = 'C'     
                                          AND b.TBBDETC_detc_active_ind = 'Y'
                                          AND b.TBBDETC_dcat_code       = 'COL'    
                                          AND b.TBBDETC_taxt_code NOT IN ('GN','EC','CU','ES','ID','BA')
                                          AND RowNum <= 1
                                      );


	     /* Versión Anterior al 09/Mayo/2024
         SELECT COUNT (*)
           INTO VL_COL_NUEVO
           FROM TBRACCD,TBBDETC
          WHERE TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
                AND TBRACCD_DOCUMENT_NUMBER IS NULL
                AND TBBDETC_DCAT_CODE = 'COL'
                AND ( TBBDETC_DESC LIKE 'COLEGIATURA %' OR TBBDETC_DESC LIKE 'BACHELORS TUITION%' ) -- OMS 30/Enero/2024
                AND TBBDETC_DESC NOT LIKE '%NOTA%'
                AND TBBDETC_DESC != 'COLEGIATURA EXTRAORDINARIO'
                AND TBRACCD_STSP_KEY_SEQUENCE = ALUMNO.STUDY_PATH
                AND TBRACCD_PIDM = ALUMNO.PIDM; */

       Exception
        When Others then
        VL_COL_NUEVO:=0;
       END;

       BEGIN
         SELECT COUNT(*)
           INTO VL_NOAPL_COM
           FROM TBRACCD
          WHERE     TBRACCD_PIDM = ALUMNO.PIDM
                AND TBRACCD_DETAIL_CODE IN ('49B0','47B0','48B0','50B0')
                AND TBRACCD_STSP_KEY_SEQUENCE = ALUMNO.STUDY_PATH;
       Exception
        When Others then
        VL_NOAPL_COM:=0;
       END;

--       IF     VL_COL_NUEVO = 0
         if   VL_NOAPL_COM = 0
          AND (P_LLAMADA != 'REPROCESO' OR P_LLAMADA IS NULL) THEN

        -----------------------------------------------
        /* Se apaga esta parte del codigo porque el proceso de Complementos se creara por recurrencia a partir de Julio 2023 vmrl */
         ----------------------------------------------
--          DBMS_OUTPUT.PUT_LINE ('Entra a Complemento');
--
--         VL_COMPLEMENTO:=PKG_FINANZAS_REZA.F_COMPLEMENTO ( ALUMNO.CAMPUS,
--                                                           ALUMNO.NIVEL,
--                                                           ALUMNO.PIDM,
--                                                           ALUMNO.PERIODO,
--                                                           ALUMNO.PROGRAMA,
--                                                           ALUMNO.STUDY_PATH);
           Null;
       END IF;

       BEGIN
         DELETE TZFACCE A
          WHERE    SUBSTR(A.TZFACCE_DETAIL_CODE,3,2) in (SELECT SUBSTR(ZSTPARA_PARAM_VALOR,3,2)
                                                          FROM ZSTPARA
                                                         WHERE ZSTPARA_MAPA_ID = 'COMPL_COSTOS')
               AND A.TZFACCE_PIDM = ALUMNO.PIDM
               AND A.TZFACCE_PIDM IN (SELECT GORADID_PIDM
                                       FROM GORADID
                                      WHERE     1=1
                                            AND GORADID_PIDM = A.TZFACCE_PIDM
                                            AND GORADID_ADID_CODE IN ('BCSP','ESPA'));
       END;

       IF VL_EXISTE_PARC > 0 AND P_LLAMADA  != 'REPROCESO'  THEN

         BEGIN
           SELECT MAX (TBRACCD_TRAN_NUMBER)
             INTO VL_ULT_COL
             FROM TBRACCD
            WHERE     TBRACCD_PIDM = ALUMNO.PIDM
                  AND TBRACCD_TERM_CODE = ALUMNO.PERIODO
                  AND TBRACCD_STSP_KEY_SEQUENCE = ALUMNO.STUDY_PATH
                  AND TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                                FROM TBBDETC
                                               WHERE     TBBDETC_DCAT_CODE = 'COL'
                                                     AND SUBSTR (TBBDETC_DETAIL_CODE, 1, 2 )  = SUBSTR (ALUMNO.PERIODO, 1, 2)
                                                     AND SUBSTR (TBBDETC_DETAIL_CODE,1,3) = SUBSTR (ALUMNO.PERIODO, 1, 2)||'N'
                                                     AND TBBDETC_DETC_ACTIVE_IND = 'Y'
                                                     AND TBBDETC_TAXT_CODE = ALUMNO.NIVEL)
                  AND (TBRACCD_PERIOD =  ALUMNO.PARTE_PERIODO OR TBRACCD_PERIOD IS NULL);
         EXCEPTION
         WHEN OTHERS THEN
         VL_ULT_COL:=0;
         END;

         BEGIN
           SELECT A1.TBRAPPL_PAY_TRAN_NUMBER
             INTO VL_NUMPAG
             FROM TBRAPPL A1
            WHERE     A1.TBRAPPL_PIDM = ALUMNO.PIDM
                  AND A1.TBRAPPL_CHG_TRAN_NUMBER =  VL_ULT_COL
                  AND A1.TBRAPPL_ACTIVITY_DATE = (SELECT MAX (A.TBRAPPL_ACTIVITY_DATE)
                                                    FROM TBRAPPL A
                                                   WHERE     A.TBRAPPL_PIDM = A1.TBRAPPL_PIDM
                                                         AND A.TBRAPPL_CHG_TRAN_NUMBER =  A1.TBRAPPL_CHG_TRAN_NUMBER
                                                         AND A.TBRAPPL_REAPPL_IND IS NULL);
         EXCEPTION
         WHEN OTHERS THEN
         VL_NUMPAG:=0;
         END;

         BEGIN
           SELECT TBRACCD_DETAIL_CODE
             INTO VL_CODIGO_AJ
             FROM TBRACCD
            WHERE     TBRACCD_PIDM = ALUMNO.PIDM
                  AND TBRACCD_TRAN_NUMBER = VL_NUMPAG;
         EXCEPTION
         WHEN OTHERS THEN
         VL_CODIGO_AJ:=0;
         END;

         BEGIN
           SELECT COUNT (ZSTPARA_PARAM_VALOR)
             INTO VL_COD_EXCLU
             FROM ZSTPARA
            WHERE     ZSTPARA_PARAM_ID = 'PARC_ANTERIOR'
                  AND ZSTPARA_PARAM_VALOR = SUBSTR(VL_CODIGO_AJ,3,2);
         EXCEPTION
         WHEN OTHERS THEN
         VL_COD_EXCLU:=0;
         END;

        --DBMS_OUTPUT.PUT_LINE('validacion reza genera cartera = '||VL_COD_EXCLU);

         IF VL_COD_EXCLU > 0 THEN

           VL_EXISTE_CART  := 0;
           VL_EXISTE_DESC  := 0;
           VL_EXISTE_PPLAN := 0;
           VL_EXISTE_PARC  := 0;
           VL_SIN_ORDEN    := NULL;

--         elsif VL_COD_EXCLU = 0 then
--
--           VL_EXISTE_CART  := 0;
--           VL_EXISTE_DESC  := 0;
--           VL_EXISTE_PPLAN := 0;
--           VL_EXISTE_PARC  := 0;
--           VL_SIN_ORDEN    := NULL;

         END IF;

       END IF;

       IF P_LLAMADA  = 'REPROCESO' THEN  ---- se limpian las variables si es el modleo reproceso para que afuerzas cree la cartera nuevamnete  vic 16.05.2018
           VL_EXISTE_CART := 0;
           VL_EXISTE_DESC := 0;
           VL_EXISTE_PPLAN := 0;
           VL_EXISTE_PARC  := 0 ;
           VL_SIN_ORDEN:= NULL;

         BEGIN
           UPDATE TZDOCTR
              SET TZDOCTR_IND = 0
            WHERE     TZDOCTR_PIDM = ALUMNO.PIDM
                  AND TZDOCTR_PROGRAM = ALUMNO.PROGRAMA
                  AND TZDOCTR_TERM_CODE= ALUMNO.PERIODO
                  AND TZDOCTR_START_DATE = ALUMNO.FECHA_INICIO
                  AND TZDOCTR_TIPO_PROC = 'AUME';
         END;

       ELSE

         BEGIN
           SELECT COUNT(*)
             INTO VL_MIGRA
             FROM TBRACCD
            WHERE     TBRACCD_PIDM = ALUMNO.PIDM
                  AND TBRACCD_STSP_KEY_SEQUENCE = ALUMNO.STUDY_PATH

				  -- OMS 09/Mayo/2024 (Incluye conceptos BACHELORS & MASTER & COLEGIATURA & TUITION)
                  AND TBRACCD_DETAIL_CODE IN (SELECT z.TZTNCD_CODE
											    FROM tztncd z, tbbdetc b
											   WHERE z.TZTNCD_concepto         = 'Venta'    
                                                 AND b.TBBDETC_detail_code     = z.TZTNCD_CODE   
                                                 AND b.TBBDETC_type_ind        = 'C'     
                                                 AND b.TBBDETC_detc_active_ind = 'Y'
                                                 AND b.TBBDETC_dcat_code       = 'COL'    
                                                 AND b.TBBDETC_taxt_code NOT IN ('GN','EC','CU','ES','ID','BA')
											 )

											  /* Version Anterior al 09/Mayo/2024
											 ( SELECT TBBDETC_DETAIL_CODE
                                                 FROM TBBDETC
                                                WHERE     TBBDETC_DCAT_CODE = 'COL'              -- OMS 30/Enero/2024
                                                      AND ( TBBDETC_DESC LIKE 'COLEGIATURA %' OR TBBDETC_DESC LIKE 'BACHELORS TUITION%' )
                                                      AND TBBDETC_DESC != 'COLEGIATURA LIC NOTA'
                                                      AND TBBDETC_DESC != 'COLEGIATURA EXTRAORDINARIO') */

                  AND LAST_DAY(TBRACCD_EFFECTIVE_DATE) = LAST_DAY(TO_DATE(ALUMNO.FECHA_INICIO)+15);  --> Estaba en 11 se cambio a 15 para respetar los peridoos cortos de decrecientes
         EXCEPTION
         WHEN OTHERS THEN
         VL_MIGRA:=0;
         END;

         BEGIN
           SELECT COUNT(*)
             INTO VL_MIGRA2
             FROM TBRACCD A
            WHERE     A.TBRACCD_PIDM = ALUMNO.PIDM
                  AND A.TBRACCD_TRAN_NUMBER IN (SELECT TBRAPPL_PAY_TRAN_NUMBER
                                                  FROM TBRAPPL
                                                 WHERE     TBRAPPL_PIDM = A.TBRACCD_PIDM
                                                       AND TBRAPPL_REAPPL_IND IS NULL
                                                       AND TBRAPPL_CHG_TRAN_NUMBER = (SELECT MAX (TBRACCD_TRAN_NUMBER)
                                                                                        FROM TBRACCD B
                                                                                       WHERE     B.TBRACCD_PIDM = ALUMNO.PIDM
                                                                                             AND B.TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE FROM TBBDETC WHERE TBBDETC_DCAT_CODE = 'COL')
                                                                                             AND LAST_DAY(B.TBRACCD_EFFECTIVE_DATE) = LAST_DAY(TO_DATE(ALUMNO.FECHA_INICIO)+15))) --> Estaba en 11 se cambio a 15 para respetar los peridoos cortos de decrecientes
                  AND SUBSTR(A.TBRACCD_DETAIL_CODE,3,2) IN (SELECT ZSTPARA_PARAM_VALOR
                                                              FROM ZSTPARA
                                                             WHERE ZSTPARA_PARAM_ID = 'PARC_ANTERIOR');
         EXCEPTION
         WHEN OTHERS THEN
         VL_MIGRA2 :=0;
         END;

         --DBMS_OUTPUT.PUT_LINE('validacion reza genera cartera 2 = '||VL_MIGRA||' = '||VL_MIGRA2);

         IF VL_MIGRA > 0 AND VL_MIGRA2 = 0 THEN

           VL_EXISTE_CART := 1;
           VL_EXISTE_DESC := 1;
           VL_EXISTE_PPLAN := 1;
           VL_EXISTE_PARC  := 1 ;
           VL_SIN_ORDEN:=NULL;

         ELSIF VL_MIGRA > 0 AND VL_MIGRA2 > 0 THEN

           VL_EXISTE_CART := 0;
           VL_EXISTE_DESC := 0;
           VL_EXISTE_PPLAN := 0;
           VL_EXISTE_PARC  := 0 ;
           VL_SIN_ORDEN:=NULL;

         END IF;

       END IF;

       IF SUBSTR(ALUMNO.RATE,1,3) = 'J01' THEN  ---> estaba en 'J09' para los pagos cuatrimestrales de Colombia
         VL_RESP_PAGOCUATRI:= PKG_FINANZAS_REZA.F_PGUNI_CUATRI ( ALUMNO.CAMPUS,
                                                                 ALUMNO.NIVEL,
                                                                 ALUMNO.PERIODO,
                                                                 ALUMNO.PARTE_PERIODO,
                                                                 vl_PRE_ACTUALIZADO,--ALUMNO.PRE_ACTUALIZADO,
                                                                 ALUMNO.PIDM,
                                                                 ALUMNO.FECHA_INICIO,
                                                                 ALUMNO.STUDY_PATH
                                                                );
         IF VL_RESP_PAGOCUATRI = 'EXITO' THEN
           VL_EXISTE_CART  := 0;
           VL_EXISTE_DESC  := 0;
           VL_EXISTE_PPLAN := 0;
           VL_EXISTE_PARC  := 0;
           VL_SIN_ORDEN    := NULL;
         ELSE
           VL_EXISTE_CART  := 1;
           VL_EXISTE_DESC  := 1;
           VL_EXISTE_PPLAN := 1;
           VL_EXISTE_PARC  := 1;
         END IF;

       END IF;

            --DBMS_OUTPUT.PUT_LINE('validacion reza genera cartera 3 = '||VL_EXISTE_CART||' = '||VL_EXISTE_DESC||' = '||VL_EXISTE_PPLAN||' = '||VL_EXISTE_PARC||' = '||VL_SIN_ORDEN);

       IF VL_EXISTE_CART = 0 AND VL_EXISTE_DESC = 0 AND VL_EXISTE_PPLAN = 0 AND VL_EXISTE_PARC = 0 AND VL_SIN_ORDEN IS NULL  THEN   ----> Se crea la nueva cartera



           BEGIN
             UPDATE TZTDMTO
                SET TZTDMTO_STUDY_PATH = ALUMNO.STUDY_PATH
              WHERE    1=1
                   AND TZTDMTO_PIDM = ALUMNO.PIDM
                   AND TZTDMTO_PROGRAMA = ALUMNO.PROGRAMA;
           Exception
            When Others then
                null;
                --DBMS_OUTPUT.PUT_LINE('Error al actualizar TZTDMTO '||sqlerrm );
           END;

           BEGIN
            --nota: se rola el descuento DSI  de la tabla de tzdmto  del periodo anterior al nuevo periodo    vic.  may 29.2018
             SELECT DISTINCT TZTDMTO_DESC_CODE,TZTDMTO_MONTO,TZTDMTO_OBSERVACIONES,TZTDMTO_STUDY_PATH
               INTO VDSI_CODE,VDSI_MTO,VDSI_DESCR,VDSI_STUDY
               FROM TZTDMTO A
              WHERE     A.TZTDMTO_PIDM = ALUMNO.PIDM
                    AND A.TZTDMTO_CAMP_CODE = ALUMNO.CAMPUS
                    AND A.TZTDMTO_NIVEL =  ALUMNO.NIVEL
                    AND A.TZTDMTO_PROGRAMA =  ALUMNO.PROGRAMA
                    AND A.TZTDMTO_TERM_CODE = ALUMNO.PERIODO
                    AND A.TZTDMTO_STUDY_PATH = ALUMNO.STUDY_PATH
                    AND A.TZTDMTO_DESC_CODE IS NOT NULL
                    AND A.TZTDMTO_MONTO = (SELECT MAX (TZTDMTO_MONTO)
                                             FROM TZTDMTO A1
                                            WHERE     A1.TZTDMTO_PIDM = A.TZTDMTO_PIDM
                                                  AND A1.TZTDMTO_CAMP_CODE = A.TZTDMTO_CAMP_CODE
                                                  AND A1.TZTDMTO_NIVEL = A.TZTDMTO_NIVEL
                                                  AND A1.TZTDMTO_TERM_CODE = A.TZTDMTO_TERM_CODE
                                                  AND A1.TZTDMTO_IND = 1
                                                  AND A1.TZTDMTO_DESC_CODE IS NOT NULL
                                                  AND A1.TZTDMTO_STUDY_PATH = ALUMNO.STUDY_PATH
                                                  AND A1.TZTDMTO_PROGRAMA = A.TZTDMTO_PROGRAMA)
                    AND   A.TZTDMTO_IND = 1;

           EXCEPTION  WHEN OTHERS THEN

             BEGIN
               SELECT DISTINCT TZTDMTO_DESC_CODE , TZTDMTO_MONTO, TZTDMTO_OBSERVACIONES, TZTDMTO_STUDY_PATH
                 INTO     VDSI_CODE ,    VDSI_MTO ,  VDSI_DESCR , VDSI_STUDY
                 FROM TZTDMTO A
                WHERE     A.TZTDMTO_PIDM = ALUMNO.PIDM
                      AND A.TZTDMTO_CAMP_CODE = ALUMNO.CAMPUS
                      AND A.TZTDMTO_NIVEL = ALUMNO.NIVEL
                      AND A.TZTDMTO_PROGRAMA =  ALUMNO.PROGRAMA
                      AND A.TZTDMTO_STUDY_PATH = ALUMNO.STUDY_PATH
                      AND A.TZTDMTO_DESC_CODE IS NOT NULL
                      AND A.TZTDMTO_TERM_CODE = (SELECT MAX (TZTDMTO_TERM_CODE)
                                                   FROM TZTDMTO A1
                                                  WHERE     A1.TZTDMTO_PIDM = A.TZTDMTO_PIDM
                                                        AND A1.TZTDMTO_CAMP_CODE = A.TZTDMTO_CAMP_CODE
                                                        AND A1.TZTDMTO_NIVEL = A.TZTDMTO_NIVEL
                                                        AND A1.TZTDMTO_IND = 1
                                                        AND A1.TZTDMTO_DESC_CODE IS NOT NULL
                                                        AND A1.TZTDMTO_STUDY_PATH = ALUMNO.STUDY_PATH
                                                        AND A1.TZTDMTO_PROGRAMA = A.TZTDMTO_PROGRAMA)
                      AND A.TZTDMTO_MONTO = (SELECT MAX (TZTDMTO_MONTO)
                                               FROM TZTDMTO A1
                                              WHERE     A1.TZTDMTO_PIDM = A.TZTDMTO_PIDM
                                                    AND A1.TZTDMTO_CAMP_CODE = A.TZTDMTO_CAMP_CODE
                                                    AND A1.TZTDMTO_NIVEL = A.TZTDMTO_NIVEL
                                                    AND A1.TZTDMTO_TERM_CODE = A.TZTDMTO_TERM_CODE
                                                    AND A1.TZTDMTO_IND = 1
                                                    AND A1.TZTDMTO_DESC_CODE IS NOT NULL
                                                    AND A1.TZTDMTO_STUDY_PATH = ALUMNO.STUDY_PATH
                                                    AND A1.TZTDMTO_PROGRAMA = A.TZTDMTO_PROGRAMA)
                      AND A.TZTDMTO_IND = 1;

               VL_ROLA_DSI:= 1;

             EXCEPTION WHEN OTHERS THEN
               VDSI_CODE := '';
               VDSI_MTO  := '';
               VDSI_DESCR := '';
             END ;

           END;

           IF  VL_ROLA_DSI = 1   THEN
             BEGIN
               INSERT
                 INTO TZTDMTO
               VALUES ( ALUMNO.MATRICULA,
                        ALUMNO.PIDM,
                        ALUMNO.CAMPUS,
                        ALUMNO.NIVEL,
                        ALUMNO.PROGRAMA,
                        ALUMNO.PERIODO ,
                        VDSI_CODE ,
                        NULL,
                        VDSI_MTO,
                        VDSI_STUDY,
                        1,
                        SYSDATE,
                        VDSI_DESCR, 
                        null);
             Exception
                When Others then 
                    null;
                    --DBMS_OUTPUT.PUT_LINE('Error al insertar TZTDMTO '||sqlerrm );
             END;
           END IF;

           IF (ALUMNO.TIPO_PAGO IN ('J','C') AND ALUMNO.TIPO_ALUMNO <> 'N') OR (ALUMNO.TIPO_PAGO IN ('J','C','P') AND ALUMNO.TIPO_ALUMNO = 'N') THEN

             BEGIN
               SELECT T.SGRSATT_ATTS_CODE
                 INTO  VC_JORNADA
                 FROM SGRSATT T
                WHERE     T.SGRSATT_PIDM = ALUMNO.PIDM
                      AND T.SGRSATT_STSP_KEY_SEQUENCE = ALUMNO.STUDY_PATH
                      AND REGEXP_LIKE  (T.SGRSATT_ATTS_CODE , '^[0-9]')
                      AND SUBSTR(T.SGRSATT_TERM_CODE_EFF,5,2) NOT IN (81,82,83,90)
                      AND T.SGRSATT_TERM_CODE_EFF = ( SELECT MAX(SGRSATT_TERM_CODE_EFF)
                                                        FROM SGRSATT TT
                                                       WHERE     TT.SGRSATT_PIDM =  T.SGRSATT_PIDM
                                                             AND TT.SGRSATT_STSP_KEY_SEQUENCE= T.SGRSATT_STSP_KEY_SEQUENCE
                                                             AND SUBSTR(TT.SGRSATT_TERM_CODE_EFF,5,2) NOT IN (81,82,83,90)
                                                             AND REGEXP_LIKE  (TT.SGRSATT_ATTS_CODE , '^[0-9]'))
                      AND T.SGRSATT_ACTIVITY_DATE = (SELECT MAX(SGRSATT_ACTIVITY_DATE)
                                                       FROM SGRSATT T1
                                                      WHERE     T1.SGRSATT_PIDM = T.SGRSATT_PIDM
                                                            AND T1.SGRSATT_STSP_KEY_SEQUENCE = T.SGRSATT_STSP_KEY_SEQUENCE
                                                            AND T1.SGRSATT_TERM_CODE_EFF = T.SGRSATT_TERM_CODE_EFF
                                                            AND SUBSTR(T1.SGRSATT_TERM_CODE_EFF,5,2) NOT IN (81,82,83,90)
                                                            AND REGEXP_LIKE  (T1.SGRSATT_ATTS_CODE , '^[0-9]'));
             EXCEPTION
             WHEN OTHERS THEN
             VC_JORNADA:=NULL;
             VL_ERROR :='Error al buscar la Jornada en SGRSATT: ';
             VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;
             END;


                DBMS_OUTPUT.PUT_LINE(' DATO PREACTUALZADO '||vl_PRE_ACTUALIZADO );

             IF vl_PRE_ACTUALIZADO IS NOT NULL THEN

               BEGIN
                 SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                   INTO VL_CODIGO, VL_DESCRIPCION, VL_MONTO,  VL_SFRRGFE_RATE_CODE
                   FROM SFRRGFE A , TBBDETC
                  WHERE     TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                        AND A.SFRRGFE_TERM_CODE= ALUMNO.PERIODO
                        AND A.SFRRGFE_TYPE = 'STUDENT'
                        AND SFRRGFE_ENTRY_TYPE = 'R'
                        AND A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                        AND A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                        AND A.SFRRGFE_ATTS_CODE = VC_JORNADA--ALUMNO.JORNADA
                        AND A.SFRRGFE_RATE_CODE = ALUMNO.RATE
                        AND A.SFRRGFE_DEPT_CODE = vl_PRE_ACTUALIZADO
                        AND A.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA
                        AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                                 FROM SFRRGFE A1
                                                WHERE     A1.SFRRGFE_TERM_CODE = A.SFRRGFE_TERM_CODE
                                                      AND A1.SFRRGFE_TYPE = A.SFRRGFE_TYPE
                                                      AND A1.SFRRGFE_ENTRY_TYPE = A.SFRRGFE_ENTRY_TYPE
                                                      AND A1.SFRRGFE_LEVL_CODE = A.SFRRGFE_LEVL_CODE
                                                      AND A1.SFRRGFE_CAMP_CODE = A.SFRRGFE_CAMP_CODE
                                                      AND A1.SFRRGFE_ATTS_CODE = A.SFRRGFE_ATTS_CODE
                                                      AND A1.SFRRGFE_RATE_CODE = A.SFRRGFE_RATE_CODE
                                                      AND A1.SFRRGFE_DEPT_CODE = A.SFRRGFE_DEPT_CODE
                                                      AND A1.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA);
               EXCEPTION
               WHEN NO_DATA_FOUND THEN

                 BEGIN
                   SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                     INTO VL_CODIGO, VL_DESCRIPCION, VL_MONTO,  VL_SFRRGFE_RATE_CODE
                     FROM SFRRGFE A , TBBDETC
                    WHERE     TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                          AND A.SFRRGFE_TERM_CODE= ALUMNO.PERIODO
                          AND A.SFRRGFE_TYPE = 'STUDENT'
                          AND SFRRGFE_ENTRY_TYPE = 'R'
                          AND A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                          AND A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                          AND A.SFRRGFE_ATTS_CODE = VC_JORNADA--ALUMNO.JORNADA
                          AND A.SFRRGFE_RATE_CODE = ALUMNO.RATE
                          AND A.SFRRGFE_DEPT_CODE = vl_PRE_ACTUALIZADO
                          AND A.SFRRGFE_PROGRAM IS NULL
                          AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                                   FROM SFRRGFE A1
                                                  WHERE     A1.SFRRGFE_TERM_CODE = A.SFRRGFE_TERM_CODE
                                                        AND A1.SFRRGFE_TYPE = A.SFRRGFE_TYPE
                                                        AND A1.SFRRGFE_ENTRY_TYPE = A.SFRRGFE_ENTRY_TYPE
                                                        AND A1.SFRRGFE_LEVL_CODE = A.SFRRGFE_LEVL_CODE
                                                        AND A1.SFRRGFE_CAMP_CODE = A.SFRRGFE_CAMP_CODE
                                                        AND A1.SFRRGFE_ATTS_CODE = A.SFRRGFE_ATTS_CODE
                                                        AND A1.SFRRGFE_RATE_CODE = A.SFRRGFE_RATE_CODE
                                                        AND A1.SFRRGFE_DEPT_CODE = A.SFRRGFE_DEPT_CODE
                                                        AND A1.SFRRGFE_PROGRAM IS NULL);
                 EXCEPTION
                 WHEN OTHERS THEN
                   VL_ERROR :='Validar Regla de Cobro, Parametros x = '||ALUMNO.PERIODO||'  -  '||NVL(VC_JORNADA,'SIN JORNADA')||'  -  '||ALUMNO.RATE||' código aumento '||NVL(vl_PRE_ACTUALIZADO,'NULL');
                   VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;
                   VL_CODIGO := NULL;
                   VL_DESCRIPCION := NULL;
                   VL_MONTO := NULL;
                 END;

               END;

             ELSIF vl_PRE_ACTUALIZADO IS  NULL THEN

               BEGIN
                 SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                   INTO VL_CODIGO, VL_DESCRIPCION, VL_MONTO,  VL_SFRRGFE_RATE_CODE
                   FROM SFRRGFE A , TBBDETC
                  WHERE     TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                        AND A.SFRRGFE_TERM_CODE = ALUMNO.PERIODO
                        AND A.SFRRGFE_TYPE = 'STUDENT'
                        AND SFRRGFE_ENTRY_TYPE = 'R'
                        AND A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                        AND A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                        AND A.SFRRGFE_ATTS_CODE = VC_JORNADA--ALUMNO.JORNADA
                        AND A.SFRRGFE_RATE_CODE = ALUMNO.RATE
                        AND A.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA
                        AND A.SFRRGFE_DEPT_CODE IS NULL
                        AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                                 FROM SFRRGFE A1
                                                WHERE     A1.SFRRGFE_TERM_CODE = A.SFRRGFE_TERM_CODE
                                                      AND A1.SFRRGFE_TYPE = A.SFRRGFE_TYPE
                                                      AND A1.SFRRGFE_ENTRY_TYPE = A.SFRRGFE_ENTRY_TYPE
                                                      AND A1.SFRRGFE_LEVL_CODE = A.SFRRGFE_LEVL_CODE
                                                      AND A1.SFRRGFE_CAMP_CODE = A.SFRRGFE_CAMP_CODE
                                                      AND A1.SFRRGFE_ATTS_CODE = A.SFRRGFE_ATTS_CODE
                                                      AND A1.SFRRGFE_RATE_CODE = A.SFRRGFE_RATE_CODE
                                                      AND A1.SFRRGFE_DEPT_CODE IS NULL
                                                      AND A1.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA);
               EXCEPTION
               WHEN OTHERS THEN

                 BEGIN
                   SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                     INTO VL_CODIGO, VL_DESCRIPCION, VL_MONTO,  VL_SFRRGFE_RATE_CODE
                     FROM SFRRGFE A , TBBDETC
                    WHERE     TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                          AND A.SFRRGFE_TERM_CODE= ALUMNO.PERIODO
                          AND A.SFRRGFE_TYPE = 'STUDENT'
                          AND SFRRGFE_ENTRY_TYPE = 'R'
                          AND A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                          AND A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                          AND A.SFRRGFE_ATTS_CODE = VC_JORNADA--ALUMNO.JORNADA
                          AND A.SFRRGFE_RATE_CODE = ALUMNO.RATE
                          AND A.SFRRGFE_DEPT_CODE IS NULL
                          AND A.SFRRGFE_PROGRAM IS NULL
                          AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                                   FROM SFRRGFE A1
                                                  WHERE     A1.SFRRGFE_TERM_CODE = A.SFRRGFE_TERM_CODE
                                                        AND A1.SFRRGFE_TYPE = A.SFRRGFE_TYPE
                                                        AND A1.SFRRGFE_ENTRY_TYPE = A.SFRRGFE_ENTRY_TYPE
                                                        AND A1.SFRRGFE_LEVL_CODE = A.SFRRGFE_LEVL_CODE
                                                        AND A1.SFRRGFE_CAMP_CODE = A.SFRRGFE_CAMP_CODE
                                                        AND A1.SFRRGFE_ATTS_CODE = A.SFRRGFE_ATTS_CODE
                                                        AND A1.SFRRGFE_RATE_CODE = A.SFRRGFE_RATE_CODE
                                                        AND A1.SFRRGFE_DEPT_CODE IS NULL
                                                        AND A1.SFRRGFE_PROGRAM IS NULL);
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_ERROR :='Validar Regla de Cobro, Parametros xx = '||ALUMNO.PERIODO||'  -  '||NVL(VC_JORNADA,'SIN JORNADA')||'  -  '||ALUMNO.RATE||' código aumento '||NVL(vl_PRE_ACTUALIZADO,'NULL');
                 VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;
                 VL_CODIGO := NULL;
                 VL_DESCRIPCION := NULL;
                 VL_MONTO := NULL;
                 END;

               END;

             END IF;

             VN_PORC_INCREM:=0;

             IF ALUMNO.TIPO_ALUMNO <> 'N' THEN

               BEGIN
                 SELECT NVL(SUM(A.TZDOCTR_PORC_INCREM),0)
                       ,MAX(A.TZDOCTR_PERIODOS_CURSADOS)
                       ,MAX(TZDOCTR_COLEG_1)
                       ,MAX(TZDOCTR_DESC_1)
                       ,MAX(TZDOCTR_PPAGO_1)
                       ,MAX(TZDOCTR_PARCI_1)
                   INTO VN_PORC_INCREM,VN_PERIODOS_CURSADOS,VN_TZDOCTR_COLEG_1,VN_TZDOCTR_DESC_1,VN_TZDOCTR_PPAGO_1,VN_TZDOCTR_PARCI_1
                   FROM  TZDOCTR A
                  WHERE     A.TZDOCTR_PIDM = ALUMNO.PIDM
                        AND A.TZDOCTR_PROGRAM = ALUMNO.PROGRAMA
                        AND A.TZDOCTR_TERM_CODE =  ALUMNO.PERIODO
                        AND A.TZDOCTR_START_DATE = ALUMNO.FECHA_INICIO
                        AND A.TZDOCTR_CAMP_CODE = ALUMNO.CAMPUS
                        AND A.TZDOCTR_LEVL_CODE = ALUMNO.NIVEL
                        AND NVL(TZDOCTR_IND,0) <> 1
                        AND A.TZDOCTR_TIPO_PROC = 'AUME';
               EXCEPTION
               WHEN OTHERS THEN
               VN_PORC_INCREM:=0;
               VN_PERIODOS_CURSADOS:=0;
               END;

             END IF;
             
             
            ---  DBMS_OUTPUT.PUT_LINE('ENTRADA DEL AJUSTE DEL AUMENTO VL_CODIGO ************ = '||VL_CODIGO ||'VL_DESCRIPCION'||VL_DESCRIPCION ||'VL_MONTO'||VL_MONTO||'VL_ERROR'||VL_ERROR);
             

             IF  VL_CODIGO IS NOT NULL AND VL_DESCRIPCION IS NOT NULL AND VL_MONTO IS NOT NULL AND VL_ERROR IS NULL THEN --SOLO SE CREA LA CARTERA SI EXISTE CONFIGURACION

              -- VL_COLEGIATURA := VL_MONTO + (VL_MONTO*(VN_PORC_INCREM/100));
               VL_COLEGIATURA := ceil (VL_MONTO + (VL_MONTO*(VN_PORC_INCREM/100)));
               
            ---   DBMS_OUTPUT.PUT_LINE('VALOR DE LA COLEGIATURA ************  = '||'VL_MONTO'||VL_MONTO||'VL_COLEGIATURA'||VL_COLEGIATURA);

               IF ALUMNO.NUM_PAGOS = 4 AND ALUMNO.PERIODICIDAD =  'Bime' THEN
                  VL_COLEGIATURA:= VL_COLEGIATURA/2;
               END IF;

               VL_PLAN_BITA :=0;
               VL_SECUENCIACOL  := VL_SECUENCIA;
               VL_ERROR := NULL;

               IF SUBSTR(ALUMNO.PARTE_PERIODO,2,1)= '0' AND ALUMNO.TIPO_ALUMNO = 'N' THEN

                 BEGIN
                   SELECT SZTPTRM_PROPEDEUTICO
                     INTO VN_PROPE
                     FROM SZTPTRM
                    WHERE     SZTPTRM_CAMP_CODE =   ALUMNO.CAMPUS  ----alumno.SGBSTDN_CAMP_CODE
                          AND SZTPTRM_LEVL_CODE = ALUMNO.NIVEL
                          AND SZTPTRM_TERM_CODE = ALUMNO.PERIODO--TZDOCTA_TERM_CODE
                          AND SZTPTRM_PTRM_CODE = ALUMNO.PARTE_PERIODO
                          AND SZTPTRM_PROGRAM   = ALUMNO.PROGRAMA;--sorlcur_program;
                 EXCEPTION
                 WHEN OTHERS THEN
                     VN_PROPE := NULL;
                 END;

                 IF VN_PROPE = 1 THEN
                     VD_FECHA_INICIO := ADD_MONTHS(TRUNC(ALUMNO.FECHA_INICIO),1);
                 ELSE
                   VD_FECHA_INICIO := ALUMNO.FECHA_INICIO;
                 END IF;

               ELSE
                   VD_FECHA_INICIO := ALUMNO.FECHA_INICIO;
               END IF;

               ----------------------------- VALIDA ACCESORIOS Y DESCUENTOS -------------------------------------------
               --------------------------------------------------------------------------------------------------------
               --------------------------------------------------------------------------------------------------------

               BEGIN
                 SELECT COUNT(*)
                   INTO V_ENTRA
                   FROM TZFACCE
                  WHERE     TZFACCE_PIDM = ALUMNO.PIDM
                        AND TZFACCE_TERM_CODE = ALUMNO.PERIODO
                        AND TZFACCE_USER = 'SV2A'
                        AND TZFACCE_FLAG = 0;
               EXCEPTION
               WHEN OTHERS THEN
               V_ENTRA := 0;
               END;

               IF V_ENTRA > 0 THEN

                 FOR X IN (

                   SELECT  TZFACCE_PIDM,
                           TZFACCE_DETAIL_CODE,
                           TZFACCE_EFFECTIVE_DATE,
                           TZFACCE_SEC_PIDM,
                           TZFACCE_FLAG,
                           TZFACCE_STUDY,
                           TZFACCE_TERM_CODE,
                           TZFACCE_USER,
                           TBBDETC_DESC,
                           TZFACCE_AMOUNT - NVL((SELECT NVL(
                                                            CASE
                                                              WHEN SWTMDAC_PERCENT_DESC IS NOT NULL THEN A.TZFACCE_AMOUNT*(SWTMDAC_PERCENT_DESC/100)
                                                            ELSE SWTMDAC_AMOUNT_DESC
                                                            END,0)
                                                   FROM SWTMDAC C
                                                  WHERE     C.SWTMDAC_PIDM = A.TZFACCE_PIDM
                                                        AND C.SWTMDAC_MASTER_IND = 'Y'
                                                        AND C.SWTMDAC_FLAG = 'Y'
                                                        AND C.SWTMDAC_APPLICATION_INDICATOR = 0
                                                        AND TRUNC(SYSDATE) BETWEEN TRUNC(C.SWTMDAC_EFFECTIVE_DATE_INI) AND TRUNC(C.SWTMDAC_EFFECTIVE_DATE_FIN)
                                                        AND C.SWTMDAC_NUM_REAPPLICATION > C.SWTMDAC_APPLICATION_INDICATOR
                                                        AND C.SWTMDAC_APPLICATION_DATE IS NULL
                                                        AND C.SWTMDAC_SEC_PIDM = (SELECT MIN (SWTMDAC_SEC_PIDM)
                                                                                     FROM SWTMDAC
                                                                                    WHERE SWTMDAC_PIDM = C.SWTMDAC_PIDM
                                                                                          AND SWTMDAC_DETAIL_CODE_ACC = C.SWTMDAC_DETAIL_CODE_ACC
                                                                                          AND SWTMDAC_MASTER_IND = 'Y'
                                                                                          AND SWTMDAC_FLAG = 'Y'
                                                                                          AND SWTMDAC_APPLICATION_INDICATOR = 0
                                                                                          AND TRUNC(SYSDATE) BETWEEN TRUNC(C.SWTMDAC_EFFECTIVE_DATE_INI)  AND  TRUNC(C.SWTMDAC_EFFECTIVE_DATE_FIN)
                                                                                          AND SWTMDAC_APPLICATION_DATE IS NULL
                                                                                          AND SWTMDAC_SEQNO_SERV IS NULL)
                                                        AND C.SWTMDAC_DETAIL_CODE_ACC = A.TZFACCE_DETAIL_CODE
                                                        AND C.SWTMDAC_DETAIL_CODE_ACC IN (SELECT ZSTPARA_PARAM_ID
                                                                                          FROM ZSTPARA
                                                                                         WHERE ZSTPARA_MAPA_ID = 'EX_DESACC')),0)TZFACCE_AMOUNT
                     FROM TZFACCE A,TBBDETC
                    WHERE     A.TZFACCE_DETAIL_CODE = TBBDETC_DETAIL_CODE
                          AND A.TZFACCE_PIDM = ALUMNO.PIDM
                          AND A.TZFACCE_USER = 'SV2A'
                          AND A.TZFACCE_FLAG = 0
                          AND SUBSTR(A.TZFACCE_DETAIL_CODE,3,2) NOT IN ('QI','NA')
                          AND SUBSTR(A.TZFACCE_DETAIL_CODE,3,2) NOT IN (SELECT ZSTPARA_PARAM_ID
                                                                          FROM ZSTPARA
                                                                         WHERE ZSTPARA_MAPA_ID = 'ACC_ALIANZA')
                          AND A.TZFACCE_SEC_PIDM IN (SELECT MAX(A1.TZFACCE_SEC_PIDM)
                                                       FROM TZFACCE A1
                                                      WHERE     A1.TZFACCE_PIDM = A.TZFACCE_PIDM
                                                            AND A1.TZFACCE_TERM_CODE = A.TZFACCE_TERM_CODE
                                                            AND A1.TZFACCE_FLAG = A.TZFACCE_FLAG
                                                            AND SUBSTR(A1.TZFACCE_DETAIL_CODE,3,2) NOT IN ('QI', 'NA')
                                                            AND A1.TZFACCE_DETAIL_CODE = A.TZFACCE_DETAIL_CODE)
                   And a.TZFACCE_DETAIL_CODE not in (select codigo from TZTINC) ---> Quita complemento 

                 )LOOP

                   VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);
                   VL_SECUENCIACOL := VL_SECUENCIA;

                   BEGIN
                     INSERT
                       INTO TBRACCD
                     VALUES (
                              ALUMNO.PIDM,   -- TBRACCD_PIDM
                              VL_SECUENCIACOL,     --TBRACCD_TRAN_NUMBER
                              ALUMNO.PERIODO,    -- TBRACCD_TERM_CODE
                              X.TZFACCE_DETAIL_CODE,--vp_inscrip_code,     ---TBRACCD_DETAIL_CODE
                              USER,     ---TBRACCD_USER
                              SYSDATE,     --TBRACCD_ENTRY_DATE
                              NVL(X.TZFACCE_AMOUNT,0),
                              NVL(X.TZFACCE_AMOUNT,0),    ---TBRACCD_BALANCE
                              SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                              NULL,    --TBRACCD_BILL_DATE
                              NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                              X.TBBDETC_DESC,    -- TBRACCD_DESC
                              ALUMNO.FOLIO,     --TBRACCD_RECEIPT_NUMBER
                              NULL,     --TBRACCD_TRAN_NUMBER_PAID
                              NULL,     --TBRACCD_CROSSREF_PIDM
                              NULL,    --TBRACCD_CROSSREF_NUMBER
                              NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                              'T',    --TBRACCD_SRCE_CODE
                              'Y',    --TBRACCD_ACCT_FEED_IND
                              SYSDATE,  --TBRACCD_ACTIVITY_DATE
                              0,        --TBRACCD_SESSION_NUMBER
                              NULL,    -- TBRACCD_CSHR_END_DATE
                              NULL,     --TBRACCD_CRN
                              NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                              NULL,     -- TBRACCD_LOC_MDT
                              NULL,     --TBRACCD_LOC_MDT_SEQ
                              NULL,     -- TBRACCD_RATE
                              NULL,     --TBRACCD_UNITS
                              NULL,     -- TBRACCD_DOCUMENT_NUMBER
                              SYSDATE,  -- TBRACCD_TRANS_DATE
                              NULL,        -- TBRACCD_PAYMENT_ID
                              NULL,     -- TBRACCD_INVOICE_NUMBER
                              NULL,     -- TBRACCD_STATEMENT_DATE
                              NULL,     -- TBRACCD_INV_NUMBER_PAID
                              'MXN',     -- TBRACCD_CURR_CODE
                              NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                              NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                              NULL,     -- TBRACCD_LATE_DCAT_CODE
                              ALUMNO.FECHA_INICIO,     -- TBRACCD_FEED_DATE
                              NULL,     -- TBRACCD_FEED_DOC_CODE
                              NULL,     -- TBRACCD_ATYP_CODE
                              NULL,     -- TBRACCD_ATYP_SEQNO
                              NULL,     -- TBRACCD_CARD_TYPE_VR
                              NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                              NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                              NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                              NULL,     -- TBRACCD_ORIG_CHG_IND
                              NULL,     -- TBRACCD_CCRD_CODE
                              NULL,     -- TBRACCD_MERCHANT_ID
                              NULL,     -- TBRACCD_TAX_REPT_YEAR
                              NULL,     -- TBRACCD_TAX_REPT_BOX
                              NULL,     -- TBRACCD_TAX_AMOUNT
                              NULL,     -- TBRACCD_TAX_FUTURE_IND
                              'TZFEDCA(ACC)',     -- TBRACCD_DATA_ORIGIN
                              'TZFEDCA(ACC)',   -- TBRACCD_CREATE_SOURCE
                              NULL,     -- TBRACCD_CPDT_IND
                              NULL,     --TBRACCD_AIDY_CODE
                              ALUMNO.STUDY_PATH,     --TBRACCD_STSP_KEY_SEQUENCE
                              ALUMNO.PARTE_PERIODO,     --TBRACCD_PERIOD
                              NULL,    --TBRACCD_SURROGATE_ID
                              NULL,     -- TBRACCD_VERSION
                              USER,     --TBRACCD_USER_ID
                              NULL );     --TBRACCD_VPDI_CODE
                   EXCEPTION
                   WHEN OTHERS THEN
                   VL_ERROR := 'Se presento ERROR INSERT TBRACCD '||SQLERRM;
                   END;

                   BEGIN
                     UPDATE SATURN.TZFACCE
                        SET TZFACCE_FLAG = 1,
                           TZFACCE_USER = 'SV2A --1'
                      WHERE     TZFACCE_PIDM = ALUMNO.PIDM
                          --  AND TZFACCE_USER = 'SV2A'
                            AND TZFACCE_FLAG = 0
                            AND TZFACCE_DETAIL_CODE = X.TZFACCE_DETAIL_CODE;
                   END;

                 END LOOP;

               END IF;

               VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);

               VL_SECUENCIACOL := VL_SECUENCIA;

               VL_ERROR:= PKG_FINANZAS.F_INSERTA_TBRACCD(
                                             P_PIDM => ALUMNO.PIDM
                                           , P_SECUENCIA => VL_SECUENCIACOL--vl_secuencia
                                           , P_NUMBER_PAID => NULL
                                           , P_PERIODO => ALUMNO.PERIODO
                                           , P_PARTE_PERIODO => ALUMNO.PARTE_PERIODO
                                           , P_CODIGO => VL_CODIGO
                                           , P_MONTO => VL_COLEGIATURA--vl_monto
                                           , P_BALANCE => VL_COLEGIATURA--vl_monto
                                           , P_FECHA_VENC => VD_FECHA_INICIO--sysdate
                                           , P_DESCRIP => VL_DESCRIPCION
                                           , P_STUDY_PATH => ALUMNO.STUDY_PATH
                                           , P_ORIGEN => 'TZFEDCA (COL)'
                                           , P_FECHA_INICIO => ALUMNO.FECHA_INICIO) ;

               VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;

               IF VL_ERROR IS NULL  THEN

                 VL_CODIGO := NULL;
                 VL_DESCRIPCION := NULL;
                 VL_MONTO := VL_COLEGIATURA;
                 VL_SECUENCIA :=0;
                 VL_MONTO_PERCENT := 0;
                 VL_MONTO_AMOUNT := 0;
                 VL_TRAN_NUM :=VL_SECUENCIACOL;

                 VN_EXISTE_DSP:=0;

                 BEGIN
                   SELECT DISTINCT TBBDETC_DETAIL_CODE,TBBDETC_DESC, TBREDET_DETAIL_CODE,TBREDET_PERCENT,TBREDET_MAX_AMOUNT,TBBESTU_EXEMPTION_CODE
                     INTO VL_CODIGO,VL_DESCRIPCION, VL_CODIGO_AFEC, VL_MONTO_PERCENT, VL_MONTO_AMOUNT,VL_CODEXEMTION
                     FROM TBBEXPT, TBBESTU A, TBBDETC, TBREDET
                    WHERE     TBBDETC_DETAIL_CODE = TBBEXPT_DETAIL_CODE
                          AND TBBDETC_TAXT_CODE = ALUMNO.NIVEL
                          AND A.TBBESTU_EXEMPTION_CODE  = TBBEXPT_EXEMPTION_CODE
                          AND A.TBBESTU_TERM_CODE         = TBBEXPT_TERM_CODE
                          AND A.TBBESTU_STUDENT_EXPT_ROLL_IND= 'Y'
                          AND A.TBBESTU_DEL_IND IS NULL
                          AND TBREDET_EXEMPTION_CODE = TBBEXPT_EXEMPTION_CODE
                          AND TBREDET_TERM_CODE = TBBEXPT_TERM_CODE
                          AND A.TBBESTU_TERM_CODE = (SELECT MAX(A1.TBBESTU_TERM_CODE)
                                                       FROM TBBESTU A1,TBBEXPT,TBREDET,TBBDETC
                                                      WHERE     A1.TBBESTU_PIDM = A.TBBESTU_PIDM
                                                            AND TBBDETC_DETAIL_CODE = TBBEXPT_DETAIL_CODE
                                                            AND TBBDETC_TAXT_CODE = ALUMNO.NIVEL
                                                            AND A1.TBBESTU_EXEMPTION_CODE  = TBBEXPT_EXEMPTION_CODE
                                                            AND A1.TBBESTU_TERM_CODE = TBBEXPT_TERM_CODE
                                                            AND TBREDET_EXEMPTION_CODE = TBBEXPT_EXEMPTION_CODE
                                                            AND TBREDET_TERM_CODE = TBBEXPT_TERM_CODE
                                                            AND A1.TBBESTU_STUDENT_EXPT_ROLL_IND = 'Y'
                                                            AND A1.TBBESTU_DEL_IND IS NULL
                                                            AND A1.TBBESTU_TERM_CODE <= ALUMNO.PERIODO)
                          AND A.TBBESTU_EXEMPTION_PRIORITY = (SELECT MAX(B1.TBBESTU_EXEMPTION_PRIORITY)
                                                                FROM TBBESTU B1,TBBEXPT,TBREDET,TBBDETC
                                                               WHERE     B1.TBBESTU_PIDM = A.TBBESTU_PIDM
                                                                     AND TBBDETC_DETAIL_CODE = TBBEXPT_DETAIL_CODE
                                                                     AND TBBDETC_TAXT_CODE = ALUMNO.NIVEL
                                                                     AND B1.TBBESTU_EXEMPTION_CODE  = TBBEXPT_EXEMPTION_CODE
                                                                     AND B1.TBBESTU_TERM_CODE = TBBEXPT_TERM_CODE
                                                                     AND TBREDET_EXEMPTION_CODE = TBBEXPT_EXEMPTION_CODE
                                                                     AND TBREDET_TERM_CODE = TBBEXPT_TERM_CODE
                                                                     AND B1.TBBESTU_STUDENT_EXPT_ROLL_IND = 'Y'
                                                                     AND B1.TBBESTU_DEL_IND IS NULL
                                                                     AND B1.TBBESTU_TERM_CODE = (SELECT MAX(B2.TBBESTU_TERM_CODE)
                                                                                                   FROM TBBESTU B2,TBBEXPT,TBREDET,TBBDETC
                                                                                                  WHERE     B2.TBBESTU_PIDM = A.TBBESTU_PIDM
                                                                                                        AND TBBDETC_DETAIL_CODE = TBBEXPT_DETAIL_CODE
                                                                                                        AND TBBDETC_TAXT_CODE = ALUMNO.NIVEL
                                                                                                        AND B2.TBBESTU_EXEMPTION_CODE  = TBBEXPT_EXEMPTION_CODE
                                                                                                        AND B2.TBBESTU_TERM_CODE = TBBEXPT_TERM_CODE
                                                                                                        AND TBREDET_EXEMPTION_CODE = TBBEXPT_EXEMPTION_CODE
                                                                                                        AND TBREDET_TERM_CODE = TBBEXPT_TERM_CODE
                                                                                                        AND B2.TBBESTU_STUDENT_EXPT_ROLL_IND = 'Y'
                                                                                                        AND B2.TBBESTU_DEL_IND IS NULL
                                                                                                        AND B2.TBBESTU_TERM_CODE <= ALUMNO.PERIODO))
                          AND TBBESTU_PIDM = ALUMNO.PIDM
                          AND TBBDETC_DCAT_CODE = 'DSP';

                   VN_EXISTE_DSP:=1;

                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_ERROR :='Error al buscar el descuento DSP : ' ||SQLERRM;
                 VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;
                 VL_CODIGO := NULL;
                 VL_DESCRIPCION := NULL;
                 VL_CODIGO_AFEC := NULL;
                 VL_MONTO_PERCENT := NULL;
                 VL_MONTO_AMOUNT := NULL;
                 VL_TRAN_NUM :=NULL;
                 VL_TRAN_NUM :=VL_SECUENCIACOL;
                 VN_EXISTE_DSP:=0;
                 END;

                 BEGIN
                   SELECT COUNT(*)
                     INTO VL_ENTDESC
                     FROM TBBESTU
                    WHERE     TBBESTU_PIDM = ALUMNO.PIDM
                          AND TBBESTU_TERM_CODE = ALUMNO.PERIODO;
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_ENTDESC:=0;
                 END;

                 IF VL_ENTDESC = 0 THEN

                   BEGIN
                       INSERT
                         INTO TBBESTU
                       VALUES(VL_CODEXEMTION,
                              ALUMNO.PIDM,
                              ALUMNO.PERIODO,
                              SYSDATE,
                              NULL,
                              'Y',
                              NULL,
                              USER,
                              1,
                              NULL,
                              NULL,
                              NULL,
                              'EDCA',
                              NULL);
                   EXCEPTION
                   WHEN OTHERS THEN
                   NULL;
                   END;

                 END IF;

                 IF     VL_CODIGO IS NOT NULL
                    AND VL_DESCRIPCION IS NOT NULL
                    AND VL_CODIGO_AFEC IS NOT NULL
                    AND (    VL_MONTO_PERCENT IS NOT NULL
                          OR VL_MONTO_AMOUNT IS NOT NULL) THEN

                   IF VL_MONTO_PERCENT IS NOT NULL THEN

                     VL_DESCUENTO := (VL_COLEGIATURA*(VL_MONTO_PERCENT/100));

                   ELSIF VL_MONTO_AMOUNT IS NOT NULL THEN

                     VL_DESCUENTO := VL_MONTO_AMOUNT + (VL_MONTO_AMOUNT*(VN_PORC_INCREM/100));

                     IF ALUMNO.NUM_PAGOS = 4 AND ALUMNO.PERIODICIDAD =  'Bime' THEN
                       VL_DESCUENTO:= VL_DESCUENTO/2;
                     END IF;

                   END IF;

                    vl_monto_tyc:=0;
                    vl_porcentaje_tyc:=null;
                    
                    Begin
                        Select MONTO_BECA_N, porcentaje 
                         Into vl_monto_tyc, vl_porcentaje_tyc
                        from BECA_TYC
                        where 1=1
                        And PIDM = ALUMNO.PIDM
                        And sp = ALUMNO.STUDY_PATH
                        And fecha_inicio = ALUMNO.FECHA_INICIO
                        And pidm not in (select goradid_pidm  from goradid DDBE where GORADID_ADID_CODE = 'DDBE');
                    Exception
                        When Others then 
                        vl_monto_tyc:=0;
                        vl_porcentaje_tyc:= null;
                    End;
                    
                    If vl_monto_tyc > 0 then 
                    
                        VL_DESCUENTO:=VL_DESCUENTO -  vl_monto_tyc;
                        
                        VL_ERROR:= pkg_utilerias.F_Genera_Etiqueta(ALUMNO.PIDM, 
                                                                   'DDBE', 
                                                                   'REDUCCION DE BECA $' ||vl_monto_tyc ||' % '||vl_porcentaje_tyc , 
                                                                   user);

                        
                    End if;


                   VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);

                   VL_ERROR:= PKG_FINANZAS.F_INSERTA_TBRACCD(
                                                 P_PIDM => ALUMNO.PIDM
                                               , P_SECUENCIA => VL_SECUENCIA
                                               , P_NUMBER_PAID => VL_SECUENCIACOL--vl_tran_num
                                               , P_PERIODO => ALUMNO.PERIODO
                                               , P_PARTE_PERIODO => ALUMNO.PARTE_PERIODO
                                               , P_CODIGO => VL_CODIGO
                                               , P_MONTO => VL_DESCUENTO
                                               , P_BALANCE => VL_DESCUENTO*-1
                                               , P_FECHA_VENC => VD_FECHA_INICIO--sysdate
                                               , P_DESCRIP => VL_DESCRIPCION
                                               , P_STUDY_PATH => ALUMNO.STUDY_PATH
                                               , P_ORIGEN => 'TZFEDCA (DSP)'
                                               ,P_FECHA_INICIO => ALUMNO.FECHA_INICIO) ;

                   VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;

                 END IF;

                 VL_VUELTA :=0;
                 VL_CODIGO := NULL;
                 VL_DESCRIPCION := NULL;
                 VL_MONTO := NULL;
                 VL_DESCUENTODSI:=0;


                 BEGIN
                   FOR DESCU IN (
                               SELECT TBRACCD_DETAIL_CODE ,  TBRACCD_DESC, TBRACCD_AMOUNT, MAX(A.TBRACCD_TRAN_NUMBER)
                                 FROM TBRACCD A
                                WHERE     A.TBRACCD_PIDM = ALUMNO.PIDM
                                      AND A.TBRACCD_DETAIL_CODE  IN (SELECT SUBSTR (ALUMNO.MATRICULA, 1, 2)||ZSTPARA_PARAM_VALOR
                                                                       FROM ZSTPARA
                                                                      WHERE     ZSTPARA_MAPA_ID='DET_CODE_CART'
                                                                            AND ZSTPARA_PARAM_ID= 'PARC_ANT_DSI')
                                      AND A.TBRACCD_AMOUNT >0
                                      AND A.TBRACCD_TRAN_NUMBER NOT IN ( SELECT TBRACCD_TRAN_NUMBER
                                                                           FROM TBRACCD, TBBDETC
                                                                          WHERE     TBRACCD_PIDM = A.TBRACCD_PIDM--p_pidm
                                                                                AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                AND TBBDETC_TYPE_IND = 'C'
                                                                                AND TBRACCD_AMOUNT < 0
                                                                          UNION
                                                                         SELECT TBRAPPL_CHG_TRAN_NUMBER
                                                                           FROM TBRAPPL,TBRACCD
                                                                          WHERE     TBRACCD_PIDM = A.TBRACCD_PIDM
                                                                                AND TBRAPPL_PIDM= TBRACCD_PIDM
                                                                                AND TBRAPPL_REAPPL_IND IS NULL
                                                                                AND TBRAPPL_PAY_TRAN_NUMBER IN ( SELECT TBRACCD_TRAN_NUMBER
                                                                                                                   FROM TBRACCD, TBBDETC
                                                                                                                  WHERE     TBRACCD_PIDM = A.TBRACCD_PIDM--p_pidm
                                                                                                                        AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                                                        AND TBBDETC_TYPE_IND = 'C'
                                                                                                                        AND TBRACCD_AMOUNT < 0)
                                                                          UNION
                                                                         SELECT TBRACCD_TRAN_NUMBER_PAID
                                                                           FROM TBRACCD, TBBDETC
                                                                          WHERE     TBRACCD_PIDM = A.TBRACCD_PIDM
                                                                                AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                AND TBBDETC_TYPE_IND = 'C'
                                                                                AND TBRACCD_AMOUNT < 0)
                                      AND A.TBRACCD_TERM_CODE = (SELECT MAX (A1.TBRACCD_TERM_CODE)
                                                                   FROM TBRACCD A1
                                                                  WHERE A.TBRACCD_PIDM = A1.TBRACCD_PIDM
                                                                     AND A.TBRACCD_DETAIL_CODE = A1.TBRACCD_DETAIL_CODE
                                                                     AND A.TBRACCD_AMOUNT >0
                                                                     AND TBRACCD_TRAN_NUMBER NOT IN ( SELECT TBRACCD_TRAN_NUMBER
                                                                                                        FROM TBRACCD, TBBDETC
                                                                                                       WHERE     TBRACCD_PIDM = A.TBRACCD_PIDM--p_pidm
                                                                                                             AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                                             AND TBBDETC_TYPE_IND = 'C'
                                                                                                             AND TBRACCD_AMOUNT < 0
                                                                                                       UNION
                                                                                                      SELECT TBRAPPL_CHG_TRAN_NUMBER
                                                                                                        FROM TBRAPPL,TBRACCD
                                                                                                       WHERE     TBRACCD_PIDM = A.TBRACCD_PIDM
                                                                                                             AND TBRAPPL_PIDM= TBRACCD_PIDM
                                                                                                             AND TBRAPPL_REAPPL_IND IS NULL
                                                                                                             AND TBRAPPL_PAY_TRAN_NUMBER IN ( SELECT TBRACCD_TRAN_NUMBER
                                                                                                                                                FROM TBRACCD, TBBDETC
                                                                                                                                               WHERE     TBRACCD_PIDM = A.TBRACCD_PIDM--p_pidm
                                                                                                                                                     AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                                                                                     AND TBBDETC_TYPE_IND = 'C'
                                                                                                                                                     AND TBRACCD_AMOUNT < 0)
                                                                                                       UNION
                                                                                                      SELECT TBRACCD_TRAN_NUMBER_PAID
                                                                                                        FROM TBRACCD, TBBDETC
                                                                                                       WHERE     TBRACCD_PIDM = A.TBRACCD_PIDM--p_pidm
                                                                                                             AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                                             AND TBBDETC_TYPE_IND = 'C'
                                                                                                             AND TBRACCD_AMOUNT < 0))
                                     GROUP BY TBRACCD_DETAIL_CODE,TBRACCD_DESC,TBRACCD_AMOUNT
                                     ORDER BY 4 DESC
                     )LOOP

                       VL_VUELTA :=  1;
                       VL_CODIGO:= DESCU.TBRACCD_DETAIL_CODE;
                       VL_DESCRIPCION := DESCU.TBRACCD_DESC;
                       VL_DESCUENTODSI := DESCU.TBRACCD_AMOUNT;

                       IF VL_VUELTA = 1 THEN
                         EXIT;
                       END IF;

                     END LOOP;
                 END;

                 VL_VUELTA :=0;

                 BEGIN
                   SELECT SUBSTR(TZDOCTR_RATE_CODE,3,1)
                     INTO VL_PAGO_ANTERIOR
                     FROM TZDOCTR TR
                    WHERE     TR.TZDOCTR_PIDM = ALUMNO.PIDM
                          AND TR.TZDOCTR_START_DATE != ALUMNO.FECHA_INICIO
                          AND TR.TZDOCTR_TERM_CODE = (SELECT MAX(TR1.TZDOCTR_TERM_CODE)
                                                        FROM TZDOCTR TR1
                                                       WHERE     TR1.TZDOCTR_PIDM = TR.TZDOCTR_PIDM
                                                             AND TR1.TZDOCTR_START_DATE != ALUMNO.FECHA_INICIO
                                                             AND TR1.TZDOCTR_TIPO_PROC != 'AUME')
                          AND TR.TZDOCTR_TIPO_PROC != 'AUME'
                          AND TR.TZDOCTR_STYP_CODE IN ('N','F');
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_PAGO_ANTERIOR:= 4;
                 END;

--                 DBMS_OUTPUT.PUT_LINE('SE VALIDA PARAMETROS PARA CALCULO DE DSI = '||ALUMNO.STUDY_PATH||' = '||
--                                                                                     ALUMNO.PERIODO||' = '||
--                                                                                     ALUMNO.PROGRAMA||' = '||
--                                                                                     ALUMNO.NIVEL||' = '||
--                                                                                     ALUMNO.CAMPUS
--                                                                                     );

                 BEGIN
                   SELECT DISTINCT TZTDMTO_MONTO  ,TZTDMTO_DESC_CODE , TZTDMTO_OBSERVACIONES
                     INTO VL_DESCUENTODSI, VL_CODIGO2,VL_DESCRIPCION
                     FROM TZTDMTO A
                    WHERE     A.TZTDMTO_PIDM = ALUMNO.PIDM
                          AND A.TZTDMTO_CAMP_CODE = ALUMNO.CAMPUS
                          AND A.TZTDMTO_NIVEL = ALUMNO.NIVEL
                          AND A.TZTDMTO_PROGRAMA = ALUMNO.PROGRAMA
                          AND A.TZTDMTO_TERM_CODE = ALUMNO.PERIODO
                          AND A.TZTDMTO_STUDY_PATH = ALUMNO.STUDY_PATH
                          AND A.TZTDMTO_DESC_CODE IS NOT NULL
                          AND A.TZTDMTO_MONTO = (SELECT MAX (TZTDMTO_MONTO)
                                                   FROM TZTDMTO A1
                                                  WHERE     A1.TZTDMTO_PIDM = A.TZTDMTO_PIDM
                                                        AND A1.TZTDMTO_CAMP_CODE = A.TZTDMTO_CAMP_CODE
                                                        AND A1.TZTDMTO_NIVEL = A.TZTDMTO_NIVEL
                                                        AND A1.TZTDMTO_TERM_CODE = A.TZTDMTO_TERM_CODE
                                                        AND A1.TZTDMTO_IND = 1
                                                        AND A1.TZTDMTO_DESC_CODE IS NOT NULL
                                                        AND TZTDMTO_STUDY_PATH = ALUMNO.STUDY_PATH
                                                        AND A1.TZTDMTO_PROGRAMA = A.TZTDMTO_PROGRAMA)
                          AND TZTDMTO_IND = 1 ;

                   VL_DESCUENTODSI := VL_DESCUENTODSI + (VL_DESCUENTODSI*(VN_PORC_INCREM/100));

                 EXCEPTION WHEN OTHERS THEN
                 VL_DESCUENTODSI  := 0;
                 BANDERADSI  := 0;

                 END;

             --    DBMS_OUTPUT.PUT_LINE('RESULTADO DE CALCULO DE DSI = '||VL_DESCUENTODSI||' = '||VL_CODIGO2||' = '||VL_DESCRIPCION);

                 IF VL_PAGO_ANTERIOR IN (2,3,5,6,7) AND ALUMNO.PERIODICIDAD !='Bime'
                     AND ALUMNO.TIPO_ALUMNO IN ('N','C','F')
                     AND VL_PAGO_ANTERIOR !=  ALUMNO.NUM_PAGOS
                     AND VL_DESCUENTODSI != 0 THEN

                      VL_DESCUENTODSI:=VL_DESCUENTODSI/VL_PAGO_ANTERIOR;

                      VL_DESCUENTODSI:=VL_DESCUENTODSI*4;

                   BEGIN
                     UPDATE TZTDMTO
                        SET TZTDMTO_MONTO = VL_DESCUENTODSI
                      WHERE     TZTDMTO_PIDM   = ALUMNO.PIDM
                            AND TZTDMTO_CAMP_CODE = ALUMNO.CAMPUS
                            AND TZTDMTO_NIVEL  = ALUMNO.NIVEL
                            AND TZTDMTO_PROGRAMA =  ALUMNO.PROGRAMA
                            AND TZTDMTO_TERM_CODE  = ALUMNO.PERIODO;
                   END;

                 END IF;

                 IF VL_DESCUENTODSI = 0 AND BANDERADSI = 0 THEN

                   BEGIN
                     SELECT TBRACCD_DETAIL_CODE,TBRACCD_DESC,TBRACCD_AMOUNT
                       INTO VL_CODIGO2,VL_DESCRIPCION,VL_DESCUENTODSI
                       FROM TBRACCD A
                      WHERE     A.TBRACCD_PIDM = ALUMNO.PIDM
                            AND A.TBRACCD_DETAIL_CODE = VL_CODIGO
                            AND A.TBRACCD_TRAN_NUMBER = (SELECT MAX(A1.TBRACCD_TRAN_NUMBER)
                                                           FROM TBRACCD A1
                                                          WHERE     A1.TBRACCD_PIDM = A.TBRACCD_PIDM
                                                                AND A1.TBRACCD_DETAIL_CODE = A.TBRACCD_DETAIL_CODE);

                     VL_DESCUENTODSI := VL_DESCUENTODSI + (VL_DESCUENTODSI*(VN_PORC_INCREM/100));
                     BANDERADSI := VL_DESCUENTODSI;

                   EXCEPTION WHEN OTHERS THEN
                   VL_DESCUENTODSI  := 0;
                   BANDERADSI  := 0;
                   END;

                   IF     VL_PAGO_ANTERIOR IN (1,4)
                      AND ALUMNO.TIPO_ALUMNO IN ('N','C','F')
                      AND BANDERADSI != 0 THEN

                     BEGIN
                       INSERT
                         INTO TZTDMTO
                       VALUES(ALUMNO.MATRICULA,
                              ALUMNO.PIDM,
                              ALUMNO.CAMPUS,
                              ALUMNO.NIVEL,
                              ALUMNO.PROGRAMA,
                              ALUMNO.PERIODO ,
                              VL_CODIGO2 ,
                              NULL,
                              VL_DESCUENTODSI,
                              ALUMNO.STUDY_PATH,
                              1,
                              SYSDATE,
                              VL_DESCRIPCION,
                              null);
                     END;

                   END IF;

                   IF     VL_PAGO_ANTERIOR IN (2,3,5,6,7)
                      AND ALUMNO.PERIODICIDAD !='Bime'
                      AND ALUMNO.TIPO_ALUMNO IN ('N','C','F')
                      AND BANDERADSI != 0 THEN

                     VL_DESCUENTODSI:=VL_DESCUENTODSI/VL_PAGO_ANTERIOR;

                     VL_DESCUENTODSI:=VL_DESCUENTODSI*4;

                     BEGIN
                       INSERT
                         INTO TZTDMTO
                       VALUES(ALUMNO.MATRICULA,
                              ALUMNO.PIDM,
                              ALUMNO.CAMPUS,
                              ALUMNO.NIVEL,
                              ALUMNO.PROGRAMA,
                              ALUMNO.PERIODO ,
                              VL_CODIGO2 ,
                              NULL,
                              VL_DESCUENTODSI,
                              ALUMNO.STUDY_PATH,
                              1,
                              SYSDATE,
                              VL_DESCRIPCION,
                              null);

                     END;

                   END IF;

                   IF ALUMNO.TIPO_ALUMNO IN ('N','C','F') THEN

                     IF ALUMNO.NUM_PAGOS = 4 AND ALUMNO.PERIODICIDAD =  'Bime' THEN
                       VL_DESCUENTODSI:= VL_DESCUENTODSI*2;
                     END IF;

                   END IF;

                 END IF;

                 VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);

                 IF ALUMNO.TIPO_ALUMNO IN ('N','C','F') THEN

                   IF ALUMNO.NUM_PAGOS = 4 AND ALUMNO.PERIODICIDAD =  'Bime' THEN
                        VL_DESCUENTODSI:= VL_DESCUENTODSI/2;
                   END IF;

                 END IF;

                 BANDERADSI := VL_DESCUENTODSI;

                 IF ALUMNO.NUM_PAGOS = 4 AND ALUMNO.PERIODICIDAD =  'Bime' THEN
                         VN_NUM_PAGOS:= ALUMNO.NUM_PAGOS/2;
                 ELSE
                        VN_NUM_PAGOS:= ALUMNO.NUM_PAGOS;
                 END IF;

                 IF BANDERADSI > 0 THEN

                   IF VL_DESCUENTODSI != 0 THEN

                     VL_PLAN_PAGO := VL_COLEGIATURA - (NVL(VL_DESCUENTO,0)+NVL(VL_DESCUENTODSI,0));

                     VL_PARCIALIDAD := ROUND(VL_PLAN_PAGO/VN_NUM_PAGOS);

                     VL_PLAN_PAGO:= VL_PARCIALIDAD*VN_NUM_PAGOS;

                     VL_DIF_DSI := NVL(VL_COLEGIATURA - VL_PLAN_PAGO - (NVL(ROUND(VL_DESCUENTO),0))-NVL(VL_DESCUENTODSI,0),0);

                     VL_DESCUENTODSI:= VL_DIF_DSI+VL_DESCUENTODSI;

                   END IF;

                   VL_ERROR:=PKG_FINANZAS.F_INSERTA_TBRACCD(
                                               P_PIDM => ALUMNO.PIDM
                                             , P_SECUENCIA => VL_SECUENCIA
                                             , P_NUMBER_PAID => VL_SECUENCIACOL--vl_tran_num
                                             , P_PERIODO => ALUMNO.PERIODO
                                             , P_PARTE_PERIODO => ALUMNO.PARTE_PERIODO
                                             , P_CODIGO => VL_CODIGO2
                                             , P_MONTO => VL_DESCUENTODSI
                                             , P_BALANCE => VL_DESCUENTODSI*-1
                                             , P_FECHA_VENC => VD_FECHA_INICIO--sysdate
                                             , P_DESCRIP => VL_DESCRIPCION
                                             , P_STUDY_PATH => ALUMNO.STUDY_PATH
                                             , P_ORIGEN => 'TZFEDCA (DSI)'
                                             , P_FECHA_INICIO => ALUMNO.FECHA_INICIO) ;

                   VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;

                 ELSIF BANDERADSI < 0 THEN

                   IF ALUMNO.NUM_PAGOS = 4 AND ALUMNO.PERIODICIDAD =  'Bime' THEN
                            VN_NUM_PAGOS:= ALUMNO.NUM_PAGOS/2;
                   ELSE
                           VN_NUM_PAGOS:= ALUMNO.NUM_PAGOS;
                   END IF;

                 END IF;

                 VL_CODIGO := NULL;
                 VL_DESCRIPCION := NULL;

                 BEGIN
                   SELECT DISTINCT ZSTPARA_PARAM_VALOR
                     INTO VL_LPC
                     FROM ZSTPARA
                    WHERE     ZSTPARA_MAPA_ID = 'PLPA_CAMP'
                          AND ZSTPARA_PARAM_ID =  SUBSTR(ALUMNO.PERIODO,1,2);
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_LPC:= NULL;
                 END;

                 IF VL_LPC IS NULL THEN

                   BEGIN
                     SELECT TBBDETC_DETAIL_CODE, TBBDETC_DESC
                       INTO VL_CODIGO, VL_DESCRIPCION
                       FROM TBBDETC
                      WHERE     TBBDETC_DCAT_CODE = 'LPC'
                            AND TBBDETC_DETAIL_CODE = 'PLPA'
                            AND TBBDETC_DETC_ACTIVE_IND = 'Y';
                   EXCEPTION
                   WHEN OTHERS THEN
                       VL_CODIGO := NULL;
                       VL_DESCRIPCION := NULL;
                   END;

                 ELSE

                   BEGIN
                     SELECT TBBDETC_DETAIL_CODE, TBBDETC_DESC
                       INTO VL_CODIGO, VL_DESCRIPCION
                       FROM TBBDETC
                      WHERE TBBDETC_DETAIL_CODE = VL_LPC;
                   EXCEPTION
                   WHEN OTHERS THEN
                   VL_CODIGO := NULL;
                   VL_DESCRIPCION := NULL;
                   END;

                 END IF;

                 VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);

                 VL_PLAN_PAGO := VL_COLEGIATURA - (NVL(VL_DESCUENTO,0)+NVL(VL_DESCUENTODSI,0));

                 VL_PARCIALIDAD := ROUND(VL_PLAN_PAGO/VN_NUM_PAGOS);

                 VL_PLAN_PAGO:= VL_PARCIALIDAD*VN_NUM_PAGOS;

                 IF VL_DESCUENTODSI = 0 THEN

                   VL_PLAN_PAGO := VL_COLEGIATURA - ROUND(NVL(VL_DESCUENTO,0));

                 END IF;

                 VL_ERROR:= PKG_FINANZAS.F_INSERTA_TBRACCD(
                                               P_PIDM => ALUMNO.PIDM
                                             , P_SECUENCIA => VL_SECUENCIA
                                             , P_NUMBER_PAID => VL_SECUENCIACOL--vl_tran_num
                                             , P_PERIODO => ALUMNO.PERIODO
                                             , P_PARTE_PERIODO => ALUMNO.PARTE_PERIODO
                                             , P_CODIGO => VL_CODIGO
                                             , P_MONTO => VL_PLAN_PAGO--vl_monto2
                                             , P_BALANCE => VL_PLAN_PAGO*-1 --vl_monto2*-1
                                             , P_FECHA_VENC => VD_FECHA_INICIO--sysdate
                                             , P_DESCRIP => VL_DESCRIPCION
                                             , P_STUDY_PATH => ALUMNO.STUDY_PATH
                                             , P_ORIGEN => 'TZFEDCA (PLPA)'
                                             , P_FECHA_INICIO => ALUMNO.FECHA_INICIO) ;

                 VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;
               END IF;

               IF VL_ERROR IS NULL  THEN

                 VL_CODIGO := NULL;
                 VL_DESCRIPCION := NULL;
                 VL_MONTO := 0;
                 VL_SECUENCIA :=0;
                 VL_NUM_PARC :=0;

                 VL_DIA := CASE SUBSTR(VL_SFRRGFE_RATE_CODE,4,1) WHEN 'A' THEN 15 WHEN 'B' THEN 30 WHEN 'C' THEN 10 END;
                 VL_MES :=SUBSTR (TO_CHAR(VD_FECHA_INICIO/*alumno.fecha_inicio*/, 'dd/mm/rrrr'), 4, 2);
                 VL_ANO :=SUBSTR (TO_CHAR(VD_FECHA_INICIO/*alumno.fecha_inicio*/, 'dd/mm/rrrr'), 7, 4);

                 IF SUBSTR (TO_CHAR(VD_FECHA_INICIO, 'dd/mm/rrrr'), 1, 2) >= 20 THEN
                   VL_MES:= VL_MES+1;
                 END IF;

                 IF VL_MES = '13' THEN
                   VL_MES := '01';
                   VL_ANO := VL_ANO +1;
                 ELSIF VL_MES = '14' THEN
                   VL_MES := '02';
                   VL_ANO := VL_ANO +1;
                 END IF;

                 BEGIN
                   SELECT TBBDETC_DETAIL_CODE, TBBDETC_DESC
                     INTO VL_CODIGO, VL_DESCRIPCION
                     FROM TBBDETC
                    WHERE     TBBDETC_DCAT_CODE = 'COL'
                          AND SUBSTR (TBBDETC_DETAIL_CODE, 1, 2 )  = SUBSTR (ALUMNO.PERIODO, 1, 2)
                          AND SUBSTR (TBBDETC_DETAIL_CODE,1,3) = SUBSTR (ALUMNO.PERIODO, 1, 2)||'N'
                          AND TBBDETC_DETC_ACTIVE_IND = 'Y'
                          AND TBBDETC_TAXT_CODE = ALUMNO.NIVEL;
                 EXCEPTION
                 WHEN OTHERS THEN

                   BEGIN
                     SELECT TBBDETC_DETAIL_CODE, TBBDETC_DESC
                       INTO VL_CODIGO, VL_DESCRIPCION
                       FROM TBBDETC
                      WHERE     TBBDETC_DCAT_CODE = 'COL'
                            AND SUBSTR (TBBDETC_DETAIL_CODE, 1, 2 )  = SUBSTR (ALUMNO.PERIODO, 1, 2)
                            AND TBBDETC_DETC_ACTIVE_IND = 'Y'
                            AND TBBDETC_DESC = ALUMNO.DEGC_CODE;
                   EXCEPTION
                   WHEN OTHERS THEN
                   VL_CODIGO := NULL;
                   VL_DESCRIPCION:= NULL;
                   END;

                 END;

                 IF ALUMNO.NUM_PAGOS = 4 AND ALUMNO.PERIODICIDAD =  'Bime' THEN
                   VN_NUM_PAGOS:= ALUMNO.NUM_PAGOS/2;
                 ELSE
                   VN_NUM_PAGOS:= ALUMNO.NUM_PAGOS;
                 END IF;

                 VL_PARCIALIDAD := (VL_PLAN_PAGO/VN_NUM_PAGOS);

                 VL_PARC_ANTE:=VL_PARCIALIDAD;

                 VL_BESP:= PKG_FINANZAS.F_INSERT_TZTBESP ( ALUMNO.PIDM,
                                                           ALUMNO.MATRICULA,
                                                           ALUMNO.ESTATUS,
                                                           VL_PARCIALIDAD );

                 FOR I IN 1..VN_NUM_PAGOS LOOP

                   IF VL_DIA = '30' THEN
                     VL_VENCIMIENTO := CASE LPAD(VL_MES,2,'0') WHEN '02' THEN '28' ELSE VL_DIA END||'/'||LPAD(VL_MES,2,'0')||'/'||VL_ANO;
                   ELSE
                     VL_VENCIMIENTO := VL_DIA||'/'||LPAD(VL_MES,2,'0')||'/'||VL_ANO;
                   END IF;

                   V_ENTRA:= NULL;

                   BEGIN
                     SELECT COUNT(*)
                       INTO V_ENTRA
                       FROM TZFACCE
                      WHERE     TZFACCE_PIDM = ALUMNO.PIDM
                            AND TZFACCE_USER = 'REZA'
                            AND TZFACCE_FLAG = 0
                            AND LAST_DAY(TZFACCE_EFFECTIVE_DATE) = LAST_DAY(TO_DATE(VL_VENCIMIENTO,'DD,MM,YYYY'));
                   EXCEPTION
                   WHEN OTHERS THEN
                   V_ENTRA := 0;
                   END;

                   IF V_ENTRA > 0 THEN
                 --  DBMS_OUTPUT.PUT_LINE('Vencimiento:'||VL_VENCIMIENTO);

                     FOR X IN (
                               SELECT DISTINCT TZFACCE_DETAIL_CODE,TZFACCE_AMOUNT,TZFACCE_EFFECTIVE_DATE,TBBDETC_DESC,TZFACCE_STUDY,TBBDETC_TYPE_IND
                                 FROM TZFACCE A,TBBDETC
                                WHERE     A.TZFACCE_DETAIL_CODE = TBBDETC_DETAIL_CODE
                                      AND A.TZFACCE_PIDM = ALUMNO.PIDM
                                      AND A.TZFACCE_USER = 'REZA'
                                      AND A.TZFACCE_FLAG = 0
                                      AND LAST_DAY(A.TZFACCE_EFFECTIVE_DATE) = LAST_DAY(TO_DATE(VL_VENCIMIENTO,'DD,MM,YYYY'))
                                      AND A.TZFACCE_SEC_PIDM IN (SELECT MAX(A1.TZFACCE_SEC_PIDM)
                                                                   FROM TZFACCE A1
                                                                  WHERE     A1.TZFACCE_PIDM = A.TZFACCE_PIDM
                                                                        AND A1.TZFACCE_TERM_CODE = A.TZFACCE_TERM_CODE
                                                                        AND A1.TZFACCE_FLAG = A.TZFACCE_FLAG
                                                                        AND LAST_DAY(A1.TZFACCE_EFFECTIVE_DATE) = LAST_DAY(TO_DATE(VL_VENCIMIENTO,'DD,MM,YYYY'))
                                                                        AND A1.TZFACCE_DETAIL_CODE = A.TZFACCE_DETAIL_CODE)
                                And a.TZFACCE_DETAIL_CODE not in (select codigo from TZTINC) ---> Quita complemento
                                ORDER BY TBBDETC_TYPE_IND ASC

                     )LOOP

                       VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);
                       VL_SECUENCIACOL := VL_SECUENCIA;

                       IF X.TBBDETC_TYPE_IND = 'C' THEN

                         BEGIN
                           INSERT
                             INTO TBRACCD
                           VALUES (
                                   ALUMNO.PIDM,   -- TBRACCD_PIDM
                                   VL_SECUENCIACOL,     --TBRACCD_TRAN_NUMBER
                                   ALUMNO.PERIODO,    -- TBRACCD_TERM_CODE
                                   X.TZFACCE_DETAIL_CODE,--vp_inscrip_code,     ---TBRACCD_DETAIL_CODE
                                   USER,     ---TBRACCD_USER
                                   SYSDATE,     --TBRACCD_ENTRY_DATE
                                   NVL(X.TZFACCE_AMOUNT,0),
                                   NVL(X.TZFACCE_AMOUNT,0),    ---TBRACCD_BALANCE
                                   TO_DATE(VL_VENCIMIENTO,'DD,MM,YYYY'),     -- TBRACCD_EFFECTIVE_DATE
                                   NULL,    --TBRACCD_BILL_DATE
                                   NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                                   X.TBBDETC_DESC,    -- TBRACCD_DESC
                                   ALUMNO.FOLIO,     --TBRACCD_RECEIPT_NUMBER
                                   NULL,     --TBRACCD_TRAN_NUMBER_PAID
                                   NULL,     --TBRACCD_CROSSREF_PIDM
                                   NULL,    --TBRACCD_CROSSREF_NUMBER
                                   NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                                   'T',    --TBRACCD_SRCE_CODE
                                   'Y',    --TBRACCD_ACCT_FEED_IND
                                   SYSDATE,  --TBRACCD_ACTIVITY_DATE
                                   0,        --TBRACCD_SESSION_NUMBER
                                   NULL,    -- TBRACCD_CSHR_END_DATE
                                   NULL,     --TBRACCD_CRN
                                   NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                                   NULL,     -- TBRACCD_LOC_MDT
                                   NULL,     --TBRACCD_LOC_MDT_SEQ
                                   NULL,     -- TBRACCD_RATE
                                   NULL,     --TBRACCD_UNITS
                                   NULL,     -- TBRACCD_DOCUMENT_NUMBER
                                   TO_DATE(VL_VENCIMIENTO,'DD,MM,YYYY'),  -- TBRACCD_TRANS_DATE
                                   NULL,        -- TBRACCD_PAYMENT_ID
                                   NULL,     -- TBRACCD_INVOICE_NUMBER
                                   NULL,     -- TBRACCD_STATEMENT_DATE
                                   NULL,     -- TBRACCD_INV_NUMBER_PAID
                                   'MXN',     -- TBRACCD_CURR_CODE
                                   NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                                   NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                                   NULL,     -- TBRACCD_LATE_DCAT_CODE
                                   ALUMNO.FECHA_INICIO,     -- TBRACCD_FEED_DATE
                                   NULL,     -- TBRACCD_FEED_DOC_CODE
                                   NULL,     -- TBRACCD_ATYP_CODE
                                   NULL,     -- TBRACCD_ATYP_SEQNO
                                   NULL,     -- TBRACCD_CARD_TYPE_VR
                                   NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                                   NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                                   NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                                   NULL,     -- TBRACCD_ORIG_CHG_IND
                                   NULL,     -- TBRACCD_CCRD_CODE
                                   NULL,     -- TBRACCD_MERCHANT_ID
                                   NULL,     -- TBRACCD_TAX_REPT_YEAR
                                   NULL,     -- TBRACCD_TAX_REPT_BOX
                                   NULL,     -- TBRACCD_TAX_AMOUNT
                                   NULL,     -- TBRACCD_TAX_FUTURE_IND
                                   'TZFEDCA(ACC)',     -- TBRACCD_DATA_ORIGIN
                                   'TZFEDCA(ACC)',   -- TBRACCD_CREATE_SOURCE
                                   NULL,     -- TBRACCD_CPDT_IND
                                   NULL,     --TBRACCD_AIDY_CODE
                                   ALUMNO.STUDY_PATH,     --TBRACCD_STSP_KEY_SEQUENCE
                                   ALUMNO.PARTE_PERIODO,     --TBRACCD_PERIOD
                                   NULL,    --TBRACCD_SURROGATE_ID
                                   NULL,     -- TBRACCD_VERSION
                                   USER,     --TBRACCD_USER_ID
                                   NULL );     --TBRACCD_VPDI_CODE
                         EXCEPTION
                         WHEN OTHERS THEN
                         VL_ERROR := 'Se presento ERROR INSERT TBRACCD '||SQLERRM;
                         END;

                       ELSIF X.TBBDETC_TYPE_IND = 'P' THEN

                         BEGIN
                           INSERT
                             INTO TBRACCD
                           VALUES (
                                    ALUMNO.PIDM,   -- TBRACCD_PIDM
                                    VL_SECUENCIACOL,     --TBRACCD_TRAN_NUMBER
                                    ALUMNO.PERIODO,    -- TBRACCD_TERM_CODE
                                    X.TZFACCE_DETAIL_CODE,--vp_inscrip_code,     ---TBRACCD_DETAIL_CODE
                                    USER,     ---TBRACCD_USER
                                    SYSDATE,     --TBRACCD_ENTRY_DATE
                                    NVL(X.TZFACCE_AMOUNT,0),
                                    NVL(X.TZFACCE_AMOUNT,0)*-1,    ---TBRACCD_BALANCE
                                    TO_DATE(VL_VENCIMIENTO,'DD,MM,YYYY'),     -- TBRACCD_EFFECTIVE_DATE
                                    NULL,    --TBRACCD_BILL_DATE
                                    NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                                    X.TBBDETC_DESC,    -- TBRACCD_DESC
                                    ALUMNO.FOLIO,     --TBRACCD_RECEIPT_NUMBER
                                    VL_SECUENCIACOL+1,     --TBRACCD_TRAN_NUMBER_PAID
                                    NULL,     --TBRACCD_CROSSREF_PIDM
                                    NULL,    --TBRACCD_CROSSREF_NUMBER
                                    NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                                    'T',    --TBRACCD_SRCE_CODE
                                    'Y',    --TBRACCD_ACCT_FEED_IND
                                    SYSDATE,  --TBRACCD_ACTIVITY_DATE
                                    0,        --TBRACCD_SESSION_NUMBER
                                    NULL,    -- TBRACCD_CSHR_END_DATE
                                    NULL,     --TBRACCD_CRN
                                    NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                                    NULL,     -- TBRACCD_LOC_MDT
                                    NULL,     --TBRACCD_LOC_MDT_SEQ
                                    NULL,     -- TBRACCD_RATE
                                    NULL,     --TBRACCD_UNITS
                                    NULL,     -- TBRACCD_DOCUMENT_NUMBER
                                    TO_DATE(VL_VENCIMIENTO,'DD,MM,YYYY'),  -- TBRACCD_TRANS_DATE
                                    NULL,        -- TBRACCD_PAYMENT_ID
                                    NULL,     -- TBRACCD_INVOICE_NUMBER
                                    NULL,     -- TBRACCD_STATEMENT_DATE
                                    NULL,     -- TBRACCD_INV_NUMBER_PAID
                                    'MXN',     -- TBRACCD_CURR_CODE
                                    NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                                    NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                                    NULL,     -- TBRACCD_LATE_DCAT_CODE
                                    ALUMNO.FECHA_INICIO,     -- TBRACCD_FEED_DATE
                                    NULL,     -- TBRACCD_FEED_DOC_CODE
                                    NULL,     -- TBRACCD_ATYP_CODE
                                    NULL,     -- TBRACCD_ATYP_SEQNO
                                    NULL,     -- TBRACCD_CARD_TYPE_VR
                                    NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                                    NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                                    NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                                    NULL,     -- TBRACCD_ORIG_CHG_IND
                                    NULL,     -- TBRACCD_CCRD_CODE
                                    NULL,     -- TBRACCD_MERCHANT_ID
                                    NULL,     -- TBRACCD_TAX_REPT_YEAR
                                    NULL,     -- TBRACCD_TAX_REPT_BOX
                                    NULL,     -- TBRACCD_TAX_AMOUNT
                                    NULL,     -- TBRACCD_TAX_FUTURE_IND
                                    'TZFEDCA(ACC)',     -- TBRACCD_DATA_ORIGIN
                                    'TZFEDCA(ACC)',   -- TBRACCD_CREATE_SOURCE
                                    NULL,     -- TBRACCD_CPDT_IND
                                    NULL,     --TBRACCD_AIDY_CODE
                                    ALUMNO.STUDY_PATH,     --TBRACCD_STSP_KEY_SEQUENCE
                                    ALUMNO.PARTE_PERIODO,     --TBRACCD_PERIOD
                                    NULL,    --TBRACCD_SURROGATE_ID
                                    NULL,     -- TBRACCD_VERSION
                                    USER,     --TBRACCD_USER_ID
                                    NULL );     --TBRACCD_VPDI_CODE


                         EXCEPTION
                         WHEN OTHERS THEN
                         VL_ERROR := 'Se presento ERROR INSERT TBRACCD '||SQLERRM;
                         END;

                       END IF;

                       IF  VL_ERROR IS NULL THEN

                         UPDATE TZFACCE
                            SET TZFACCE_FLAG = 1,
                              TZFACCE_USER = 'REZA--2'
                          WHERE     TZFACCE_PIDM = ALUMNO.PIDM
                                AND TZFACCE_USER = 'REZA'
                                AND TZFACCE_FLAG = 0
                                AND TZFACCE_EFFECTIVE_DATE = X.TZFACCE_EFFECTIVE_DATE
                                AND TZFACCE_DETAIL_CODE = X.TZFACCE_DETAIL_CODE;

                       END IF;

                       BEGIN
                         Select count(*)
                            Into VL_ROLA_ACC
                         from TZTINC
                         Where campus = alumno.campus
                         And nivel = alumno.nivel
                         And codigo = x.TZFACCE_DETAIL_CODE ;
                       Exception
                        When OThers then
                          VL_ROLA_ACC:=0;
                       END;

                       IF VL_ROLA_ACC != 0 THEN

                         BEGIN

                           IF SUBSTR(ALUMNO.PERIODO,5,1) = 4 THEN

                             IF SUBSTR(ALUMNO.PERIODO,6,1) = 1 THEN

                               VL_NEWPERIODO:= SUBSTR(ALUMNO.PERIODO,1,5)||(SUBSTR(ALUMNO.PERIODO,6,1)+1);

                             ELSIF SUBSTR(ALUMNO.PERIODO,6,1) = 2 THEN

                               VL_NEWPERIODO:= SUBSTR(ALUMNO.PERIODO,1,5)||(SUBSTR(ALUMNO.PERIODO,6,1)+1);

                             ELSIF SUBSTR(ALUMNO.PERIODO,6,1) = 3 THEN

                               VL_NEWPERIODO:= SUBSTR(ALUMNO.PERIODO,1,2)||(SUBSTR(ALUMNO.PERIODO,3,2)+1||SUBSTR(ALUMNO.PERIODO,5,1)||1);

                             END IF;

                             BEGIN
                               SELECT
                                  CASE TO_NUMBER(SUBSTR(VL_VENCIMIENTO,4,2))+4
                                    WHEN 4  THEN (SUBSTR (VL_VENCIMIENTO,1,2)||'/04/'||(SUBSTR (VL_VENCIMIENTO,7,4)) )
                                    WHEN 5  THEN (SUBSTR (VL_VENCIMIENTO,1,2)||'/05/'||(SUBSTR (VL_VENCIMIENTO,7,4)) )
                                    WHEN 6  THEN (SUBSTR (VL_VENCIMIENTO,1,2)||'/06/'||(SUBSTR (VL_VENCIMIENTO,7,4)) )
                                    WHEN 7  THEN (SUBSTR (VL_VENCIMIENTO,1,2)||'/07/'||(SUBSTR (VL_VENCIMIENTO,7,4)) )
                                    WHEN 8  THEN (SUBSTR (VL_VENCIMIENTO,1,2)||'/08/'||(SUBSTR (VL_VENCIMIENTO,7,4)) )
                                    WHEN 9  THEN (SUBSTR (VL_VENCIMIENTO,1,2)||'/09/'||(SUBSTR (VL_VENCIMIENTO,7,4)) )
                                    WHEN 10 THEN (SUBSTR (VL_VENCIMIENTO,1,2)||'/10/'||(SUBSTR (VL_VENCIMIENTO,7,4)) )
                                    WHEN 11 THEN (SUBSTR (VL_VENCIMIENTO,1,2)||'/11/'||(SUBSTR (VL_VENCIMIENTO,7,4)) )
                                    WHEN 12 THEN (SUBSTR (VL_VENCIMIENTO,1,2)||'/12/'||(SUBSTR (VL_VENCIMIENTO,7,4)) )
                                    WHEN 13 THEN (SUBSTR (VL_VENCIMIENTO,1,2)||'/01/'||(SUBSTR (VL_VENCIMIENTO,7,4)+1) )
                                    WHEN 14 THEN (SUBSTR (VL_VENCIMIENTO,1,2)||'/02/'||(SUBSTR (VL_VENCIMIENTO,7,4)+1) )
                                    WHEN 15 THEN (SUBSTR (VL_VENCIMIENTO,1,2)||'/03/'||(SUBSTR (VL_VENCIMIENTO,7,4)+1) )
                                    WHEN 16 THEN (SUBSTR (VL_VENCIMIENTO,1,2)||'/04/'||(SUBSTR (VL_VENCIMIENTO,7,4)+1) )
                                    WHEN 17 THEN (SUBSTR (VL_VENCIMIENTO,1,2)||'/05/'||(SUBSTR (VL_VENCIMIENTO,7,4)+1) )
                                  END
                               INTO VL_FECHA_FUTU_2
                               FROM DUAL;
                             EXCEPTION
                             WHEN OTHERS THEN
                             VL_ERROR:= 'ERROR EN FECHA TZFACCE = '||SQLERRM;
                             END;

                           -- DBMS_OUTPUT.PUT_LINE('FECHA COMPLEMENTO = '||VL_FECHA_FUTU_2||' = '||VL_VENCIMIENTO||' *** '||VL_ERROR);

                              BEGIN
                               SELECT COUNT(*)
                                 INTO VL_COMPLE_INICIO
                                 FROM ZSTPARA
                                WHERE     ZSTPARA_MAPA_ID = 'COM_PRIMES'
                                      AND ZSTPARA_PARAM_ID = ALUMNO.CAMPUS||ALUMNO.NIVEL
                                      AND ZSTPARA_PARAM_VALOR = 1;
                             END;

                             IF     VL_COL_NUEVO = 0
                                AND VL_COMPLE_INICIO > 0 THEN

                                VL_COMPLE_FILI:=PKG_FINANZAS_REZA.F_COMPLE_FILI ( TO_DATE(VL_VENCIMIENTO,'DD/MM/YYYY'),
                                                                                  ALUMNO.PIDM,
                                                                                  X.TZFACCE_DETAIL_CODE,
                                                                                  X.TBBDETC_DESC,
                                                                                  X.TZFACCE_AMOUNT,
                                                                                  VL_NEWPERIODO,
                                                                                  X.TZFACCE_STUDY );
                             ELSE

                                 BEGIN
                                   SELECT NVL(MAX (TZFACCE_SEC_PIDM),0)+1
                                     INTO LV_TRAN_NUM
                                     FROM TZFACCE
                                    WHERE TZFACCE_PIDM = ALUMNO.PIDM;
                                 EXCEPTION
                                 WHEN OTHERS  THEN
                                 LV_TRAN_NUM := 1;
                                 END;

                                  BEGIN
                                   SELECT NVL(MAX (TZFACCE_STUDY),1)
                                     INTO VL_SOLICITUD
                                     FROM TZFACCE
                                    WHERE TZFACCE_PIDM = ALUMNO.PIDM;
                                 EXCEPTION
                                 WHEN OTHERS  THEN
                                 VL_SOLICITUD := 1;
                                 END;

                                 BEGIN
                                   INSERT
                                     INTO TZFACCE
                                   VALUES ( ALUMNO.PIDM,  --TZFACCE_PIDM
                                            LV_TRAN_NUM,  --TZFACCE_SEC_PIDM
                                            VL_NEWPERIODO, --TZFACCE_TERM_CODE
                                            X.TZFACCE_DETAIL_CODE,    --TZFACCE_DETAIL_CODE
                                            X.TBBDETC_DESC, --TZFACCE_DESC
                                            X.TZFACCE_AMOUNT,  --TZFACCE_AMOUNT
                                            TO_DATE(VL_FECHA_FUTU_2,'DD/MM/YYYY'), --TZFACCE_EFFECTIVE_DATE
                                            'REZA',    --TZFACCE_USER
                                            SYSDATE,  --TZFACCE_ACTIVITY_DATE
                                            0,--TZFACCE_FLAG
                                            VL_SOLICITUD);
                                 EXCEPTION
                                 WHEN OTHERS THEN
                                 VL_ERROR:= 'ERROR INSERTAR TZFACCE'||SQLERRM;
                                 END;
                             END IF;

                           END IF;

                         END;

                       END IF;

                     END LOOP;

                   END IF;

                    /* Apago Este codigo para Argentina de debe de Existir

                   VL_INCR:= PKG_FINANZAS_REZA.F_MONTO_INCRE ( ALUMNO.CAMPUS,
                                                               ALUMNO.NIVEL,
                                                               ALUMNO.PIDM,
                                                               ALUMNO.PROGRAMA,
                                                               ALUMNO.FECHA_INICIO,
                                                               ALUMNO.STUDY_PATH );

                   IF VL_INCR != 0 THEN
                     VL_PARCIALIDAD:= CEIL((VL_INCR+1)*VL_PARC_ANTE);
                   END IF;
                   */

                   VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);

                   If alumno.campus = 'UIN' then
                       vl_colegiatura_uin:= 0;

                       --DBMS_OUTPUT.PUT_LINE('VALIDA EL CAMPUS UIN');

                      Begin
                            Select count (1)
                                into vl_colegiatura_uin
                            from tbraccd
                            Where 1=1
                            And tbraccd_pidm = ALUMNO.PIDM
                            And tbraccd_detail_code = VL_CODIGO
                           -- And  TBRACCD_PERIOD = ALUMNO.PARTE_PERIODO
                            And  TBRACCD_CREATE_SOURCE = 'TZFEDCA (PARC)'
                            And  TRUNC (TBRACCD_EFFECTIVE_DATE) = VL_VENCIMIENTO;
                      Exception
                        When Others then 
                         vl_colegiatura_uin:=0;
                      End;

                        --DBMS_OUTPUT.PUT_LINE('VALIDA EXISTE COLEGIATURA '||vl_colegiatura_uin);                   


                      If vl_colegiatura_uin >= 1 then   -----Victor aqui

                         VL_VENCIMIENTO:= ADD_MONTHS(TO_DATE(VL_VENCIMIENTO,'DD,MM,YYYY'),1);
                         iF substr (TO_DATE(VL_VENCIMIENTO,'DD/MM/YYYY'),1,2) IN ('11', '16', '31') THEN 
                            VL_VENCIMIENTO:= TO_DATE(VL_VENCIMIENTO,'DD,MM,YYYY') -1;
                         End if;      


                         --DBMS_OUTPUT.PUT_LINE('VALIDA FECHA VENCIMIENTO '||VL_VENCIMIENTO);      

                      End if;

                   End if ;


                   VL_ERROR:= PKG_FINANZAS.F_INSERTA_TBRACCD(
                                                   P_PIDM => ALUMNO.PIDM
                                                 , P_SECUENCIA => VL_SECUENCIA
                                                 , P_NUMBER_PAID => NULL
                                                 , P_PERIODO => ALUMNO.PERIODO
                                                 , P_PARTE_PERIODO => ALUMNO.PARTE_PERIODO
                                                 , P_CODIGO => VL_CODIGO
                                                 , P_MONTO => VL_PARCIALIDAD--vl_monto2/alumno.num_pagos
                                                 , P_BALANCE => VL_PARCIALIDAD--vl_monto2/alumno.num_pagos
                                                 , P_FECHA_VENC => VL_VENCIMIENTO
                                                 , P_DESCRIP => VL_DESCRIPCION
                                                 , P_STUDY_PATH => ALUMNO.STUDY_PATH
                                                 , P_ORIGEN => 'TZFEDCA (PARC)'
                                                 ,P_FECHA_INICIO => ALUMNO.FECHA_INICIO);

                   IF (P_LLAMADA  != 'REPROCESO' OR  P_LLAMADA IS NULL) THEN

--                      VL_CART_UTL:= PKG_FINANZAS.F_MEMBRESIA_UTLX( ALUMNO.MATRICULA,
--                                                                    'CARTERA',
--                                                                    VL_VENCIMIENTO,
--                                                                    ALUMNO.PERIODO,
--                                                                    ALUMNO.FECHA_INICIO,
--                                                                    ALUMNO.STUDY_PATH,
--                                                                    ALUMNO.PARTE_PERIODO);
                 null;

                     BEGIN
                        VL_RECURRENTE:= PKG_FINANZAS_REZA.F_ACC_RECURENTE ( ALUMNO.PIDM,
                                                                            ALUMNO.PERIODO,
                                                                            to_date(VL_VENCIMIENTO,'dd/mm/yyyy'),
                                                                            ALUMNO.STUDY_PATH,
                                                                            ALUMNO.PARTE_PERIODO,
                                                                            ALUMNO.FOLIO);
                     EXCEPTION
                     WHEN OTHERS THEN
                     VL_RECURRENTE:='ERROR= '||SQLERRM;
                     END;

                   END IF;

                   VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;

                   VL_MES := VL_MES +1;

                   IF VL_MES = '13' THEN
                     VL_MES := '01';
                     VL_ANO := VL_ANO +1;
                   END IF;

                 END LOOP;

                 IF (P_LLAMADA  != 'REPROCESO' OR  P_LLAMADA IS NULL) THEN
                   VL_CONDONACION_UTLX:= PKG_FINANZAS_REZA.F_COND_UTELX ( ALUMNO.PIDM, NULL,'CONTINUO');
                 END IF;

                 IF VL_UPSE > 0 THEN ---- GENERA CARGOS DE UPSELLING ----

                   BEGIN
                     VL_RESP_UPSELLING:= PKG_FINANZAS_BOOTCAMP.F_VALIDA_UPSELLING ( ALUMNO.PIDM,NULL);
                   EXCEPTION
                   WHEN OTHERS THEN
                   VL_ERROR:= 'ERROR AL GENERAR CARGOS UPSELLING = '||SQLERRM;
                   END;
                  --   DBMS_OUTPUT.PUT_LINE('PROCESO CARTERAS UPSELLING = '||VL_ERROR);
                 END IF;

               END IF;

                 BEGIN
                    SELECT COUNT(*)
                      INTO VL_ENTRA_DINA
                      FROM GORADID
                     WHERE     GORADID_ADID_CODE = 'DINA'
                              AND GORADID_PIDM = ALUMNO.PIDM;
                 END;

                 IF VL_ENTRA_DINA > 0 THEN /* ENTRA PROCESO PAQUETES DINAMICOS */

                   VL_DINAMICOS:= PKG_FINANZAS_DINAMICOS.F_CARTERA_DINA ( ALUMNO.PIDM,
                                                                          ALUMNO.FECHA_INICIO,
                                                                          NULL,
                                                                          USER,
                                                                          'CARTERA' );
                   IF VL_DINAMICOS = 'EXITO' THEN
                    VL_ERROR:= NULL;
                   ELSE
                     VL_ERROR:= VL_DINAMICOS;
                   END IF;
                 END IF;

             ELSE

               VL_ERROR :='No existe configuración en: SGRSATT y/o SFRRGFE' ;
               VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;
               VL_PLAN_BITA := 0;

             END IF;

           ELSE
            --- DBMS_OUTPUT.PUT_LINE('Entra plan');
             VL_NUINGR_PLAN:= 0;

             BEGIN
               SELECT TBRACCD_TRAN_NUMBER
                 INTO VL_ULT_COL
                 FROM TBRACCD A
                WHERE A.TBRACCD_PIDM = ALUMNO.PIDM
                 AND A.TBRACCD_TRAN_NUMBER = (SELECT MAX (TBRACCD_TRAN_NUMBER)
                                                FROM TBRACCD
                                               WHERE TBRACCD_PIDM = ALUMNO.PIDM
                                                 AND TBRACCD_DOCUMENT_NUMBER IS NULL
                                                 AND TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                                                               FROM TBBDETC
                                                                              WHERE TBBDETC_DCAT_CODE = 'COL'
                                                                                AND SUBSTR (TBBDETC_DETAIL_CODE,1,2) = SUBSTR (ALUMNO.PERIODO, 1, 2)
                                                                                AND SUBSTR (TBBDETC_DETAIL_CODE,1,3) = SUBSTR (ALUMNO.PERIODO, 1, 2)||'N'
                                                                                AND TBBDETC_DETC_ACTIVE_IND = 'Y'
                                                                                AND TBBDETC_TAXT_CODE = ALUMNO.NIVEL));
             EXCEPTION
             WHEN OTHERS THEN
               VL_ULT_COL:=0;
               VL_NUINGR_PLAN:=1;
             END;

            -- DBMS_OUTPUT.PUT_LINE('VALIDA ULTIMA COLEGIATURA = '||VL_ULT_COL||'<<>>'||ALUMNO.PERIODO||'**'||ALUMNO.PARTE_PERIODO||'**'||ALUMNO.NIVEL);

             BEGIN
               SELECT A1.TBRAPPL_PAY_TRAN_NUMBER
                 INTO VL_NUMPAG
                 FROM TBRAPPL A1
                WHERE     A1.TBRAPPL_PIDM = ALUMNO.PIDM
                      AND A1.TBRAPPL_CHG_TRAN_NUMBER =  VL_ULT_COL
                      AND A1.TBRAPPL_ACTIVITY_DATE = (SELECT MAX (A.TBRAPPL_ACTIVITY_DATE)
                                                        FROM TBRAPPL A
                                                       WHERE     A.TBRAPPL_PIDM = A1.TBRAPPL_PIDM
                                                             AND A.TBRAPPL_CHG_TRAN_NUMBER =  A1.TBRAPPL_CHG_TRAN_NUMBER
                      AND A1.TBRAPPL_REAPPL_IND IS NULL);
             EXCEPTION
             WHEN OTHERS THEN
             VL_NUMPAG:=0;
             END;

             BEGIN
               SELECT TBRACCD_DETAIL_CODE
                 INTO VL_CODIGO_AJ
                 FROM TBRACCD
                WHERE     TBRACCD_PIDM = ALUMNO.PIDM
                      AND TBRACCD_TRAN_NUMBER = VL_NUMPAG;
             EXCEPTION
             WHEN OTHERS THEN
             VL_CODIGO_AJ:=0;
             END;

             BEGIN
               SELECT COUNT (ZSTPARA_PARAM_VALOR)
                 INTO VL_COD_EXCLU
                 FROM ZSTPARA
                WHERE     ZSTPARA_PARAM_ID = 'PARC_ANTERIOR'
                      AND ZSTPARA_PARAM_VALOR = SUBSTR(VL_CODIGO_AJ,3,2);
             EXCEPTION
             WHEN OTHERS THEN
             VL_COD_EXCLU:=0;
             END;

             IF (VL_COD_EXCLU > 0 OR VL_NUINGR_PLAN = 1) THEN

               BEGIN
                 SELECT T.SGRSATT_ATTS_CODE
                   INTO  VC_JORNADA
                   FROM SGRSATT T
                  WHERE     T.SGRSATT_PIDM = ALUMNO.PIDM
                        AND T.SGRSATT_STSP_KEY_SEQUENCE = ALUMNO.STUDY_PATH
                        AND REGEXP_LIKE  (T.SGRSATT_ATTS_CODE , '^[0-9]')
                        AND SUBSTR(T.SGRSATT_TERM_CODE_EFF,5,2) NOT IN (81,82,83,90)
                        AND T.SGRSATT_TERM_CODE_EFF = ( SELECT MAX(SGRSATT_TERM_CODE_EFF)
                                                          FROM SGRSATT TT
                                                         WHERE     TT.SGRSATT_PIDM =  T.SGRSATT_PIDM
                                                               AND TT.SGRSATT_STSP_KEY_SEQUENCE= T.SGRSATT_STSP_KEY_SEQUENCE
                                                               AND SUBSTR(TT.SGRSATT_TERM_CODE_EFF,5,2) NOT IN (81,82,83,90)
                                                               AND REGEXP_LIKE  (TT.SGRSATT_ATTS_CODE , '^[0-9]'))
                        AND T.SGRSATT_ACTIVITY_DATE = (SELECT MAX(SGRSATT_ACTIVITY_DATE)
                                                         FROM SGRSATT T1
                                                        WHERE     T1.SGRSATT_PIDM = T.SGRSATT_PIDM
                                                              AND T1.SGRSATT_STSP_KEY_SEQUENCE = T.SGRSATT_STSP_KEY_SEQUENCE
                                                              AND T1.SGRSATT_TERM_CODE_EFF = T.SGRSATT_TERM_CODE_EFF
                                                              AND SUBSTR(T1.SGRSATT_TERM_CODE_EFF,5,2) NOT IN (81,82,83,90)
                                                              AND REGEXP_LIKE  (T1.SGRSATT_ATTS_CODE , '^[0-9]'));
               EXCEPTION
               WHEN OTHERS THEN
               VC_JORNADA:=NULL;
               VL_ERROR :='Error al buscar la Jornada en SGRSATT: ';
               VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;
               END;

               IF vl_PRE_ACTUALIZADO IS NOT NULL THEN

                 BEGIN
                   SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                     INTO VL_CODIGO, VL_DESCRIPCION, VL_MONTO,  VL_SFRRGFE_RATE_CODE
                     FROM SFRRGFE A , TBBDETC
                    WHERE     TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                          AND A.SFRRGFE_TERM_CODE= ALUMNO.PERIODO
                          AND A.SFRRGFE_TYPE = 'STUDENT'
                          AND SFRRGFE_ENTRY_TYPE = 'R'
                          AND A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                          AND A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                          AND A.SFRRGFE_ATTS_CODE = VC_JORNADA--ALUMNO.JORNADA
                          AND A.SFRRGFE_RATE_CODE = ALUMNO.RATE
                          AND A.SFRRGFE_DEPT_CODE = vl_PRE_ACTUALIZADO
                          AND A.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA
                          AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                                   FROM SFRRGFE A1
                                                  WHERE     A1.SFRRGFE_TERM_CODE = A.SFRRGFE_TERM_CODE
                                                        AND A1.SFRRGFE_TYPE = A.SFRRGFE_TYPE
                                                        AND A1.SFRRGFE_ENTRY_TYPE = A.SFRRGFE_ENTRY_TYPE
                                                        AND A1.SFRRGFE_LEVL_CODE = A.SFRRGFE_LEVL_CODE
                                                        AND A1.SFRRGFE_CAMP_CODE = A.SFRRGFE_CAMP_CODE
                                                        AND A1.SFRRGFE_ATTS_CODE = A.SFRRGFE_ATTS_CODE
                                                        AND A1.SFRRGFE_RATE_CODE = A.SFRRGFE_RATE_CODE
                                                        AND A1.SFRRGFE_DEPT_CODE = A.SFRRGFE_DEPT_CODE
                                                        AND A1.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA);
                 EXCEPTION
                 WHEN NO_DATA_FOUND THEN

                   BEGIN
                     SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                       INTO VL_CODIGO, VL_DESCRIPCION, VL_MONTO,  VL_SFRRGFE_RATE_CODE
                       FROM SFRRGFE A , TBBDETC
                      WHERE     TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                            AND A.SFRRGFE_TERM_CODE= ALUMNO.PERIODO
                            AND A.SFRRGFE_TYPE = 'STUDENT'
                            AND SFRRGFE_ENTRY_TYPE = 'R'
                            AND A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                            AND A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                            AND A.SFRRGFE_ATTS_CODE = VC_JORNADA--ALUMNO.JORNADA
                            AND A.SFRRGFE_RATE_CODE = ALUMNO.RATE
                            AND A.SFRRGFE_DEPT_CODE = vl_PRE_ACTUALIZADO
                            AND A.SFRRGFE_PROGRAM IS NULL
                            AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                                     FROM SFRRGFE A1
                                                    WHERE     A1.SFRRGFE_TERM_CODE = A.SFRRGFE_TERM_CODE
                                                          AND A1.SFRRGFE_TYPE = A.SFRRGFE_TYPE
                                                          AND A1.SFRRGFE_ENTRY_TYPE = A.SFRRGFE_ENTRY_TYPE
                                                          AND A1.SFRRGFE_LEVL_CODE = A.SFRRGFE_LEVL_CODE
                                                          AND A1.SFRRGFE_CAMP_CODE = A.SFRRGFE_CAMP_CODE
                                                          AND A1.SFRRGFE_ATTS_CODE = A.SFRRGFE_ATTS_CODE
                                                          AND A1.SFRRGFE_RATE_CODE = A.SFRRGFE_RATE_CODE
                                                          AND A1.SFRRGFE_DEPT_CODE = A.SFRRGFE_DEPT_CODE
                                                          AND A1.SFRRGFE_PROGRAM IS NULL);
                   EXCEPTION
                   WHEN OTHERS THEN
                     VL_ERROR :='Validar Regla de Cobro, Parametros xxx = '||ALUMNO.PERIODO||'  -  '||NVL(VC_JORNADA,'SIN JORNADA')||'  -  '||ALUMNO.RATE||' código aumento '||NVL(vl_PRE_ACTUALIZADO,'NULL');
                     VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;
                     VL_CODIGO := NULL;
                     VL_DESCRIPCION := NULL;
                     VL_MONTO := NULL;
                   END;

                 END;

               ELSIF vl_PRE_ACTUALIZADO IS  NULL THEN

                 BEGIN
                   SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                     INTO VL_CODIGO, VL_DESCRIPCION, VL_MONTO,  VL_SFRRGFE_RATE_CODE
                     FROM SFRRGFE A , TBBDETC
                    WHERE     TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                          AND A.SFRRGFE_TERM_CODE = ALUMNO.PERIODO
                          AND A.SFRRGFE_TYPE = 'STUDENT'
                          AND SFRRGFE_ENTRY_TYPE = 'R'
                          AND A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                          AND A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                          AND A.SFRRGFE_ATTS_CODE = VC_JORNADA--ALUMNO.JORNADA
                          AND A.SFRRGFE_RATE_CODE = ALUMNO.RATE
                          AND A.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA
                          AND A.SFRRGFE_DEPT_CODE IS NULL
                          AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                                   FROM SFRRGFE A1
                                                  WHERE     A1.SFRRGFE_TERM_CODE = A.SFRRGFE_TERM_CODE
                                                        AND A1.SFRRGFE_TYPE = A.SFRRGFE_TYPE
                                                        AND A1.SFRRGFE_ENTRY_TYPE = A.SFRRGFE_ENTRY_TYPE
                                                        AND A1.SFRRGFE_LEVL_CODE = A.SFRRGFE_LEVL_CODE
                                                        AND A1.SFRRGFE_CAMP_CODE = A.SFRRGFE_CAMP_CODE
                                                        AND A1.SFRRGFE_ATTS_CODE = A.SFRRGFE_ATTS_CODE
                                                        AND A1.SFRRGFE_RATE_CODE = A.SFRRGFE_RATE_CODE
                                                        AND A1.SFRRGFE_DEPT_CODE IS NULL
                                                        AND A1.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA);
                 EXCEPTION
                 WHEN OTHERS THEN

                   BEGIN
                     SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                       INTO VL_CODIGO, VL_DESCRIPCION, VL_MONTO,  VL_SFRRGFE_RATE_CODE
                       FROM SFRRGFE A , TBBDETC
                      WHERE     TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                            AND A.SFRRGFE_TERM_CODE= ALUMNO.PERIODO
                            AND A.SFRRGFE_TYPE = 'STUDENT'
                            AND SFRRGFE_ENTRY_TYPE = 'R'
                            AND A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                            AND A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                            AND A.SFRRGFE_ATTS_CODE = VC_JORNADA--ALUMNO.JORNADA
                            AND A.SFRRGFE_RATE_CODE = ALUMNO.RATE
                            AND A.SFRRGFE_DEPT_CODE IS NULL
                            AND A.SFRRGFE_PROGRAM IS NULL
                            AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                                     FROM SFRRGFE A1
                                                    WHERE     A1.SFRRGFE_TERM_CODE = A.SFRRGFE_TERM_CODE
                                                          AND A1.SFRRGFE_TYPE = A.SFRRGFE_TYPE
                                                          AND A1.SFRRGFE_ENTRY_TYPE = A.SFRRGFE_ENTRY_TYPE
                                                          AND A1.SFRRGFE_LEVL_CODE = A.SFRRGFE_LEVL_CODE
                                                          AND A1.SFRRGFE_CAMP_CODE = A.SFRRGFE_CAMP_CODE
                                                          AND A1.SFRRGFE_ATTS_CODE = A.SFRRGFE_ATTS_CODE
                                                          AND A1.SFRRGFE_RATE_CODE = A.SFRRGFE_RATE_CODE
                                                          AND A1.SFRRGFE_DEPT_CODE IS NULL
                                                          AND A1.SFRRGFE_PROGRAM IS NULL);
                   EXCEPTION
                   WHEN OTHERS THEN
                    VL_ERROR :='Validar Regla de Cobro, Parametros xxxx = '||ALUMNO.PERIODO||'  -  '||NVL(VC_JORNADA,'SIN JORNADA')||'  -  '||ALUMNO.RATE||' código aumento '||NVL(vl_PRE_ACTUALIZADO,'NULL');
                    VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;
                    VL_CODIGO := NULL;
                    VL_DESCRIPCION := NULL;
                    VL_MONTO := NULL;
                   END;

                 END;


               END IF;

               VN_PORC_INCREM:=0;

               IF ALUMNO.TIPO_ALUMNO <> 'N' THEN

                 BEGIN
                   SELECT NVL(SUM(A.TZDOCTR_PORC_INCREM),0)
                         ,MAX(A.TZDOCTR_PERIODOS_CURSADOS)
                         ,MAX(TZDOCTR_COLEG_1)
                         ,MAX(TZDOCTR_DESC_1)
                         ,MAX(TZDOCTR_PPAGO_1)
                         ,MAX(TZDOCTR_PARCI_1)
                     INTO VN_PORC_INCREM,VN_PERIODOS_CURSADOS,VN_TZDOCTR_COLEG_1,VN_TZDOCTR_DESC_1,VN_TZDOCTR_PPAGO_1,VN_TZDOCTR_PARCI_1
                     FROM  TZDOCTR A
                    WHERE     A.TZDOCTR_PIDM = ALUMNO.PIDM
                          AND A.TZDOCTR_PROGRAM = ALUMNO.PROGRAMA
                          AND A.TZDOCTR_TERM_CODE =  ALUMNO.PERIODO
                          AND A.TZDOCTR_START_DATE = ALUMNO.FECHA_INICIO
                          AND NVL(TZDOCTR_IND,0) <> 1
                          AND A.TZDOCTR_TIPO_PROC = 'AUME'
                          AND A.TZDOCTR_PERIODOS_CURSADOS =(SELECT MAX(TZDOCTR_PERIODOS_CURSADOS)
                                                              FROM TZDOCTR B
                                                             WHERE     B.TZDOCTR_PIDM=A.TZDOCTR_PIDM
                                                                   AND B.TZDOCTR_PROGRAM=A.TZDOCTR_PROGRAM
                                                                   AND B.TZDOCTR_TERM_CODE=A.TZDOCTR_TERM_CODE
                                                                   AND B.TZDOCTR_START_DATE=A.TZDOCTR_START_DATE
                                                                   AND B.TZDOCTR_COLEG=A.TZDOCTR_COLEG
                                                                   AND B.TZDOCTR_TIPO_PROC=A.TZDOCTR_TIPO_PROC)
                             AND A.FECHA_PROCESO = (SELECT MAX (FECHA_PROCESO)
                                                      FROM TZDOCTR C
                                                     WHERE     C.TZDOCTR_PIDM=A.TZDOCTR_PIDM
                                                           AND C.TZDOCTR_PROGRAM = A.TZDOCTR_PROGRAM
                                                           AND C.TZDOCTR_TERM_CODE = A.TZDOCTR_TERM_CODE
                                                           AND C.TZDOCTR_START_DATE = A.TZDOCTR_START_DATE
                                                           AND C.TZDOCTR_COLEG = A.TZDOCTR_COLEG
                                                           AND C.TZDOCTR_TIPO_PROC = A.TZDOCTR_TIPO_PROC);
                 EXCEPTION
                 WHEN OTHERS THEN
                 VN_PORC_INCREM:=0;
                 VN_PERIODOS_CURSADOS:=0;
                 END;

               END IF;

               IF  VL_CODIGO IS NOT NULL AND VL_DESCRIPCION IS NOT NULL AND VL_MONTO IS NOT NULL AND VL_ERROR IS NULL THEN --SOLO SE CREA LA CARTERA SI EXISTE CONFIGURACION

                 VL_COLEGIATURA := VL_MONTO + (VL_MONTO*(VN_PORC_INCREM/100));

                 IF ALUMNO.NUM_PAGOS = 4 AND ALUMNO.PERIODICIDAD =  'Bime' THEN
                    VL_COLEGIATURA:= VL_COLEGIATURA/2;
                 END IF;

                 VL_PLAN_BITA :=0;
                 VL_SECUENCIACOL  := VL_SECUENCIA;
                 VL_ERROR := NULL;

                 IF SUBSTR(ALUMNO.PARTE_PERIODO,2,1)= '0' AND ALUMNO.TIPO_ALUMNO = 'N' THEN

                   BEGIN
                     SELECT SZTPTRM_PROPEDEUTICO
                       INTO VN_PROPE
                       FROM SZTPTRM
                      WHERE     SZTPTRM_CAMP_CODE =   ALUMNO.CAMPUS
                            AND SZTPTRM_LEVL_CODE = ALUMNO.NIVEL
                            AND SZTPTRM_TERM_CODE = ALUMNO.PERIODO
                            AND SZTPTRM_PTRM_CODE = ALUMNO.PARTE_PERIODO
                            AND SZTPTRM_PROGRAM   = ALUMNO.PROGRAMA;
                   EXCEPTION
                   WHEN OTHERS THEN
                   VN_PROPE := NULL;
                   END;

                   IF VN_PROPE = 1 THEN
                       VD_FECHA_INICIO := ADD_MONTHS(TRUNC(ALUMNO.FECHA_INICIO),1);
                   ELSE
                     VD_FECHA_INICIO := ALUMNO.FECHA_INICIO;
                   END IF;

                 ELSE
                   VD_FECHA_INICIO := ALUMNO.FECHA_INICIO;
                 END IF;

                 ------------------------ VALIDA ACCESORIOS Y DESCUENTOS -------------------------------------------
                 ---------------------------------------------------------------------------------------------------
                 ---------------------------------------------------------------------------------------------------

                 BEGIN
                   SELECT COUNT(*)
                     INTO V_ENTRA
                     FROM TZFACCE
                    WHERE     TZFACCE_PIDM = ALUMNO.PIDM
                          AND TZFACCE_TERM_CODE = ALUMNO.PERIODO
                           AND TZFACCE_USER = 'SV2A'
                          AND TZFACCE_FLAG = 0
                          And TZFACCE_DETAIL_CODE not in (select codigo from TZTINC); ---> Quita complemento;
                 EXCEPTION
                 WHEN OTHERS THEN
                 V_ENTRA := 0;
                 END;

                 IF V_ENTRA > 0 THEN

                   FOR X IN (

                             SELECT A.*,TBBDETC_DESC
                               FROM TZFACCE A,TBBDETC
                              WHERE A.TZFACCE_DETAIL_CODE = TBBDETC_DETAIL_CODE
                                AND A.TZFACCE_PIDM = ALUMNO.PIDM
                                AND A.TZFACCE_USER = 'SV2A'
                                AND A.TZFACCE_FLAG = 0
                                AND SUBSTR(A.TZFACCE_DETAIL_CODE,3,2) NOT IN ('QI','NA')
                                AND A.TZFACCE_SEC_PIDM IN (SELECT MAX(A1.TZFACCE_SEC_PIDM)
                                                             FROM TZFACCE A1
                                                            WHERE     A1.TZFACCE_PIDM = A.TZFACCE_PIDM
                                                                  AND A1.TZFACCE_TERM_CODE = A.TZFACCE_TERM_CODE
                                                                  AND A1.TZFACCE_FLAG = A.TZFACCE_FLAG
                                                                  AND SUBSTR(A1.TZFACCE_DETAIL_CODE,3,2) NOT IN ('QI','NA')
                                                                  AND A1.TZFACCE_DETAIL_CODE = A.TZFACCE_DETAIL_CODE)
                               And a.TZFACCE_DETAIL_CODE not in (select codigo from TZTINC) ---> Quita complemento

                   )LOOP

                     VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);
                     VL_SECUENCIACOL := VL_SECUENCIA;

                     BEGIN
                       INSERT
                         INTO TBRACCD
                       VALUES (
                                ALUMNO.PIDM,   -- TBRACCD_PIDM
                                VL_SECUENCIACOL,     --TBRACCD_TRAN_NUMBER
                                ALUMNO.PERIODO,    -- TBRACCD_TERM_CODE
                                X.TZFACCE_DETAIL_CODE,--vp_inscrip_code,     ---TBRACCD_DETAIL_CODE
                                USER,     ---TBRACCD_USER
                                SYSDATE,     --TBRACCD_ENTRY_DATE
                                NVL(X.TZFACCE_AMOUNT,0),
                                NVL(X.TZFACCE_AMOUNT,0),    ---TBRACCD_BALANCE
                                SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                                NULL,    --TBRACCD_BILL_DATE
                                NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                                X.TBBDETC_DESC,    -- TBRACCD_DESC
                                ALUMNO.FOLIO,     --TBRACCD_RECEIPT_NUMBER
                                NULL,     --TBRACCD_TRAN_NUMBER_PAID
                                NULL,     --TBRACCD_CROSSREF_PIDM
                                NULL,    --TBRACCD_CROSSREF_NUMBER
                                NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                                'T',    --TBRACCD_SRCE_CODE
                                'Y',    --TBRACCD_ACCT_FEED_IND
                                SYSDATE,  --TBRACCD_ACTIVITY_DATE
                                0,        --TBRACCD_SESSION_NUMBER
                                NULL,    -- TBRACCD_CSHR_END_DATE
                                NULL,     --TBRACCD_CRN
                                NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                                NULL,     -- TBRACCD_LOC_MDT
                                NULL,     --TBRACCD_LOC_MDT_SEQ
                                NULL,     -- TBRACCD_RATE
                                NULL,     --TBRACCD_UNITS
                                NULL,     -- TBRACCD_DOCUMENT_NUMBER
                                SYSDATE,  -- TBRACCD_TRANS_DATE
                                NULL,        -- TBRACCD_PAYMENT_ID
                                NULL,     -- TBRACCD_INVOICE_NUMBER
                                NULL,     -- TBRACCD_STATEMENT_DATE
                                NULL,     -- TBRACCD_INV_NUMBER_PAID
                                'MXN',     -- TBRACCD_CURR_CODE
                                NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                                NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                                NULL,     -- TBRACCD_LATE_DCAT_CODE
                                ALUMNO.FECHA_INICIO,     -- TBRACCD_FEED_DATE
                                NULL,     -- TBRACCD_FEED_DOC_CODE
                                NULL,     -- TBRACCD_ATYP_CODE
                                NULL,     -- TBRACCD_ATYP_SEQNO
                                NULL,     -- TBRACCD_CARD_TYPE_VR
                                NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                                NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                                NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                                NULL,     -- TBRACCD_ORIG_CHG_IND
                                NULL,     -- TBRACCD_CCRD_CODE
                                NULL,     -- TBRACCD_MERCHANT_ID
                                NULL,     -- TBRACCD_TAX_REPT_YEAR
                                NULL,     -- TBRACCD_TAX_REPT_BOX
                                NULL,     -- TBRACCD_TAX_AMOUNT
                                NULL,     -- TBRACCD_TAX_FUTURE_IND
                                'TZFEDCA(ACC)',     -- TBRACCD_DATA_ORIGIN
                                'TZFEDCA(ACC)',   -- TBRACCD_CREATE_SOURCE
                                NULL,     -- TBRACCD_CPDT_IND
                                NULL,     --TBRACCD_AIDY_CODE
                                ALUMNO.STUDY_PATH,     --TBRACCD_STSP_KEY_SEQUENCE
                                ALUMNO.PARTE_PERIODO,     --TBRACCD_PERIOD
                                NULL,    --TBRACCD_SURROGATE_ID
                                NULL,     -- TBRACCD_VERSION
                                USER,     --TBRACCD_USER_ID
                                NULL );     --TBRACCD_VPDI_CODE
                     EXCEPTION
                     WHEN OTHERS THEN
                     VL_ERROR := 'Se presento ERROR INSERT TBRACCD '||SQLERRM;
                     END;

                     BEGIN
                       UPDATE SATURN.TZFACCE
                          SET TZFACCE_FLAG = 1,
                                TZFACCE_USER = 'SV2A--2'
                        WHERE     TZFACCE_PIDM = ALUMNO.PIDM
                              AND TZFACCE_USER = 'SV2A'
                              AND TZFACCE_FLAG = 0
                              AND TZFACCE_DETAIL_CODE = X.TZFACCE_DETAIL_CODE;
                     END;

                   END LOOP;

                 END IF;

                 VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);

                 VL_SECUENCIACOL := VL_SECUENCIA;

                 VL_ERROR:= PKG_FINANZAS.F_INSERTA_TBRACCD(
                                               P_PIDM => ALUMNO.PIDM
                                             , P_SECUENCIA => VL_SECUENCIACOL--vl_secuencia
                                             , P_NUMBER_PAID => NULL
                                             , P_PERIODO => ALUMNO.PERIODO
                                             , P_PARTE_PERIODO => ALUMNO.PARTE_PERIODO
                                             , P_CODIGO => VL_CODIGO
                                             , P_MONTO => VL_COLEGIATURA--vl_monto
                                             , P_BALANCE => VL_COLEGIATURA--vl_monto
                                             , P_FECHA_VENC => VD_FECHA_INICIO--sysdate
                                             , P_DESCRIP => VL_DESCRIPCION
                                             , P_STUDY_PATH => ALUMNO.STUDY_PATH
                                             , P_ORIGEN => 'TZFEDCA (COL)'
                                             , P_FECHA_INICIO => ALUMNO.FECHA_INICIO) ;

                 VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;

                 IF VL_ERROR IS NULL  THEN

                   VL_CODIGO := NULL;
                   VL_DESCRIPCION := NULL;
                   VL_MONTO := VL_COLEGIATURA;
                   VL_SECUENCIA :=0;
                   VL_MONTO_PERCENT := 0;
                   VL_MONTO_AMOUNT := 0;
                   VL_TRAN_NUM :=VL_SECUENCIACOL;
                   VN_EXISTE_DSP:=0;

                   BEGIN
                     SELECT DISTINCT TBBDETC_DETAIL_CODE,TBBDETC_DESC, TBREDET_DETAIL_CODE,TBREDET_PERCENT,TBREDET_MAX_AMOUNT,TBBESTU_EXEMPTION_CODE
                       INTO VL_CODIGO,VL_DESCRIPCION, VL_CODIGO_AFEC, VL_MONTO_PERCENT, VL_MONTO_AMOUNT,VL_CODEXEMTION
                       FROM TBBEXPT, TBBESTU A, TBBDETC, TBREDET
                      WHERE TBBDETC_DETAIL_CODE = TBBEXPT_DETAIL_CODE
                            AND A.TBBESTU_EXEMPTION_CODE  = TBBEXPT_EXEMPTION_CODE
                            AND A.TBBESTU_TERM_CODE         = TBBEXPT_TERM_CODE
                            AND A.TBBESTU_STUDENT_EXPT_ROLL_IND= 'Y'
                            AND A.TBBESTU_DEL_IND IS NULL
                            AND TBREDET_EXEMPTION_CODE = TBBEXPT_EXEMPTION_CODE
                            AND TBREDET_TERM_CODE = TBBEXPT_TERM_CODE
                            AND A.TBBESTU_TERM_CODE = (SELECT MAX(A1.TBBESTU_TERM_CODE)
                                                         FROM TBBESTU A1,TBBEXPT,TBREDET
                                                        WHERE     A1.TBBESTU_PIDM = A.TBBESTU_PIDM
                                                              AND A1.TBBESTU_EXEMPTION_CODE  = TBBEXPT_EXEMPTION_CODE
                                                              AND A1.TBBESTU_TERM_CODE = TBBEXPT_TERM_CODE
                                                              AND TBREDET_EXEMPTION_CODE = TBBEXPT_EXEMPTION_CODE
                                                              AND TBREDET_TERM_CODE = TBBEXPT_TERM_CODE
                                                              AND A1.TBBESTU_STUDENT_EXPT_ROLL_IND = 'Y'
                                                              AND A1.TBBESTU_DEL_IND IS NULL
                                                              AND A1.TBBESTU_TERM_CODE <= ALUMNO.PERIODO)
                            AND A.TBBESTU_EXEMPTION_PRIORITY = (SELECT MAX(TBBESTU_EXEMPTION_PRIORITY)
                                                                  FROM TBBESTU A1
                                                                 WHERE     A1.TBBESTU_PIDM = A.TBBESTU_PIDM
                                                                       AND A1.TBBESTU_STUDENT_EXPT_ROLL_IND = A.TBBESTU_STUDENT_EXPT_ROLL_IND
                                                                       AND A1.TBBESTU_DEL_IND IS NULL
                                                                       AND A1.TBBESTU_TERM_CODE = A.TBBESTU_TERM_CODE)
                            AND TBBESTU_PIDM = ALUMNO.PIDM
                            AND TBBDETC_DCAT_CODE = 'DSP';

                       VN_EXISTE_DSP:=1;

                   EXCEPTION
                   WHEN OTHERS THEN
                   VL_ERROR :='Error al buscar el descuento DSP : ' ||SQLERRM;
                   VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;
                   VL_CODIGO := NULL;
                   VL_DESCRIPCION := NULL;
                   VL_CODIGO_AFEC := NULL;
                   VL_MONTO_PERCENT := NULL;
                   VL_MONTO_AMOUNT := NULL;
                   VL_TRAN_NUM :=NULL;
                   VL_TRAN_NUM :=VL_SECUENCIACOL;
                   VN_EXISTE_DSP:=0;
                   END;

                   IF     VL_CODIGO IS NOT NULL
                      AND VL_DESCRIPCION IS NOT NULL
                      AND VL_CODIGO_AFEC IS NOT NULL
                      AND (    VL_MONTO_PERCENT IS NOT NULL
                            OR VL_MONTO_AMOUNT IS NOT NULL)     THEN

                     IF VL_MONTO_PERCENT IS NOT NULL THEN

                       VL_DESCUENTO := (VL_COLEGIATURA*(VL_MONTO_PERCENT/100));

                     ELSIF VL_MONTO_AMOUNT IS NOT NULL THEN

                       VL_DESCUENTO := VL_MONTO_AMOUNT + (VL_MONTO_AMOUNT*(VN_PORC_INCREM/100));

                       IF ALUMNO.NUM_PAGOS = 4 AND ALUMNO.PERIODICIDAD =  'Bime' THEN
                          VL_DESCUENTO:= VL_DESCUENTO/2;
                       END IF;

                     END IF;


                    vl_monto_tyc:=0;
                    vl_porcentaje_tyc:=null;
                    
                    Begin
                        Select MONTO_BECA_N, porcentaje 
                         Into vl_monto_tyc, vl_porcentaje_tyc
                        from BECA_TYC
                        where 1=1
                        And PIDM = ALUMNO.PIDM
                        And sp = ALUMNO.STUDY_PATH
                        And fecha_inicio = ALUMNO.FECHA_INICIO
                        And pidm not in (select goradid_pidm  from goradid DDBE where GORADID_ADID_CODE = 'DDBE');
                    Exception
                        When Others then 
                        vl_monto_tyc:=0;
                        vl_porcentaje_tyc:= null;
                    End;
                    
                    If vl_monto_tyc > 0 then 
                    
                        VL_DESCUENTO:=VL_DESCUENTO - vl_monto_tyc;
                        
                        VL_ERROR:= pkg_utilerias.F_Genera_Etiqueta(ALUMNO.PIDM, 
                                                                   'DDBE', 
                                                                   'REDUCCION DE BECA...BECA $' ||vl_monto_tyc ||' % '||vl_porcentaje_tyc , 
                                                                   user);

                        
                    End if;



                     VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);

                     VL_ERROR:=PKG_FINANZAS.F_INSERTA_TBRACCD(
                                                 P_PIDM => ALUMNO.PIDM
                                               , P_SECUENCIA => VL_SECUENCIA
                                               , P_NUMBER_PAID => VL_SECUENCIACOL--vl_tran_num
                                               , P_PERIODO => ALUMNO.PERIODO
                                               , P_PARTE_PERIODO => ALUMNO.PARTE_PERIODO
                                               , P_CODIGO => VL_CODIGO
                                               , P_MONTO => VL_DESCUENTO
                                               , P_BALANCE => VL_DESCUENTO*-1
                                               , P_FECHA_VENC => VD_FECHA_INICIO--sysdate
                                               , P_DESCRIP => VL_DESCRIPCION
                                               , P_STUDY_PATH => ALUMNO.STUDY_PATH
                                               , P_ORIGEN => 'TZFEDCA (DSP)'
                                               ,P_FECHA_INICIO => ALUMNO.FECHA_INICIO) ;

                     VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;

                   END IF;

                   VL_VUELTA :=0;
                   VL_CODIGO := NULL;
                   VL_DESCRIPCION := NULL;
                   VL_MONTO := NULL;
                   VL_DESCUENTODSI:=0;

                   FOR DESCU IN (
                                 SELECT TBRACCD_DETAIL_CODE ,  TBRACCD_DESC, TBRACCD_AMOUNT, MAX(A.TBRACCD_TRAN_NUMBER)
                                   FROM TBRACCD A
                                  WHERE     A.TBRACCD_PIDM = ALUMNO.PIDM
                                        AND A.TBRACCD_DETAIL_CODE  IN (SELECT SUBSTR (ALUMNO.MATRICULA, 1, 2)||ZSTPARA_PARAM_VALOR
                                                                         FROM ZSTPARA
                                                                        WHERE     ZSTPARA_MAPA_ID='DET_CODE_CART'
                                                                              AND ZSTPARA_PARAM_ID= 'PARC_ANT_DSI')
                                        AND A.TBRACCD_AMOUNT >0
                                        AND A.TBRACCD_TRAN_NUMBER NOT IN (SELECT TBRACCD_TRAN_NUMBER
                                                                            FROM TBRACCD, TBBDETC
                                                                           WHERE     TBRACCD_PIDM = A.TBRACCD_PIDM--p_pidm
                                                                                 AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                 AND TBBDETC_TYPE_IND = 'C'
                                                                                 AND TBRACCD_AMOUNT < 0
                                                                           UNION
                                                                          SELECT TBRAPPL_CHG_TRAN_NUMBER
                                                                            FROM TBRAPPL,TBRACCD
                                                                           WHERE     TBRACCD_PIDM = A.TBRACCD_PIDM
                                                                                 AND TBRAPPL_PIDM= TBRACCD_PIDM
                                                                                 AND TBRAPPL_REAPPL_IND IS NULL
                                                                                 AND TBRAPPL_PAY_TRAN_NUMBER IN ( SELECT TBRACCD_TRAN_NUMBER
                                                                                                                    FROM TBRACCD, TBBDETC
                                                                                                                   WHERE     TBRACCD_PIDM = A.TBRACCD_PIDM--p_pidm
                                                                                                                         AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                                                         AND TBBDETC_TYPE_IND = 'C'
                                                                                                                         AND TBRACCD_AMOUNT < 0)
                                                                           UNION
                                                                          SELECT TBRACCD_TRAN_NUMBER_PAID
                                                                            FROM TBRACCD, TBBDETC
                                                                           WHERE     TBRACCD_PIDM = A.TBRACCD_PIDM--p_pidm
                                                                                 AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                 AND TBBDETC_TYPE_IND = 'C'
                                                                                 AND TBRACCD_AMOUNT < 0)
                                        AND A.TBRACCD_TERM_CODE = (SELECT MAX (A1.TBRACCD_TERM_CODE)
                                                                     FROM TBRACCD A1
                                                                    WHERE     A.TBRACCD_PIDM = A1.TBRACCD_PIDM
                                                                          AND A.TBRACCD_DETAIL_CODE = A1.TBRACCD_DETAIL_CODE
                                                                          AND A.TBRACCD_AMOUNT >0
                                                                          AND TBRACCD_TRAN_NUMBER NOT IN (SELECT TBRACCD_TRAN_NUMBER
                                                                                                            FROM TBRACCD, TBBDETC
                                                                                                           WHERE     TBRACCD_PIDM = A.TBRACCD_PIDM--p_pidm
                                                                                                                 AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                                                 AND TBBDETC_TYPE_IND = 'C'
                                                                                                                 AND TBRACCD_AMOUNT < 0
                                                                                                           UNION
                                                                                                          SELECT TBRAPPL_CHG_TRAN_NUMBER
                                                                                                            FROM TBRAPPL,TBRACCD
                                                                                                           WHERE     TBRACCD_PIDM = A.TBRACCD_PIDM
                                                                                                                 AND TBRAPPL_PIDM= TBRACCD_PIDM
                                                                                                                 AND TBRAPPL_REAPPL_IND IS NULL
                                                                                                                 AND TBRAPPL_PAY_TRAN_NUMBER IN ( SELECT TBRACCD_TRAN_NUMBER
                                                                                                                                                    FROM TBRACCD, TBBDETC
                                                                                                                                                   WHERE     TBRACCD_PIDM = A.TBRACCD_PIDM--p_pidm
                                                                                                                                                         AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                                                                                         AND TBBDETC_TYPE_IND = 'C'
                                                                                                                                                         AND TBRACCD_AMOUNT < 0)
                                                                                                           UNION
                                                                                                          SELECT TBRACCD_TRAN_NUMBER_PAID
                                                                                                            FROM TBRACCD, TBBDETC
                                                                                                           WHERE     TBRACCD_PIDM = A.TBRACCD_PIDM--p_pidm
                                                                                                                 AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                                                 AND TBBDETC_TYPE_IND = 'C'
                                                                                                                 AND TBRACCD_AMOUNT < 0))
                                       GROUP BY TBRACCD_DETAIL_CODE,TBRACCD_DESC,TBRACCD_AMOUNT
                                       ORDER BY 4 DESC
                   )LOOP

                     VL_VUELTA :=  1;
                     VL_CODIGO:= DESCU.TBRACCD_DETAIL_CODE;
                     VL_DESCRIPCION := DESCU.TBRACCD_DESC;
                     VL_DESCUENTODSI := DESCU.TBRACCD_AMOUNT;

                     IF VL_VUELTA = 1 THEN
                       EXIT;
                     END IF;

                   END LOOP;

                   VL_VUELTA :=0;

--                   DBMS_OUTPUT.PUT_LINE('SE VALIDA PARAMETROS PARA CALCULO DE DSI = '||ALUMNO.STUDY_PATH||' = '||
--                                                                                     ALUMNO.PERIODO||' = '||
--                                                                                     ALUMNO.PROGRAMA||' = '||
--                                                                                     ALUMNO.NIVEL||' = '||
--                                                                                     ALUMNO.CAMPUS
--                                                                                     );

                   BEGIN
                     SELECT DISTINCT TZTDMTO_MONTO  ,TZTDMTO_DESC_CODE , TZTDMTO_OBSERVACIONES
                       INTO VL_DESCUENTODSI, VL_CODIGO2,VL_DESCRIPCION
                       FROM TZTDMTO A
                      WHERE     A.TZTDMTO_PIDM = ALUMNO.PIDM
                            AND A.TZTDMTO_CAMP_CODE = ALUMNO.CAMPUS
                            AND A.TZTDMTO_NIVEL = ALUMNO.NIVEL
                            AND A.TZTDMTO_PROGRAMA = ALUMNO.PROGRAMA
                            AND A.TZTDMTO_TERM_CODE = ALUMNO.PERIODO
                            AND A.TZTDMTO_STUDY_PATH = ALUMNO.STUDY_PATH
                            AND A.TZTDMTO_DESC_CODE IS NOT NULL
                            AND A.TZTDMTO_MONTO = (SELECT MAX (TZTDMTO_MONTO)
                                                     FROM TZTDMTO A1
                                                    WHERE     A1.TZTDMTO_PIDM = A.TZTDMTO_PIDM
                                                          AND A1.TZTDMTO_CAMP_CODE = A.TZTDMTO_CAMP_CODE
                                                          AND A1.TZTDMTO_NIVEL = A.TZTDMTO_NIVEL
                                                          AND A1.TZTDMTO_TERM_CODE = A.TZTDMTO_TERM_CODE
                                                          AND A1.TZTDMTO_IND = 1
                                                          AND A1.TZTDMTO_DESC_CODE IS NOT NULL
                                                          AND TZTDMTO_STUDY_PATH = ALUMNO.STUDY_PATH
                                                          AND A1.TZTDMTO_PROGRAMA = A.TZTDMTO_PROGRAMA)
                            AND TZTDMTO_IND = 1 ;

                     VL_DESCUENTODSI := VL_DESCUENTODSI + (VL_DESCUENTODSI*(VN_PORC_INCREM/100));
                     BANDERADSI := VL_DESCUENTODSI;
                   EXCEPTION WHEN OTHERS THEN
                   VL_DESCUENTODSI  := 0;
                   BANDERADSI  := 0;
                   END;

               --    DBMS_OUTPUT.PUT_LINE('RESULTADO DE CALCULO DSI = '||VL_DESCUENTODSI||' = '||VL_CODIGO2||' = '||VL_DESCRIPCION);

                   IF VL_DESCUENTODSI = 0 THEN

                     BEGIN
                       SELECT TBRACCD_DETAIL_CODE,TBRACCD_DESC,TBRACCD_AMOUNT
                         INTO VL_CODIGO2,VL_DESCRIPCION,VL_DESCUENTODSI
                         FROM TBRACCD A
                        WHERE     A.TBRACCD_PIDM = ALUMNO.PIDM
                              AND A.TBRACCD_DETAIL_CODE = VL_CODIGO
                              AND A.TBRACCD_TRAN_NUMBER = (SELECT MAX(A1.TBRACCD_TRAN_NUMBER)
                                                             FROM TBRACCD A1
                                                            WHERE     A1.TBRACCD_PIDM = A.TBRACCD_PIDM
                                                                  AND A1.TBRACCD_DETAIL_CODE = A.TBRACCD_DETAIL_CODE);

                        VL_DESCUENTODSI := VL_DESCUENTODSI + (VL_DESCUENTODSI*(VN_PORC_INCREM/100));
                        BANDERADSI := VL_DESCUENTODSI;

                     EXCEPTION WHEN OTHERS THEN
                     VL_DESCUENTODSI  := 0;
                     BANDERADSI  := 0;
                     END;

                   END IF;

                   VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);

                   IF ALUMNO.TIPO_ALUMNO = 'N' THEN
                     IF ALUMNO.NUM_PAGOS = 4 AND ALUMNO.PERIODICIDAD =  'Bime' THEN
                       VL_DESCUENTODSI:= VL_DESCUENTODSI/2;
                     END IF;
                   END IF;

                   IF ALUMNO.NUM_PAGOS = 4 AND ALUMNO.PERIODICIDAD =  'Bime' THEN
                         VN_NUM_PAGOS:= ALUMNO.NUM_PAGOS/2;
                   ELSE
                        VN_NUM_PAGOS:= ALUMNO.NUM_PAGOS;
                   END IF;

                   IF BANDERADSI > 0 THEN

                     BEGIN
                      DELETE
                        FROM TBRACCD
                       WHERE     TBRACCD_PIDM = ALUMNO.PIDM
                             AND TBRACCD_DETAIL_CODE = VL_CODIGO2
                             AND (TBRACCD_BALANCE + TBRACCD_AMOUNT) = 0;
                     END;

                     IF VL_DESCUENTODSI != 0 THEN

                       VL_PLAN_PAGO := VL_COLEGIATURA - (NVL(VL_DESCUENTO,0)+NVL(VL_DESCUENTODSI,0));

                       VL_PARCIALIDAD := ROUND(VL_PLAN_PAGO/VN_NUM_PAGOS);

                       VL_PLAN_PAGO:= VL_PARCIALIDAD*VN_NUM_PAGOS;

                       VL_DIF_DSI := NVL(VL_COLEGIATURA - VL_PLAN_PAGO - (NVL(ROUND(VL_DESCUENTO),0))-NVL(VL_DESCUENTODSI,0),0);

                       VL_DESCUENTODSI:= VL_DIF_DSI+VL_DESCUENTODSI;

                     END IF;


                     VL_ERROR:=PKG_FINANZAS.F_INSERTA_TBRACCD(
                                                 P_PIDM => ALUMNO.PIDM
                                               , P_SECUENCIA => VL_SECUENCIA
                                               , P_NUMBER_PAID => VL_SECUENCIACOL--vl_tran_num
                                               , P_PERIODO => ALUMNO.PERIODO
                                               , P_PARTE_PERIODO => ALUMNO.PARTE_PERIODO
                                               , P_CODIGO => VL_CODIGO2
                                               , P_MONTO => VL_DESCUENTODSI
                                               , P_BALANCE => VL_DESCUENTODSI*-1
                                               , P_FECHA_VENC => VD_FECHA_INICIO--sysdate
                                               , P_DESCRIP => VL_DESCRIPCION
                                               , P_STUDY_PATH => ALUMNO.STUDY_PATH
                                               , P_ORIGEN => 'TZFEDCA (DSI)'
                                               ,P_FECHA_INICIO => ALUMNO.FECHA_INICIO);

                        VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;

                   END IF;

                   VL_CODIGO := NULL;
                   VL_DESCRIPCION := NULL;

                   BEGIN
                     SELECT DISTINCT ZSTPARA_PARAM_VALOR
                       INTO VL_LPC
                       FROM ZSTPARA
                      WHERE     ZSTPARA_MAPA_ID = 'PLPA_CAMP'
                            AND ZSTPARA_PARAM_ID =  SUBSTR(ALUMNO.PERIODO,1,2);
                   EXCEPTION
                   WHEN OTHERS THEN
                   VL_LPC:= NULL;
                   END;

                   IF VL_LPC IS NULL THEN

                     BEGIN
                       SELECT TBBDETC_DETAIL_CODE, TBBDETC_DESC
                         INTO VL_CODIGO, VL_DESCRIPCION
                         FROM TBBDETC
                        WHERE     TBBDETC_DCAT_CODE = 'LPC'
                              AND TBBDETC_DETAIL_CODE = 'PLPA'
                              AND TBBDETC_DETC_ACTIVE_IND = 'Y';
                     EXCEPTION
                     WHEN OTHERS THEN
                         VL_CODIGO := NULL;
                         VL_DESCRIPCION := NULL;
                     END;

                   ELSE

                     BEGIN
                       SELECT TBBDETC_DETAIL_CODE, TBBDETC_DESC
                         INTO VL_CODIGO, VL_DESCRIPCION
                         FROM TBBDETC
                        WHERE TBBDETC_DETAIL_CODE = VL_LPC;
                     EXCEPTION
                     WHEN OTHERS THEN
                     VL_CODIGO := NULL;
                     VL_DESCRIPCION := NULL;
                     END;

                   END IF;

                   VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);

                   VL_PLAN_PAGO := VL_COLEGIATURA - (NVL(VL_DESCUENTO,0)+NVL(VL_DESCUENTODSI,0));

                   VL_PARCIALIDAD := ROUND(VL_PLAN_PAGO/VN_NUM_PAGOS);

                   VL_PLAN_PAGO:= VL_PARCIALIDAD*VN_NUM_PAGOS;

                   IF VL_DESCUENTODSI = 0 THEN

                     VL_PLAN_PAGO := VL_COLEGIATURA - ROUND(NVL(VL_DESCUENTO,0));

                   END IF;


                   If alumno.campus = 'UIN' then
                       vl_colegiatura_uin:= 0;

--                       DBMS_OUTPUT.PUT_LINE('VALIDA EL CAMPUS UIN');

                      Begin
                            Select count (1)
                                into vl_colegiatura_uin
                            from tbraccd
                            Where 1=1
                            And tbraccd_pidm = ALUMNO.PIDM
                            And tbraccd_detail_code = VL_CODIGO
                           -- And  TBRACCD_PERIOD = ALUMNO.PARTE_PERIODO
                            And  TBRACCD_CREATE_SOURCE = 'TZFEDCA (PARC)'
                            And  TRUNC (TBRACCD_EFFECTIVE_DATE) = VD_FECHA_INICIO;
                      Exception
                        When Others then 
                         vl_colegiatura_uin:=0;
                      End;

                        --DBMS_OUTPUT.PUT_LINE('VALIDA EXISTE COLEGIATURA '||vl_colegiatura_uin);                   


                      If vl_colegiatura_uin >= 1 then   -----Victor aqui

                         VD_FECHA_INICIO:= ADD_MONTHS(TO_DATE(VD_FECHA_INICIO,'DD,MM,YYYY'),1);
                         iF substr (TO_DATE(VD_FECHA_INICIO,'DD/MM/YYYY'),1,2) IN ('11', '16', '31') THEN 
                            VD_FECHA_INICIO:= TO_DATE(VD_FECHA_INICIO,'DD,MM,YYYY') -1;
                         End if;      


                         --DBMS_OUTPUT.PUT_LINE('VALIDA FECHA VENCIMIENTO '||VD_FECHA_INICIO);      

                      End if;

                   End if ;




                   VL_ERROR:=PKG_FINANZAS.F_INSERTA_TBRACCD(
                                               P_PIDM => ALUMNO.PIDM
                                             , P_SECUENCIA => VL_SECUENCIA
                                             , P_NUMBER_PAID => VL_SECUENCIACOL--vl_tran_num
                                             , P_PERIODO => ALUMNO.PERIODO
                                             , P_PARTE_PERIODO => ALUMNO.PARTE_PERIODO
                                             , P_CODIGO => VL_CODIGO
                                             , P_MONTO => VL_PLAN_PAGO--vl_monto2
                                             , P_BALANCE => VL_PLAN_PAGO*-1 --vl_monto2*-1
                                             , P_FECHA_VENC => VD_FECHA_INICIO--sysdate
                                             , P_DESCRIP => VL_DESCRIPCION
                                             , P_STUDY_PATH => ALUMNO.STUDY_PATH
                                             , P_ORIGEN => 'TZFEDCA (PLPA)'
                                             ,P_FECHA_INICIO => ALUMNO.FECHA_INICIO) ;

                         VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;
                 END IF;

                 IF VL_ERROR IS NULL  THEN

                   VL_CODIGO := NULL;
                   VL_DESCRIPCION := NULL;
                   VL_MONTO := 0;
                   VL_SECUENCIA :=0;
                   VL_NUM_PARC :=0;

                   VL_DIA := CASE SUBSTR(VL_SFRRGFE_RATE_CODE,4,1) WHEN 'A' THEN 15 WHEN 'B' THEN 30 WHEN 'C' THEN 10 END;
                   VL_MES :=SUBSTR (TO_CHAR(VD_FECHA_INICIO/*alumno.fecha_inicio*/, 'dd/mm/rrrr'), 4, 2);
                   VL_ANO :=SUBSTR (TO_CHAR(VD_FECHA_INICIO/*alumno.fecha_inicio*/, 'dd/mm/rrrr'), 7, 4);

                   BEGIN
                     SELECT TBBDETC_DETAIL_CODE, TBBDETC_DESC
                       INTO VL_CODIGO, VL_DESCRIPCION
                       FROM TBBDETC
                      WHERE     TBBDETC_DCAT_CODE = 'COL'
                            AND SUBSTR (TBBDETC_DETAIL_CODE, 1, 2 )  = SUBSTR (ALUMNO.PERIODO, 1, 2)
                            AND SUBSTR (TBBDETC_DETAIL_CODE,1,3) = SUBSTR (ALUMNO.PERIODO, 1, 2)||'N'
                            AND TBBDETC_DETC_ACTIVE_IND = 'Y'
                            AND TBBDETC_TAXT_CODE = ALUMNO.NIVEL;
                   EXCEPTION
                   WHEN OTHERS THEN
                     BEGIN
                       SELECT ZSTPARA_PARAM_ID,ZSTPARA_PARAM_DESC
                         INTO VL_CODIGO, VL_DESCRIPCION
                         FROM ZSTPARA
                        WHERE     ZSTPARA_MAPA_ID = 'COD_DET_X_PROG'
                              AND ZSTPARA_PARAM_DESC LIKE '%PARCIALIDAD%'
                              AND ZSTPARA_PARAM_VALOR = ALUMNO.PROGRAMA;
                     EXCEPTION
                     WHEN OTHERS THEN
                     VL_CODIGO       := NULL;
                     VL_DESCRIPCION:= NULL;
                     END;
                   END;

                   IF ALUMNO.NUM_PAGOS = 4 AND ALUMNO.PERIODICIDAD =  'Bime' THEN
                     VN_NUM_PAGOS:= ALUMNO.NUM_PAGOS/2;
                   ELSE
                     VN_NUM_PAGOS:= ALUMNO.NUM_PAGOS;
                   END IF;

                   VL_PARCIALIDAD := (VL_PLAN_PAGO/VN_NUM_PAGOS);

                   FOR I IN 1..VN_NUM_PAGOS LOOP

                     IF VL_DIA = '30' THEN
                       VL_VENCIMIENTO := CASE LPAD(VL_MES,2,'0') WHEN '02' THEN '28' ELSE VL_DIA END||'/'||LPAD(VL_MES,2,'0')||'/'||VL_ANO;
                     ELSE
                       VL_VENCIMIENTO := VL_DIA||'/'||LPAD(VL_MES,2,'0')||'/'||VL_ANO;
                     END IF;

                     V_ENTRA:= NULL;

                     BEGIN
                       SELECT COUNT(*)
                         INTO V_ENTRA
                         FROM TZFACCE
                        WHERE     TZFACCE_PIDM = ALUMNO.PIDM
                              AND TZFACCE_TERM_CODE = ALUMNO.PERIODO
                              AND TZFACCE_USER = 'REZA'
                              AND TZFACCE_FLAG = 0
                              AND TZFACCE_EFFECTIVE_DATE = TO_DATE(VL_VENCIMIENTO,'DD,MM,YYYY');
                     EXCEPTION
                     WHEN OTHERS THEN
                     V_ENTRA := 0;
                     END;

                     IF V_ENTRA > 0 THEN

                       FOR X IN (
                                 SELECT DISTINCT TZFACCE_DETAIL_CODE,TZFACCE_AMOUNT,TZFACCE_EFFECTIVE_DATE,TZFACCE_DESC,TZFACCE_STUDY,TBBDETC_TYPE_IND
                                   FROM TZFACCE A,TBBDETC
                                  WHERE     A.TZFACCE_DETAIL_CODE = TBBDETC_DETAIL_CODE
                                        AND A.TZFACCE_PIDM = ALUMNO.PIDM
                                        AND A.TZFACCE_TERM_CODE = ALUMNO.PERIODO
                                        AND A.TZFACCE_USER = 'REZA'
                                        AND A.TZFACCE_FLAG = 0
                                        AND A.TZFACCE_EFFECTIVE_DATE = TO_DATE(VL_VENCIMIENTO,'DD,MM,YYYY')
                                        AND A.TZFACCE_SEC_PIDM IN (SELECT MAX(A1.TZFACCE_SEC_PIDM)
                                                                     FROM TZFACCE A1
                                                                    WHERE     A1.TZFACCE_PIDM = A.TZFACCE_PIDM
                                                                          AND A1.TZFACCE_TERM_CODE = A.TZFACCE_TERM_CODE
                                                                          AND A1.TZFACCE_FLAG = A.TZFACCE_FLAG
                                                                          AND A.TZFACCE_EFFECTIVE_DATE = TO_DATE(VL_VENCIMIENTO,'DD,MM,YYYY')
                                                                          AND A1.TZFACCE_DETAIL_CODE = A.TZFACCE_DETAIL_CODE)
                                   And a.TZFACCE_DETAIL_CODE not in (select codigo from TZTINC) ---> Quita complemento

                       )LOOP

                         VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);
                         VL_SECUENCIACOL := VL_SECUENCIA;

                         IF X.TBBDETC_TYPE_IND = 'C' THEN

                           BEGIN
                             INSERT
                               INTO TBRACCD
                             VALUES (
                                     ALUMNO.PIDM,   -- TBRACCD_PIDM
                                     VL_SECUENCIACOL,     --TBRACCD_TRAN_NUMBER
                                     ALUMNO.PERIODO,    -- TBRACCD_TERM_CODE
                                     X.TZFACCE_DETAIL_CODE,--vp_inscrip_code,     ---TBRACCD_DETAIL_CODE
                                     USER,     ---TBRACCD_USER
                                     SYSDATE,     --TBRACCD_ENTRY_DATE
                                     NVL(X.TZFACCE_AMOUNT,0),
                                     NVL(X.TZFACCE_AMOUNT,0),    ---TBRACCD_BALANCE
                                     VL_VENCIMIENTO,     -- TBRACCD_EFFECTIVE_DATE
                                     NULL,    --TBRACCD_BILL_DATE
                                     NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                                     X.TZFACCE_DESC,    -- TBRACCD_DESC
                                     ALUMNO.FOLIO,     --TBRACCD_RECEIPT_NUMBER
                                     NULL,     --TBRACCD_TRAN_NUMBER_PAID
                                     NULL,     --TBRACCD_CROSSREF_PIDM
                                     NULL,    --TBRACCD_CROSSREF_NUMBER
                                     NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                                     'T',    --TBRACCD_SRCE_CODE
                                     'Y',    --TBRACCD_ACCT_FEED_IND
                                     SYSDATE,  --TBRACCD_ACTIVITY_DATE
                                     0,        --TBRACCD_SESSION_NUMBER
                                     NULL,    -- TBRACCD_CSHR_END_DATE
                                     NULL,     --TBRACCD_CRN
                                     NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                                     NULL,     -- TBRACCD_LOC_MDT
                                     NULL,     --TBRACCD_LOC_MDT_SEQ
                                     NULL,     -- TBRACCD_RATE
                                     NULL,     --TBRACCD_UNITS
                                     NULL,     -- TBRACCD_DOCUMENT_NUMBER
                                     VL_VENCIMIENTO,  -- TBRACCD_TRANS_DATE
                                     NULL,        -- TBRACCD_PAYMENT_ID
                                     NULL,     -- TBRACCD_INVOICE_NUMBER
                                     NULL,     -- TBRACCD_STATEMENT_DATE
                                     NULL,     -- TBRACCD_INV_NUMBER_PAID
                                     'MXN',     -- TBRACCD_CURR_CODE
                                     NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                                     NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                                     NULL,     -- TBRACCD_LATE_DCAT_CODE
                                     ALUMNO.FECHA_INICIO,     -- TBRACCD_FEED_DATE
                                     NULL,     -- TBRACCD_FEED_DOC_CODE
                                     NULL,     -- TBRACCD_ATYP_CODE
                                     NULL,     -- TBRACCD_ATYP_SEQNO
                                     NULL,     -- TBRACCD_CARD_TYPE_VR
                                     NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                                     NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                                     NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                                     NULL,     -- TBRACCD_ORIG_CHG_IND
                                     NULL,     -- TBRACCD_CCRD_CODE
                                     NULL,     -- TBRACCD_MERCHANT_ID
                                     NULL,     -- TBRACCD_TAX_REPT_YEAR
                                     NULL,     -- TBRACCD_TAX_REPT_BOX
                                     NULL,     -- TBRACCD_TAX_AMOUNT
                                     NULL,     -- TBRACCD_TAX_FUTURE_IND
                                     'TZFEDCA(ACC)',     -- TBRACCD_DATA_ORIGIN
                                     'TZFEDCA(ACC)',   -- TBRACCD_CREATE_SOURCE
                                     NULL,     -- TBRACCD_CPDT_IND
                                     NULL,     --TBRACCD_AIDY_CODE
                                     X.TZFACCE_STUDY,     --TBRACCD_STSP_KEY_SEQUENCE
                                     ALUMNO.PARTE_PERIODO,     --TBRACCD_PERIOD
                                     NULL,    --TBRACCD_SURROGATE_ID
                                     NULL,     -- TBRACCD_VERSION
                                     USER,     --TBRACCD_USER_ID
                                     NULL );     --TBRACCD_VPDI_CODE
                           EXCEPTION
                           WHEN OTHERS THEN
                           VL_ERROR := 'Se presento ERROR INSERT TBRACCD '||SQLERRM;
                           END;

                         ELSIF X.TBBDETC_TYPE_IND = 'P' THEN

                           BEGIN
                             INSERT
                               INTO TBRACCD
                             VALUES (
                                    ALUMNO.PIDM,   -- TBRACCD_PIDM
                                    VL_SECUENCIACOL,     --TBRACCD_TRAN_NUMBER
                                    ALUMNO.PERIODO,    -- TBRACCD_TERM_CODE
                                    X.TZFACCE_DETAIL_CODE,--vp_inscrip_code,     ---TBRACCD_DETAIL_CODE
                                    USER,     ---TBRACCD_USER
                                    SYSDATE,     --TBRACCD_ENTRY_DATE
                                    NVL(X.TZFACCE_AMOUNT,0),
                                    NVL(X.TZFACCE_AMOUNT,0)*-1,    ---TBRACCD_BALANCE
                                    VL_VENCIMIENTO,     -- TBRACCD_EFFECTIVE_DATE
                                    NULL,    --TBRACCD_BILL_DATE
                                    NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                                    X.TZFACCE_DESC,    -- TBRACCD_DESC
                                    ALUMNO.FOLIO,     --TBRACCD_RECEIPT_NUMBER
                                    VL_SECUENCIACOL+1,     --TBRACCD_TRAN_NUMBER_PAID
                                    NULL,     --TBRACCD_CROSSREF_PIDM
                                    NULL,    --TBRACCD_CROSSREF_NUMBER
                                    NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                                    'T',    --TBRACCD_SRCE_CODE
                                    'Y',    --TBRACCD_ACCT_FEED_IND
                                    SYSDATE,  --TBRACCD_ACTIVITY_DATE
                                    0,        --TBRACCD_SESSION_NUMBER
                                    NULL,    -- TBRACCD_CSHR_END_DATE
                                    NULL,     --TBRACCD_CRN
                                    NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                                    NULL,     -- TBRACCD_LOC_MDT
                                    NULL,     --TBRACCD_LOC_MDT_SEQ
                                    NULL,     -- TBRACCD_RATE
                                    NULL,     --TBRACCD_UNITS
                                    NULL,     -- TBRACCD_DOCUMENT_NUMBER
                                    VL_VENCIMIENTO,  -- TBRACCD_TRANS_DATE
                                    NULL,        -- TBRACCD_PAYMENT_ID
                                    NULL,     -- TBRACCD_INVOICE_NUMBER
                                    NULL,     -- TBRACCD_STATEMENT_DATE
                                    NULL,     -- TBRACCD_INV_NUMBER_PAID
                                    'MXN',     -- TBRACCD_CURR_CODE
                                    NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                                    NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                                    NULL,     -- TBRACCD_LATE_DCAT_CODE
                                    ALUMNO.FECHA_INICIO,     -- TBRACCD_FEED_DATE
                                    NULL,     -- TBRACCD_FEED_DOC_CODE
                                    NULL,     -- TBRACCD_ATYP_CODE
                                    NULL,     -- TBRACCD_ATYP_SEQNO
                                    NULL,     -- TBRACCD_CARD_TYPE_VR
                                    NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                                    NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                                    NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                                    NULL,     -- TBRACCD_ORIG_CHG_IND
                                    NULL,     -- TBRACCD_CCRD_CODE
                                    NULL,     -- TBRACCD_MERCHANT_ID
                                    NULL,     -- TBRACCD_TAX_REPT_YEAR
                                    NULL,     -- TBRACCD_TAX_REPT_BOX
                                    NULL,     -- TBRACCD_TAX_AMOUNT
                                    NULL,     -- TBRACCD_TAX_FUTURE_IND
                                    'TZFEDCA(ACC)',     -- TBRACCD_DATA_ORIGIN
                                    'TZFEDCA(ACC)',   -- TBRACCD_CREATE_SOURCE
                                    NULL,     -- TBRACCD_CPDT_IND
                                    NULL,     --TBRACCD_AIDY_CODE
                                    X.TZFACCE_STUDY,     --TBRACCD_STSP_KEY_SEQUENCE
                                    ALUMNO.PARTE_PERIODO,     --TBRACCD_PERIOD
                                    NULL,    --TBRACCD_SURROGATE_ID
                                    NULL,     -- TBRACCD_VERSION
                                    USER,     --TBRACCD_USER_ID
                                    NULL );     --TBRACCD_VPDI_CODE
                           EXCEPTION
                           WHEN OTHERS THEN
                           VL_ERROR := 'Se presento ERROR INSERT TBRACCD '||SQLERRM;
                           END;

                         END IF;

                         BEGIN
                           UPDATE TZFACCE
                              SET TZFACCE_FLAG = 1,
                                  TZFACCE_USER = 'REZA-->3'
                            WHERE     TZFACCE_PIDM = ALUMNO.PIDM
                                  AND TZFACCE_TERM_CODE = ALUMNO.PERIODO
                                  AND TZFACCE_USER = 'REZA'
                                  AND TZFACCE_FLAG = 0
                                  AND TZFACCE_DETAIL_CODE = X.TZFACCE_DETAIL_CODE;
                         END;

                       END LOOP;

                     END IF;

                     BEGIN
                       SELECT COUNT(*)
                         INTO VL_ESCA
                         FROM TZFACCE
                        WHERE     TZFACCE_PIDM = ALUMNO.PIDM
                              AND TZFACCE_USER = 'REZA'
                              AND TZFACCE_FLAG = 0
                              AND SUBSTR(TZFACCE_DETAIL_CODE,3,2) = 'M3';
                     EXCEPTION
                     WHEN OTHERS THEN
                     VL_ESCA := 0;
                     END;

                     IF VL_ESCA = 0 THEN

                       DELETE GORADID
                        WHERE     GORADID_ADID_CODE = 'ESCA'
                              AND GORADID_PIDM = ALUMNO.PIDM;
                     END IF;

                     VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);
                   If alumno.campus = 'UIN' then
                       vl_colegiatura_uin:= 0;

                      Begin
                            Select count (1)
                                into vl_colegiatura_uin
                            from tbraccd
                            Where 1=1
                            And tbraccd_pidm = ALUMNO.PIDM
                            And tbraccd_detail_code = VL_CODIGO
                            And  TBRACCD_PERIOD = ALUMNO.PARTE_PERIODO
                            And  TBRACCD_CREATE_SOURCE = 'TZFEDCA (PARC)'
                            And  TBRACCD_FEED_DATE = VL_VENCIMIENTO;
                      Exception
                        When Others then 
                         vl_colegiatura_uin:=0;
                      End;

                      If vl_colegiatura_uin >= 1 then   -----Victor aqui
                         VL_VENCIMIENTO:= ADD_MONTHS(TO_DATE(VL_VENCIMIENTO,'DD,MM,YYYY'),1);
                      End if;

                   End if ;                     


                     VL_ERROR:= PKG_FINANZAS.F_INSERTA_TBRACCD(
                                                   P_PIDM => ALUMNO.PIDM
                                                 , P_SECUENCIA => VL_SECUENCIA
                                                 , P_NUMBER_PAID => NULL
                                                 , P_PERIODO => ALUMNO.PERIODO
                                                 , P_PARTE_PERIODO => ALUMNO.PARTE_PERIODO
                                                 , P_CODIGO => VL_CODIGO
                                                 , P_MONTO => VL_PARCIALIDAD--vl_monto2/alumno.num_pagos
                                                 , P_BALANCE => VL_PARCIALIDAD--vl_monto2/alumno.num_pagos
                                                 , P_FECHA_VENC => VL_VENCIMIENTO
                                                 , P_DESCRIP => VL_DESCRIPCION
                                                 , P_STUDY_PATH => ALUMNO.STUDY_PATH
                                                 , P_ORIGEN => 'TZFEDCA (PARC2)'
                                                 ,P_FECHA_INICIO => ALUMNO.FECHA_INICIO);

                     IF (P_LLAMADA  != 'REPROCESO' OR  P_LLAMADA IS NULL) THEN

--                       VL_CART_UTL:= PKG_FINANZAS.F_MEMBRESIA_UTLX( ALUMNO.MATRICULA,
--                                                                    'CARTERA',
--                                                                    VL_VENCIMIENTO,
--                                                                    ALUMNO.PERIODO,
--                                                                    ALUMNO.FECHA_INICIO,
--                                                                    ALUMNO.STUDY_PATH,
--                                                                    ALUMNO.PARTE_PERIODO);
                         null;
                     END IF;

                     VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;
                     VL_MES := VL_MES +1;

                     IF VL_MES = '13' THEN
                       VL_MES := '01';
                       VL_ANO := VL_ANO +1;
                     END IF;

                   END LOOP;

                 END IF;

               ELSE
                 VL_ERROR :='No existe configuración en: SGRSATT y/o SFRRGFE' ;
                 VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;
                 VL_PLAN_BITA :=0;
               END IF;

             ELSIF VL_COD_EXCLU = 0 THEN
               VL_ERROR :='Ya Existe la Cartera debido a que es un Plan ';
               VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;
               VL_PLAN_BITA :=1;
             END IF;

           END IF;


       ELSIF VL_SIN_ORDEN > 0 THEN

           VL_ERROR :='Ya Existe la Cartera para este numero de orden '||VL_SIN_ORDEN;
           VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;
           VL_PLAN_BITA :=1;
           --DBMS_OUTPUT.PUT_LINE('VL_SIN_ORDEN ELSIF = '||VL_CADENAERROR);
       ELSE
           VL_ERROR :='Ya Existe la Cartera para el periodo '||ALUMNO.PERIODO;
           VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;
           VL_PLAN_BITA :=1;
            --DBMS_OUTPUT.PUT_LINE('VL_SIN_ORDEN ELSE = '||VL_CADENAERROR);
       END IF;

       IF   VL_ERROR IS NULL THEN
         COMMIT;
           --ROLLBACK;
       ELSE
         ROLLBACK;
       END IF;

       IF VL_ERROR IS NULL THEN

         VL_BIME := PKG_FINANZAS.F_BIME_GRATIS ( ALUMNO.PIDM,
                                                 ALUMNO.STUDY_PATH,
                                                 ALUMNO.FECHA_INICIO,
                                                 ALUMNO.PERIODICIDAD,
                                                 ALUMNO.NIVEL);

---------------------------------------------------------------------------------------------------
      VL_PAGOUNICO := PKG_FINANZAS.F_DES_PAG_UNI_NW ( ALUMNO.PIDM, ALUMNO.FECHA_INICIO, ALUMNO.FECHA_INICIO); ---> Se cambia por la nueva funcion
       ---------------------------------------------------------------------------------------------------


         VL_SECUEN:= null;

         IF ALUMNO.FOLIO IS NULL THEN

           BEGIN
             SELECT NVL(MAX(TZTORDR_CONTADOR),0)
               INTO VL_PROSPECTO
               FROM TZTORDR
              WHERE     TZTORDR_PIDM = ALUMNO.PIDM
                    AND TZTORDR_DATA_ORIGIN = 'PROSPECTO';
           EXCEPTION
           WHEN OTHERS THEN
           VL_PROSPECTO:= 0;
           END;

           IF VL_PROSPECTO > 0 THEN

             BEGIN
               UPDATE TZTORDR
                  SET TZTORDR_CAMPUS = ALUMNO.CAMPUS,
                      TZTORDR_NIVEL    = ALUMNO.NIVEL,
                      TZTORDR_PROGRAMA    = ALUMNO.PROGRAMA,
                      TZTORDR_ACTIVITY_DATE= SYSDATE,
                      TZTORDR_USER  = USER,
                      TZTORDR_DATA_ORIGIN = 'TZTFEDCA',
                      TZTORDR_FECHA_INICIO  = ALUMNO.FECHA_INICIO,
                      TZTORDR_RATE  = ALUMNO.RATE,
                      TZTORDR_JORNADA= VC_JORNADA,
                      TZTORDR_DSI  = VL_DESCUENTODSI,
                      TZTORDR_TERM_CODE = ALUMNO.PERIODO
                WHERE     TZTORDR_PIDM = ALUMNO.PIDM
                      AND TZTORDR_DATA_ORIGIN = 'PROSPECTO'
                      And TZTORDR_CONTADOR = VL_PROSPECTO;
             EXCEPTION
             WHEN OTHERS THEN
             NULL;
             END;

             BEGIN
               UPDATE TBRACCD A1
                  SET A1.TBRACCD_RECEIPT_NUMBER = VL_PROSPECTO
                WHERE     A1.TBRACCD_PIDM = ALUMNO.PIDM
                      AND A1.TBRACCD_TERM_CODE = ALUMNO.PERIODO
                      AND A1.TBRACCD_PERIOD = ALUMNO.PARTE_PERIODO
                      AND A1.TBRACCD_STSP_KEY_SEQUENCE = ALUMNO.STUDY_PATH
                      AND A1.TBRACCD_RECEIPT_NUMBER IS NULL ;
             EXCEPTION
               WHEN OTHERS THEN
               NULL;
             END;

             BEGIN
               UPDATE TVRACCD A1
                  SET A1.TVRACCD_RECEIPT_NUMBER = VL_PROSPECTO
                WHERE     A1.TVRACCD_PIDM = ALUMNO.PIDM
                      AND A1.TVRACCD_TERM_CODE = ALUMNO.PERIODO
                      AND A1.TVRACCD_PERIOD = ALUMNO.PARTE_PERIODO
                      AND A1.TVRACCD_STSP_KEY_SEQUENCE = ALUMNO.STUDY_PATH
                      AND A1.TVRACCD_RECEIPT_NUMBER IS NULL;
             EXCEPTION
               WHEN OTHERS THEN
               NULL;
             END;

             BEGIN
               UPDATE SFRSTCR
                  SET SFRSTCR_VPDI_CODE = VL_PROSPECTO
                WHERE     SFRSTCR_PIDM = ALUMNO.PIDM
                      AND SFRSTCR_TERM_CODE = ALUMNO.PERIODO
                      AND SFRSTCR_PTRM_CODE = ALUMNO.PARTE_PERIODO
                      AND SFRSTCR_STSP_KEY_SEQUENCE = ALUMNO.STUDY_PATH
                      AND SFRSTCR_VPDI_CODE IS NULL;
             EXCEPTION
               WHEN OTHERS THEN
               NULL;
             END;

           ELSIF VL_PROSPECTO = 0 THEN
            VL_SECUEN:=null;

             BEGIN
               SELECT MAX(TZTORDR_CONTADOR)+1
                 INTO VL_SECUEN
                 FROM TZTORDR;
             EXCEPTION
             WHEN OTHERS THEN
             VL_SECUEN:= NULL;
             END;



             IF VL_SECUEN IS NOT NULL THEN
                VL_PROSPECTO:=0;

                Begin
                    Select count(1)
                        Into VL_PROSPECTO
                    from TZTORDR
                    Where TZTORDR_CONTADOR = VL_SECUEN;
                Exception
                    When Others then
                        VL_PROSPECTO:=0;
                End;

                    If VL_PROSPECTO > 0 then
                       VL_SECUEN:= VL_SECUEN+1;
                    End if;

                BEgin
                     INSERT
                         INTO TZTORDR
                               ( TZTORDR_CAMPUS,
                                 TZTORDR_NIVEL,
                                 TZTORDR_CONTADOR,
                                 TZTORDR_PROGRAMA,
                                 TZTORDR_PIDM,
                                 TZTORDR_ID,
                                 TZTORDR_ESTATUS,
                                 TZTORDR_ACTIVITY_DATE,
                                 TZTORDR_USER,
                                 TZTORDR_DATA_ORIGIN,
                                 TZTORDR_NO_REGLA,
                                 TZTORDR_FECHA_INICIO,
                                 TZTORDR_RATE,
                                 TZTORDR_JORNADA,
                                 TZTORDR_DSI,
                                 TZTORDR_TERM_CODE)
                       VALUES ( ALUMNO.CAMPUS,
                                ALUMNO.NIVEL,
                                VL_SECUEN,
                                ALUMNO.PROGRAMA,
                                ALUMNO.PIDM,
                                ALUMNO.MATRICULA,
                                'S',
                                SYSDATE,
                                USER,
                                'TZTFEDCA',
                                NULL,
                                ALUMNO.FECHA_INICIO,
                                ALUMNO.RATE,
                                VC_JORNADA,
                                VL_DESCUENTODSI,
                                ALUMNO.PERIODO);
                Exception
                    When Others then
                        null;
                End;
             END IF;

             BEGIN
               UPDATE TBRACCD A1
                  SET A1.TBRACCD_RECEIPT_NUMBER = VL_SECUEN
                WHERE     A1.TBRACCD_PIDM = ALUMNO.PIDM
                      AND A1.TBRACCD_TERM_CODE = ALUMNO.PERIODO
                      AND A1.TBRACCD_PERIOD = ALUMNO.PARTE_PERIODO
                      AND A1.TBRACCD_STSP_KEY_SEQUENCE = ALUMNO.STUDY_PATH
                      AND A1.TBRACCD_RECEIPT_NUMBER IS NULL ;
             EXCEPTION
             WHEN OTHERS THEN
             NULL;
             END;

             BEGIN
               UPDATE TVRACCD A1
                  SET A1.TVRACCD_RECEIPT_NUMBER = VL_SECUEN
                WHERE     A1.TVRACCD_PIDM = ALUMNO.PIDM
                      AND A1.TVRACCD_TERM_CODE = ALUMNO.PERIODO
                      AND A1.TVRACCD_PERIOD = ALUMNO.PARTE_PERIODO
                      AND A1.TVRACCD_STSP_KEY_SEQUENCE = ALUMNO.STUDY_PATH
                      AND A1.TVRACCD_RECEIPT_NUMBER IS NULL;
             EXCEPTION
             WHEN OTHERS THEN
             NULL;
             END;

             BEGIN
               UPDATE SFRSTCR
                  SET SFRSTCR_VPDI_CODE = VL_SECUEN
                WHERE     SFRSTCR_PIDM = ALUMNO.PIDM
                      AND SFRSTCR_TERM_CODE = ALUMNO.PERIODO
                      AND SFRSTCR_PTRM_CODE = ALUMNO.PARTE_PERIODO
                      AND SFRSTCR_STSP_KEY_SEQUENCE = ALUMNO.STUDY_PATH
                      AND SFRSTCR_VPDI_CODE IS NULL;
             EXCEPTION
             WHEN OTHERS THEN
             NULL;
             END;

           END IF;

         ELSE

            BEGIN
               UPDATE TBRACCD A1
                  SET A1.TBRACCD_RECEIPT_NUMBER = ALUMNO.FOLIO
                WHERE     A1.TBRACCD_PIDM = ALUMNO.PIDM
                      AND A1.TBRACCD_TERM_CODE = ALUMNO.PERIODO
                      AND A1.TBRACCD_PERIOD = ALUMNO.PARTE_PERIODO
                      AND A1.TBRACCD_STSP_KEY_SEQUENCE = ALUMNO.STUDY_PATH
                      AND A1.TBRACCD_RECEIPT_NUMBER IS NULL ;
             EXCEPTION
             WHEN OTHERS THEN
             NULL;
             END;

             BEGIN
               UPDATE TVRACCD A1
                  SET A1.TVRACCD_RECEIPT_NUMBER = ALUMNO.FOLIO
                WHERE     A1.TVRACCD_PIDM = ALUMNO.PIDM
                      AND A1.TVRACCD_TERM_CODE = ALUMNO.PERIODO
                      AND A1.TVRACCD_PERIOD = ALUMNO.PARTE_PERIODO
                      AND A1.TVRACCD_STSP_KEY_SEQUENCE = ALUMNO.STUDY_PATH
                      AND A1.TVRACCD_RECEIPT_NUMBER IS NULL;
             EXCEPTION
             WHEN OTHERS THEN
             NULL;
             END;
         END IF;

         COMMIT;

       ELSE

         ROLLBACK;

       END IF;

       BEGIN
         SELECT COUNT (1)
           INTO VL_EXISTE_BITA
           FROM TZDOCTR
          WHERE     TZDOCTR_PIDM = ALUMNO.PIDM
                AND TZDOCTR_PROGRAM = ALUMNO.PROGRAMA
                AND TZDOCTR_PTRM_CODE = ALUMNO.PARTE_PERIODO
                AND TZDOCTR_TERM_CODE =  ALUMNO.PERIODO
                AND TZDOCTR_START_DATE = ALUMNO.FECHA_INICIO--vd_Fecha_inicio
                AND TZDOCTR_STUDY_PATH = ALUMNO.STUDY_PATH
                AND TZDOCTR_TIPO_PROC != 'AUME'
                AND TZDOCTR_TIPO_PROC IN ('CART', 'EDCA');
       EXCEPTION
       WHEN OTHERS THEN
       VL_EXISTE_BITA :=0;
       END;

       IF VL_EXISTE_CART = 0 AND VL_EXISTE_DESC = 0 AND VL_EXISTE_PPLAN = 0 AND VL_EXISTE_PARC = 0 AND VL_ERROR IS NULL THEN  ----> Registra en la Bitacora ya sea exito en la creacion o error

         IF VL_EXISTE_BITA = 0 THEN

           BEGIN
               INSERT INTO TZDOCTR (
                 TZDOCTR_PIDM, TZDOCTR_PROGRAM, TZDOCTR_STST_CODE, TZDOCTR_STYP_CODE, TZDOCTR_CAMP_CODE
               , TZDOCTR_LEVL_CODE, TZDOCTR_TERM_CODE, TZDOCTR_START_DATE, TZDOCTR_PTRM_CODE, TZDOCTR_STUDY_PATH
               , TZDOCTR_NUM_PAGOS, TZDOCTR_RATE_CODE, TZDOCTR_COLEG, TZDOCTR_DESC, TZDOCTR_PPAGO
               , TZDOCTR_PARCI, FECHA_PROCESO, TZDOCTR_IND, TZDOCTR_OBSERVACIONES, TZDOCTR_VENCIMIENTO
               , TZDOCTR_ID, TZDOCTR_TIPO_PROC, TZDOCTR_DESCUENTO
               )
               VALUES (
                 ALUMNO.PIDM     , ALUMNO.PROGRAMA, ALUMNO.ESTATUS , ALUMNO.TIPO_ALUMNO  , ALUMNO.CAMPUS
               , ALUMNO.NIVEL    , ALUMNO.PERIODO , ALUMNO.FECHA_INICIO/*vd_Fecha_inicio*/, ALUMNO.PARTE_PERIODO, ALUMNO.STUDY_PATH
               , ALUMNO.NUM_PAGOS, ALUMNO.RATE    , VL_COLEGIATURA , VL_DESCUENTO        , VL_PLAN_PAGO
               , VL_PARCIALIDAD  , SYSDATE        , 1              , 'Cartera creada con exito para el periodo '||ALUMNO.PERIODO,ALUMNO.VENCIMIENTO
               , ALUMNO.MATRICULA, 'EDCA'         , VN_EXISTE_DSP
               );

               UPDATE TZDOCTR SET TZDOCTR_IND = 1,
               TZDOCTR_OBSERVACIONES_1     = 'Cartera creada con exito para el periodo '||ALUMNO.PERIODO
               --FECHA_PROCESO = trunc(sysdate)
               WHERE TZDOCTR_PIDM = ALUMNO.PIDM
               AND TZDOCTR_PROGRAM = ALUMNO.PROGRAMA
               AND TZDOCTR_TERM_CODE =  ALUMNO.PERIODO
               AND TZDOCTR_START_DATE = ALUMNO.FECHA_INICIO--vd_Fecha_inicio--
               AND TZDOCTR_TIPO_PROC = 'AUME'
               AND TZDOCTR_PERIODOS_CURSADOS=VN_PERIODOS_CURSADOS;

           EXCEPTION
           WHEN OTHERS THEN
               VL_ERROR1 :='Error al insertar la bitacora de la cartera' ||SQLERRM;
           END;

         ELSIF VL_EXISTE_BITA >= 1 THEN

           BEGIN
               UPDATE TZDOCTR
               SET TZDOCTR_IND = 1,
               TZDOCTR_OBSERVACIONES = 'Cartera creada con exito para el periodo '||ALUMNO.PERIODO,
               FECHA_PROCESO = SYSDATE,
               TZDOCTR_ID=ALUMNO.MATRICULA,
               TZDOCTR_COLEG = VL_COLEGIATURA,
               TZDOCTR_DESC  = VL_DESCUENTO,
               TZDOCTR_PPAGO = VL_PLAN_PAGO,
               TZDOCTR_PARCI = VL_PARCIALIDAD,
               TZDOCTR_DESCUENTO   = VN_EXISTE_DSP
               WHERE TZDOCTR_PIDM = ALUMNO.PIDM
               AND TZDOCTR_PROGRAM = ALUMNO.PROGRAMA
               AND TZDOCTR_TERM_CODE =  ALUMNO.PERIODO
               AND TZDOCTR_START_DATE = ALUMNO.FECHA_INICIO--vd_Fecha_inicio
               AND TZDOCTR_TIPO_PROC != 'AUME';

               UPDATE TZDOCTR SET TZDOCTR_IND = 1,
               TZDOCTR_OBSERVACIONES_1     = 'Cartera creada con exito para el periodo '||ALUMNO.PERIODO
               WHERE TZDOCTR_PIDM = ALUMNO.PIDM
               AND TZDOCTR_PROGRAM = ALUMNO.PROGRAMA
               AND TZDOCTR_TERM_CODE =  ALUMNO.PERIODO
               AND TZDOCTR_START_DATE = ALUMNO.FECHA_INICIO--vd_Fecha_inicio
               AND TZDOCTR_TIPO_PROC = 'AUME'
               AND TZDOCTR_PERIODOS_CURSADOS=VN_PERIODOS_CURSADOS;

           EXCEPTION
           WHEN OTHERS THEN
            VL_ERROR1 :='Error al insertar la bitacora de la cartera' ||SQLERRM;
           END;

         END IF;

       ELSIF VL_EXISTE_CART = 0 AND VL_EXISTE_DESC = 0 AND VL_EXISTE_PPLAN = 0 AND VL_EXISTE_PARC = 0 AND VL_ERROR IS NOT NULL THEN  ----> Registra en la Bitacora ya sea exito en la creacion o error

         BEGIN
           SELECT COUNT (1)
             INTO VL_EXISTE_BITA
             FROM TZDOCTR
            WHERE     TZDOCTR_PIDM = ALUMNO.PIDM
                  AND TZDOCTR_PROGRAM = ALUMNO.PROGRAMA
                  AND TZDOCTR_PTRM_CODE = ALUMNO.PARTE_PERIODO
                  AND TZDOCTR_TERM_CODE =  ALUMNO.PERIODO
                  AND TZDOCTR_START_DATE = ALUMNO.FECHA_INICIO--vd_Fecha_inicio
                  AND TZDOCTR_TIPO_PROC != 'AUME'
                  AND TZDOCTR_TIPO_PROC IN ('CART', 'EDCA');
         EXCEPTION
         WHEN OTHERS THEN
         VL_EXISTE_BITA :=0;
         END;

         IF VL_EXISTE_BITA = 0 THEN

           IF VL_PLAN_BITA = 0 THEN

             BEGIN
                 INSERT INTO TZDOCTR (
                 TZDOCTR_PIDM, TZDOCTR_PROGRAM, TZDOCTR_STST_CODE, TZDOCTR_STYP_CODE, TZDOCTR_CAMP_CODE
                 , TZDOCTR_LEVL_CODE, TZDOCTR_TERM_CODE, TZDOCTR_START_DATE, TZDOCTR_PTRM_CODE, TZDOCTR_STUDY_PATH
                 , TZDOCTR_NUM_PAGOS, TZDOCTR_RATE_CODE, TZDOCTR_COLEG, TZDOCTR_DESC, TZDOCTR_PPAGO
                 , TZDOCTR_PARCI, FECHA_PROCESO, TZDOCTR_IND, TZDOCTR_OBSERVACIONES, TZDOCTR_VENCIMIENTO
                 , TZDOCTR_ID, TZDOCTR_TIPO_PROC, TZDOCTR_DESCUENTO
                 )
                 VALUES ( ALUMNO.PIDM,
                 ALUMNO.PROGRAMA,
                 ALUMNO.ESTATUS,
                 ALUMNO.TIPO_ALUMNO,
                 ALUMNO.CAMPUS,
                 ALUMNO.NIVEL,
                 ALUMNO.PERIODO,
                 ALUMNO.FECHA_INICIO,--vd_Fecha_inicio,
                 ALUMNO.PARTE_PERIODO,
                 ALUMNO.STUDY_PATH,
                 ALUMNO.NUM_PAGOS,
                 ALUMNO.RATE,
                 NVL (VL_COLEGIATURA, 0),
                 NVL (VL_DESCUENTO, 0),
                 NVL (VL_PLAN_PAGO, 0),
                 NVL (VL_PARCIALIDAD,0),
                 SYSDATE,
                 0,
                 VL_CADENAERROR ||' '|| 'para el periodo '||ALUMNO.PERIODO,--||case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end,
                 ALUMNO.VENCIMIENTO,
                 ALUMNO.MATRICULA,
                 'EDCA',
                 1);

                 UPDATE TZDOCTR SET TZDOCTR_IND = 0,
                 TZDOCTR_OBSERVACIONES_1     = VL_CADENAERROR ||' '|| 'para el periodo '||ALUMNO.PERIODO--||case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end
                 --FECHA_PROCESO = trunc(sysdate)
                 WHERE TZDOCTR_PIDM = ALUMNO.PIDM
                 AND TZDOCTR_PROGRAM = ALUMNO.PROGRAMA
                 AND TZDOCTR_TERM_CODE =  ALUMNO.PERIODO
                 AND TZDOCTR_START_DATE = ALUMNO.FECHA_INICIO--vd_Fecha_inicio
                 AND TZDOCTR_TIPO_PROC = 'AUME'
                 AND TZDOCTR_PERIODOS_CURSADOS=VN_PERIODOS_CURSADOS;

             EXCEPTION
                 WHEN OTHERS THEN
                 VL_ERROR1 :='Error al insertar la bitacora de la cartera' ||SQLERRM;
             END;

           ELSIF VL_PLAN_BITA = 1 THEN

             BEGIN
                 INSERT INTO TZDOCTR (
                 TZDOCTR_PIDM, TZDOCTR_PROGRAM, TZDOCTR_STST_CODE, TZDOCTR_STYP_CODE, TZDOCTR_CAMP_CODE
                 , TZDOCTR_LEVL_CODE, TZDOCTR_TERM_CODE, TZDOCTR_START_DATE, TZDOCTR_PTRM_CODE, TZDOCTR_STUDY_PATH
                 , TZDOCTR_NUM_PAGOS, TZDOCTR_RATE_CODE, TZDOCTR_COLEG, TZDOCTR_DESC, TZDOCTR_PPAGO
                 , TZDOCTR_PARCI, FECHA_PROCESO, TZDOCTR_IND, TZDOCTR_OBSERVACIONES, TZDOCTR_VENCIMIENTO
                 , TZDOCTR_ID, TZDOCTR_TIPO_PROC, TZDOCTR_DESCUENTO
                 )
                 VALUES ( ALUMNO.PIDM,
                 ALUMNO.PROGRAMA,
                 ALUMNO.ESTATUS,
                 ALUMNO.TIPO_ALUMNO,
                 ALUMNO.CAMPUS,
                 ALUMNO.NIVEL,
                 ALUMNO.PERIODO,
                 ALUMNO.FECHA_INICIO,--vd_Fecha_inicio,
                 ALUMNO.PARTE_PERIODO,
                 ALUMNO.STUDY_PATH,
                 ALUMNO.NUM_PAGOS,
                 ALUMNO.RATE,
                 NVL (VL_COLEGIATURA, 0),
                 NVL (VL_DESCUENTO, 0),
                 NVL (VL_PLAN_PAGO, 0),
                 NVL (VL_PARCIALIDAD,0),
                 SYSDATE,
                 1,
                 VL_CADENAERROR ||' '|| 'para el periodo '||ALUMNO.PERIODO,--|| case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end,
                 ALUMNO.VENCIMIENTO,
                 ALUMNO.MATRICULA,
                 'EDCA',
                 1);


                 UPDATE TZDOCTR SET TZDOCTR_IND = 0,
                 TZDOCTR_OBSERVACIONES_1     = VL_CADENAERROR ||' '|| 'para el periodo '||ALUMNO.PERIODO--||case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end
                 --FECHA_PROCESO = trunc(sysdate)
                 WHERE TZDOCTR_PIDM = ALUMNO.PIDM
                 AND TZDOCTR_PROGRAM = ALUMNO.PROGRAMA
                 AND TZDOCTR_TERM_CODE =  ALUMNO.PERIODO
                 AND TZDOCTR_START_DATE = ALUMNO.FECHA_INICIO--vd_Fecha_inicio
                 AND TZDOCTR_TIPO_PROC = 'AUME'
                 AND TZDOCTR_PERIODOS_CURSADOS=VN_PERIODOS_CURSADOS;

             EXCEPTION
             WHEN OTHERS THEN
                 VL_ERROR1 :='Error al insertar la bitacora de la cartera' ||SQLERRM;
             END;

           END IF;

         ELSIF VL_EXISTE_BITA >= 1 THEN

           IF VL_PLAN_BITA >= 1 THEN

             BEGIN
                 UPDATE TZDOCTR
                 SET   TZDOCTR_IND = 1,
                 TZDOCTR_OBSERVACIONES = 'Error en la creacion de Cartera para el periodo  '||ALUMNO.PERIODO ||'  '||VL_CADENAERROR,--||case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end,
                 FECHA_PROCESO = SYSDATE,
                 TZDOCTR_ID=ALUMNO.MATRICULA,
                 TZDOCTR_COLEG = VL_COLEGIATURA,
                 TZDOCTR_DESC  = VL_DESCUENTO,
                 TZDOCTR_PPAGO = VL_PLAN_PAGO,
                 TZDOCTR_PARCI = VL_PARCIALIDAD
                 WHERE TZDOCTR_PIDM = ALUMNO.PIDM
                 AND TZDOCTR_PROGRAM = ALUMNO.PROGRAMA
                 AND TZDOCTR_START_DATE =  ALUMNO.FECHA_INICIO--vd_Fecha_inicio
                 AND TZDOCTR_TIPO_PROC != 'AUME';--'EDCA';


                 UPDATE TZDOCTR SET TZDOCTR_IND = 1,
                 TZDOCTR_OBSERVACIONES_1     =  'Error en la creacion de Cartera para el periodo  '||ALUMNO.PERIODO ||'  '||VL_CADENAERROR--||case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end
                 --FECHA_PROCESO = trunc(sysdate)
                 WHERE TZDOCTR_PIDM = ALUMNO.PIDM
                 AND TZDOCTR_PROGRAM = ALUMNO.PROGRAMA
                 AND TZDOCTR_TERM_CODE =  ALUMNO.PERIODO
                 AND TZDOCTR_START_DATE = ALUMNO.FECHA_INICIO--vd_Fecha_inicio
                 AND TZDOCTR_TIPO_PROC = 'AUME'
                 AND TZDOCTR_PERIODOS_CURSADOS=VN_PERIODOS_CURSADOS;

             EXCEPTION
             WHEN OTHERS THEN
                 VL_ERROR1 :='Error al insertar la bitacora de la cartera' ||SQLERRM;
             END;


           ELSE

             BEGIN
                 UPDATE TZDOCTR
                 SET   TZDOCTR_IND = 0,
                 TZDOCTR_OBSERVACIONES = 'Error en la creacion de Cartera para el periodo  '||ALUMNO.PERIODO ||'  '||VL_CADENAERROR,--||case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end,
                 FECHA_PROCESO = SYSDATE,
                 TZDOCTR_ID=ALUMNO.MATRICULA,
                 TZDOCTR_COLEG = VL_COLEGIATURA,
                 TZDOCTR_DESC  = VL_DESCUENTO,
                 TZDOCTR_PPAGO = VL_PLAN_PAGO,
                 TZDOCTR_PARCI = VL_PARCIALIDAD
                 WHERE TZDOCTR_PIDM = ALUMNO.PIDM
                 AND TZDOCTR_PROGRAM = ALUMNO.PROGRAMA
                 AND TZDOCTR_START_DATE =  ALUMNO.FECHA_INICIO--vd_Fecha_inicio
                 AND TZDOCTR_TIPO_PROC != 'AUME';--'EDCA';


                 UPDATE TZDOCTR SET TZDOCTR_IND = 0,
                 TZDOCTR_OBSERVACIONES_1     =  'Error en la creacion de Cartera para el periodo  '||ALUMNO.PERIODO ||'  '||VL_CADENAERROR--||case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end
                 --FECHA_PROCESO = trunc(sysdate)
                 WHERE TZDOCTR_PIDM = ALUMNO.PIDM
                 AND TZDOCTR_PROGRAM = ALUMNO.PROGRAMA
                 AND TZDOCTR_TERM_CODE =  ALUMNO.PERIODO
                 AND TZDOCTR_START_DATE = ALUMNO.FECHA_INICIO--vd_Fecha_inicio
                 AND TZDOCTR_TIPO_PROC = 'AUME'
                 AND TZDOCTR_PERIODOS_CURSADOS=VN_PERIODOS_CURSADOS;
             EXCEPTION
             WHEN OTHERS THEN
                 VL_ERROR1 :='Error al insertar la bitacora de la cartera' ||SQLERRM;
             END;

           END IF;


         END IF;

       ELSIF VL_EXISTE_CART >= 1 OR  VL_EXISTE_DESC >= 1 OR VL_EXISTE_PPLAN >= 1 OR VL_EXISTE_PARC >= 1 AND VL_ERROR IS  NULL THEN  ----> Registra en la Bitacora ya sea exito en la creacion o error

         IF VL_EXISTE_BITA = 0 THEN

           BEGIN
               INSERT INTO TZDOCTR (
               TZDOCTR_PIDM, TZDOCTR_PROGRAM, TZDOCTR_STST_CODE, TZDOCTR_STYP_CODE, TZDOCTR_CAMP_CODE
               , TZDOCTR_LEVL_CODE, TZDOCTR_TERM_CODE, TZDOCTR_START_DATE, TZDOCTR_PTRM_CODE, TZDOCTR_STUDY_PATH
               , TZDOCTR_NUM_PAGOS, TZDOCTR_RATE_CODE, TZDOCTR_COLEG, TZDOCTR_DESC, TZDOCTR_PPAGO
               , TZDOCTR_PARCI, FECHA_PROCESO, TZDOCTR_IND, TZDOCTR_OBSERVACIONES, TZDOCTR_VENCIMIENTO
               , TZDOCTR_ID, TZDOCTR_TIPO_PROC, TZDOCTR_DESCUENTO
               )
               VALUES ( ALUMNO.PIDM,
                   ALUMNO.PROGRAMA,
                   ALUMNO.ESTATUS,
                   ALUMNO.TIPO_ALUMNO,
                   ALUMNO.CAMPUS,
                   ALUMNO.NIVEL,
                   ALUMNO.PERIODO,
                   ALUMNO.FECHA_INICIO,--vd_Fecha_inicio,
                   ALUMNO.PARTE_PERIODO,
                   ALUMNO.STUDY_PATH,
                   ALUMNO.NUM_PAGOS,
                   ALUMNO.RATE,
                   NVL (VL_COLEGIATURA, 0),
                   NVL (VL_DESCUENTO, 0),
                   NVL (VL_PLAN_PAGO, 0),
                   NVL (VL_PARCIALIDAD,0),
                   SYSDATE,
                   1,
                   'Ya Existe la Cartera para el periodo  '||ALUMNO.PERIODO ||' con los siguientes conceptos  Colegiatura = '||VL_EXISTE_CART ||
                   '  Descuento= '||VL_EXISTE_DESC || ' Plan de Pago= '||VL_EXISTE_PPLAN || ' Parcialidades= ' ||VL_EXISTE_PARC||' Aumento='||VN_PORC_INCREM,--||case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end,
                   ALUMNO.VENCIMIENTO,
                   ALUMNO.MATRICULA,
                   'EDCA',
                   1);

                   --Se actualiza en el aumento
                   UPDATE TZDOCTR SET TZDOCTR_IND = 1,
                   TZDOCTR_OBSERVACIONES_1     = 'Ya Existe la Cartera para el periodo  '||ALUMNO.PERIODO ||' con los siguientes conceptos  Colegiatura = '||VL_EXISTE_CART ||
                   '  Descuento= '||VL_EXISTE_DESC || ' Plan de Pago= '||VL_EXISTE_PPLAN || ' Parcialidades= ' ||VL_EXISTE_PARC||' Aumento='||VN_PORC_INCREM--|| case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end
                   --FECHA_PROCESO = trunc(sysdate)
                   WHERE TZDOCTR_PIDM = ALUMNO.PIDM
                   AND TZDOCTR_PROGRAM = ALUMNO.PROGRAMA
                   AND TZDOCTR_TERM_CODE =  ALUMNO.PERIODO
                   AND TZDOCTR_START_DATE = ALUMNO.FECHA_INICIO--vd_Fecha_inicio
                   AND TZDOCTR_TIPO_PROC = 'AUME'
                   AND TZDOCTR_PERIODOS_CURSADOS=VN_PERIODOS_CURSADOS;

           EXCEPTION
           WHEN OTHERS THEN
               VL_ERROR1 :='Error al insertar la bitacora de la cartera' ||SQLERRM;
           END;

         ELSIF VL_EXISTE_BITA >= 1 THEN

           BEGIN
               UPDATE TZDOCTR
               SET TZDOCTR_IND = 1,
               TZDOCTR_OBSERVACIONES = 'Ya Existe la Cartera para el periodo  '||ALUMNO.PERIODO ||' con los siguientes conceptos  Colegiatura = '||VL_EXISTE_CART ||
               '  Descuento= '||VL_EXISTE_DESC || ' Plan de Pago= '||VL_EXISTE_PPLAN || ' Parcialidades= ' ||VL_EXISTE_PARC||' Aumento='||VN_PORC_INCREM,--||case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end,
               FECHA_PROCESO = SYSDATE,
               TZDOCTR_ID=ALUMNO.MATRICULA,
               TZDOCTR_COLEG = VL_COLEGIATURA,
               TZDOCTR_DESC  = VL_DESCUENTO,
               TZDOCTR_PPAGO = VL_PLAN_PAGO,
               TZDOCTR_PARCI = VL_PARCIALIDAD,
               TZDOCTR_DESCUENTO   = 1
               WHERE TZDOCTR_PIDM = ALUMNO.PIDM
               AND TZDOCTR_PROGRAM = ALUMNO.PROGRAMA
               AND TZDOCTR_TERM_CODE =  ALUMNO.PERIODO
               AND TZDOCTR_START_DATE = ALUMNO.FECHA_INICIO--vd_Fecha_inicio
               AND TZDOCTR_TIPO_PROC != 'AUME';-- 'EDCA';


               UPDATE TZDOCTR SET TZDOCTR_IND = 1,
               TZDOCTR_OBSERVACIONES_1     = 'Ya Existe la Cartera para el periodo  '||ALUMNO.PERIODO ||' con los siguientes conceptos  Colegiatura = '||VL_EXISTE_CART ||
               '  Descuento= '||VL_EXISTE_DESC || ' Plan de Pago= '||VL_EXISTE_PPLAN || ' Parcialidades= ' ||VL_EXISTE_PARC||' Aumento='||VN_PORC_INCREM--|| case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end
               --FECHA_PROCESO = trunc(sysdate)
               WHERE TZDOCTR_PIDM = ALUMNO.PIDM
               AND TZDOCTR_PROGRAM = ALUMNO.PROGRAMA
               AND TZDOCTR_TERM_CODE =  ALUMNO.PERIODO
               AND TZDOCTR_START_DATE = ALUMNO.FECHA_INICIO--vd_Fecha_inicio
               AND TZDOCTR_TIPO_PROC = 'AUME'
               AND TZDOCTR_PERIODOS_CURSADOS=VN_PERIODOS_CURSADOS;
           EXCEPTION
           WHEN OTHERS THEN
               VL_ERROR1 :='Error al insertar la bitacora de la cartera' ||SQLERRM;
           END;
         END IF;

       ELSIF VL_EXISTE_CART >= 1 OR  VL_EXISTE_DESC >= 1 OR VL_EXISTE_PPLAN >= 1 OR VL_EXISTE_PARC >= 1 AND VL_ERROR IS NOT NULL THEN  ----> Registra en la Bitacora ya sea exito en la creacion o error

         IF VL_EXISTE_BITA = 0 THEN

           BEGIN
               INSERT INTO TZDOCTR (
               TZDOCTR_PIDM, TZDOCTR_PROGRAM, TZDOCTR_STST_CODE, TZDOCTR_STYP_CODE, TZDOCTR_CAMP_CODE
               , TZDOCTR_LEVL_CODE, TZDOCTR_TERM_CODE, TZDOCTR_START_DATE, TZDOCTR_PTRM_CODE, TZDOCTR_STUDY_PATH
               , TZDOCTR_NUM_PAGOS, TZDOCTR_RATE_CODE, TZDOCTR_COLEG, TZDOCTR_DESC, TZDOCTR_PPAGO
               , TZDOCTR_PARCI, FECHA_PROCESO, TZDOCTR_IND, TZDOCTR_OBSERVACIONES, TZDOCTR_VENCIMIENTO
               , TZDOCTR_ID, TZDOCTR_TIPO_PROC, TZDOCTR_DESCUENTO
               )
               VALUES ( ALUMNO.PIDM,
                   ALUMNO.PROGRAMA,
                   ALUMNO.ESTATUS,
                   ALUMNO.TIPO_ALUMNO,
                   ALUMNO.CAMPUS,
                   ALUMNO.NIVEL,
                   ALUMNO.PERIODO,
                   ALUMNO.FECHA_INICIO,--vd_Fecha_inicio,
                   ALUMNO.PARTE_PERIODO,
                   ALUMNO.STUDY_PATH,
                   ALUMNO.NUM_PAGOS,
                   ALUMNO.RATE,
                   NVL (VL_COLEGIATURA, 0),
                   NVL (VL_DESCUENTO, 0),
                   NVL (VL_PLAN_PAGO, 0),
                   NVL (VL_PARCIALIDAD,0),
                   SYSDATE,
                   1,
                   'Ya Existe la Cartera para el periodo  '||ALUMNO.PERIODO ||' con los siguientes conceptos  Colegiatura = '||VL_EXISTE_CART ||
                   '  Descuento= '||VL_EXISTE_DESC || ' Plan de Pago= '||VL_EXISTE_PPLAN || ' Parcialidades= ' ||VL_EXISTE_PARC||' Aumento='||VN_PORC_INCREM,--||case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end,
                   ALUMNO.VENCIMIENTO,
                   ALUMNO.MATRICULA,
                   'EDCA',
                   1);


                   UPDATE TZDOCTR SET TZDOCTR_IND = 1,
                   TZDOCTR_OBSERVACIONES_1     = 'Ya Existe la Cartera para el periodo  '||ALUMNO.PERIODO ||' con los siguientes conceptos  Colegiatura = '||VL_EXISTE_CART ||
                   '  Descuento= '||VL_EXISTE_DESC || ' Plan de Pago= '||VL_EXISTE_PPLAN || ' Parcialidades= ' ||VL_EXISTE_PARC||' Aumento='||VN_PORC_INCREM--|| case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end
                   --FECHA_PROCESO = trunc(sysdate)
                   WHERE TZDOCTR_PIDM = ALUMNO.PIDM
                   AND TZDOCTR_PROGRAM = ALUMNO.PROGRAMA
                   AND TZDOCTR_TERM_CODE =  ALUMNO.PERIODO
                   AND TZDOCTR_START_DATE = ALUMNO.FECHA_INICIO--vd_Fecha_inicio
                   AND TZDOCTR_TIPO_PROC = 'AUME'
                   AND TZDOCTR_PERIODOS_CURSADOS=VN_PERIODOS_CURSADOS;

           EXCEPTION
           WHEN OTHERS THEN
               VL_ERROR1 :='Error al insertar la bitacora de la cartera' ||SQLERRM;
           END;

         ELSIF VL_EXISTE_BITA >= 1 THEN

           BEGIN
               UPDATE TZDOCTR
               SET TZDOCTR_IND = 1,
               TZDOCTR_OBSERVACIONES = 'Ya Existe la Cartera para el periodo  '||ALUMNO.PERIODO ||' con los siguientes conceptos  Colegiatura = '||VL_EXISTE_CART ||
               '  Descuento= '||VL_EXISTE_DESC || ' Plan de Pago= '||VL_EXISTE_PPLAN || ' Parcialidades= ' ||VL_EXISTE_PARC||' Aumento='||VN_PORC_INCREM,--||case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end,
               FECHA_PROCESO = SYSDATE,
               TZDOCTR_ID=ALUMNO.MATRICULA,
               TZDOCTR_COLEG = VL_COLEGIATURA,
               TZDOCTR_DESC  = VL_DESCUENTO,
               TZDOCTR_PPAGO = VL_PLAN_PAGO,
               TZDOCTR_PARCI = VL_PARCIALIDAD,
               TZDOCTR_DESCUENTO   = 1
               WHERE TZDOCTR_PIDM = ALUMNO.PIDM
               AND TZDOCTR_PROGRAM = ALUMNO.PROGRAMA
               AND TZDOCTR_TERM_CODE =  ALUMNO.PERIODO
               AND TZDOCTR_START_DATE = ALUMNO.FECHA_INICIO--vd_Fecha_inicio
               AND TZDOCTR_TIPO_PROC != 'AUME';-- 'EDCA';


               UPDATE TZDOCTR SET TZDOCTR_IND = 1,
               TZDOCTR_OBSERVACIONES_1     = 'Ya Existe la Cartera para el periodo  '||ALUMNO.PERIODO ||' con los siguientes conceptos  Colegiatura = '||VL_EXISTE_CART ||
               '  Descuento= '||VL_EXISTE_DESC || ' Plan de Pago= '||VL_EXISTE_PPLAN || ' Parcialidades= ' ||VL_EXISTE_PARC||' Aumento='||VN_PORC_INCREM--|| case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end
               --FECHA_PROCESO = trunc(sysdate)
               WHERE TZDOCTR_PIDM = ALUMNO.PIDM
               AND TZDOCTR_PROGRAM = ALUMNO.PROGRAMA
               AND TZDOCTR_TERM_CODE =  ALUMNO.PERIODO
               AND TZDOCTR_START_DATE = ALUMNO.FECHA_INICIO--vd_Fecha_inicio
               AND TZDOCTR_TIPO_PROC = 'AUME'
               AND TZDOCTR_PERIODOS_CURSADOS=VN_PERIODOS_CURSADOS;
           EXCEPTION
           WHEN OTHERS THEN
               VL_ERROR1 :='Error al insertar la bitacora de la cartera' ||SQLERRM;
           END;
         END IF;

       END IF;

       --DBMS_OUTPUT.PUT_LINE('FINAL ******* '||VL_ERROR1||SQLERRM);

        /********************************************
        *    MARCA DE CAMBIO: 001-27062023-FND.    *
        ********************************************/

            IF SUBSTR(ALUMNO.MATRICULA,1,2) = '11' THEN

              --DBMS_OUTPUT.PUT_LINE('llega a la generacion de 11*'||ALUMNO.MATRICULA||'*'||ALUMNO.FECHA_INICIO);

                VL_UNICA := PKG_FINANZAS.F_UNICA_CARGO(ALUMNO.MATRICULA
                                                      ,ALUMNO.FECHA_INICIO);

            END IF;

        /***********************************************
        *    FIN MARCA DE CAMBIO: 001-27062023-FND.    *
        ***********************************************/

       COMMIT;


     END LOOP;

   END IF;

   PKG_FINANZAS.P_CARTERA_API;                      --- Procedimiento para generear carteras a alumnos que no lleban materias inscritas en SFARHST y son continuos

   IF P_MATRICULA IS NULL THEN
     PKG_FINANZAS.P_ELIMINA_ESCA;                     --- Procedimiento para eliminar etiqueta de Escalonado cuando ya no tiene Descuento asociado
    -- VL_UTLX := PKG_FINANZAS.F_CARTERA_UTEL_X (NULL); --- Procedimiento para generear carteras a alumnos de UTELX y son continuos
   END IF;

 END P_GEN_CART_CONF;



PROCEDURE P_GEN_CART_ANT (   P_FECHA DATE
                            ,P_MATRICULA VARCHAR2
                            ,p_campus     varchar2
                            ,p_nivel      varchar2) IS

    vl_existe_mat number:=0;
    vl_existe_cart number:=0;
    vl_existe_desc number:=0;
    vl_existe_pplan number:=0;
    vl_existe_parc number:=0;
    vl_existe_bita number:=0;
    vl_secuencia number:=0;
    vl_secuencia_padre number:=0;
    vl_codigo varchar2(6) := null;
    vl_descripcion varchar2(50) :=null;
    vl_error varchar2 (500);
    vl_error1  varchar2 (500);
    vl_dia varchar2 (2);
    vl_mes varchar2 (2);
    vl_ano varchar2 (4);
    vl_vencimiento varchar2 (10);
    vl_monto number:=0;
    vl_num_parc number:=0;
    vl_colegiatura  number:=0;
    vl_descuento number:=0;
    vl_plan_pago number:=0;
    vl_parcialidad number:=0;
    vl_vuelta number:=0;
    vl_fecha_parc date := null;
    vl_plan_bita number :=0;


    vl_periodo_desc varchar2(20);
    vl_cod_desc varchar2(10);
    vl_porc_desc  number;

    vn_TZDOCTR_COLEG_1    NUMBER (12,2);
    vn_TZDOCTR_DESC_1    NUMBER (12,2);
    vn_TZDOCTR_PPAGO_1    NUMBER (12,2);
    vn_TZDOCTR_PARCI_1    NUMBER (12,2);
    vn_porc_increm number;
    vn_no_match number;
    VN_PERIODOS_CURSADOS NUMBER;

    sp_name VARCHAR2(80);

    vn_existe_parc VARCHAR2(1);

    vn_existen_pagos NUMBER;
    vn_existen_ppl NUMBER;
    vn_resultado number;

Begin

    dbms_output.put_line('EStoy EN BEGIN');
    If P_FECHA is not null then
                  For alumno in (
                  select distinct d.spriden_id Matricula,
                                 a.sorlcur_pidm pidm,
                                 a.sorlcur_program programa,
                                 e.SZTDTEC_PROGRAMA_COMP Programa_desc,
                                 b.SGBSTDN_STST_CODE Estatus,
                                 b.SGBSTDN_STYP_CODE Tipo_Alumno,
                                 b.sgbstdn_camp_code campus,
                                 b.SGBSTDN_LEVL_CODE Nivel,
                                 f.SFRSTCR_TERM_CODE Periodo,
                                /* (CASE substr (to_char(g.SSBSECT_PTRM_START_DATE, 'dd/mm/rrrr'), 1, 2)
                                  WHEN '30' THEN g.SSBSECT_PTRM_START_DATE + 2
                                    ELSE g.SSBSECT_PTRM_START_DATE END) Fecha_inicioMAS2,*/--QUITAR DESPUES DE ESTA CORRIDA  30/10/2017
                                   g.SSBSECT_PTRM_START_DATE Fecha_inicio,
                                 f.SFRSTCR_PTRM_CODE Parte_Periodo,
                                 a.SORLCUR_KEY_SEQNO study_path,
                                case
                                        substr (b.sgbstdn_rate_code, 1, 1)
                                            when  ('P') then substr (b.sgbstdn_rate_code, 2, 2)
                                            when  ('J') then substr (b.sgbstdn_rate_code, 3, 1)
                                end  Num_pagos,
                                  (decode (substr (b.sgbstdn_rate_code, 4, 1), 'A', 15, 'B', '30', 'C', '10')) vencimiento,
                                  substr (b.sgbstdn_rate_code, 1, 1) Tipo_Pago,
                                  b.sgbstdn_rate_code Rate,
                                  decode (e.SZTDTEC_PERIODICIDAD, 1, 'Bime', 2, 'Cuatri', 3, 'Semes', 4, 'Anual') periodicidad,
                                  decode (e.SZTDTEC_PERIODICIDAD, 1, 2
                                                                , 2, 4
                                                                , 3, 6
                                                                , 4, 12) periodicidad2
                                  from sorlcur a, sgbstdn b, spriden d, SFRSTCR f, ssbsect g, SZTDTEC e
                                    Where a.SORLCUR_LMOD_CODE = 'LEARNER'
                                    and a.SORLCUR_ROLL_IND  = 'Y'
                                    And a.SORLCUR_SEQNO in (select max (a1.SORLCUR_SEQNO)
                                                                              from SORLCUR a1
                                                                              Where a.sorlcur_pidm = a1.sorlcur_pidm
                                                                              And a.sorlcur_program = a1.sorlcur_program
                                                                              And a.SORLCUR_LMOD_CODE = a1.SORLCUR_LMOD_CODE)
                                    And a.sorlcur_pidm =  b.sgbstdn_pidm
                                    And a.sorlcur_program = b.sgbstdn_program_1
                                    And b.SGBSTDN_STYP_CODE in ('C','R', 'F')--And b.SGBSTDN_STYP_CODE  'C'  Nota: se agrega N pero no se pricesará por este medio, solo es para enviar MSG
                                    And b.sgbstdn_term_code_eff in (select max (b1.sgbstdn_term_code_eff)
                                                                                     from sgbstdn b1
                                                                                     Where b.sgbstdn_pidm = b1.sgbstdn_pidm
                                                                                     And b.SGBSTDN_STYP_CODE = b1.SGBSTDN_STYP_CODE
                                                                                     And b.sgbstdn_program_1 = b1.sgbstdn_program_1)
                                    And e.SZTDTEC_PROGRAM = b.sgbstdn_program_1
                                    And a.SORLCUR_TERM_CODE_CTLG = e.SZTDTEC_TERM_CODE
                                    and d.spriden_pidm = sgbstdn_pidm
                                    And d.spriden_change_ind is null
                                    And f.SFRSTCR_pidm = a.sorlcur_pidm
                                    and f.SFRSTCR_RSTS_CODE ='RE'
                                    and f.SFRSTCR_STSP_KEY_SEQUENCE = a.SORLCUR_KEY_SEQNO
                                    And f.SFRSTCR_TERM_CODE = g.SSBSECT_TERM_CODE
                                    And f.SFRSTCR_CRN = g.SSBSECT_CRN
                                    And f.SFRSTCR_PTRM_CODE = g.SSBSECT_PTRM_CODE
                                    And trunc (g.SSBSECT_PTRM_START_DATE)  = P_FECHA
                                    And a.sorlcur_pidm not in (select TZDOCTR_PIDM
                                                                            from TZDOCTR
                                                                            where TZDOCTR_PROGRAM = a.sorlcur_program
                                                                            And TZDOCTR_TERM_CODE = f.SFRSTCR_TERM_CODE
                                                                            And trunc (TZDOCTR_START_DATE)  = trunc (a.SORLCUR_START_DATE)
                                                                            --And TZDOCTR_PTRM_CODE = f.SFRSTCR_PTRM_CODE
                                                                            and TZDOCTR_IND = 1
                                                                            and TZDOCTR_TIPO_PROC != 'AUME') --='CART')
                                    And b.SGBSTDN_STST_CODE in ('AS', 'MA', 'PR')
                                    and d.spriden_id = NVL(P_MATRICULA,d.spriden_id)
                                    and a.SORLCUR_CAMP_CODE  = NVL(p_campus,a.SORLCUR_CAMP_CODE)
                                    and a.SORLCUR_LEVL_CODE  = NVL(p_nivel,a.SORLCUR_LEVL_CODE)
                                    And a.SORLCUR_CAMP_CODE||a.SORLCUR_LEVL_CODE not in ('UTSEC')
                                    order by 1, 8, 9 ) loop

                                    ------------------------- Se busca que no exista la cartera en periodo de las inscripciones --------------------------
                                    dbms_output.put_line('EStoy FOR');
                                    vl_existe_mat :=0;
                                    vl_existe_cart :=0;
                                    vl_existe_desc :=0;
                                    vl_existe_pplan :=0;
                                    vl_existe_parc :=0;
                                    vl_existe_bita :=0;
                                    vl_secuencia :=0;
                                    vl_codigo  := null;
                                    vl_descripcion :=null;
                                    vl_error :=null;
                                    vl_error1 :=null;
                                    vl_dia :=null;
                                    vl_mes :=null;
                                    vl_ano :=null;
                                    vl_vencimiento :=null;
                                    vl_monto :=0;
                                    vl_num_parc :=0;
                                    vl_colegiatura  :=0;
                                    vl_descuento :=0;
                                    vl_plan_pago :=0;
                                    vl_parcialidad :=0;
                                    vl_vuelta :=0;
                                    vl_fecha_parc  := null;
                                    vl_plan_bita  :=0;

                                    vn_TZDOCTR_COLEG_1:=0;
                                                                        vn_TZDOCTR_DESC_1    :=0;
                                                                        vn_TZDOCTR_PPAGO_1:=0;
                                                                        vn_TZDOCTR_PARCI_1:=0;
                                    vn_porc_increm  :=0;
                                    vn_no_match:=0;
                                    VN_PERIODOS_CURSADOS:=0;

                                    vn_existe_parc :=null;
                                    vn_existen_pagos:=0;
                                    vn_existen_ppl :=0;
                                    vn_resultado :=0;
                                    --sp_name := Get_Application_Property(SAVEPOINT_NAME);

                               Begin
                                    Select count (tbraccd_detail_code)
                                       Into vl_existe_cart
                                    from tbraccd
                                    Where tbraccd_pidm = alumno.pidm
                                    and tbraccd_term_code = alumno.periodo
                                    And tbraccd_detail_code in (select TBBDETC_DETAIL_CODE
                                                                from tbbdetc
                                                                where TBBDETC_DCAT_CODE = 'TUI'
                                                                And substr (TBBDETC_DETAIL_CODE, 1, 2 )  = substr (alumno.periodo, 1, 2)
                                                                and TBBDETC_DETC_ACTIVE_IND = 'Y'
                                                                And TBBDETC_TAXT_CODE = alumno.nivel)
                                    And (TBRACCD_PERIOD =  alumno.parte_periodo or TBRACCD_PERIOD is null);
                              Exception
                              when Others then
                                  vl_existe_cart :=0;
                              End;



                   ------------------------- Se busca que no exista el descuento en periodo de las inscripciones --------------------------
                              Begin
                                        Select count (tbraccd_detail_code)
                                           Into vl_existe_desc
                                        from tbraccd
                                        Where tbraccd_pidm = alumno.pidm
                                        and tbraccd_term_code = alumno.periodo
                                        And tbraccd_detail_code in (select TBBDETC_DETAIL_CODE
                                                                    from tbbdetc
                                                                    where TBBDETC_DCAT_CODE = 'DSP'
                                                                    And substr (TBBDETC_DETAIL_CODE, 1, 2 ) = substr (alumno.periodo, 1, 2)
                                                                    and TBBDETC_DETC_ACTIVE_IND = 'Y'
                                                                    And TBBDETC_TAXT_CODE = alumno.nivel)
                                        And (TBRACCD_PERIOD =  alumno.parte_periodo or TBRACCD_PERIOD is null);
                              Exception
                              when Others then
                                  vl_existe_desc :=0;
                              End;


                   ------------------------- Se busca que no exista el plan de pagos  en periodo de las inscripciones --------------------------
                              Begin
                                        Select count (tbraccd_detail_code)
                                           Into vl_existe_pplan
                                        from tbraccd
                                        Where tbraccd_pidm = alumno.pidm
                                        and tbraccd_term_code = alumno.periodo
                                        And tbraccd_detail_code in (select TBBDETC_DETAIL_CODE
                                                                     from tbbdetc
                                                                     where TBBDETC_DCAT_CODE = 'LPC'
                                                                     And TBBDETC_DETAIL_CODE = 'PLPA'
                                                                     )
                                        And (TBRACCD_PERIOD =  alumno.parte_periodo or TBRACCD_PERIOD is null);
                              Exception
                              when Others then
                                  vl_existe_pplan :=0;
                              End;


                   ------------------------- Se busca que no existan parcialidades  en periodo de las inscripciones --------------------------

                               Begin
                                        Select count (tbraccd_detail_code)
                                           Into vl_existe_parc
                                        from tbraccd
                                        Where tbraccd_pidm = alumno.pidm
                                        and tbraccd_term_code = alumno.periodo
                                        And tbraccd_detail_code in (select TBBDETC_DETAIL_CODE
                                                                    from tbbdetc
                                                                    where TBBDETC_DCAT_CODE = 'COL'
                                                                    And substr (TBBDETC_DETAIL_CODE, 1, 2 )  = substr (alumno.periodo, 1, 2)
                                                                    And substr (TBBDETC_DETAIL_CODE,1,3) = substr (alumno.periodo, 1, 2)||'N'
                                                                    and TBBDETC_DETC_ACTIVE_IND = 'Y'
                                                                    And TBBDETC_TAXT_CODE = alumno.nivel)
                                      And (TBRACCD_PERIOD =  alumno.parte_periodo or TBRACCD_PERIOD is null);
                              Exception
                              when Others then
                                  vl_existe_parc :=0;
                              End;

                              ----------- Validacion para crear las carteras de los bimetrales ------------
                              ---------- Si la cartera es bimestral se valida que la parcialidad mayor sea menor a la fecha de inicio de clases ------------
                              vl_fecha_parc := null;
                              --dbms_output.put_line('EStoy para validar bimestrales ');
                              If vl_existe_cart >= 1 and vl_existe_desc >= 1 and vl_existe_pplan  >= 1 and vl_existe_parc  in (1,2,3)  and alumno.num_pagos in (1, 2, 3 ) then   ----> Se crea la nueva cartera
                                 -- dbms_output.put_line('Cumple condicion bimestral ');
                                     Begin
                                             select distinct max (TBRACCD_EFFECTIVE_DATE)
                                               Into vl_fecha_parc
                                            from tbraccd a
                                            where a.tbraccd_pidm = alumno.pidm
                                            And a.tbraccd_detail_code in (select TBBDETC_DETAIL_CODE
                                                                          from tbbdetc
                                                                          where TBBDETC_DCAT_CODE = 'COL'
                                                                          And substr (TBBDETC_DETAIL_CODE, 1, 2 )  = substr (a.TBRACCD_TERM_CODE, 1, 2)
                                                                          And substr (TBBDETC_DETAIL_CODE,1,3) = substr (a.TBRACCD_TERM_CODE, 1, 2)||'N'
                                                                          and TBBDETC_DETC_ACTIVE_IND = 'Y'
                                                                          And TBBDETC_TAXT_CODE = alumno.nivel
                                                                          )
                                            And a.tbraccd_amount >0
                                            And a.TBRACCD_TERM_CODE = alumno.periodo
                                            order by 1 desc;
                                     Exception
                                     When Others then
                                        vl_fecha_parc := null;
                                     End;

                                -- dbms_output.put_line('Valida la fecha');
                                    If   vl_fecha_parc < alumno.fecha_inicio then
                                 --dbms_output.put_line('setea variables');
                                         vl_existe_cart :=0;
                                         vl_existe_desc :=0;
                                         vl_existe_pplan :=0;
                                         vl_existe_parc :=0;
                                    End if;
                              End if;

                            dbms_output.put_line('No Entro a Validar bimestral ');


                           If vl_existe_cart = 0 and vl_existe_desc = 0 and vl_existe_pplan = 0 and vl_existe_parc = 0  then   ----> Se crea la nueva cartera

                               --IF ALUMNO.Tipo_Alumno   <> 'N' THEN

                                     BEGIN
                                       select A.TZDOCTR_PORC_INCREM
                                            , A.TZDOCTR_PERIODOS_CURSADOS
                                            ,TZDOCTR_COLEG_1
                                                                                ,TZDOCTR_DESC_1
                                                                                ,TZDOCTR_PPAGO_1
                                                                                ,TZDOCTR_PARCI_1
                                                                           into vn_porc_increm
                                                                                ,VN_PERIODOS_CURSADOS
                                                                                ,vn_TZDOCTR_COLEG_1
                                                                                ,vn_TZDOCTR_DESC_1
                                                                                ,vn_TZDOCTR_PPAGO_1
                                                                                ,vn_TZDOCTR_PARCI_1
                                                                           from  TZDOCTR A
                                                                           Where A.TZDOCTR_PIDM = alumno.pidm
                                                                           And A.TZDOCTR_PROGRAM = alumno.programa
                                                                           And A.TZDOCTR_TERM_CODE =  alumno.periodo
                                                                           And A.TZDOCTR_START_DATE = alumno.Fecha_inicio
                                                                           and nvl(TZDOCTR_IND,0) <> 1
                                                                           AND A.TZDOCTR_TIPO_PROC = 'AUME'
                                                                           AND A.TZDOCTR_PERIODOS_CURSADOS =(SELECT MAX(TZDOCTR_PERIODOS_CURSADOS)
                                                                                                             FROM TZDOCTR B
                                                                                                             Where B.TZDOCTR_PIDM=A.TZDOCTR_PIDM
                                                                                                                                               And B.TZDOCTR_PROGRAM=A.TZDOCTR_PROGRAM
                                                                                                                                               And B.TZDOCTR_TERM_CODE=A.TZDOCTR_TERM_CODE
                                                                                                                                               And B.TZDOCTR_START_DATE=A.TZDOCTR_START_DATE
                                                                                                                                               and B.TZDOCTR_COLEG=A.TZDOCTR_COLEG
                                                                                                                                               AND B.TZDOCTR_TIPO_PROC=A.TZDOCTR_TIPO_PROC
                                                                                                            );
                                     EXCEPTION
                                         WHEN OTHERS THEN
                                           vn_porc_increm:=0;
                                           VN_PERIODOS_CURSADOS:=0;
                                     END;
                                     dbms_output.put_line('Entra a Crear Cartera ');

                                       Begin
                                           select nvl (max(TBRACCD_TRAN_NUMBER) , 0)+1
                                           Into vl_secuencia
                                           from tbraccd
                                           Where tbraccd_pidm =  alumno.pidm;
                                     Exception
                                     When Others then
                                         vl_secuencia := 1;
                                     End;

                                    vl_codigo := null;
                                    vl_descripcion := null;
                                    vl_monto := 0;
                                    vl_error := null;
                                    vl_error1:= null;

                                      ---------- Busca el ultimo concepto de colegiatura para crear la nueva version del cargo  ------------------
                                     Begin
                                                Select TBRACCD_DETAIL_CODE ,  TBRACCD_DESC, TBRACCD_AMOUNT
                                                Into vl_codigo, vl_descripcion, vl_monto
                                                from tbraccd a
                                                Where a.tbraccd_pidm = alumno.pidm
                                                And a.tbraccd_detail_code in (select TBBDETC_DETAIL_CODE
                                                                              from tbbdetc
                                                                              where TBBDETC_DCAT_CODE = 'TUI'
                                                                              And substr (TBBDETC_DETAIL_CODE, 1, 2 )  = substr (alumno.periodo, 1, 2)
                                                                              and TBBDETC_DETC_ACTIVE_IND = 'Y'
                                                                              And TBBDETC_TAXT_CODE = alumno.nivel
                                                                                         )
                                                And a.tbraccd_amount >0
                                                And a.TBRACCD_TERM_CODE = (select max (a1.TBRACCD_TERM_CODE)
                                                                              from TBRACCD a1
                                                                              Where a.tbraccd_pidm = a1.tbraccd_pidm
                                                                              And a.tbraccd_detail_code = a1.tbraccd_detail_code
                                                                              And a.tbraccd_amount >0
                                                                             )
                                                And a.TBRACCD_TRAN_NUMBER = ( select max (a1.TBRACCD_TRAN_NUMBER)x
                                                                              from TBRACCD a1
                                                                              Where a.tbraccd_pidm = a1.tbraccd_pidm
                                                                              And a.tbraccd_detail_code = a1.tbraccd_detail_code
                                                                              AND a1.tbraccd_amount >0
                                                                              --RLS AGREGADO EN LA VERSION V 1.6
                                                                              AND TBRACCD_TRAN_NUMBER NOT IN
                                                                                                    (SELECT TBRACCD_TRAN_NUMBER
                                                                                                    FROM TBRACCD, TBBDETC
                                                                                                    WHERE     TBRACCD_PIDM = a.tbraccd_pidm--p_pidm
                                                                                                    AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                                    AND TBBDETC_TYPE_IND = 'C'
                                                                                                    AND TBRACCD_AMOUNT < 0
                                                                                                    UNION
                                                                                                    SELECT TBRAPPL_CHG_TRAN_NUMBER
                                                                                                    FROM TBRAPPL,TBRACCD
                                                                                                    WHERE TBRACCD_PIDM = a.tbraccd_pidm
                                                                                                    AND TBRAPPL_PIDM= TBRACCD_PIDM
                                                                                                    AND TBRAPPL_REAPPL_IND IS NULL
                                                                                                    AND TBRAPPL_PAY_TRAN_NUMBER IN (
                                                                                                            SELECT TBRACCD_TRAN_NUMBER
                                                                                                            FROM TBRACCD, TBBDETC
                                                                                                            WHERE     TBRACCD_PIDM = a.tbraccd_pidm--p_pidm
                                                                                                            AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                                            AND TBBDETC_TYPE_IND = 'C'
                                                                                                            AND TBRACCD_AMOUNT < 0
                                                                                                            )
                                                                                                    UNION
                                                                                                    SELECT TBRACCD_TRAN_NUMBER_PAID
                                                                                                    FROM TBRACCD, TBBDETC
                                                                                                    WHERE     TBRACCD_PIDM = a.tbraccd_pidm--p_pidm
                                                                                                    AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                                    AND TBBDETC_TYPE_IND = 'C'
                                                                                                    AND TBRACCD_AMOUNT < 0
                                                                                                    )
                                                                              );
                                     Exception
                                      when Others then
                                          vl_codigo := null;
                                          vl_descripcion := null;
                                           vl_monto := 0;
                                     End;
                                     ---------------------------dbms_output.put_line('codigodetalle '||vl_codigo ||  ' * '||vl_descripcion ||' * '||vl_monto ||'*' || alumno.pidm);

                                    IF alumno.Tipo_Pago in ('J','C') THEN--= 'J'  THEN

                                        If vl_codigo is not null and vl_descripcion is not null and vl_monto is not null then
                                               vl_plan_bita :=0;

                                               /****
                                               ***/

                                            BEGIN
                                                                        select distinct count (a.tbraccd_detail_code)
                                                                        INTO vn_existen_pagos
                                                                            from tbraccd a
                                                                            where a.tbraccd_pidm = alumno.pidm
                                                                            And a.tbraccd_detail_code in (select TBBDETC_DETAIL_CODE
                                                                                                            from tbbdetc
                                                                                                            where TBBDETC_DCAT_CODE = 'COL'
                                                                                                            And substr (TBBDETC_DETAIL_CODE, 1, 2 )  = substr (a.TBRACCD_TERM_CODE, 1, 2)
                                                                                                            And substr (TBBDETC_DETAIL_CODE,1,3) = substr (a.TBRACCD_TERM_CODE, 1, 2)||'N'
                                                                                                            and TBBDETC_DETC_ACTIVE_IND = 'Y'
                                                                                                            And TBBDETC_TAXT_CODE = alumno.nivel)
                                                                    And a.tbraccd_amount >0
                                                                    --RLS AGREGADO EN LA VERSION V 1.6
                                                                    AND TBRACCD_TRAN_NUMBER NOT IN
                                                                                    (SELECT TBRACCD_TRAN_NUMBER
                                                                                    FROM TBRACCD, TBBDETC
                                                                                    WHERE     TBRACCD_PIDM = a.tbraccd_pidm--p_pidm
                                                                                    AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                    AND TBBDETC_TYPE_IND = 'C'
                                                                                    AND TBRACCD_AMOUNT < 0
                                                                                    UNION
                                                                                    SELECT TBRAPPL_CHG_TRAN_NUMBER
                                                                                    FROM TBRAPPL,TBRACCD
                                                                                    WHERE TBRACCD_PIDM = a.tbraccd_pidm
                                                                                    AND TBRAPPL_PIDM= TBRACCD_PIDM
                                                                                    AND TBRAPPL_REAPPL_IND IS NULL
                                                                                    AND TBRAPPL_PAY_TRAN_NUMBER IN (
                                                                                            SELECT TBRACCD_TRAN_NUMBER
                                                                                            FROM TBRACCD, TBBDETC
                                                                                            WHERE     TBRACCD_PIDM = a.tbraccd_pidm--p_pidm
                                                                                            AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                            AND TBBDETC_TYPE_IND = 'C'
                                                                                            AND TBRACCD_AMOUNT < 0
                                                                                            )
                                                                                    UNION
                                                                                    SELECT TBRACCD_TRAN_NUMBER_PAID
                                                                                    FROM TBRACCD, TBBDETC
                                                                                    WHERE     TBRACCD_PIDM = a.tbraccd_pidm--p_pidm
                                                                                    AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                    AND TBBDETC_TYPE_IND = 'C'
                                                                                    AND TBRACCD_AMOUNT < 0
                                                                                    )
                                                                    And a.TBRACCD_TERM_CODE = (select max (a1.TBRACCD_TERM_CODE)
                                                                                                                        from tbraccd a1
                                                                                                                        Where a.tbraccd_pidm = a1.tbraccd_pidm
                                                                                                                        And   a.tbraccd_detail_code = a1.tbraccd_detail_code
                                                                                                                        );
                                            EXCEPTION
                                            WHEN OTHERS THEN
                                                vn_existen_pagos :=0;
                                            END;



                                            Begin

                                                                                            Select count (a.tbraccd_detail_code)
                                                                                            Into vn_existen_ppl
                                                                                            from tbraccd a
                                                                                            Where a.tbraccd_pidm = alumno.pidm
                                                                                            and a.tbraccd_term_code = (select max (a1.tbraccd_term_code)
                                                                                                                                      from tbraccd a1
                                                                                                                                      where a.tbraccd_pidm = a1.tbraccd_pidm
                                                                                                                                      and a.tbraccd_detail_code = a1.tbraccd_detail_code)
                                                                                            And a.tbraccd_detail_code in (select TBBDETC_DETAIL_CODE
                                                                                                                       from tbbdetc
                                                                                                                       where TBBDETC_DCAT_CODE = 'LPC'
                                                                                                                       And TBBDETC_DETAIL_CODE = 'PLPA');
                                            Exception
                                                    When Others then
                                                     vn_existen_ppl :=0;
                                            End;

                                            If vn_existen_ppl = 2 and vn_existen_pagos = 4 then
                                                   vn_existen_pagos := 2;
                                            End if;




                                               /****
                                               ***/
                                               --message('tui1:'||vn_existen_pagos||'::'||ALUMNO.PERIODICIDAD2); pause;
                                               --Si existe incremento, aqui se realiza el calculo de COl
                                             IF vn_porc_increm > 0 THEN

                                                      vl_monto := ROUND(vl_monto + (vl_monto*(vn_porc_increm/100)));

                                                IF vn_existen_pagos = 4 AND ALUMNO.PERIODICIDAD2 = 2 THEN

                                                      vl_monto := ROUND(vl_monto/2);
                                                      vn_TZDOCTR_COLEG_1 := ROUND(vn_TZDOCTR_COLEG_1/2);

                                                END IF ;


                                                vn_resultado := vl_monto - vn_TZDOCTR_COLEG_1;


                                                If vn_resultado > 2 then
                                                        vn_no_match := 1;
                                                        vl_error :=' Error en el match de incremento en col:'||vl_monto||'<>'||vn_TZDOCTR_COLEG_1;
                                                END IF;

                                             ELSE
                                                     IF vn_existen_pagos =4 AND ALUMNO.PERIODICIDAD2 = 2 THEN
                                                     --message('TUI2:'||vn_existen_pagos||'::'||ALUMNO.PERIODICIDAD2);pause;
                                                           vl_monto := vl_monto/2;

                                                     END IF ;
                                             END IF;



                                            vl_colegiatura := vl_monto;



                                                 Begin

                                                       Insert into TBRACCD values (
                                                                 alumno.pidm,   -- TBRACCD_PIDM
                                                                 vl_secuencia,     --TBRACCD_TRAN_NUMBER
                                                                 alumno.periodo,    -- TBRACCD_TERM_CODE
                                                                 vl_codigo,     ---TBRACCD_DETAIL_CODE
                                                                 user,     ---TBRACCD_USER
                                                                 SYSDATE,     --TBRACCD_ENTRY_DATE
                                                                 nvl(vl_monto,0),
                                                                 nvl(vl_monto,0),    ---TBRACCD_BALANCE
                                                                 ADD_MONTHS(LAST_day (alumno.Fecha_inicio)+1,-1),--sysdate,     -- TBRACCD_EFFECTIVE_DATE
                                                                 NULL,    --TBRACCD_BILL_DATE
                                                                 NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                                                                vl_descripcion,    -- TBRACCD_DESC
                                                                null,     --TBRACCD_RECEIPT_NUMBER
                                                                NULL,     --TBRACCD_TRAN_NUMBER_PAID
                                                                NULL,     --TBRACCD_CROSSREF_PIDM
                                                                NULL,    --TBRACCD_CROSSREF_NUMBER
                                                                null,       --TBRACCD_CROSSREF_DETAIL_CODE
                                                                  'T',    --TBRACCD_SRCE_CODE
                                                                 'Y',    --TBRACCD_ACCT_FEED_IND
                                                                 sysdate,  --TBRACCD_ACTIVITY_DATE
                                                                 0,        --TBRACCD_SESSION_NUMBER
                                                                 null,    -- TBRACCD_CSHR_END_DATE
                                                                 NULL,     --TBRACCD_CRN
                                                                 NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                                                                 NULL,     -- TBRACCD_LOC_MDT
                                                                 NULL,     --TBRACCD_LOC_MDT_SEQ
                                                                null,     -- TBRACCD_RATE
                                                                 NULL,     --TBRACCD_UNITS
                                                                 NULL,     -- TBRACCD_DOCUMENT_NUMBER
                                                                 ADD_MONTHS(LAST_day (alumno.Fecha_inicio)+1,-1),--sysdate,  -- TBRACCD_TRANS_DATE
                                                                 NULL,        -- TBRACCD_PAYMENT_ID
                                                                 NULL,     -- TBRACCD_INVOICE_NUMBER
                                                                 NULL,     -- TBRACCD_STATEMENT_DATE
                                                                 NULL,     -- TBRACCD_INV_NUMBER_PAID
                                                                 'MXN',     -- TBRACCD_CURR_CODE
                                                                 null,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                                                                 NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                                                                NULL,     -- TBRACCD_LATE_DCAT_CODE
                                                                alumno.Fecha_inicio,--NULL,     -- TBRACCD_FEED_DATE
                                                                NULL,     -- TBRACCD_FEED_DOC_CODE
                                                                NULL,     -- TBRACCD_ATYP_CODE
                                                                NULL,     -- TBRACCD_ATYP_SEQNO
                                                                NULL,     -- TBRACCD_CARD_TYPE_VR
                                                                NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                                                                NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                                                                NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                                                                NULL,     -- TBRACCD_ORIG_CHG_IND
                                                                NULL,     -- TBRACCD_CCRD_CODE
                                                                NULL,     -- TBRACCD_MERCHANT_ID
                                                                NULL,     -- TBRACCD_TAX_REPT_YEAR
                                                                NULL,     -- TBRACCD_TAX_REPT_BOX
                                                                NULL,     -- TBRACCD_TAX_AMOUNT
                                                                NULL,     -- TBRACCD_TAX_FUTURE_IND
                                                                'TZFCART_RE2',     -- TBRACCD_DATA_ORIGIN
                                                                'AUTOR',   -- TBRACCD_CREATE_SOURCE
                                                                null,     -- TBRACCD_CPDT_IND
                                                                NULL,     --TBRACCD_AIDY_CODE
                                                                alumno.study_path,     --TBRACCD_STSP_KEY_SEQUENCE
                                                                alumno.parte_periodo,     --TBRACCD_PERIOD
                                                                NULL,    --TBRACCD_SURROGATE_ID
                                                                NULL,     -- TBRACCD_VERSION
                                                                user,     --TBRACCD_USER_ID
                                                                NULL );     --TBRACCD_VPDI_CODE

                                                     vl_secuencia_padre := vl_secuencia;

                                                     /**


                                                     **/
                                                    ---------------------------dbms_output.put_line('Termina La colegiatura');

                                                 Exception
                                                    When Others then
                                                      vl_error :='Error Insertar colegiatura' ||sqlerrm;
                                                       ---------------------------dbms_output.put_line(vl_error);
                                                 End;

                                ---------------------------dbms_output.put_line('valida la variable de errro ' ||vl_error);

                                                 If vl_error is null  then          ---------------> Se crea el descuento para la cartera
                                                    vl_codigo := null;
                                                    vl_descripcion := null;
                                                    vl_monto := 0;
                                                    vl_secuencia :=0;

                                                        ---------------------------dbms_output.put_line('Entra al descuento');

                                                      ---------- Busca el ultimo concepto de descuento para crear la nueva version del cargo  ------------------
                                                         vl_vuelta :=0;
                                                                   For descu in (Select distinct TBRACCD_DETAIL_CODE ,  TBRACCD_DESC, TBRACCD_AMOUNT, a.TBRACCD_TRAN_NUMBER
                                                                        from tbraccd a
                                                                        Where a.tbraccd_pidm = alumno.pidm
                                                                        And a.tbraccd_detail_code in (select TBBDETC_DETAIL_CODE
                                                                                                                 from tbbdetc
                                                                                                                 where TBBDETC_DCAT_CODE = 'DSP'
                                                                                                                And substr (TBBDETC_DETAIL_CODE, 1, 2 )  = substr (alumno.periodo, 1, 2)
                                                                                                                and TBBDETC_DETAIL_CODE not in (substr (alumno.periodo, 1, 2)||'W5')
                                                                                                                and TBBDETC_DETC_ACTIVE_IND = 'Y'
                                                                                                                And TBBDETC_TAXT_CODE = alumno.nivel
                                                                                                                 )
                                                                        And a.tbraccd_amount >0
                                                                        --RLS AGREGADO EN LA VERSION V 1.6
                                                                        AND TBRACCD_TRAN_NUMBER NOT IN
                                                                                                    (SELECT TBRACCD_TRAN_NUMBER
                                                                                                    FROM TBRACCD, TBBDETC
                                                                                                    WHERE     TBRACCD_PIDM = a.tbraccd_pidm--p_pidm
                                                                                                    AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                                    AND TBBDETC_TYPE_IND = 'C'
                                                                                                    AND TBRACCD_AMOUNT < 0
                                                                                                    UNION
                                                                                                    SELECT TBRAPPL_CHG_TRAN_NUMBER
                                                                                                    FROM TBRAPPL,TBRACCD
                                                                                                    WHERE TBRACCD_PIDM = a.tbraccd_pidm
                                                                                                    AND TBRAPPL_PIDM= TBRACCD_PIDM
                                                                                                    AND TBRAPPL_REAPPL_IND IS NULL
                                                                                                    AND TBRAPPL_PAY_TRAN_NUMBER IN (
                                                                                                            SELECT TBRACCD_TRAN_NUMBER
                                                                                                            FROM TBRACCD, TBBDETC
                                                                                                            WHERE     TBRACCD_PIDM = a.tbraccd_pidm--p_pidm
                                                                                                            AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                                            AND TBBDETC_TYPE_IND = 'C'
                                                                                                            AND TBRACCD_AMOUNT < 0
                                                                                                            )
                                                                                                    UNION
                                                                                                    SELECT TBRACCD_TRAN_NUMBER_PAID
                                                                                                    FROM TBRACCD, TBBDETC
                                                                                                    WHERE     TBRACCD_PIDM = a.tbraccd_pidm--p_pidm
                                                                                                    AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                                    AND TBBDETC_TYPE_IND = 'C'
                                                                                                    AND TBRACCD_AMOUNT < 0
                                                                                                    )
                                                                        And a.TBRACCD_TERM_CODE = (select max (a1.TBRACCD_TERM_CODE)
                                                                                                                            from TBRACCD a1
                                                                                                                            Where a.tbraccd_pidm = a1.tbraccd_pidm
                                                                                                                            And a.tbraccd_detail_code = a1.tbraccd_detail_code
                                                                                                                            And a.tbraccd_amount >0
                                                                                                                            )
                                                                        order by 4 desc
                                                                                                                        )Loop

                                                                   vl_vuelta :=  1;
                                                                     vl_codigo:= descu.TBRACCD_DETAIL_CODE;
                                                                     vl_descripcion := descu.TBRACCD_DESC;
                                                                     vl_monto := descu.TBRACCD_AMOUNT;
                                                                     If vl_vuelta = 1 then
                                                                        Exit;
                                                                     End if;
                                                                End Loop;


                                                        vl_vuelta :=0;
                                                         ---------------------------dbms_output.put_line('codigodetalle descuento '||vl_codigo ||  ' * '||vl_descripcion ||' * '||vl_monto);

                                                         If vl_codigo is not null and vl_descripcion is not null and vl_monto is not null then
                                                            --message('dsp1:'||vn_existen_pagos||'::'||ALUMNO.PERIODICIDAD2); pause;
                                                            --Si existe incremento, aqui se realiza el calculo de COl
                                                                                  IF vn_porc_increm > 0 THEN

                                                                                       vl_monto := ROUND(vl_monto + (vl_monto*(vn_porc_increm/100)));

                                                                                       IF vn_existen_pagos =4 AND ALUMNO.PERIODICIDAD2 = 2 THEN

                                                                   vl_monto := ROUND(vl_monto/2);
                                                                   vn_TZDOCTR_DESC_1:= ROUND(vn_TZDOCTR_DESC_1/2);

                                                              END IF ;

                                                                                     vn_resultado :=0;
                                                                                   vn_resultado := vl_monto - vn_TZDOCTR_DESC_1;
                                                                                   If vn_resultado > 2 then
                                                                                        vn_no_match := 1;
                                                                                        vl_error :=' Error en el match de incremento descuento:'||vl_monto||'<>'||vn_TZDOCTR_DESC_1;
                                                                                     END IF;

                                                                                  ELSE
                                                                                    IF vn_existen_pagos =4 AND ALUMNO.PERIODICIDAD2 = 2 THEN
                                                                   --message('dsp2:'||vn_existen_pagos||'::'||ALUMNO.PERIODICIDAD2); pause;
                                                                   vl_monto := vl_monto/2;

                                                              END IF ;
                                                                                  END IF;


                                                            vl_descuento := vl_monto;

                                                                 Begin
                                                                       select nvl (max(TBRACCD_TRAN_NUMBER) , 0)+1
                                                                       Into vl_secuencia
                                                                       from tbraccd
                                                                       Where tbraccd_pidm =  alumno.pidm;
                                                                 Exception
                                                                 When Others then
                                                                     vl_secuencia := 1;
                                                                    ---------------------------dbms_output.put_line('secuencia error'||sqlerrm);
                                                                 End;


                                                                 Begin

                                                                       Insert into TBRACCD values (
                                                                                 alumno.pidm,   -- TBRACCD_PIDM
                                                                                 vl_secuencia,     --TBRACCD_TRAN_NUMBER
                                                                                 alumno.periodo,    -- TBRACCD_TERM_CODE
                                                                                 vl_codigo,     ---TBRACCD_DETAIL_CODE
                                                                                 user,     ---TBRACCD_USER
                                                                                 SYSDATE,     --TBRACCD_ENTRY_DATE
                                                                                 nvl(vl_monto,0),
                                                                                 nvl(vl_monto,0) * -1,    ---TBRACCD_BALANCE
                                                                                 ADD_MONTHS(LAST_day (alumno.Fecha_inicio)+1,-1),--sysdate,     -- TBRACCD_EFFECTIVE_DATE
                                                                                 NULL,    --TBRACCD_BILL_DATE
                                                                                 NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                                                                                vl_descripcion,    -- TBRACCD_DESC
                                                                                null,     --TBRACCD_RECEIPT_NUMBER
                                                                                vl_secuencia_padre,     --TBRACCD_TRAN_NUMBER_PAID
                                                                                NULL,     --TBRACCD_CROSSREF_PIDM
                                                                                NULL,    --TBRACCD_CROSSREF_NUMBER
                                                                                null,       --TBRACCD_CROSSREF_DETAIL_CODE
                                                                                  'T',    --TBRACCD_SRCE_CODE
                                                                                 'Y',    --TBRACCD_ACCT_FEED_IND
                                                                                 sysdate,  --TBRACCD_ACTIVITY_DATE
                                                                                 0,        --TBRACCD_SESSION_NUMBER
                                                                                 null,    -- TBRACCD_CSHR_END_DATE
                                                                                 NULL,     --TBRACCD_CRN
                                                                                 NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                                                                                 NULL,     -- TBRACCD_LOC_MDT
                                                                                 NULL,     --TBRACCD_LOC_MDT_SEQ
                                                                                 null,     -- TBRACCD_RATE
                                                                                 NULL,     --TBRACCD_UNITS
                                                                                 NULL,     -- TBRACCD_DOCUMENT_NUMBER
                                                                                 ADD_MONTHS(LAST_day (alumno.Fecha_inicio)+1,-1),--sysdate,  -- TBRACCD_TRANS_DATE
                                                                                 NULL,        -- TBRACCD_PAYMENT_ID
                                                                                 NULL,     -- TBRACCD_INVOICE_NUMBER
                                                                                 NULL,     -- TBRACCD_STATEMENT_DATE
                                                                                 NULL,     -- TBRACCD_INV_NUMBER_PAID
                                                                                 'MXN',     -- TBRACCD_CURR_CODE
                                                                                 null,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                                                                                 NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                                                                                NULL,     -- TBRACCD_LATE_DCAT_CODE
                                                                                alumno.Fecha_inicio,--NULL,     -- TBRACCD_FEED_DATE
                                                                                NULL,     -- TBRACCD_FEED_DOC_CODE
                                                                                NULL,     -- TBRACCD_ATYP_CODE
                                                                                NULL,     -- TBRACCD_ATYP_SEQNO
                                                                                NULL,     -- TBRACCD_CARD_TYPE_VR
                                                                                NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                                                                                NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                                                                                NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                                                                                NULL,     -- TBRACCD_ORIG_CHG_IND
                                                                                NULL,     -- TBRACCD_CCRD_CODE
                                                                                NULL,     -- TBRACCD_MERCHANT_ID
                                                                                NULL,     -- TBRACCD_TAX_REPT_YEAR
                                                                                NULL,     -- TBRACCD_TAX_REPT_BOX
                                                                                NULL,     -- TBRACCD_TAX_AMOUNT
                                                                                NULL,     -- TBRACCD_TAX_FUTURE_IND
                                                                                'TZFCART_RE2',     -- TBRACCD_DATA_ORIGIN
                                                                                'AUTOR',   -- TBRACCD_CREATE_SOURCE
                                                                                null,     -- TBRACCD_CPDT_IND
                                                                                NULL,     --TBRACCD_AIDY_CODE
                                                                                alumno.study_path,     --TBRACCD_STSP_KEY_SEQUENCE
                                                                                alumno.parte_periodo,     --TBRACCD_PERIOD
                                                                                  NULL,    --TBRACCD_SURROGATE_ID
                                                                                NULL,     -- TBRACCD_VERSION
                                                                                user,     --TBRACCD_USER_ID
                                                                                NULL );     --TBRACCD_VPDI_CODE


                                                                 Exception
                                                                    When Others then
                                                                      vl_error :='Error Insertar descuento' ||sqlerrm;
                                                                       ---------------------------dbms_output.put_line(vl_error);
                                                                 End;

                                                                 --Se checa que contenga el registro de descuento en tbbestu
                                                                                               IF vl_codigo is not null then

                                                                                                    select nvl(max(a.TBBESTU_TERM_CODE) ,'0')
                                                                                                    into vl_periodo_desc
                                                                                                                                            from tbbestu A
                                                                                                                                            where A.TBBESTU_PIDM = alumno.pidm
                                                                                                                                            AND A.TBBESTU_STUDENT_EXPT_ROLL_IND= 'Y'
                                                                                                                                            AND A.TBBESTU_DEL_IND IS NULL
                                                                                                                                            AND A.TBBESTU_TERM_CODE = (SELECT MAX(TBBESTU_TERM_CODE)
                                                                                                                                                                                            from tbbestu B
                                                                                                                                                                                            WHERE B.TBBESTU_PIDM = A.TBBESTU_PIDM
                                                                                                                                                                                            AND B.TBBESTU_STUDENT_EXPT_ROLL_IND= 'Y'
                                                                                                                                                                                            AND B.TBBESTU_DEL_IND IS NULL
                                                                                                                                                                                          );
                                                                                                                                          IF vl_periodo_desc != ALUMNO.PERIODO THEN
                                                                                                                                              BEGIN

                                                                            vl_porc_desc:= floor((nvl(vl_monto,0)/vl_colegiatura)*100);
                                                                                                                    vl_porc_desc:= vl_porc_desc - mod(vl_porc_desc,5);

                                                                                                                                                      select nvl(TBBEXPT_EXEMPTION_CODE,'0')
                                                                                                                                                      into vl_cod_desc
                                                                                                                                                        from TBBEXPT--TBREDET
                                                                                                                                                        where TBBEXPT_TERM_CODE=ALUMNO.PERIODO--'011841'
                                                                                                                                                        and TBBEXPT_DETAIL_CODE=vl_codigo--'01NB'
                                                                                                                                                        AND substr(TBBEXPT_EXEMPTION_CODE,-3) = LPAD(TO_CHAR(vl_porc_desc),3,'0')
                                                                                                                                                        and substr(lpad(TBBEXPT_EXEMPTION_CODE,7,'0'),1,2) in (Select ZSTPARA_PARAM_ID
                                                                                                                                                                                                               from ZSTPARA
                                                                                                                                                                     where ZSTPARA_MAPA_ID='HOMOLOGA_NIVEL'
                                                                                                                                                                     and ZSTPARA_PARAM_VALOR = ALUMNO.NIVEL--'LI'
                                                                                                                                                                     );
                                                                                                                                               EXCEPTION
                                                                                                                   WHEN OTHERS THEN
                                                                                 vl_cod_desc:='0';
                                                                                                              END;

                                                                                                                                               IF vl_cod_desc != '0' THEN
                                                                                                                                                   BEGIN
                                                                                                                                                     INSERT INTO TBBESTU(
                                                                                                                                                       TBBESTU_EXEMPTION_CODE                    ,TBBESTU_PIDM        ,TBBESTU_TERM_CODE           ,TBBESTU_ACTIVITY_DATE
                                                                                                                                                   ,TBBESTU_STUDENT_EXPT_ROLL_IND   ,TBBESTU_USER_ID,TBBESTU_EXEMPTION_PRIORITY,TBBESTU_DATA_ORIGIN
                                                                                                                                                   )
                                                                                                                                                  VALUES(
                                                                                                                                                    vl_cod_desc                     ,ALUMNO.PIDM    ,ALUMNO.PERIODO             ,TRUNC(SYSDATE)
                                                                                                                                                    ,'Y'                                                        ,USER                        ,1                                                 ,'TZFCART_RE2'
                                                                                                                                                  );
                                                                                                                                                   EXCEPTION
                                                                                                                                                       WHEN OTHERS THEN NULL;
                                                                                                                                                   END;
                                                                                                                                            END IF;
                                                                                                                                          END IF;

                                                                                               END IF;

                                                         End if;

                                                 End if;

                                                 If vl_error is null  then          ---------------> Se crea el descuento complementario para la cartera
                                                    vl_codigo := null;
                                                    vl_descripcion := null;
                                                    vl_monto := 0;
                                                    vl_secuencia :=0;

                                                        ---------------------------dbms_output.put_line('Entra al descuento');

                                                      ---------- Busca el ultimo concepto de descuento para crear la nueva version del cargo  ------------------
                                                         vl_vuelta :=0;
                                                             --???
                                                                   For descu in (Select TBRACCD_DETAIL_CODE ,  TBRACCD_DESC, TBRACCD_AMOUNT, MAX(a.TBRACCD_TRAN_NUMBER)
                                                                        from tbraccd a
                                                                        Where a.tbraccd_pidm = alumno.pidm
                                                                        --And a.tbraccd_detail_code = substr (alumno.matricula, 1, 2)||'GB'
                                                                        And a.tbraccd_detail_code in (select TBBDETC_DETAIL_CODE
                                                                                                                 from tbbdetc
                                                                                                                 where TBBDETC_DCAT_CODE = 'DSI'
                                                                                                                And substr (TBBDETC_DETAIL_CODE, 1, 2 )  = substr (alumno.periodo, 1, 2)
                                                                                                                and TBBDETC_DETC_ACTIVE_IND = 'Y'
                                                                                                                And TBBDETC_TAXT_CODE = alumno.nivel
                                                                                                                 )
                                                                        And a.tbraccd_amount >0
                                                                        --RLS AGREGADO EN LA VERSION V 1.6
                                                                        AND TBRACCD_TRAN_NUMBER NOT IN
                                                                                                    (SELECT TBRACCD_TRAN_NUMBER
                                                                                                    FROM TBRACCD, TBBDETC
                                                                                                    WHERE     TBRACCD_PIDM = a.tbraccd_pidm--p_pidm
                                                                                                    AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                                    AND TBBDETC_TYPE_IND = 'C'
                                                                                                    AND TBRACCD_AMOUNT < 0
                                                                                                    UNION
                                                                                                    SELECT TBRAPPL_CHG_TRAN_NUMBER
                                                                                                    FROM TBRAPPL,TBRACCD
                                                                                                    WHERE TBRACCD_PIDM = a.tbraccd_pidm
                                                                                                    AND TBRAPPL_PIDM= TBRACCD_PIDM
                                                                                                    AND TBRAPPL_REAPPL_IND IS NULL
                                                                                                    AND TBRAPPL_PAY_TRAN_NUMBER IN (
                                                                                                            SELECT TBRACCD_TRAN_NUMBER
                                                                                                            FROM TBRACCD, TBBDETC
                                                                                                            WHERE     TBRACCD_PIDM = a.tbraccd_pidm--p_pidm
                                                                                                            AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                                            AND TBBDETC_TYPE_IND = 'C'
                                                                                                            AND TBRACCD_AMOUNT < 0
                                                                                                            )
                                                                                                    UNION
                                                                                                    SELECT TBRACCD_TRAN_NUMBER_PAID
                                                                                                    FROM TBRACCD, TBBDETC
                                                                                                    WHERE     TBRACCD_PIDM = a.tbraccd_pidm--p_pidm
                                                                                                    AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                                    AND TBBDETC_TYPE_IND = 'C'
                                                                                                    AND TBRACCD_AMOUNT < 0
                                                                                                    )
                                                                        And a.TBRACCD_TERM_CODE = (select max (a1.TBRACCD_TERM_CODE)
                                                                                                                            from TBRACCD a1
                                                                                                                            Where a.tbraccd_pidm = a1.tbraccd_pidm
                                                                                                                            And a.tbraccd_detail_code = a1.tbraccd_detail_code
                                                                                                                            And a.tbraccd_amount >0)
                                                                        GROUP BY TBRACCD_DETAIL_CODE ,  TBRACCD_DESC, TBRACCD_AMOUNT
                                                                        order by 4 desc
                                                                                                                        )Loop

                                                                   vl_vuelta :=  1;
                                                                     vl_codigo:= descu.TBRACCD_DETAIL_CODE;
                                                                     vl_descripcion := descu.TBRACCD_DESC;
                                                                     vl_monto := descu.TBRACCD_AMOUNT;
                                                                     If vl_vuelta = 1 then
                                                                        Exit;
                                                                     End if;
                                                                End Loop;


                                                        vl_vuelta :=0;
                                                         ---------------------------dbms_output.put_line('codigodetalle descuento '||vl_codigo ||  ' * '||vl_descripcion ||' * '||vl_monto);

                                                         If vl_codigo is not null and vl_descripcion is not null and vl_monto is not null then

                                                               --Si existe incremento, aqui se realiza el calculo de COl
                                                                                  IF vn_porc_increm > 0 THEN

                                                                                       vl_monto := vl_monto + (vl_monto*(vn_porc_increm/100));

                                                                                       IF vn_existen_pagos =4 AND ALUMNO.PERIODICIDAD2 = 2 THEN

                                                                   vl_monto := ROUND(vl_monto/2);

                                                                 END IF ;

                                                                                  ELSE
                                                                                    IF vn_existen_pagos =4 AND ALUMNO.PERIODICIDAD2 = 2 THEN

                                                                   vl_monto := vl_monto/2;

                                                              END IF ;

                                                                                  END IF;

                                                            --vl_descuento := vl_monto;

                                                                 Begin
                                                                       select nvl (max(TBRACCD_TRAN_NUMBER) , 0)+1
                                                                       Into vl_secuencia
                                                                       from tbraccd
                                                                       Where tbraccd_pidm =  alumno.pidm;
                                                                 Exception
                                                                 When Others then
                                                                     vl_secuencia := 1;
                                                                    ---------------------------dbms_output.put_line('secuencia error'||sqlerrm);
                                                                 End;


                                                                 Begin

                                                                       Insert into TBRACCD values (
                                                                                 alumno.pidm,   -- TBRACCD_PIDM
                                                                                 vl_secuencia,     --TBRACCD_TRAN_NUMBER
                                                                                 alumno.periodo,    -- TBRACCD_TERM_CODE
                                                                                 vl_codigo,     ---TBRACCD_DETAIL_CODE
                                                                                 user,     ---TBRACCD_USER
                                                                                 SYSDATE,     --TBRACCD_ENTRY_DATE
                                                                                 nvl(vl_monto,0),
                                                                                 nvl(vl_monto,0) * -1,    ---TBRACCD_BALANCE
                                                                                 ADD_MONTHS(LAST_day (alumno.Fecha_inicio)+1,-1),--sysdate,     -- TBRACCD_EFFECTIVE_DATE
                                                                                 NULL,    --TBRACCD_BILL_DATE
                                                                                 NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                                                                                vl_descripcion,    -- TBRACCD_DESC
                                                                                null,     --TBRACCD_RECEIPT_NUMBER
                                                                                vl_secuencia_padre,     --TBRACCD_TRAN_NUMBER_PAID
                                                                                NULL,     --TBRACCD_CROSSREF_PIDM
                                                                                NULL,    --TBRACCD_CROSSREF_NUMBER
                                                                                null,       --TBRACCD_CROSSREF_DETAIL_CODE
                                                                                  'T',    --TBRACCD_SRCE_CODE
                                                                                 'Y',    --TBRACCD_ACCT_FEED_IND
                                                                                 sysdate,  --TBRACCD_ACTIVITY_DATE
                                                                                 0,        --TBRACCD_SESSION_NUMBER
                                                                                 null,    -- TBRACCD_CSHR_END_DATE
                                                                                 NULL,     --TBRACCD_CRN
                                                                                 NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                                                                                 NULL,     -- TBRACCD_LOC_MDT
                                                                                 NULL,     --TBRACCD_LOC_MDT_SEQ
                                                                                 null,     -- TBRACCD_RATE
                                                                                 NULL,     --TBRACCD_UNITS
                                                                                 NULL,     -- TBRACCD_DOCUMENT_NUMBER
                                                                                 ADD_MONTHS(LAST_day (alumno.Fecha_inicio)+1,-1),--sysdate,  -- TBRACCD_TRANS_DATE
                                                                                 NULL,        -- TBRACCD_PAYMENT_ID
                                                                                 NULL,     -- TBRACCD_INVOICE_NUMBER
                                                                                 NULL,     -- TBRACCD_STATEMENT_DATE
                                                                                 NULL,     -- TBRACCD_INV_NUMBER_PAID
                                                                                 'MXN',     -- TBRACCD_CURR_CODE
                                                                                 null,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                                                                                 NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                                                                                NULL,     -- TBRACCD_LATE_DCAT_CODE
                                                                                alumno.Fecha_inicio,--NULL,     -- TBRACCD_FEED_DATE
                                                                                NULL,     -- TBRACCD_FEED_DOC_CODE
                                                                                NULL,     -- TBRACCD_ATYP_CODE
                                                                                NULL,     -- TBRACCD_ATYP_SEQNO
                                                                                NULL,     -- TBRACCD_CARD_TYPE_VR
                                                                                NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                                                                                NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                                                                                NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                                                                                NULL,     -- TBRACCD_ORIG_CHG_IND
                                                                                NULL,     -- TBRACCD_CCRD_CODE
                                                                                NULL,     -- TBRACCD_MERCHANT_ID
                                                                                NULL,     -- TBRACCD_TAX_REPT_YEAR
                                                                                NULL,     -- TBRACCD_TAX_REPT_BOX
                                                                                NULL,     -- TBRACCD_TAX_AMOUNT
                                                                                NULL,     -- TBRACCD_TAX_FUTURE_IND
                                                                                'TZFCART_RE2',     -- TBRACCD_DATA_ORIGIN
                                                                                'AUTOR',   -- TBRACCD_CREATE_SOURCE
                                                                                null,     -- TBRACCD_CPDT_IND
                                                                                NULL,     --TBRACCD_AIDY_CODE
                                                                                alumno.study_path,     --TBRACCD_STSP_KEY_SEQUENCE
                                                                                alumno.parte_periodo,     --TBRACCD_PERIOD
                                                                                  NULL,    --TBRACCD_SURROGATE_ID
                                                                                NULL,     -- TBRACCD_VERSION
                                                                                user,     --TBRACCD_USER_ID
                                                                                NULL );     --TBRACCD_VPDI_CODE


                                                                 Exception
                                                                    When Others then
                                                                      vl_error :='Error Insertar descuento' ||sqlerrm;
                                                                       ---------------------------dbms_output.put_line(vl_error);
                                                                 End;

                                                         End if;

                                                 End if;





                                                 If vl_error is null  then          ---------------> Se crea el plan de pagos para la cartera
                                                    vl_codigo := null;
                                                    vl_descripcion := null;
                                                    vl_monto := 0;
                                                    vl_secuencia :=0;

                                                        ---------------------------dbms_output.put_line('Entra al Plan de pagos');

                                                      ---------- Busca el ultimo concepto de plan de pagos para crear la nueva version del cargo  ------------------
                                                         vl_vuelta :=0;
                                                         For pplan in (Select distinct TBRACCD_DETAIL_CODE ,  TBRACCD_DESC, TBRACCD_AMOUNT, a.TBRACCD_TRAN_NUMBER
                                                                            from tbraccd a
                                                                            Where a.tbraccd_pidm = alumno.pidm
                                                                            And a.tbraccd_detail_code in (select TBBDETC_DETAIL_CODE
                                                                                                                     from tbbdetc
                                                                                                                     where TBBDETC_DCAT_CODE = 'LPC'
                                                                                                                    And TBBDETC_DETAIL_CODE = 'PLPA'
                                                                                                                     )
                                                                            And a.tbraccd_amount >0
                                                                            --RLS AGREGADO EN LA VERSION V 1.6
                                                                            AND TBRACCD_TRAN_NUMBER NOT IN
                                                                                                    (SELECT TBRACCD_TRAN_NUMBER
                                                                                                    FROM TBRACCD, TBBDETC
                                                                                                    WHERE     TBRACCD_PIDM = a.tbraccd_pidm--p_pidm
                                                                                                    AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                                    AND TBBDETC_TYPE_IND = 'C'
                                                                                                    AND TBRACCD_AMOUNT < 0
                                                                                                    UNION
                                                                                                    SELECT TBRAPPL_CHG_TRAN_NUMBER
                                                                                                    FROM TBRAPPL,TBRACCD
                                                                                                    WHERE TBRACCD_PIDM = a.tbraccd_pidm
                                                                                                    AND TBRAPPL_PIDM= TBRACCD_PIDM
                                                                                                    AND TBRAPPL_REAPPL_IND IS NULL
                                                                                                    AND TBRAPPL_PAY_TRAN_NUMBER IN (
                                                                                                            SELECT TBRACCD_TRAN_NUMBER
                                                                                                            FROM TBRACCD, TBBDETC
                                                                                                            WHERE     TBRACCD_PIDM = a.tbraccd_pidm--p_pidm
                                                                                                            AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                                            AND TBBDETC_TYPE_IND = 'C'
                                                                                                            AND TBRACCD_AMOUNT < 0
                                                                                                            )
                                                                                                    UNION
                                                                                                    SELECT TBRACCD_TRAN_NUMBER_PAID
                                                                                                    FROM TBRACCD, TBBDETC
                                                                                                    WHERE     TBRACCD_PIDM = a.tbraccd_pidm--p_pidm
                                                                                                    AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                                    AND TBBDETC_TYPE_IND = 'C'
                                                                                                    AND TBRACCD_AMOUNT < 0
                                                                                                    )
                                                                            And a.TBRACCD_TERM_CODE = (select max (a1.TBRACCD_TERM_CODE)
                                                                                                                                from TBRACCD a1
                                                                                                                                Where a.tbraccd_pidm = a1.tbraccd_pidm
                                                                                                                                And a.tbraccd_detail_code = a1.tbraccd_detail_code
                                                                                                                                And a.tbraccd_amount >0)
                                                                            order by 4 desc
                                                                                                                                ) Loop
                                                                   vl_vuelta :=  1;
                                                                     vl_codigo:= pplan.TBRACCD_DETAIL_CODE;
                                                                     vl_descripcion := pplan.TBRACCD_DESC;
                                                                     vl_monto := pplan.TBRACCD_AMOUNT;
                                                                     If vl_vuelta = 1 then
                                                                        Exit;
                                                                     End if;
                                                                End Loop;

                                                         ---------------------------dbms_output.put_line('codigodetalle plan de pagos '||vl_codigo ||  ' * '||vl_descripcion ||' * '||vl_monto);

                                                         If vl_codigo is not null and vl_descripcion is not null and vl_monto is not null then

                                                               --Si existe incremento, aqui se realiza el calculo de COl
                                                                                  IF vn_porc_increm > 0 THEN


                                                                                       vl_monto := ROUND(vl_colegiatura - vl_descuento);

                                                                                       IF vn_existen_pagos =4 AND ALUMNO.PERIODICIDAD2 = 2 THEN

                                                                    --vl_monto := ROUND(vl_monto/2);
                                                                    vn_TZDOCTR_PPAGO_1 := ROUND(vn_TZDOCTR_PPAGO_1/2);

                                                                                       END IF ;

                                                                                       --IF vl_monto <> vn_TZDOCTR_PPAGO_1 THEN
                                                                                       vn_resultado :=0;
                                                                                       vn_resultado := vl_monto - vn_TZDOCTR_PPAGO_1;
                                                                                       If vn_resultado > 2 then
                                                                                                vn_no_match := 1;
                                                                                                vl_error :=' Error en el match de incremento en plan:'||vl_monto||'<>'||vn_TZDOCTR_PPAGO_1;
                                                                                         END IF;
                                                                                     ELSE
                                                                                    IF vn_existen_pagos =4 AND ALUMNO.PERIODICIDAD2 = 2 THEN

                                                                    vl_monto := vl_monto/2;
                                                                    --vn_TZDOCTR_PPAGO_1 := ROUND(vn_TZDOCTR_PPAGO_1/2);

                                                                                       END IF ;
                                                                                  END IF;



                                                            vl_plan_pago :=vl_monto;

                                                                 Begin
                                                                       select nvl (max(TBRACCD_TRAN_NUMBER) , 0)+1
                                                                       Into vl_secuencia
                                                                       from tbraccd
                                                                       Where tbraccd_pidm =  alumno.pidm;
                                                                 Exception
                                                                 When Others then
                                                                     vl_secuencia := 1;
                                                                    ---------------------------dbms_output.put_line('secuencia error plan de pagos'||sqlerrm);
                                                                 End;


                                                                 Begin

                                                                       Insert into TBRACCD values (
                                                                                 alumno.pidm,   -- TBRACCD_PIDM
                                                                                 vl_secuencia,     --TBRACCD_TRAN_NUMBER
                                                                                 alumno.periodo,    -- TBRACCD_TERM_CODE
                                                                                 vl_codigo,     ---TBRACCD_DETAIL_CODE
                                                                                 user,     ---TBRACCD_USER
                                                                                 SYSDATE,     --TBRACCD_ENTRY_DATE
                                                                                 nvl(vl_monto,0),
                                                                                 nvl(vl_monto,0) * -1,    ---TBRACCD_BALANCE
                                                                                 ADD_MONTHS(LAST_day (alumno.Fecha_inicio)+1,-1),--sysdate,     -- TBRACCD_EFFECTIVE_DATE
                                                                                 NULL,    --TBRACCD_BILL_DATE
                                                                                 NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                                                                                vl_descripcion,    -- TBRACCD_DESC
                                                                                null,     --TBRACCD_RECEIPT_NUMBER
                                                                                vl_secuencia_padre,     --TBRACCD_TRAN_NUMBER_PAID
                                                                                NULL,     --TBRACCD_CROSSREF_PIDM
                                                                                NULL,    --TBRACCD_CROSSREF_NUMBER
                                                                                null,       --TBRACCD_CROSSREF_DETAIL_CODE
                                                                                  'T',    --TBRACCD_SRCE_CODE
                                                                                 'Y',    --TBRACCD_ACCT_FEED_IND
                                                                                 sysdate,  --TBRACCD_ACTIVITY_DATE
                                                                                 0,        --TBRACCD_SESSION_NUMBER
                                                                                 null,    -- TBRACCD_CSHR_END_DATE
                                                                                 NULL,     --TBRACCD_CRN
                                                                                 NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                                                                                 NULL,     -- TBRACCD_LOC_MDT
                                                                                 NULL,     --TBRACCD_LOC_MDT_SEQ
                                                                                 null,     -- TBRACCD_RATE
                                                                                 NULL,     --TBRACCD_UNITS
                                                                                 NULL,     -- TBRACCD_DOCUMENT_NUMBER
                                                                                 ADD_MONTHS(LAST_day (alumno.Fecha_inicio)+1,-1),--sysdate,  -- TBRACCD_TRANS_DATE
                                                                                 NULL,        -- TBRACCD_PAYMENT_ID
                                                                                 NULL,     -- TBRACCD_INVOICE_NUMBER
                                                                                 NULL,     -- TBRACCD_STATEMENT_DATE
                                                                                 NULL,     -- TBRACCD_INV_NUMBER_PAID
                                                                                 'MXN',     -- TBRACCD_CURR_CODE
                                                                                 null,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                                                                                 NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                                                                                NULL,     -- TBRACCD_LATE_DCAT_CODE
                                                                                alumno.Fecha_inicio,--NULL,     -- TBRACCD_FEED_DATE
                                                                                NULL,     -- TBRACCD_FEED_DOC_CODE
                                                                                NULL,     -- TBRACCD_ATYP_CODE
                                                                                NULL,     -- TBRACCD_ATYP_SEQNO
                                                                                NULL,     -- TBRACCD_CARD_TYPE_VR
                                                                                NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                                                                                NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                                                                                NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                                                                                NULL,     -- TBRACCD_ORIG_CHG_IND
                                                                                NULL,     -- TBRACCD_CCRD_CODE
                                                                                NULL,     -- TBRACCD_MERCHANT_ID
                                                                                NULL,     -- TBRACCD_TAX_REPT_YEAR
                                                                                NULL,     -- TBRACCD_TAX_REPT_BOX
                                                                                NULL,     -- TBRACCD_TAX_AMOUNT
                                                                                NULL,     -- TBRACCD_TAX_FUTURE_IND
                                                                                'TZFCART_RE2',     -- TBRACCD_DATA_ORIGIN
                                                                                'AUTOR',   -- TBRACCD_CREATE_SOURCE
                                                                                null,     -- TBRACCD_CPDT_IND
                                                                                NULL,     --TBRACCD_AIDY_CODE
                                                                                alumno.study_path,     --TBRACCD_STSP_KEY_SEQUENCE
                                                                                alumno.parte_periodo,     --TBRACCD_PERIOD
                                                                                  NULL,    --TBRACCD_SURROGATE_ID
                                                                                NULL,     -- TBRACCD_VERSION
                                                                                user,     --TBRACCD_USER_ID
                                                                                NULL );     --TBRACCD_VPDI_CODE


                                                                 Exception
                                                                    When Others then
                                                                      vl_error :='Error Insertar Plan de Pagos' ||sqlerrm;
                                                                       ------------------------------------------------------dbms_output.put_line(vl_error);
                                                                 End;
                                                         Elsif    vl_codigo is null or vl_descripcion is not null or vl_monto is not null then
                                                           vl_error :='Error el buscar Valores de Plan de pagos algun valor vacio Codigo = ' ||vl_codigo ||' Descripcion = '||vl_descripcion ||'  Monto = '||vl_monto  ||' ? '||alumno.pidm;
                                                             ------------------------------------------------------dbms_output.put_line(vl_error);
                                                         End if;

                                                 End if;



                                                 If vl_error is null  then          ---------------> Se crean las parcialidades se crean  cuatro para cubrir el cuatrimestre completo
                                                    vl_codigo := null;
                                                    vl_descripcion := null;
                                                    vl_monto := 0;
                                                    vl_secuencia :=0;
                                                    vl_num_parc :=0;

                                                        ------------------------------------------------------dbms_output.put_line('Entra a crear parcialidades');
                                                       vl_dia :=alumno.vencimiento;
                                                       vl_mes :=substr (to_char(alumno.fecha_inicio, 'dd/mm/rrrr'), 4, 2);
                                                       vl_ano :=substr (to_char(alumno.fecha_inicio, 'dd/mm/rrrr'), 7, 4);


                                                       ------------------------------------------------------dbms_output.put_line('fechas '  ||vl_dia|| '+'||vl_mes||'+'||vl_ano);
                                                      ---------- Busca el ultimo concepto de parcialidades para crear la nueva version del cargo  ------------------


                                                            ---VICTOR

                                                        vl_vuelta :=0;
                                                               For parci in (select distinct count (a.tbraccd_detail_code)No_Parc, a.TBRACCD_DETAIL_CODE ,  a.TBRACCD_DESC, a.TBRACCD_AMOUNT
                                                                                    from tbraccd a
                                                                                    where a.tbraccd_pidm = alumno.pidm
                                                                                    And a.tbraccd_detail_code in (select TBBDETC_DETAIL_CODE
                                                                                                                            from tbbdetc
                                                                                                                            where TBBDETC_DCAT_CODE = 'COL'
                                                                                                                            And substr (TBBDETC_DETAIL_CODE, 1, 2 )  = substr (a.TBRACCD_TERM_CODE, 1, 2)
                                                                                                                            And substr (TBBDETC_DETAIL_CODE,1,3) = substr (a.TBRACCD_TERM_CODE, 1, 2)||'N'
                                                                                                                            and TBBDETC_DETC_ACTIVE_IND = 'Y'
                                                                                                                            And TBBDETC_TAXT_CODE = alumno.nivel)
                                                                                    And a.tbraccd_amount >0
                                                                                    --RLS AGREGADO EN LA VERSION V 1.6
                                                                                    AND TBRACCD_TRAN_NUMBER NOT IN
                                                                                                    (SELECT TBRACCD_TRAN_NUMBER
                                                                                                    FROM TBRACCD, TBBDETC
                                                                                                    WHERE     TBRACCD_PIDM = a.tbraccd_pidm--p_pidm
                                                                                                    AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                                    AND TBBDETC_TYPE_IND = 'C'
                                                                                                    AND TBRACCD_AMOUNT < 0
                                                                                                    UNION
                                                                                                    SELECT TBRAPPL_CHG_TRAN_NUMBER
                                                                                                    FROM TBRAPPL,TBRACCD
                                                                                                    WHERE TBRACCD_PIDM = a.tbraccd_pidm
                                                                                                    AND TBRAPPL_PIDM= TBRACCD_PIDM
                                                                                                    AND TBRAPPL_REAPPL_IND IS NULL
                                                                                                    AND TBRAPPL_PAY_TRAN_NUMBER IN (
                                                                                                            SELECT TBRACCD_TRAN_NUMBER
                                                                                                            FROM TBRACCD, TBBDETC
                                                                                                            WHERE     TBRACCD_PIDM = a.tbraccd_pidm--p_pidm
                                                                                                            AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                                            AND TBBDETC_TYPE_IND = 'C'
                                                                                                            AND TBRACCD_AMOUNT < 0
                                                                                                            )
                                                                                                    UNION
                                                                                                    SELECT TBRACCD_TRAN_NUMBER_PAID
                                                                                                    FROM TBRACCD, TBBDETC
                                                                                                    WHERE     TBRACCD_PIDM = a.tbraccd_pidm--p_pidm
                                                                                                    AND TBBDETC_DETAIL_CODE = TBRACCD_DETAIL_CODE
                                                                                                    AND TBBDETC_TYPE_IND = 'C'
                                                                                                    AND TBRACCD_AMOUNT < 0
                                                                                                    )
                                                                                    And a.TBRACCD_TERM_CODE = (select max (a1.TBRACCD_TERM_CODE)
                                                                                                                                        from tbraccd a1
                                                                                                                                        Where a.tbraccd_pidm = a1.tbraccd_pidm
                                                                                                                                        And   a.tbraccd_detail_code = a1.tbraccd_detail_code
                                                                                                                                        )
                                                                                    group by a.TBRACCD_DETAIL_CODE ,  a.TBRACCD_DESC, a.TBRACCD_AMOUNT
                                                                                    order by 1 desc ) loop
                                                                     vl_vuelta :=  1;
                                                                     vl_num_parc:= parci.No_Parc;
                                                                     vl_codigo:= parci.TBRACCD_DETAIL_CODE;
                                                                     vl_descripcion := parci.TBRACCD_DESC;
                                                                     vl_monto := parci.TBRACCD_AMOUNT;
                                                                     If vl_vuelta = 1 then
                                                                        Exit;
                                                                     End if;
                                                                End Loop;
                                                         ------------------------------------------------------dbms_output.put_line('codigodetalle parcialidades '||vl_codigo ||  ' * '||vl_descripcion ||' * '||vl_monto|| '*' ||alumno.num_pagos || '?' ||alumno.pidm);
         ---vmrl16

                                                                                                                If vn_existen_ppl = 2 and vl_num_parc = 4 then
                                                                                                                        vl_num_parc := 2;
                                                                                                                End if;


                                                       If vl_codigo is not null and vl_descripcion is not null and vl_monto is not null and alumno.num_pagos is not null then

                                                                    --Si existe incremento, aqui se realiza el calculo de COl
                                                                                                  IF vn_porc_increm > 0 THEN

                                                                                                       vl_monto:=ROUND(vl_plan_pago/alumno.periodicidad2);--alumno.Num_pagos;

                                                                                                       IF vl_monto <> vn_TZDOCTR_PARCI_1 THEN

                                                                                                                vn_no_match := 1;
                                                                                                                vl_error :=' Error en el match de incremento en parc:'||vl_monto||'<>'||vn_TZDOCTR_PARCI_1||' NumParc:'||alumno.periodicidad2;

                                                                                                         END IF;

                                                                                                     END IF;

                                                                    vl_parcialidad := vl_monto;
                                                                    ------------------------------------------------------dbms_output.put_line('Un monton de vacios  Pidm '||vl_codigo ||  ' * '||vl_descripcion ||' * '||vl_monto|| '*' ||alumno.num_pagos || '?' ||alumno.pidm);

                                                                    If alumno.num_pagos > 4 then
                                                                       null;
                                                                       ------------------------------------------------------dbms_output.put_line('Un monto de vacios '||vl_codigo ||  ' * '||vl_descripcion ||' * '||vl_monto|| '*' ||alumno.num_pagos);
                                                                    Elsif alumno.num_pagos between 1 and 4  then
                                                                       ------------------------------------------------------dbms_output.put_line('Procesa la cartera'||vl_codigo ||  ' * '||vl_descripcion ||' * '||vl_monto|| '*' ||alumno.num_pagos);

                                                                              --  FOR i IN 1..alumno.Num_pagos LOOP

                                                                                FOR i IN 1..alumno.periodicidad2 LOOP


                                                                                     --vl_vencimiento := vl_dia||'/'||vl_mes||'/'||vl_ano;
                                                                                     IF vl_dia = '30' THEN
                                                                                       vl_vencimiento := case Lpad(vl_mes,2,'0') when '02' then '28' else vl_dia end||'/'||Lpad(vl_mes,2,'0')||'/'||vl_ano;
                                                                                     ELSE
                                                                                          vl_vencimiento := vl_dia||'/'||Lpad(vl_mes,2,'0')||'/'||vl_ano;
                                                                                     END IF;
                                                                                      ------------------------------------------------------dbms_output.put_line('fechas armada'  ||vl_vencimiento);
                                                                                      --Se checa si existe parcialidad con la fecha

                                                                                     vn_existe_parc := null;

                                                                                     Begin
                                                                                           /*select 'S'
                                                                                           Into vn_existe_parc
                                                                                           from tbraccd
                                                                                           Where tbraccd_pidm =  alumno.pidm
                                                                                           and trunc(TBRACCD_EFFECTIVE_DATE) = to_date(vl_vencimiento, 'dd/mm/rrrr');*/

                                                                                          SELECT 'S'
                                                                                          Into vn_existe_parc
                                                                                                                                                                                    FROM TBRACCD a
                                                                                                                                                                                    WHERE a.TBRACCD_PIDM=alumno.pidm--14787
                                                                                                                                                                                    and TRUNC(a.TBRACCD_EFFECTIVE_DATE)=to_date(vl_vencimiento, 'dd/mm/rrrr')--'15/11/2017'
                                                                                                                                                                                    And a.tbraccd_detail_code in (select TBBDETC_DETAIL_CODE
                                                                                                                                                                                                    from tbbdetc
                                                                                                                                                                                                    where TBBDETC_DCAT_CODE = 'COL'
                                                                                                                                                                                                    And substr (TBBDETC_DETAIL_CODE, 1, 2 )  = substr (a.TBRACCD_TERM_CODE, 1, 2)
                                                                                                                                                                                                    And substr (TBBDETC_DETAIL_CODE,1,3) = substr (a.TBRACCD_TERM_CODE, 1, 2)||'N'
                                                                                                                                                                                                    and TBBDETC_DETC_ACTIVE_IND = 'Y'
                                                                                                                                                                                                    )
                                                                                                                                                                                    AND NOT EXISTS (
                                                                                                                                                                                                       SELECT 1
                                                                                                                                                                                                       FROM TBRAPPL,TBRACCD b
                                                                                                                                                                                                       WHERE b.TBRACCD_PIDM = a.TBRACCD_PIDM
                                                                                                                                                                                                       AND TBRAPPL_PIDM= b.TBRACCD_PIDM
                                                                                                                                                                                                       AND TBRAPPL_REAPPL_IND IS NULL
                                                                                                                                                                                                       AND TBRAPPL_PAY_TRAN_NUMBER= b.TBRACCD_TRAN_NUMBER
                                                                                                                                                                                                       and TBRAPPL_CHG_TRAN_NUMBER =a.TBRACCD_TRAN_NUMBER
                                                                                                                                                                                                       AND SUBSTR(TBRACCD_DETAIL_CODE,-2) IN (SELECT ZSTPARA_PARAM_VALOR
                                                                                                                                                                                                                                                       FROM ZSTPARA
                                                                                                                                                                                                                                                        WHERE ZSTPARA_MAPA_ID = 'DET_CODE_CART'
                                                                                                                                                                                                                                                        AND ZSTPARA_PARAM_ID = 'PARC_ANTERIOR'
                                                                                                                                                                                                                                              )
                                                                                                                                                                                                  );


                                                                                     Exception
                                                                                     When too_many_rows then
                                                                                         vn_existe_parc := 'S';
                                                                                     When Others then
                                                                                         vn_existe_parc := null;
                                                                                        ------------------------------------------------------dbms_output.put_line('secuencia error parcialidad'||sqlerrm);
                                                                                     End;

                                                                                     IF vn_existe_parc IS NULL THEN

                                                                                                 Begin
                                                                                                       select nvl (max(TBRACCD_TRAN_NUMBER) , 0)+1
                                                                                                       Into vl_secuencia
                                                                                                       from tbraccd
                                                                                                       Where tbraccd_pidm =  alumno.pidm;
                                                                                                 Exception
                                                                                                 When Others then
                                                                                                     vl_secuencia := 1;
                                                                                                    ------------------------------------------------------dbms_output.put_line('secuencia error parcialidad'||sqlerrm);
                                                                                                 End;


                                                                                                 Begin

                                                                                                       Insert into TBRACCD values (
                                                                                                                 alumno.pidm,   -- TBRACCD_PIDM
                                                                                                                 vl_secuencia,     --TBRACCD_TRAN_NUMBER
                                                                                                                 alumno.periodo,    -- TBRACCD_TERM_CODE
                                                                                                                 vl_codigo,     ---TBRACCD_DETAIL_CODE
                                                                                                                 user,     ---TBRACCD_USER
                                                                                                                 SYSDATE,     --TBRACCD_ENTRY_DATE
                                                                                                                 nvl(vl_monto,0),
                                                                                                                 nvl(vl_monto,0) ,    ---TBRACCD_BALANCE
                                                                                                                 to_date (vl_vencimiento, 'dd/mm/rrrr'),     -- TBRACCD_EFFECTIVE_DATE
                                                                                                                 NULL,    --TBRACCD_BILL_DATE
                                                                                                                 NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                                                                                                                vl_descripcion,    -- TBRACCD_DESC
                                                                                                                null,     --TBRACCD_RECEIPT_NUMBER
                                                                                                                null,     --TBRACCD_TRAN_NUMBER_PAID
                                                                                                                NULL,     --TBRACCD_CROSSREF_PIDM
                                                                                                                NULL,    --TBRACCD_CROSSREF_NUMBER
                                                                                                                null,       --TBRACCD_CROSSREF_DETAIL_CODE
                                                                                                                  'T',    --TBRACCD_SRCE_CODE
                                                                                                                 'Y',    --TBRACCD_ACCT_FEED_IND
                                                                                                                 sysdate,  --TBRACCD_ACTIVITY_DATE
                                                                                                                 0,        --TBRACCD_SESSION_NUMBER
                                                                                                                 null,    -- TBRACCD_CSHR_END_DATE
                                                                                                                 NULL,     --TBRACCD_CRN
                                                                                                                 NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                                                                                                                 NULL,     -- TBRACCD_LOC_MDT
                                                                                                                 NULL,     --TBRACCD_LOC_MDT_SEQ
                                                                                                                 null,     -- TBRACCD_RATE
                                                                                                                 NULL,     --TBRACCD_UNITS
                                                                                                                 NULL,     -- TBRACCD_DOCUMENT_NUMBER
                                                                                                                 to_date (vl_vencimiento, 'dd/mm/rrrr'),     -- sysdate,  -- TBRACCD_TRANS_DATE
                                                                                                                 NULL,        -- TBRACCD_PAYMENT_ID
                                                                                                                 NULL,     -- TBRACCD_INVOICE_NUMBER
                                                                                                                 NULL,     -- TBRACCD_STATEMENT_DATE
                                                                                                                 NULL,     -- TBRACCD_INV_NUMBER_PAID
                                                                                                                 'MXN',     -- TBRACCD_CURR_CODE
                                                                                                                 null,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                                                                                                                 NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                                                                                                                NULL,     -- TBRACCD_LATE_DCAT_CODE
                                                                                                                alumno.Fecha_inicio,--NULL,     -- TBRACCD_FEED_DATE
                                                                                                                NULL,     -- TBRACCD_FEED_DOC_CODE
                                                                                                                NULL,     -- TBRACCD_ATYP_CODE
                                                                                                                NULL,     -- TBRACCD_ATYP_SEQNO
                                                                                                                NULL,     -- TBRACCD_CARD_TYPE_VR
                                                                                                                NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                                                                                                                NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                                                                                                                NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                                                                                                                NULL,     -- TBRACCD_ORIG_CHG_IND
                                                                                                                NULL,     -- TBRACCD_CCRD_CODE
                                                                                                                NULL,     -- TBRACCD_MERCHANT_ID
                                                                                                                NULL,     -- TBRACCD_TAX_REPT_YEAR
                                                                                                                NULL,     -- TBRACCD_TAX_REPT_BOX
                                                                                                                NULL,     -- TBRACCD_TAX_AMOUNT
                                                                                                                NULL,     -- TBRACCD_TAX_FUTURE_IND
                                                                                                                'TZFCART_RE2',     -- TBRACCD_DATA_ORIGIN
                                                                                                                'AUTOR',   -- TBRACCD_CREATE_SOURCE
                                                                                                                null,     -- TBRACCD_CPDT_IND
                                                                                                                NULL,     --TBRACCD_AIDY_CODE
                                                                                                                alumno.study_path,     --TBRACCD_STSP_KEY_SEQUENCE
                                                                                                                alumno.parte_periodo,     --TBRACCD_PERIOD
                                                                                                                  NULL,    --TBRACCD_SURROGATE_ID
                                                                                                                NULL,     -- TBRACCD_VERSION
                                                                                                                user,     --TBRACCD_USER_ID
                                                                                                                NULL );     --TBRACCD_VPDI_CODE

                                                                                                              vl_mes := vl_mes +1;
                                                                                                               If vl_mes = '13' then
                                                                                                                     vl_mes := '01';
                                                                                                                     vl_ano := vl_ano +1;
                                                                                                               End if;
                                                                                                  Exception
                                                                                                    When Others then
                                                                                                      vl_error :='Error Insertar Parcialidades' ||sqlerrm;

                                                                                                       ------------------------------------------------------dbms_output.put_line(vl_error);
                                                                                                 End;

                                                                                     else
                                                                                                 vl_error :='Error Ya existe parcialidad para la fecha: '||vl_vencimiento||' En el periodo:'||alumno.periodo;

                                                                                     end if;


                                                                                End loop;
                                                                    End if;

                                                        Else
                                                           vl_error :='Error el buscar Valores de Parcialidades algun valor vacio Codigo = ' ||vl_codigo ||' Descripcion = '||vl_descripcion ||'  Monto = '||vl_monto ||' Num Parcialidad = '||alumno.num_pagos ||' ? '||alumno.pidm;
                                                             ------------------------------------------------------dbms_output.put_line(vl_error);
                                                        End if;


                                                 End if;

                                        Else
                                           vl_error :='No se encontró el codigo de detalle, descripcion y monto para Colegiatura';
                                           --vl_plan_bita :=1;
                                        End if;

                                    Else
                                      vl_error :='Ya Existe la Cartera debido a que es un Plan ';
                                      vl_plan_bita :=1;
                                    End if;
                                /*
                                ELSIF ALUMNO.Tipo_Alumno = 'N' THEN
                                   vl_error :='El Alumno es de nuevo Ingreso, estos alumnos se Deben Procesar por el Tab: Nuevo Ingreso o Por la Opción de Regla.';
                                END IF;
                                */
                          End If;

                          if   vl_error is null and vl_error1 is null and vn_no_match = 0 then
                                 Commit;
                          Elsif  vl_error is not null or  vl_error1 is not null or vn_no_match = 1 then

                                 Rollback;

                          End if;


                             ------------------------------------------------------dbms_output.put_line('termina los Insert  ' ||'*'||vl_error);

                          If vl_existe_cart = 0 and vl_existe_desc = 0 and vl_existe_pplan = 0 and vl_existe_parc = 0 and vl_error is null then  ----> Registra en la Bitacora ya sea exito en la creacion o error

                               ------------------------------------------------------dbms_output.put_line('Validada para insertar bitacora y commit  ' ||'*'||vl_existe_cart ||'*'||vl_error);

                                Begin
                                           Select count (1)
                                            Into vl_existe_bita
                                           from TZDOCTR
                                           Where TZDOCTR_PIDM = alumno.pidm
                                            And TZDOCTR_PROGRAM = alumno.programa
                                            And TZDOCTR_TERM_CODE =  alumno.periodo
                                            And TZDOCTR_START_DATE = alumno.Fecha_inicio
                                            AND TZDOCTR_TIPO_PROC = 'CART';

                                Exception
                                    When Others then
                                      vl_existe_bita :=0;
                                End;


                                If vl_existe_bita = 0 then

                                 ------------------------------------------------------dbms_output.put_line('Inserta la bitacora ' ||'*'||vl_existe_bita );

                                             Begin
                                                   Insert into TZDOCTR (
                                                       TZDOCTR_PIDM, TZDOCTR_PROGRAM, TZDOCTR_STST_CODE, TZDOCTR_STYP_CODE, TZDOCTR_CAMP_CODE
                                                     , TZDOCTR_LEVL_CODE, TZDOCTR_TERM_CODE, TZDOCTR_START_DATE, TZDOCTR_PTRM_CODE, TZDOCTR_STUDY_PATH
                                                     , TZDOCTR_NUM_PAGOS, TZDOCTR_RATE_CODE, TZDOCTR_COLEG, TZDOCTR_DESC, TZDOCTR_PPAGO
                                                     , TZDOCTR_PARCI, FECHA_PROCESO, TZDOCTR_IND, TZDOCTR_OBSERVACIONES, TZDOCTR_VENCIMIENTO
                                                     , TZDOCTR_ID, TZDOCTR_TIPO_PROC, TZDOCTR_PERIODOS_CURSADOS,TZDOCTR_DESCUENTO
                                                          )
                                                   VALUES(                      alumno.pidm,
                                                                                alumno.programa,
                                                                                alumno.estatus,
                                                                                alumno.tipo_alumno,
                                                                                alumno.campus,
                                                                                alumno.nivel,
                                                                                alumno.periodo,
                                                                                alumno.fecha_inicio,
                                                                                alumno.parte_periodo,
                                                                                alumno.study_path,
                                                                                alumno.num_pagos,
                                                                                alumno.rate,
                                                                                vl_colegiatura,
                                                                                vl_descuento,
                                                                                vl_plan_pago,
                                                                                vl_parcialidad,
                                                                                sysdate,
                                                                                1,
                                                                                'Cartera creada con exito para el periodo '||alumno.periodo,
                                                                                alumno.vencimiento,
                                                                                alumno.matricula,
                                                                                'CART',
                                                                                0,
                                                                                1);

                                                 UPDATE TZDOCTR SET TZDOCTR_IND = 1,
                                                        TZDOCTR_OBSERVACIONES_1     = 'Cartera creada con exito para el periodo '||alumno.periodo
                                                        --FECHA_PROCESO = trunc(sysdate)
                                                                                               Where TZDOCTR_PIDM = alumno.pidm
                                                                                               And TZDOCTR_PROGRAM = alumno.programa
                                                                                               And TZDOCTR_TERM_CODE =  alumno.periodo
                                                                                               And TZDOCTR_START_DATE = alumno.Fecha_inicio
                                                                                               AND TZDOCTR_TIPO_PROC = 'AUME'
                                                                                               AND TZDOCTR_PERIODOS_CURSADOS=VN_PERIODOS_CURSADOS;
                                            Exception
                                              when others then
                                                vl_error1 :='Error al insertar la bitacora de la cartera' ||sqlerrm;
                                            End;
                                Elsif vl_existe_bita >= 1 then
                                           ------------------------------------------------------dbms_output.put_line('actualiza  la bitacora ' ||'*'||vl_existe_bita );
                                            Begin
                                                    Update TZDOCTR
                                                    set TZDOCTR_IND = 1,
                                                          TZDOCTR_OBSERVACIONES = 'Cartera creada con exito para el periodo '||alumno.periodo,
                                                          FECHA_PROCESO = trunc(sysdate)
                                                    Where TZDOCTR_PIDM = alumno.pidm
                                                    And TZDOCTR_PROGRAM = alumno.programa
                                                    And TZDOCTR_TERM_CODE =  alumno.periodo
                                                    AND TZDOCTR_TIPO_PROC = 'CART';

                                                    --Se actualiza en el aumento
                                                    UPDATE TZDOCTR SET TZDOCTR_IND = 1,
                                                        TZDOCTR_OBSERVACIONES_1     = 'Cartera creada con exito para el periodo '||alumno.periodo
                                                        --FECHA_PROCESO = trunc(sysdate)
                                                                                                    Where TZDOCTR_PIDM = alumno.pidm
                                                                                                    And TZDOCTR_PROGRAM = alumno.programa
                                                                                                    And TZDOCTR_TERM_CODE =  alumno.periodo
                                                                                                    And TZDOCTR_START_DATE = alumno.Fecha_inicio
                                                                                                    AND TZDOCTR_TIPO_PROC = 'AUME'
                                                                                                    AND TZDOCTR_PERIODOS_CURSADOS=VN_PERIODOS_CURSADOS;

                                            Exception
                                              when others then
                                                vl_error1 :='Error al insertar la bitacora de la cartera' ||sqlerrm;
                                            End;



                                End if;

                          ElsIf vl_existe_cart = 0 and vl_existe_desc = 0 and vl_existe_pplan = 0 and vl_existe_parc = 0 and vl_error is not null then  ----> Registra en la Bitacora ya sea exito en la creacion o error

                            ------------------------------------------------------dbms_output.put_line('Validada para insertar bitacora y rollback  ' ||'*'||vl_existe_cart ||'*'||vl_error);

                                    Begin
                                               Select count (1)
                                                Into vl_existe_bita
                                               from TZDOCTR
                                               Where TZDOCTR_PIDM = alumno.pidm
                                                And TZDOCTR_PROGRAM = alumno.programa
                                                And TZDOCTR_TERM_CODE =  alumno.periodo
                                                AND TZDOCTR_TIPO_PROC = 'CART';
                                    Exception
                                        When Others then
                                          vl_existe_bita :=0;
                                    End;

                                    If vl_existe_bita = 0 then
                                        ------------------------------------------------------dbms_output.put_line('Inserta la bitacora rollback ' ||'*'||vl_existe_bita );


                                       If vl_plan_bita = 0 then
                                            Begin
                                                 Insert into TZDOCTR  (
                                                       TZDOCTR_PIDM, TZDOCTR_PROGRAM, TZDOCTR_STST_CODE, TZDOCTR_STYP_CODE, TZDOCTR_CAMP_CODE
                                                     , TZDOCTR_LEVL_CODE, TZDOCTR_TERM_CODE, TZDOCTR_START_DATE, TZDOCTR_PTRM_CODE, TZDOCTR_STUDY_PATH
                                                     , TZDOCTR_NUM_PAGOS, TZDOCTR_RATE_CODE, TZDOCTR_COLEG, TZDOCTR_DESC, TZDOCTR_PPAGO
                                                     , TZDOCTR_PARCI, FECHA_PROCESO, TZDOCTR_IND, TZDOCTR_OBSERVACIONES, TZDOCTR_VENCIMIENTO
                                                     , TZDOCTR_ID, TZDOCTR_TIPO_PROC, TZDOCTR_DESCUENTO
                                                          )
                                                 VALUES (                     alumno.pidm,
                                                                              alumno.programa,
                                                                              alumno.estatus,
                                                                              alumno.tipo_alumno,
                                                                              alumno.campus,
                                                                              alumno.nivel,
                                                                              alumno.periodo,
                                                                              alumno.fecha_inicio,
                                                                              alumno.parte_periodo,
                                                                              alumno.study_path,
                                                                              alumno.num_pagos,
                                                                              alumno.rate,
                                                                              nvl (vl_colegiatura, 0),
                                                                              nvl (vl_descuento, 0),
                                                                              nvl (vl_plan_pago, 0),
                                                                              nvl (vl_parcialidad,0),
                                                                              sysdate,
                                                                              0,
                                                                              vl_error ||' '|| 'para el periodo '||alumno.periodo||
                                                                              case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end,
                                                                              alumno.vencimiento,
                                                                              alumno.matricula,
                                                                              'CART',
                                                                              1);

                                                    --Se actualiza en el aumento
                                                    UPDATE TZDOCTR SET TZDOCTR_IND = 0,
                                                        TZDOCTR_OBSERVACIONES_1     = vl_error ||' '|| 'para el periodo '||alumno.periodo||
                                                                              case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end
                                                        --FECHA_PROCESO = trunc(sysdate)
                                                                                                    Where TZDOCTR_PIDM = alumno.pidm
                                                                                                    And TZDOCTR_PROGRAM = alumno.programa
                                                                                                    And TZDOCTR_TERM_CODE =  alumno.periodo
                                                                                                    And TZDOCTR_START_DATE = alumno.Fecha_inicio
                                                                                                    AND TZDOCTR_TIPO_PROC = 'AUME'
                                                                                                    AND TZDOCTR_PERIODOS_CURSADOS=VN_PERIODOS_CURSADOS;

                                            Exception
                                                when others then
                                                  vl_error1 :='Error al insertar la bitacora de la cartera' ||sqlerrm;
                                            End;

                                       ElsIf vl_plan_bita = 1 then

                                            Begin
                                                 Insert into TZDOCTR  (
                                                       TZDOCTR_PIDM, TZDOCTR_PROGRAM, TZDOCTR_STST_CODE, TZDOCTR_STYP_CODE, TZDOCTR_CAMP_CODE
                                                     , TZDOCTR_LEVL_CODE, TZDOCTR_TERM_CODE, TZDOCTR_START_DATE, TZDOCTR_PTRM_CODE, TZDOCTR_STUDY_PATH
                                                     , TZDOCTR_NUM_PAGOS, TZDOCTR_RATE_CODE, TZDOCTR_COLEG, TZDOCTR_DESC, TZDOCTR_PPAGO
                                                     , TZDOCTR_PARCI, FECHA_PROCESO, TZDOCTR_IND, TZDOCTR_OBSERVACIONES, TZDOCTR_VENCIMIENTO
                                                     , TZDOCTR_ID, TZDOCTR_TIPO_PROC, TZDOCTR_DESCUENTO
                                                          )
                                                 VALUES (                                         alumno.pidm,
                                                                              alumno.programa,
                                                                              alumno.estatus,
                                                                              alumno.tipo_alumno,
                                                                              alumno.campus,
                                                                              alumno.nivel,
                                                                              alumno.periodo,
                                                                              alumno.fecha_inicio,
                                                                              alumno.parte_periodo,
                                                                              alumno.study_path,
                                                                              alumno.num_pagos,
                                                                              alumno.rate,
                                                                              nvl (vl_colegiatura, 0),
                                                                              nvl (vl_descuento, 0),
                                                                              nvl (vl_plan_pago, 0),
                                                                              nvl (vl_parcialidad,0),
                                                                              sysdate,
                                                                              1,
                                                                              vl_error ||' '|| 'para el periodo '||alumno.periodo,
                                                                              alumno.vencimiento,
                                                                              alumno.matricula,
                                                                              'CART',
                                                                              1);

                                                    --Se actualiza en el aumento
                                                    UPDATE TZDOCTR SET TZDOCTR_IND = 0,
                                                        TZDOCTR_OBSERVACIONES_1     = vl_error ||' '|| 'para el periodo '||alumno.periodo||
                                                                              case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end
                                                        --FECHA_PROCESO = trunc(sysdate)
                                                                                                    Where TZDOCTR_PIDM = alumno.pidm
                                                                                                    And TZDOCTR_PROGRAM = alumno.programa
                                                                                                    And TZDOCTR_TERM_CODE =  alumno.periodo
                                                                                                    And TZDOCTR_START_DATE = alumno.Fecha_inicio
                                                                                                    AND TZDOCTR_TIPO_PROC = 'AUME'
                                                                                                    AND TZDOCTR_PERIODOS_CURSADOS=VN_PERIODOS_CURSADOS;

                                            Exception
                                                when others then
                                                  vl_error1 :='Error al insertar la bitacora de la cartera' ||sqlerrm;
                                            End;
                                       End if;

                                    Elsif vl_existe_bita >= 1 then
                                         ------------------------------------------------------dbms_output.put_line('actualiza  la bitacora rollback' ||'*'||vl_existe_bita );
                                            Begin
                                                    Update TZDOCTR
                                                    set TZDOCTR_IND = 0,
                                                          TZDOCTR_OBSERVACIONES = 'Error en la creacion de Cartera para el periodo  '||alumno.periodo ||'  '||vl_error||
                                                                              case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end,
                                                          FECHA_PROCESO = trunc(sysdate)
                                                    Where TZDOCTR_PIDM = alumno.pidm
                                                    And TZDOCTR_PROGRAM = alumno.programa
                                                    And TZDOCTR_TERM_CODE =  alumno.periodo
                                                    AND TZDOCTR_TIPO_PROC = 'CART';

                                                    --Se actualiza en el aumento
                                                    UPDATE TZDOCTR SET TZDOCTR_IND = 0,
                                                        TZDOCTR_OBSERVACIONES_1     =  'Error en la creacion de Cartera para el periodo  '||alumno.periodo ||'  '||vl_error||
                                                                              case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end
                                                        --FECHA_PROCESO = trunc(sysdate)
                                                                                                    Where TZDOCTR_PIDM = alumno.pidm
                                                                                                    And TZDOCTR_PROGRAM = alumno.programa
                                                                                                    And TZDOCTR_TERM_CODE =  alumno.periodo
                                                                                                    And TZDOCTR_START_DATE = alumno.Fecha_inicio
                                                                                                    AND TZDOCTR_TIPO_PROC = 'AUME'
                                                                                                    AND TZDOCTR_PERIODOS_CURSADOS=VN_PERIODOS_CURSADOS;

                                            Exception
                                              when others then
                                                vl_error1 :='Error al insertar la bitacora de la cartera' ||sqlerrm;
                                            End;
                                    End if;

                          ElsIf vl_existe_cart >= 1 or  vl_existe_desc >= 1 or vl_existe_pplan >= 1 or vl_existe_parc >= 1 and vl_error is  null then  ----> Registra en la Bitacora ya sea exito en la creacion o error

                            ------------------------------------------------------dbms_output.put_line('Valida el Insert cuando existe algo de la cartera generada ' ||'*'||vl_existe_cart ||'*'||vl_error);

                                    Begin
                                               Select count (1)
                                                Into vl_existe_bita
                                               from TZDOCTR
                                               Where TZDOCTR_PIDM = alumno.pidm
                                                And TZDOCTR_PROGRAM = alumno.programa
                                                And TZDOCTR_TERM_CODE =  alumno.periodo
                                                AND TZDOCTR_TIPO_PROC = 'CART';
                                    Exception
                                        When Others then
                                          vl_existe_bita :=0;
                                    End;

                                    If vl_existe_bita = 0 then
                                        ------------------------------------------------------dbms_output.put_line('Inserta la bitacora rollback ' ||'*'||vl_existe_bita );
                                            Begin
                                                       Insert into TZDOCTR  (
                                                       TZDOCTR_PIDM, TZDOCTR_PROGRAM, TZDOCTR_STST_CODE, TZDOCTR_STYP_CODE, TZDOCTR_CAMP_CODE
                                                     , TZDOCTR_LEVL_CODE, TZDOCTR_TERM_CODE, TZDOCTR_START_DATE, TZDOCTR_PTRM_CODE, TZDOCTR_STUDY_PATH
                                                     , TZDOCTR_NUM_PAGOS, TZDOCTR_RATE_CODE, TZDOCTR_COLEG, TZDOCTR_DESC, TZDOCTR_PPAGO
                                                     , TZDOCTR_PARCI, FECHA_PROCESO, TZDOCTR_IND, TZDOCTR_OBSERVACIONES, TZDOCTR_VENCIMIENTO
                                                     , TZDOCTR_ID, TZDOCTR_TIPO_PROC, TZDOCTR_DESCUENTO
                                                          )
                                                       VALUES (                     alumno.pidm,
                                                                                    alumno.programa,
                                                                                    alumno.estatus,
                                                                                    alumno.tipo_alumno,
                                                                                    alumno.campus,
                                                                                    alumno.nivel,
                                                                                    alumno.periodo,
                                                                                    alumno.fecha_inicio,
                                                                                    alumno.parte_periodo,
                                                                                    alumno.study_path,
                                                                                    alumno.num_pagos,
                                                                                    alumno.rate,
                                                                                    nvl (vl_colegiatura, 0),
                                                                                    nvl (vl_descuento, 0),
                                                                                    nvl (vl_plan_pago, 0),
                                                                                    nvl (vl_parcialidad,0),
                                                                                    sysdate,
                                                                                    1,
                                                                                    'Ya Existe la Cartera para el periodo  '||alumno.periodo ||' con los siguientes conceptos  Colegiatura = '||vl_existe_cart ||
                                                                                    '  Descuento= '||vl_existe_desc || ' Plan de Pago= '||vl_existe_pplan || ' Parcialidades= ' ||vl_existe_parc||
                                                                              case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end,
                                                                                    alumno.vencimiento,
                                                                                    alumno.matricula,
                                                                                    'CART',
                                                                                    1);

                                                    --Se actualiza en el aumento
                                                    UPDATE TZDOCTR SET TZDOCTR_IND = 1,
                                                        TZDOCTR_OBSERVACIONES_1     = 'Ya Existe la Cartera para el periodo  '||alumno.periodo ||' con los siguientes conceptos  Colegiatura = '||vl_existe_cart ||
                                                                                    '  Descuento= '||vl_existe_desc || ' Plan de Pago= '||vl_existe_pplan || ' Parcialidades= ' ||vl_existe_parc||
                                                                              case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end
                                                        --FECHA_PROCESO = trunc(sysdate)
                                                                                                    Where TZDOCTR_PIDM = alumno.pidm
                                                                                                    And TZDOCTR_PROGRAM = alumno.programa
                                                                                                    And TZDOCTR_TERM_CODE =  alumno.periodo
                                                                                                    And TZDOCTR_START_DATE = alumno.Fecha_inicio
                                                                                                    AND TZDOCTR_TIPO_PROC = 'AUME'
                                                                                                    AND TZDOCTR_PERIODOS_CURSADOS=VN_PERIODOS_CURSADOS;

                                            Exception
                                                when others then
                                                  vl_error1 :='Error al insertar la bitacora de la cartera' ||sqlerrm;
                                            End;
                                    Elsif vl_existe_bita >= 1 then
                                         ------------------------------------------------------dbms_output.put_line('actualiza  la bitacora rollback' ||'*'||vl_existe_bita );
                                            Begin
                                                    Update TZDOCTR
                                                    set TZDOCTR_IND = 1,
                                                          TZDOCTR_OBSERVACIONES = 'Ya Existe la Cartera para el periodo  '||alumno.periodo ||' con los siguientes conceptos  Colegiatura = '||vl_existe_cart ||
                                                                                  '  Descuento= '||vl_existe_desc || ' Plan de Pago= '||vl_existe_pplan || ' Parcialidades= ' ||vl_existe_parc||' Aumento='||vn_porc_increm||
                                                                              case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end,
                                                          FECHA_PROCESO = trunc(sysdate)
                                                    Where TZDOCTR_PIDM = alumno.pidm
                                                    And TZDOCTR_PROGRAM = alumno.programa
                                                    And TZDOCTR_TERM_CODE =  alumno.periodo
                                                    AND TZDOCTR_TIPO_PROC = 'CART';

                                                    --Se actualiza en el aumento
                                                    UPDATE TZDOCTR SET TZDOCTR_IND = 1,
                                                        TZDOCTR_OBSERVACIONES_1     = 'Ya Existe la Cartera para el periodo  '||alumno.periodo ||' con los siguientes conceptos  Colegiatura = '||vl_existe_cart ||
                                                                                                    '  Descuento= '||vl_existe_desc || ' Plan de Pago= '||vl_existe_pplan || ' Parcialidades= ' ||vl_existe_parc||' Aumento='||vn_porc_increm||
                                                                              case vn_no_match when 1 then '. Lo calculado en el incremento, no corresponde a la cartera' end
                                                        --FECHA_PROCESO = trunc(sysdate)
                                                                                                    Where TZDOCTR_PIDM = alumno.pidm
                                                                                                    And TZDOCTR_PROGRAM = alumno.programa
                                                                                                    And TZDOCTR_TERM_CODE =  alumno.periodo
                                                                                                    And TZDOCTR_START_DATE = alumno.Fecha_inicio
                                                                                                    AND TZDOCTR_TIPO_PROC = 'AUME'
                                                                                                    AND TZDOCTR_PERIODOS_CURSADOS=VN_PERIODOS_CURSADOS;

                                            Exception
                                              when others then
                                                vl_error1 :='Error al insertar la bitacora de la cartera' ||sqlerrm;
                                            End;
                                    End if;
                          End if;

                            ------------------------------------------------------dbms_output.put_line('validacion final para salvar' ||'*'|| vl_error||'*'||vl_error1 );

                           --if   vl_error is null and vl_error1 is null and vn_no_match = 0 then
                           if  vl_error1 is null  then
                                 Commit;
                           Elsif vl_error1 is not null then
                                 rollback;
                          End if;


    End Loop;


        Begin

        UPDATE TZDOCTR c
        SET c.TZDOCTR_ID = ( SELECT a.spriden_id
                                        FROM spriden a
                                        where c.TZDOCTR_PIDM = a.spriden_pidm
                                        and spriden_change_ind is null)
        where c.TZDOCTR_ID is null;
        Commit;
        Exception
            when Others then
              null;

        End;

    End if;



END P_GEN_CART_ANT;

FUNCTION F_INSERTA_TBRACCD(
                                                    P_PIDM NUMBER
                                                  , p_secuencia number
                                                  , p_number_paid number
                                                  , P_PERIODO VARCHAR2
                                                  , p_parte_periodo varchar2
                                                  , P_codigo VARCHAR2
                                                  , p_monto number
                                                  , p_balance number
                                                  , p_fecha_venc varchar2
                                                  , p_descrip varchar2
                                                  , p_study_path number
                                                  , p_origen varchar2
                                                  ,p_fecha_inicio varchar2
                                                  ) return varchar2 IS

    vl_error varchar2 (1000);

    VD_FECHA_EFE VARCHAR2(20);
    VL_FOLIO     NUMBER;
    VL_CAMPUS    VARCHAR2(20);
    VL_MONTO     NUMBER(16,2);
    VL_BALANCE   NUMBER(16,2);

BEGIN

      IF P_ORIGEN IN ('TZFEDCA (COL)','TZFEDCA (DSP)','TZFEDCA (PLPA)') THEN
        VD_FECHA_EFE:=ADD_MONTHS(LAST_day (TO_DATE(p_fecha_venc))+1,-1);
      ELSE
        VD_FECHA_EFE:=p_fecha_venc;
      END IF;

      vl_error:=null;
      VL_CAMPUS:=NULL;
      VL_MONTO:= NULL;
      VL_BALANCE:=NULL;


      BEGIN
            SELECT DISTINCT SFRSTCR_VPDI_CODE
            INTO VL_FOLIO
            FROM SFRSTCR
            WHERE SFRSTCR_PIDM = P_PIDM
            AND SFRSTCR_TERM_CODE = P_PERIODO
            AND SFRSTCR_PTRM_CODE = p_parte_periodo
            AND SFRSTCR_RSTS_CODE = 'RE';
      EXCEPTION
      WHEN OTHERS THEN
      VL_FOLIO:=NULL;
      END;

      BEGIN
         SELECT GB_COMMON.F_GET_ID (P_PIDM)
           INTO VL_CAMPUS
           FROM DUAL;
      END;

      IF SUBSTR(VL_CAMPUS,1,2) IN ('40','54') THEN
         VL_MONTO:= NVL(P_MONTO,0);
         VL_BALANCE:= NVL(P_BALANCE,0);
      ELSE
         VL_MONTO:= NVL(ROUND(P_MONTO),0);
         VL_BALANCE:= NVL(ROUND(P_BALANCE),0);

      END IF;

      BEGIN
            Insert into TBRACCD (
              TBRACCD_PIDM
            , TBRACCD_TRAN_NUMBER
            , TBRACCD_TRAN_NUMBER_PAID
            , TBRACCD_TERM_CODE
            , TBRACCD_DETAIL_CODE
            , TBRACCD_USER
            , TBRACCD_ENTRY_DATE
            , TBRACCD_AMOUNT
            , TBRACCD_BALANCE
            , TBRACCD_EFFECTIVE_DATE
            , TBRACCD_FEED_DATE
            , TBRACCD_DESC --No SecPAdre
            , TBRACCD_SRCE_CODE
            , TBRACCD_ACCT_FEED_IND
            , TBRACCD_ACTIVITY_DATE
            , TBRACCD_SESSION_NUMBER
            , TBRACCD_TRANS_DATE
            , TBRACCD_CURR_CODE
            , TBRACCD_DATA_ORIGIN
            , TBRACCD_CREATE_SOURCE
            , TBRACCD_STSP_KEY_SEQUENCE
            , TBRACCD_PERIOD
            , TBRACCD_USER_ID
            , TBRACCD_RECEIPT_NUMBER)
            values (
            p_pidm,   -- TBRACCD_PIDM
            p_secuencia,     --TBRACCD_TRAN_NUMBER
            p_number_paid,
            p_periodo,    -- TBRACCD_TERM_CODE
            p_codigo,     ---TBRACCD_DETAIL_CODE
            user,     ---TBRACCD_USER
            SYSDATE,     --TBRACCD_ENTRY_DATE
            VL_MONTO, -- TBRACCD_AMOUNT
            VL_BALANCE,    ---TBRACCD_BALANCE
            to_date (VD_FECHA_EFE, 'dd/mm/rrrr'),     -- TBRACCD_EFFECTIVE_DATE
            to_date (p_fecha_inicio, 'dd/mm/rrrr'),     -- TBRACCD_FEED_DATE
            p_descrip,    -- TBRACCD_DESC
            'T',    --TBRACCD_SRCE_CODE
            'Y',    --TBRACCD_ACCT_FEED_IND
            sysdate,  --TBRACCD_ACTIVITY_DATE
            0,        --TBRACCD_SESSION_NUMBER
            to_date (VD_FECHA_EFE, 'dd/mm/rrrr'),     -- sysdate,  -- TBRACCD_TRANS_DATE
            'MXN',     -- TBRACCD_CURR_CODE
            p_origen,--'TZFEDCA',     -- TBRACCD_DATA_ORIGIN
            p_origen,   -- TBRACCD_CREATE_SOURCE
            p_study_path,     --TBRACCD_STSP_KEY_SEQUENCE
            p_parte_periodo,     --TBRACCD_PERIOD
            user,     --TBRACCD_USER_ID
            VL_FOLIO
             );
      Exception
          when others then
            vl_error :='Error al insertar la cartera en: '|| p_origen||'; Periodo: '||p_periodo||' . Codigo: '||p_codigo||' Parte Period: '||p_parte_periodo||'. FECHA = '||VD_FECHA_EFE||' = '||sqlerrm||' .';
      End;

      RETURN vl_error;

END;

FUNCTION F_VALIDA_EXIST_CARTERA ( P_PIDM NUMBER
                                                        ,  P_PERIODO VARCHAR2
                                                        , p_parte_periodo varchar2
                                                        , P_NIVEL varchar2
                                                        , P_CAT_CODE varchar2
                                                        , P_DETAIL_CODE varchar2
                                                        , P_STUDY NUMBER
                                                        ) return varchar2 IS

  vl_existe NUMBER;

BEGIN

   IF P_CAT_CODE <> 'COL' THEN
      Begin
                Select count (tbraccd_detail_code)
                   Into vl_existe
                from tbraccd
                Where tbraccd_pidm = P_PIDM--alumno.pidm
                and tbraccd_term_code = P_PERIODO--alumno.periodo
                AND TBRACCD_STSP_KEY_SEQUENCE = P_STUDY
                And tbraccd_detail_code in (select TBBDETC_DETAIL_CODE
                                            from tbbdetc
                                            where TBBDETC_DCAT_CODE = P_CAT_CODE--'DSP'
                                            And substr (TBBDETC_DETAIL_CODE, 1, 2 ) = substr (P_periodo, 1, 2)
                                            and TBBDETC_DETC_ACTIVE_IND = 'Y'
                                             And TBBDETC_DETAIL_CODE = NVL(P_DETAIL_CODE,TBBDETC_DETAIL_CODE)  --'PLPA'
                                            And TBBDETC_TAXT_CODE = P_nivel)
                And (TBRACCD_PERIOD =  P_parte_periodo or TBRACCD_PERIOD is null);
      Exception
      when Others then
          vl_existe:=0;
      End;
   ELSIF P_CAT_CODE = 'COL' THEN
       Begin
                Select count (tbraccd_detail_code)
                   Into vl_existe
                from tbraccd
                Where tbraccd_pidm = P_PIDM
                and tbraccd_term_code = P_PERIODO
                AND TBRACCD_STSP_KEY_SEQUENCE = P_STUDY
                And tbraccd_detail_code in (select TBBDETC_DETAIL_CODE
                                            from tbbdetc
                                            where TBBDETC_DCAT_CODE = 'COL'
                                            And substr (TBBDETC_DETAIL_CODE, 1, 2 )  = substr (P_PERIODO, 1, 2)
                                            And substr (TBBDETC_DETAIL_CODE,1,3) = substr (P_PERIODO, 1, 2)||'N'
                                            and TBBDETC_DETC_ACTIVE_IND = 'Y'
                                            And TBBDETC_TAXT_CODE = P_nivel)
              And (TBRACCD_PERIOD =  P_parte_periodo or TBRACCD_PERIOD is null);
      Exception
      when Others then
          vl_existe:=0;
      End;
   END IF;


      RETURN vl_existe;

END F_VALIDA_EXIST_CARTERA;


FUNCTION F_MAX_SEC_TBRACCD (P_PIDM NUMBER) return number is
  vl_secuencia number;
begin

    Begin
       select nvl (max(TBRACCD_TRAN_NUMBER) , 0)+1
       Into vl_secuencia
       from tbraccd
       Where tbraccd_pidm =  P_PIDM;
    Exception
    When Others then
     vl_secuencia := 1;
    End;
    return vl_secuencia;
end F_MAX_SEC_TBRACCD;

PROCEDURE P_COM IS
BEGIN
  COMMIT;
END P_COM;


Procedure  P_DESAPLICA_PAGOS (p_pidm in number, p_solicitud in number)  IS
---SE MODIFICO EN PKT 5 03- 2018 VR
v_pago number:=0;

vl_existe number;
vl_valida number;
vl_secuencia number;
vl_tipo varchar2(1):= null;



    Begin

                v_pago:=0;
                vl_tipo := null;

                Begin
                    Select distinct TBBDETC_TYPE_IND
                        Into vl_tipo
                    from tbraccd, tbbdetc
                    where TBRACCD_PIDM = p_pidm
                    and TBRACCD_TRAN_NUMBER = p_solicitud
                    and TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE;
                Exception
                    When Others then
                      vl_tipo := null;
                End;

                If vl_tipo = 'P' then
                           For pago in (

                                            select TBRACCD_PIDM, TBRACCD_TRAN_NUMBER, TBRACCD_CROSSREF_NUMBER, TBRAPPL_PAY_TRAN_NUMBER
                                                from tbraccd , tbbdetc, tbrappl
                                               Where TBRACCD_PIDM   = p_pidm
                                               And   TBRACCD_TRAN_NUMBER  =  p_solicitud
                                               --And TBRACCD_DETAIL_CODE in (select ZSTPARA_PARAM_VALOR from zstpara where ZSTPARA_MAPA_ID = 'DESCUENTO')
                                               And TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
                                               And tbraccd_pidm = TBRAPPL_PIDM
                                               And TBRAPPL_PAY_TRAN_NUMBER = TBRACCD_TRAN_NUMBER
                                              And TBRAPPL_REAPPL_IND is null
                                               order by 3 desc

                                               ) loop
                                               v_pago :=1;
                                      For pagoppl in (select TBRAPPL_PIDM, TBRAPPL_PAY_TRAN_NUMBER, TBRAPPL_CHG_TRAN_NUMBER, TBRAPPL_AMOUNT, TBRAPPL_DIRECT_PAY_TYPE
                                                            from tbrappl
                                                            Where TBRAPPL_PIDM = pago.TBRACCD_PIDM
                                                            And TBRAPPL_PAY_TRAN_NUMBER = pago.TBRAPPL_PAY_TRAN_NUMBER
                                                            And TBRAPPL_REAPPL_IND is null )  loop

                                                            gb_common.p_set_context('TB_RECEIVABLE','PROCESS','APPLPMNT-FORCE','N');

                                                           tv_application.p_unapply_by_tran_number( p_pidm               => pagoppl.TBRAPPL_PIDM,
                                                                                                                          p_pay_tran_number    => pagoppl.TBRAPPL_PAY_TRAN_NUMBER,
                                                                                                                          p_unapply_direct_pay => pagoppl.TBRAPPL_DIRECT_PAY_TYPE);

                                      End Loop pagoppl;

                             End Loop pago;

                Elsif  vl_tipo = 'C' then

                           For pago in (

                                            select TBRACCD_PIDM, TBRACCD_TRAN_NUMBER, TBRACCD_CROSSREF_NUMBER, TBRAPPL_CHG_TRAN_NUMBER, TBRAPPL_PAY_TRAN_NUMBER
                                                from tbraccd , tbbdetc, tbrappl
                                               Where TBRACCD_PIDM   = p_pidm
                                               And   TBRACCD_TRAN_NUMBER  =  p_solicitud
                                               --And TBRACCD_DETAIL_CODE in (select ZSTPARA_PARAM_VALOR from zstpara where ZSTPARA_MAPA_ID = 'DESCUENTO')
                                               And TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
                                               And tbraccd_pidm = TBRAPPL_PIDM
                                               And TBRAPPL_CHG_TRAN_NUMBER = TBRACCD_TRAN_NUMBER
                                              And TBRAPPL_REAPPL_IND is null
                                               order by 3 desc

                                               ) loop
                                               v_pago :=1;
                                      For pagoppl in (select TBRAPPL_PIDM, TBRAPPL_CHG_TRAN_NUMBER, TBRAPPL_PAY_TRAN_NUMBER, TBRAPPL_AMOUNT, TBRAPPL_DIRECT_PAY_TYPE
                                                            from tbrappl
                                                            Where TBRAPPL_PIDM = pago.TBRACCD_PIDM
                                                            And TBRAPPL_CHG_TRAN_NUMBER = pago.TBRAPPL_CHG_TRAN_NUMBER
                                                            And TBRAPPL_REAPPL_IND is null )  loop

                                                            gb_common.p_set_context('TB_RECEIVABLE','PROCESS','APPLPMNT-FORCE','N');

                                                           tv_application.p_unapply_by_tran_number( p_pidm               => pagoppl.TBRAPPL_PIDM,
                                                                                                                          p_pay_tran_number    => pagoppl.TBRAPPL_PAY_TRAN_NUMBER,
                                                                                                                          p_unapply_direct_pay => pagoppl.TBRAPPL_DIRECT_PAY_TYPE);

                                      End Loop pagoppl;

                             End Loop pago;
                End if;

    COMMIT;

End P_DESAPLICA_PAGOS;

PROCEDURE leer_file_carga_bajas IS

 cadena VARCHAR2(32767);
 Vfile UTL_FILE.FILE_TYPE;
 iden         varchar2(20);
 --materia    varchar2(20);
 prog         varchar2(200);
 --periodo     varchar2(20);
 nvoestatus   varchar2(5);
 fecha_baja  varchar2(15);
 motivo_baja varchar2(4000);
 --grupo       varchar2(5);
 --calif          varchar2(10);
 --iden_prof  varchar2(10);
 f1             VARCHAR2(10);
 f2             VARCHAR2(10);
 var           number;
 coma        number;
 i               number;
 bimestre   varchar2(1);
--modificación se agraga una nueva columna al archivo para que la baje a la tabla GLOVICX  23.10.2023 proyecto SZFCABA
vrazon     varchar2(200);
vtamano     number:=0;


BEGIN

 -- Abro fichero en lectura (Read)
 Vfile := UTL_FILE.FOPEN('IMAGEN','carga_bajas.csv','R',256);

delete from SZCARBA;
commit;

loop
begin
 -- Leo del fichero
 UTL_FILE.GET_LINE(Vfile,cadena,32767);
 iden:=null;  prog:=null; /*periodo:=null;*/ nvoestatus:=null; fecha_baja:=null; 
 motivo_baja:=null; var:=0; vrazon := null;

vtamano := length(cadena);

--dbms_output.put_line('tamaño de cadena: '|| vtamano);
 for i IN 1..vtamano+1 loop
 vtamano := length(cadena);
  -- dbms_output.put_line('tamaño de cadena2 : '||i||'-'||  vtamano);
  -- dbms_output.put_line('primero: '||substr(cadena,i,1)||' '||var);
 if substr(cadena,i,1)=',' then
    if var=0 then
       iden:=trim(substr(cadena,1,i-1));
       var:=1;
       coma:=i;
    --     dbms_output.put_line(substr(cadena,i,1)||' '||var||'-matricula-'|| iden||'coma-'||coma);
    elsif var=1 then
          prog:=trim(substr(cadena,coma+1,i-(coma+1)));
          prog := substr(prog,1,10);
          var:=2;
          coma:=i;
      --      dbms_output.put_line(substr(cadena,i,1)||' '||var||'-programa-'||prog||' coma-'||coma);
    elsif var=2 then
              nvoestatus:=trim(substr(cadena,coma+1,i-(coma+1)));
              var:=3;
              coma:=i;
        --        dbms_output.put_line(substr(cadena,i,1)||' '||var||'-nvoestatus-'||nvoestatus||'coma-'||coma||'var'|| var);
    elsif var=3 then
          --     dbms_output.put_line('fechas-- '||substr(cadena,i,100)||'-comax-'||coma||' var'|| var );
                   fecha_baja:=trim(substr(cadena,coma+1,i-(coma+1)));

                   -- motivo_baja:=trim(substr(cadena,i+1,4000));
                    var:=4;
                    coma:=i;
            --          dbms_output.put_line(substr(cadena,i,10)||' '||var||' fechbaja-'||fecha_baja||' coma-'||coma||' var'|| var );
    elsif var= 4 then 
         --    dbms_output.put_line('motivossss -- '||substr(cadena,i,100)||'-coma-'||coma||'var'|| var);

                motivo_baja:=trim(substr(cadena,coma+1,i-(coma+1)));
           --         dbms_output.put_line(substr(cadena,i,1)||' '||var||'-motivo-'||motivo_baja||' coma-'||coma||'var'|| var );
                    coma:=i;
                    vrazon:=trim(substr(cadena,i+1,4));
                    var:=5;
             --         dbms_output.put_line(substr(cadena,i,1)||' '||var||'-razon-'||vrazon||' coma-'||coma||'var'|| var);


             -----dbms_output.put_line(substr(cadena,i,8)||' '||var);
    end if;
  else
  --dbms_output.put_line(cadena ||'-coma-'||coma||'var'|| var);
   null;

 end if;

 --dbms_output.put_line('ultimooo:  '||cadena);
 end loop;

dbms_output.put_line('FINAL__matricula: '||iden||'prog: '||prog||' '||' nvoestatus: '||nvoestatus||' fecha_baja: '||fecha_baja||' '||'motivo_baja: '||motivo_baja||'->'|| vrazon||'-tamaño-'||vtamano);

insert into SZCARBA(SZCARBA_ID,
SZCARBA_PROGRAM,
SZCARBA_NVO_ESTATUS,
SZCARBA_FECHA_BAJA,
SZCARBA_MOTIVO_BAJA,
SZCARBA_IND,
SZCARBA_RESULT_PROC,
SZCARBA_USER_ID,
SZCARBA_ACTIVITY_DATE,
SZCARBA_RAZON)
VALUES(iden,prog,nvoestatus,fecha_baja,motivo_baja,NULL,NULL,USER,trunc(SYSDATE), substr(vrazon,1,2));

exception when NO_DATA_FOUND  then
  exit;
end;
end loop;

 -- Cierro fichero
 commit;
 UTL_FILE.FCLOSE(Vfile);

END leer_file_carga_bajas;

FUNCTION sp_aplica_ajuste (p_pidm number,
                                                    p_num_tran number,
                                                    p_detail_code varchar2,
                                                    p_monto number,
                                                    p_term_code varchar2 ,
                                                    p_detalle_desc varchar2,
                                                    p_fecha_venc varchar2,
                                                    p_study number,
                                                    p_fecha_inicio varchar2,
                                                    p_pperiodo varchar2,
                                                    p_user varchar2
                                                    )Return varchar2
 is


p_detail_desc varchar2(100);
p_detail_co varchar2(6);
p_num_tran_MAX NUMBER:=0;
v_moneda      varchar2(5);
vl_error varchar2(2500):='EXITO';
vl_error_inserta varchar(200):=Null;
vl_error_actualiza varchar(200):=Null;
vl_codigo varchar2(1):= null;

vc_fuera_rango NUMBER:=0;

begin
dbms_output.put_line ( ' Aplica descuento  num tran del parametro  ' ||p_num_tran);
--p_detail_desc := 'codigo de descuento' ;

If p_detail_code is null then
   vl_error := 'No existe configuracion de ajuste para este concepto';
Else
    Begin
            Select distinct TBBDETC_TYPE_IND
            into vl_codigo
            from tbbdetc
            where tbbdetc_detail_code = p_detail_code;
    Exception
    when Others then
      vl_codigo :=null;
    End;


 If vl_codigo = 'P' then

  dbms_output.put_line ( ' El concepto es PAGo  ' ||vl_codigo);

        BEGIN
                 UPDATE TVRACCD
                 SET TVRACCD_TRAN_NUMBER_PAID = NULL
                 WHERE TVRACCD_PIDM = P_PIDM
                 AND TVRACCD_TRAN_NUMBER_PAID = P_NUM_TRAN;
        EXCEPTION
          WHEN OTHERS THEN
            VL_ERROR :=' Errror al actualizar saldo Saldo Espejo>>  ' || SQLERRM ;
        END;


        BEGIN
                 UPDATE TBRACCD
                 SET TBRACCD_TRAN_NUMBER_PAID = NULL
                 WHERE TBRACCD_PIDM = P_PIDM
                 AND TBRACCD_TRAN_NUMBER_PAID = P_NUM_TRAN;
        EXCEPTION
        WHEN OTHERS THEN
           VL_ERROR :=' Errror al actualizar saldo Saldo>>  ' || SQLERRM ;
        END;

        BEGIN
                 UPDATE TVRACCD
                 SET TVRACCD_TRAN_NUMBER_PAID = NULL
                 WHERE TVRACCD_PIDM = P_PIDM
                 AND TVRACCD_ACCD_TRAN_NUMBER = P_NUM_TRAN;
        EXCEPTION
          WHEN OTHERS THEN
            VL_ERROR :=' Errror al actualizar saldo Saldo Espejo>>  ' || SQLERRM ;
        END;


        BEGIN
                 UPDATE TBRACCD
                 SET TBRACCD_TRAN_NUMBER_PAID = NULL
                 WHERE TBRACCD_PIDM = P_PIDM
                 AND TBRACCD_TRAN_NUMBER = P_NUM_TRAN;
        EXCEPTION
        WHEN OTHERS THEN
           VL_ERROR :=' Errror al actualizar saldo Saldo>>  ' || SQLERRM ;
        END;

        Begin
                    SELECT nvl(MAX(TBRACCD_TRAN_NUMBER),0)+ 1  N_TRAN
                            INTO p_num_tran_MAX
                    FROM TBRACCD
                    WHERE TBRACCD_PIDM = p_pidm;
        Exception
        When Others then
        vl_error := 'Error al obtener valor maximo' ||sqlerrm;
        End;

        ---------------------VOY A CALCULAR LA MONEDA QUE TIENE EL DESCUENTO --------
        Begin
                SELECT TVRDCTX_CURR_CODE
                INTO v_moneda
                FROM TAISMGR.TVRDCTX
                WHERE TVRDCTX_DETC_CODE  = p_detail_code;
        Exception
        When Others then
        v_moneda  := 'MXN';
        End;


        Begin
            SELECT TBBDETC_DESC
                INTO p_detail_desc
             FROM TAISMGR.TBBDETC
            WHERE TBBDETC_DETAIL_CODE = p_detail_code;
        Exception
        When Others then
        vl_error := 'Error al obtener descripcin del codigo de detalle' ||sqlerrm;
        End;



-- dbms_output.put_line ( ' calcula el maxico del pidm ' || p_num_tran_MAX);

        if p_num_tran_MAX = p_num_tran then
        p_num_tran_MAX := p_num_tran_MAX+1;
        end if;

        Begin

         INSERT INTO TBRACCD
         (TBRACCD_PIDM, TBRACCD_TRAN_NUMBER, TBRACCD_TERM_CODE, TBRACCD_DETAIL_CODE, TBRACCD_USER, TBRACCD_ENTRY_DATE,
         TBRACCD_AMOUNT, TBRACCD_BALANCE,TBRACCD_EFFECTIVE_DATE, TBRACCD_DESC,
         TBRACCD_ACTIVITY_DATE, TBRACCD_TRANS_DATE, TBRACCD_DATA_ORIGIN, TBRACCD_CREATE_SOURCE,
         TBRACCD_SRCE_CODE , TBRACCD_ACCT_FEED_IND, TBRACCD_SESSION_NUMBER, TBRACCD_CURR_CODE,
         TBRACCD_TRAN_NUMBER_PAID,
         TBRACCD_STSP_KEY_SEQUENCE,
         TBRACCD_PERIOD,
         TBRACCD_FEED_DATE
          )
         VALUES
         (p_pidm, p_num_tran_max, p_term_code, p_detail_code, p_user, SYSDATE,
         p_monto, (p_monto)*-1 , to_Date(p_fecha_venc,'dd/mm/rrrr'), p_detail_desc,
         sysdate, to_Date(p_fecha_venc,'dd/mm/rrrr'), 'SIU-V2','AJ',
         'T' , 'Y',0 , v_moneda,
          p_num_tran,
          p_study,
          p_pperiodo,
          to_Date (p_fecha_inicio,'dd/mm/rrrr')
           );

        Exception
        When Others then
            vl_error :=' Errror al Insertar el Ajuste>>  ' || sqlerrm ;
        End;



    --       if vl_error = 'EXITO' then
    --          Begin
    --                   Insert into tbrappl values (
    --                                     p_pidm,               --TBRAPPL_PIDM
    --                                     p_num_tran_max,               --TBRAPPL_PAY_TRAN_NUMBER
    --                                     p_num_tran,               --TBRAPPL_CHG_TRAN_NUMBER
    --                                     p_monto ,              --TBRAPPL_AMOUNT
    --                                     'Y',             --TBRAPPL_DIRECT_PAY_IND
    --                                      null,              --TBRAPPL_REAPPL_IND
    --                                      p_user,              --TBRAPPL_USER
    --                                      'Y',              --TBRAPPL_ACCT_FEED_IND
    --                                      sysdate,              --TBRAPPL_ACTIVITY_DATE
    --                                      null,              --TBRAPPL_FEED_DATE
    --                                      null,              --TBRAPPL_FEED_DOC_CODE
    --                                      null,              --TBRAPPL_CPDT_TRAN_NUMBER
    --                                      'T',              --TBRAPPL_DIRECT_PAY_TYPE
    --                                      null,              --TBRAPPL_INV_NUMBER_PAID
    --                                      null,              --TBRAPPL_SURROGATE_ID
    --                                      null,              --TBRAPPL_VERSION
    --                                      user,              --TBRAPPL_USER_ID
    --                                      'AJ',              --TBRAPPL_DATA_ORIGIN
    --                                      null);              --TBRAPPL_VPDI_CODE
    --          Exception
    --          When Others then
    --            vl_error :=' Errror al Insertar aplicacion de pagos>>  ' || sqlerrm ;
    --          End;
    --      End if;
    --
    --     if  vl_error = 'EXITO' then
    --         Begin
    --                 Update tbraccd
    --                 set tbraccd_balance = 0
    --                 Where tbraccd_pidm = p_pidm
    --                 and TBRACCD_TRAN_NUMBER = p_num_tran_max;
    --         Exception
    --          When Others then
    --            vl_error :=' Errror al actualizar saldo Pago>>  ' || sqlerrm ;
    --         End;
    --
    --         Begin
    --                 Update tbraccd
    --                 set tbraccd_balance = tbraccd_balance - p_monto
    --                 Where tbraccd_pidm = p_pidm
    --                 and TBRACCD_TRAN_NUMBER = p_num_tran;
    --         Exception
    --          When Others then
    --            vl_error :=' Errror al actualizar saldo Saldo>>  ' || sqlerrm ;
    --         End;
    --
    --     End if;
    --
    --    if  vl_error = 'EXITO' then
    --         Begin
    --                 Update tvraccd
    --                 set tvraccd_balance = 0
    --                 Where tvraccd_pidm = p_pidm
    --                 and TVRACCD_ACCD_TRAN_NUMBER = p_num_tran_max;
    --          Exception
    --          When Others then
    --            vl_error :=' Errror al actualizar saldo>>  ' || sqlerrm ;
    --          End;
    --
    --
    --        Begin
    --                 Update tvraccd
    --                 set tvraccd_balance = tvraccd_balance - p_monto
    --                 Where tvraccd_pidm = p_pidm
    --                 and TVRACCD_ACCD_TRAN_NUMBER = p_num_tran;
    --        Exception
    --          When Others then
    --            vl_error :=' Errror al actualizar saldo Saldo Espejo>>  ' || sqlerrm ;
    --        End;
    --
    --
    --
    --    End if;

  Elsif vl_codigo = 'C' then


        Begin
                    SELECT nvl(MAX(TBRACCD_TRAN_NUMBER),0)+ 1  N_TRAN
                            INTO p_num_tran_MAX
                    FROM TBRACCD
                    WHERE TBRACCD_PIDM = p_pidm;
        Exception
        When Others then
        vl_error := 'Error al obtener valor maximo' ||sqlerrm;
        End;

        ---------------------VOY A CALCULAR LA MONEDA QUE TIENE EL DESCUENTO --------
        Begin
                SELECT TVRDCTX_CURR_CODE
                INTO v_moneda
                FROM TAISMGR.TVRDCTX
                WHERE TVRDCTX_DETC_CODE  = p_detail_code;
        Exception
        When Others then
        v_moneda  := 'MXN';
        End;


        Begin
            SELECT TBBDETC_DESC
                INTO p_detail_desc
             FROM TAISMGR.TBBDETC
            WHERE TBBDETC_DETAIL_CODE = p_detail_code;
        Exception
        When Others then
        vl_error := 'Error al obtener descripcin del codigo de detalle' ||sqlerrm;
        End;



-- dbms_output.put_line ( ' calcula el maxico del pidm ' || p_num_tran_MAX);
        if p_num_tran_MAX = p_num_tran then
        p_num_tran_MAX := p_num_tran_MAX+1;
        end if;

        Begin

         INSERT INTO TBRACCD
         (TBRACCD_PIDM, TBRACCD_TRAN_NUMBER, TBRACCD_TERM_CODE, TBRACCD_DETAIL_CODE, TBRACCD_USER, TBRACCD_ENTRY_DATE,
         TBRACCD_AMOUNT, TBRACCD_BALANCE,TBRACCD_EFFECTIVE_DATE, TBRACCD_DESC,
         TBRACCD_ACTIVITY_DATE, TBRACCD_TRANS_DATE, TBRACCD_DATA_ORIGIN, TBRACCD_CREATE_SOURCE,
         TBRACCD_SRCE_CODE , TBRACCD_ACCT_FEED_IND, TBRACCD_SESSION_NUMBER, TBRACCD_CURR_CODE,
         TBRACCD_TRAN_NUMBER_PAID,
         TBRACCD_STSP_KEY_SEQUENCE,
         TBRACCD_PERIOD,
         TBRACCD_FEED_DATE
          )
         VALUES
         (p_pidm, p_num_tran_max, p_term_code, p_detail_code, p_user, SYSDATE,
         p_monto, (p_monto) , to_Date(p_fecha_venc,'dd/mm/rrrr'), p_detail_desc,
         sysdate, to_Date(p_fecha_venc,'dd/mm/rrrr'), 'SIU-V2','AJ',
         'T' , 'Y',0 , v_moneda,
          p_num_tran,
          p_study,
          p_pperiodo,
          to_Date (p_fecha_inicio,'dd/mm/rrrr')
           );

        Exception
        When Others then
            vl_error :=' Errror al Insertar el Ajuste>>  ' || sqlerrm ;
        End;



    --       if vl_error = 'EXITO' then
    --          Begin
    --                   Insert into tbrappl values (
    --                                     p_pidm,               --TBRAPPL_PIDM
    --                                     p_num_tran,               --TBRAPPL_PAY_TRAN_NUMBER
    --                                     p_num_tran_max,               --TBRAPPL_CHG_TRAN_NUMBER
    --                                     p_monto ,              --TBRAPPL_AMOUNT
    --                                     'Y',             --TBRAPPL_DIRECT_PAY_IND
    --                                      null,              --TBRAPPL_REAPPL_IND
    --                                      p_user,              --TBRAPPL_USER
    --                                      'Y',              --TBRAPPL_ACCT_FEED_IND
    --                                      sysdate,              --TBRAPPL_ACTIVITY_DATE
    --                                      null,              --TBRAPPL_FEED_DATE
    --                                      null,              --TBRAPPL_FEED_DOC_CODE
    --                                      null,              --TBRAPPL_CPDT_TRAN_NUMBER
    --                                      'T',              --TBRAPPL_DIRECT_PAY_TYPE
    --                                      null,              --TBRAPPL_INV_NUMBER_PAID
    --                                      null,              --TBRAPPL_SURROGATE_ID
    --                                      null,              --TBRAPPL_VERSION
    --                                      user,              --TBRAPPL_USER_ID
    --                                      'AJ',              --TBRAPPL_DATA_ORIGIN
    --                                      null);              --TBRAPPL_VPDI_CODE
    --          Exception
    --          When Others then
    --            vl_error :=' Errror al Insertar aplicacion de pagos>>  ' || sqlerrm ;
    --          End;
    --
    --      End if;

    --     if  vl_error = 'EXITO' then
    --         Begin
    --                 Update tbraccd
    --                 set tbraccd_balance = 0
    --                 Where tbraccd_pidm = p_pidm
    --                 and TBRACCD_TRAN_NUMBER = p_num_tran_max;
    --         Exception
    --          When Others then
    --            vl_error :=' Errror al actualizar saldo Pago>>  ' || sqlerrm ;
    --         End;
    --
    --         Begin
    --                 Update tbraccd
    --                 set tbraccd_balance = tbraccd_balance + p_monto,
    --                      TBRACCD_TRAN_NUMBER_PAID = p_num_tran_max
    --                 Where tbraccd_pidm = p_pidm
    --                 and TBRACCD_TRAN_NUMBER = p_num_tran;
    --         Exception
    --          When Others then
    --            vl_error :=' Errror al actualizar saldo Saldo>>  ' || sqlerrm ;
    --         End;
    --
    --     End if;
    --

         IF  VL_ERROR = 'EXITO' THEN

            BEGIN
                     UPDATE TVRACCD
                     SET TVRACCD_TRAN_NUMBER_PAID = P_NUM_TRAN_MAX
                     WHERE TVRACCD_PIDM = P_PIDM
                     AND TVRACCD_ACCD_TRAN_NUMBER = P_NUM_TRAN;
            EXCEPTION
              WHEN OTHERS THEN
                VL_ERROR :=' Errror al actualizar saldo Saldo Espejo>>  ' || SQLERRM ;
            END;


            BEGIN
                     UPDATE TBRACCD
                     SET TBRACCD_TRAN_NUMBER_PAID = P_NUM_TRAN_MAX
                     WHERE TBRACCD_PIDM = P_PIDM
                     AND TBRACCD_TRAN_NUMBER = P_NUM_TRAN;
            EXCEPTION
            WHEN OTHERS THEN
               VL_ERROR :=' Errror al actualizar saldo Saldo>>  ' || SQLERRM ;
            END;

        END IF;

  End if;

end if;

dbms_output.put_line('vl_error = '||vl_error);

Return vl_error;


Exception when others then
    vl_error:='Error sp_aplica_descuento '||sqlerrm;
    Return vl_error;
end;



FUNCTION fn_inser_tram (p_matricula in varchar2,p_monto in FLOAT,p_code_detail IN varchar2,p_desc_code IN varchar2,p_effec_date IN varchar2,
                                        p_origin IN varchar2,p_comentario IN varchar2,p_moneda in varchar2,p_solicitud in varchar2,p_programa in varchar2 ) RETURN varchar2

is


    lv_pidm  number:=0;
    lv_camp varchar2(2);
    lv_periodo varchar2(6);
    vl_secuencia number:=0;
    vl_seq_number1 varchar2(70):=null;
    vl_seq_number2 varchar2(70):=null;
    vl_study number:=0;
    vl_error varchar2(250):= NULL;
    V_VALIDA    varchar2(5):= 'FALSO';
    v_desc_code varchar2(30):= NULL;



    BEGIN


        lv_camp:= substr(p_matricula,1,2);
        lv_periodo:= fget_periodo_general(lv_camp,P_EFFEC_DATE);
        lv_pidm :=  fget_pidm (p_matricula);
        vl_seq_number1:= substr(p_comentario,1,60);
        vl_seq_number2:= NVL(substr(p_comentario,61,121),0);

--        dbms_output.put_line('ENTRA '||'/'||vl_seq_number1||'/'||vl_seq_number2);


            BEGIN

               select nvl (max(TBRACCD_TRAN_NUMBER) , 0)+1
               Into vl_secuencia
               from tbraccd
               Where tbraccd_pidm = lv_pidm;

            Exception
            When Others then
            vl_secuencia := 1;
            END;

--            dbms_output.put_line('ENTRA SECUENCIA'||'/'||vl_secuencia);

            BEGIN

                select max(SORLCUR_KEY_SEQNO)
                INTO vl_study
                from sorlcur
                where sorlcur_PIDM = lv_pidm
                AND SORLCUR_LMOD_CODE = 'LEARNER'
                AND SORLCUR_PROGRAM = p_programa;

            Exception
            When Others then
            vl_study := NULL;
            END;

--                 dbms_output.put_line('ENTRA A INSERTAR CARGO'||'/'||vl_secuencia||'/'||vl_study);

            begin

                select TBBDETC_DESC
                into v_desc_code
                from tbbdetc
                where TBBDETC_DETAIL_CODE = p_code_detail;

            Exception
            When Others then
            vl_study := NULL;
            END;


            BEGIN

                INSERT INTO  TBRACCD
                    values (
                             lv_pidm,   -- TBRACCD_PIDM
                             vl_secuencia,     --TBRACCD_TRAN_NUMBER
                             lv_periodo,    -- TBRACCD_TERM_CODE
                             p_code_detail,     ---TBRACCD_DETAIL_CODE
                             p_origin,     ---TBRACCD_USER
                             SYSDATE,     --TBRACCD_ENTRY_DATE
                             p_monto,
                             p_monto,    ---TBRACCD_BALANCE
                             to_date(p_effec_date, 'dd/mm/rrrr'),     -- TBRACCD_EFFECTIVE_DATE
                             NULL,    --TBRACCD_BILL_DATE
                             NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                            v_desc_code,    -- TBRACCD_DESC
                            null,     --TBRACCD_RECEIPT_NUMBER
                            NULL,     --TBRACCD_TRAN_NUMBER_PAID
                            NULL,     --TBRACCD_CROSSREF_PIDM
                            NULL,    --TBRACCD_CROSSREF_NUMBER
                            null,       --TBRACCD_CROSSREF_DETAIL_CODE
                              'T',    --TBRACCD_SRCE_CODE
                             'Y',    --TBRACCD_ACCT_FEED_IND
                             sysdate,  --TBRACCD_ACTIVITY_DATE
                             0,        --TBRACCD_SESSION_NUMBER
                             null,    -- TBRACCD_CSHR_END_DATE
                             NULL,     --TBRACCD_CRN
                             NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                             NULL,     -- TBRACCD_LOC_MDT
                             NULL,     --TBRACCD_LOC_MDT_SEQ
                             null,     -- TBRACCD_RATE
                             NULL,     --TBRACCD_UNITS
                             p_solicitud,     -- TBRACCD_DOCUMENT_NUMBER
                             to_date(p_effec_date, 'dd/mm/rrrr'),  -- TBRACCD_TRANS_DATE
                             NULL,        -- TBRACCD_PAYMENT_ID
                             NULL,     -- TBRACCD_INVOICE_NUMBER
                             NULL,     -- TBRACCD_STATEMENT_DATE
                             NULL,     -- TBRACCD_INV_NUMBER_PAID
                             p_moneda,     -- TBRACCD_CURR_CODE
                             null,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                             NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                            NULL,     -- TBRACCD_LATE_DCAT_CODE
                            NULL,     -- TBRACCD_FEED_DATE
                            NULL,     -- TBRACCD_FEED_DOC_CODE
                            NULL,     -- TBRACCD_ATYP_CODE
                            NULL,     -- TBRACCD_ATYP_SEQNO
                            NULL,     -- TBRACCD_CARD_TYPE_VR
                            NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                            NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                            NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                            NULL,     -- TBRACCD_ORIG_CHG_IND
                            NULL,     -- TBRACCD_CCRD_CODE
                            NULL,     -- TBRACCD_MERCHANT_ID
                            NULL,     -- TBRACCD_TAX_REPT_YEAR
                            NULL,     -- TBRACCD_TAX_REPT_BOX
                            NULL,     -- TBRACCD_TAX_AMOUNT
                            NULL,     -- TBRACCD_TAX_FUTURE_IND
                            'Banner',     -- TBRACCD_DATA_ORIGIN
                            'AUTOM',   -- TBRACCD_CREATE_SOURCE
                            null,     -- TBRACCD_CPDT_IND
                            NULL,     --TBRACCD_AIDY_CODE
                            vl_study,     --TBRACCD_STSP_KEY_SEQUENCE
                            NULL,     --TBRACCD_PERIOD
                            NULL,    --TBRACCD_SURROGATE_ID
                            NULL,     -- TBRACCD_VERSION
                            p_origin,     --TBRACCD_USER_ID
                            NULL );     --TBRACCD_VPDI_CODE

            Exception
            When Others then
            vl_error:='Error al insertar TBRACCD'||'/'||p_desc_code||'/'||sqlerrm;
            End;


--            dbms_output.put_line('INSERTA TBRACCD'||'/'||vl_error);

            BEGIN

                    if vl_seq_number1 is not null and vl_seq_number2 = 0 THEN

                             begin
                                Insert into TBRACDT
                                     Values
                                           (lv_pidm,--tbracdt_pidm
                                            vl_secuencia,--tbracdt_tran_number
                                            1,--tbracdt_seq_number
                                            vl_seq_number1,--tbracdt_text
                                            'Y', --tbracdt_print_ind
                                            SYSDATE, ---tbracdt_activity_date
                                            NULL,--TBRACDT_SURROGATE_ID
                                            NULL,--TBRACDT_VERSION
                                            p_origin, --tbracdt_user_id
                                            'MANUAL',--TBRACDT_DATA_ORIGIN
                                            NULL);---TBRACDT_VPDI_CODE

                            Exception
                            when Others then
                            vl_error:='Se presento el Error insertar TBRACDT 1:= '||'2';
                            End;

--                                            dbms_output.put_line('INSERTA 1'||'/'||vl_seq_number1||'/'||vl_seq_number2);

                    ELSIF vl_seq_number1 is not null and vl_seq_number2 <>0 THEN

                             begin
                                Insert into TBRACDT
                                     Values
                                           (lv_pidm,--tbracdt_pidm
                                            vl_secuencia,--tbracdt_tran_number
                                            1,--tbracdt_seq_number
                                            vl_seq_number1,--tbracdt_text
                                            'Y', --tbracdt_print_ind
                                            SYSDATE, ---tbracdt_activity_date
                                            NULL,--TBRACDT_SURROGATE_ID
                                            NULL,--TBRACDT_VERSION
                                            p_origin, --tbracdt_user_id
                                            'MANUAL',--TBRACDT_DATA_ORIGIN
                                            NULL);---TBRACDT_VPDI_CODE

                            Exception
                            when Others then
                            vl_error:='Se presento el Error insertar TBRACDT 2:= '||'3';
                            End;

                           begin
                                Insert into TBRACDT
                                     Values
                                           (lv_pidm,--tbracdt_pidm
                                            vl_secuencia,--tbracdt_tran_number
                                            2,--tbracdt_seq_number
                                            vl_seq_number2,--tbracdt_text
                                            'Y', --tbracdt_print_ind
                                            SYSDATE, ---tbracdt_activity_date
                                            NULL,--TBRACDT_SURROGATE_ID
                                            NULL,--TBRACDT_VERSION
                                            p_origin, --tbracdt_user_id
                                            'MANUAL',--TBRACDT_DATA_ORIGIN
                                            NULL);---TBRACDT_VPDI_CODE

--                                            dbms_output.put_line('INSERTA 2'||'/'||vl_seq_number1||'/'||vl_seq_number2);
                           Exception
                           when Others then
                           vl_error:='Se presento el Error insertar TBRACDT 3:= '||'4';
                           End;

                    END IF;

            Exception
            when Others then
            vl_error:='Se presento el Error insertar TBRACCD:= '||'5';
            End;

            V_VALIDA := 'EXITO';

--           dbms_output.put_line('INSERTA TBRACDT'||'/'||vl_error);

        COMMIT;


      IF V_VALIDA = 'EXITO'  THEN
      RETURN(V_VALIDA);
      ELSE
      vl_error := 'Se presento el Error 1'||'/'||vl_error;
      RETURN(vl_error);
      END IF;

   Exception
    when Others then
    vl_error:='Se presento el Error 2'||sqlerrm;
    Return vl_error;

   END fn_inser_tram;


FUNCTION f_ajuste_40 (pn_pidm in number) return Varchar2

as

vl_exis_contra varchar2(6) := null;
vl_secuencia number:=0;
vl_cod_contra varchar2(6) := null;
vl_desc_contra varchar2(50) :=null;
vl_numpag number:=0;
vl_monto_pagado varchar2(50) :=null;
vl_codigo_aj varchar2(6) :=null;
vl_exis_ajust varchar2(6) :=null;
vl_error varchar2(500) :='EXITO';
V_VALIDA    varchar2(5):= 'FALSO';

    BEGIN


           For alumno in (

                                    SELECT a.TBRACCD_TRAN_NUMBER trans,
                                                b.SPRIDEN_ID,
                                                a.TBRACCD_PIDM,
                                                a.TBRACCD_TRAN_NUMBER_PAID paga,
                                                a.TBRACCD_TERM_CODE,
                                                a.TBRACCD_DETAIL_CODE Codigo_detalle,
                                                a.TBRACCD_DESC,
                                                a.TBRACCD_AMOUNT,
                                                a.TBRACCD_BALANCE,
                                                c.TBBDETC_TYPE_IND tipo,
                                                a.TBRACCD_DOCUMENT_NUMBER
                                    FROM TBRACCD a,SPRIDEN b,TBBDETC c
                                    WHERE a.TBRACCD_PIDM = b.SPRIDEN_PIDM
                                    AND b.SPRIDEN_CHANGE_IND IS NULL
                                    AND c.TBBDETC_DETAIL_CODE = a.TBRACCD_DETAIL_CODE
                                    AND SUBSTR (a.TBRACCD_DETAIL_CODE ,3,4 ) IN (SELECT(ZSTPARA_PARAM_ID)
                                                                                                              FROM ZSTPARA
                                                                                                               WHERE ZSTPARA_MAPA_ID = 'CANC_DEC40')
                                   AND a.TBRACCD_TERM_CODE IN (SELECT MAX (a1.TBRACCD_TERM_CODE)
                                                                                 FROM TBRACCD a1
                                                                                 WHERE a1.TBRACCD_pidm = pn_pidm)
                                    AND a.TBRACCD_PIDM = pn_pidm
                                    AND a.TBRACCD_AMOUNT > 0
                                    --AND TBRACCD_TRAN_NUMBER = 18
                                    AND a.TBRACCD_DOCUMENT_NUMBER IS NULL
                                    ORDER BY 3,4


                ) loop


                            begin

                                    SELECT ZSTPARA_PARAM_VALOR
                                    INTO vl_exis_contra
                                    FROM ZSTPARA
                                    WHERE ZSTPARA_PARAM_ID = SUBSTR (alumno.Codigo_detalle,3,4 )
                                    AND ZSTPARA_MAPA_ID = 'CANC_DEC40';

                            Exception
                            when Others then
                            vl_exis_contra := 0;
                            End;

                      --      dbms_output.put_line('vl_exis_contra'||'/'||vl_exis_contra||'/'||alumno.trans);

                             begin

                                    if alumno.tipo = 'C' THEN

                                            SELECT TBRAPPL_PAY_TRAN_NUMBER
                                            INTO vl_numpag
                                            from TBRAPPL
                                            WHERE tbrappl_pidm = pn_pidm
                                            and TBRAPPL_CHG_TRAN_NUMBER =  alumno.trans;

                                    elsif alumno.tipo = 'P' THEN

                                            SELECT TBRAPPL_CHG_TRAN_NUMBER
                                            INTO vl_numpag
                                            from tbrappl
                                            WHERE tbrappl_pidm = pn_pidm
                                            and TBRAPPL_PAY_TRAN_NUMBER =  alumno.trans;


                                    end if;

                            Exception
                            when Others then
                            vl_numpag := 0;
                            end;

                        --    dbms_output.put_line('vl_numpag'||'/'||vl_numpag||'/'||vl_exis_contra);

                           begin

                                    select tbraccd_amount,tbraccd_detail_code
                                    into vl_monto_pagado,vl_codigo_aj
                                    from tbraccd
                                    where tbraccd_pidm = pn_pidm
                                    and tbraccd_tran_number = vl_numpag;


                           Exception
                            when Others then
                            vl_monto_pagado :=0;
                           End;

                         --   dbms_output.put_line(vl_monto_pagado||'/'||vl_codigo_aj||'/'||vl_exis_contra);

                            begin

                                    SELECT TBRACCD_DETAIL_CODE
                                    INTO vl_exis_ajust
                                    FROM TBRACCD
                                    WHERE TBRACCD_PIDM = pn_pidm
                                    AND SUBSTR (TBRACCD_DETAIL_CODE,3,4) IN (SELECT(ZSTPARA_PARAM_VALOR)
                                                                                                          FROM ZSTPARA
                                                                                                          WHERE ZSTPARA_PARAM_VALOR = SUBSTR (vl_codigo_aj,3,4 )
                                                                                                           AND ZSTPARA_MAPA_ID = 'CANC_DEC40');

                            Exception
                            when Others then
                            vl_exis_ajust := null;
                            End;


                    --       dbms_output.put_line(SUBSTR(alumno.SPRIDEN_ID,1,2)||'/'||vl_exis_ajust||'/'||vl_exis_contra);

                            begin

                                   IF vl_exis_ajust IS NOT NULL THEN

                                            UPDATE TBRACCD
                                            SET TBRACCD_DOCUMENT_NUMBER = 'DEC40'
                                            WHERE TBRACCD_PIDM = alumno.TBRACCD_PIDM
                                            AND TBRACCD_TRAN_NUMBER =  alumno.trans;

                                      --    dbms_output.put_line(vl_exis_ajust);

                                   ELSIF vl_monto_pagado <0 THEN

                                            UPDATE TBRACCD
                                            SET TBRACCD_DOCUMENT_NUMBER = 'DEC40'
                                            WHERE TBRACCD_PIDM = alumno.TBRACCD_PIDM
                                            AND TBRACCD_TRAN_NUMBER =  alumno.trans;

                                     --   dbms_output.put_line(vl_monto_pagado);


                                   END IF;

                            Exception
                            when Others then
                            vl_exis_ajust := null;
                            vl_monto_pagado := null;
                             end;

                    --        dbms_output.put_line('INCERTA CONTRA PARTE'||'/'||vl_exis_contra);



                            If vl_exis_contra is not null AND vl_monto_pagado >= 0 AND vl_exis_ajust IS NULL THEN

                                PKG_FINANZAS.P_DESAPLICA_PAGOS (alumno.TBRACCD_PIDM, alumno.trans);
                       --     dbms_output.put_line('INSERTA CONTRA PARTE'||'/'||vl_exis_contra||'/'||vl_monto_pagado);

                                             Begin

                                                   select nvl (max(TBRACCD_TRAN_NUMBER) , 0)+1
                                                   Into vl_secuencia
                                                   from tbraccd
                                                   Where tbraccd_pidm =  alumno.tbraccd_pidm;

                                             Exception
                                             When Others then
                                             vl_secuencia := 1;
                                             End;

                        --    dbms_output.put_line('Secuencia '||vl_secuencia);


                                             Begin

                                                    select TBBDETC_DETAIL_CODE, TBBDETC_DESC
                                                    Into vl_cod_contra, vl_desc_contra
                                                    from tbbdetc
                                                    where substr(TBBDETC_DETAIL_CODE,1,2) = substr(alumno.spriden_id,1,2)
                                                    And substr (TBBDETC_DETAIL_CODE,3,4) = vl_exis_contra;
                                                    --and TBBDETC_DETC_ACTIVE_IND = 'Y';
                                                    --and TBBDETC_PAYT_CODE = 'T';

                                             Exception
                                             When Others then
                                                 vl_cod_contra:= null;
                                                 vl_desc_contra := null;
                                             End;

                          --  dbms_output.put_line(vl_cod_contra||'/'||vl_desc_contra||'/'||vl_exis_contra);

                                            Begin

                                                If alumno.tipo = 'C' THEN

                                                           Insert into TBRACCD values (
                                                                     alumno.TBRACCD_PIDM,   -- TBRACCD_PIDM
                                                                     vl_secuencia,     --TBRACCD_TRAN_NUMBER
                                                                     alumno.TBRACCD_TERM_CODE,    -- TBRACCD_TERM_CODE
                                                                     vl_cod_contra,     ---TBRACCD_DETAIL_CODE
                                                                     user,     ---TBRACCD_USER
                                                                     SYSDATE,     --TBRACCD_ENTRY_DATE
                                                                     alumno.TBRACCD_AMOUNT,
                                                                     (alumno.TBRACCD_AMOUNT)*-1,    ---TBRACCD_BALANCE
                                                                     sysdate,     -- TBRACCD_EFFECTIVE_DATE
                                                                     NULL,    --TBRACCD_BILL_DATE
                                                                     NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                                                                    vl_desc_contra,    -- TBRACCD_DESC
                                                                    null,     --TBRACCD_RECEIPT_NUMBER
                                                                    alumno.trans,     --TBRACCD_TRAN_NUMBER_PAID
                                                                    NULL,     --TBRACCD_CROSSREF_PIDM
                                                                    NULL,    --TBRACCD_CROSSREF_NUMBER
                                                                    null,       --TBRACCD_CROSSREF_DETAIL_CODE
                                                                      'T',    --TBRACCD_SRCE_CODE
                                                                     'Y',    --TBRACCD_ACCT_FEED_IND
                                                                     sysdate,  --TBRACCD_ACTIVITY_DATE
                                                                     0,        --TBRACCD_SESSION_NUMBER
                                                                     null,    -- TBRACCD_CSHR_END_DATE
                                                                     NULL,     --TBRACCD_CRN
                                                                     NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                                                                     NULL,     -- TBRACCD_LOC_MDT
                                                                     NULL,     --TBRACCD_LOC_MDT_SEQ
                                                                     null,     -- TBRACCD_RATE
                                                                     NULL,     --TBRACCD_UNITS
                                                                     'DEC40',     -- TBRACCD_DOCUMENT_NUMBER
                                                                     sysdate,  -- TBRACCD_TRANS_DATE
                                                                     NULL,        -- TBRACCD_PAYMENT_ID
                                                                     NULL,     -- TBRACCD_INVOICE_NUMBER
                                                                     NULL,     -- TBRACCD_STATEMENT_DATE
                                                                     NULL,     -- TBRACCD_INV_NUMBER_PAID
                                                                     'MXN',     -- TBRACCD_CURR_CODE
                                                                     null,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                                                                     NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                                                                    NULL,     -- TBRACCD_LATE_DCAT_CODE
                                                                    NULL,     -- TBRACCD_FEED_DATE
                                                                    NULL,     -- TBRACCD_FEED_DOC_CODE
                                                                    NULL,     -- TBRACCD_ATYP_CODE
                                                                    NULL,     -- TBRACCD_ATYP_SEQNO
                                                                    NULL,     -- TBRACCD_CARD_TYPE_VR
                                                                    NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                                                                    NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                                                                    NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                                                                    NULL,     -- TBRACCD_ORIG_CHG_IND
                                                                    NULL,     -- TBRACCD_CCRD_CODE
                                                                    NULL,     -- TBRACCD_MERCHANT_ID
                                                                    NULL,     -- TBRACCD_TAX_REPT_YEAR
                                                                    NULL,     -- TBRACCD_TAX_REPT_BOX
                                                                    NULL,     -- TBRACCD_TAX_AMOUNT
                                                                    NULL,     -- TBRACCD_TAX_FUTURE_IND
                                                                    'Banner',     -- TBRACCD_DATA_ORIGIN
                                                                    'AUTOM',   -- TBRACCD_CREATE_SOURCE
                                                                    null,     -- TBRACCD_CPDT_IND
                                                                    NULL,     --TBRACCD_AIDY_CODE
                                                                    NULL,     --TBRACCD_STSP_KEY_SEQUENCE
                                                                    NULL,     --TBRACCD_PERIOD
                                                                    NULL,    --TBRACCD_SURROGATE_ID
                                                                    NULL,     -- TBRACCD_VERSION
                                                                    user,     --TBRACCD_USER_ID
                                                                    NULL );     --TBRACCD_VPDI_CODE

                                                                              Begin
                                                                                       Insert into tbrappl values (
                                                                                                         pn_pidm,               --TBRAPPL_PIDM
                                                                                                         vl_secuencia,               --TBRAPPL_PAY_TRAN_NUMBER
                                                                                                         alumno.trans,               --TBRAPPL_CHG_TRAN_NUMBER
                                                                                                         alumno.TBRACCD_AMOUNT ,              --TBRAPPL_AMOUNT
                                                                                                         null,             --TBRAPPL_DIRECT_PAY_IND
                                                                                                          null,              --TBRAPPL_REAPPL_IND
                                                                                                          user,              --TBRAPPL_USER
                                                                                                          'Y',              --TBRAPPL_ACCT_FEED_IND
                                                                                                          sysdate,              --TBRAPPL_ACTIVITY_DATE
                                                                                                          null,              --TBRAPPL_FEED_DATE
                                                                                                          'Y',              --TBRAPPL_FEED_DOC_CODE
                                                                                                          null,              --TBRAPPL_CPDT_TRAN_NUMBER
                                                                                                          null,              --TBRAPPL_DIRECT_PAY_TYPE
                                                                                                          null,              --TBRAPPL_INV_NUMBER_PAID
                                                                                                          null,              --TBRAPPL_SURROGATE_ID
                                                                                                          null,              --TBRAPPL_VERSION
                                                                                                          user,              --TBRAPPL_USER_ID
                                                                                                          'AJ',              --TBRAPPL_DATA_ORIGIN
                                                                                                          null);              --TBRAPPL_VPDI_CODE
                                                                              Exception
                                                                              When Others then
                                                                                vl_secuencia :=' Errror al Insertar aplicacion de pagos 1  ' || sqlerrm ;
                                                                              End;

                                                                            --  dbms_output.put_line('1'||'/'||vl_error);

                                                ELSIf alumno.tipo = 'P' THEN

                                                           Insert into TBRACCD values (
                                                                     alumno.TBRACCD_PIDM,   -- TBRACCD_PIDM
                                                                     vl_secuencia,     --TBRACCD_TRAN_NUMBER
                                                                     alumno.TBRACCD_TERM_CODE,    -- TBRACCD_TERM_CODE
                                                                     vl_cod_contra,     ---TBRACCD_DETAIL_CODE
                                                                     user,     ---TBRACCD_USER
                                                                     SYSDATE,     --TBRACCD_ENTRY_DATE
                                                                     alumno.TBRACCD_AMOUNT,
                                                                     alumno.TBRACCD_AMOUNT,    ---TBRACCD_BALANCE
                                                                     sysdate,     -- TBRACCD_EFFECTIVE_DATE
                                                                     NULL,    --TBRACCD_BILL_DATE
                                                                     NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                                                                    vl_desc_contra,    -- TBRACCD_DESC
                                                                    null,     --TBRACCD_RECEIPT_NUMBER
                                                                    NULL,     --TBRACCD_TRAN_NUMBER_PAID
                                                                    NULL,     --TBRACCD_CROSSREF_PIDM
                                                                    NULL,    --TBRACCD_CROSSREF_NUMBER
                                                                    null,       --TBRACCD_CROSSREF_DETAIL_CODE
                                                                      'T',    --TBRACCD_SRCE_CODE
                                                                     'Y',    --TBRACCD_ACCT_FEED_IND
                                                                     sysdate,  --TBRACCD_ACTIVITY_DATE
                                                                     0,        --TBRACCD_SESSION_NUMBER
                                                                     null,    -- TBRACCD_CSHR_END_DATE
                                                                     NULL,     --TBRACCD_CRN
                                                                     NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                                                                     NULL,     -- TBRACCD_LOC_MDT
                                                                     NULL,     --TBRACCD_LOC_MDT_SEQ
                                                                     null,     -- TBRACCD_RATE
                                                                     NULL,     --TBRACCD_UNITS
                                                                     'DEC40',     -- TBRACCD_DOCUMENT_NUMBER
                                                                     sysdate,  -- TBRACCD_TRANS_DATE
                                                                     NULL,        -- TBRACCD_PAYMENT_ID
                                                                     NULL,     -- TBRACCD_INVOICE_NUMBER
                                                                     NULL,     -- TBRACCD_STATEMENT_DATE
                                                                     NULL,     -- TBRACCD_INV_NUMBER_PAID
                                                                     'MXN',     -- TBRACCD_CURR_CODE
                                                                     null,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                                                                     NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                                                                    NULL,     -- TBRACCD_LATE_DCAT_CODE
                                                                    NULL,     -- TBRACCD_FEED_DATE
                                                                    NULL,     -- TBRACCD_FEED_DOC_CODE
                                                                    NULL,     -- TBRACCD_ATYP_CODE
                                                                    NULL,     -- TBRACCD_ATYP_SEQNO
                                                                    NULL,     -- TBRACCD_CARD_TYPE_VR
                                                                    NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                                                                    NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                                                                    NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                                                                    NULL,     -- TBRACCD_ORIG_CHG_IND
                                                                    NULL,     -- TBRACCD_CCRD_CODE
                                                                    NULL,     -- TBRACCD_MERCHANT_ID
                                                                    NULL,     -- TBRACCD_TAX_REPT_YEAR
                                                                    NULL,     -- TBRACCD_TAX_REPT_BOX
                                                                    NULL,     -- TBRACCD_TAX_AMOUNT
                                                                    NULL,     -- TBRACCD_TAX_FUTURE_IND
                                                                    'Banner',     -- TBRACCD_DATA_ORIGIN
                                                                    'AUTOM',   -- TBRACCD_CREATE_SOURCE
                                                                    null,     -- TBRACCD_CPDT_IND
                                                                    NULL,     --TBRACCD_AIDY_CODE
                                                                    NULL,     --TBRACCD_STSP_KEY_SEQUENCE
                                                                    NULL,     --TBRACCD_PERIOD
                                                                    NULL,    --TBRACCD_SURROGATE_ID
                                                                    NULL,     -- TBRACCD_VERSION
                                                                    user,     --TBRACCD_USER_ID
                                                                    NULL );     --TBRACCD_VPDI_CODE

                                                       -- dbms_output.put_line('Termina contra parte CARGO');

                                                                              Begin
                                                                                       Insert into tbrappl values (
                                                                                                         pn_pidm,               --TBRAPPL_PIDM
                                                                                                         alumno.trans,               --TBRAPPL_PAY_TRAN_NUMBER
                                                                                                         vl_secuencia,               --TBRAPPL_CHG_TRAN_NUMBER
                                                                                                         alumno.TBRACCD_AMOUNT ,              --TBRAPPL_AMOUNT
                                                                                                         null,             --TBRAPPL_DIRECT_PAY_IND
                                                                                                          null,              --TBRAPPL_REAPPL_IND
                                                                                                          user,              --TBRAPPL_USER
                                                                                                          'Y',              --TBRAPPL_ACCT_FEED_IND
                                                                                                          sysdate,              --TBRAPPL_ACTIVITY_DATE
                                                                                                          null,              --TBRAPPL_FEED_DATE
                                                                                                          'Y',              --TBRAPPL_FEED_DOC_CODE
                                                                                                          null,              --TBRAPPL_CPDT_TRAN_NUMBER
                                                                                                          null,              --TBRAPPL_DIRECT_PAY_TYPE
                                                                                                          null,              --TBRAPPL_INV_NUMBER_PAID
                                                                                                          null,              --TBRAPPL_SURROGATE_ID
                                                                                                          null,              --TBRAPPL_VERSION
                                                                                                          user,              --TBRAPPL_USER_ID
                                                                                                          'AJ',              --TBRAPPL_DATA_ORIGIN
                                                                                                          null);              --TBRAPPL_VPDI_CODE
                                                                              Exception
                                                                              When Others then
                                                                                vl_secuencia :=' Errror al Insertar aplicacion de pagos>>  ' || sqlerrm ;
                                                                              End;

                                                                               -- dbms_output.put_line('1'||'/'||vl_error);

                                                end if;

                                            Exception
                                            When Others then
                                            vl_cod_contra := null;
                                            end;

                                            if  vl_exis_contra is not null AND vl_monto_pagado >= 0 AND vl_exis_ajust IS NULL THEN
                                                     Begin
                                                             Update tbraccd
                                                             set tbraccd_balance = 0
                                                             Where tbraccd_pidm = pn_pidm
                                                             and TBRACCD_TRAN_NUMBER = alumno.trans;
                                                     Exception
                                                      When Others then
                                                        vl_error :=' Errror al actualizar saldo Pago>>  ' || sqlerrm ;
                                                     End;

                                                     Begin
                                                             Update tbraccd
                                                             set tbraccd_balance = 0
                                                             Where tbraccd_pidm = pn_pidm
                                                             and TBRACCD_TRAN_NUMBER = vl_secuencia;
                                                     Exception
                                                      When Others then
                                                        vl_error :=' Errror al actualizar saldo Saldo>>  ' || sqlerrm ;
                                                     End;

                                            End if;



                                            begin

                                                    if alumno.tipo = 'C' THEN

                                                            UPDATE TBRACCD
                                                            SET TBRACCD_DOCUMENT_NUMBER = 'DEC40'
                                                            WHERE TBRACCD_PIDM = alumno.TBRACCD_PIDM
                                                            AND TBRACCD_TRAN_NUMBER =  alumno.trans;

                                                    elsif alumno.tipo = 'P' THEN

                                                            UPDATE TBRACCD
                                                            SET TBRACCD_DOCUMENT_NUMBER = 'DEC40',
                                                                   TBRACCD_TRAN_NUMBER_PAID =  vl_secuencia
                                                            WHERE TBRACCD_PIDM = alumno.TBRACCD_PIDM
                                                            AND TBRACCD_TRAN_NUMBER =  alumno.trans;

                                                    end if;

                                             Exception
                                             When Others then
                                              alumno.trans:= null;
                                            end;

                                       --     dbms_output.put_line('Termina AJUSTES');


                             end if;

                  V_VALIDA := 'TRUE';

                end loop;

        COMMIT;
        IF V_VALIDA = 'TRUE'  THEN
      RETURN(vl_error);
      ELSE
      vl_error := 'Pidm No Existe' ;
      RETURN(vl_error);
      END IF;

   exception when others then

   vl_error:='Error general en f_ajuste_40'||sqlerrm;
      RETURN(vl_error);

   END;




PROCEDURE P_DISMINU_CUPON (P_CAMPUS in VARCHAR2,P_NIVEL in VARCHAR2,P_FECHA_INI in VARCHAR2) IS

vl_desc_final varchar2(10);
vl_desc_actual varchar2(10);
vl_entra number;
VL_TIPO VARCHAR2(2);
--vl_valida varchar2(20);

   BEGIN

    DELETE FROM SZTDICUP
    WHERE SZTDICUP_CAMPUS = P_CAMPUS
    AND SZTDICUP_NIVEL = P_NIVEL
    AND SZTDICUP_FECHA_INICIO = P_FECHA_INI
    AND SZTDICUP_ESTATUS_CERRADO = 'N';
    COMMIT;

           For ALUMNO in (

                                        select distinct SUBSTR(szp.SZTPRONO_PROGRAM,1,3) CAMPUS,
                                        SUBSTR(szp.SZTPRONO_PROGRAM,4,2) NIVEL,
                                        SZTPRONO_PIDM PIDM,
                                        SZTPRONO_ID MATRICULA,
                                        szp.SZTPRONO_FECHA_INICIO FECHA,
                                        SZTPRONO_TERM_CODE,
                                                 (SELECT SUM((CASE
                                                         WHEN TBRACCD_AMOUNT <> 0 THEN TBRACCD_BALANCE
                                                 END))
                                                 FROM TBRACCD tb
                                                 WHERE 1 = 1
                                                 AND tb.TBRACCD_pidm= szp.SZTPRONO_PIDM
                                                 AND TRUNC(tb.TBRACCD_EFFECTIVE_DATE)<= TRUNC(SYSDATE)) adeudo,
                                         (SELECT MAX(TBBESTU_EXEMPTION_CODE )
                                                 FROM TBBESTU,TBBEXPT
                                                 WHERE TBBESTU_PIDM = szp.SZTPRONO_PIDM
                                                 AND TBBESTU_EXEMPTION_CODE = TBBEXPT_EXEMPTION_CODE
                                                 AND TBBESTU_STUDENT_EXPT_ROLL_IND = 'Y'
                                                 AND TBBESTU_TERM_CODE = (SELECT MAX(TBBESTU_TERM_CODE)FROM TBBESTU WHERE TBBESTU_PIDM = szp.SZTPRONO_PIDM
                                                AND TBBESTU_STUDENT_EXPT_ROLL_IND = 'Y')) DESCUENTO_ACTUAL,
                                        (SELECT MAX(TBBESTU_EXEMPTION_CODE )
                                                 FROM TBBESTU,TBBEXPT
                                                 WHERE TBBESTU_PIDM = szp.SZTPRONO_PIDM
                                                 AND TBBESTU_STUDENT_EXPT_ROLL_IND = 'Y'
                                                 AND TBBESTU_EXEMPTION_CODE = TBBEXPT_EXEMPTION_CODE
                                                 AND TBBESTU_TERM_CODE = (SELECT MAX(TBBESTU_TERM_CODE)FROM TBBESTU WHERE TBBESTU_PIDM = szp.SZTPRONO_PIDM
                                                AND TBBESTU_STUDENT_EXPT_ROLL_IND = 'Y'))-NVL((SELECT ZSTPARA_PARAM_DESC
                                                                                           FROM ZSTPARA
                                                                                           WHERE ZSTPARA_MAPA_ID = 'PORC_DESCU'
                                                                                           AND ZSTPARA_PARAM_ID <                                                                                                                                                                 (SELECT SUM((CASE
                                                                                           WHEN TBRACCD_AMOUNT <> 0 THEN TBRACCD_BALANCE
                                                                                           END))  FROM TBRACCD tb WHERE 1 = 1 AND tb.TBRACCD_pidm= szp.SZTPRONO_PIDM
                                                                                           AND TRUNC(tb.TBRACCD_EFFECTIVE_DATE)<= TRUNC(SYSDATE))
                                                                                                                        AND ZSTPARA_PARAM_VALOR >
                                                                                                                                                 (SELECT SUM((CASE
                                                                                                                                                 WHEN TBRACCD_AMOUNT <> 0 THEN TBRACCD_BALANCE
                                                                                                                                                 END)) FROM TBRACCD tb WHERE 1 = 1 AND tb.TBRACCD_pidm= szp.SZTPRONO_PIDM
                                                                                                                                                 AND TRUNC(tb.TBRACCD_EFFECTIVE_DATE)<= TRUNC(SYSDATE))),0) DESCUENTO_FINAL
            from sztprono szp
                                    where 1 = 1
--                                    AND (SELECT SUM((CASE WHEN TBRACCD_AMOUNT <> 0 THEN TBRACCD_BALANCE END))
--                                            FROM TBRACCD tb WHERE 1 = 1 AND tb.TBRACCD_pidm= szp.SZTPRONO_PIDM
--                                            AND TRUNC(tb.TBRACCD_EFFECTIVE_DATE)<= TRUNC(SYSDATE)) > (SELECT MAX(ZSTPARA_PARAM_ID) FROM ZSTPARA WHERE ZSTPARA_MAPA_ID = 'PORC_DESCU' AND ZSTPARA_PARAM_SEC = 1)
--                                    AND (SELECT SUM((CASE WHEN TBRACCD_AMOUNT <> 0 THEN TBRACCD_BALANCE END))
--                                            FROM TBRACCD tb WHERE 1 = 1 AND tb.TBRACCD_pidm= szp.SZTPRONO_PIDM
--                                            AND TRUNC(tb.TBRACCD_EFFECTIVE_DATE)<= TRUNC(SYSDATE)) <(SELECT MAX(ZSTPARA_PARAM_VALOR) FROM ZSTPARA WHERE ZSTPARA_MAPA_ID = 'PORC_DESCU')
                                    and szp.SZTPRONO_FECHA_INICIO = P_FECHA_INI
                                    and SUBSTR(szp.SZTPRONO_PROGRAM,1,3) = P_CAMPUS
                                    and SUBSTR(szp.SZTPRONO_PROGRAM,4,2) = P_NIVEL
                                    AND szp.SZTPRONO_PIDM NOT IN (SELECT GORADID_PIDM
                                                                    FROM GORADID
                                                                   WHERE GORADID_ADID_CODE = 'EUTL')
--                                    AND (SELECT MAX(TBBESTU_EXEMPTION_CODE )
--                                                         FROM TBBESTU,TBBEXPT
--                                                         WHERE TBBESTU_PIDM = szp.SZTPRONO_PIDM
--                                                         AND TBBESTU_EXEMPTION_CODE = TBBEXPT_EXEMPTION_CODE
--                                                         AND TBBEXPT_TERM_CODE = szp.SZTPRONO_TERM_CODE
--                                                         AND TBBESTU_STUDENT_EXPT_ROLL_IND = 'Y') IS NOT NULL
                                    ORDER BY 4

                                     )LOOP


                   BEGIN

                           SELECT (TBBEXPT_EXEMPTION_CODE)
                           INTO vl_desc_final
                           FROM TBBEXPT
                           WHERE TBBEXPT_TERM_CODE = ALUMNO.SZTPRONO_TERM_CODE
                           AND TBBEXPT_EXEMPTION_CODE = ALUMNO.DESCUENTO_FINAL;

                   EXCEPTION
                   WHEN OTHERS THEN

                        BEGIN

                           SELECT (TBBEXPT_EXEMPTION_CODE)
                           INTO vl_desc_final
                           FROM TBBEXPT
                           WHERE TBBEXPT_TERM_CODE = ALUMNO.SZTPRONO_TERM_CODE
                           AND TBBEXPT_EXEMPTION_CODE = ALUMNO.DESCUENTO_ACTUAL;

                        EXCEPTION
                        WHEN OTHERS THEN
                        vl_desc_final := '0';
                        END;

                   END;


                   If vl_desc_final = '0' then
                     vl_desc_final := 'CUP 0';
                   END IF;

                   BEGIN

                           SELECT (TBBEXPT_EXEMPTION_CODE)
                           INTO vl_desc_actual
                           FROM TBBEXPT
                           WHERE TBBEXPT_TERM_CODE = ALUMNO.SZTPRONO_TERM_CODE
                           AND TBBEXPT_EXEMPTION_CODE = ALUMNO.DESCUENTO_ACTUAL;

                   EXCEPTION
                   WHEN OTHERS THEN
                   vl_desc_actual := '0';
                   END;


                   If vl_desc_actual = '0' then
                     vl_desc_actual := 'CUP 0';
                   END IF;

                   BEGIN

                        SELECT A.SGBSTDN_STYP_CODE
                        INTO VL_TIPO
                        FROM SGBSTDN A
                        WHERE A.SGBSTDN_PIDM = ALUMNO.PIDM
                        AND A.SGBSTDN_TERM_CODE_EFF = (SELECT MAX (A1.SGBSTDN_TERM_CODE_EFF)
                                                       FROM SGBSTDN A1
                                                       WHERE A1.SGBSTDN_PIDM = A.SGBSTDN_PIDM);
                   EXCEPTION
                   WHEN OTHERS THEN
                   VL_TIPO:= 'N';
                   END;

                   IF VL_TIPO = 'C' THEN

                       BEGIN

                            SELECT COUNT(SZTDICUP_PIDM)
                            INTO vl_entra
                            FROM SZTDICUP
                            WHERE SZTDICUP_CAMPUS = P_CAMPUS
                            AND SZTDICUP_NIVEL = P_NIVEL
                            AND SZTDICUP_FECHA_INICIO = P_FECHA_INI
                            AND SZTDICUP_ESTATUS_CERRADO = 'Y';

                       EXCEPTION
                       WHEN OTHERS THEN
                       vl_entra:=0;
                       END;

                       IF vl_entra = 0 then

                               BEGIN

                                INSERT INTO SZTDICUP
                                VALUES(ALUMNO.CAMPUS,
                                            ALUMNO.NIVEL,
                                            ALUMNO.PIDM,
                                            ALUMNO.MATRICULA,
                                            ALUMNO.FECHA,
                                            ALUMNO.ADEUDO,
                                            vl_desc_actual,
                                            vl_desc_final,
                                            'N',
                                            'N',
                                            USER,
                                            SYSDATE,
                                            USER,
                                            SYSDATE,
                                           ALUMNO.SZTPRONO_TERM_CODE );

                               END;

                       END IF;

                   ELSIF VL_TIPO = 'R' THEN

                       BEGIN

                            SELECT COUNT(SZTDICUP_PIDM)
                            INTO vl_entra
                            FROM SZTDICUP
                            WHERE SZTDICUP_CAMPUS = P_CAMPUS
                            AND SZTDICUP_NIVEL = P_NIVEL
                            AND SZTDICUP_FECHA_INICIO = P_FECHA_INI
                            AND SZTDICUP_ESTATUS_CERRADO = 'Y';

                       EXCEPTION
                       WHEN OTHERS THEN
                       vl_entra:=0;
                       END;

                       IF vl_entra = 0 then

                               BEGIN

                                INSERT INTO SZTDICUP
                                VALUES(ALUMNO.CAMPUS,
                                            ALUMNO.NIVEL,
                                            ALUMNO.PIDM,
                                            ALUMNO.MATRICULA,
                                            ALUMNO.FECHA,
                                            ALUMNO.ADEUDO,
                                            vl_desc_actual,
                                            vl_desc_actual,
                                            'N',
                                            'N',
                                            USER,
                                            SYSDATE,
                                            USER,
                                            SYSDATE,
                                           ALUMNO.SZTPRONO_TERM_CODE );

                               END;

                       END IF;

                   END IF;

            COMMIT;

            END LOOP;


 END P_DISMINU_CUPON;


PROCEDURE P_ACTUALIZAR_CUPON (P_CAMPUS in VARCHAR2,P_NIVEL in VARCHAR2,P_FECHA_INI in VARCHAR2) IS

VL_ACT_TER  VARCHAR2(10);
VL_ACT_COD  VARCHAR2(10);
VL_ERROR    VARCHAR2(100);

BEGIN

        FOR C1 IN (

            SELECT SZTDICUP_PIDM,SZTDICUP_TERM_CODE,SZTDICUP_DESC_ACTUAL,SZTDICUP_DESC_NUEVO,SZTDICUP_ESTATUS_CERRADO,SZTDICUP_ESTATUS_ECXEPTO,SZTDICUP_FECHA_INICIO, NVL((SELECT MAX(TBBESTU_EXEMPTION_PRIORITY)
                          FROM TBBESTU WHERE TBBESTU_PIDM = a.SZTDICUP_PIDM
                          AND TBBESTU_TERM_CODE =  a.SZTDICUP_TERM_CODE and TBBESTU_STUDENT_EXPT_ROLL_IND = 'Y'),0) PRIORITY
            FROM SZTDICUP a
            WHERE a.SZTDICUP_CAMPUS = P_CAMPUS
            AND a.SZTDICUP_NIVEL = P_NIVEL
            AND a.SZTDICUP_FECHA_INICIO = P_FECHA_INI
            AND a.SZTDICUP_PIDM NOT IN (SELECT GORADID_PIDM
                                            FROM GORADID
                                           WHERE GORADID_ADID_CODE = 'EUTL')

            )

            LOOP

             VL_ERROR:= NULL;

                           BEGIN

                                    IF C1.SZTDICUP_ESTATUS_ECXEPTO = 'N' AND C1.SZTDICUP_ESTATUS_CERRADO = 'N' THEN

                                         IF c1.SZTDICUP_DESC_NUEVO = 'CUP 0' THEN

                                            UPDATE TBBESTU
                                             SET TBBESTU_DEL_IND = 'Y',TBBESTU_STUDENT_EXPT_ROLL_IND = 'N'
                                             WHERE TBBESTU_PIDM = C1.SZTDICUP_PIDM
                                             AND TBBESTU_TERM_CODE = (SELECT MAX(TBBESTU_TERM_CODE)
                                                                                          FROM TBBESTU WHERE TBBESTU_PIDM = C1.SZTDICUP_PIDM
                                                                                          AND TBBESTU_STUDENT_EXPT_ROLL_IND = 'Y')
                                             AND TBBESTU_EXEMPTION_CODE = C1.SZTDICUP_DESC_ACTUAL;


                                         ELSE

                                                 BEGIN

                                                      BEGIN

                                                             SELECT  TBBESTU_TERM_CODE,TBBESTU_EXEMPTION_CODE
                                                             INTO VL_ACT_TER,VL_ACT_COD
                                                             FROM TBBESTU
                                                             WHERE TBBESTU_PIDM = C1.SZTDICUP_PIDM
                                                             AND TBBESTU_TERM_CODE = (SELECT MAX(TBBESTU_TERM_CODE)
                                                                                      FROM TBBESTU
                                                                                      WHERE TBBESTU_PIDM = C1.SZTDICUP_PIDM
                                                                                      AND TBBESTU_STUDENT_EXPT_ROLL_IND = 'Y')
                                                             AND TBBESTU_EXEMPTION_CODE = C1.SZTDICUP_DESC_ACTUAL;

                                                      END;

                                                      IF VL_ACT_TER = C1.SZTDICUP_TERM_CODE AND VL_ACT_COD = C1.SZTDICUP_DESC_NUEVO THEN

                                                        dbms_output.put_line('NO ACTUALIZA'||'---'||c1.SZTDICUP_PIDM);

                                                      ELSIF VL_ACT_TER != C1.SZTDICUP_TERM_CODE THEN

                                                             UPDATE TBBESTU
                                                             SET TBBESTU_DEL_IND = 'Y',TBBESTU_STUDENT_EXPT_ROLL_IND = 'N'
                                                             WHERE TBBESTU_PIDM = C1.SZTDICUP_PIDM
                                                             AND TBBESTU_TERM_CODE = (SELECT MAX(TBBESTU_TERM_CODE)
                                                                                      FROM TBBESTU WHERE TBBESTU_PIDM = C1.SZTDICUP_PIDM
                                                                                      AND TBBESTU_STUDENT_EXPT_ROLL_IND = 'Y')
                                                             AND TBBESTU_EXEMPTION_CODE = C1.SZTDICUP_DESC_ACTUAL;

                                                        dbms_output.put_line('EMPIEZA actu'||'---'||c1.SZTDICUP_PIDM);



                                                         BEGIN

                                                            INSERT INTO TBBESTU
                                                            VALUES(C1.SZTDICUP_DESC_NUEVO,
                                                                      C1.SZTDICUP_PIDM,
                                                                      C1.SZTDICUP_TERM_CODE,
                                                                      SYSDATE,
                                                                      NULL,
                                                                      'Y',
                                                                      NULL,
                                                                      USER,
                                                                      (C1.PRIORITY)+1,
                                                                      NULL,
                                                                      NULL,
                                                                      NULL,
                                                                      'DICUP',
                                                                      NULL
                                                                        );

                                                         EXCEPTION
                                                         WHEN OTHERS THEN
                                                         C1.SZTDICUP_DESC_NUEVO:= NULL;
                                                         VL_ERROR:='ERROR AL INSERTAR EN TBBESTU';
                                                         END;

                                                         IF VL_ERROR IS NOT NULL THEN

                                                            UPDATE TBBESTU
                                                               SET TBBESTU_DEL_IND = NULL,
                                                                   TBBESTU_STUDENT_EXPT_ROLL_IND = 'Y'
                                                             WHERE     TBBESTU_PIDM = C1.SZTDICUP_PIDM
                                                                   AND TBBESTU_TERM_CODE = C1.SZTDICUP_TERM_CODE
                                                                   AND TBBESTU_EXEMPTION_CODE = C1.SZTDICUP_DESC_NUEVO;

                                                         END IF;

                                                      END IF;

                                                 END;


                                            dbms_output.put_line('EMPIEZA 2 '||'---'||c1.SZTDICUP_DESC_NUEVO||'---'||C1.SZTDICUP_DESC_ACTUAL);

                                         END IF;

                                         BEGIN

                                         UPDATE SZTDICUP
                                         SET SZTDICUP_ESTATUS_CERRADO = 'Y'
                                         WHERE SZTDICUP_PIDM = C1.SZTDICUP_PIDM
                                         AND SZTDICUP_FECHA_INICIO = C1.SZTDICUP_FECHA_INICIO;

                                         END;

                                     END IF;

                           END;

                            dbms_output.put_line('Termina actu'||'---'||c1.SZTDICUP_ESTATUS_CERRADO);
                          COMMIT;
--                          rollback;
              END LOOP;

 END;




   -------------------------------------------------------------------------------------------------------------------------------------------------------------------------

 PROCEDURE P_REVERSA_CUPON (P_PIDM IN VARCHAR2,P_CAMPUS in VARCHAR2,P_NIVEL in VARCHAR2,P_FECHA_INI in VARCHAR2) IS

 VL_PRIORITY NUMBER;


 BEGIN

           FOR C1 IN (
                      SELECT*
                        FROM SZTDICUP
                       WHERE     SZTDICUP_PIDM = P_PIDM
                             AND SZTDICUP_CAMPUS = P_CAMPUS
                             AND SZTDICUP_NIVEL = P_NIVEL
                             AND SZTDICUP_FECHA_INICIO = P_FECHA_INI
                             AND SZTDICUP_PIDM NOT IN (SELECT GORADID_PIDM
                                                         FROM GORADID
                                                        WHERE GORADID_ADID_CODE = 'EUTL')

       )LOOP

                              BEGIN

                                    IF C1.SZTDICUP_ESTATUS_CERRADO = 'Y' AND C1.SZTDICUP_ESTATUS_ECXEPTO = 'N' THEN

                                    dbms_output.put_line('REVERSA 1  '||C1.SZTDICUP_ESTATUS_CERRADO||'----'||C1.SZTDICUP_ESTATUS_ECXEPTO);

                                        IF C1.SZTDICUP_DESC_NUEVO = 'CUP 0' THEN

                                                 BEGIN
                                                             UPDATE TBBESTU
                                                             SET TBBESTU_STUDENT_EXPT_ROLL_IND = 'Y',TBBESTU_DEL_IND = NULL
                                                             WHERE TBBESTU_PIDM = C1.SZTDICUP_PIDM
                                                             AND TBBESTU_EXEMPTION_CODE = C1.SZTDICUP_DESC_ACTUAL
                                                             AND TBBESTU_TERM_CODE = C1.SZTDICUP_TERM_CODE;
                                                 END;

                                        ELSE



                                                --BEGIN
                                                  --   UPDATE TBBESTU
                                                --     SET TBBESTU_STUDENT_EXPT_ROLL_IND = 'Y',TBBESTU_DEL_IND = NULL
                                                  --   WHERE TBBESTU_PIDM = C1.SZTDICUP_PIDM
                                                --     AND TBBESTU_EXEMPTION_CODE = C1.SZTDICUP_DESC_ACTUAL
                                                 --    AND TBBESTU_TERM_CODE = C1.SZTDICUP_TERM_CODE;
                                                ---END;


                                                BEGIN
                                                  SELECT TBBESTU_EXEMPTION_PRIORITY+1
                                                    INTO VL_PRIORITY
                                                    FROM TBBESTU
                                                   WHERE     TBBESTU_PIDM = C1.SZTDICUP_PIDM
                                                         AND TBBESTU_TERM_CODE = C1.SZTDICUP_TERM_CODE;

                                                EXCEPTION
                                                WHEN OTHERS THEN
                                                VL_PRIORITY:= 1;
                                                END;

                                          dbms_output.put_line('REVERSA 2  '||C1.SZTDICUP_DESC_NUEVO||'----'||C1.SZTDICUP_ESTATUS_ECXEPTO);

                                                 BEGIN

                                                    INSERT INTO TBBESTU
                                                    VALUES(C1.SZTDICUP_DESC_ACTUAL,
                                                              C1.SZTDICUP_PIDM,
                                                              C1.SZTDICUP_TERM_CODE,
                                                              SYSDATE,
                                                              NULL,
                                                              'Y',
                                                              NULL,
                                                              USER,
                                                              VL_PRIORITY,
                                                              NULL,
                                                              NULL,
                                                              NULL,
                                                              'DICUP',
                                                              NULL
                                                                );

                                                    dbms_output.put_line('INSERTA TBBESTU ');

                                                 EXCEPTION
                                                 WHEN OTHERS THEN
                                                 C1.SZTDICUP_DESC_NUEVO:= NULL;
                                                 END;

                                                BEGIN
                                                     UPDATE TBBESTU
                                                     SET TBBESTU_DEL_IND = 'Y',TBBESTU_STUDENT_EXPT_ROLL_IND = 'N'
                                                     WHERE TBBESTU_PIDM = C1.SZTDICUP_PIDM
                                                     AND TBBESTU_EXEMPTION_CODE = C1.SZTDICUP_DESC_NUEVO
                                                     AND TBBESTU_TERM_CODE = C1.SZTDICUP_TERM_CODE;
                                                END;


                                        END IF;

                                        BEGIN
                                              UPDATE SZTDICUP
                                             SET SZTDICUP_ESTATUS_ECXEPTO = 'Y'
                                             WHERE SZTDICUP_PIDM = C1.SZTDICUP_PIDM
                                             AND SZTDICUP_FECHA_INICIO = P_FECHA_INI;
                                        END;


                                     END IF;


                               END;

          COMMIT;

       END LOOP;

  END;


PROCEDURE P_INCREMENTO_REZA (p_fecha_ini varchar2, p_nivel varchar2, p_campus varchar2, p_matricula varchar2)
is
    CURSOR C IS

           SELECT
           DISTINCT
                    SORLCUR_CAMP_CODE CAMP,
                    SORLCUR_LEVL_CODE NIVEL,
                    SORLCUR_PROGRAM PROGRAMA,
                    SPRIDEN_ID ID,
                    SFVRHST_PIDM PIDM,
                    spriden_first_name||' '||spriden_last_name ALUMNO,
                    SFVRHST_TERM_CODE PERIODO,
                    SORLCUR_START_DATE FECHA_INICIO,
                    ROUND((SELECT AVG (A1.SFVRHST_GRDE_CODE)
                            FROM SFVRHST A1
                            WHERE A1.SFVRHST_PIDM = HST.SFVRHST_PIDM
                            AND TRIM(A1.SFVRHST_GRDE_CODE) IS NOT NULL
                            AND A1.SFVRHST_GRDE_CODE != 'NP'
                            AND A1.SFVRHST_GRDE_CODE != 'AC'
                            AND A1.SFVRHST_GRDE_CODE != 'NA'
                            AND A1.SFVRHST_PTRM_CODE = HST.SFVRHST_PTRM_CODE
                            AND A1.SFVRHST_TERM_CODE = HST.SFVRHST_TERM_CODE))PROM_CALI,
                    SFVRHST_PTRM_CODE,
                    (select decode (SZTDTEC_PERIODICIDAD, 1, '2', 2, '4', 3, '6', 4, '12')
                    from SZTDTEC
                    where SZTDTEC_PROGRAM = cur.sorlcur_program
                    and  SZTDTEC_TERM_CODE = cur.SORLCUR_TERM_CODE_CTLG)MESES
            FROM SFVRHST HST,
                 SORLCUR CUR,
                 SPRIDEN
            WHERE 1 = 1
            AND HST.SFVRHST_PIDM=CUR.SORLCUR_PIDM
            and spriden_pidm = SORLCUR_PIDM
            and spriden_change_ind is null
            AND SPRIDEN_ID = nvl(p_matricula,SPRIDEN_ID)
            AND (HST.SFVRHST_GRDE_CODE != 'NP'
                 OR HST.SFVRHST_GRDE_CODE != 'AC'
                 OR HST.SFVRHST_GRDE_CODE != 'NA'
                 OR  TRIM(HST.SFVRHST_GRDE_CODE) IS NULL)
            AND CUR.SORLCUR_LMOD_CODE = 'LEARNER'
            AND CUR.SORLCUR_ROLL_IND  = 'Y'
            AND CUR.SORLCUR_CACT_CODE = 'ACTIVE'
            AND CUR.SORLCUR_SEQNO = (SELECT MAX(CUR2.SORLCUR_SEQNO)
                                      FROM SORLCUR CUR2
                                      WHERE 1 = 1
                                      AND CUR2.SORLCUR_PIDM=CUR.SORLCUR_PIDM
                                      AND CUR2.SORLCUR_LMOD_CODE = CUR.SORLCUR_LMOD_CODE
                                      AND CUR2.SORLCUR_ROLL_IND = CUR.SORLCUR_ROLL_IND
                                      AND CUR2.SORLCUR_CACT_CODE = CUR.SORLCUR_CACT_CODE)
           AND SORLCUR_CAMP_CODE = NVL(p_campus,SORLCUR_CAMP_CODE)
           AND SORLCUR_LEVL_CODE = NVL(p_nivel,SORLCUR_LEVL_CODE)
           AND SORLCUR_START_DATE = p_fecha_ini
           AND SORLCUR_PIDM NOT IN (SELECT GORADID_PIDM
                                    FROM GORADID
                                    WHERE GORADID_ADDITIONAL_ID = 'Alumno de IMBEC')
           ORDER BY 1,2,4
           ;


l_contar number;
VL_INSERTA NUMBER;
VL_NO_APLICA number;

BEGIN

--    DELETE SZTINAL;



    FOR l IN c LOOP

        dbms_output.put_line(' PERIODO =  '||l.PERIODO||'  MESES = '||l.MESES);

        BEGIN

               SELECT COUNT (SZTINAL_PIDM)
               INTO VL_INSERTA
               FROM SZTINAL
               WHERE SZTINAL_PIDM = l.pidm
               AND SZTINAL_PERIODO = l.PERIODO
               AND SZTINAL_PTRM_CODE = l.SFVRHST_PTRM_CODE
               ;

        EXCEPTION
        WHEN OTHERS THEN
        VL_INSERTA:=0;
        END;

        IF  VL_INSERTA = 0 THEN




                   INSERT INTO SZTINAL
                   VALUES
                        (
                          l.camp,            -- SZTINAL_CAMPUS
                          l.NIVEL, -- SZTINAL_NIVEL
                          l.PROGRAMA,          -- SZTINAL_PROGRAMA
                          l.id,         -- SZTINAL_ID
                          l.pidm,              -- SZTINAL_PIDM
                          l.ALUMNO,        --  SZTINAL_NOMBRE
                          l.PERIODO, -- SZTINAL_PERIODO
                          'Y', -- SZTINAL_IND
                          l.meses,             -- SZTINAL_MESES
                          round(l.PROM_CALI),  -- SZTINAL_CALIFI
                          l.FECHA_INICIO,          -- SZTINAL_FECHAINI
                          l.SFVRHST_PTRM_CODE);



        ELSIF VL_INSERTA > 0 THEN

            BEGIN

                   SELECT COUNT (SZTINAL_PIDM)
                   INTO VL_NO_APLICA
                   FROM SZTINAL
                   WHERE SZTINAL_PIDM = l.pidm
                   AND SZTINAL_PERIODO = l.PERIODO
                   AND SZTINAL_IND = 'N'
                   ;

            EXCEPTION
            WHEN OTHERS THEN
            VL_INSERTA:=0;
            END;


            IF VL_NO_APLICA = 0 THEN


                 BEGIN

                   DELETE SZTINAL
                   WHERE SZTINAL_PIDM = l.pidm
                   AND SZTINAL_PERIODO = l.PERIODO
                   ;

                    dbms_output.put_line(' ENTRA A BORRAR '||l.pidm||' -- '||l.PERIODO);
                 END;

                 BEGIN

                       INSERT INTO SZTINAL
                       VALUES
                            (
                              l.camp,            -- SZTINAL_CAMPUS
                              l.NIVEL, -- SZTINAL_NIVEL
                              l.PROGRAMA,          -- SZTINAL_PROGRAMA
                              l.id,         -- SZTINAL_ID
                              l.pidm,              -- SZTINAL_PIDM
                              l.ALUMNO,        --  SZTINAL_NOMBRE
                              l.PERIODO, -- SZTINAL_PERIODO
                              'Y', -- SZTINAL_IND
                              l.meses,             -- SZTINAL_MESES
                              round(l.PROM_CALI),  -- SZTINAL_CALIFI
                              l.FECHA_INICIO,          -- SZTINAL_FECHAINI
                              l.SFVRHST_PTRM_CODE);

                 END;


              END IF;

        END IF;


    END LOOP;

 COMMIT;
--ROLLBACK;

END;


PROCEDURE P_PREVIO_REGLAS (p_fecha_ini varchar2, p_nivel varchar2, p_campus varchar2, P_MATRICULA VARCHAR2) IS

vl_error VARCHAR2 (500);
vc_jornada VARCHAR2(4);
vl_codigo VARCHAR2(4);
vl_descripcion VARCHAR2(40);
vl_monto  NUMBER;
VL_SFRRGFE_RATE_CODE VARCHAR2(6);
vl_codigo_desc VARCHAR2(4);
vl_descripcion_desc VARCHAR2(40);
vl_codigo_afec VARCHAR2(4);
vl_monto_percent NUMBER;
vl_monto_amount NUMBER;
vl_descuentoDSI NUMBER;
vl_codigo_DSI VARCHAR2(4);
vl_descripcion_DSI VARCHAR2(50);
vl_plan_pagos number;
vl_colegiatura number;
vl_descuento_col number;
VL_TZCARRE NUMBER;
VL_PAGOS NUMBER;
VL_PORCENTAJE NUMBER;
vl_estatus VARCHAR2(3);
vl_tipo VARCHAR2(3);
VL_ENTRA_TZDOCTR NUMBER;
VL_REINGRE VARCHAR2(2);



BEGIN

vl_error := NULL;
vc_jornada := NULL;
vl_codigo := NULL;
vl_descripcion := NULL;
vl_monto  := NULL;
VL_SFRRGFE_RATE_CODE := NULL;
vl_codigo_desc := NULL;
vl_descripcion_desc := NULL;
vl_codigo_afec := NULL;
vl_monto_percent := NULL;
vl_monto_amount := NULL;
vl_descuentoDSI := NULL;
vl_codigo_DSI := NULL;
vl_descripcion_DSI := NULL;
vl_plan_pagos := NULL;
vl_colegiatura := NULL;
vl_descuento_col := NULL;

    P_INCREMENTO_REZA ( P_FECHA_INI, P_NIVEL, P_CAMPUS,P_MATRICULA );

FOR X IN (

                     SELECT SZTINAL_PIDM,
                       SZTINAL_ID,
                      (SELECT MAX (A1.SZTINAL_PERIODO) FROM SZTINAL A1 WHERE A1.SZTINAL_PIDM = A.SZTINAL_PIDM AND SUBSTR(A1.SZTINAL_PERIODO,5,2) NOT IN (81,82,83))PERIODO,
                       SZTINAL_FECHAINI FECHA_INICIO,
                       SZTINAL_CAMPUS,
                       SZTINAL_NIVEL,
                       SZTINAL_IND,
                        NVL( CASE
                                WHEN (SELECT SUM (SZTINAL_MESES)
                                      FROM SZTINAL A1
                                      WHERE A1.SZTINAL_FECHAINI = P_FECHA_INI
                                      AND A1.SZTINAL_CALIFI IS NOT NULL
                                      AND SUBSTR(A1.SZTINAL_PERIODO,5,2) NOT IN (81,82,83)
                                      AND A1.SZTINAL_PIDM = A.SZTINAL_PIDM) < 12 THEN 0
                                WHEN (SELECT SUM (SZTINAL_MESES)
                                      FROM SZTINAL A1
                                      WHERE A1.SZTINAL_FECHAINI = P_FECHA_INI
                                      AND A1.SZTINAL_CALIFI IS NOT NULL
                                      AND SUBSTR(A1.SZTINAL_PERIODO,5,2) NOT IN (81,82,83)
                                      AND A1.SZTINAL_PIDM = A.SZTINAL_PIDM) BETWEEN 12 AND 23 THEN 5
                                WHEN (SELECT SUM (SZTINAL_MESES)
                                      FROM SZTINAL A1
                                      WHERE A1.SZTINAL_FECHAINI = P_FECHA_INI
                                      AND A1.SZTINAL_CALIFI IS NOT NULL
                                      AND SUBSTR(A1.SZTINAL_PERIODO,5,2) NOT IN (81,82,83)
                                      AND A1.SZTINAL_PIDM = A.SZTINAL_PIDM) >= 24 THEN 10
                        END,0) PORCENTAJE,
                        NVL((SELECT SUM(A1.SZTINAL_MESES)
                        FROM SZTINAL A1
                        WHERE A1.SZTINAL_FECHAINI = P_FECHA_INI
                        AND A1.SZTINAL_CALIFI IS NOT NULL
                        AND SUBSTR(A1.SZTINAL_PERIODO,5,2) NOT IN (81,82,83)
                        AND A1.SZTINAL_PIDM = A.SZTINAL_PIDM),0)MESES_CUR
                FROM SZTINAL A
                WHERE A.SZTINAL_FECHAINI = p_fecha_ini
                AND A.SZTINAL_ID = NVL(P_MATRICULA,SZTINAL_ID)
                group by SZTINAL_PIDM,
                         SZTINAL_FECHAINI,
                         SZTINAL_ID,
                         SZTINAL_CAMPUS,
                         SZTINAL_NIVEL,
                         SZTINAL_IND


  )LOOP

    VL_PORCENTAJE:= X.PORCENTAJE;

        FOR ALUMNO IN (

                SELECT SORLCUR_PIDM PIDM,SORLCUR_TERM_CODE PERIODO,SORLCUR_LEVL_CODE NIVEL,SORLCUR_CAMP_CODE CAMPUS,SORLCUR_PROGRAM PROGRAMA,SORLCUR_KEY_SEQNO STUDY,X.PORCENTAJE porcentaje,
                       (SELECT SUM( (CASE
                       WHEN TBBDETC_DCAT_CODE = 'TUI' THEN TBRACCD_AMOUNT
                       END)) AS COLEGIATURA
                        FROM TBRACCD A,TBBDETC
                        WHERE A.TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
                        AND A.TBRACCD_PIDM = X.SZTINAL_PIDM
                        AND A.TBRACCD_DETAIL_CODE IN (SELECT(TBBDETC_DETAIL_CODE)
                                                      FROM TBBDETC
                                                      WHERE TBBDETC_DCAT_CODE IN ('TUI'))
                        AND A.TBRACCD_TRAN_NUMBER = (SELECT MAX(A1.TBRACCD_TRAN_NUMBER)
                                                     FROM TBRACCD A1
                                                     WHERE A1.TBRACCD_DETAIL_CODE = A.TBRACCD_DETAIL_CODE
                                                     AND A1.TBRACCD_TERM_CODE = A.TBRACCD_TERM_CODE
                                                     AND A1.TBRACCD_PIDM = A.TBRACCD_PIDM)
                        AND A.TBRACCD_TERM_CODE = (SELECT MAX (A1.TBRACCD_TERM_CODE)
                                                   FROM TBRACCD A1
                                                   WHERE A1.TBRACCD_PIDM = A.TBRACCD_PIDM
                                                   AND A1.TBRACCD_DETAIL_CODE = A.TBRACCD_DETAIL_CODE
                                                   AND (A1.TBRACCD_FEED_DATE != X.FECHA_INICIO or A1.TBRACCD_FEED_DATE is null)))COLEG_ANTE,------------------------------- Ultimo cargo de PLAN COLEGIATURA
                        (SELECT SUM( (CASE
                               WHEN TBBDETC_DCAT_CODE = 'DSP' THEN TBRACCD_AMOUNT
                               END)) AS COLEGIATURA
                        FROM TBRACCD A,TBBDETC
                        WHERE A.TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
                        AND A.TBRACCD_PIDM = X.SZTINAL_PIDM
                        AND A.TBRACCD_DETAIL_CODE IN (SELECT(TBBDETC_DETAIL_CODE)
                                                      FROM TBBDETC
                                                      WHERE TBBDETC_DCAT_CODE IN ('DSP'))
                        AND A.TBRACCD_TRAN_NUMBER = (SELECT MAX(A1.TBRACCD_TRAN_NUMBER)
                                                     FROM TBRACCD A1
                                                     WHERE A1.TBRACCD_DETAIL_CODE = A.TBRACCD_DETAIL_CODE
                                                     AND A1.TBRACCD_TERM_CODE = A.TBRACCD_TERM_CODE
                                                     AND A1.TBRACCD_PIDM = A.TBRACCD_PIDM)
                        AND A.TBRACCD_TERM_CODE = (SELECT MAX (A1.TBRACCD_TERM_CODE)
                                                   FROM TBRACCD A1
                                                   WHERE A1.TBRACCD_PIDM = A.TBRACCD_PIDM
                                                   AND A1.TBRACCD_DETAIL_CODE = A.TBRACCD_DETAIL_CODE
                                                   AND (A1.TBRACCD_FEED_DATE != X.FECHA_INICIO or A1.TBRACCD_FEED_DATE is null)))DESCU_ANTE, ------------------------------- Ultimo descuento a colegiatura
                        (SELECT SUM( (CASE
                               WHEN TBRACCD_DESC LIKE 'DSI COLE%' THEN TBRACCD_AMOUNT
                               END)) AS COLEGIATURA
                        FROM TBRACCD A,TBBDETC
                        WHERE A.TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
                        AND A.TBRACCD_PIDM = X.SZTINAL_PIDM
                        AND A.TBRACCD_DETAIL_CODE IN (SELECT(TBBDETC_DETAIL_CODE)
                                                      FROM TBBDETC
                                                      WHERE TBBDETC_DCAT_CODE IN ('DSI'))
                        AND A.TBRACCD_TRAN_NUMBER = (SELECT MAX(A1.TBRACCD_TRAN_NUMBER)
                                                     FROM TBRACCD A1
                                                     WHERE A1.TBRACCD_DETAIL_CODE = A.TBRACCD_DETAIL_CODE
                                                     AND A1.TBRACCD_TERM_CODE = A.TBRACCD_TERM_CODE
                                                     AND A1.TBRACCD_PIDM = A.TBRACCD_PIDM)
                        AND A.TBRACCD_TERM_CODE = (SELECT MAX (A1.TBRACCD_TERM_CODE)
                                                   FROM TBRACCD A1
                                                   WHERE A1.TBRACCD_PIDM = A.TBRACCD_PIDM
                                                   AND A1.TBRACCD_DETAIL_CODE = A.TBRACCD_DETAIL_CODE
                                                   AND (A1.TBRACCD_FEED_DATE != X.FECHA_INICIO or A1.TBRACCD_FEED_DATE is null)))DSI_ANTE, ------------------------------- Ultimo descuento DSI
                        (SELECT SUM( (CASE
                               WHEN TBBDETC_DETAIL_CODE = 'PLPA' THEN TBRACCD_AMOUNT
                               END)) AS COLEGIATURA
                        FROM TBRACCD A,TBBDETC
                        WHERE A.TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
                        AND A.TBRACCD_PIDM = X.SZTINAL_PIDM
                        AND A.TBRACCD_DETAIL_CODE IN (SELECT(TBBDETC_DETAIL_CODE)
                                                      FROM TBBDETC
                                                      WHERE TBBDETC_DCAT_CODE IN ('LPC'))
                        AND A.TBRACCD_TRAN_NUMBER = (SELECT MAX(A1.TBRACCD_TRAN_NUMBER)
                                                     FROM TBRACCD A1
                                                     WHERE A1.TBRACCD_DETAIL_CODE = A.TBRACCD_DETAIL_CODE
                                                     AND A1.TBRACCD_TERM_CODE = A.TBRACCD_TERM_CODE
                                                     AND A1.TBRACCD_PIDM = A.TBRACCD_PIDM)
                        AND A.TBRACCD_TERM_CODE = (SELECT MAX (A1.TBRACCD_TERM_CODE)
                                                   FROM TBRACCD A1
                                                   WHERE A1.TBRACCD_PIDM = A.TBRACCD_PIDM
                                                   AND A1.TBRACCD_DETAIL_CODE = A.TBRACCD_DETAIL_CODE
                                                   AND (A1.TBRACCD_FEED_DATE != X.FECHA_INICIO or A1.TBRACCD_FEED_DATE is null)))PLPA_ANTE, ------------------------------- Ultimo descuento de CRED PLAN DE PAGOS
                       (SELECT SUM( (CASE
                               WHEN TBBDETC_DCAT_CODE = 'COL' THEN TBRACCD_AMOUNT
                               END)) AS COLEGIATURA
                        FROM TBRACCD A,TBBDETC
                        WHERE A.TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
                        AND A.TBRACCD_PIDM = X.SZTINAL_PIDM
                        AND A.TBRACCD_DETAIL_CODE IN (SELECT(TBBDETC_DETAIL_CODE)
                                                      FROM TBBDETC
                                                      WHERE TBBDETC_DCAT_CODE IN ('COL'))
                        AND A.TBRACCD_TRAN_NUMBER = (SELECT MAX(A1.TBRACCD_TRAN_NUMBER)
                                                     FROM TBRACCD A1
                                                     WHERE A1.TBRACCD_DETAIL_CODE = A.TBRACCD_DETAIL_CODE
                                                     AND A1.TBRACCD_TERM_CODE = A.TBRACCD_TERM_CODE
                                                     AND A1.TBRACCD_PIDM = A.TBRACCD_PIDM)
                        AND A.TBRACCD_TERM_CODE = (SELECT MAX (A1.TBRACCD_TERM_CODE)
                                                   FROM TBRACCD A1
                                                   WHERE A1.TBRACCD_PIDM = A.TBRACCD_PIDM
                                                   AND A1.TBRACCD_DETAIL_CODE = A.TBRACCD_DETAIL_CODE
                                                   AND (A1.TBRACCD_FEED_DATE != X.FECHA_INICIO or A1.TBRACCD_FEED_DATE is null)))PARCI_ANTE, ------------------------------- Ultimo cargo de parcialidad
                        (SELECT A.SGBSTDN_RATE_CODE
                        FROM SGBSTDN A
                        WHERE A.SGBSTDN_PIDM =  A.SORLCUR_PIDM
                        AND A.SGBSTDN_PROGRAM_1 = A.SORLCUR_PROGRAM
                        AND A.SGBSTDN_TERM_CODE_EFF = (SELECT MAX(A1.SGBSTDN_TERM_CODE_EFF)
                                                       FROM SGBSTDN A1
                                                       WHERE A1.SGBSTDN_PIDM = A.SGBSTDN_PIDM))RATE ------------------------------- Rate actual
                FROM SORLCUR A
                WHERE 1=1
                AND SORLCUR_PIDM = X.SZTINAL_PIDM
                AND A.SORLCUR_LMOD_CODE = 'LEARNER'
                AND A.SORLCUR_ROLL_IND  = 'Y'
                AND A.SORLCUR_CACT_CODE = 'ACTIVE'
                AND A.SORLCUR_SEQNO IN (SELECT MAX (A1.SORLCUR_SEQNO)
                                        FROM SORLCUR A1
                                        WHERE A1.SORLCUR_PIDM = A.SORLCUR_PIDM
                                        AND A1.SORLCUR_PROGRAM = A.SORLCUR_PROGRAM
                                        AND A1.SORLCUR_LMOD_CODE = A.SORLCUR_LMOD_CODE)

        )LOOP

            IF (SUBSTR(ALUMNO.RATE,1,1)) IN ('J','C','P') THEN

                    vl_error := NULL;

                    BEGIN

                        SELECT T.SGRSATT_ATTS_CODE
                            INTO  VC_JORNADA
                            FROM SGRSATT T
                            WHERE T.SGRSATT_PIDM = ALUMNO.PIDM
                            AND T.SGRSATT_STSP_KEY_SEQUENCE = ALUMNO.STUDY
                            AND REGEXP_LIKE  (T.SGRSATT_ATTS_CODE , '^[0-9]')
                            AND SUBSTR(T.SGRSATT_TERM_CODE_EFF,5,2) NOT IN (81,82,83,90)
                            AND T.SGRSATT_TERM_CODE_EFF = ( SELECT MAX(SGRSATT_TERM_CODE_EFF)
                                                               FROM SGRSATT TT
                                                               WHERE  TT.SGRSATT_PIDM =  T.SGRSATT_PIDM
                                                               AND  TT.SGRSATT_STSP_KEY_SEQUENCE= T.SGRSATT_STSP_KEY_SEQUENCE
                                                               AND SUBSTR(TT.SGRSATT_TERM_CODE_EFF,5,2) NOT IN (81,82,83,90)
                                                               AND REGEXP_LIKE  (TT.SGRSATT_ATTS_CODE , '^[0-9]'))
                            AND T.SGRSATT_ACTIVITY_DATE = (SELECT MAX(SGRSATT_ACTIVITY_DATE)
                                                           FROM SGRSATT T1
                                                           WHERE T1.SGRSATT_PIDM = T.SGRSATT_PIDM
                                                           AND T1.SGRSATT_STSP_KEY_SEQUENCE = T.SGRSATT_STSP_KEY_SEQUENCE
                                                           AND T1.SGRSATT_TERM_CODE_EFF = T.SGRSATT_TERM_CODE_EFF
                                                           AND SUBSTR(T1.SGRSATT_TERM_CODE_EFF,5,2) NOT IN (81,82,83,90)
                                                           AND REGEXP_LIKE  (T1.SGRSATT_ATTS_CODE , '^[0-9]'));
                    EXCEPTION
                    WHEN OTHERS THEN
                        vc_jornada:=NULL;
                        vl_error :='Error al buscar la Jornada en SGRSATT: ' ||sqlerrm;
                    END;

                    dbms_output.put_line ('reza Inicia --- '||ALUMNO.PIDM||'---'||vc_jornada||'--'||vl_error||'--'||ALUMNO.PORCENTAJE);

                    BEGIN

                        SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                        Into vl_codigo, vl_descripcion, vl_monto,  VL_SFRRGFE_RATE_CODE
                                   FROM SFRRGFE A , TBBDETC
                                   WHERE TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                                   And  A.SFRRGFE_TERM_CODE= X.PERIODO
                                   AND A.SFRRGFE_TYPE = 'STUDENT'
                                   AND A.SFRRGFE_ENTRY_TYPE = 'R'
                                   and A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                                   and A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                                   AND A.SFRRGFE_ATTS_CODE = vc_jornada--ALUMNO.JORNADA
                                   AND A.SFRRGFE_RATE_CODE = ALUMNO.RATE
                                   AND A.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA
                                   AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                                          FROM SFRRGFE A1
                                                          WHERE A1.SFRRGFE_TERM_CODE=A.SFRRGFE_TERM_CODE
                                                          AND A1.SFRRGFE_TYPE=A.SFRRGFE_TYPE
                                                          AND A1.SFRRGFE_ENTRY_TYPE=A.SFRRGFE_ENTRY_TYPE
                                                          AND A1.SFRRGFE_LEVL_CODE=A.SFRRGFE_LEVL_CODE
                                                          AND A1.SFRRGFE_CAMP_CODE=A.SFRRGFE_CAMP_CODE
                                                          AND A1.SFRRGFE_ATTS_CODE=A.SFRRGFE_ATTS_CODE
                                                          AND A1.SFRRGFE_RATE_CODE=A.SFRRGFE_RATE_CODE
                                                          AND A1.SFRRGFE_PROGRAM=A.SFRRGFE_PROGRAM);

                                   --and (A.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA or A.SFRRGFE_PROGRAM is null );
                    Exception
                    when Others then
                            BEGIN

                                SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                                Into vl_codigo, vl_descripcion, vl_monto,  VL_SFRRGFE_RATE_CODE
                                           FROM SFRRGFE A , TBBDETC
                                           WHERE TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                                           And  A.SFRRGFE_TERM_CODE= X.PERIODO
                                           AND A.SFRRGFE_TYPE = 'STUDENT'
                                           AND SFRRGFE_ENTRY_TYPE = 'R'
                                           and A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                                           and A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                                           AND A.SFRRGFE_ATTS_CODE = vc_jornada--ALUMNO.JORNADA
                                           AND A.SFRRGFE_RATE_CODE = ALUMNO.RATE
                                           AND A.SFRRGFE_PROGRAM is null;
                                           --and (A.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA or A.SFRRGFE_PROGRAM is null );
                            Exception
                            when Others then
                                  vl_error :='Error al buscar el cargo en SFRRGFE: ' ||sqlerrm;
                                  vl_codigo := null;
                                  vl_descripcion := null;
                                  vl_monto := NULL;
                            End;



                    End;

            --        dbms_output.put_line ('reza --- '||vc_jornada||'---'||vl_error||'--'||vl_descripcion||'--'||vl_monto);


                    BEGIN

                        select DISTINCT TBBDETC_DETAIL_CODE,TBBDETC_DESC, TBREDET_DETAIL_CODE,TBREDET_PERCENT,TBREDET_MAX_AMOUNT
                        INTO vl_codigo_desc,vl_descripcion_desc, vl_codigo_afec, vl_monto_percent, vl_monto_amount
                        from TBBEXPT, tbbestu, tbbdetc, tbredet
                        where TBBDETC_DETAIL_CODE = TBBEXPT_DETAIL_CODE
                        AND TBBESTU_EXEMPTION_CODE  = TBBEXPT_EXEMPTION_CODE
                        AND TBBESTU_TERM_CODE         = TBBEXPT_TERM_CODE
                        AND TBBESTU_STUDENT_EXPT_ROLL_IND= 'Y'
                        AND TBBESTU_DEL_IND IS NULL
                        AND TBREDET_EXEMPTION_CODE   = TBBEXPT_EXEMPTION_CODE
                        AND TBREDET_TERM_CODE    = TBBEXPT_TERM_CODE
                        and TBBEXPT_TERM_CODE = X.PERIODO
                        AND TBBESTU_PIDM = ALUMNO.PIDM
                        AND TBBDETC_DCAT_CODE = 'DSP';


                    EXCEPTION
                    WHEN OTHERS THEN

                            BEGIN
                                    select DISTINCT TBBDETC_DETAIL_CODE,TBBDETC_DESC, TBREDET_DETAIL_CODE,TBREDET_PERCENT,TBREDET_MAX_AMOUNT
                                    INTO vl_codigo_desc,vl_descripcion_desc, vl_codigo_afec, vl_monto_percent, vl_monto_amount
                                    from TBBEXPT, tbbestu A, tbbdetc, tbredet
                                    where TBBDETC_DETAIL_CODE = TBBEXPT_DETAIL_CODE
                                    AND A.TBBESTU_EXEMPTION_CODE  = TBBEXPT_EXEMPTION_CODE
                                    AND A.TBBESTU_TERM_CODE         = TBBEXPT_TERM_CODE
                                    AND A.TBBESTU_STUDENT_EXPT_ROLL_IND= 'Y'
                                    AND A.TBBESTU_DEL_IND IS NULL
                                    AND TBREDET_EXEMPTION_CODE   = TBBEXPT_EXEMPTION_CODE
                                    AND TBREDET_TERM_CODE    = TBBEXPT_TERM_CODE
                                    and A.TBBESTU_TERM_CODE = (SELECT MAX(A1.TBBESTU_TERM_CODE)
                                                              FROM TBBESTU A1
                                                              WHERE A1.TBBESTU_PIDM = A.TBBESTU_PIDM
                                                              AND A1.TBBESTU_STUDENT_EXPT_ROLL_IND = A.TBBESTU_STUDENT_EXPT_ROLL_IND
                                                              AND A1.TBBESTU_DEL_IND IS NULL)
                                    AND A.TBBESTU_EXEMPTION_PRIORITY = (SELECT MAX(TBBESTU_EXEMPTION_PRIORITY)
                                                                        FROM TBBESTU A1
                                                                        WHERE A1.TBBESTU_PIDM = A.TBBESTU_PIDM
                                                                        AND A1.TBBESTU_STUDENT_EXPT_ROLL_IND = A.TBBESTU_STUDENT_EXPT_ROLL_IND
                                                                        AND A1.TBBESTU_DEL_IND IS NULL
                                                                        AND A1.TBBESTU_TERM_CODE = A.TBBESTU_TERM_CODE)
                                    AND TBBESTU_PIDM = ALUMNO.PIDM
                                    AND TBBDETC_DCAT_CODE = 'DSP';

                            EXCEPTION
                            WHEN OTHERS THEN
                            vl_error :='Error al buscar el descuento DSP : ' ||sqlerrm;
                            vl_codigo_desc := null;
                            vl_descripcion_desc := null;
                            vl_codigo_afec := null;
                            vl_monto_percent := 0;
                            vl_monto_amount := 0;
                            END;

                    END;

                    dbms_output.put_line('DESCUENTO  << '||X.PERIODO||'---'||vl_monto_percent);
            --         dbms_output.put_line ('reza TBBEXPT --- '||vl_codigo_desc||'---'||vl_descripcion_desc||'--'||vl_monto_percent||'--'||vl_codigo_afec);

                     begin

                          select NVL(TZTDMTO_MONTO,0)  ,TZTDMTO_DESC_CODE , TZTDMTO_OBSERVACIONES
                             INTO vl_descuentoDSI, vl_codigo_DSI,vl_descripcion_DSI
                                 from TZTDMTO A
                                      where A.TZTDMTO_PIDm   = alumno.pidm
                                      and   A.TZTDMTO_CAMP_CODE = alumno.campus
                                      and  A.TZTDMTO_NIVEL  = alumno.nivel
                                      and A.TZTDMTO_PROGRAMA =  alumno.programa
                                      and  A.TZTDMTO_TERM_CODE  = X.PERIODO
                                      and A.TZTDMTO_IND = 1 -----UNO(1) esta activo /  cero(0) esta desactivado
                                      AND A.TZTDMTO_STUDY_PATH = ALUMNO.STUDY
                                      ;

                     exception when others then
                       vl_descuentoDSI  := 0;
                     end;

                       IF vl_descuentoDSI = 0 THEN

                           BEGIN

                                SELECT TBRACCD_DETAIL_CODE,TBRACCD_DESC,TBRACCD_AMOUNT
                                INTO vl_codigo_DSI,vl_descripcion_DSI,vl_descuentoDSI
                                FROM TBRACCD A
                                WHERE A.TBRACCD_PIDM = alumno.pidm
                                AND A.TBRACCD_DESC LIKE 'DSI COLE%'
                                AND A.TBRACCD_TRAN_NUMBER = (SELECT MAX(A1.TBRACCD_TRAN_NUMBER)
                                                             FROM TBRACCD A1
                                                             WHERE A1.TBRACCD_PIDM = A.TBRACCD_PIDM
                                                             AND A1.TBRACCD_DETAIL_CODE = A.TBRACCD_DETAIL_CODE
                                                             AND (A1.TBRACCD_FEED_DATE != p_fecha_ini
                                                             OR A1.TBRACCD_FEED_DATE is null))
                                                             ;

                           EXCEPTION WHEN OTHERS THEN
                           vl_descuentoDSI:= 0;
                           vl_error:='Error al buscar DSI : ' ||sqlerrm;
                           END;

                     END IF;


                         dbms_output.put_line ('reza TZTDMTO --- '||vl_descuentoDSI||'---'||vl_codigo_DSI||'--'||vl_error);

                   IF (SUBSTR(ALUMNO.RATE,1,1)) IN ('J','C') AND X.SZTINAL_IND = 'Y' THEN

                    VL_PAGOS:= substr(VL_SFRRGFE_RATE_CODE,3,1);

                         BEGIN

                                SELECT A.SGBSTDN_STYP_CODE
                                INTO VL_REINGRE
                                FROM SGBSTDN A
                                WHERE A.SGBSTDN_PIDM = ALUMNO.PIDM
                                AND A.SGBSTDN_TERM_CODE_EFF = (SELECT MAX (A1.SGBSTDN_TERM_CODE_EFF)
                                                               FROM SGBSTDN A1
                                                               WHERE A1.SGBSTDN_PIDM = A.SGBSTDN_PIDM);
                         EXCEPTION
                         WHEN OTHERS THEN
                         VL_REINGRE:= 'C';
                         END;

                         IF VL_REINGRE = 'R' THEN

                          VL_PORCENTAJE:=0;

                         END IF;


                            IF VL_PORCENTAJE = 0 THEN

                                dbms_output.put_line ('reza vl_monto_percent --- '||vl_monto_percent);

                                       vl_descuento_col:= round((vl_monto*(vl_monto_percent/100)));
                                       vl_plan_pagos:= round((vl_monto - vl_descuento_col -  vl_descuentoDSI));
                                       vl_colegiatura:= round(vl_plan_pagos/VL_PAGOS);

                                      dbms_output.put_line ('reza  --- '||vl_descuento_col||'=='||vl_plan_pagos);

                                       vl_plan_pagos:= vl_colegiatura*(substr(VL_SFRRGFE_RATE_CODE,3,1));

                    --                   dbms_output.put_line ('reza vl_plan_pagos ajust--- '||vl_plan_pagos);

                                       vl_descuento_col:= (vl_monto - vl_descuentoDSI - vl_plan_pagos);

                    --                   dbms_output.put_line ('reza descuento ajust--- '||vl_descuento_col);

                                       dbms_output.put_line ('Montos finales 0 %--- colegiatura = '||vl_monto||' descuento = '||vl_descuento_col||' dsi = '||vl_descuentoDSI||' plande pagos = '||vl_plan_pagos||' Numero de pagos = '||ALUMNO.RATE||' oo '||vl_error);

                            ELSIF VL_PORCENTAJE = 5 THEN

                                       vl_descuento_col:= (vl_monto*(vl_monto_percent/100));
                                       vl_plan_pagos:= (vl_monto - vl_descuento_col -  vl_descuentoDSI);
                                       vl_colegiatura:= vl_plan_pagos/VL_PAGOS;

                              dbms_output.put_line ('Montos finales sin incre --- colegiatura = '||vl_monto||' descuento = '||vl_descuento_col||' dsi = '||vl_descuentoDSI||' plande pagos = '||vl_plan_pagos||' Numero de pagos = '||ALUMNO.RATE||' oo '||vl_monto_percent);


                                       vl_monto:= round(vl_monto*1.05);
                                       vl_descuento_col:= round(vl_descuento_col*1.05);
                                       vl_descuentoDSI:= round(vl_descuentoDSI*1.05);
                                       vl_plan_pagos:= round(vl_plan_pagos*1.05);
                                       vl_colegiatura:= round( vl_colegiatura*1.05);

                    --                   dbms_output.put_line ('reza vl_plan_pagos aume--- '||vl_monto||'---'||vl_descuento_col||'--'||vl_descuentoDSI||'--'||vl_plan_pagos||'--'||vl_colegiatura);

                                       vl_plan_pagos:= vl_colegiatura*VL_PAGOS;

                    --                   dbms_output.put_line ('reza vl_plan_pagos ajust--- '||vl_plan_pagos);

                                       vl_descuento_col:= (vl_monto - vl_descuentoDSI - vl_plan_pagos);

                    --                   dbms_output.put_line ('reza descuento ajust--- '||vl_descuento_col);
                                       VL_ENTRA_TZDOCTR:=0;
                                       dbms_output.put_line ('Montos finales 05 %--- colegiatura = '||vl_monto||' descuento = '||vl_descuento_col||' dsi = '||vl_descuentoDSI||' plande pagos = '||vl_plan_pagos||' Numero de pagos = '||ALUMNO.RATE||' oo '||vl_monto_percent);
                                       dbms_output.put_line('ANTERIORES - '||ALUMNO.COLEG_ANTE||' <> '||ALUMNO.DESCU_ANTE||' <> '||ALUMNO.DSI_ANTE||' <> '||ALUMNO.PLPA_ANTE||'<>'||ALUMNO.PARCI_ANTE||' ERROR '||vl_error);

                            ELSIF VL_PORCENTAJE = 10 THEN

                                       vl_descuento_col:= (vl_monto*(vl_monto_percent/100));
                                       vl_plan_pagos:= (vl_monto - vl_descuento_col -  vl_descuentoDSI);
                                       vl_colegiatura:= vl_plan_pagos/VL_PAGOS;


                                       vl_monto:= round(vl_monto*1.1);
                                       vl_descuento_col:= round(vl_descuento_col*1.1);
                                       vl_descuentoDSI:= round(vl_descuentoDSI*1.1);
                                       vl_plan_pagos:= round(vl_plan_pagos*1.1);
                                       vl_colegiatura:= round( vl_colegiatura*1.1);

                    --                   dbms_output.put_line ('reza vl_plan_pagos aume--- '||vl_monto||'---'||vl_descuento_col||'--'||vl_descuentoDSI||'--'||vl_plan_pagos||'--'||vl_colegiatura);

                                       vl_plan_pagos:= vl_colegiatura*VL_PAGOS;

                    --                   dbms_output.put_line ('reza vl_plan_pagos ajust--- '||vl_plan_pagos);

                                       vl_descuento_col:= (vl_monto - vl_descuentoDSI - vl_plan_pagos);

                    --                   dbms_output.put_line ('reza descuento ajust--- '||vl_descuento_col);
                                       VL_ENTRA_TZDOCTR:=0;
                                       dbms_output.put_line ('Montos finales 10% --- colegiatura = '||vl_monto||' descuento = '||vl_descuento_col||' dsi = '||vl_descuentoDSI||' plande pagos = '||vl_plan_pagos||' Numero de pagos = '||ALUMNO.RATE||' oo '||vl_error);
                            END IF;


                            IF VL_ENTRA_TZDOCTR = 0 THEN

                                VL_ENTRA_TZDOCTR:= NULL;

                                BEGIN

                                        SELECT COUNT (TZDOCTR_PIDM)
                                        INTO VL_ENTRA_TZDOCTR
                                        FROM TZDOCTR
                                        WHERE TZDOCTR_PIDM = alumno.pidm
                                        AND TZDOCTR_TERM_CODE = X.PERIODO
                                        AND TZDOCTR_TIPO_PROC = 'AUME'
                                        AND TZDOCTR_START_DATE = p_fecha_ini
                                        ;
                                EXCEPTION
                                WHEN OTHERS THEN
                                VL_ENTRA_TZDOCTR:= 0;
                                END;

                                BEGIN

                                    SELECT SGBSTDN_STST_CODE,SGBSTDN_STYP_CODE
                                    INTO vl_estatus,vl_tipo
                                    FROM SGBSTDN A
                                    WHERE A.SGBSTDN_PIDM = alumno.pidm
                                    AND A.SGBSTDN_PROGRAM_1 = alumno.PROGRAMA
                                    AND A.SGBSTDN_TERM_CODE_EFF = (SELECT MAX (A1.SGBSTDN_TERM_CODE_EFF)
                                                                   FROM SGBSTDN A1
                                                                   WHERE A1.SGBSTDN_PIDM = A.SGBSTDN_PIDM
                                                                   AND A1.SGBSTDN_PROGRAM_1 = A.SGBSTDN_PROGRAM_1)
                                                                   ;
                                EXCEPTION
                                WHEN OTHERS THEN
                                vl_estatus:= NULL;
                                vl_tipo:= NULL;
                                END;

                                IF VL_ENTRA_TZDOCTR > 0 THEN

                                    DELETE FROM TZDOCTR
                                    WHERE TZDOCTR_PIDM = alumno.pidm
                                    AND TZDOCTR_TERM_CODE = X.PERIODO
                                    AND TZDOCTR_TIPO_PROC = 'AUME'
                                    AND TZDOCTR_START_DATE = p_fecha_ini
                                    ;


                                END IF;



                                Begin
                                          Insert
                                          into TZDOCTR
                                          VALUES (
                                                   alumno.pidm,          --TZDOCTR_PIDM
                                                   alumno.PROGRAMA,          --TZDOCTR_PROGRAM
                                                   vl_estatus,          --TZDOCTR_STST_CODE
                                                   vl_tipo,          --TZDOCTR_STYP_CODE
                                                   alumno.campus,          --TZDOCTR_CAMP_CODE
                                                   alumno.nivel,          --TZDOCTR_LEVL_CODE
                                                   X.PERIODO,          --TZDOCTR_TERM_CODE
                                                   p_fecha_ini,          --TZDOCTR_START_DATE
                                                   NULL,         --TZDOCTR_PTRM_CODE
                                                   0,          --TZDOCTR_STUDY_PATH
                                                   VL_PAGOS,         --TZDOCTR_NUM_PAGOS
                                                   VL_SFRRGFE_RATE_CODE,         --TZDOCTR_RATE_CODE
                                                   vl_monto,         --TZDOCTR_COLEG
                                                   vl_descuento_col,         --TZDOCTR_DESC
                                                   vl_plan_pagos,         --TZDOCTR_PPAGO
                                                   vl_colegiatura,         --TZDOCTR_PARCI
                                                   sysdate,         --FECHA_PROCESO
                                                   null,         --TZDOCTR_IND
                                                   null,         --TZDOCTR_OBSERVACIONES
                                                   null,         --TZDOCTR_VENCIMIENTO
                                                   X.SZTINAL_ID,         --TZDOCTR_ID
                                                   'AUME',         --TZDOCTR_TIPO_PROC
                                                   0,        --TZDOCTR_DESCUENTO
                                                   X.MESES_CUR,        --TZDOCTR_PERIODOS_CURSADOS
                                                   vl_monto,       --TZDOCTR_COLEG_1
                                                   vl_descuento_col,       --TZDOCTR_DESC_1
                                                   vl_plan_pagos,       --TZDOCTR_PPAGO_1
                                                   vl_colegiatura,       --TZDOCTR_PARCI_1
                                                   VL_PORCENTAJE,       --TZDOCTR_PORC_INCREM
                                                   NULL,       --TZDOCTR_IND_1
                                                   null);       --TZDOCTR_OBSERVACIONES_1

                                Exception
                                When Others then
                                  dbms_output.put_line ('Error TZDOCTR '|| alumno.pidm ||'*'||sqlerrm);

                                End;


                            END IF;




                   ELSIF (SUBSTR(ALUMNO.RATE,1,1)) IN ('P') AND X.SZTINAL_IND = 'Y' THEN

                   VL_PAGOS:= substr(VL_SFRRGFE_RATE_CODE,2,2);

                           vl_descuento_col:= round((vl_monto*(vl_monto_percent/100)));
                           vl_plan_pagos:= round((vl_monto - vl_descuento_col -  vl_descuentoDSI));
                           vl_colegiatura:= round(vl_plan_pagos/VL_PAGOS);

                           vl_plan_pagos:= vl_colegiatura*VL_PAGOS;
                           vl_descuento_col:= (vl_monto - vl_descuentoDSI - vl_plan_pagos);


                   ELSIF X.SZTINAL_IND = 'N' THEN

                   VL_PAGOS:= substr(VL_SFRRGFE_RATE_CODE,2,2);
                                       vl_descuento_col:= round((vl_monto*(vl_monto_percent/100)));
                                       vl_plan_pagos:= round((vl_monto - vl_descuento_col -  vl_descuentoDSI));
                                       vl_colegiatura:= round(vl_plan_pagos/VL_PAGOS);



                                       vl_plan_pagos:= vl_colegiatura*(substr(VL_SFRRGFE_RATE_CODE,3,1));

                    --                   dbms_output.put_line ('reza vl_plan_pagos ajust--- '||vl_plan_pagos);

                                       vl_descuento_col:= (vl_monto - vl_descuentoDSI - vl_plan_pagos);

                    --                   dbms_output.put_line ('reza descuento ajust--- '||vl_descuento_col);

                     VL_PORCENTAJE:= 0;

                   END IF;

                    BEGIN

                         SELECT COUNT (PIDM)
                         INTO VL_TZCARRE
                         FROM TZCARRE
                         WHERE PIDM = X.SZTINAL_PIDM
                         AND PROGRAMA = ALUMNO.PROGRAMA
                         AND PERIODO = X.PERIODO
                         AND STUDY = ALUMNO.STUDY
                         AND FECHA_INICIO = X.FECHA_INICIO;

                    END;

                    IF VL_TZCARRE = 0 THEN

                     vl_error:= null;

                        BEGIN

                            INSERT INTO TZCARRE
                            VALUES(
                                     X.SZTINAL_PIDM,            --PIDM
                                     X.SZTINAL_ID,              --MATRICULA
                                     X.MESES_CUR,               --MESES_CUR
                                     X.PORCENTAJE,              --PORC_INCRE
                                     ALUMNO.PROGRAMA,           --PROGRAMA
                                     ALUMNO.RATE,               --RATE
                                     vc_jornada,                --JORNADA
                                     X.PERIODO,                 --PERIODO
                                     ALUMNO.STUDY,              --STUDY
                                     vl_monto,                  --COL_REGLAS
                                     vl_descuento_col,          --DESC_REGLAS
                                     vl_descuentoDSI,           --DSI_REGLAS
                                     vl_plan_pagos,             --PLAN_PAGOS
                                     vl_colegiatura,            --PARCI_REGLAS
                                     VL_PAGOS,                  --NUM_PAGOS
                                     ALUMNO.COLEG_ANTE,         --COL_ANTER
                                     ALUMNO.DESCU_ANTE,         --DESC_ANTER
                                     ALUMNO.DSI_ANTE,           --DSI_ANTER
                                     ALUMNO.PLPA_ANTE,          --PLAN_ANTER
                                     ALUMNO.PARCI_ANTE,         --PARCI_ANTER
                                     SYSDATE,                   --ACTIVITY_DATE
                                     USER,                       --TZCARRE_USER
                                     X.FECHA_INICIO,
                                     X.SZTINAL_CAMPUS,
                                     X.SZTINAL_NIVEL,
                                     'N'
                                    );
                        EXCEPTION
                        WHEN OTHERS THEN
                        VL_ERROR:= 'ERROR AL INSERTAR '||SQLERRM;
                        END;

                    ELSIF VL_TZCARRE >0 THEN

                    vl_error:= null;

                        IF X.SZTINAL_IND = 'N' THEN

                                 DELETE TZCARRE
                                 WHERE PIDM = X.SZTINAL_PIDM
                                 AND PROGRAMA = ALUMNO.PROGRAMA
                                 AND PERIODO = X.PERIODO
                                 AND STUDY = ALUMNO.STUDY
                                 AND FECHA_INICIO = X.FECHA_INICIO;

                                BEGIN

                                    INSERT INTO TZCARRE
                                    VALUES(
                                             X.SZTINAL_PIDM,            --PIDM
                                             X.SZTINAL_ID,              --MATRICULA
                                             X.MESES_CUR,               --MESES_CUR
                                             X.PORCENTAJE,              --PORC_INCRE
                                             ALUMNO.PROGRAMA,           --PROGRAMA
                                             ALUMNO.RATE,               --RATE
                                             vc_jornada,                --JORNADA
                                             X.PERIODO,                 --PERIODO
                                             ALUMNO.STUDY,              --STUDY
                                             vl_monto,                  --COL_REGLAS
                                             vl_descuento_col,          --DESC_REGLAS
                                             vl_descuentoDSI,           --DSI_REGLAS
                                             vl_plan_pagos,             --PLAN_PAGOS
                                             vl_colegiatura,            --PARCI_REGLAS
                                             VL_PAGOS,                  --NUM_PAGOS
                                             ALUMNO.COLEG_ANTE,         --COL_ANTER
                                             ALUMNO.DESCU_ANTE,         --DESC_ANTER
                                             ALUMNO.DSI_ANTE,           --DSI_ANTER
                                             ALUMNO.PLPA_ANTE,          --PLAN_ANTER
                                             ALUMNO.PARCI_ANTE,         --PARCI_ANTER
                                             SYSDATE,                   --ACTIVITY_DATE
                                             USER,                       --TZCARRE_USER
                                             X.FECHA_INICIO,
                                             X.SZTINAL_CAMPUS,
                                             X.SZTINAL_NIVEL,
                                             'Y'
                                            );
                                EXCEPTION
                                WHEN OTHERS THEN
                                VL_ERROR:= 'ERROR AL INSERTAR '||SQLERRM;
                                END;

                         dbms_output.put_line ('SE BORRA E INSERTA '||VL_TZCARRE);

                       ELSIF X.SZTINAL_IND = 'Y' THEN

                                 DELETE TZCARRE
                                 WHERE PIDM = X.SZTINAL_PIDM
                                 AND PROGRAMA = ALUMNO.PROGRAMA
                                 AND PERIODO = X.PERIODO
                                 AND STUDY = ALUMNO.STUDY
                                 AND FECHA_INICIO = X.FECHA_INICIO;

                                BEGIN

                                    INSERT INTO TZCARRE
                                    VALUES(
                                             X.SZTINAL_PIDM,            --PIDM
                                             X.SZTINAL_ID,              --MATRICULA
                                             X.MESES_CUR,               --MESES_CUR
                                             X.PORCENTAJE,              --PORC_INCRE
                                             ALUMNO.PROGRAMA,           --PROGRAMA
                                             ALUMNO.RATE,               --RATE
                                             vc_jornada,                --JORNADA
                                             X.PERIODO,                 --PERIODO
                                             ALUMNO.STUDY,              --STUDY
                                             vl_monto,                  --COL_REGLAS
                                             vl_descuento_col,          --DESC_REGLAS
                                             vl_descuentoDSI,           --DSI_REGLAS
                                             vl_plan_pagos,             --PLAN_PAGOS
                                             vl_colegiatura,            --PARCI_REGLAS
                                             VL_PAGOS,                  --NUM_PAGOS
                                             ALUMNO.COLEG_ANTE,         --COL_ANTER
                                             ALUMNO.DESCU_ANTE,         --DESC_ANTER
                                             ALUMNO.DSI_ANTE,           --DSI_ANTER
                                             ALUMNO.PLPA_ANTE,          --PLAN_ANTER
                                             ALUMNO.PARCI_ANTE,         --PARCI_ANTER
                                             SYSDATE,                   --ACTIVITY_DATE
                                             USER,                       --TZCARRE_USER
                                             X.FECHA_INICIO,
                                             X.SZTINAL_CAMPUS,
                                             X.SZTINAL_NIVEL,
                                             'N'
                                            );
                                EXCEPTION
                                WHEN OTHERS THEN
                                VL_ERROR:= 'ERROR AL INSERTAR '||SQLERRM;
                                END;

                       END IF;

                    END IF;


                   dbms_output.put_line ('FINAL = '||VL_ERROR||'<<'||X.SZTINAL_PIDM||'<<'||X.SZTINAL_ID||'<<'||X.MESES_CUR||'<<'||X.PORCENTAJE||'<<'||vc_jornada||'<<'||X.PERIODO||'<<'||USER );


            END IF;

        END LOOP;

  END loop;

    COMMIT;

 END;

FUNCTION F_ACTU_TZFACCE (P_PIDM         IN NUMBER,
                         P_PERIODO      IN VARCHAR2,
                         P_FECHA_NUEVA  IN DATE,
                         P_FECHA_OLD    IN DATE,
                         P_PER_NUEVO    IN VARCHAR2,
                         P_PROGRAMA     IN VARCHAR2,
                         P_CAMPUS       IN VARCHAR2,
                         P_NIVEL        IN VARCHAR2) RETURN VARCHAR2 IS

VL_MES              NUMBER;
VL_ANO              NUMBER;
VL_VIGENCIA         DATE;
VL_ERROR            VARCHAR2(500);
VL_PROPEDEUTICO     NUMBER;
VL_MES_FECHA_OLD    NUMBER;
VL_DIA_FECHA_OLD    NUMBER;
VL_MES_ACC          NUMBER;
VL_MES_APLICAR      NUMBER;
VL_COMPLE_MES       NUMBER;
VL_ANO_COMPLE       NUMBER;
VL_MES_REAL         NUMBER;
VL_VALIDA           NUMBER;
VL_PROPEANTE        NUMBER;


BEGIN

      FOR X IN (

            SELECT *
            FROM TZFACCE
            WHERE TZFACCE_PIDM = P_PIDM
            AND TZFACCE_TERM_CODE = P_PERIODO
            AND TZFACCE_USER != 'PRIM'

  )LOOP

    VL_MES              := NULL;
    VL_ANO              := NULL;
    VL_MES_FECHA_OLD    := NULL;
    VL_DIA_FECHA_OLD    := NULL;
    VL_MES_ACC          := NULL;

    BEGIN
        SELECT EXTRACT(DAY FROM P_FECHA_OLD )DIA,EXTRACT(MONTH FROM P_FECHA_OLD )MES
        INTO VL_DIA_FECHA_OLD,VL_MES_FECHA_OLD
        FROM DUAL;
    END;

    DBMS_OUTPUT.PUT_LINE('REZA 1 = '||VL_DIA_FECHA_OLD||' = '||VL_MES_FECHA_OLD);

    BEGIN
        SELECT EXTRACT(MONTH FROM X.TZFACCE_EFFECTIVE_DATE )MES
        INTO VL_MES_ACC
        FROM DUAL;

    END;

    DBMS_OUTPUT.PUT_LINE('REZA 2 = '||VL_MES_ACC);


    IF VL_DIA_FECHA_OLD >= 20 THEN
     VL_MES_FECHA_OLD:=VL_MES_FECHA_OLD+1;
    END IF;

    DBMS_OUTPUT.PUT_LINE('REZA 3 = '||VL_DIA_FECHA_OLD);

    VL_MES_APLICAR:= VL_MES_ACC - VL_MES_FECHA_OLD;

    IF VL_MES_APLICAR < 0 THEN
        VL_MES_APLICAR:= VL_MES_APLICAR+12;
    END IF;

    DBMS_OUTPUT.PUT_LINE('REZA 4 = '||VL_MES_APLICAR);

    BEGIN

        SELECT EXTRACT(MONTH FROM P_FECHA_NUEVA)MES
        INTO VL_MES
        FROM DUAL;

    EXCEPTION
    WHEN OTHERS THEN
    VL_ERROR:= 'ERROR EN CALCULAR VIGENCIA   '||SQLERRM;
    END;

    DBMS_OUTPUT.PUT_LINE('REZA 5 = '||VL_MES);

    IF SUBSTR(P_FECHA_NUEVA,1,2) >= 20 THEN

    VL_MES_APLICAR:= VL_MES_APLICAR+1;

    END IF;

    DBMS_OUTPUT.PUT_LINE('REZA 5 = '||VL_MES_APLICAR);


    BEGIN

            SELECT SZTPTRM_PROPEDEUTICO
            INTO VL_PROPEANTE
            FROM SZTPTRM A
            WHERE A.SZTPTRM_PROGRAM = P_PROGRAMA
            AND A.SZTPTRM_TERM_CODE  = P_PERIODO
            AND A.SZTPTRM_PTRM_CODE IN (SELECT SOBPTRM_PTRM_CODE
                                          FROM SOBPTRM
                                         WHERE SOBPTRM_TERM_CODE = A.SZTPTRM_TERM_CODE
                                           AND  SOBPTRM_START_DATE = P_FECHA_OLD );
    EXCEPTION
    WHEN OTHERS THEN
    VL_PROPEANTE:= 0;
    END;


    BEGIN

            SELECT SZTPTRM_PROPEDEUTICO
            INTO VL_PROPEDEUTICO
            FROM SZTPTRM A
            WHERE A.SZTPTRM_PROGRAM = P_PROGRAMA
            AND A.SZTPTRM_TERM_CODE  = P_PER_NUEVO
            AND A.SZTPTRM_PTRM_CODE IN (SELECT SOBPTRM_PTRM_CODE
                                                            FROM SOBPTRM
                                                            WHERE SOBPTRM_TERM_CODE = A.SZTPTRM_TERM_CODE
                                                            AND  SOBPTRM_START_DATE = P_FECHA_NUEVA );
    EXCEPTION
    WHEN OTHERS THEN
    VL_PROPEDEUTICO:= 0;
    END;

    IF  VL_PROPEDEUTICO > 0 THEN
        VL_MES_APLICAR:= VL_MES_APLICAR+1;
    END IF;

    IF VL_PROPEANTE > 0 THEN

       VL_MES_APLICAR:= VL_MES_APLICAR-1;

    END IF;

    DBMS_OUTPUT.PUT_LINE('REZA 6 = '||VL_MES_APLICAR);

    VL_VIGENCIA:= ADD_MONTHS(P_FECHA_NUEVA,(VL_MES_APLICAR));

    DBMS_OUTPUT.PUT_LINE('REZA 7 = '||VL_VIGENCIA);

    IF SUBSTR(X.TZFACCE_DETAIL_CODE,3,2) IN ('XH','TH','TG','TF') AND P_NIVEL = 'LI' THEN

        BEGIN

            SELECT EXTRACT(MONTH FROM P_FECHA_NUEVA)MES,
                   EXTRACT(YEAR FROM P_FECHA_NUEVA)AÑO
            INTO VL_COMPLE_MES,VL_ANO_COMPLE
            FROM DUAL;

        EXCEPTION
        WHEN OTHERS THEN
        VL_ERROR:= 'ERROR EN CALCULAR VIGENCIA   '||SQLERRM;
        END;

        DBMS_OUTPUT.PUT_LINE('REZA 8 = '||VL_COMPLE_MES||' = '||VL_ANO_COMPLE||' = '||VL_ERROR);

        IF SUBSTR(P_FECHA_NUEVA,1,2) >= 15 THEN

          VL_COMPLE_MES:=VL_COMPLE_MES+1;

          DBMS_OUTPUT.PUT_LINE('REZA 9 = '||VL_COMPLE_MES);

        END IF;

        BEGIN

            SELECT ZSTPARA_PARAM_VALOR
            INTO VL_MES_REAL
            FROM ZSTPARA
            WHERE ZSTPARA_MAPA_ID = 'COMPL_MES'
            AND ZSTPARA_PARAM_SEC = VL_COMPLE_MES
            ;


        EXCEPTION
        WHEN OTHERS THEN
        NULL;
        END;

        DBMS_OUTPUT.PUT_LINE('REZA 10 = '||VL_MES_REAL);


        IF VL_COMPLE_MES IN (11,12) THEN

            VL_VIGENCIA := TO_DATE('15/'||LPAD(VL_MES_REAL,2,'0')||'/'||(VL_ANO_COMPLE+1),'DD/MM/YYYY');
        ELSE

            VL_VIGENCIA := TO_DATE('15/'||LPAD(VL_MES_REAL,2,'0')||'/'||VL_ANO_COMPLE,'DD/MM/YYYY');

        END IF;

        DBMS_OUTPUT.PUT_LINE('REZA 11 = '||VL_VIGENCIA);

    END IF;

    BEGIN
        SELECT EXTRACT(MONTH FROM VL_VIGENCIA)MES
        INTO VL_VALIDA
        FROM DUAL;
    END;

    IF VL_VALIDA = 2 THEN

        BEGIN
            SELECT  TO_DATE('15/'||
                    LPAD(VL_VALIDA,2,'0')||'/'||
                    (SELECT EXTRACT(YEAR FROM VL_VIGENCIA)AÑO
                     FROM DUAL),'DD/MM/YYYY')
            INTO VL_VIGENCIA
            FROM DUAL;

        END;

    ELSE

        BEGIN

            SELECT  TO_DATE(
                    SUBSTR(X.TZFACCE_EFFECTIVE_DATE,1,2)||'/'||
                    LPAD(VL_VALIDA,2,'0')||'/'||
                    (SELECT EXTRACT(YEAR FROM VL_VIGENCIA)AÑO
                     FROM DUAL),'DD/MM/YYYY')
            INTO VL_VIGENCIA
            FROM DUAL;

        END;

     END IF;

    IF VL_ERROR IS NULL THEN

        UPDATE TZFACCE
        SET TZFACCE_EFFECTIVE_DATE = VL_VIGENCIA,
            TZFACCE_FLAG = 0,
            TZFACCE_TERM_CODE = P_PER_NUEVO
        WHERE  TZFACCE_PIDM = X.TZFACCE_PIDM
        AND TZFACCE_TERM_CODE = X.TZFACCE_TERM_CODE
        AND TZFACCE_DETAIL_CODE = X.TZFACCE_DETAIL_CODE
        AND TZFACCE_SEC_PIDM = X.TZFACCE_SEC_PIDM;


        UPDATE SWTMDAC
        SET SWTMDAC_FLAG = 'Y',
            SWTMDAC_MASTER_IND = 'Y',
            SWTMDAC_EFFECTIVE_DATE_FIN = TO_DATE(VL_VIGENCIA)+30,
            SWTMDAC_APPLICATION_INDICATOR = 0
        WHERE SWTMDAC_PIDM = X.TZFACCE_PIDM
        AND SWTMDAC_DETAIL_CODE_ACC = X.TZFACCE_DETAIL_CODE;



    END IF;

    DBMS_OUTPUT.PUT_LINE('FINAL  <<>> '||VL_VIGENCIA||'---'||VL_ERROR);

  END LOOP;

  IF VL_ERROR IS NULL THEN
     VL_ERROR := 'EXITO';
    COMMIT;
  ELSE
    ROLLBACK;
  END IF;

  RETURN VL_ERROR;

END F_ACTU_TZFACCE;


FUNCTION F_CANCELA_CARTERA (P_PIDM NUMBER,
                            P_PERIODO VARCHAR2,
                            P_FECHA DATE
                            )RETURN VARCHAR2 IS


---------------- Funcion para cancelar cartera en TVAAREV
---------------- e insertar nueva cartera con nuevos parametros
---------------- a solicitud de SZFABCC
---------------- JREZAOLI 20/02/2019

VTRAN_MAX       NUMBER;
VL_MATRICULA    VARCHAR2(11);
VL_ERROR        VARCHAR2(500):= NULL;
VL_PERIODO      VARCHAR2(10);
VL_FECHA_FIN    DATE;
VL_ABCC         NUMBER;

 BEGIN

   BEGIN

       SELECT TBRACCD_TERM_CODE
       INTO VL_PERIODO
       FROM(SELECT TBRACCD_TERM_CODE
            FROM TBRACCD A
            WHERE A.TBRACCD_PIDM = P_PIDM
            --AND A.TBRACCD_TERM_CODE = P_PERIODO
            AND A.TBRACCD_FEED_DATE = P_FECHA
            AND A.TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                        FROM TBBDETC
                                        WHERE TBBDETC_DCAT_CODE = 'COL'
                                        AND SUBSTR (TBBDETC_DETAIL_CODE,1,3) = SUBSTR (P_PERIODO, 1, 2)||'N'
                                        AND TBBDETC_DETC_ACTIVE_IND = 'Y')
            AND TRUNC(A.TBRACCD_ENTRY_DATE) = (SELECT MAX(TRUNC(A1.TBRACCD_ENTRY_DATE))
                                               FROM TBRACCD A1
                                               WHERE A1.TBRACCD_PIDM = A.TBRACCD_PIDM
                                               AND A1.TBRACCD_TERM_CODE = A.TBRACCD_TERM_CODE
                                               AND A1.TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                                                              FROM TBBDETC
                                                                              WHERE TBBDETC_DCAT_CODE = 'COL'
                                                                              AND SUBSTR (TBBDETC_DETAIL_CODE,1,3) = SUBSTR (P_PERIODO, 1, 2)||'N'
                                                                              AND TBBDETC_DETC_ACTIVE_IND = 'Y')
                                               AND A1.TBRACCD_FEED_DATE = A.TBRACCD_FEED_DATE
                                               AND A1.TBRACCD_DOCUMENT_NUMBER IS NULL)
            AND A.TBRACCD_DOCUMENT_NUMBER IS NULL
            AND A.TBRACCD_USER != 'MIGRA_D'
            UNION
            SELECT TBRACCD_TERM_CODE
            FROM TBRACCD A
            WHERE A.TBRACCD_PIDM = P_PIDM
            --AND A.TBRACCD_TERM_CODE = P_PERIODO
            AND A.TBRACCD_RECEIPT_NUMBER in (SELECT TZTORDR_CONTADOR
                                            FROM TZTORDR
                                            WHERE TZTORDR_PIDM = A.TBRACCD_PIDM
                                            AND TZTORDR_FECHA_INICIO = P_FECHA
                                            AND TZTORDR_ESTATUS = 'S'
                                            )
            AND A.TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                    FROM TBBDETC
                                    WHERE TBBDETC_DCAT_CODE = 'COL'
                                    AND SUBSTR (TBBDETC_DETAIL_CODE,1,3) = SUBSTR (P_PERIODO, 1, 2)||'N'
                                    AND TBBDETC_DETC_ACTIVE_IND = 'Y')
            AND A.TBRACCD_DOCUMENT_NUMBER IS NULL
            AND A.TBRACCD_USER = 'MIGRA_D')VALIDA;

   EXCEPTION
   WHEN OTHERS THEN
   VL_PERIODO:= NULL;
   END;

   BEGIN

        SELECT ZSTPARA_PARAM_VALOR
        INTO VL_ABCC
        FROM ZSTPARA
        WHERE 1=1
        AND ZSTPARA_MAPA_ID = 'ABCC_VIG'
        AND ZSTPARA_PARAM_ID = 'GENERAL';

    EXCEPTION
    WHEN OTHERS THEN
    VL_ABCC:=0;
    END;

   IF VL_PERIODO IS NOT NULL THEN


       IF (P_FECHA+360) >= TRUNC(SYSDATE) THEN

         BEGIN

              SELECT SPRIDEN_ID
              INTO VL_MATRICULA
              FROM SPRIDEN
              WHERE SPRIDEN_PIDM = P_PIDM
              AND SPRIDEN_CHANGE_IND IS NULL
              ;
         EXCEPTION
         WHEN OTHERS THEN
         VL_ERROR:= 'ERROR AL RECUPERAR MATRICULA '||SQLERRM;
         END;

         IF VL_ERROR IS NULL THEN

             BEGIN

                UPDATE TZDOCTR
                SET TZDOCTR_IND = 0
                WHERE TZDOCTR_PIDM = P_PIDM
                --AND TZDOCTR_TERM_CODE = P_PERIODO
                AND TZDOCTR_START_DATE = P_FECHA;

             END;

            VL_ERROR:= 'NO EXISTEN TRANSACCIONES A CANCELAR';

            DBMS_OUTPUT.PUT_LINE('INICIA '||P_FECHA);

             BEGIN

                FOR PARCIALIDADES  IN (

                                 SELECT  TBRACCD_PIDM,
                                         TBRACCD_TRAN_NUMBER,
                                         TBRACCD_TERM_CODE,
                                         TBRACCD_DETAIL_CODE,
                                         TBRACCD_AMOUNT,
                                         TBRACCD_BALANCE,
                                         TBRACCD_DESC,
                                         TBRACCD_USER,
                                         TBRACCD_ENTRY_DATE,
                                         TBRACCD_EFFECTIVE_DATE,
                                         TBRACCD_SRCE_CODE,
                                         TBRACCD_ACCT_FEED_IND,
                                         TBRACCD_ACTIVITY_DATE,
                                         TBRACCD_SESSION_NUMBER,
                                         TBRACCD_SURROGATE_ID,
                                         TBRACCD_VERSION,
                                         TBRACCD_STSP_KEY_SEQUENCE,
                                         TBRACCD_PERIOD,
                                         TBRACCD_FEED_DATE,
                                         TBRACCD_RECEIPT_NUMBER
                                FROM TBRACCD A
                                WHERE A.TBRACCD_PIDM = P_PIDM
                                --AND A.TBRACCD_TERM_CODE = P_PERIODO
                                AND A.TBRACCD_FEED_DATE = P_FECHA
                                AND A.TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                                            FROM TBBDETC
                                                            WHERE TBBDETC_DCAT_CODE = 'COL'
                                                            AND SUBSTR (TBBDETC_DETAIL_CODE,1,3) = SUBSTR (P_PERIODO, 1, 2)||'N'
                                                            AND TBBDETC_DETC_ACTIVE_IND = 'Y')
                                AND TRUNC(A.TBRACCD_ENTRY_DATE) = (SELECT MAX(TRUNC(A1.TBRACCD_ENTRY_DATE))
                                                                   FROM TBRACCD A1
                                                                   WHERE A1.TBRACCD_PIDM = A.TBRACCD_PIDM
                                                                   AND A1.TBRACCD_TERM_CODE = A.TBRACCD_TERM_CODE
                                                                   AND A1.TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                                                                                  FROM TBBDETC
                                                                                                  WHERE TBBDETC_DCAT_CODE = 'COL'
                                                                                                  AND SUBSTR (TBBDETC_DETAIL_CODE,1,3) = SUBSTR (P_PERIODO, 1, 2)||'N'
                                                                                                  AND TBBDETC_DETC_ACTIVE_IND = 'Y')
                                                                   AND A1.TBRACCD_FEED_DATE = A.TBRACCD_FEED_DATE
                                                                   AND A1.TBRACCD_DOCUMENT_NUMBER IS NULL)
                                AND A.TBRACCD_DOCUMENT_NUMBER IS NULL
                                AND A.TBRACCD_USER != 'MIGRA_D'
                                UNION
                                SELECT TBRACCD_PIDM,
                                       TBRACCD_TRAN_NUMBER,
                                       TBRACCD_TERM_CODE,
                                       TBRACCD_DETAIL_CODE,
                                       TBRACCD_AMOUNT,
                                       TBRACCD_BALANCE,
                                       TBRACCD_DESC,
                                       TBRACCD_USER,
                                       TBRACCD_ENTRY_DATE,
                                       TBRACCD_EFFECTIVE_DATE,
                                       TBRACCD_SRCE_CODE,
                                       TBRACCD_ACCT_FEED_IND,
                                       TBRACCD_ACTIVITY_DATE,
                                       TBRACCD_SESSION_NUMBER,
                                       TBRACCD_SURROGATE_ID,
                                       TBRACCD_VERSION,
                                       TBRACCD_STSP_KEY_SEQUENCE,
                                       TBRACCD_PERIOD,
                                       TBRACCD_FEED_DATE,
                                       TBRACCD_RECEIPT_NUMBER
                                FROM TBRACCD A
                                WHERE A.TBRACCD_PIDM = P_PIDM
                                --AND A.TBRACCD_TERM_CODE = P_PERIODO
                                AND A.TBRACCD_RECEIPT_NUMBER in (SELECT TZTORDR_CONTADOR
                                                                FROM TZTORDR
                                                                WHERE TZTORDR_PIDM = A.TBRACCD_PIDM
                                                                AND TZTORDR_FECHA_INICIO = P_FECHA
                                                                AND TZTORDR_ESTATUS = 'S'
                                                                )
                                AND A.TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                                        FROM TBBDETC
                                                        WHERE TBBDETC_DCAT_CODE = 'COL'
                                                        AND SUBSTR (TBBDETC_DETAIL_CODE,1,3) = SUBSTR (P_PERIODO, 1, 2)||'N'
                                                        AND TBBDETC_DETC_ACTIVE_IND = 'Y')
                                AND A.TBRACCD_DOCUMENT_NUMBER IS NULL
                                AND A.TBRACCD_USER = 'MIGRA_D'


                )LOOP

                  DBMS_OUTPUT.PUT_LINE('1');

                  VL_ERROR:= NULL;

                  BEGIN
                    UPDATE TBRACCD
                       SET TBRACCD_TRAN_NUMBER_PAID = NULL
                    WHERE     TBRACCD_PIDM = PARCIALIDADES.TBRACCD_PIDM
                          AND TBRACCD_TRAN_NUMBER_PAID = PARCIALIDADES.TBRACCD_TRAN_NUMBER;
                  END;

                  BEGIN

                    SELECT MAX(TBRACCD_TRAN_NUMBER)+1
                    INTO  VTRAN_MAX
                    FROM TBRACCD
                    WHERE TBRACCD_PIDM = PARCIALIDADES.TBRACCD_PIDM ;

                  END;

                  DBMS_OUTPUT.PUT_LINE('2');
                    -------------------este es la desaplicacion de pagos--------

                 PKG_FINANZAS.P_DESAPLICA_PAGOS (PARCIALIDADES.TBRACCD_PIDM, PARCIALIDADES.TBRACCD_TRAN_NUMBER);

                  BEGIN

                        INSERT
                        INTO TBRACCD
                             (TBRACCD_PIDM,
                              TBRACCD_TRAN_NUMBER,
                              TBRACCD_TERM_CODE,
                              TBRACCD_DETAIL_CODE,
                              TBRACCD_AMOUNT,
                              TBRACCD_BALANCE,
                              TBRACCD_DESC,
                              TBRACCD_USER,
                              TBRACCD_ENTRY_DATE,
                              TBRACCD_EFFECTIVE_DATE,
                              TBRACCD_TRANS_DATE,
                              TBRACCD_SRCE_CODE,
                              TBRACCD_ACCT_FEED_IND,
                              TBRACCD_ACTIVITY_DATE,
                              TBRACCD_SESSION_NUMBER,
                              TBRACCD_SURROGATE_ID,
                              TBRACCD_VERSION,
                              TBRACCD_TRAN_NUMBER_PAID,
                              TBRACCD_FEED_DATE,
                              TBRACCD_STSP_KEY_SEQUENCE,
                              TBRACCD_DATA_ORIGIN,
                              TBRACCD_PERIOD,
                              TBRACCD_RECEIPT_NUMBER  )
                         VALUES(PARCIALIDADES.TBRACCD_PIDM,
                                VTRAN_MAX,
                                PARCIALIDADES.TBRACCD_TERM_CODE ,
                                SUBSTR(PARCIALIDADES.TBRACCD_TERM_CODE,1,2)||'EZ',
                                PARCIALIDADES.TBRACCD_AMOUNT,
                                PARCIALIDADES.TBRACCD_AMOUNT*-1 ,
                                'CANCELACION DE COLEGIATURA',
                                USER,
                                SYSDATE,
                                SYSDATE,
                                SYSDATE,
                                PARCIALIDADES.TBRACCD_SRCE_CODE,
                                PARCIALIDADES.TBRACCD_ACCT_FEED_IND,
                                PARCIALIDADES.TBRACCD_ACTIVITY_DATE,
                                0,
                                NULL,
                                NULL,
                                PARCIALIDADES.TBRACCD_TRAN_NUMBER,
                                PARCIALIDADES.TBRACCD_FEED_DATE,
                                PARCIALIDADES.TBRACCD_STSP_KEY_SEQUENCE,
                                'CAN_ABC',
                                PARCIALIDADES.TBRACCD_PERIOD,
                                PARCIALIDADES.TBRACCD_RECEIPT_NUMBER  );

                                DBMS_OUTPUT.PUT_LINE('3');

                  END;

                  BEGIN

                       INSERT
                       INTO TBRAPPL
                       VALUES (
                                PARCIALIDADES.TBRACCD_PIDM,               --TBRAPPL_PIDM
                                VTRAN_MAX,               --TBRAPPL_PAY_TRAN_NUMBER
                                PARCIALIDADES.TBRACCD_TRAN_NUMBER,               --TBRAPPL_CHG_TRAN_NUMBER
                                PARCIALIDADES.TBRACCD_AMOUNT ,              --TBRAPPL_AMOUNT
                                NULL,             --TBRAPPL_DIRECT_PAY_IND
                                NULL,              --TBRAPPL_REAPPL_IND
                                USER,              --TBRAPPL_USER
                                'Y',              --TBRAPPL_ACCT_FEED_IND
                                SYSDATE,              --TBRAPPL_ACTIVITY_DATE
                                NULL,              --TBRAPPL_FEED_DATE
                                'Y',              --TBRAPPL_FEED_DOC_CODE
                                NULL,              --TBRAPPL_CPDT_TRAN_NUMBER
                                NULL,                 --TBRAPPL_DIRECT_PAY_TYPE
                                NULL,        ---TBRAPPL_INV_NUMBER_PAID
                                NULL,            --TBRAPPL_SURROGATE_ID
                                NULL,             --TBRAPPL_VERSION
                                NULL,             --TBRAPPL_USER_ID
                                'SZFABCC',          --TBRAPPL_DATA_ORIGIN
                                NULL                ---TBRAPPL_VPDI_CODE
                                );

                                DBMS_OUTPUT.PUT_LINE('4');
                  EXCEPTION
                  WHEN OTHERS THEN
                  VL_ERROR :=' Errror al insertar tbrappl>>  ' || SQLERRM ;
                  END;

                  BEGIN

                         UPDATE TBRACCD
                         SET TBRACCD_BALANCE = 0,
                             TBRACCD_DOCUMENT_NUMBER = 'CAN_ABC',
                             TBRACCD_ACTIVITY_DATE = SYSDATE
                         WHERE TBRACCD_PIDM = PARCIALIDADES.TBRACCD_PIDM
                         AND TBRACCD_TRAN_NUMBER = VTRAN_MAX;

                  EXCEPTION
                  WHEN OTHERS THEN
                  VL_ERROR :=' Errror al actualizar saldo Pago>>  ' || SQLERRM ;
                  END;

                  BEGIN
                           UPDATE TBRACCD
                           SET TBRACCD_BALANCE = 0,
                               TBRACCD_TRAN_NUMBER_PAID = NULL,
                               TBRACCD_DOCUMENT_NUMBER = 'CAN_ABC',
                               TBRACCD_ACTIVITY_DATE  = SYSDATE
                           WHERE TBRACCD_PIDM = PARCIALIDADES.TBRACCD_PIDM
                           AND TBRACCD_TRAN_NUMBER = PARCIALIDADES.TBRACCD_TRAN_NUMBER;
                  EXCEPTION
                  WHEN OTHERS THEN
                  VL_ERROR :=' Errror al actualizar saldo Saldo de la COL ANTERIOR >>  ' || SQLERRM ;
                  END;

                END LOOP;

             END;

         END IF;

       ELSE

       VL_ERROR:= 'No se aplican ajustes, fecha milite para cambios = ';

       END IF;



   ELSE

   VL_ERROR:= 'NO EXISTEN TRANSACCIONES A CANCELAR';

   END IF;

   IF VL_ERROR IS NULL THEN

        PKG_FINANZAS.P_GEN_CART_CONF ( 'REPROCESO', P_FECHA, VL_MATRICULA, NULL, NULL );

        VL_ERROR:= 'EXITO';

        BEGIN
          DELETE GORADID
           WHERE     GORADID_ADID_CODE = 'UTLX' AND GORADID_PIDM = P_PIDM;
        END;

        COMMIT;

   ELSIF VL_ERROR = 'NO EXISTEN TRANSACCIONES A CANCELAR' THEN

        BEGIN
          DELETE GORADID
           WHERE     GORADID_ADID_CODE = 'UTLX' AND GORADID_PIDM = P_PIDM;
        END;

        COMMIT;

   ELSIF VL_ERROR = 'No se aplican ajustes, fecha milite para cambios = '||VL_FECHA_FIN THEN

         COMMIT;

   ELSE
         ROLLBACK;

   END IF;
   DBMS_OUTPUT.PUT_LINE(VL_ERROR);
   RETURN VL_ERROR;

 END;


FUNCTION F_VALIDA_RECARTERA (P_MATRICULA VARCHAR2, P_FECHA DATE, P_JORNADA VARCHAR2, P_RATE VARCHAR2) RETURN VARCHAR2

IS

---------------- Funcion para validar si existe regla de cobro
---------------- antes de actualizar datos del alumno
---------------- a solicitud de SZFABCC
---------------- JREZAOLI 20/02/2019

VC_JORNADA VARCHAR2(6);
VL_ERROR VARCHAR2(500);
VL_CADENAERROR VARCHAR2(500);
VL_CODIGO VARCHAR2(6);
VL_DESCRIPCION VARCHAR2(35);
VL_MONTO FLOAT;
VL_SFRRGFE_RATE_CODE VARCHAR2(5);
VL_VALIDA NUMBER:= 0;
VL_MAT_BAJA NUMBER;

 BEGIN


    BEGIN


     FOR ALUMNO IN (

                SELECT DISTINCT D.SPRIDEN_ID MATRICULA,
                       A.SORLCUR_PIDM PIDM,
                       A.SORLCUR_PROGRAM PROGRAMA,
                       E.SZTDTEC_PROGRAMA_COMP PROGRAMA_DESC,
                       B.SGBSTDN_STST_CODE ESTATUS,
                       B.SGBSTDN_STYP_CODE TIPO_ALUMNO,
                       B.SGBSTDN_CAMP_CODE CAMPUS,
                       B.SGBSTDN_LEVL_CODE NIVEL,
                       F.SFRSTCR_TERM_CODE PERIODO,
                       G.SSBSECT_PTRM_START_DATE FECHA_INICIO,
                       NULL PARTE_PERIODO,
                       A.SORLCUR_KEY_SEQNO STUDY_PATH,
                       CASE SUBSTR (B.SGBSTDN_RATE_CODE, 1, 1)
                             WHEN  ('P') THEN SUBSTR (B.SGBSTDN_RATE_CODE, 2, 2)
                             WHEN  ('C') THEN SUBSTR (B.SGBSTDN_RATE_CODE, 3, 1)-- Se agrega
                             WHEN  ('J') THEN SUBSTR (B.SGBSTDN_RATE_CODE, 3, 1)
                       END  NUM_PAGOS,
                      (DECODE (SUBSTR (B.SGBSTDN_RATE_CODE, 4, 1), 'A', 15, 'B', '30', 'C', '10')) VENCIMIENTO,
                       SUBSTR (B.SGBSTDN_RATE_CODE, 1, 1) TIPO_PAGO,
                       B.SGBSTDN_RATE_CODE RATE,
                       DECODE (E.SZTDTEC_PERIODICIDAD, 1, 'Bime', 2, 'Cuatri', 3, 'Semes', 4, 'Anual') PERIODICIDAD,
                      (SELECT DISTINCT SORLCUR_SITE_CODE
                       FROM SORLCUR CUR
                       WHERE CUR.SORLCUR_PIDM = A.SORLCUR_PIDM
                       AND CUR.SORLCUR_LMOD_CODE = 'ADMISSIONS'
                       AND CUR.SORLCUR_SEQNO = (SELECT MAX (SORLCUR_SEQNO)
                                               FROM SORLCUR CUR2
                                               WHERE CUR2.SORLCUR_PIDM = CUR.SORLCUR_PIDM
                                               AND CUR2.SORLCUR_LMOD_CODE = CUR.SORLCUR_LMOD_CODE))PRE_ACTUALIZADO,
                       DECODE (A.SORLCUR_DEGC_CODE, 'DIPL', 'COLEGIATURA DIPLOMADO', 'CURS', 'COLEGIATURA CURSO')DEGC_CODE,
                       (SELECT DISTINCT SORLCUR_START_DATE
                          FROM SORLCUR CUR
                          WHERE CUR.SORLCUR_PIDM = A.SORLCUR_PIDM
                          AND CUR.SORLCUR_LMOD_CODE = 'LEARNER'
                          AND CUR.SORLCUR_ROLL_IND = 'Y'
                          AND CUR.SORLCUR_CACT_CODE = 'ACTIVE' --Va?
                          AND CUR.SORLCUR_SEQNO = (SELECT MAX (A1.SORLCUR_SEQNO)
                                                   FROM SORLCUR A1
                                                   WHERE A1.SORLCUR_PIDM = CUR.SORLCUR_PIDM
                                                   AND A1.SORLCUR_ROLL_IND  = CUR.SORLCUR_ROLL_IND
                                                   AND A1.SORLCUR_CACT_CODE = CUR.SORLCUR_CACT_CODE
                                                   AND A1.SORLCUR_LMOD_CODE = CUR.SORLCUR_LMOD_CODE))FECHA_SGASTDN,
                      'MATERIAS' VALIDA
                 FROM SORLCUR A, SGBSTDN B, SPRIDEN D, SFRSTCR F, SSBSECT G, SZTDTEC E
                 WHERE A.SORLCUR_LMOD_CODE = 'LEARNER'
                 AND A.SORLCUR_ROLL_IND  = 'Y'
                 AND A.SORLCUR_CACT_CODE = 'ACTIVE' --Va?
                 AND A.SORLCUR_SEQNO = (SELECT MAX (A1.SORLCUR_SEQNO)
                                       FROM SORLCUR A1
                                       WHERE A1.SORLCUR_PIDM = A.SORLCUR_PIDM
                                       AND A1.SORLCUR_ROLL_IND  = A.SORLCUR_ROLL_IND
                                       AND A1.SORLCUR_CACT_CODE = A.SORLCUR_CACT_CODE
                                       AND A1.SORLCUR_PROGRAM = A.SORLCUR_PROGRAM
                                       AND A1.SORLCUR_LMOD_CODE = A.SORLCUR_LMOD_CODE)
                 AND A.SORLCUR_PIDM =  B.SGBSTDN_PIDM
                 AND A.SORLCUR_PROGRAM = B.SGBSTDN_PROGRAM_1
                 AND B.SGBSTDN_TERM_CODE_EFF IN (SELECT MAX (B1.SGBSTDN_TERM_CODE_EFF)
                                                 FROM SGBSTDN B1
                                                 WHERE B.SGBSTDN_PIDM = B1.SGBSTDN_PIDM
                                                 AND B.SGBSTDN_PROGRAM_1 = B1.SGBSTDN_PROGRAM_1)
                 AND E.SZTDTEC_PROGRAM = B.SGBSTDN_PROGRAM_1
                 AND A.SORLCUR_TERM_CODE_CTLG = E.SZTDTEC_TERM_CODE
                 AND D.SPRIDEN_PIDM = SGBSTDN_PIDM
                 AND D.SPRIDEN_CHANGE_IND IS NULL
                 AND F.SFRSTCR_PIDM = A.SORLCUR_PIDM
                 AND F.SFRSTCR_RSTS_CODE IN ('RE')
                 AND F.SFRSTCR_STSP_KEY_SEQUENCE = A.SORLCUR_KEY_SEQNO
                 AND F.SFRSTCR_TERM_CODE = G.SSBSECT_TERM_CODE
                 AND SUBSTR(F.SFRSTCR_TERM_CODE,5,2) NOT IN (81,82,83,90)
                 AND F.SFRSTCR_CRN = G.SSBSECT_CRN
                 AND F.SFRSTCR_PTRM_CODE = G.SSBSECT_PTRM_CODE
                 AND TRUNC (G.SSBSECT_PTRM_START_DATE)  = P_FECHA
                 AND D.SPRIDEN_ID = P_MATRICULA
                 UNION
                 SELECT DISTINCT D.SPRIDEN_ID MATRICULA,
                         A.SORLCUR_PIDM PIDM,
                         A.SORLCUR_PROGRAM PROGRAMA,
                         E.SZTDTEC_PROGRAMA_COMP PROGRAMA_DESC,
                         B.SGBSTDN_STST_CODE ESTATUS,
                         B.SGBSTDN_STYP_CODE TIPO_ALUMNO,
                         B.SGBSTDN_CAMP_CODE CAMPUS,
                         B.SGBSTDN_LEVL_CODE NIVEL,
                       --  b.SGBSTDN_CAMP_CODE,
                         B.SGBSTDN_TERM_CODE_EFF PERIODO,
                         A.SORLCUR_START_DATE FECHA_INICIO,
                         NULL PARTE_PERIODO,
                         A.SORLCUR_KEY_SEQNO STUDY_PATH,
                         CASE SUBSTR (B.SGBSTDN_RATE_CODE, 1, 1)
                              WHEN  ('P') THEN SUBSTR (B.SGBSTDN_RATE_CODE, 2, 2)
                              WHEN  ('C') THEN SUBSTR (B.SGBSTDN_RATE_CODE, 3, 1)-- Se agrega
                              WHEN  ('J') THEN SUBSTR (B.SGBSTDN_RATE_CODE, 3, 1)
                         END  NUM_PAGOS,
                        (DECODE (SUBSTR (B.SGBSTDN_RATE_CODE, 4, 1), 'A', 15, 'B', '30', 'C', '10')) VENCIMIENTO,
                         SUBSTR (B.SGBSTDN_RATE_CODE, 1, 1) TIPO_PAGO,
                          B.SGBSTDN_RATE_CODE RATE,
                          DECODE (E.SZTDTEC_PERIODICIDAD, 1, 'Bime', 2, 'Cuatri', 3, 'Semes', 4, 'Anual') PERIODICIDAD,
                         (SELECT DISTINCT SORLCUR_SITE_CODE
                          FROM SORLCUR CUR
                          WHERE CUR.SORLCUR_PIDM = A.SORLCUR_PIDM
                          AND CUR.SORLCUR_LMOD_CODE = 'ADMISSIONS'
                       AND CUR.SORLCUR_SEQNO = (SELECT MAX (SORLCUR_SEQNO)
                                               FROM SORLCUR CUR2
                                               WHERE CUR2.SORLCUR_PIDM = CUR.SORLCUR_PIDM
                                               AND CUR2.SORLCUR_LMOD_CODE = CUR.SORLCUR_LMOD_CODE)
                                                           )PRE_ACTUALIZADO,
                          DECODE (A.SORLCUR_DEGC_CODE, 'DIPL', 'COLEGIATURA DIPLOMADO', 'CURS', 'COLEGIATURA CURSO')DEGC_CODE,
                          (SELECT DISTINCT SORLCUR_START_DATE
                          FROM SORLCUR CUR
                          WHERE CUR.SORLCUR_PIDM = A.SORLCUR_PIDM
                          AND CUR.SORLCUR_LMOD_CODE = 'LEARNER'
                          AND CUR.SORLCUR_ROLL_IND = 'Y'
                          AND CUR.SORLCUR_CACT_CODE = 'ACTIVE' --Va?
                          AND CUR.SORLCUR_SEQNO = (SELECT MAX (A1.SORLCUR_SEQNO)
                                                   FROM SORLCUR A1
                                                   WHERE A1.SORLCUR_PIDM = CUR.SORLCUR_PIDM
                                                   AND A1.SORLCUR_ROLL_IND  = CUR.SORLCUR_ROLL_IND
                                                   AND A1.SORLCUR_CACT_CODE = CUR.SORLCUR_CACT_CODE
                                                   AND A1.SORLCUR_PROGRAM = CUR.SORLCUR_PROGRAM
                                                   AND A1.SORLCUR_LMOD_CODE = CUR.SORLCUR_LMOD_CODE))FECHA_SGASTDN,
                       NULL VALIDA
                 FROM SORLCUR A, SGBSTDN B, SPRIDEN D, SZTDTEC E
                 WHERE A.SORLCUR_LMOD_CODE = 'LEARNER'
                 AND A.SORLCUR_ROLL_IND  = 'Y'
                 AND A.SORLCUR_CACT_CODE = 'ACTIVE' --Va?
                 AND A.SORLCUR_SEQNO = (SELECT MAX (A1.SORLCUR_SEQNO)
                                        FROM SORLCUR A1
                                        WHERE A1.SORLCUR_PIDM = A.SORLCUR_PIDM
                                        AND A1.SORLCUR_ROLL_IND  = A.SORLCUR_ROLL_IND
                                        AND A1.SORLCUR_CACT_CODE = A.SORLCUR_CACT_CODE
                                        AND A1.SORLCUR_PROGRAM = A.SORLCUR_PROGRAM
                                        AND A1.SORLCUR_LMOD_CODE = A.SORLCUR_LMOD_CODE)
                 AND A.SORLCUR_PIDM =  B.SGBSTDN_PIDM
                 AND A.SORLCUR_PROGRAM = B.SGBSTDN_PROGRAM_1
                 AND B.SGBSTDN_TERM_CODE_EFF IN (SELECT MAX (B1.SGBSTDN_TERM_CODE_EFF)
                                                  FROM SGBSTDN B1
                                                  WHERE B.SGBSTDN_PIDM = B1.SGBSTDN_PIDM
                                                  AND B.SGBSTDN_PROGRAM_1 = B1.SGBSTDN_PROGRAM_1)
                AND E.SZTDTEC_PROGRAM = B.SGBSTDN_PROGRAM_1
                AND A.SORLCUR_TERM_CODE_CTLG = E.SZTDTEC_TERM_CODE
                AND D.SPRIDEN_PIDM = SGBSTDN_PIDM
                AND D.SPRIDEN_CHANGE_IND IS NULL
                AND A.SORLCUR_START_DATE = P_FECHA
                AND D.SPRIDEN_ID = P_MATRICULA
                AND A.SORLCUR_PIDM NOT IN (SELECT DISTINCT AA.SORLCUR_PIDM
                                             FROM SORLCUR AA, SGBSTDN B, SPRIDEN D, SFRSTCR F, SSBSECT G, SZTDTEC E
                                             WHERE AA.SORLCUR_LMOD_CODE = 'LEARNER'
                                             AND AA.SORLCUR_ROLL_IND  = 'Y'
                                             AND AA.SORLCUR_CACT_CODE = 'ACTIVE' --Va?
                                             AND AA.SORLCUR_SEQNO = (SELECT MAX (A1.SORLCUR_SEQNO)
                                                                   FROM SORLCUR A1
                                                                   WHERE A1.SORLCUR_PIDM = AA.SORLCUR_PIDM
                                                                   AND A1.SORLCUR_ROLL_IND  = AA.SORLCUR_ROLL_IND
                                                                   AND A1.SORLCUR_CACT_CODE = AA.SORLCUR_CACT_CODE
                                                                   AND A1.SORLCUR_PROGRAM = AA.SORLCUR_PROGRAM
                                                                   AND A1.SORLCUR_LMOD_CODE = AA.SORLCUR_LMOD_CODE)
                                             AND AA.SORLCUR_PIDM =  B.SGBSTDN_PIDM
                                             AND AA.SORLCUR_PROGRAM = B.SGBSTDN_PROGRAM_1
                                             AND B.SGBSTDN_TERM_CODE_EFF IN (SELECT MAX (B1.SGBSTDN_TERM_CODE_EFF)
                                                                             FROM SGBSTDN B1
                                                                             WHERE B.SGBSTDN_PIDM = B1.SGBSTDN_PIDM
                                                                             AND B.SGBSTDN_PROGRAM_1 = B1.SGBSTDN_PROGRAM_1)
                                             AND E.SZTDTEC_PROGRAM = B.SGBSTDN_PROGRAM_1
                                             AND A.SORLCUR_TERM_CODE_CTLG = E.SZTDTEC_TERM_CODE
                                             AND D.SPRIDEN_PIDM = SGBSTDN_PIDM
                                             AND D.SPRIDEN_CHANGE_IND IS NULL
                                             AND F.SFRSTCR_PIDM = AA.SORLCUR_PIDM
                                             AND F.SFRSTCR_RSTS_CODE IN ('RE','DD')
                                             AND F.SFRSTCR_STSP_KEY_SEQUENCE = AA.SORLCUR_KEY_SEQNO
                                             AND F.SFRSTCR_TERM_CODE = G.SSBSECT_TERM_CODE
                                             AND SUBSTR(F.SFRSTCR_TERM_CODE,5,2) NOT IN (81,82,83,90)
                                             AND F.SFRSTCR_CRN = G.SSBSECT_CRN
                                             AND F.SFRSTCR_PTRM_CODE = G.SSBSECT_PTRM_CODE
                                             AND TRUNC (G.SSBSECT_PTRM_START_DATE)  = P_FECHA
                                             AND D.SPRIDEN_ID = P_MATRICULA)

                ORDER BY 1, 8, 9

        ) LOOP

          IF P_JORNADA IS NULL AND P_RATE IS NULL THEN

              BEGIN

                    SELECT T.SGRSATT_ATTS_CODE
                    INTO  VC_JORNADA
                    FROM SGRSATT T
                    WHERE T.SGRSATT_PIDM = ALUMNO.PIDM
                    AND T.SGRSATT_STSP_KEY_SEQUENCE = ALUMNO.STUDY_PATH
                    AND SUBSTR(T.SGRSATT_TERM_CODE_EFF,5,2) NOT IN (81,82,83,90)
                    AND REGEXP_LIKE  (T.SGRSATT_ATTS_CODE , '^[0-9]')
                    AND T.SGRSATT_TERM_CODE_EFF = ( SELECT MAX(SGRSATT_TERM_CODE_EFF)
                                                       FROM SGRSATT TT
                                                       WHERE  TT.SGRSATT_PIDM =  T.SGRSATT_PIDM
                                                       AND  TT.SGRSATT_STSP_KEY_SEQUENCE= T.SGRSATT_STSP_KEY_SEQUENCE
                                                       AND SUBSTR(TT.SGRSATT_TERM_CODE_EFF,5,2) NOT IN (81,82,83,90)
                                                       AND REGEXP_LIKE  (TT.SGRSATT_ATTS_CODE , '^[0-9]'))
                    AND T.SGRSATT_ACTIVITY_DATE = (SELECT MAX(SGRSATT_ACTIVITY_DATE)
                                                   FROM SGRSATT T1
                                                   WHERE T1.SGRSATT_PIDM = T.SGRSATT_PIDM
                                                   AND T1.SGRSATT_STSP_KEY_SEQUENCE = T.SGRSATT_STSP_KEY_SEQUENCE
                                                   AND T1.SGRSATT_TERM_CODE_EFF = T.SGRSATT_TERM_CODE_EFF
                                                   AND SUBSTR(T1.SGRSATT_TERM_CODE_EFF,5,2) NOT IN (81,82,83,90)
                                                   AND REGEXP_LIKE  (T1.SGRSATT_ATTS_CODE , '^[0-9]'))
                                                   ;

              EXCEPTION
              WHEN OTHERS THEN
              VC_JORNADA:=NULL;
              VL_ERROR :='Error al buscar la Jornada en SGASADD: ';
              VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;
              END;


              IF  ALUMNO.FECHA_INICIO = ALUMNO.FECHA_SGASTDN THEN

                  IF VL_ERROR IS NULL THEN

                    VL_ERROR:='EXITO';


                      IF alumno.PRE_ACTUALIZADO IS NOT NULL THEN


                        BEGIN

                                SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                                INTO VL_CODIGO, VL_DESCRIPCION, VL_MONTO,  VL_SFRRGFE_RATE_CODE
                                FROM SFRRGFE A , TBBDETC
                                WHERE TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                                AND  A.SFRRGFE_TERM_CODE= ALUMNO.PERIODO
                                AND A.SFRRGFE_TYPE = 'STUDENT'
                                AND SFRRGFE_ENTRY_TYPE = 'R'
                                AND A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                                AND A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                                AND A.SFRRGFE_ATTS_CODE = VC_JORNADA--ALUMNO.JORNADA
                                AND A.SFRRGFE_RATE_CODE = ALUMNO.RATE
                                AND A.SFRRGFE_DEPT_CODE = ALUMNO.PRE_ACTUALIZADO
                                AND A.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA
                                AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                                      FROM SFRRGFE A1
                                                      WHERE A1.SFRRGFE_TERM_CODE = A.SFRRGFE_TERM_CODE
                                                      AND A1.SFRRGFE_TYPE = A.SFRRGFE_TYPE
                                                      AND A1.SFRRGFE_ENTRY_TYPE = A.SFRRGFE_ENTRY_TYPE
                                                      AND A1.SFRRGFE_LEVL_CODE = A.SFRRGFE_LEVL_CODE
                                                      AND A1.SFRRGFE_CAMP_CODE = A.SFRRGFE_CAMP_CODE
                                                      AND A1.SFRRGFE_ATTS_CODE = A.SFRRGFE_ATTS_CODE
                                                      AND A1.SFRRGFE_RATE_CODE = A.SFRRGFE_RATE_CODE
                                                      AND A1.SFRRGFE_DEPT_CODE = A.SFRRGFE_DEPT_CODE
                                                      AND A1.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA);

                        EXCEPTION
                        WHEN NO_DATA_FOUND THEN

                            BEGIN

                                SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                                INTO VL_CODIGO, VL_DESCRIPCION, VL_MONTO,  VL_SFRRGFE_RATE_CODE
                                FROM SFRRGFE A , TBBDETC
                                WHERE TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                                AND  A.SFRRGFE_TERM_CODE= ALUMNO.PERIODO
                                AND A.SFRRGFE_TYPE = 'STUDENT'
                                AND SFRRGFE_ENTRY_TYPE = 'R'
                                AND A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                                AND A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                                AND A.SFRRGFE_ATTS_CODE = VC_JORNADA--ALUMNO.JORNADA
                                AND A.SFRRGFE_RATE_CODE = ALUMNO.RATE
                                AND A.SFRRGFE_DEPT_CODE = ALUMNO.PRE_ACTUALIZADO
                                AND A.SFRRGFE_PROGRAM IS NULL
                                AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                                      FROM SFRRGFE A1
                                                      WHERE A1.SFRRGFE_TERM_CODE = A.SFRRGFE_TERM_CODE
                                                      AND A1.SFRRGFE_TYPE = A.SFRRGFE_TYPE
                                                      AND A1.SFRRGFE_ENTRY_TYPE = A.SFRRGFE_ENTRY_TYPE
                                                      AND A1.SFRRGFE_LEVL_CODE = A.SFRRGFE_LEVL_CODE
                                                      AND A1.SFRRGFE_CAMP_CODE = A.SFRRGFE_CAMP_CODE
                                                      AND A1.SFRRGFE_ATTS_CODE = A.SFRRGFE_ATTS_CODE
                                                      AND A1.SFRRGFE_RATE_CODE = A.SFRRGFE_RATE_CODE
                                                      AND A1.SFRRGFE_DEPT_CODE = A.SFRRGFE_DEPT_CODE
                                                      AND A1.SFRRGFE_PROGRAM IS NULL);

                            EXCEPTION
                            WHEN OTHERS THEN
                              VL_ERROR :='Validar Regla de Cobro, Parametros xxxxx= '||ALUMNO.PERIODO||'  -  '||NVL(VC_JORNADA,'SIN JORNADA')||'  -  '||ALUMNO.RATE;
                              VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;
                              VL_CODIGO := NULL;
                              VL_DESCRIPCION := NULL;
                              VL_MONTO := NULL;
                            END;

                        END;


                      ELSIF alumno.PRE_ACTUALIZADO IS  NULL THEN


                        BEGIN

                            SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                            INTO VL_CODIGO, VL_DESCRIPCION, VL_MONTO,  VL_SFRRGFE_RATE_CODE
                            FROM SFRRGFE A , TBBDETC
                            WHERE TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                            AND  A.SFRRGFE_TERM_CODE = ALUMNO.PERIODO
                            AND A.SFRRGFE_TYPE = 'STUDENT'
                            AND SFRRGFE_ENTRY_TYPE = 'R'
                            AND A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                            AND A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                            AND A.SFRRGFE_ATTS_CODE = VC_JORNADA--ALUMNO.JORNADA
                            AND A.SFRRGFE_RATE_CODE = ALUMNO.RATE
                            AND A.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA
                            AND A.SFRRGFE_DEPT_CODE IS NULL
                            AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                                  FROM SFRRGFE A1
                                                  WHERE A1.SFRRGFE_TERM_CODE = A.SFRRGFE_TERM_CODE
                                                  AND A1.SFRRGFE_TYPE = A.SFRRGFE_TYPE
                                                  AND A1.SFRRGFE_ENTRY_TYPE = A.SFRRGFE_ENTRY_TYPE
                                                  AND A1.SFRRGFE_LEVL_CODE = A.SFRRGFE_LEVL_CODE
                                                  AND A1.SFRRGFE_CAMP_CODE = A.SFRRGFE_CAMP_CODE
                                                  AND A1.SFRRGFE_ATTS_CODE = A.SFRRGFE_ATTS_CODE
                                                  AND A1.SFRRGFE_RATE_CODE = A.SFRRGFE_RATE_CODE
                                                  AND A1.SFRRGFE_DEPT_CODE IS NULL
                                                  AND A1.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA);
                        EXCEPTION
                        WHEN OTHERS THEN

                            BEGIN

                                SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                                INTO VL_CODIGO, VL_DESCRIPCION, VL_MONTO,  VL_SFRRGFE_RATE_CODE
                                FROM SFRRGFE A , TBBDETC
                                WHERE TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                                AND  A.SFRRGFE_TERM_CODE= ALUMNO.PERIODO
                                AND A.SFRRGFE_TYPE = 'STUDENT'
                                AND SFRRGFE_ENTRY_TYPE = 'R'
                                AND A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                                AND A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                                AND A.SFRRGFE_ATTS_CODE = VC_JORNADA--ALUMNO.JORNADA
                                AND A.SFRRGFE_RATE_CODE = ALUMNO.RATE
                                AND A.SFRRGFE_DEPT_CODE IS NULL
                                AND A.SFRRGFE_PROGRAM IS NULL
                                AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                                      FROM SFRRGFE A1
                                                      WHERE A1.SFRRGFE_TERM_CODE = A.SFRRGFE_TERM_CODE
                                                      AND A1.SFRRGFE_TYPE = A.SFRRGFE_TYPE
                                                      AND A1.SFRRGFE_ENTRY_TYPE = A.SFRRGFE_ENTRY_TYPE
                                                      AND A1.SFRRGFE_LEVL_CODE = A.SFRRGFE_LEVL_CODE
                                                      AND A1.SFRRGFE_CAMP_CODE = A.SFRRGFE_CAMP_CODE
                                                      AND A1.SFRRGFE_ATTS_CODE = A.SFRRGFE_ATTS_CODE
                                                      AND A1.SFRRGFE_RATE_CODE = A.SFRRGFE_RATE_CODE
                                                      AND A1.SFRRGFE_DEPT_CODE IS NULL
                                                      AND A1.SFRRGFE_PROGRAM IS NULL);
                            EXCEPTION
                            WHEN OTHERS THEN
                                  VL_ERROR :='Validar Regla de Cobro, Parametros xxxxxx= '||ALUMNO.PERIODO||'  -  '||NVL(VC_JORNADA,'SIN JORNADA')||'  -  '||ALUMNO.RATE;
                                  VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;
                                  VL_CODIGO := NULL;
                                  VL_DESCRIPCION := NULL;
                                  VL_MONTO := NULL;
                            END;

                        END;

                      END IF;

                  END IF;

              ELSE

              VL_ERROR:= 'Fecha inicio diferente = '||ALUMNO.FECHA_INICIO;

              END IF;

          ELSIF P_RATE IS NOT NULL THEN

             BEGIN

                    SELECT T.SGRSATT_ATTS_CODE
                    INTO  VC_JORNADA
                    FROM SGRSATT T
                    WHERE T.SGRSATT_PIDM = ALUMNO.PIDM
                    AND T.SGRSATT_STSP_KEY_SEQUENCE = ALUMNO.STUDY_PATH
                    AND REGEXP_LIKE  (T.SGRSATT_ATTS_CODE , '^[0-9]')
                    AND SUBSTR(T.SGRSATT_TERM_CODE_EFF,5,2) NOT IN (81,82,83,90)
                    AND T.SGRSATT_TERM_CODE_EFF = ( SELECT MAX(SGRSATT_TERM_CODE_EFF)
                                                     FROM SGRSATT TT
                                                     WHERE  TT.SGRSATT_PIDM =  T.SGRSATT_PIDM
                                                     AND  TT.SGRSATT_STSP_KEY_SEQUENCE= T.SGRSATT_STSP_KEY_SEQUENCE
                                                     AND SUBSTR(TT.SGRSATT_TERM_CODE_EFF,5,2) NOT IN (81,82,83,90)
                                                     AND REGEXP_LIKE  (T.SGRSATT_ATTS_CODE , '^[0-9]'))
                    AND T.SGRSATT_ACTIVITY_DATE = (SELECT MAX(SGRSATT_ACTIVITY_DATE)
                                                   FROM SGRSATT T1
                                                   WHERE T1.SGRSATT_PIDM = T.SGRSATT_PIDM
                                                   AND T1.SGRSATT_STSP_KEY_SEQUENCE = T.SGRSATT_STSP_KEY_SEQUENCE
                                                   AND T1.SGRSATT_TERM_CODE_EFF = T.SGRSATT_TERM_CODE_EFF
                                                   AND SUBSTR(T1.SGRSATT_TERM_CODE_EFF,5,2) NOT IN (81,82,83,90)
                                                   AND REGEXP_LIKE  (T.SGRSATT_ATTS_CODE , '^[0-9]'))
                                                   ;

             EXCEPTION
             WHEN OTHERS THEN
             VC_JORNADA:=NULL;
             VL_ERROR :='Error al buscar la Jornada en SGASADD: ';
             VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;
             END;

             IF VL_ERROR IS NULL THEN

                VL_ERROR:='EXITO';


                  IF alumno.PRE_ACTUALIZADO IS NOT NULL THEN


                    BEGIN

                            SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                            INTO VL_CODIGO, VL_DESCRIPCION, VL_MONTO,  VL_SFRRGFE_RATE_CODE
                            FROM SFRRGFE A , TBBDETC
                            WHERE TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                            AND  A.SFRRGFE_TERM_CODE= ALUMNO.PERIODO
                            AND A.SFRRGFE_TYPE = 'STUDENT'
                            AND SFRRGFE_ENTRY_TYPE = 'R'
                            AND A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                            AND A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                            AND A.SFRRGFE_ATTS_CODE = VC_JORNADA--ALUMNO.JORNADA
                            AND A.SFRRGFE_RATE_CODE = P_RATE
                            AND A.SFRRGFE_DEPT_CODE = alumno.PRE_ACTUALIZADO
                            AND A.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA
                            AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                                  FROM SFRRGFE A1
                                                  WHERE A1.SFRRGFE_TERM_CODE = A.SFRRGFE_TERM_CODE
                                                  AND A1.SFRRGFE_TYPE = A.SFRRGFE_TYPE
                                                  AND A1.SFRRGFE_ENTRY_TYPE = A.SFRRGFE_ENTRY_TYPE
                                                  AND A1.SFRRGFE_LEVL_CODE = A.SFRRGFE_LEVL_CODE
                                                  AND A1.SFRRGFE_CAMP_CODE = A.SFRRGFE_CAMP_CODE
                                                  AND A1.SFRRGFE_ATTS_CODE = A.SFRRGFE_ATTS_CODE
                                                  AND A1.SFRRGFE_RATE_CODE = A.SFRRGFE_RATE_CODE
                                                  AND A1.SFRRGFE_DEPT_CODE = A.SFRRGFE_DEPT_CODE
                                                  AND A1.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA);

                    EXCEPTION
                    WHEN NO_DATA_FOUND THEN

                        BEGIN

                            SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                            INTO VL_CODIGO, VL_DESCRIPCION, VL_MONTO,  VL_SFRRGFE_RATE_CODE
                            FROM SFRRGFE A , TBBDETC
                            WHERE TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                            AND  A.SFRRGFE_TERM_CODE= ALUMNO.PERIODO
                            AND A.SFRRGFE_TYPE = 'STUDENT'
                            AND SFRRGFE_ENTRY_TYPE = 'R'
                            AND A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                            AND A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                            AND A.SFRRGFE_ATTS_CODE = VC_JORNADA--ALUMNO.JORNADA
                            AND A.SFRRGFE_RATE_CODE = P_RATE
                            AND A.SFRRGFE_DEPT_CODE = alumno.PRE_ACTUALIZADO
                            AND A.SFRRGFE_PROGRAM IS NULL
                            AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                                  FROM SFRRGFE A1
                                                  WHERE A1.SFRRGFE_TERM_CODE = A.SFRRGFE_TERM_CODE
                                                  AND A1.SFRRGFE_TYPE = A.SFRRGFE_TYPE
                                                  AND A1.SFRRGFE_ENTRY_TYPE = A.SFRRGFE_ENTRY_TYPE
                                                  AND A1.SFRRGFE_LEVL_CODE = A.SFRRGFE_LEVL_CODE
                                                  AND A1.SFRRGFE_CAMP_CODE = A.SFRRGFE_CAMP_CODE
                                                  AND A1.SFRRGFE_ATTS_CODE = A.SFRRGFE_ATTS_CODE
                                                  AND A1.SFRRGFE_RATE_CODE = A.SFRRGFE_RATE_CODE
                                                  AND A1.SFRRGFE_DEPT_CODE = A.SFRRGFE_DEPT_CODE
                                                  AND A1.SFRRGFE_PROGRAM IS NULL);

                        EXCEPTION
                        WHEN OTHERS THEN
                          VL_ERROR :='Validar Regla de Cobro, Parametros xxxxxxx= '||ALUMNO.PERIODO||'  -  '||NVL(VC_JORNADA,'SIN JORNADA')||'  -  '||P_RATE;
                          VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;
                          VL_CODIGO := NULL;
                          VL_DESCRIPCION := NULL;
                          VL_MONTO := NULL;
                        END;

                    END;


                  ELSIF alumno.PRE_ACTUALIZADO IS  NULL THEN


                    BEGIN

                        SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                        INTO VL_CODIGO, VL_DESCRIPCION, VL_MONTO,  VL_SFRRGFE_RATE_CODE
                        FROM SFRRGFE A , TBBDETC
                        WHERE TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                        AND  A.SFRRGFE_TERM_CODE = ALUMNO.PERIODO
                        AND A.SFRRGFE_TYPE = 'STUDENT'
                        AND SFRRGFE_ENTRY_TYPE = 'R'
                        AND A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                        AND A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                        AND A.SFRRGFE_ATTS_CODE = VC_JORNADA--ALUMNO.JORNADA
                        AND A.SFRRGFE_RATE_CODE = P_RATE
                        AND A.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA
                        AND A.SFRRGFE_DEPT_CODE IS NULL
                        AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                              FROM SFRRGFE A1
                                              WHERE A1.SFRRGFE_TERM_CODE = A.SFRRGFE_TERM_CODE
                                              AND A1.SFRRGFE_TYPE = A.SFRRGFE_TYPE
                                              AND A1.SFRRGFE_ENTRY_TYPE = A.SFRRGFE_ENTRY_TYPE
                                              AND A1.SFRRGFE_LEVL_CODE = A.SFRRGFE_LEVL_CODE
                                              AND A1.SFRRGFE_CAMP_CODE = A.SFRRGFE_CAMP_CODE
                                              AND A1.SFRRGFE_ATTS_CODE = A.SFRRGFE_ATTS_CODE
                                              AND A1.SFRRGFE_RATE_CODE = A.SFRRGFE_RATE_CODE
                                              AND A1.SFRRGFE_DEPT_CODE IS NULL
                                              AND A1.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA);
                    EXCEPTION
                    WHEN OTHERS THEN

                        BEGIN

                            SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                            INTO VL_CODIGO, VL_DESCRIPCION, VL_MONTO,  VL_SFRRGFE_RATE_CODE
                            FROM SFRRGFE A , TBBDETC
                            WHERE TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                            AND  A.SFRRGFE_TERM_CODE= ALUMNO.PERIODO
                            AND A.SFRRGFE_TYPE = 'STUDENT'
                            AND SFRRGFE_ENTRY_TYPE = 'R'
                            AND A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                            AND A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                            AND A.SFRRGFE_ATTS_CODE = VC_JORNADA--ALUMNO.JORNADA
                            AND A.SFRRGFE_RATE_CODE = P_RATE
                            AND A.SFRRGFE_DEPT_CODE IS NULL
                            AND A.SFRRGFE_PROGRAM IS NULL
                            AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                                  FROM SFRRGFE A1
                                                  WHERE A1.SFRRGFE_TERM_CODE = A.SFRRGFE_TERM_CODE
                                                  AND A1.SFRRGFE_TYPE = A.SFRRGFE_TYPE
                                                  AND A1.SFRRGFE_ENTRY_TYPE = A.SFRRGFE_ENTRY_TYPE
                                                  AND A1.SFRRGFE_LEVL_CODE = A.SFRRGFE_LEVL_CODE
                                                  AND A1.SFRRGFE_CAMP_CODE = A.SFRRGFE_CAMP_CODE
                                                  AND A1.SFRRGFE_ATTS_CODE = A.SFRRGFE_ATTS_CODE
                                                  AND A1.SFRRGFE_RATE_CODE = A.SFRRGFE_RATE_CODE
                                                  AND A1.SFRRGFE_DEPT_CODE IS NULL
                                                  AND A1.SFRRGFE_PROGRAM IS NULL);
                        EXCEPTION
                        WHEN OTHERS THEN
                              VL_ERROR :='Validar Regla de Cobro, Parametros xxxxxxxx = '||ALUMNO.PERIODO||'  -  '||NVL(VC_JORNADA,'SIN JORNADA')||'  -  '||P_RATE;
                              VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;
                              VL_CODIGO := NULL;
                              VL_DESCRIPCION := NULL;
                              VL_MONTO := NULL;
                        END;

                    END;

                  END IF;

             END IF;


          ELSIF P_JORNADA IS NOT NULL THEN


              IF VL_ERROR IS NULL THEN

                VL_ERROR:='EXITO';


                  IF alumno.PRE_ACTUALIZADO IS NOT NULL THEN


                    BEGIN

                            SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                            INTO VL_CODIGO, VL_DESCRIPCION, VL_MONTO,  VL_SFRRGFE_RATE_CODE
                            FROM SFRRGFE A , TBBDETC
                            WHERE TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                            AND  A.SFRRGFE_TERM_CODE= ALUMNO.PERIODO
                            AND A.SFRRGFE_TYPE = 'STUDENT'
                            AND SFRRGFE_ENTRY_TYPE = 'R'
                            AND A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                            AND A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                            AND A.SFRRGFE_ATTS_CODE = P_JORNADA
                            AND A.SFRRGFE_RATE_CODE = ALUMNO.RATE
                            AND A.SFRRGFE_DEPT_CODE = alumno.PRE_ACTUALIZADO
                            AND A.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA
                            AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                                  FROM SFRRGFE A1
                                                  WHERE A1.SFRRGFE_TERM_CODE = A.SFRRGFE_TERM_CODE
                                                  AND A1.SFRRGFE_TYPE = A.SFRRGFE_TYPE
                                                  AND A1.SFRRGFE_ENTRY_TYPE = A.SFRRGFE_ENTRY_TYPE
                                                  AND A1.SFRRGFE_LEVL_CODE = A.SFRRGFE_LEVL_CODE
                                                  AND A1.SFRRGFE_CAMP_CODE = A.SFRRGFE_CAMP_CODE
                                                  AND A1.SFRRGFE_ATTS_CODE = A.SFRRGFE_ATTS_CODE
                                                  AND A1.SFRRGFE_RATE_CODE = A.SFRRGFE_RATE_CODE
                                                  AND A1.SFRRGFE_DEPT_CODE = A.SFRRGFE_DEPT_CODE
                                                  AND A1.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA);

                    EXCEPTION
                    WHEN NO_DATA_FOUND THEN

                        BEGIN

                            SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                            INTO VL_CODIGO, VL_DESCRIPCION, VL_MONTO,  VL_SFRRGFE_RATE_CODE
                            FROM SFRRGFE A , TBBDETC
                            WHERE TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                            AND  A.SFRRGFE_TERM_CODE= ALUMNO.PERIODO
                            AND A.SFRRGFE_TYPE = 'STUDENT'
                            AND SFRRGFE_ENTRY_TYPE = 'R'
                            AND A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                            AND A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                            AND A.SFRRGFE_ATTS_CODE = P_JORNADA
                            AND A.SFRRGFE_RATE_CODE = ALUMNO.RATE
                            AND A.SFRRGFE_DEPT_CODE = alumno.PRE_ACTUALIZADO
                            AND A.SFRRGFE_PROGRAM IS NULL
                            AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                                  FROM SFRRGFE A1
                                                  WHERE A1.SFRRGFE_TERM_CODE = A.SFRRGFE_TERM_CODE
                                                  AND A1.SFRRGFE_TYPE = A.SFRRGFE_TYPE
                                                  AND A1.SFRRGFE_ENTRY_TYPE = A.SFRRGFE_ENTRY_TYPE
                                                  AND A1.SFRRGFE_LEVL_CODE = A.SFRRGFE_LEVL_CODE
                                                  AND A1.SFRRGFE_CAMP_CODE = A.SFRRGFE_CAMP_CODE
                                                  AND A1.SFRRGFE_ATTS_CODE = A.SFRRGFE_ATTS_CODE
                                                  AND A1.SFRRGFE_RATE_CODE = A.SFRRGFE_RATE_CODE
                                                  AND A1.SFRRGFE_DEPT_CODE = A.SFRRGFE_DEPT_CODE
                                                  AND A1.SFRRGFE_PROGRAM IS NULL);

                        EXCEPTION
                        WHEN OTHERS THEN
                          VL_ERROR :='Validar Regla de Cobro, Parametros xxxxxxxxxx= '||ALUMNO.PERIODO||'  -  '||NVL(P_JORNADA,'SIN JORNADA')||'  -  '||ALUMNO.RATE;
                          VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;
                          VL_CODIGO := NULL;
                          VL_DESCRIPCION := NULL;
                          VL_MONTO := NULL;
                        END;

                    END;


                  ELSIF alumno.PRE_ACTUALIZADO IS  NULL THEN


                    BEGIN

                        SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                        INTO VL_CODIGO, VL_DESCRIPCION, VL_MONTO,  VL_SFRRGFE_RATE_CODE
                        FROM SFRRGFE A , TBBDETC
                        WHERE TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                        AND  A.SFRRGFE_TERM_CODE = ALUMNO.PERIODO
                        AND A.SFRRGFE_TYPE = 'STUDENT'
                        AND SFRRGFE_ENTRY_TYPE = 'R'
                        AND A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                        AND A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                        AND A.SFRRGFE_ATTS_CODE = P_JORNADA
                        AND A.SFRRGFE_RATE_CODE = ALUMNO.RATE
                        AND A.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA
                        AND A.SFRRGFE_DEPT_CODE IS NULL
                        AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                              FROM SFRRGFE A1
                                              WHERE A1.SFRRGFE_TERM_CODE = A.SFRRGFE_TERM_CODE
                                              AND A1.SFRRGFE_TYPE = A.SFRRGFE_TYPE
                                              AND A1.SFRRGFE_ENTRY_TYPE = A.SFRRGFE_ENTRY_TYPE
                                              AND A1.SFRRGFE_LEVL_CODE = A.SFRRGFE_LEVL_CODE
                                              AND A1.SFRRGFE_CAMP_CODE = A.SFRRGFE_CAMP_CODE
                                              AND A1.SFRRGFE_ATTS_CODE = A.SFRRGFE_ATTS_CODE
                                              AND A1.SFRRGFE_RATE_CODE = A.SFRRGFE_RATE_CODE
                                              AND A1.SFRRGFE_DEPT_CODE IS NULL
                                              AND A1.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA);
                    EXCEPTION
                    WHEN OTHERS THEN

                        BEGIN

                            SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                            INTO VL_CODIGO, VL_DESCRIPCION, VL_MONTO,  VL_SFRRGFE_RATE_CODE
                            FROM SFRRGFE A , TBBDETC
                            WHERE TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                            AND  A.SFRRGFE_TERM_CODE= ALUMNO.PERIODO
                            AND A.SFRRGFE_TYPE = 'STUDENT'
                            AND SFRRGFE_ENTRY_TYPE = 'R'
                            AND A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                            AND A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                            AND A.SFRRGFE_ATTS_CODE = P_JORNADA
                            AND A.SFRRGFE_RATE_CODE = ALUMNO.RATE
                            AND A.SFRRGFE_DEPT_CODE IS NULL
                            AND A.SFRRGFE_PROGRAM IS NULL
                            AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                                  FROM SFRRGFE A1
                                                  WHERE A1.SFRRGFE_TERM_CODE = A.SFRRGFE_TERM_CODE
                                                  AND A1.SFRRGFE_TYPE = A.SFRRGFE_TYPE
                                                  AND A1.SFRRGFE_ENTRY_TYPE = A.SFRRGFE_ENTRY_TYPE
                                                  AND A1.SFRRGFE_LEVL_CODE = A.SFRRGFE_LEVL_CODE
                                                  AND A1.SFRRGFE_CAMP_CODE = A.SFRRGFE_CAMP_CODE
                                                  AND A1.SFRRGFE_ATTS_CODE = A.SFRRGFE_ATTS_CODE
                                                  AND A1.SFRRGFE_RATE_CODE = A.SFRRGFE_RATE_CODE
                                                  AND A1.SFRRGFE_DEPT_CODE IS NULL
                                                  AND A1.SFRRGFE_PROGRAM IS NULL);
                        EXCEPTION
                        WHEN OTHERS THEN
                              VL_ERROR :='Validar Regla de Cobro, Parametros = '||ALUMNO.PERIODO||'  -  '||NVL(P_JORNADA,'SIN JORNADA')||'  -  '||ALUMNO.RATE;
                              VL_CADENAERROR:=VL_CADENAERROR||'|'||VL_ERROR;
                              VL_CODIGO := NULL;
                              VL_DESCRIPCION := NULL;
                              VL_MONTO := NULL;
                        END;

                    END;

                  END IF;

              END IF;


          END IF;

         VL_VALIDA:= 1;

        END LOOP;

    END;

    IF VL_VALIDA = 0 THEN

        BEGIN

             SELECT COUNT( DISTINCT D.SPRIDEN_ID)
             INTO VL_MAT_BAJA
             FROM SORLCUR A, SGBSTDN B, SPRIDEN D, SFRSTCR F, SSBSECT G, SZTDTEC E
             WHERE A.SORLCUR_LMOD_CODE = 'LEARNER'
--             AND A.SORLCUR_ROLL_IND  != 'Y'
--             AND A.SORLCUR_CACT_CODE != 'ACTIVE' --Va?
             AND A.SORLCUR_SEQNO = (SELECT MAX (A1.SORLCUR_SEQNO)
                                   FROM SORLCUR A1
                                   WHERE A1.SORLCUR_PIDM = A.SORLCUR_PIDM
                                   AND A1.SORLCUR_ROLL_IND  = A.SORLCUR_ROLL_IND
                                   AND A1.SORLCUR_CACT_CODE = A.SORLCUR_CACT_CODE
                                   AND A1.SORLCUR_PROGRAM = A.SORLCUR_PROGRAM
                                   AND A1.SORLCUR_LMOD_CODE = A.SORLCUR_LMOD_CODE)
             AND A.SORLCUR_PIDM =  B.SGBSTDN_PIDM
             AND A.SORLCUR_PROGRAM = B.SGBSTDN_PROGRAM_1
             AND B.SGBSTDN_TERM_CODE_EFF IN (SELECT MAX (B1.SGBSTDN_TERM_CODE_EFF)
                                             FROM SGBSTDN B1
                                             WHERE B.SGBSTDN_PIDM = B1.SGBSTDN_PIDM
                                             AND B.SGBSTDN_PROGRAM_1 = B1.SGBSTDN_PROGRAM_1)
             AND E.SZTDTEC_PROGRAM = B.SGBSTDN_PROGRAM_1
             AND A.SORLCUR_TERM_CODE_CTLG = E.SZTDTEC_TERM_CODE
             AND D.SPRIDEN_PIDM = SGBSTDN_PIDM
             AND D.SPRIDEN_CHANGE_IND IS NULL
             AND F.SFRSTCR_PIDM = A.SORLCUR_PIDM
             AND F.SFRSTCR_RSTS_CODE IN ('DD','BD')
             AND F.SFRSTCR_STSP_KEY_SEQUENCE = A.SORLCUR_KEY_SEQNO
             AND F.SFRSTCR_TERM_CODE = G.SSBSECT_TERM_CODE
             AND SUBSTR(F.SFRSTCR_TERM_CODE,5,2) NOT IN (81,82,83,90)
             AND F.SFRSTCR_CRN = G.SSBSECT_CRN
             AND F.SFRSTCR_PTRM_CODE = G.SSBSECT_PTRM_CODE
             AND TRUNC (G.SSBSECT_PTRM_START_DATE)  = P_FECHA
             AND D.SPRIDEN_ID = P_MATRICULA
             ;
        EXCEPTION
        WHEN OTHERS THEN
        VL_MAT_BAJA:= 0;
        END;

        IF VL_MAT_BAJA != 0 THEN

        VL_ERROR:= 'No se puede re-procesar, materias con status de baja';

        END IF;

    END IF;


    DBMS_OUTPUT.PUT_LINE(VL_ERROR);

    RETURN VL_ERROR;

 END;


FUNCTION F_PAGOS_OUT (P_PIDM IN NUMBER) RETURN PKG_FINANZAS.CUP_OUT
AS
CURPAGOS_OUT PKG_FINANZAS.CUP_OUT;

    BEGIN

        OPEN CURPAGOS_OUT
         FOR
               SELECT TBRACCD_TRAN_NUMBER TRANS,
                      (SELECT TZTNCD_CONCEPTO
                       FROM TZTNCD
                       WHERE TZTNCD_CODE = A.TBRACCD_DETAIL_CODE)CONCEPTO,
                       (SELECT TBRACCD_PAYMENT_ID
                       FROM TBRACCD
                       WHERE TBRACCD_PIDM = A.TBRACCD_PIDM
                       AND TBRACCD_TRAN_NUMBER = A.TBRACCD_TRAN_NUMBER)FOLIO_PAGO,
                       TBRACCD_DESC DESCRIPCIÓN,
                       TBRACCD_TRANS_DATE FECHA_DE_PAGO,
                       TBRACCD_AMOUNT TOTAL,
                       TZTFACT_RFC RFC,
                       TZTFACT_SERIE Serie,
                       TZTFACT_FOLIO Folio,
                       TZTFACT_FECHA_PROCESO Fecha_Facturacion
                FROM TBRACCD A
                left join tztfact on TZTFACT_PIDM = a.tbraccd_pidm and TZTFACT_TRAN_NUMBER =  a.TBRACCD_TRAN_NUMBER
                WHERE (A.tbraccd_pidm, a.TBRACCD_TRAN_NUMBER ) IN  (select tbraccd_pidm, TBRACCD_TRAN_NUMBER
                                                                                         from tbraccd, TZTNCD
                                                                                         where tbraccd_detail_code = TZTNCD_CODE
                                                                                         And TZTNCD_CONCEPTO IN ('Poliza', 'Deposito', 'Nota Distribucion'))
                AND A.TBRACCD_PIDM = P_PIDM
                AND A.TBRACCD_AMOUNT > 0
                ORDER BY 1 desc,5 desc;

        RETURN (CURPAGOS_OUT);

    END F_PAGOS_OUT;

FUNCTION F_PAGOAPLICADO_OUT (P_PIDM IN NUMBER,P_TRANSACCION IN NUMBER) RETURN PKG_FINANZAS.CUPA_OUT
AS
CURPAGOAPLI_OUT PKG_FINANZAS.CUPA_OUT;

    BEGIN

        OPEN CURPAGOAPLI_OUT
         FOR

                SELECT DISTINCT
                        TBRAPPL_CHG_TRAN_NUMBER NUM,
                        (SELECT TZTNCD_CONCEPTO
                        FROM TZTNCD
                        WHERE TZTNCD_CODE = (SELECT A1.TBRACCD_DETAIL_CODE
                                             FROM TBRACCD A1
                                             WHERE TBRACCD_PIDM = A.TBRAPPL_PIDM
                                             AND TBRACCD_TRAN_NUMBER = A.TBRAPPL_PAY_TRAN_NUMBER))CONCEPTO,
                        (SELECT TBRACCD_DESC
                        FROM TBRACCD
                        WHERE TBRACCD_PIDM = A.TBRAPPL_PIDM
                        AND TBRACCD_TRAN_NUMBER = A.TBRAPPL_PAY_TRAN_NUMBER)PAGO,
                        (SELECT TBRACCD_EFFECTIVE_DATE
                        FROM TBRACCD
                        WHERE TBRACCD_PIDM = A.TBRAPPL_PIDM
                        AND TBRACCD_TRAN_NUMBER = A.TBRAPPL_PAY_TRAN_NUMBER)FECHA_PAGO,
                        (SELECT TBRACCD_PAYMENT_ID
                        FROM TBRACCD
                        WHERE TBRACCD_PIDM = A.TBRAPPL_PIDM
                        AND TBRACCD_TRAN_NUMBER = A.TBRAPPL_PAY_TRAN_NUMBER)FOLIO_PAGO,
                        (SELECT TBRACCD_AMOUNT
                        FROM TBRACCD
                        WHERE TBRACCD_PIDM = A.TBRAPPL_PIDM
                        AND TBRACCD_TRAN_NUMBER = A.TBRAPPL_PAY_TRAN_NUMBER)MONTO_PAGO,
                        (SELECT TZTNCD_CONCEPTO
                        FROM TZTNCD
                        WHERE TZTNCD_CODE = (SELECT A1.TBRACCD_DETAIL_CODE
                                             FROM TBRACCD A1
                                             WHERE TBRACCD_PIDM = A.TBRAPPL_PIDM
                                             AND TBRACCD_TRAN_NUMBER = A.TBRAPPL_CHG_TRAN_NUMBER))CON_PAG,
                        (SELECT TBRACCD_DESC
                        FROM TBRACCD
                        WHERE TBRACCD_PIDM = A.TBRAPPL_PIDM
                        AND TBRACCD_TRAN_NUMBER = A.TBRAPPL_CHG_TRAN_NUMBER)CARGO_PAGADO,
                        (SELECT TRUNC(TBRACCD_EFFECTIVE_DATE)
                        FROM TBRACCD
                        WHERE TBRACCD_PIDM = A.TBRAPPL_PIDM
                        AND TBRACCD_TRAN_NUMBER = A.TBRAPPL_CHG_TRAN_NUMBER)FECHA_CARGO,
                        TBRAPPL_AMOUNT,
                        ((SELECT TBRACCD_AMOUNT
                        FROM TBRACCD
                        WHERE TBRACCD_PIDM = A.TBRAPPL_PIDM
                        AND TBRACCD_TRAN_NUMBER = A.TBRAPPL_PAY_TRAN_NUMBER) - (SELECT SUM(TBRAPPL_AMOUNT)
                                                                                FROM TBRAPPL A1
                                                                                WHERE A1.TBRAPPL_PIDM = A.TBRAPPL_PIDM
                                                                                AND A1.TBRAPPL_PAY_TRAN_NUMBER = A.TBRAPPL_PAY_TRAN_NUMBER
                                                                                AND A1.TBRAPPL_REAPPL_IND IS NULL
                                                                                AND A1.TBRAPPL_CHG_TRAN_NUMBER <= A.TBRAPPL_CHG_TRAN_NUMBER))*-1BALANCE,
                        (SELECT TBRACCD_AMOUNT
                        FROM TBRACCD
                        WHERE TBRACCD_PIDM = A.TBRAPPL_PIDM
                        AND TBRACCD_TRAN_NUMBER = A.TBRAPPL_CHG_TRAN_NUMBER)TOTAL_CARGO,
                        (SELECT TBRACCD_RECEIPT_NUMBER
                        FROM TBRACCD
                        WHERE TBRACCD_PIDM = A.TBRAPPL_PIDM
                        AND TBRACCD_TRAN_NUMBER = A.TBRAPPL_CHG_TRAN_NUMBER)ORDEN,
                        (SELECT DISTINCT SUBSTR((SELECT DISTINCT ((SELECT DISTINCT TBRACDT_TEXT FROM TBRACDT WHERE TBRACDT_PIDM = A1.TBRAPPL_PIDM AND TBRACDT_TRAN_NUMBER = A1.TBRAPPL_PAY_TRAN_NUMBER AND TBRACDT_SEQ_NUMBER = 1)||(SELECT DISTINCT TBRACDT_TEXT FROM TBRACDT WHERE TBRACDT_PIDM = A1.TBRAPPL_PIDM AND TBRACDT_TRAN_NUMBER = A1.TBRAPPL_PAY_TRAN_NUMBER AND TBRACDT_SEQ_NUMBER = 2))
                         FROM TBRAPPL A1
                         WHERE A1.TBRAPPL_PIDM = A.TBRAPPL_PIDM
                         AND A1.TBRAPPL_PAY_TRAN_NUMBER = A.TBRAPPL_PAY_TRAN_NUMBER
                         AND A1.TBRAPPL_REAPPL_IND IS NULL),-------CADENA COMPLETA
                        (SELECT INSTR((SELECT DISTINCT (SELECT DISTINCT TBRACDT_TEXT
                         FROM TBRACDT
                         WHERE TBRACDT_PIDM = A1.TBRAPPL_PIDM
                         AND TBRACDT_TRAN_NUMBER = A1.TBRAPPL_PAY_TRAN_NUMBER
                         AND TBRACDT_SEQ_NUMBER = 1) ||(SELECT DISTINCT TBRACDT_TEXT
                                                        FROM TBRACDT
                                                        WHERE TBRACDT_PIDM = A1.TBRAPPL_PIDM
                                                        AND TBRACDT_TRAN_NUMBER = A1.TBRAPPL_PAY_TRAN_NUMBER
                                                        AND TBRACDT_SEQ_NUMBER = 2)FOLIO_PAGO
                         FROM TBRAPPL A1
                         WHERE A1.TBRAPPL_PIDM = A.TBRAPPL_PIDM
                         AND A1.TBRAPPL_PAY_TRAN_NUMBER = A.TBRAPPL_PAY_TRAN_NUMBER
                         AND A1.TBRAPPL_REAPPL_IND IS NULL),'_',-1,1)CARA
                         FROM DUAL)+1,------NUMERO DE CARACTERESA BUSCAR
                        (SELECT DISTINCT (SELECT LENGTH((SELECT DISTINCT
                        (SELECT DISTINCT TBRACDT_TEXT
                         FROM TBRACDT
                         WHERE TBRACDT_PIDM = A1.TBRAPPL_PIDM
                         AND TBRACDT_TRAN_NUMBER = A1.TBRAPPL_PAY_TRAN_NUMBER
                         AND TBRACDT_SEQ_NUMBER = 1) ||(SELECT DISTINCT TBRACDT_TEXT
                                                        FROM TBRACDT
                                                        WHERE TBRACDT_PIDM = A1.TBRAPPL_PIDM
                                                        AND TBRACDT_TRAN_NUMBER = A1.TBRAPPL_PAY_TRAN_NUMBER
                                                        AND TBRACDT_SEQ_NUMBER = 2)FOLIO_PAGO
                         FROM TBRAPPL A1
                         WHERE A1.TBRAPPL_PIDM = A.TBRAPPL_PIDM
                         AND A1.TBRAPPL_PAY_TRAN_NUMBER = A.TBRAPPL_PAY_TRAN_NUMBER
                         AND A1.TBRAPPL_REAPPL_IND IS NULL))------LARGO DE CADENA
                         -
                        (SELECT DISTINCT INSTR((SELECT DISTINCT
                        (SELECT DISTINCT TBRACDT_TEXT
                         FROM TBRACDT
                         WHERE TBRACDT_PIDM = A1.TBRAPPL_PIDM
                         AND TBRACDT_TRAN_NUMBER = A1.TBRAPPL_PAY_TRAN_NUMBER
                         AND TBRACDT_SEQ_NUMBER = 1) ||(SELECT DISTINCT TBRACDT_TEXT
                                                        FROM TBRACDT
                                                        WHERE TBRACDT_PIDM = A1.TBRAPPL_PIDM
                                                        AND TBRACDT_TRAN_NUMBER = A1.TBRAPPL_PAY_TRAN_NUMBER
                                                        AND TBRACDT_SEQ_NUMBER = 2)FOLIO_PAGO
                        FROM TBRAPPL A1
                        WHERE A1.TBRAPPL_PIDM = A.TBRAPPL_PIDM
                        AND A1.TBRAPPL_PAY_TRAN_NUMBER = A.TBRAPPL_PAY_TRAN_NUMBER
                        AND A1.TBRAPPL_REAPPL_IND IS NULL),'_',-1,1)CARA
                        FROM DUAL)TAMAÑO--------NUMERO DE LA POSICION DEL CARACTER
                        FROM DUAL)TOTAL--------TOTAL DE CARACTERES A SUBSTRAER
                        FROM DUAL))
                        FROM DUAL)FOLIO_DE_PAGO
                FROM TBRAPPL A
                WHERE A.TBRAPPL_PIDM = P_PIDM
                AND A.TBRAPPL_PAY_TRAN_NUMBER = P_TRANSACCION
                AND A.TBRAPPL_REAPPL_IND IS NULL
                ORDER BY 1;

        RETURN (CURPAGOAPLI_OUT);

    END F_PAGOAPLICADO_OUT;

FUNCTION F_CARGOS_OUT (P_PIDM IN NUMBER) RETURN PKG_FINANZAS.CUCAR_OUT
AS
CURCARGOS_OUT PKG_FINANZAS.CUCAR_OUT;

    BEGIN

       OPEN CURCARGOS_OUT
       FOR
       SELECT NUMERO,
               DESCRIPCION,
               FECHA_LIMITE,
               MONTO,
               POR_PAGAR,
               PERIODO,
               PARTE_P,
               CASE
                WHEN CATE = 'COL' THEN
                 DECODE (DESCUENTO,'000%','0%','100%','100%','0%','0%',DESCUENTO,SUBSTR(DESCUENTO,2,3))
                ELSE
                     NULL
               END DESCUENTO,---CASE PARA COLOCAR DESCUENTO SOLO A COL--
               CASE
                    WHEN POR_PAGAR = 0 THEN 'PAGADO'
                    WHEN POR_PAGAR > 0 AND FECHA_LIMITE < TRUNC(SYSDATE) AND MONTO = POR_PAGAR THEN 'VENCIDO'
                    WHEN POR_PAGAR > 0 AND FECHA_LIMITE < TRUNC(SYSDATE) AND MONTO != POR_PAGAR THEN 'PAGO PARCIAL VENCIDO'
                    WHEN POR_PAGAR > 0 AND FECHA_LIMITE >= TRUNC(SYSDATE) AND MONTO = POR_PAGAR THEN 'PENDIENTE DE PAGO'
                    WHEN POR_PAGAR > 0 AND FECHA_LIMITE >= TRUNC(SYSDATE) AND MONTO != POR_PAGAR THEN 'PAGO PARCIAL'
               END ESTADO,
               ORDEN,
               CATE,
               CASE
                     WHEN TO_CHAR(FECHA_LIMITE,'MM') BETWEEN 1 AND 4 THEN 'ENERO - ABRIL DEL '||TO_CHAR(FECHA_LIMITE,'YYYY')
                     WHEN TO_CHAR(FECHA_LIMITE,'MM') BETWEEN 5 AND 8 THEN 'MAYO - AGOSTO DEL '||TO_CHAR(FECHA_LIMITE,'YYYY')
                     WHEN TO_CHAR(FECHA_LIMITE,'MM') BETWEEN 9 AND 12 THEN 'SEPTIEMBRE - DICIEMBRE DEL '||TO_CHAR(FECHA_LIMITE,'YYYY')
               END RANGO ---CASE PARA CALCULAR LOS PERIODOS EN RANGO DE FECHAS---
        FROM (SELECT TBRACCD_TRAN_NUMBER NUMERO,
                     TBRACCD_DESC DESCRIPCION,
                     TBRACCD_AMOUNT MONTO,
                     TBRACCD_BALANCE POR_PAGAR,
                     TBRACCD_TERM_CODE PERIODO,
                     TBRACCD_PERIOD PARTE_P,
                     TBRACCD_EFFECTIVE_DATE FECHA_LIMITE,
                     NVL((SELECT SUBSTR(TBBESTU_EXEMPTION_CODE,4,3)||'%'
                     FROM TBBEXPT, TBBESTU A, TBBDETC, TBREDET
                     WHERE TBBDETC_DETAIL_CODE = TBBEXPT_DETAIL_CODE
                     AND A.TBBESTU_EXEMPTION_CODE  = TBBEXPT_EXEMPTION_CODE
                     AND A.TBBESTU_TERM_CODE = TBBEXPT_TERM_CODE
                     AND TBREDET_EXEMPTION_CODE = TBBEXPT_EXEMPTION_CODE
                     AND TBREDET_TERM_CODE = TBBEXPT_TERM_CODE
                     AND (A.TBBESTU_TERM_CODE = A.TBRACCD_TERM_CODE
                          OR
                          A.TBBESTU_TERM_CODE = (SELECT MAX(TBBESTU_TERM_CODE)
                                                 FROM TBBEXPT, TBBESTU A1, TBBDETC, TBREDET
                                                 WHERE TBBDETC_DETAIL_CODE = TBBEXPT_DETAIL_CODE
                                                 AND A1.TBBESTU_EXEMPTION_CODE  = TBBEXPT_EXEMPTION_CODE
                                                 AND A1.TBBESTU_TERM_CODE = TBBEXPT_TERM_CODE
                                                 AND TBREDET_EXEMPTION_CODE = TBBEXPT_EXEMPTION_CODE
                                                 AND TBREDET_TERM_CODE = TBBEXPT_TERM_CODE
                                                 AND A1.TBBESTU_TERM_CODE <= A.TBRACCD_TERM_CODE
                                                 AND A1.TBBESTU_PIDM = A.TBRACCD_PIDM))
                     AND A.TBBESTU_EXEMPTION_PRIORITY = (SELECT MAX(TBBESTU_EXEMPTION_PRIORITY)
                                                         FROM TBBEXPT, TBBESTU A1, TBBDETC, TBREDET
                                                         WHERE TBBDETC_DETAIL_CODE = TBBEXPT_DETAIL_CODE
                                                         AND A1.TBBESTU_EXEMPTION_CODE  = TBBEXPT_EXEMPTION_CODE
                                                         AND A1.TBBESTU_TERM_CODE = TBBEXPT_TERM_CODE
                                                         AND TBREDET_EXEMPTION_CODE = TBBEXPT_EXEMPTION_CODE
                                                         AND TBREDET_TERM_CODE = TBBEXPT_TERM_CODE
                                                         AND (A1.TBBESTU_TERM_CODE = A.TBRACCD_TERM_CODE
                                                              OR
                                                              A1.TBBESTU_TERM_CODE = (SELECT MAX(TBBESTU_TERM_CODE)
                                                                                     FROM TBBEXPT, TBBESTU A2, TBBDETC, TBREDET
                                                                                     WHERE TBBDETC_DETAIL_CODE = TBBEXPT_DETAIL_CODE
                                                                                     AND A2.TBBESTU_EXEMPTION_CODE  = TBBEXPT_EXEMPTION_CODE
                                                                                     AND A2.TBBESTU_TERM_CODE = TBBEXPT_TERM_CODE
                                                                                     AND TBREDET_EXEMPTION_CODE = TBBEXPT_EXEMPTION_CODE
                                                                                     AND TBREDET_TERM_CODE = TBBEXPT_TERM_CODE
                                                                                     AND A2.TBBESTU_TERM_CODE <= A.TBRACCD_TERM_CODE
                                                                                     AND A2.TBBESTU_PIDM = A.TBRACCD_PIDM))
                                                         AND A1.TBBESTU_PIDM = A.TBRACCD_PIDM)
                     AND TBBESTU_PIDM = A.TBRACCD_PIDM
                     AND TBBESTU_DEL_IND IS NULL
                     AND TBBDETC_DCAT_CODE = 'DSP'
                     AND ROWNUM = 1),'0%')DESCUENTO,
                    (SELECT TBRACCD_DETAIL_CODE
                     FROM TBRACCD A1
                     WHERE A1.TBRACCD_PIDM = A.TBRACCD_PIDM
                     AND A1.TBRACCD_TRAN_NUMBER = (SELECT MAX(A.TBRAPPL_PAY_TRAN_NUMBER)
                                                   FROM TBRAPPL A
                                                   WHERE A.TBRAPPL_PIDM = A.TBRACCD_PIDM
                                                   AND A.TBRAPPL_REAPPL_IND IS NULL
                                                   AND A.TBRAPPL_CHG_TRAN_NUMBER = A.TBRACCD_TRAN_NUMBER))CANCELACION,
                     TBRACCD_RECEIPT_NUMBER ORDEN,
                     TBBDETC_DCAT_CODE CATE
                     FROM TBRACCD A,TBBDETC
                     WHERE A.TBRACCD_PIDM = P_PIDM---FGET_PIDM('010040470') ----AMARRAS PIDM
                     AND A.TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
                     AND TBBDETC_DCAT_CODE NOT IN ( 'TUI')
                     AND TBBDETC_TYPE_IND = 'C'
                     ORDER BY 7 DESC)CUR1
        WHERE (CANCELACION NOT LIKE ('%EZ') OR CANCELACION IS NULL)
        AND (CANCELACION NOT LIKE ('%Y7') OR CANCELACION IS NULL)
        AND (CANCELACION NOT LIKE ('%Y9') OR CANCELACION IS NULL)
        ORDER BY 3 DESC;

        RETURN (CURCARGOS_OUT);

    END F_CARGOS_OUT;

FUNCTION F_NUM_PAGOS (P_PIDM NUMBER) RETURN NUMBER IS

VL_PAGOS NUMBER:=0;

BEGIN

    BEGIN
       SELECT COUNT(*)
       INTO VL_PAGOS
       FROM TBRACCD
       WHERE 1=1
       AND TBRACCD_PIDM =  P_PIDM
       AND TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                   FROM TBBDETC
                                   WHERE TBBDETC_DCAT_CODE = 'CSH'
                                   AND TBBDETC_DESC != 'ANULA CANCELACION ERROR BANCA'
                                   AND TBBDETC_DESC != 'CANCELACION INGRESO ERROR BANC'
                                   AND TBBDETC_DESC NOT LIKE ('%DEV%')
                                   AND TBBDETC_DESC NOT LIKE ('%CTRACGO%'))
       ;

    EXCEPTION
    WHEN OTHERS THEN
     VL_PAGOS := 0;
    END;

    RETURN VL_PAGOS;

END F_NUM_PAGOS;

FUNCTION F_QUITAS (P_PIDM NUMBER) RETURN NUMBER IS

VL_QUITAS NUMBER;


BEGIN

   BEGIN

    SELECT COUNT(DISTINCT(TRUNC( TBRACCD_EFFECTIVE_DATE)))QUITAS
    INTO VL_QUITAS
    FROM TBRACCD
    WHERE 1=1
    AND SUBSTR(TBRACCD_DETAIL_CODE,3,2) = 'MS'
    AND TBRACCD_PIDM = P_PIDM
    ;

   EXCEPTION
   WHEN OTHERS THEN
    VL_QUITAS:=0;
   END;

   IF VL_QUITAS = 0 THEN /*SE AGREGA PARA IDENTIFICAR INCOBRABLES.*/

       BEGIN
       SELECT COUNT(DISTINCT( TBRACCD_PIDM))INCOBRABLES
        INTO VL_QUITAS
        FROM TBRACCD A
        WHERE 1=1
        AND SUBSTR(TBRACCD_DETAIL_CODE,3,2) = 'YM'
        AND A.TBRACCD_PIDM = P_PIDM
        AND A.TBRACCD_PIDM NOT IN (SELECT A1.TBRACCD_PIDM
                                 FROM TBRACCD A1
                                 WHERE A1.TBRACCD_PIDM = A.TBRACCD_PIDM
                                 AND SUBSTR(TBRACCD_DETAIL_CODE,3,2) = 'YN');


       EXCEPTION
       WHEN OTHERS THEN
        VL_QUITAS:=0;
       END;


   END IF;

   RETURN (VL_QUITAS);

END F_QUITAS;

PROCEDURE P_CARTERA_API  IS

VL_NUM_COL              NUMBER;
VL_COL_GENE             NUMBER;
VL_PARCIALIDADES        NUMBER;
VL_CODIGO               VARCHAR2(10);
VL_DESCRIPCION          VARCHAR2(50);
VL_MONTO                NUMBER;
VL_SFRRGFE_RATE_CODE    VARCHAR2(5);
VL_NEWPERIODO           VARCHAR2(11);

VL_CODIGO_DESC          VARCHAR2(5);
VL_DESCRIPCION_DESC     VARCHAR2(50);
VL_CODIGO_AFEC          VARCHAR2(5);
VL_MONTO_PERCENT        NUMBER;
VL_MONTO_AMOUNT         NUMBER;
VL_DESCUENTO            NUMBER;

VL_DESCUENTODSI         NUMBER;
VL_CODIGO_DSI           VARCHAR2(5);
VL_DESCRIPCION_DSI      VARCHAR2(50);
VL_CODIGO2              VARCHAR2(5);

VL_CODIGO_PLP           VARCHAR2(50);
VL_DESCRIPCION_PLP      VARCHAR2(50);
VL_SECUENCIA            NUMBER;
VL_SECUENCIACOL         NUMBER;
VL_PLAN_PAGO            NUMBER;

VL_ULT_COL              NUMBER;
VL_CODIGO_PAR           VARCHAR2(5);
VL_DESCRIPCION_PAR      VARCHAR2(50);
VL_PARCIALIDAD          NUMBER;

VL_DIA                  VARCHAR2(2);
VL_MES                  VARCHAR2(2);
VL_ANO                  VARCHAR2(4);
VL_VENCIMIENTO          DATE;

VL_DOCTR                NUMBER;
VL_SECUEN               NUMBER;
VL_ERROR                VARCHAR2(500);
VL_PERCOL               VARCHAR2(15);

    BEGIN

        FOR ALUMNO IN (

                    SELECT DISTINCT
                            D.SPRIDEN_ID MATRICULA,
                            A.SORLCUR_PIDM PIDM,
                            A.SORLCUR_PROGRAM PROGRAMA,
                            E.SZTDTEC_PROGRAMA_COMP PROGRAMA_DESC,
                            B.SGBSTDN_STST_CODE ESTATUS,
                            B.SGBSTDN_STYP_CODE TIPO_ALUMNO,
                            B.SGBSTDN_CAMP_CODE CAMPUS,
                            B.SGBSTDN_LEVL_CODE NIVEL,
                            B.SGBSTDN_TERM_CODE_EFF PERIODO,
                            A.SORLCUR_START_DATE FECHA_INICIO,
                            A.SORLCUR_VPDI_CODE PARTE_PERIODO,
                            A.SORLCUR_KEY_SEQNO STUDY_PATH,
                            CASE
                            SUBSTR (B.SGBSTDN_RATE_CODE, 1, 1)
                            WHEN  ('P') THEN SUBSTR (B.SGBSTDN_RATE_CODE, 2, 2)
                            WHEN  ('C') THEN SUBSTR (B.SGBSTDN_RATE_CODE, 3, 1)-- Se agrega
                            WHEN  ('J') THEN SUBSTR (B.SGBSTDN_RATE_CODE, 3, 1)
                            END  NUM_PAGOS,
                            (DECODE (SUBSTR (B.SGBSTDN_RATE_CODE, 4, 1), 'A', 15, 'B', '30', 'C', '10')) VENCIMIENTO,
                            SUBSTR (B.SGBSTDN_RATE_CODE, 1, 1) TIPO_PAGO,
                            B.SGBSTDN_RATE_CODE RATE,
                            DECODE (E.SZTDTEC_PERIODICIDAD, 1, 'Bime', 2, 'Cuatri', 3, 'Semes', 4, 'Anual') PERIODICIDAD,
                            (SELECT DISTINCT (SORLCUR_SITE_CODE)
                            FROM SORLCUR CUR
                            WHERE CUR.SORLCUR_PIDM = A.SORLCUR_PIDM
                            AND CUR.SORLCUR_LMOD_CODE = 'ADMISSIONS'
                       AND CUR.SORLCUR_SEQNO = (SELECT MAX (SORLCUR_SEQNO)
                                               FROM SORLCUR CUR2
                                               WHERE CUR2.SORLCUR_PIDM = CUR.SORLCUR_PIDM
                                               AND CUR2.SORLCUR_LMOD_CODE = CUR.SORLCUR_LMOD_CODE)
                                                           )PRE_ACTUALIZADO,
                            (SELECT MAX (T.SGRSATT_ATTS_CODE)
                            FROM SGRSATT T
                            WHERE T.SGRSATT_PIDM = A.SORLCUR_PIDM
                            AND T.SGRSATT_STSP_KEY_SEQUENCE = A.SORLCUR_KEY_SEQNO
                            AND REGEXP_LIKE  (T.SGRSATT_ATTS_CODE , '^[0-9]')
                            AND SUBSTR(T.SGRSATT_TERM_CODE_EFF,5,2) NOT IN (81,82,83)
                            AND T.SGRSATT_TERM_CODE_EFF = ( SELECT MAX(SGRSATT_TERM_CODE_EFF)
                                                   FROM SGRSATT TT
                                                   WHERE  TT.SGRSATT_PIDM =  T.SGRSATT_PIDM
                                                   AND  TT.SGRSATT_STSP_KEY_SEQUENCE= T.SGRSATT_STSP_KEY_SEQUENCE
                                                   AND SUBSTR(TT.SGRSATT_TERM_CODE_EFF,5,2) NOT IN (81,82,83)
                                                   AND REGEXP_LIKE  (T.SGRSATT_ATTS_CODE , '^[0-9]'))
                            AND T.SGRSATT_ACTIVITY_DATE = (SELECT MAX(SGRSATT_ACTIVITY_DATE)
                                               FROM SGRSATT T1
                                               WHERE T1.SGRSATT_PIDM = T.SGRSATT_PIDM
                                               AND T1.SGRSATT_STSP_KEY_SEQUENCE = T.SGRSATT_STSP_KEY_SEQUENCE
                                               AND T1.SGRSATT_TERM_CODE_EFF = T.SGRSATT_TERM_CODE_EFF
                                               AND SUBSTR(T1.SGRSATT_TERM_CODE_EFF,5,2) NOT IN (81,82,83)
                                               AND REGEXP_LIKE  (T.SGRSATT_ATTS_CODE , '^[0-9]')))JORNADA,
                            NVL((SELECT SUBSTR(TBBESTU_EXEMPTION_CODE,4,3)
                            FROM TBBEXPT, TBBESTU A, TBBDETC, TBREDET
                            WHERE TBBDETC_DETAIL_CODE = TBBEXPT_DETAIL_CODE
                            AND A.TBBESTU_EXEMPTION_CODE  = TBBEXPT_EXEMPTION_CODE
                            AND A.TBBESTU_TERM_CODE = TBBEXPT_TERM_CODE
                            AND A.TBBESTU_STUDENT_EXPT_ROLL_IND= 'Y'
                            AND A.TBBESTU_DEL_IND IS NULL
                            AND TBREDET_EXEMPTION_CODE = TBBEXPT_EXEMPTION_CODE
                            AND TBREDET_TERM_CODE = TBBEXPT_TERM_CODE
                            AND A.TBBESTU_TERM_CODE = (SELECT MAX(A1.TBBESTU_TERM_CODE)
                                          FROM TBBESTU A1
                                          WHERE A1.TBBESTU_PIDM = A.TBBESTU_PIDM
                                          AND A1.TBBESTU_STUDENT_EXPT_ROLL_IND = A.TBBESTU_STUDENT_EXPT_ROLL_IND
                                          AND A1.TBBESTU_DEL_IND IS NULL
                                          AND A1.TBBESTU_TERM_CODE <= B.SGBSTDN_TERM_CODE_EFF)
                            AND A.TBBESTU_EXEMPTION_PRIORITY = (SELECT MAX(TBBESTU_EXEMPTION_PRIORITY)
                                                    FROM TBBESTU A1
                                                    WHERE A1.TBBESTU_PIDM = A.TBBESTU_PIDM
                                                    AND A1.TBBESTU_STUDENT_EXPT_ROLL_IND = A.TBBESTU_STUDENT_EXPT_ROLL_IND
                                                    AND A1.TBBESTU_DEL_IND IS NULL
                                                    AND A1.TBBESTU_TERM_CODE = A.TBBESTU_TERM_CODE)
                            AND TBBESTU_PIDM = A.SORLCUR_PIDM
                            AND TBBDETC_DCAT_CODE = 'DSP'),0)DESCUENTO,
                           (SELECT SUBSTR(TEXTO,LARGO,2)
                            FROM(
                            SELECT SARACMT_COMMENT_TEXT TEXTO,LENGTH (SARACMT_COMMENT_TEXT)-1 LARGO
                              FROM SARACMT MT
                             WHERE    MT.SARACMT_PIDM = A.SORLCUR_PIDM
                                  AND MT.SARACMT_APPL_NO = A.SORLCUR_APPL_KEY_SEQNO
                                  AND MT.SARACMT_ORIG_CODE = 'PAQT'
                                  AND MT.SARACMT_SEQNO = (SELECT MAX(SARACMT_SEQNO)
                                                            FROM SARACMT
                                                           WHERE     SARACMT_PIDM = MT.SARACMT_PIDM
                                                                 AND SARACMT_ORIG_CODE = 'PAQT'
                                                                 AND SARACMT_APPL_NO = MT.SARACMT_APPL_NO)
                            )
                            WHERE 1=1)PAGOS_PLAN,
                            DECODE (A.SORLCUR_DEGC_CODE, 'DIPL', 'COLEGIATURA DIPLOMADO', 'CURS', 'COLEGIATURA CURSO')DEGC_CODE
                    FROM SORLCUR A, SGBSTDN B, SPRIDEN D, SZTDTEC E
                    WHERE A.SORLCUR_LMOD_CODE = 'LEARNER'
                    AND A.SORLCUR_ROLL_IND  = 'Y'
                    AND A.SORLCUR_CACT_CODE = 'ACTIVE'
                    AND A.SORLCUR_SEQNO = (SELECT MAX (A1.SORLCUR_SEQNO)
                                           FROM SORLCUR A1
                                           WHERE A1.SORLCUR_PIDM = A.SORLCUR_PIDM
                                           AND A1.SORLCUR_ROLL_IND  = A.SORLCUR_ROLL_IND
                                           AND A1.SORLCUR_CACT_CODE = A.SORLCUR_CACT_CODE
                                           AND A1.SORLCUR_PROGRAM = A.SORLCUR_PROGRAM
                                           AND A1.SORLCUR_LMOD_CODE = A.SORLCUR_LMOD_CODE)
                    AND A.SORLCUR_PIDM =  B.SGBSTDN_PIDM
                    AND A.SORLCUR_PROGRAM = B.SGBSTDN_PROGRAM_1
                    AND B.SGBSTDN_TERM_CODE_EFF IN (SELECT MAX (B1.SGBSTDN_TERM_CODE_EFF)
                                                    FROM SGBSTDN B1
                                                    WHERE B.SGBSTDN_PIDM = B1.SGBSTDN_PIDM
                                                    AND B.SGBSTDN_PROGRAM_1 = B1.SGBSTDN_PROGRAM_1)
                    AND E.SZTDTEC_PROGRAM = B.SGBSTDN_PROGRAM_1
                    AND A.SORLCUR_TERM_CODE_CTLG = E.SZTDTEC_TERM_CODE
                    AND D.SPRIDEN_PIDM = SGBSTDN_PIDM
                    AND D.SPRIDEN_CHANGE_IND IS NULL
                    AND LAST_DAY(A.SORLCUR_START_DATE) <= LAST_DAY(TRUNC(SYSDATE))
                    AND A.SORLCUR_PIDM NOT IN (SELECT TZDOCTR_PIDM
                                                FROM TZDOCTR
                                                WHERE TZDOCTR_PIDM = A.SORLCUR_PIDM
                                                AND LAST_DAY(TZDOCTR_START_DATE) = LAST_DAY(TRUNC(SYSDATE))
                                                AND TZDOCTR_TIPO_PROC != 'AUME')--CART
                    AND A.SORLCUR_PIDM NOT IN (SELECT TZDOCTR_PIDM
                                                FROM TZDOCTR
                                                WHERE TZDOCTR_PIDM = A.SORLCUR_PIDM
                                                AND TZDOCTR_OBSERVACIONES = 'CARTERA FINAL PROCESADA')
                    AND A.SORLCUR_CAMP_CODE IN (SELECT ZSTPARA_PARAM_ID
                                                FROM ZSTPARA
                                                WHERE ZSTPARA_MAPA_ID = 'CART_SINMA'
                                                AND ZSTPARA_PARAM_VALOR = 1)
                    ORDER BY 1, 8, 9
        )LOOP

            VL_NUM_COL              :=NULL;
            VL_COL_GENE             :=NULL;
            VL_PARCIALIDADES        :=NULL;
            VL_CODIGO               :=NULL;
            VL_DESCRIPCION          :=NULL;
            VL_MONTO                :=NULL;
            VL_SFRRGFE_RATE_CODE    :=NULL;
            VL_NEWPERIODO           :=NULL;
            VL_CODIGO_DESC          :=NULL;
            VL_DESCRIPCION_DESC     :=NULL;
            VL_CODIGO_AFEC          :=NULL;
            VL_MONTO_PERCENT        :=NULL;
            VL_MONTO_AMOUNT         :=NULL;
            VL_DESCUENTO            :=NULL;
            VL_DESCUENTODSI         :=NULL;
            VL_CODIGO_DSI           :=NULL;
            VL_DESCRIPCION_DSI      :=NULL;
            VL_CODIGO2              :=NULL;
            VL_CODIGO_PLP           :=NULL;
            VL_DESCRIPCION_PLP      :=NULL;
            VL_SECUENCIA            :=NULL;
            VL_SECUENCIACOL         :=NULL;
            VL_PLAN_PAGO            :=NULL;
            VL_ULT_COL              :=NULL;
            VL_CODIGO_PAR           :=NULL;
            VL_DESCRIPCION_PAR      :=NULL;
            VL_PARCIALIDAD          :=NULL;
            VL_DIA                  :=NULL;
            VL_MES                  :=NULL;
            VL_ANO                  :=NULL;
            VL_VENCIMIENTO          :=NULL;
            VL_DOCTR                :=NULL;
            VL_SECUEN               :=NULL;
            VL_ERROR                :=NULL;
            VL_PERCOL               :=NULL;

          BEGIN

            BEGIN
              SELECT DISTINCT TBRACCD_TERM_CODE
                INTO VL_PERCOL
                FROM TBRACCD
               WHERE     TBRACCD_PIDM = ALUMNO.PIDM
                     AND TBRACCD_TRAN_NUMBER = (SELECT MAX(TBRACCD_TRAN_NUMBER)
                                                   FROM TBBDETC,TBRACCD
                                                  WHERE TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
                                                  AND TBRACCD_PIDM = ALUMNO.PIDM
                                                  AND TBRACCD_DOCUMENT_NUMBER IS NULL
                                                  AND TBBDETC_DCAT_CODE = 'COL')
                  ;

            EXCEPTION
            WHEN OTHERS THEN
            VL_COL_GENE:=0;
            END;

            IF SUBSTR(VL_PERCOL ,5,1) = 4 THEN

                IF SUBSTR(VL_PERCOL ,6,1) = 1 THEN

                 VL_NEWPERIODO:= SUBSTR(VL_PERCOL ,1,5)||(SUBSTR(VL_PERCOL ,6,1)+1);

                ELSIF SUBSTR(VL_PERCOL ,6,1) = 2 THEN

                 VL_NEWPERIODO:= SUBSTR(VL_PERCOL ,1,5)||(SUBSTR(VL_PERCOL ,6,1)+1);

                ELSIF SUBSTR(VL_PERCOL ,6,1) = 3 THEN

                 VL_NEWPERIODO:= SUBSTR(VL_PERCOL ,1,2)||(SUBSTR(VL_PERCOL ,3,2)+1||SUBSTR(VL_PERCOL ,5,1)||1);

                END IF;

            END IF;

          END;

          BEGIN

              SELECT COUNT(*)
              INTO VL_COL_GENE
              FROM TBRACCD
              WHERE TBRACCD_PIDM = ALUMNO.PIDM
              AND TBRACCD_DOCUMENT_NUMBER IS NULL
              AND TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                          FROM TBBDETC
                                          WHERE TBBDETC_DCAT_CODE = 'COL')
              ;

          EXCEPTION
          WHEN OTHERS THEN
          VL_COL_GENE:=0;
          END;

--          DBMS_OUTPUT.PUT_LINE ('reza valida 1'||'---'||VL_COL_GENE);

          IF VL_COL_GENE > 0 THEN

            BEGIN

                SELECT COUNT(*)
                INTO VL_NUM_COL
                FROM TBRACCD
                WHERE TBRACCD_PIDM = ALUMNO.PIDM
                AND TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                            FROM TBBDETC
                                            WHERE TBBDETC_DCAT_CODE = 'COL')
                AND TBRACCD_DOCUMENT_NUMBER IS NULL
                AND LAST_DAY(TBRACCD_EFFECTIVE_DATE) = LAST_DAY(TRUNC(SYSDATE))
                ;
            EXCEPTION
            WHEN OTHERS THEN
            VL_NUM_COL:=0;
            END;

--            DBMS_OUTPUT.PUT_LINE ('reza valida 1'||'---'||VL_NUM_COL);

            IF VL_NUM_COL = 0 THEN

              IF alumno.PRE_ACTUALIZADO IS NOT NULL THEN

--              DBMS_OUTPUT.PUT_LINE ('PRE_ACTUALIZADO 1'||'---'||VL_NUM_COL);

                BEGIN

                    SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                    INTO VL_CODIGO, VL_DESCRIPCION, VL_MONTO,  VL_SFRRGFE_RATE_CODE
                    FROM SFRRGFE A , TBBDETC
                    WHERE TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                    AND  A.SFRRGFE_TERM_CODE= ALUMNO.PERIODO
                    AND A.SFRRGFE_TYPE = 'STUDENT'
                    AND SFRRGFE_ENTRY_TYPE = 'R'
                    AND A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                    AND A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                    AND A.SFRRGFE_ATTS_CODE = ALUMNO.JORNADA
                    AND A.SFRRGFE_RATE_CODE = ALUMNO.RATE
                    AND A.SFRRGFE_DEPT_CODE = ALUMNO.PRE_ACTUALIZADO
                    AND A.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA
                    AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                          FROM SFRRGFE A1
                                          WHERE A1.SFRRGFE_TERM_CODE = A.SFRRGFE_TERM_CODE
                                          AND A1.SFRRGFE_TYPE = A.SFRRGFE_TYPE
                                          AND A1.SFRRGFE_ENTRY_TYPE = A.SFRRGFE_ENTRY_TYPE
                                          AND A1.SFRRGFE_LEVL_CODE = A.SFRRGFE_LEVL_CODE
                                          AND A1.SFRRGFE_CAMP_CODE = A.SFRRGFE_CAMP_CODE
                                          AND A1.SFRRGFE_ATTS_CODE = A.SFRRGFE_ATTS_CODE
                                          AND A1.SFRRGFE_RATE_CODE = A.SFRRGFE_RATE_CODE
                                          AND A1.SFRRGFE_DEPT_CODE = A.SFRRGFE_DEPT_CODE
                                          AND A1.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA);

                EXCEPTION
                WHEN NO_DATA_FOUND THEN

                    BEGIN

                        SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                        INTO VL_CODIGO, VL_DESCRIPCION, VL_MONTO,  VL_SFRRGFE_RATE_CODE
                        FROM SFRRGFE A , TBBDETC
                        WHERE TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                        AND  A.SFRRGFE_TERM_CODE= ALUMNO.PERIODO
                        AND A.SFRRGFE_TYPE = 'STUDENT'
                        AND SFRRGFE_ENTRY_TYPE = 'R'
                        AND A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                        AND A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                        AND A.SFRRGFE_ATTS_CODE = ALUMNO.JORNADA--ALUMNO.JORNADA
                        AND A.SFRRGFE_RATE_CODE = ALUMNO.RATE
                        AND A.SFRRGFE_DEPT_CODE = alumno.PRE_ACTUALIZADO
                        AND A.SFRRGFE_PROGRAM IS NULL
                        AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                              FROM SFRRGFE A1
                                              WHERE A1.SFRRGFE_TERM_CODE = A.SFRRGFE_TERM_CODE
                                              AND A1.SFRRGFE_TYPE = A.SFRRGFE_TYPE
                                              AND A1.SFRRGFE_ENTRY_TYPE = A.SFRRGFE_ENTRY_TYPE
                                              AND A1.SFRRGFE_LEVL_CODE = A.SFRRGFE_LEVL_CODE
                                              AND A1.SFRRGFE_CAMP_CODE = A.SFRRGFE_CAMP_CODE
                                              AND A1.SFRRGFE_ATTS_CODE = A.SFRRGFE_ATTS_CODE
                                              AND A1.SFRRGFE_RATE_CODE = A.SFRRGFE_RATE_CODE
                                              AND A1.SFRRGFE_DEPT_CODE = A.SFRRGFE_DEPT_CODE
                                              AND A1.SFRRGFE_PROGRAM IS NULL);

                    EXCEPTION
                    WHEN OTHERS THEN
                      VL_ERROR :='Validar Regla de Cobro, Parametros = '||ALUMNO.PERIODO||'  -  '||NVL(ALUMNO.JORNADA,'SIN JORNADA')||'  -  '||ALUMNO.RATE||' código aumento '||NVL(alumno.PRE_ACTUALIZADO,'NULL');
                      VL_CODIGO := NULL;
                      VL_DESCRIPCION := NULL;
                      VL_MONTO := NULL;
                    END;

                END;

--                dBMS_OUTPUT.PUT_LINE ('final 1 '||'---'||VL_ERROR);

              ELSIF alumno.PRE_ACTUALIZADO IS  NULL THEN

--              DBMS_OUTPUT.PUT_LINE ('PRE_ACTUALIZADO 2 '||'---'||VL_NUM_COL);

                BEGIN

                    SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                    INTO VL_CODIGO, VL_DESCRIPCION, VL_MONTO,  VL_SFRRGFE_RATE_CODE
                    FROM SFRRGFE A , TBBDETC
                    WHERE TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                    AND  A.SFRRGFE_TERM_CODE = ALUMNO.PERIODO
                    AND A.SFRRGFE_TYPE = 'STUDENT'
                    AND SFRRGFE_ENTRY_TYPE = 'R'
                    AND A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                    AND A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                    AND A.SFRRGFE_ATTS_CODE = ALUMNO.JORNADA--ALUMNO.JORNADA
                    AND A.SFRRGFE_RATE_CODE = ALUMNO.RATE
                    AND A.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA
                    AND A.SFRRGFE_DEPT_CODE IS NULL
                    AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                          FROM SFRRGFE A1
                                          WHERE A1.SFRRGFE_TERM_CODE = A.SFRRGFE_TERM_CODE
                                          AND A1.SFRRGFE_TYPE = A.SFRRGFE_TYPE
                                          AND A1.SFRRGFE_ENTRY_TYPE = A.SFRRGFE_ENTRY_TYPE
                                          AND A1.SFRRGFE_LEVL_CODE = A.SFRRGFE_LEVL_CODE
                                          AND A1.SFRRGFE_CAMP_CODE = A.SFRRGFE_CAMP_CODE
                                          AND A1.SFRRGFE_ATTS_CODE = A.SFRRGFE_ATTS_CODE
                                          AND A1.SFRRGFE_RATE_CODE = A.SFRRGFE_RATE_CODE
                                          AND A1.SFRRGFE_DEPT_CODE IS NULL
                                          AND A1.SFRRGFE_PROGRAM = ALUMNO.PROGRAMA);
                EXCEPTION
                WHEN OTHERS THEN

                    BEGIN

                        SELECT  A.SFRRGFE_DETL_CODE, TBBDETC_DESC, A.SFRRGFE_MAX_CHARGE, A.SFRRGFE_RATE_CODE
                        INTO VL_CODIGO, VL_DESCRIPCION, VL_MONTO,  VL_SFRRGFE_RATE_CODE
                        FROM SFRRGFE A , TBBDETC
                        WHERE TBBDETC_DETAIL_CODE = SFRRGFE_DETL_CODE
                        AND  A.SFRRGFE_TERM_CODE= ALUMNO.PERIODO
                        AND A.SFRRGFE_TYPE = 'STUDENT'
                        AND SFRRGFE_ENTRY_TYPE = 'R'
                        AND A.SFRRGFE_LEVL_CODE = ALUMNO.NIVEL
                        AND A.SFRRGFE_CAMP_CODE = ALUMNO.CAMPUS
                        AND A.SFRRGFE_ATTS_CODE = ALUMNO.JORNADA--ALUMNO.JORNADA
                        AND A.SFRRGFE_RATE_CODE = ALUMNO.RATE
                        AND A.SFRRGFE_DEPT_CODE IS NULL
                        AND A.SFRRGFE_PROGRAM IS NULL
                        AND A.SFRRGFE_SEQNO = (SELECT MAX(A1.SFRRGFE_SEQNO)
                                              FROM SFRRGFE A1
                                              WHERE A1.SFRRGFE_TERM_CODE = A.SFRRGFE_TERM_CODE
                                              AND A1.SFRRGFE_TYPE = A.SFRRGFE_TYPE
                                              AND A1.SFRRGFE_ENTRY_TYPE = A.SFRRGFE_ENTRY_TYPE
                                              AND A1.SFRRGFE_LEVL_CODE = A.SFRRGFE_LEVL_CODE
                                              AND A1.SFRRGFE_CAMP_CODE = A.SFRRGFE_CAMP_CODE
                                              AND A1.SFRRGFE_ATTS_CODE = A.SFRRGFE_ATTS_CODE
                                              AND A1.SFRRGFE_RATE_CODE = A.SFRRGFE_RATE_CODE
                                              AND A1.SFRRGFE_DEPT_CODE IS NULL
                                              AND A1.SFRRGFE_PROGRAM IS NULL);
                    EXCEPTION
                    WHEN OTHERS THEN
                          VL_ERROR :='Validar Regla de Cobro, Parametros = '||ALUMNO.PERIODO||'  -  '||NVL(ALUMNO.JORNADA,'SIN JORNADA')||'  -  '||ALUMNO.RATE||' código aumento '||NVL(alumno.PRE_ACTUALIZADO,'NULL');
                          VL_CODIGO := NULL;
                          VL_DESCRIPCION := NULL;
                          VL_MONTO := NULL;
                    END;


--                    dBMS_OUTPUT.PUT_LINE ('final 2 '||'---'||VL_ERROR);

                END;

--                DBMS_OUTPUT.PUT_LINE ('reza valida 1'||'---'||VL_ERROR);

              END IF;

              VL_PARCIALIDADES:= ALUMNO.PAGOS_PLAN - VL_COL_GENE;

              IF VL_ERROR IS NULL THEN

                 IF VL_PARCIALIDADES <= ALUMNO.NUM_PAGOS AND VL_PARCIALIDADES > 0 THEN

                    -------------------------------------------      se genera cartera modificando parametros                --------------------------------------------
                    -------------------------------------------      de acuerdo a los pagos pendientes del plan de  venta    --------------------------------------------
                    -------------------------------------------     (Colegiaturas generadas - colegiaturas pendientes)       --------------------------------------------

                    BEGIN

                      BEGIN

                            SELECT DISTINCT TBBDETC_DETAIL_CODE,TBBDETC_DESC, TBREDET_DETAIL_CODE,TBREDET_PERCENT,TBREDET_MAX_AMOUNT
                            INTO VL_CODIGO_DESC,VL_DESCRIPCION_DESC, VL_CODIGO_AFEC, VL_MONTO_PERCENT, VL_MONTO_AMOUNT
                            FROM TBBEXPT, TBBESTU A, TBBDETC, TBREDET
                            WHERE TBBDETC_DETAIL_CODE = TBBEXPT_DETAIL_CODE
                            AND A.TBBESTU_EXEMPTION_CODE  = TBBEXPT_EXEMPTION_CODE
                            AND A.TBBESTU_TERM_CODE         = TBBEXPT_TERM_CODE
                            AND A.TBBESTU_STUDENT_EXPT_ROLL_IND= 'Y'
                            AND A.TBBESTU_DEL_IND IS NULL
                            AND TBREDET_EXEMPTION_CODE = TBBEXPT_EXEMPTION_CODE
                            AND TBREDET_TERM_CODE = TBBEXPT_TERM_CODE
                            AND A.TBBESTU_TERM_CODE = (SELECT MAX(A1.TBBESTU_TERM_CODE)
                                                      FROM TBBESTU A1
                                                      WHERE A1.TBBESTU_PIDM = A.TBBESTU_PIDM
                                                      AND A1.TBBESTU_STUDENT_EXPT_ROLL_IND = A.TBBESTU_STUDENT_EXPT_ROLL_IND
                                                      AND A1.TBBESTU_DEL_IND IS NULL
                                                      AND A1.TBBESTU_TERM_CODE <= ALUMNO.PERIODO)
                            AND A.TBBESTU_EXEMPTION_PRIORITY = (SELECT MAX(TBBESTU_EXEMPTION_PRIORITY)
                                                                FROM TBBESTU A1
                                                                WHERE A1.TBBESTU_PIDM = A.TBBESTU_PIDM
                                                                AND A1.TBBESTU_STUDENT_EXPT_ROLL_IND = A.TBBESTU_STUDENT_EXPT_ROLL_IND
                                                                AND A1.TBBESTU_DEL_IND IS NULL
                                                                AND A1.TBBESTU_TERM_CODE = A.TBBESTU_TERM_CODE)
                            AND TBBESTU_PIDM = ALUMNO.PIDM
                            AND TBBDETC_DCAT_CODE = 'DSP';

                      EXCEPTION
                      WHEN OTHERS THEN
                        VL_CODIGO_DESC := NULL;
                        VL_DESCRIPCION_DESC := NULL;
                        VL_CODIGO_AFEC := NULL;
                        VL_MONTO_PERCENT := NULL;
                        VL_MONTO_AMOUNT := NULL;

                      END;


                      BEGIN

                            SELECT DISTINCT TZTDMTO_MONTO  ,TZTDMTO_DESC_CODE , TZTDMTO_OBSERVACIONES
                            INTO VL_DESCUENTODSI, VL_CODIGO_DSI,VL_DESCRIPCION_DSI
                            FROM TZTDMTO A
                            WHERE A.TZTDMTO_PIDM   = ALUMNO.PIDM
                            AND A.TZTDMTO_CAMP_CODE = ALUMNO.CAMPUS
                            AND A.TZTDMTO_NIVEL  = ALUMNO.NIVEL
                            AND A.TZTDMTO_PROGRAMA =  ALUMNO.PROGRAMA
                            AND A.TZTDMTO_TERM_CODE  = ALUMNO.PERIODO
                            AND A.TZTDMTO_MONTO = (SELECT MAX (TZTDMTO_MONTO)
                                                   FROM TZTDMTO A1
                                                   WHERE A1.TZTDMTO_PIDM = A.TZTDMTO_PIDM
                                                   AND A1.TZTDMTO_CAMP_CODE = A.TZTDMTO_CAMP_CODE
                                                   AND A1.TZTDMTO_NIVEL = A.TZTDMTO_NIVEL
                                                   AND A1.TZTDMTO_TERM_CODE = A.TZTDMTO_TERM_CODE
                                                   AND A1.TZTDMTO_IND = 1
                                                   AND A1.TZTDMTO_PROGRAMA = A.TZTDMTO_PROGRAMA)
                            AND TZTDMTO_IND = 1 ;

                      EXCEPTION WHEN OTHERS THEN
                      VL_DESCUENTODSI := 0;
                      END;

                      BEGIN

                            SELECT A.TBRACCD_AMOUNT,TBRACCD_DETAIL_CODE,TBRACCD_DESC
                            INTO VL_ULT_COL,VL_CODIGO_PAR,VL_DESCRIPCION_PAR
                            FROM TBRACCD A
                            WHERE A.TBRACCD_PIDM = ALUMNO.PIDM
                            AND A.TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                                          FROM TBBDETC
                                                          WHERE TBBDETC_DCAT_CODE = 'COL'
                                                          AND TBBDETC_DESC != 'COLEGIATURA EXTRAORDINARIO')
                            AND A.TBRACCD_TRAN_NUMBER = (SELECT MAX(TBRACCD_TRAN_NUMBER)
                                                         FROM TBRACCD A1
                                                         WHERE TBRACCD_PIDM = A.TBRACCD_PIDM
                                                         AND TBRACCD_DETAIL_CODE = A.TBRACCD_DETAIL_CODE)
                            ;
                      EXCEPTION
                      WHEN OTHERS THEN
                      VL_ULT_COL:=0;
                      END;

                      BEGIN
                            SELECT TBBDETC_DETAIL_CODE, TBBDETC_DESC
                            INTO VL_CODIGO_PLP, VL_DESCRIPCION_PLP
                            FROM TBBDETC
                            WHERE TBBDETC_DCAT_CODE = 'LPC'
                            AND TBBDETC_DETAIL_CODE = 'PLPA'
                            AND TBBDETC_DETC_ACTIVE_IND = 'Y';
                      EXCEPTION
                      WHEN OTHERS THEN
                      VL_CODIGO_PLP:= NULL;
                      VL_DESCRIPCION_PLP:= NULL;
                      END;

                      IF VL_CODIGO_DESC IS NULL AND VL_DESCUENTODSI = 0 THEN

                        VL_MONTO:= VL_PARCIALIDADES*VL_ULT_COL;

                        VL_PLAN_PAGO:= VL_PARCIALIDADES*VL_ULT_COL;

                      ELSIF VL_CODIGO_DESC IS NOT NULL AND VL_DESCUENTODSI = 0 THEN

                          VL_MONTO:= VL_MONTO/ALUMNO.NUM_PAGOS;
                          VL_MONTO:= VL_MONTO*VL_PARCIALIDADES;
                          VL_DESCUENTO := VL_MONTO-(VL_PARCIALIDADES*VL_ULT_COL);
                          VL_PLAN_PAGO:= VL_PARCIALIDADES*VL_ULT_COL;

                      ELSIF VL_CODIGO_DESC IS NOT NULL AND VL_DESCUENTODSI > 0 THEN

                          VL_MONTO:= VL_MONTO/ALUMNO.NUM_PAGOS;
                          VL_MONTO:= VL_MONTO*VL_PARCIALIDADES;

                        IF VL_MONTO_PERCENT IS NOT NULL THEN

                            VL_DESCUENTO := VL_MONTO*(VL_MONTO_PERCENT/100);

                        ELSIF VL_MONTO_AMOUNT IS NOT NULL THEN

                            VL_DESCUENTO := VL_MONTO_AMOUNT;
                            VL_DESCUENTO := VL_DESCUENTO/ALUMNO.NUM_PAGOS;
                            VL_DESCUENTO := ROUND(VL_DESCUENTO*VL_PARCIALIDADES,0);

                        END IF;

                          VL_DESCUENTODSI := VL_MONTO-(VL_PARCIALIDADES*VL_ULT_COL)-VL_DESCUENTO;
                          VL_PLAN_PAGO:= VL_PARCIALIDADES*VL_ULT_COL;

                      ELSIF VL_CODIGO_DESC IS NULL AND VL_DESCUENTODSI > 0 THEN

                        VL_MONTO:= VL_MONTO/ALUMNO.NUM_PAGOS;
                        VL_MONTO:= VL_MONTO*VL_PARCIALIDADES;
                        VL_PLAN_PAGO:= VL_PARCIALIDADES*VL_ULT_COL;
                        VL_DESCUENTODSI := VL_MONTO-(VL_PARCIALIDADES*VL_ULT_COL);

                      END IF;

                      IF VL_ERROR IS NULL THEN

                        VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);

                        VL_SECUENCIACOL := VL_SECUENCIA;

                        VL_ERROR:= PKG_FINANZAS.F_INSERTA_TBRACCD(
                                                        P_PIDM              => ALUMNO.PIDM
                                                      , P_SECUENCIA         => VL_SECUENCIACOL--vl_secuencia
                                                      , P_NUMBER_PAID       => NULL
                                                      , P_PERIODO           => VL_NEWPERIODO
                                                      , P_PARTE_PERIODO     => ALUMNO.PARTE_PERIODO
                                                      , P_CODIGO            => VL_CODIGO
                                                      , P_MONTO             => VL_MONTO--vl_monto
                                                      , P_BALANCE           => VL_MONTO--vl_monto
                                                      , P_FECHA_VENC        => TRUNC(SYSDATE)--sysdate
                                                      , P_DESCRIP           => VL_DESCRIPCION
                                                      , P_STUDY_PATH        => ALUMNO.STUDY_PATH
                                                      , P_ORIGEN            => 'TZFEDCA (COL)'
                                                      , P_FECHA_INICIO      => ALUMNO.FECHA_INICIO
                                                      ) ;




                      END IF;


                      IF VL_CODIGO_DESC IS NOT NULL THEN

                          VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);

                          VL_ERROR:=PKG_FINANZAS.F_INSERTA_TBRACCD(    P_PIDM                => ALUMNO.PIDM
                                                        , P_SECUENCIA           => VL_SECUENCIA
                                                        , P_NUMBER_PAID         => VL_SECUENCIACOL
                                                        , P_PERIODO             => VL_NEWPERIODO
                                                        , P_PARTE_PERIODO       => ALUMNO.PARTE_PERIODO
                                                        , P_CODIGO              => VL_CODIGO_DESC
                                                        , P_MONTO               => VL_DESCUENTO
                                                        , P_BALANCE             => VL_DESCUENTO*-1
                                                        , P_FECHA_VENC          => TRUNC(SYSDATE)--sysdate
                                                        , P_DESCRIP             => VL_DESCRIPCION_DESC
                                                        , P_STUDY_PATH          => ALUMNO.STUDY_PATH
                                                        , P_ORIGEN              => 'TZFEDCA (DSP)'
                                                        ,P_FECHA_INICIO         => ALUMNO.FECHA_INICIO
                                                        ) ;
                      END IF;


                      IF VL_CODIGO_DSI IS NOT NULL THEN

                        VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);

                        VL_ERROR:=PKG_FINANZAS.F_INSERTA_TBRACCD(
                                                      P_PIDM                => ALUMNO.PIDM
                                                    , P_SECUENCIA           => VL_SECUENCIA
                                                    , P_NUMBER_PAID         => VL_SECUENCIACOL--vl_tran_num
                                                    , P_PERIODO             => VL_NEWPERIODO
                                                    , P_PARTE_PERIODO       => ALUMNO.PARTE_PERIODO
                                                    , P_CODIGO              => VL_CODIGO_DSI
                                                    , P_MONTO               => VL_DESCUENTODSI
                                                    , P_BALANCE             => VL_DESCUENTODSI*-1
                                                    , P_FECHA_VENC          => TRUNC(SYSDATE)
                                                    , P_DESCRIP             => VL_DESCRIPCION_DSI
                                                    , P_STUDY_PATH          => ALUMNO.STUDY_PATH
                                                    , P_ORIGEN              => 'TZFEDCA (DSI)'
                                                    ,P_FECHA_INICIO         => ALUMNO.FECHA_INICIO
                                                     ) ;

                      END IF;


                      IF VL_ERROR IS NULL THEN

                       VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);

                       VL_ERROR:=PKG_FINANZAS.F_INSERTA_TBRACCD(
                                                      P_PIDM                => ALUMNO.PIDM
                                                    , P_SECUENCIA           => VL_SECUENCIA
                                                    , P_NUMBER_PAID         => VL_SECUENCIACOL--vl_tran_num
                                                    , P_PERIODO             => VL_NEWPERIODO
                                                    , P_PARTE_PERIODO       => ALUMNO.PARTE_PERIODO
                                                    , P_CODIGO              => VL_CODIGO_PLP
                                                    , P_MONTO               => VL_PLAN_PAGO--vl_monto2
                                                    , P_BALANCE             => VL_PLAN_PAGO*-1 --vl_monto2*-1
                                                    , P_FECHA_VENC          => TRUNC(SYSDATE)
                                                    , P_DESCRIP             => VL_DESCRIPCION_PLP
                                                    , P_STUDY_PATH          => ALUMNO.STUDY_PATH
                                                    , P_ORIGEN              => 'TZFEDCA (PLPA)'
                                                    ,P_FECHA_INICIO         => ALUMNO.FECHA_INICIO
                                                      ) ;
                      END IF;



                      IF VL_ERROR IS NULL THEN

                            VL_DIA := CASE SUBSTR(VL_SFRRGFE_RATE_CODE,4,1) WHEN 'A' THEN 15 WHEN 'B' THEN 30 WHEN 'C' THEN 10 END;
                            VL_MES := SUBSTR (TO_CHAR(TRUNC(SYSDATE),'dd/mm/rrrr'), 4, 2);
                            VL_ANO := SUBSTR (TO_CHAR(TRUNC(SYSDATE),'dd/mm/rrrr'), 7, 4);

                        BEGIN

                          FOR I IN 1..VL_PARCIALIDADES

                           LOOP

                             IF VL_DIA = '30' THEN
                               VL_VENCIMIENTO := TO_DATE(CASE LPAD(VL_MES,2,'0') WHEN '02' THEN '28' ELSE VL_DIA END||'/'||LPAD(VL_MES,2,'0')||'/'||VL_ANO,'DD/MM/YYYY');
                             ELSE
                               VL_VENCIMIENTO := TO_DATE(VL_DIA||'/'||LPAD(VL_MES,2,'0')||'/'||VL_ANO,'DD/MM/YYYY');
                             END IF;

                              VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);

                             IF VL_ERROR IS NULL THEN

                                VL_ERROR:= PKG_FINANZAS.F_INSERTA_TBRACCD(
                                                              P_PIDM            => ALUMNO.PIDM
                                                            , P_SECUENCIA       => VL_SECUENCIA
                                                            , P_NUMBER_PAID     => NULL
                                                            , P_PERIODO         => VL_NEWPERIODO
                                                            , P_PARTE_PERIODO   => ALUMNO.PARTE_PERIODO
                                                            , P_CODIGO          => VL_CODIGO_PAR
                                                            , P_MONTO           => VL_ULT_COL--vl_monto2/alumno.num_pagos
                                                            , P_BALANCE         => VL_ULT_COL--vl_monto2/alumno.num_pagos
                                                            , P_FECHA_VENC      => VL_VENCIMIENTO
                                                            , P_DESCRIP         => VL_DESCRIPCION_PAR
                                                            , P_STUDY_PATH      => ALUMNO.STUDY_PATH
                                                            , P_ORIGEN          => 'TZFEDCA (PARC)'
                                                            ,P_FECHA_INICIO     => ALUMNO.FECHA_INICIO
                                                            );

                                 VL_MES := VL_MES +1;

                                 IF VL_MES = '13' THEN
                                    VL_MES := '01';
                                    VL_ANO := VL_ANO +1;
                                 END IF;

                             END IF;

                           END LOOP;

                        END;

                      END IF;

                    END;

                    IF VL_ERROR IS NULL THEN


                       BEGIN

                              SELECT MAX(TZTORDR_CONTADOR)+1
                              INTO VL_SECUEN
                              FROM TZTORDR
                              ;

                       EXCEPTION
                       WHEN OTHERS THEN
                       VL_SECUEN:= NULL;
                       END;

                       IF VL_SECUEN IS NOT NULL THEN

                          BEGIN

                            INSERT INTO TZTORDR
                            (
                              TZTORDR_CAMPUS,
                              TZTORDR_NIVEL,
                              TZTORDR_CONTADOR,
                              TZTORDR_PROGRAMA,
                              TZTORDR_PIDM,
                              TZTORDR_ID,
                              TZTORDR_ESTATUS,
                              TZTORDR_ACTIVITY_DATE,
                              TZTORDR_USER,
                              TZTORDR_DATA_ORIGIN,
                              TZTORDR_NO_REGLA,
                              TZTORDR_FECHA_INICIO,
                              TZTORDR_RATE,
                              TZTORDR_JORNADA,
                              TZTORDR_DSI,
                              TZTORDR_TERM_CODE
                            )
                            VALUES( ALUMNO.CAMPUS,
                                    ALUMNO.NIVEL,
                                    VL_SECUEN,
                                    ALUMNO.PROGRAMA,
                                    ALUMNO.PIDM,
                                    ALUMNO.MATRICULA,
                                    'S',
                                    SYSDATE,
                                    USER,
                                    'TZTFEDCA',
                                    NULL,
                                    ALUMNO.FECHA_INICIO,
                                    ALUMNO.RATE,
                                    ALUMNO.JORNADA,
                                    VL_DESCUENTODSI,
                                    VL_NEWPERIODO
                                    );
                          EXCEPTION
                          WHEN OTHERS THEN
                          VL_ERROR:= 'ERROR AL INSERTAR EN TZTORDR = '||SQLERRM;
                          END;

                       END IF;

                       BEGIN

                            UPDATE TBRACCD A1
                            SET A1.TBRACCD_RECEIPT_NUMBER = VL_SECUEN
                            WHERE A1.TBRACCD_PIDM = ALUMNO.PIDM
                            AND A1.TBRACCD_TERM_CODE = VL_NEWPERIODO
                            AND A1.TBRACCD_PERIOD = ALUMNO.PARTE_PERIODO
                            AND A1.TBRACCD_RECEIPT_NUMBER IS NULL
                            ;

                            UPDATE TVRACCD A1
                            SET A1.TVRACCD_RECEIPT_NUMBER = VL_SECUEN
                            WHERE A1.TVRACCD_PIDM = ALUMNO.PIDM
                            AND A1.TVRACCD_TERM_CODE = VL_NEWPERIODO
                            AND A1.TVRACCD_PERIOD = ALUMNO.PARTE_PERIODO
                            AND A1.TVRACCD_RECEIPT_NUMBER IS NULL
                            ;

                       EXCEPTION
                       WHEN OTHERS THEN
                       VL_ERROR:= 'ERROR AL ACTUALIZAR TBRACCD = '||SQLERRM;
                       END;


                    END IF;

                 ELSIF VL_PARCIALIDADES > ALUMNO.NUM_PAGOS AND VL_PARCIALIDADES > 0 THEN

                    -------------------------------------------      se genera cartera con los parametros      --------------------------------------------
                    -------------------------------------------      eredados de la cartera anterior           --------------------------------------------
                    -------------------------------------------      parametros desde venta, (Rate y Jornada)  --------------------------------------------

                    BEGIN

                      BEGIN

                            SELECT DISTINCT TBBDETC_DETAIL_CODE,TBBDETC_DESC, TBREDET_DETAIL_CODE,TBREDET_PERCENT,TBREDET_MAX_AMOUNT
                            INTO VL_CODIGO_DESC,VL_DESCRIPCION_DESC, VL_CODIGO_AFEC, VL_MONTO_PERCENT, VL_MONTO_AMOUNT
                            FROM TBBEXPT, TBBESTU A, TBBDETC, TBREDET
                            WHERE TBBDETC_DETAIL_CODE = TBBEXPT_DETAIL_CODE
                            AND A.TBBESTU_EXEMPTION_CODE  = TBBEXPT_EXEMPTION_CODE
                            AND A.TBBESTU_TERM_CODE         = TBBEXPT_TERM_CODE
                            AND A.TBBESTU_STUDENT_EXPT_ROLL_IND= 'Y'
                            AND A.TBBESTU_DEL_IND IS NULL
                            AND TBREDET_EXEMPTION_CODE = TBBEXPT_EXEMPTION_CODE
                            AND TBREDET_TERM_CODE = TBBEXPT_TERM_CODE
                            AND A.TBBESTU_TERM_CODE = (SELECT MAX(A1.TBBESTU_TERM_CODE)
                                                      FROM TBBESTU A1
                                                      WHERE A1.TBBESTU_PIDM = A.TBBESTU_PIDM
                                                      AND A1.TBBESTU_STUDENT_EXPT_ROLL_IND = A.TBBESTU_STUDENT_EXPT_ROLL_IND
                                                      AND A1.TBBESTU_DEL_IND IS NULL
                                                      AND A1.TBBESTU_TERM_CODE <= ALUMNO.PERIODO)
                            AND A.TBBESTU_EXEMPTION_PRIORITY = (SELECT MAX(TBBESTU_EXEMPTION_PRIORITY)
                                                                FROM TBBESTU A1
                                                                WHERE A1.TBBESTU_PIDM = A.TBBESTU_PIDM
                                                                AND A1.TBBESTU_STUDENT_EXPT_ROLL_IND = A.TBBESTU_STUDENT_EXPT_ROLL_IND
                                                                AND A1.TBBESTU_DEL_IND IS NULL
                                                                AND A1.TBBESTU_TERM_CODE = A.TBBESTU_TERM_CODE)
                            AND TBBESTU_PIDM = ALUMNO.PIDM
                            AND TBBDETC_DCAT_CODE = 'DSP';

                      EXCEPTION
                      WHEN OTHERS THEN
                        VL_CODIGO_DESC := NULL;
                        VL_DESCRIPCION_DESC := NULL;
                        VL_CODIGO_AFEC := NULL;
                        VL_MONTO_PERCENT := NULL;
                        VL_MONTO_AMOUNT := NULL;

                      END;


                      BEGIN

                            SELECT DISTINCT TZTDMTO_MONTO  ,TZTDMTO_DESC_CODE , TZTDMTO_OBSERVACIONES
                            INTO VL_DESCUENTODSI, VL_CODIGO_DSI,VL_DESCRIPCION_DSI
                            FROM TZTDMTO A
                            WHERE A.TZTDMTO_PIDM   = ALUMNO.PIDM
                            AND A.TZTDMTO_CAMP_CODE = ALUMNO.CAMPUS
                            AND A.TZTDMTO_NIVEL  = ALUMNO.NIVEL
                            AND A.TZTDMTO_PROGRAMA =  ALUMNO.PROGRAMA
                            AND A.TZTDMTO_TERM_CODE  = ALUMNO.PERIODO
                            AND A.TZTDMTO_MONTO = (SELECT MAX (TZTDMTO_MONTO)
                                                   FROM TZTDMTO A1
                                                   WHERE A1.TZTDMTO_PIDM = A.TZTDMTO_PIDM
                                                   AND A1.TZTDMTO_CAMP_CODE = A.TZTDMTO_CAMP_CODE
                                                   AND A1.TZTDMTO_NIVEL = A.TZTDMTO_NIVEL
                                                   AND A1.TZTDMTO_TERM_CODE = A.TZTDMTO_TERM_CODE
                                                   AND A1.TZTDMTO_IND = 1
                                                   AND A1.TZTDMTO_PROGRAMA = A.TZTDMTO_PROGRAMA)
                            AND TZTDMTO_IND = 1 ;

                      EXCEPTION WHEN OTHERS THEN
                      VL_DESCUENTODSI := 0;
                      END;

                      BEGIN

                            SELECT A.TBRACCD_AMOUNT,TBRACCD_DETAIL_CODE,TBRACCD_DESC
                            INTO VL_ULT_COL,VL_CODIGO_PAR,VL_DESCRIPCION_PAR
                            FROM TBRACCD A
                            WHERE A.TBRACCD_PIDM = ALUMNO.PIDM
                            AND A.TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                                          FROM TBBDETC
                                                          WHERE TBBDETC_DCAT_CODE = 'COL'
                                                          AND TBBDETC_DESC != 'COLEGIATURA EXTRAORDINARIO')
                            AND A.TBRACCD_TRAN_NUMBER = (SELECT MAX(TBRACCD_TRAN_NUMBER)
                                                         FROM TBRACCD A1
                                                         WHERE TBRACCD_PIDM = A.TBRACCD_PIDM
                                                         AND TBRACCD_DETAIL_CODE = A.TBRACCD_DETAIL_CODE)
                            ;
                      EXCEPTION
                      WHEN OTHERS THEN
                      VL_ULT_COL:=0;
                      END;

                      BEGIN
                            SELECT TBBDETC_DETAIL_CODE, TBBDETC_DESC
                            INTO VL_CODIGO_PLP, VL_DESCRIPCION_PLP
                            FROM TBBDETC
                            WHERE TBBDETC_DCAT_CODE = 'LPC'
                            AND TBBDETC_DETAIL_CODE = 'PLPA'
                            AND TBBDETC_DETC_ACTIVE_IND = 'Y';
                      EXCEPTION
                      WHEN OTHERS THEN
                      VL_CODIGO_PLP:= NULL;
                      VL_DESCRIPCION_PLP:= NULL;
                      END;

                      IF VL_CODIGO_DESC IS NULL AND VL_DESCUENTODSI = 0 THEN

                        VL_MONTO:= VL_PARCIALIDADES*VL_ULT_COL;

                        VL_PLAN_PAGO:= VL_PARCIALIDADES*VL_ULT_COL;

                      ELSIF VL_CODIGO_DESC IS NOT NULL AND VL_DESCUENTODSI = 0 THEN

                          VL_DESCUENTO := VL_MONTO-(ALUMNO.NUM_PAGOS*VL_ULT_COL);
                          VL_PLAN_PAGO:= ALUMNO.NUM_PAGOS*VL_ULT_COL;

                      ELSIF VL_CODIGO_DESC IS NOT NULL AND VL_DESCUENTODSI > 0 THEN

                        IF VL_MONTO_PERCENT IS NOT NULL THEN

                            VL_DESCUENTO := VL_MONTO*(VL_MONTO_PERCENT/100);

                        ELSIF VL_MONTO_AMOUNT IS NOT NULL THEN

                            VL_DESCUENTO := VL_MONTO_AMOUNT;

                        END IF;

                          VL_DESCUENTODSI := VL_MONTO-(ALUMNO.NUM_PAGOS*VL_ULT_COL)-VL_DESCUENTO;
                          VL_PLAN_PAGO:= ALUMNO.NUM_PAGOS*VL_ULT_COL;

                      ELSIF VL_CODIGO_DESC IS NULL AND VL_DESCUENTODSI > 0 THEN

                        VL_PLAN_PAGO:= ALUMNO.NUM_PAGOS*VL_ULT_COL;
                        VL_DESCUENTODSI := VL_MONTO-(ALUMNO.NUM_PAGOS*VL_ULT_COL);

                      END IF;

                      IF VL_ERROR IS NULL THEN

                        VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);

                        VL_SECUENCIACOL := VL_SECUENCIA;

                        VL_ERROR:= PKG_FINANZAS.F_INSERTA_TBRACCD(
                                                        P_PIDM              => ALUMNO.PIDM
                                                      , P_SECUENCIA         => VL_SECUENCIACOL--vl_secuencia
                                                      , P_NUMBER_PAID       => NULL
                                                      , P_PERIODO           => VL_NEWPERIODO
                                                      , P_PARTE_PERIODO     => ALUMNO.PARTE_PERIODO
                                                      , P_CODIGO            => VL_CODIGO
                                                      , P_MONTO             => VL_MONTO--vl_monto
                                                      , P_BALANCE           => VL_MONTO--vl_monto
                                                      , P_FECHA_VENC        => TRUNC(SYSDATE)--sysdate
                                                      , P_DESCRIP           => VL_DESCRIPCION
                                                      , P_STUDY_PATH        => ALUMNO.STUDY_PATH
                                                      , P_ORIGEN            => 'TZFEDCA (COL)'
                                                      , P_FECHA_INICIO      => ALUMNO.FECHA_INICIO
                                                      ) ;




                      END IF;


                      IF VL_CODIGO_DESC IS NOT NULL THEN

                          VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);

                          VL_ERROR:=PKG_FINANZAS.F_INSERTA_TBRACCD(    P_PIDM                => ALUMNO.PIDM
                                                        , P_SECUENCIA           => VL_SECUENCIA
                                                        , P_NUMBER_PAID         => VL_SECUENCIACOL
                                                        , P_PERIODO             => VL_NEWPERIODO
                                                        , P_PARTE_PERIODO       => ALUMNO.PARTE_PERIODO
                                                        , P_CODIGO              => VL_CODIGO_DESC
                                                        , P_MONTO               => VL_DESCUENTO
                                                        , P_BALANCE             => VL_DESCUENTO*-1
                                                        , P_FECHA_VENC          => TRUNC(SYSDATE)--sysdate
                                                        , P_DESCRIP             => VL_DESCRIPCION_DESC
                                                        , P_STUDY_PATH          => ALUMNO.STUDY_PATH
                                                        , P_ORIGEN              => 'TZFEDCA (DSP)'
                                                        ,P_FECHA_INICIO         => ALUMNO.FECHA_INICIO
                                                        ) ;
                      END IF;


                      IF VL_CODIGO_DSI IS NOT NULL THEN

                        VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);

                        VL_ERROR:=PKG_FINANZAS.F_INSERTA_TBRACCD(
                                                      P_PIDM                => ALUMNO.PIDM
                                                    , P_SECUENCIA           => VL_SECUENCIA
                                                    , P_NUMBER_PAID         => VL_SECUENCIACOL--vl_tran_num
                                                    , P_PERIODO             => VL_NEWPERIODO
                                                    , P_PARTE_PERIODO       => ALUMNO.PARTE_PERIODO
                                                    , P_CODIGO              => VL_CODIGO_DSI
                                                    , P_MONTO               => VL_DESCUENTODSI
                                                    , P_BALANCE             => VL_DESCUENTODSI*-1
                                                    , P_FECHA_VENC          => TRUNC(SYSDATE)
                                                    , P_DESCRIP             => VL_DESCRIPCION_DSI
                                                    , P_STUDY_PATH          => ALUMNO.STUDY_PATH
                                                    , P_ORIGEN              => 'TZFEDCA (DSI)'
                                                    ,P_FECHA_INICIO         => ALUMNO.FECHA_INICIO
                                                     ) ;

                      END IF;


                      IF VL_ERROR IS NULL THEN

                       VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);

                       VL_ERROR:=PKG_FINANZAS.F_INSERTA_TBRACCD(
                                                      P_PIDM                => ALUMNO.PIDM
                                                    , P_SECUENCIA           => VL_SECUENCIA
                                                    , P_NUMBER_PAID         => VL_SECUENCIACOL--vl_tran_num
                                                    , P_PERIODO             => VL_NEWPERIODO
                                                    , P_PARTE_PERIODO       => ALUMNO.PARTE_PERIODO
                                                    , P_CODIGO              => VL_CODIGO_PLP
                                                    , P_MONTO               => VL_PLAN_PAGO--vl_monto2
                                                    , P_BALANCE             => VL_PLAN_PAGO*-1 --vl_monto2*-1
                                                    , P_FECHA_VENC          => TRUNC(SYSDATE)
                                                    , P_DESCRIP             => VL_DESCRIPCION_PLP
                                                    , P_STUDY_PATH          => ALUMNO.STUDY_PATH
                                                    , P_ORIGEN              => 'TZFEDCA (PLPA)'
                                                    ,P_FECHA_INICIO         => ALUMNO.FECHA_INICIO
                                                      ) ;
                      END IF;



                      IF VL_ERROR IS NULL THEN

                            VL_DIA := CASE SUBSTR(VL_SFRRGFE_RATE_CODE,4,1) WHEN 'A' THEN 15 WHEN 'B' THEN 30 WHEN 'C' THEN 10 END;
                            VL_MES := SUBSTR (TO_CHAR(TRUNC(SYSDATE),'dd/mm/rrrr'), 4, 2);
                            VL_ANO := SUBSTR (TO_CHAR(TRUNC(SYSDATE),'dd/mm/rrrr'), 7, 4);

                        BEGIN

                          FOR I IN 1..ALUMNO.NUM_PAGOS

                           LOOP

                             IF VL_DIA = '30' THEN
                               VL_VENCIMIENTO := TO_DATE(CASE LPAD(VL_MES,2,'0') WHEN '02' THEN '28' ELSE VL_DIA END||'/'||LPAD(VL_MES,2,'0')||'/'||VL_ANO,'DD/MM/YYYY');
                             ELSE
                               VL_VENCIMIENTO := TO_DATE(VL_DIA||'/'||LPAD(VL_MES,2,'0')||'/'||VL_ANO,'DD/MM/YYYY');
                             END IF;

                              VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);

                             IF VL_ERROR IS NULL THEN

                                VL_ERROR:= PKG_FINANZAS.F_INSERTA_TBRACCD(
                                                              P_PIDM            => ALUMNO.PIDM
                                                            , P_SECUENCIA       => VL_SECUENCIA
                                                            , P_NUMBER_PAID     => NULL
                                                            , P_PERIODO         => VL_NEWPERIODO
                                                            , P_PARTE_PERIODO   => ALUMNO.PARTE_PERIODO
                                                            , P_CODIGO          => VL_CODIGO_PAR
                                                            , P_MONTO           => VL_ULT_COL--vl_monto2/alumno.num_pagos
                                                            , P_BALANCE         => VL_ULT_COL--vl_monto2/alumno.num_pagos
                                                            , P_FECHA_VENC      => VL_VENCIMIENTO
                                                            , P_DESCRIP         => VL_DESCRIPCION_PAR
                                                            , P_STUDY_PATH      => ALUMNO.STUDY_PATH
                                                            , P_ORIGEN          => 'TZFEDCA (PARC)'
                                                            ,P_FECHA_INICIO     => ALUMNO.FECHA_INICIO
                                                            );

                                 VL_MES := VL_MES +1;

                                 IF VL_MES = '13' THEN
                                    VL_MES := '01';
                                    VL_ANO := VL_ANO +1;
                                 END IF;

                             END IF;

                           END LOOP;

                        END;

                      END IF;

                    END;

                    DBMS_OUTPUT.PUT_LINE('INSERTA DOCTR 2 = '||VL_ERROR);

                    IF VL_ERROR IS NULL THEN


                       BEGIN

                           SELECT MAX(TZTORDR_CONTADOR)+1
                           INTO VL_SECUEN
                           FROM TZTORDR
                              ;

                       EXCEPTION
                       WHEN OTHERS THEN
                       VL_SECUEN:= NULL;
                       END;

                       IF VL_SECUEN IS NOT NULL THEN

                          BEGIN

                            INSERT INTO TZTORDR
                            (
                              TZTORDR_CAMPUS,
                              TZTORDR_NIVEL,
                              TZTORDR_CONTADOR,
                              TZTORDR_PROGRAMA,
                              TZTORDR_PIDM,
                              TZTORDR_ID,
                              TZTORDR_ESTATUS,
                              TZTORDR_ACTIVITY_DATE,
                              TZTORDR_USER,
                              TZTORDR_DATA_ORIGIN,
                              TZTORDR_NO_REGLA,
                              TZTORDR_FECHA_INICIO,
                              TZTORDR_RATE,
                              TZTORDR_JORNADA,
                              TZTORDR_DSI,
                              TZTORDR_TERM_CODE
                            )
                            VALUES( ALUMNO.CAMPUS,
                                    ALUMNO.NIVEL,
                                    VL_SECUEN,
                                    ALUMNO.PROGRAMA,
                                    ALUMNO.PIDM,
                                    ALUMNO.MATRICULA,
                                    'S',
                                    SYSDATE,
                                    USER,
                                    'TZTFEDCA',
                                    NULL,
                                    ALUMNO.FECHA_INICIO,
                                    ALUMNO.RATE,
                                    ALUMNO.JORNADA,
                                    VL_DESCUENTODSI,
                                    VL_NEWPERIODO
                                    );
                          EXCEPTION
                          WHEN OTHERS THEN
                          VL_ERROR:= 'ERROR AL INSERTAR EN TZTORDR = '||SQLERRM;
                          END;

                       END IF;

                       BEGIN

                                UPDATE TBRACCD A1
                                SET A1.TBRACCD_RECEIPT_NUMBER = VL_SECUEN
                                WHERE A1.TBRACCD_PIDM = ALUMNO.PIDM
                                AND A1.TBRACCD_TERM_CODE = VL_NEWPERIODO
                                AND A1.TBRACCD_PERIOD = ALUMNO.PARTE_PERIODO
                                AND A1.TBRACCD_RECEIPT_NUMBER IS NULL
                                ;

                                UPDATE TVRACCD A1
                                SET A1.TVRACCD_RECEIPT_NUMBER = VL_SECUEN
                                WHERE A1.TVRACCD_PIDM = ALUMNO.PIDM
                                AND A1.TVRACCD_TERM_CODE = VL_NEWPERIODO
                                AND A1.TVRACCD_PERIOD = ALUMNO.PARTE_PERIODO
                                AND A1.TVRACCD_RECEIPT_NUMBER IS NULL
                                ;

                       EXCEPTION
                       WHEN OTHERS THEN
                       VL_ERROR:= 'ERROR AL ACTUALIZAR TBRACCD = '||SQLERRM;
                       END;


                    END IF;

                 ELSE

                    BEGIN

                        SELECT COUNT(*)
                        INTO VL_DOCTR
                        FROM TZDOCTR
                        WHERE TZDOCTR_PIDM = ALUMNO.PIDM
                        AND LAST_DAY(TZDOCTR_START_DATE) = LAST_DAY(TRUNC(SYSDATE))--ALUMNO.FECHA_INICIO PARA VALIDAR SI YA SE INTENTO EJECUTAR LA CARTERA
                        ;

                    EXCEPTION
                    WHEN OTHERS THEN
                    VL_DOCTR:=0;
                    END;

                    IF VL_DOCTR = 0 THEN

                        BEGIN

                            INSERT INTO TZDOCTR (TZDOCTR_PIDM,
                                                 TZDOCTR_PROGRAM,
                                                 TZDOCTR_STST_CODE,
                                                 TZDOCTR_STYP_CODE,
                                                 TZDOCTR_CAMP_CODE,
                                                 TZDOCTR_LEVL_CODE,
                                                 TZDOCTR_TERM_CODE,
                                                 TZDOCTR_START_DATE,
                                                 TZDOCTR_PTRM_CODE,
                                                 TZDOCTR_STUDY_PATH,
                                                 TZDOCTR_NUM_PAGOS,
                                                 TZDOCTR_RATE_CODE,
                                                 TZDOCTR_COLEG,
                                                 TZDOCTR_DESC,
                                                 TZDOCTR_PPAGO,
                                                 TZDOCTR_PARCI,
                                                 FECHA_PROCESO,
                                                 TZDOCTR_IND,
                                                 TZDOCTR_OBSERVACIONES,
                                                 TZDOCTR_VENCIMIENTO,
                                                 TZDOCTR_ID,
                                                 TZDOCTR_TIPO_PROC,
                                                 TZDOCTR_DESCUENTO)
                            VALUES ( ALUMNO.PIDM,
                                    ALUMNO.PROGRAMA,
                                    ALUMNO.ESTATUS,
                                    ALUMNO.TIPO_ALUMNO,
                                    ALUMNO.CAMPUS,
                                    ALUMNO.NIVEL,
                                    ALUMNO.PERIODO,
                                    LAST_DAY(TRUNC(SYSDATE)),--vd_Fecha_inicio,
                                    ALUMNO.PARTE_PERIODO,
                                    ALUMNO.STUDY_PATH,
                                    ALUMNO.NUM_PAGOS,
                                    ALUMNO.RATE,
                                    NULL,
                                    NULL,
                                    NULL,
                                    NULL,
                                    SYSDATE,
                                    1,
                                    'CARTERA FINAL PROCESADA',
                                    ALUMNO.VENCIMIENTO,
                                    ALUMNO.MATRICULA,
                                    'EDCA',
                                    1);
                        EXCEPTION
                        WHEN OTHERS THEN
                        VL_ERROR:= 'Error al insertar en TZDOCTR'||SQLERRM;
                        END;

                    END IF;

                 END IF;

              END IF;

            ELSE

                 ------------------------  si cuenta con parcialidad en el mes,              ----------------------------------
                 ------------------------  solo se incerta el registro de cartera existente  ----------------------------------

                BEGIN

                    SELECT COUNT(*)
                    INTO VL_DOCTR
                    FROM TZDOCTR
                    WHERE TZDOCTR_PIDM = ALUMNO.PIDM
                    AND LAST_DAY(TZDOCTR_START_DATE) = LAST_DAY(TRUNC(SYSDATE))--ALUMNO.FECHA_INICIO PARA VALIDAR SI YA SE INTENTO EJECUTAR LA CARTERA
                    ;

                EXCEPTION
                WHEN OTHERS THEN
                VL_DOCTR:=0;
                END;

                IF VL_DOCTR = 0 THEN

                    BEGIN

                        INSERT INTO TZDOCTR (TZDOCTR_PIDM,
                                             TZDOCTR_PROGRAM,
                                             TZDOCTR_STST_CODE,
                                             TZDOCTR_STYP_CODE,
                                             TZDOCTR_CAMP_CODE,
                                             TZDOCTR_LEVL_CODE,
                                             TZDOCTR_TERM_CODE,
                                             TZDOCTR_START_DATE,
                                             TZDOCTR_PTRM_CODE,
                                             TZDOCTR_STUDY_PATH,
                                             TZDOCTR_NUM_PAGOS,
                                             TZDOCTR_RATE_CODE,
                                             TZDOCTR_COLEG,
                                             TZDOCTR_DESC,
                                             TZDOCTR_PPAGO,
                                             TZDOCTR_PARCI,
                                             FECHA_PROCESO,
                                             TZDOCTR_IND,
                                             TZDOCTR_OBSERVACIONES,
                                             TZDOCTR_VENCIMIENTO,
                                             TZDOCTR_ID,
                                             TZDOCTR_TIPO_PROC,
                                             TZDOCTR_DESCUENTO)
                        VALUES ( ALUMNO.PIDM,
                                ALUMNO.PROGRAMA,
                                ALUMNO.ESTATUS,
                                ALUMNO.TIPO_ALUMNO,
                                ALUMNO.CAMPUS,
                                ALUMNO.NIVEL,
                                ALUMNO.PERIODO,
                                LAST_DAY(TRUNC(SYSDATE)),--vd_Fecha_inicio,
                                ALUMNO.PARTE_PERIODO,
                                ALUMNO.STUDY_PATH,
                                ALUMNO.NUM_PAGOS,
                                ALUMNO.RATE,
                                NULL,
                                NULL,
                                NULL,
                                NULL,
                                SYSDATE,
                                1,
                                'Ya Existe la Cartera ',
                                ALUMNO.VENCIMIENTO,
                                ALUMNO.MATRICULA,
                                'EDCA',
                                1);
                    EXCEPTION
                    WHEN OTHERS THEN
                    VL_ERROR:= 'Error al insertar en TZDOCTR'||SQLERRM;
                    END;

                END IF;

            END IF;

          END IF;

          DBMS_OUTPUT.PUT_LINE (VL_ERROR);

          IF VL_ERROR IS NULL THEN

            BEGIN

                SELECT COUNT(*)
                INTO VL_DOCTR
                FROM TZDOCTR
                WHERE TZDOCTR_PIDM = ALUMNO.PIDM
                AND LAST_DAY(TZDOCTR_START_DATE) = LAST_DAY(TRUNC(SYSDATE))--ALUMNO.FECHA_INICIO PARA VALIDAR SI YA SE INTENTO EJECUTAR LA CARTERA
                ;

            EXCEPTION
            WHEN OTHERS THEN
            VL_DOCTR:=0;
            END;

            IF VL_DOCTR = 0 THEN

                BEGIN

                    INSERT INTO
                    TZDOCTR (TZDOCTR_PIDM,
                             TZDOCTR_PROGRAM,
                             TZDOCTR_STST_CODE,
                             TZDOCTR_STYP_CODE,
                             TZDOCTR_CAMP_CODE,
                             TZDOCTR_LEVL_CODE,
                             TZDOCTR_TERM_CODE,
                             TZDOCTR_START_DATE,
                             TZDOCTR_PTRM_CODE,
                             TZDOCTR_STUDY_PATH,
                             TZDOCTR_NUM_PAGOS,
                             TZDOCTR_RATE_CODE,
                             TZDOCTR_COLEG,
                             TZDOCTR_DESC,
                             TZDOCTR_PPAGO,
                             TZDOCTR_PARCI,
                             FECHA_PROCESO,
                             TZDOCTR_IND,
                             TZDOCTR_OBSERVACIONES,
                             TZDOCTR_VENCIMIENTO,
                             TZDOCTR_ID,
                             TZDOCTR_TIPO_PROC,
                             TZDOCTR_DESCUENTO)
                    VALUES ( ALUMNO.PIDM,
                            ALUMNO.PROGRAMA,
                            ALUMNO.ESTATUS,
                            ALUMNO.TIPO_ALUMNO,
                            ALUMNO.CAMPUS,
                            ALUMNO.NIVEL,
                            ALUMNO.PERIODO,
                            LAST_DAY(TRUNC(SYSDATE)),--vd_Fecha_inicio,
                            ALUMNO.PARTE_PERIODO,
                            ALUMNO.STUDY_PATH,
                            ALUMNO.NUM_PAGOS,
                            ALUMNO.RATE,
                            NULL,
                            NULL,
                            NULL,
                            NULL,
                            SYSDATE,
                            1,
                            'Cartera creada con exito para el periodo '||VL_NEWPERIODO,
                            ALUMNO.VENCIMIENTO,
                            ALUMNO.MATRICULA,
                            'EDCA',
                            1);
                EXCEPTION
                WHEN OTHERS THEN
                VL_ERROR:= 'Error al insertar en TZDOCTR'||SQLERRM;
                END;

            END IF;

            COMMIT;

          ELSE

            ROLLBACK;

          END IF;

        END LOOP;

    END P_CARTERA_API;

FUNCTION F_PERIODO_NEW(P_PERIODO VARCHAR2)RETURN VARCHAR2 IS

VL_NEWPERIODO VARCHAR2(11);

 BEGIN

    IF SUBSTR(P_PERIODO,5,1) = 4 THEN

        IF SUBSTR(P_PERIODO,6,1) = 1 THEN

         VL_NEWPERIODO:= SUBSTR(P_PERIODO,1,5)||(SUBSTR(P_PERIODO,6,1)+1);

        ELSIF SUBSTR(P_PERIODO,6,1) = 2 THEN

         VL_NEWPERIODO:= SUBSTR(P_PERIODO,1,5)||(SUBSTR(P_PERIODO,6,1)+1);

        ELSIF SUBSTR(P_PERIODO,6,1) = 3 THEN

         VL_NEWPERIODO:= SUBSTR(P_PERIODO,1,2)||(SUBSTR(P_PERIODO,3,2)+1||SUBSTR(P_PERIODO,5,1)||1);

        END IF;

     RETURN(VL_NEWPERIODO);

    END IF;

 END F_PERIODO_NEW;

FUNCTION F_PERIODO_OLD(P_PERIODO VARCHAR2)RETURN VARCHAR2 IS

VL_NEWPERIODO VARCHAR2(11);

 BEGIN

    IF SUBSTR(P_PERIODO,5,1) = 4 THEN

        IF SUBSTR(P_PERIODO,6,1) = 1 THEN

         VL_NEWPERIODO:= SUBSTR(P_PERIODO,1,2)||(SUBSTR(P_PERIODO,3,2)-1||SUBSTR(P_PERIODO,5,1)||3);

        ELSIF SUBSTR(P_PERIODO,6,1) = 2 THEN

         VL_NEWPERIODO:= SUBSTR(P_PERIODO,1,5)||(SUBSTR(P_PERIODO,6,1)-1);

        ELSIF SUBSTR(P_PERIODO,6,1) = 3 THEN

         VL_NEWPERIODO:= SUBSTR(P_PERIODO,1,5)||(SUBSTR(P_PERIODO,6,1)-1);

        END IF;

     RETURN(VL_NEWPERIODO);

    END IF;

 END F_PERIODO_OLD;

FUNCTION F_NOTAS_CRD_DEB (P_PIDM IN NUMBER) RETURN PKG_FINANZAS.CUR_NOTAS_OUT
AS
NOTAS_CREDITO_DEBITO PKG_FINANZAS.CUR_NOTAS_OUT;

    BEGIN

       OPEN NOTAS_CREDITO_DEBITO
       FOR

        SELECT  TBRACCD_TRAN_NUMBER NUMERO,
                (SELECT DISTINCT TZTNCD_CONCEPTO
                 FROM TZTNCD
                 WHERE TZTNCD_CODE = A.TBRACCD_DETAIL_CODE)CONCEPTO,
                TBRACCD_DESC DESCRIPCION,
                TBRACCD_AMOUNT MONTO,
                TBRACCD_EFFECTIVE_DATE FECHA_LIMITE,
                TBRACCD_BALANCE BALANCE
        FROM TBRACCD A,TBBDETC
        WHERE A.TBRACCD_PIDM = P_PIDM --FGET_PIDM('010040470')
        AND A.TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
        AND TBBDETC_DCAT_CODE NOT IN ( 'TUI','COL','LPC','DSP','CSH')
        AND TBBDETC_DESC NOT LIKE 'DSI COL%'
        AND TBRACCD_AMOUNT!= 0
        ORDER BY 1 DESC;

        RETURN (NOTAS_CREDITO_DEBITO);

    END F_NOTAS_CRD_DEB;

FUNCTION F_ACTUALIZA_TZTORDR (P_PIDM NUMBER, P_TRAN NUMBER, P_CAMPUS VARCHAR2, P_NIVEL VARCHAR2) RETURN VARCHAR2 IS

 BEGIN


   BEGIN

    UPDATE TZTORDR
    SET TZTORDR_CAMPUS = P_CAMPUS,
        TZTORDR_NIVEL = P_NIVEL
    WHERE TZTORDR_CONTADOR = (SELECT TBRACCD_RECEIPT_NUMBER
                              FROM TBRACCD
                              WHERE TBRACCD_PIDM = P_PIDM
                              AND TBRACCD_TRAN_NUMBER = P_TRAN);
   END;

   IF SQL%ROWCOUNT = 0 THEN

    RETURN('NO ACTUALIZA');

   ELSE

    RETURN('EXITO');

   END IF;

   COMMIT;

 END F_ACTUALIZA_TZTORDR;


FUNCTION F_INSER_TZTINCR (P_PIDM NUMBER, P_PERIODO VARCHAR2, P_FECHA DATE, P_PROGRAMA VARCHAR2)RETURN VARCHAR2 IS

VL_STUDY NUMBER;
VL_ENTRA NUMBER;
VL_ERROR VARCHAR2(500);

BEGIN

    BEGIN

        SELECT DISTINCT SORLCUR_KEY_SEQNO + 1
        INTO VL_STUDY
        FROM SORLCUR A
        WHERE A.SORLCUR_PIDM = P_PIDM
        AND A.SORLCUR_LMOD_CODE = 'LEARNER'
        AND A.SORLCUR_SEQNO IN (SELECT MAX (A1.SORLCUR_SEQNO)
                               FROM SORLCUR A1
                               WHERE A1.SORLCUR_PIDM = A.SORLCUR_PIDM
                               AND A1.SORLCUR_LMOD_CODE = A.SORLCUR_LMOD_CODE);
    EXCEPTION
    WHEN OTHERS THEN
    VL_STUDY:= 2;
    END;

    BEGIN

        SELECT COUNT(*)
        INTO VL_ENTRA
        FROM TZTINCR
        WHERE TZTINCR_PIDM = P_PIDM
        AND TZTINCR_TERM_CODE = P_PERIODO
        AND TZTINCR_START_DATE = TO_CHAR(P_FECHA,'YYYY/MM/DD')
        AND TZTINCR_PROGRAM = P_PROGRAMA
        ;

    EXCEPTION
    WHEN OTHERS THEN
    NULL;
    END;

    IF VL_ENTRA = 0 THEN

        VL_ERROR:= 'EXITO';

        BEGIN

            INSERT INTO TZTINCR
                   (
                    TZTINCR_PIDM,
                    TZTINCR_TERM_CODE,
                    TZTINCR_START_DATE,
                    TZTINCR_ACTIVITY,
                    TZTINCR_USER,
                    TZTINCR_PROGRAM,
                    TZTINCR_STUDY
                    )
            VALUES(P_PIDM,
                   P_PERIODO,
                   TO_CHAR(P_FECHA,'YYYY/MM/DD'),
                   SYSDATE,
                   USER,
                   P_PROGRAMA,
                   VL_STUDY
                   );
        EXCEPTION
        WHEN OTHERS THEN
        VL_ERROR:= 'ERROR AL INSERTAR EN TZTINCR = '||P_FECHA||' = AAA = '||SQLERRM;
        END;

    ELSE

    VL_ERROR:= 'YA EXISTE REGISTRO EN TZTINCR';

    END IF;

    RETURN(VL_ERROR);

 COMMIT;

END F_INSER_TZTINCR;

FUNCTION F_TBRAPPL (P_PIDM IN NUMBER,P_TRAN IN NUMBER) RETURN PKG_FINANZAS.CUR_TBRAPPL
AS
APLICA_PAGOS PKG_FINANZAS.CUR_TBRAPPL;

 BEGIN

   OPEN APLICA_PAGOS FOR

                        SELECT CODIGO,
                             ROUND((CASE WHEN PORC_IVA = 0 THEN TBRAPPL_AMOUNT
                                    WHEN PORC_IVA != 0 THEN ROUND(TBRAPPL_AMOUNT/((PORC_IVA+100)/100),2)
                             END),2) AS MONTO,
                             ROUND((CASE WHEN PORC_IVA = 0 THEN 0
                                    WHEN PORC_IVA != 0 THEN TBRAPPL_AMOUNT - ROUND(TBRAPPL_AMOUNT/((PORC_IVA+100)/100),2)
                             END),2) AS MONTO_IVA
                        FROM(
                        SELECT (SELECT TBRACCD_DETAIL_CODE FROM TBRACCD WHERE TBRACCD_PIDM = A.TBRAPPL_PIDM AND TBRACCD_TRAN_NUMBER = A.TBRAPPL_CHG_TRAN_NUMBER )CODIGO,
                               TBRAPPL_AMOUNT,
                               (SELECT DISTINCT TVRTPDC_PERCENT
                                FROM TVRTPDC
                                WHERE TVRTPDC_DETC_CODE = (SELECT TVRACCD_DETAIL_CODE
                                                           FROM TVRACCD
                                                           WHERE TVRACCD_PIDM = A.TBRAPPL_PIDM
                                                           AND TVRACCD_DETAIL_CODE IN ('IVAE','IVAG')
                                                           AND TVRACCD_ACCD_TRAN_NUMBER = A.TBRAPPL_CHG_TRAN_NUMBER))PORC_IVA
                        FROM TBRAPPL A
                        WHERE 1=1
                        AND A.TBRAPPL_REAPPL_IND IS NULL
                        AND A.TBRAPPL_PIDM = P_PIDM
                        AND A.TBRAPPL_PAY_TRAN_NUMBER = P_TRAN)
                        WHERE 1=1;

        RETURN (APLICA_PAGOS);

 END F_TBRAPPL;

FUNCTION F_DES_PAG_UNI (P_PIDM IN NUMBER, P_FECHA IN DATE) RETURN VARCHAR2 IS


/* Funcion para aplicar descuento de pago unico recurrente
  Autor         JREZAOLI
 Creado         13/09/2019
 Actualizado    11/03/2021
*/



VL_RESP             VARCHAR2(500);
VL_EXI_TBRA         NUMBER;
VL_ERROR            VARCHAR2(500):='EXITO';
VL_DESCUENTO        NUMBER;
VL_CADENA_ERROR     VARCHAR2(500);
VL_AJUSTES          NUMBER;
VL_DESC             VARCHAR2(35);
VL_FECHA_NEW        DATE;
VL_DIA              NUMBER;
VL_FECHA_FINAL      DATE;
VL_PAGO             NUMBER;
VL_FECHA_EFF        DATE;
VL_DESCUENTOS       NUMBER;
VL_FINAL            NUMBER;
VL_APLI_DESCU       NUMBER;
VL_FECHA_APLICA     DATE;
VL_NUM_APLICA       NUMBER;
VL_SECUENCIA        NUMBER;
VL_ENTRA            NUMBER;

vl_fecha_ini   date;
vl_fecha_fin date;

 BEGIN

          DBMS_OUTPUT.PUT_LINE('Entrada Registro  = '||P_FECHA);
   BEGIN
   SELECT COUNT(*)
       INTO VL_ENTRA
       FROM TZTPUNI
      WHERE         TZTPUNI_PIDM = P_PIDM
            AND  TZTPUNI_FECHA_INICIO = P_FECHA  AND (TZTPUNI_CHECK IS NULL OR TZTPUNI_CHECK = 0)
                 OR
                    (LAST_DAY(TZTPUNI_PROX_FECHA) = LAST_DAY(P_FECHA )--+11
                    AND TZTPUNI_CHECK = 1)
                ANd TZTPUNI_PIDM = P_PIDM
                AND     TZTPUNI_CHECH_FINAL IS NULL;
   Exception
    When Others then
        VL_ENTRA:=0;
   END;

    /*
    Begin
  --  DBMS_OUTPUT.PUT_LINE('Bloque 0 = '||sqlerrm);
       SELECT COUNT(*), TZTPUNI_FECHA_INICIO, TZTPUNI_PROX_FECHA
       Into VL_ENTRA, vl_fecha_ini, vl_fecha_fin
       FROM TZTPUNI
      WHERE   1= 1
      And       TZTPUNI_PIDM = P_PIDM
      AND     TZTPUNI_CHECH_FINAL IS NULL
       AND  trim (TZTPUNI_CHECK) is null
       AND  trunc (TZTPUNI_FECHA_INICIO)  = P_FECHA
       group by TZTPUNI_PROX_FECHA, TZTPUNI_FECHA_INICIO;
    Exception
    When Others then
            VL_ENTRA:=0;
            vl_fecha_ini:= null;
            vl_fecha_fin:= null;
    -- DBMS_OUTPUT.PUT_LINE('no_Others_bloque0 = '||sqlerrm);
    End;

    If VL_ENTRA = 0 then

        Begin
               SELECT COUNT(*), TZTPUNI_FECHA_INICIO, TZTPUNI_PROX_FECHA
               Into VL_ENTRA, vl_fecha_ini, vl_fecha_fin
               FROM TZTPUNI
              WHERE   1= 1
              And       TZTPUNI_PIDM = P_PIDM
              AND     TZTPUNI_CHECH_FINAL IS NULL
               AND  trim (TZTPUNI_CHECK) = 0
               AND  trunc (TZTPUNI_FECHA_INICIO)  = P_FECHA
             group by TZTPUNI_PROX_FECHA, TZTPUNI_FECHA_INICIO;
        Exception
        When Others then
                VL_ENTRA:=0;
                vl_fecha_ini:= null;
                vl_fecha_fin:= null;
        -- DBMS_OUTPUT.PUT_LINE('no_Others_bloque1 = '||sqlerrm);
        End;

    End if;

    If VL_ENTRA = 0 then

                Begin
                       SELECT COUNT(*), TZTPUNI_FECHA_INICIO, TZTPUNI_PROX_FECHA
                       Into VL_ENTRA, vl_fecha_ini, vl_fecha_fin
                       FROM TZTPUNI
                      WHERE   1= 1
                      And       TZTPUNI_PIDM = P_PIDM
                      AND     TZTPUNI_CHECH_FINAL IS NULL
                       AND  trim (TZTPUNI_CHECK) = 1
                       And LAST_DAY(TZTPUNI_PROX_FECHA) = last_day((LAST_DAY(P_FECHA)+11))
                      group by TZTPUNI_PROX_FECHA, TZTPUNI_FECHA_INICIO;
                Exception
                When Others then
                        VL_ENTRA:=0;
                        vl_fecha_ini:= null;
                        vl_fecha_fin:= null;
                      --   DBMS_OUTPUT.PUT_LINE('no_Others_bloque2 = '||sqlerrm);
                End;

    End if;


      DBMS_OUTPUT.PUT_LINE('Salida  = '||VL_ENTRA);

  */


   IF VL_ENTRA != 0 THEN

       BEGIN
         SELECT COUNT(*)
           INTO VL_EXI_TBRA
           FROM TBRACCD A,TBBDETC
          WHERE TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
                AND TBRACCD_PIDM = P_PIDM
                AND TBRACCD_FEED_DATE = P_FECHA
                AND TBBDETC_DCAT_CODE = 'COL'
                AND TBRACCD_DOCUMENT_NUMBER IS NULL
                AND LAST_DAY(TRUNC(A.TBRACCD_EFFECTIVE_DATE)) >= LAST_DAY(TRUNC(SYSDATE-90));
       EXCEPTION
       WHEN OTHERS THEN
       VL_EXI_TBRA:=0;
       END;

       IF VL_EXI_TBRA > 0 THEN

         BEGIN
           FOR DESCUENTO IN (
                               SELECT TZTPUNI_PIDM,
                                      TZTPUNI_ID,
                                      TZTPUNI_TERM_CODE,
                                      TZTPUNI_FECHA_INICIO,
                                      TO_NUMBER(TO_CHAR(TZTPUNI_FECHA_INICIO,'DD'))DIA,
                                      TO_NUMBER(NVL(TO_CHAR(TZTPUNI_PROX_FECHA,'DD'),'01'))DIAP,
                                      TZTPUNI_PROX_FECHA,
                                      TZTPUNI_MONTO,
                                      TZTPUNI_PORCENTAJE,
                                      TZTPUNI_CODIGO,
                                      TZTPUNI_REPLICA,
                                      TZTPUNI_VECES,
                                      TZTPUNI_APLI,
                                      TZTPUNI_CHECK,
                                      TZTPUNI_FINALIZADO,
                                      TZTPUNI_DATA_ORIGIN
                                 FROM TZTPUNI
                          WHERE         TZTPUNI_PIDM = P_PIDM
                                AND  TZTPUNI_FECHA_INICIO = P_FECHA  AND (TZTPUNI_CHECK IS NULL OR TZTPUNI_CHECK = 0)
                                     OR
                                        (LAST_DAY(TZTPUNI_PROX_FECHA) = LAST_DAY(P_FECHA )--+11
                                        AND TZTPUNI_CHECK = 1)
                                    AND     TZTPUNI_CHECH_FINAL IS NULL
                                    And TZTPUNI_PIDM = P_PIDM
                                 /*
                                WHERE         TZTPUNI_PIDM = P_PIDM
                                And trunc (TZTPUNI_FECHA_INICIO) = vl_fecha_ini
                                And trunc (TZTPUNI_PROX_FECHA) = vl_fecha_fin -- '01/11/2022'
                                AND     TZTPUNI_CHECH_FINAL IS NULL*/


           )LOOP

             IF (DESCUENTO.TZTPUNI_DATA_ORIGIN IS NULL OR DESCUENTO.TZTPUNI_DATA_ORIGIN != 'UNICO_SIU')THEN
                 VL_NUM_APLICA:= (DESCUENTO.TZTPUNI_REPLICA*DESCUENTO.TZTPUNI_VECES);
             ELSE
                 VL_NUM_APLICA:= DESCUENTO.TZTPUNI_VECES;
             END IF;

             IF (DESCUENTO.TZTPUNI_CHECK IS NULL OR DESCUENTO.TZTPUNI_CHECK = 0) THEN

                 BEGIN
                   SELECT COUNT(*)
                     INTO VL_PAGO
                     FROM TBRACCD A,TBBDETC
                    WHERE     TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
                          AND TBBDETC_DCAT_CODE = 'CSH'
                          AND TBRACCD_PIDM = P_PIDM
                          AND TBRACCD_AMOUNT >= DESCUENTO.TZTPUNI_MONTO;
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_PAGO:=0;
                 END;

             ELSE

               VL_PAGO:=1;

             END IF;

             BEGIN
               SELECT COUNT(*)
                 INTO VL_DESCUENTOS
                 FROM TBRACCD
                WHERE     TBRACCD_PIDM = P_PIDM
                      AND TBRACCD_DOCUMENT_NUMBER = 'PAGOUNIC'
                      AND TBRACCD_EFFECTIVE_DATE >= DESCUENTO.TZTPUNI_FECHA_INICIO;
             EXCEPTION
             WHEN OTHERS THEN
             VL_DESCUENTOS:=0;
             END;

             VL_APLI_DESCU:= VL_NUM_APLICA-VL_DESCUENTOS;

             IF (DESCUENTO.TZTPUNI_CHECK = 0 OR DESCUENTO.TZTPUNI_CHECK IS NULL ) THEN

               IF DESCUENTO.TZTPUNI_FINALIZADO = 1 THEN
                   VL_FECHA_APLICA := DESCUENTO.TZTPUNI_FECHA_INICIO;
               ELSE
                   VL_FECHA_APLICA := TRUNC(SYSDATE);
               END IF;

             ELSE
                 VL_FECHA_APLICA := TRUNC(SYSDATE);
             END IF;

             IF VL_PAGO > 0 THEN

               BEGIN
                 FOR ALUMNO IN (
                                 SELECT A.*,ROW_NUMBER()OVER (PARTITION BY A.TBRACCD_PIDM ORDER BY A.TBRACCD_EFFECTIVE_DATE)SECU
                                   FROM TBRACCD A,TBBDETC
                                  WHERE     A.TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
                                        AND A.TBRACCD_PIDM = P_PIDM
                                        AND A.TBRACCD_FEED_DATE = P_FECHA
                                        AND TBBDETC_DCAT_CODE = 'COL'
                                        AND TBBDETC_DESC LIKE 'COLEGIATURA%'
                                        AND TBBDETC_DESC != 'COLEGIATURA EXTRAORDINARIO'
                                        AND A.TBRACCD_DOCUMENT_NUMBER IS NULL
                                        AND LAST_DAY(TRUNC(A.TBRACCD_EFFECTIVE_DATE)) >= LAST_DAY(TRUNC(VL_FECHA_APLICA))

                 )LOOP

                   IF DESCUENTO.TZTPUNI_DATA_ORIGIN = 'UNICO_SIU' THEN

                    VL_DESCUENTO:=ROUND(ALUMNO.TBRACCD_BALANCE*(DESCUENTO.TZTPUNI_PORCENTAJE/100),2);

                   ELSE

                    VL_DESCUENTO:=ROUND(ALUMNO.TBRACCD_AMOUNT*(DESCUENTO.TZTPUNI_PORCENTAJE/100),2);

                   END IF;

                   IF (DESCUENTO.TZTPUNI_DATA_ORIGIN IS NULL OR DESCUENTO.TZTPUNI_DATA_ORIGIN != 'UNICO_SIU')THEN
                       VL_DESCUENTO:=VL_DESCUENTO;
                   ELSE
                       VL_DESCUENTO:=FLOOR(VL_DESCUENTO);
                   END IF;

                   BEGIN
                     SELECT SUM(TBRACCD_AMOUNT)
                       INTO VL_AJUSTES
                       FROM TBRACCD
                      WHERE TBRACCD_PIDM = ALUMNO.TBRACCD_PIDM
                            AND TBRACCD_TRAN_NUMBER_PAID = ALUMNO.TBRACCD_TRAN_NUMBER;
                   EXCEPTION
                   WHEN OTHERS THEN
                   VL_AJUSTES:=0;
                   END;

                   IF (VL_AJUSTES+VL_DESCUENTO)> ALUMNO.TBRACCD_AMOUNT THEN

                     VL_ERROR:='LA TRANSACCION '||ALUMNO.TBRACCD_TRAN_NUMBER||', PRESENTA AJUSTES POR '||VL_AJUSTES||' desvincular pagos para aplicar descuento';

                   ELSE

                     BEGIN
                       SELECT TBBDETC_DESC
                         INTO VL_DESC
                         FROM TBBDETC
                        WHERE TBBDETC_DETAIL_CODE = DESCUENTO.TZTPUNI_CODIGO;
                     EXCEPTION
                     WHEN OTHERS THEN
                     VL_DESC:=NULL;
                     END;

                     IF (DESCUENTO.TZTPUNI_DATA_ORIGIN != 'UNICO_SIU' OR DESCUENTO.TZTPUNI_DATA_ORIGIN IS NULL) THEN

                      PKG_FINANZAS.P_DESAPLICA_PAGOS ( ALUMNO.TBRACCD_PIDM, ALUMNO.TBRACCD_TRAN_NUMBER);

                     END IF;

                     IF LAST_DAY(ALUMNO.TBRACCD_EFFECTIVE_DATE) <= LAST_DAY(TRUNC(SYSDATE)) THEN
                          VL_FECHA_EFF:= TRUNC(SYSDATE);
                     ELSE
                          VL_FECHA_EFF:= ALUMNO.TBRACCD_EFFECTIVE_DATE;
                     END IF;

                     BEGIN
                       BEGIN
                         SELECT MAX(TBRACCD_TRAN_NUMBER)+1
                         INTO VL_SECUENCIA
                         FROM TBRACCD
                         WHERE TBRACCD_PIDM = ALUMNO.TBRACCD_PIDM;
                       END;

                        DBMS_OUTPUT.PUT_LINE('Inserta Descuento  = '||ALUMNO.TBRACCD_PIDM);

                         BEGIN
                           INSERT
                             INTO TBRACCD
                                  (TBRACCD_PIDM,
                                   TBRACCD_TRAN_NUMBER,
                                   TBRACCD_TERM_CODE,
                                   TBRACCD_DETAIL_CODE,
                                   TBRACCD_USER,
                                   TBRACCD_ENTRY_DATE,
                                   TBRACCD_AMOUNT,
                                   TBRACCD_BALANCE,
                                   TBRACCD_EFFECTIVE_DATE,
                                   TBRACCD_DESC,
                                   TBRACCD_ACTIVITY_DATE,
                                   TBRACCD_TRANS_DATE,
                                   TBRACCD_DATA_ORIGIN,
                                   TBRACCD_CREATE_SOURCE,
                                   TBRACCD_SRCE_CODE ,
                                   TBRACCD_ACCT_FEED_IND,
                                   TBRACCD_SESSION_NUMBER,
                                   TBRACCD_CURR_CODE,
                                   TBRACCD_TRAN_NUMBER_PAID,
                                   TBRACCD_STSP_KEY_SEQUENCE,
                                   TBRACCD_PERIOD,
                                   TBRACCD_FEED_DATE)
                            VALUES (ALUMNO.TBRACCD_PIDM,
                                    VL_SECUENCIA,
                                    ALUMNO.TBRACCD_TERM_CODE,
                                    DESCUENTO.TZTPUNI_CODIGO,
                                    USER,
                                    SYSDATE,
                                    VL_DESCUENTO,
                                    (VL_DESCUENTO)*-1 ,
                                    VL_FECHA_EFF,
                                    VL_DESC,
                                    SYSDATE,
                                    VL_FECHA_EFF,
                                    'PUNI_SIU',
                                    'PUNI_SIU',
                                    'T' ,
                                    'Y',
                                    0 ,
                                    'MXN',
                                    ALUMNO.TBRACCD_TRAN_NUMBER,
                                    ALUMNO.TBRACCD_STSP_KEY_SEQUENCE,
                                    ALUMNO.TBRACCD_PERIOD,
                                    ALUMNO.TBRACCD_FEED_DATE
                                    );

                         EXCEPTION
                         WHEN OTHERS THEN
                         VL_ERROR :=' Errror al Insertar el Ajuste>>  ' || SQLERRM ;
                         END;

                     END;

                   END IF;

                   VL_CADENA_ERROR:= VL_ERROR;

                   BEGIN
                     UPDATE TBRACCD
                        SET TBRACCD_DOCUMENT_NUMBER = 'PAGOUNIC'
                      WHERE     TBRACCD_PIDM = DESCUENTO.TZTPUNI_PIDM
                            AND TBRACCD_FEED_DATE = ALUMNO.TBRACCD_FEED_DATE
                            AND TBRACCD_DETAIL_CODE = DESCUENTO.TZTPUNI_CODIGO
                            AND TRUNC(TBRACCD_ENTRY_DATE) = TRUNC(SYSDATE)
                            AND TBRACCD_DOCUMENT_NUMBER IS NULL;
                   END;

                   BEGIN
                     UPDATE TVRACCD
                        SET TVRACCD_DOCUMENT_NUMBER = 'PAGOUNIC'
                      WHERE     TVRACCD_PIDM = DESCUENTO.TZTPUNI_PIDM
                            AND TVRACCD_FEED_DATE = ALUMNO.TBRACCD_FEED_DATE
                            AND TVRACCD_DETAIL_CODE = DESCUENTO.TZTPUNI_CODIGO
                            AND TRUNC(TVRACCD_ENTRY_DATE) = TRUNC(SYSDATE)
                            AND TVRACCD_DOCUMENT_NUMBER IS NULL;

                   END;

                   IF VL_APLI_DESCU = ALUMNO.SECU THEN
                      EXIT;
                   END IF;

                 END LOOP;


               END;

               IF (VL_CADENA_ERROR IS NULL OR VL_CADENA_ERROR = 'EXITO')THEN

                 IF DESCUENTO.TZTPUNI_CHECK = 1 THEN

                       VL_DIA:= DESCUENTO.DIAP;
                       VL_FECHA_FINAL:= DESCUENTO.TZTPUNI_PROX_FECHA;

                 ELSE

                       VL_DIA:= DESCUENTO.DIA;
                       VL_FECHA_FINAL:= DESCUENTO.TZTPUNI_FECHA_INICIO;

                 END IF;

                 IF VL_DIA > 20 THEN

                   BEGIN
                     SELECT ADD_MONTHS((TRUNC(VL_FECHA_FINAL)-(TO_NUMBER(TO_CHAR(VL_FECHA_FINAL,'DD'))-1)),(DESCUENTO.TZTPUNI_REPLICA+1))
                       INTO VL_FECHA_NEW
                       FROM DUAL;
                   EXCEPTION
                   WHEN OTHERS THEN
                   VL_FECHA_NEW:=NULL;
                   VL_ERROR:='ERROR AL CALCULAR FECHA NUEVA'||SQLERRM;
                   END;

                 ELSE

                   BEGIN
                     SELECT ADD_MONTHS((TRUNC(VL_FECHA_FINAL)-(TO_NUMBER(TO_CHAR(VL_FECHA_FINAL,'DD'))-1)),DESCUENTO.TZTPUNI_REPLICA)
                       INTO VL_FECHA_NEW
                       FROM DUAL;
                   EXCEPTION
                   WHEN OTHERS THEN
                   VL_FECHA_NEW:=NULL;
                   VL_ERROR:='ERROR AL CALCULAR FECHA NUEVA'||SQLERRM;
                   END;

                 END IF;

                 BEGIN
                   UPDATE TZTPUNI
                   SET TZTPUNI_CHECK = 1,
                       TZTPUNI_APLI = NVL(DESCUENTO.TZTPUNI_APLI,0)+1,
                       TZTPUNI_OBSERVACIONES = 'GENERADO CORRECTAMENTE',
                       TZTPUNI_PROX_FECHA = VL_FECHA_NEW,
                       TZTPUNI_CHECK_ERROR = NULL
                   WHERE TZTPUNI_PIDM = DESCUENTO.TZTPUNI_PIDM
                   AND TZTPUNI_FECHA_INICIO = DESCUENTO.TZTPUNI_FECHA_INICIO;
                 END;

                 BEGIN
                   SELECT COUNT(*)
                     INTO VL_FINAL
                     FROM TBRACCD
                    WHERE     TBRACCD_PIDM = P_PIDM
                          AND TBRACCD_DOCUMENT_NUMBER = 'PAGOUNIC'
                          AND TBRACCD_EFFECTIVE_DATE >= DESCUENTO.TZTPUNI_FECHA_INICIO;
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_DESCUENTOS:=0;
                 END;

                 IF  VL_NUM_APLICA = VL_FINAL THEN

                    UPDATE TZTPUNI
                       SET TZTPUNI_CHECK = 1,
                           TZTPUNI_APLI = NVL(DESCUENTO.TZTPUNI_APLI,0)+1,
                           TZTPUNI_OBSERVACIONES = 'DESCUENTO FINALIZADO',
                           TZTPUNI_CHECK_ERROR = NULL,
                           TZTPUNI_CHECH_FINAL = 1
                     WHERE     TZTPUNI_PIDM = DESCUENTO.TZTPUNI_PIDM
                           AND TZTPUNI_FECHA_INICIO = DESCUENTO.TZTPUNI_FECHA_INICIO;

                 END IF;

               ELSE

                ROLLBACK;

                 IF DESCUENTO.TZTPUNI_CHECK = 1 THEN

                   UPDATE TZTPUNI
                      SET TZTPUNI_CHECK_ERROR = 1,
                          TZTPUNI_OBSERVACIONES = VL_CADENA_ERROR,
                          TZTPUNI_PROX_FECHA = P_FECHA
                    WHERE     TZTPUNI_PIDM = DESCUENTO.TZTPUNI_PIDM
                          AND TZTPUNI_FECHA_INICIO = DESCUENTO.TZTPUNI_FECHA_INICIO;

                 ELSE

                    UPDATE TZTPUNI
                       SET TZTPUNI_CHECK = 0,
                           TZTPUNI_OBSERVACIONES = VL_CADENA_ERROR,
                           TZTPUNI_PROX_FECHA = P_FECHA
                     WHERE     TZTPUNI_PIDM = DESCUENTO.TZTPUNI_PIDM
                           AND TZTPUNI_FECHA_INICIO = DESCUENTO.TZTPUNI_FECHA_INICIO;

                 END IF;

               END IF;

             ELSE

                VL_ERROR:= 'No existe pago en el estado de cuenta = '||DESCUENTO.TZTPUNI_MONTO;

                BEGIN
                  UPDATE TZTPUNI
                     SET TZTPUNI_CHECK = 0,
                         TZTPUNI_OBSERVACIONES = VL_ERROR
                   WHERE     TZTPUNI_PIDM = P_PIDM
                         AND TZTPUNI_FECHA_INICIO = P_FECHA;
                END;

             END IF;


           END LOOP;

         END;

       ELSE

       VL_ERROR:= 'NO EXISTE CARTERA PARA LA FECHA INICIO = '||P_FECHA;

         BEGIN
           UPDATE TZTPUNI
              SET TZTPUNI_CHECK = 0,
                  TZTPUNI_OBSERVACIONES = VL_ERROR
            WHERE     TZTPUNI_PIDM = P_PIDM
                  AND TZTPUNI_FECHA_INICIO = P_FECHA
                  AND TZTPUNI_CHECH_FINAL IS NULL;
         END;

         IF SQL%ROWCOUNT = 0 THEN

            BEGIN
              UPDATE TZTPUNI
                 SET TZTPUNI_CHECK_ERROR = 1,
                     TZTPUNI_OBSERVACIONES = VL_ERROR
               WHERE     TZTPUNI_PIDM = P_PIDM
                     AND TZTPUNI_PROX_FECHA = P_FECHA
                     AND TZTPUNI_CHECH_FINAL IS NULL;
            END;

         END IF;

       END IF;

   END IF;


  COMMIT;

    DBMS_OUTPUT.PUT_LINE('F_DES_PAG_UNI  = '||VL_ERROR);

   RETURN(VL_ERROR);

 END F_DES_PAG_UNI;

FUNCTION F_CAN_UNI (P_PIDM IN NUMBER, P_FECHA IN DATE) RETURN VARCHAR2 IS

VL_RESP             VARCHAR2(500);
VL_EXI_TBRA         NUMBER;
VL_ERROR            VARCHAR2(500);
VL_DESCUENTO        NUMBER;
VL_CADENA_ERROR     VARCHAR2(500);
VL_AJUSTES          NUMBER;
VL_DESC             VARCHAR2(35);
VL_FECHA_NEW        DATE;
VL_DIA              NUMBER;
VL_FECHA_FINAL      DATE;
VL_PAGO             NUMBER;
VL_CANCE            NUMBER;


 BEGIN

    BEGIN

           SELECT COUNT(*)
           INTO  VL_CANCE
           FROM  TZTPUNI
           WHERE TZTPUNI_PIDM = P_PIDM
           AND   (TZTPUNI_FECHA_INICIO = P_FECHA
                  OR TZTPUNI_PROX_FECHA = P_FECHA)
           AND   TZTPUNI_CHECK = 1;

    EXCEPTION
    WHEN OTHERS THEN
    VL_CANCE:=0;
    END;

    IF VL_CANCE > 0 THEN

         BEGIN

            FOR DESCUENTO IN (

                           SELECT     TZTPUNI_PIDM,
                                      TZTPUNI_ID,
                                      TZTPUNI_TERM_CODE,
                                      TZTPUNI_FECHA_INICIO,
                                      TO_CHAR(TZTPUNI_FECHA_INICIO,'DD')DIA,
                                      NVL(TO_CHAR(TZTPUNI_PROX_FECHA,'DD'),'01')DIAP,
                                      TZTPUNI_PROX_FECHA,
                                      TZTPUNI_MONTO,
                                      TZTPUNI_PORCENTAJE,
                                      TZTPUNI_CODIGO,
                                      TZTPUNI_REPLICA,
                                      TZTPUNI_VECES,
                                      TZTPUNI_APLI,
                                      TZTPUNI_CHECK
                           FROM  TZTPUNI
                           WHERE TZTPUNI_PIDM = P_PIDM
                           AND   (TZTPUNI_FECHA_INICIO = P_FECHA
                                  OR TZTPUNI_PROX_FECHA = P_FECHA)
                           AND   TZTPUNI_CHECK = 1

           )LOOP



              BEGIN

                    FOR ALUMNO IN (

                                    SELECT *
                                    FROM  TBRACCD A,TBBDETC
                                    WHERE TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
                                    AND   TBRACCD_PIDM = P_PIDM
                                    AND   TBRACCD_FEED_DATE = P_FECHA
                                    AND   TBRACCD_DETAIL_CODE = DESCUENTO.TZTPUNI_CODIGO
                                    AND   TBRACCD_DOCUMENT_NUMBER = 'PAGOUNIC'

                )LOOP

                    BEGIN

                        SELECT TBBDETC_DESC
                        INTO VL_DESC
                        FROM TBBDETC
                        WHERE TBBDETC_DETAIL_CODE = SUBSTR(DESCUENTO.TZTPUNI_CODIGO,1,2)||'30';

                    EXCEPTION
                    WHEN OTHERS THEN
                    VL_DESC:=NULL;
                    VL_CADENA_ERROR:='Error en descripcion '||sqlerrm;
                    END;

                    BEGIN    PKG_FINANZAS.P_DESAPLICA_PAGOS ( ALUMNO.TBRACCD_PIDM, ALUMNO.TBRACCD_TRAN_NUMBER); END;

                    BEGIN

                        VL_RESP := PKG_FINANZAS.SP_APLICA_AJUSTE (ALUMNO.TBRACCD_PIDM,
                                                                  ALUMNO.TBRACCD_TRAN_NUMBER,
                                                                  SUBSTR(DESCUENTO.TZTPUNI_CODIGO,1,2)||'30',
                                                                  ALUMNO.TBRACCD_AMOUNT,
                                                                  ALUMNO.TBRACCD_TERM_CODE,
                                                                  VL_DESC,
                                                                  ALUMNO.TBRACCD_EFFECTIVE_DATE,
                                                                  ALUMNO.TBRACCD_STSP_KEY_SEQUENCE,
                                                                  ALUMNO.TBRACCD_FEED_DATE,
                                                                  ALUMNO.TBRACCD_PERIOD,
                                                                  USER);
                    END;

                    VL_CADENA_ERROR:= VL_RESP;

                 DBMS_OUTPUT.PUT_LINE('FOR ALUMNO == '||ALUMNO.TBRACCD_PIDM||' == '||ALUMNO.TBRACCD_TRAN_NUMBER);


                END LOOP;

              END;

              BEGIN

                BEGIN

                    UPDATE  TBRACCD
                    SET     TBRACCD_DOCUMENT_NUMBER = 'CANUNIC'
                    WHERE   TBRACCD_PIDM = P_PIDM
                    AND     TBRACCD_FEED_DATE = P_FECHA
                    AND     TBRACCD_DETAIL_CODE = DESCUENTO.TZTPUNI_CODIGO
                    AND     TBRACCD_DOCUMENT_NUMBER = 'PAGOUNIC'
                    ;

                END;

                BEGIN

                    UPDATE  TVRACCD
                    SET     TVRACCD_DOCUMENT_NUMBER = 'CANUNIC'
                    WHERE   TVRACCD_PIDM = P_PIDM
                    AND     TVRACCD_FEED_DATE = P_FECHA
                    AND     TVRACCD_DETAIL_CODE = DESCUENTO.TZTPUNI_CODIGO
                    AND     TVRACCD_DOCUMENT_NUMBER = 'PAGOUNIC'
                    ;

                END;

                IF SQL%ROWCOUNT = 0 THEN

                    VL_CADENA_ERROR:= 'NO ACTUALIZA = '||DESCUENTO.TZTPUNI_CODIGO||' = '||P_FECHA||' = '||P_PIDM;

                ELSE

                    VL_CADENA_ERROR:= DESCUENTO.TZTPUNI_CODIGO||' = '||P_FECHA||' = '||P_PIDM;

                END IF;

              END;

              IF DESCUENTO.TZTPUNI_FECHA_INICIO = P_FECHA THEN

                  UPDATE TZTPUNI
                  SET TZTPUNI_CHECK = 0,
                      TZTPUNI_APLI = NVL(DESCUENTO.TZTPUNI_APLI,0)-1,
                      TZTPUNI_OBSERVACIONES = 'Se cancela descuento programado por cambio de fecha inicio',
                      TZTPUNI_CHECK_ERROR = NULL
                  WHERE TZTPUNI_PIDM = P_PIDM
                  AND TZTPUNI_FECHA_INICIO = P_FECHA;

              ELSIF DESCUENTO.TZTPUNI_FECHA_INICIO != P_FECHA AND DESCUENTO.TZTPUNI_PROX_FECHA = P_FECHA THEN

                  UPDATE TZTPUNI
                  SET TZTPUNI_APLI = NVL(DESCUENTO.TZTPUNI_APLI,0)-1,
                      TZTPUNI_OBSERVACIONES = 'Se cancela descuento programado por cambio de fecha inicio',
                      TZTPUNI_CHECK_ERROR = 1,
                      TZTPUNI_CHECH_FINAL = NULL
                  WHERE TZTPUNI_PIDM = P_PIDM
                  AND TZTPUNI_PROX_FECHA = P_FECHA;

              END IF;

           END LOOP;

         END;

    ELSE

      VL_ERROR:= 'Se cancela descuento programado por cambio de fecha inicio; sin ajustes por aplicar';

      BEGIN

          UPDATE TZTPUNI
          SET   TZTPUNI_CHECK = 0,
                TZTPUNI_OBSERVACIONES = VL_ERROR
          WHERE TZTPUNI_PIDM = P_PIDM
          AND   TZTPUNI_FECHA_INICIO = P_FECHA
          ;

      END;

      VL_CADENA_ERROR:= VL_CADENA_ERROR;

    END IF;

  COMMIT;

    DBMS_OUTPUT.PUT_LINE('F_DES_PAG_UNI  = '||VL_CADENA_ERROR);

   RETURN(VL_CADENA_ERROR);

 END F_CAN_UNI;


FUNCTION F_MESES_CUR (P_PIDM IN NUMBER) RETURN VARCHAR2
AS

VL_MESES    NUMBER;

BEGIN

    BEGIN
                    SELECT
                           NVL( CASE
                                WHEN MESES < 0 THEN 0
                                WHEN MESES > 0 THEN MESES
                           END,0)MESES
                    INTO VL_MESES
                    FROM(
                    SELECT CAMP,
                           NIVEL,
                           ID,
                           PIDM,
                           PROGRAMA,
                           RATE,
                           STUDY,
                           FECHA_MATE,
                           FECHA_CXC,
                           FECHA_INICIO,
                           (CASE
                                 WHEN FECHA_CXC IS NOT NULL THEN (SELECT ROUND(MONTHS_BETWEEN(TO_DATE(FECHA_INICIO),TO_DATE(FECHA_CXC)))FROM DUAL)
                                 WHEN FECHA_CXC IS NULL THEN (SELECT ROUND(MONTHS_BETWEEN(TO_DATE(FECHA_INICIO),TO_DATE(FECHA_MATE)))FROM DUAL)
                           END) MESES
                    FROM (
                    SELECT DISTINCT
                           SORLCUR_CAMP_CODE CAMP,
                           SORLCUR_LEVL_CODE NIVEL,
                           SORLCUR_PROGRAM PROGRAMA,
                           SPRIDEN_ID ID,
                           SFRSTCR_PIDM PIDM,
                           SPRIDEN_FIRST_NAME||' '||SPRIDEN_LAST_NAME ALUMNO,
                           (SELECT TO_DATE(TRUNC(MIN (SSBSECT_PTRM_START_DATE),'MONTH'))
                            FROM SFRSTCR F1,SSBSECT T1
                            WHERE SFRSTCR_CRN = SSBSECT_CRN
                            AND SFRSTCR_TERM_CODE = SSBSECT_TERM_CODE
                            AND SFRSTCR_PTRM_CODE = SSBSECT_PTRM_CODE
                            AND SFRSTCR_PIDM = CUR.SORLCUR_PIDM
                            AND SFRSTCR_STSP_KEY_SEQUENCE = CUR.SORLCUR_KEY_SEQNO
                            AND SFRSTCR_RSTS_CODE = 'RE')FECHA_MATE,
                           (SELECT MAX(TZTINCR_START_DATE)
                            FROM TZTINCR
                            WHERE TZTINCR_PIDM = CUR.SORLCUR_PIDM
                            AND TZTINCR_STUDY = CUR.SORLCUR_KEY_SEQNO)FECHA_CXC,
                           SORLCUR_START_DATE FECHA_INICIO,
                           SORLCUR_KEY_SEQNO STUDY,
                           SORLCUR_RATE_CODE RATE
                    FROM SFRSTCR HST,
                         SORLCUR CUR,
                         SPRIDEN
                    WHERE 1 = 1
                    AND HST.SFRSTCR_PIDM=CUR.SORLCUR_PIDM
                    AND SPRIDEN_PIDM = SORLCUR_PIDM
                    AND SPRIDEN_CHANGE_IND IS NULL
                    AND SPRIDEN_PIDM = P_PIDM
                    AND CUR.SORLCUR_LMOD_CODE = 'LEARNER'
                    AND CUR.SORLCUR_ROLL_IND  = 'Y'
                    AND CUR.SORLCUR_CACT_CODE = 'ACTIVE'
                    AND CUR.SORLCUR_SEQNO = (SELECT MAX(CUR2.SORLCUR_SEQNO)
                                              FROM SORLCUR CUR2
                                              WHERE 1 = 1
                                              AND CUR2.SORLCUR_PIDM=CUR.SORLCUR_PIDM
                                              AND CUR2.SORLCUR_LMOD_CODE = CUR.SORLCUR_LMOD_CODE
                                              AND CUR2.SORLCUR_ROLL_IND = CUR.SORLCUR_ROLL_IND
                                              AND CUR2.SORLCUR_CACT_CODE = CUR.SORLCUR_CACT_CODE)
                    AND CUR.SORLCUR_KEY_SEQNO = HST.SFRSTCR_STSP_KEY_SEQUENCE
                    AND HST.SFRSTCR_RSTS_CODE = 'RE'
                    AND SORLCUR_CAMP_CODE IN ('UTS','UTL')
                    AND NOT EXISTS (SELECT GORADID_PIDM
                                      FROM GORADID
                                     WHERE     GORADID_ADID_CODE = 'INBE'
                                           AND GORADID_PIDM = CUR.SORLCUR_PIDM)
                    )ALUMNO
                    WHERE 1=1)X
                    WHERE 1=1;

    EXCEPTION
    WHEN OTHERS THEN
    VL_MESES:=NULL;
    END;

  RETURN(VL_MESES);

END;

FUNCTION F_ACTUALIZA_RATE (P_PIDM NUMBER,P_PERIODO VARCHAR2,P_RATE VARCHAR2, P_STUDY NUMBER,P_REGLA NUMBER) RETURN VARCHAR2
IS

  VL_MONTO      NUMBER ;
  VL_DESCDSI    NUMBER;
  L_CONTAR      NUMBER;
  L_ACTSOR      NUMBER;
  L_ACTGAS      NUMBER;
  VL_ERROR      VARCHAR2(500):='EXITO';
  VL_NEW_RATE   VARCHAR2(5);


 BEGIN

    BEGIN

        SELECT SUBSTR(P_RATE,1,2)||2||SUBSTR(P_RATE,4,2)
        INTO VL_NEW_RATE
        FROM DUAL
        ;

    EXCEPTION
    WHEN OTHERS THEN
    VL_ERROR:= 'ERROR CALCULAR RATE = '||SQLERRM;
    END;

    --DBMS_OUTPUT.PUT_LINE('REZA 1 = '||VL_NEW_RATE);

    BEGIN

            UPDATE SORLCUR A
               SET SORLCUR_RATE_CODE = VL_NEW_RATE
            WHERE    1=1
                 AND A.SORLCUR_PIDM = P_PIDM
                 AND A.SORLCUR_LMOD_CODE = 'LEARNER'
                 AND A.SORLCUR_ROLL_IND  = 'Y'
                 AND A.SORLCUR_CACT_CODE = 'ACTIVE'
                 AND A.SORLCUR_SEQNO IN (SELECT MAX (A1.SORLCUR_SEQNO)
                                           FROM SORLCUR A1
                                          WHERE    A1.SORLCUR_PIDM = A.SORLCUR_PIDM
                                               AND A1.SORLCUR_ROLL_IND  = A.SORLCUR_ROLL_IND
                                               AND A1.SORLCUR_CACT_CODE = A.SORLCUR_CACT_CODE
                                               AND A1.SORLCUR_LMOD_CODE = A.SORLCUR_LMOD_CODE);

    EXCEPTION
    WHEN OTHERS THEN
    VL_ERROR:= 'NO ACTUALIZA SORLCUR = '||SQLERRM;
    END;

    --DBMS_OUTPUT.PUT_LINE('REZA 2 = '||VL_ERROR);

    BEGIN

          UPDATE SGBSTDN A
             SET A.SGBSTDN_RATE_CODE = VL_NEW_RATE
           WHERE    A.SGBSTDN_PIDM = P_PIDM
                AND A.SGBSTDN_TERM_CODE_EFF = (SELECT MAX (SGBSTDN_TERM_CODE_EFF)
                                                 FROM SGBSTDN A1
                                                WHERE A1.SGBSTDN_PIDM = A.SGBSTDN_PIDM);
    EXCEPTION
    WHEN OTHERS THEN
    VL_ERROR:= 'NO ACTUALIZA SGBSTDN = '||SQLERRM;
    END;

    BEGIN
        UPDATE SZTPRONO
              SET SZTPRONO_RATE=VL_NEW_RATE
              WHERE SZTPRONO_PIDM=P_PIDM
              AND SZTPRONO_NO_REGLA=P_REGLA
              ;
      EXCEPTION
    WHEN OTHERS THEN
    VL_ERROR:= 'NO ACTUALIZA = SZTPRONO  '||SQLERRM;
    --DBMS_OUTPUT.PUT_LINE('PRONO = '||VL_ERROR);
    END;
    --DBMS_OUTPUT.PUT_LINE('REZA 3 = '||VL_ERROR);

     BEGIN

        SELECT DISTINCT TZTDMTO_MONTO
        INTO VL_MONTO
        FROM TZTDMTO A
        WHERE A.TZTDMTO_PIDM   = P_PIDM
        AND A.TZTDMTO_IND = 1
        AND A.TZTDMTO_STUDY_PATH = P_STUDY
        AND ( A.TZTDMTO_TERM_CODE  = P_PERIODO
             OR A.TZTDMTO_TERM_CODE = (SELECT MAX (TZT.TZTDMTO_TERM_CODE)
                                       FROM TZTDMTO TZT
                                       WHERE TZT.TZTDMTO_PIDM = A.TZTDMTO_PIDM
                                       AND   TZT.TZTDMTO_CAMP_CODE = A.TZTDMTO_CAMP_CODE
                                       AND  TZT.TZTDMTO_NIVEL = A.TZTDMTO_NIVEL
                                       AND TZT.TZTDMTO_PROGRAMA = A.TZTDMTO_PROGRAMA
                                       AND TZT.TZTDMTO_IND = 1
                                       AND TZT.TZTDMTO_STUDY_PATH = A.TZTDMTO_STUDY_PATH
                                       AND TZT.TZTDMTO_TERM_CODE  <= P_PERIODO))
        AND A.TZTDMTO_ACTIVITY_DATE = (SELECT MAX (A1.TZTDMTO_ACTIVITY_DATE)
                                        FROM TZTDMTO A1
                                        WHERE A1.TZTDMTO_PIDM = A.TZTDMTO_PIDM
                                        AND   A1.TZTDMTO_CAMP_CODE = A.TZTDMTO_CAMP_CODE
                                        AND  A1.TZTDMTO_NIVEL = A.TZTDMTO_NIVEL
                                        AND A1.TZTDMTO_PROGRAMA = A.TZTDMTO_PROGRAMA
                                        AND A1.TZTDMTO_IND = 1
                                        AND A1.TZTDMTO_STUDY_PATH = A.TZTDMTO_STUDY_PATH
                                        AND ( A1.TZTDMTO_TERM_CODE  = P_PERIODO
                                              OR A1.TZTDMTO_TERM_CODE = (SELECT MAX (TZT.TZTDMTO_TERM_CODE)
                                                                         FROM TZTDMTO TZT
                                                                         WHERE TZT.TZTDMTO_PIDM = A.TZTDMTO_PIDM
                                                                         AND   TZT.TZTDMTO_CAMP_CODE = A.TZTDMTO_CAMP_CODE
                                                                         AND  TZT.TZTDMTO_NIVEL = A.TZTDMTO_NIVEL
                                                                         AND TZT.TZTDMTO_PROGRAMA = A.TZTDMTO_PROGRAMA
                                                                         AND TZT.TZTDMTO_IND = 1
                                                                         AND TZT.TZTDMTO_STUDY_PATH = A.TZTDMTO_STUDY_PATH
                                                                         AND TZT.TZTDMTO_TERM_CODE  <= P_PERIODO)))
         AND A.TZTDMTO_TERM_CODE  <= P_PERIODO
         AND ROWNUM = 1;

     EXCEPTION
     WHEN OTHERS THEN
     VL_MONTO:= 0;
     END;

     --DBMS_OUTPUT.PUT_LINE('REZA 4 = '||VL_MONTO);

     IF VL_MONTO > 0 THEN

         VL_DESCDSI:=(VL_MONTO/3)*2;

     --DBMS_OUTPUT.PUT_LINE('REZA 5 = '||VL_DESCDSI);

       BEGIN

         INSERT INTO TZTDMTO (TZTDMTO_ID,
                             TZTDMTO_PIDM,
                             TZTDMTO_CAMP_CODE,
                             TZTDMTO_NIVEL,
                             TZTDMTO_PROGRAMA,
                             TZTDMTO_TERM_CODE,
                             TZTDMTO_DESC_CODE,
                             TZTDMTO_APLICA_CODE,
                             TZTDMTO_MONTO,
                             TZTDMTO_STUDY_PATH,
                             TZTDMTO_IND,
                             TZTDMTO_ACTIVITY_DATE,
                             TZTDMTO_OBSERVACIONES)
               SELECT TZTDMTO_ID,
                      TZTDMTO_PIDM,
                      TZTDMTO_CAMP_CODE,
                      TZTDMTO_NIVEL,
                      TZTDMTO_PROGRAMA,
                      P_PERIODO,
                      TZTDMTO_DESC_CODE,
                      TZTDMTO_APLICA_CODE,
                      VL_DESCDSI,
                      TZTDMTO_STUDY_PATH,
                      1,
                      TZTDMTO_ACTIVITY_DATE,
                      TZTDMTO_OBSERVACIONES
                 FROM TZTDMTO A
                WHERE A.TZTDMTO_PIDM   = P_PIDM
                AND A.TZTDMTO_IND = 1
                AND A.TZTDMTO_STUDY_PATH = P_STUDY
                AND ( A.TZTDMTO_TERM_CODE  = P_PERIODO
                     OR A.TZTDMTO_TERM_CODE = (SELECT MAX (TZT.TZTDMTO_TERM_CODE)
                                               FROM TZTDMTO TZT
                                               WHERE TZT.TZTDMTO_PIDM = A.TZTDMTO_PIDM
                                               AND   TZT.TZTDMTO_CAMP_CODE = A.TZTDMTO_CAMP_CODE
                                               AND  TZT.TZTDMTO_NIVEL = A.TZTDMTO_NIVEL
                                               AND TZT.TZTDMTO_PROGRAMA = A.TZTDMTO_PROGRAMA
                                               AND TZT.TZTDMTO_IND = 1
                                               AND TZT.TZTDMTO_STUDY_PATH = A.TZTDMTO_STUDY_PATH
                                               AND TZT.TZTDMTO_TERM_CODE  <= P_PERIODO))
                AND A.TZTDMTO_ACTIVITY_DATE = (SELECT MAX (A1.TZTDMTO_ACTIVITY_DATE)
                                                FROM TZTDMTO A1
                                                WHERE A1.TZTDMTO_PIDM = A.TZTDMTO_PIDM
                                                AND   A1.TZTDMTO_CAMP_CODE = A.TZTDMTO_CAMP_CODE
                                                AND  A1.TZTDMTO_NIVEL = A.TZTDMTO_NIVEL
                                                AND A1.TZTDMTO_PROGRAMA = A.TZTDMTO_PROGRAMA
                                                AND A1.TZTDMTO_IND = 1
                                                AND A1.TZTDMTO_STUDY_PATH = A.TZTDMTO_STUDY_PATH
                                                AND ( A1.TZTDMTO_TERM_CODE  = P_PERIODO
                                                      OR A1.TZTDMTO_TERM_CODE = (SELECT MAX (TZT.TZTDMTO_TERM_CODE)
                                                                                 FROM TZTDMTO TZT
                                                                                 WHERE TZT.TZTDMTO_PIDM = A.TZTDMTO_PIDM
                                                                                 AND   TZT.TZTDMTO_CAMP_CODE = A.TZTDMTO_CAMP_CODE
                                                                                 AND  TZT.TZTDMTO_NIVEL = A.TZTDMTO_NIVEL
                                                                                 AND TZT.TZTDMTO_PROGRAMA = A.TZTDMTO_PROGRAMA
                                                                                 AND TZT.TZTDMTO_IND = 1
                                                                                 AND TZT.TZTDMTO_STUDY_PATH = A.TZTDMTO_STUDY_PATH
                                                                                 AND TZT.TZTDMTO_TERM_CODE  <= P_PERIODO)))
                 AND A.TZTDMTO_TERM_CODE  <= P_PERIODO
                 AND ROWNUM = 1;

       EXCEPTION
       WHEN OTHERS THEN
       VL_ERROR:= 'ERROR AL INSERTAR TZTDMTO = '||SQLERRM;
       END;

        --DBMS_OUTPUT.PUT_LINE('REZA 5 = '||VL_ERROR);

       BEGIN

         UPDATE TZTDMTO SET TZTDMTO_IND = 0
          WHERE 1=1
         AND TZTDMTO_IND = 1
         AND TZTDMTO_TERM_CODE <= P_PERIODO
         AND TZTDMTO_PIDM = P_PIDM
         AND TZTDMTO_STUDY_PATH = P_STUDY
         AND (TZTDMTO_MONTO != VL_DESCDSI OR TZTDMTO_MONTO IS NULL)
         ;

       END;

    END IF;

    RETURN(VL_ERROR);

    COMMIT;
 END F_ACTUALIZA_RATE;

FUNCTION F_CAN_PAQT (PN_PIDM IN NUMBER) RETURN VARCHAR2
AS

    VL_SECUENCIA            NUMBER:=0;
    VL_COD_CONTRA           VARCHAR2(6) := NULL;
    VL_DESC_CONTRA          VARCHAR2(50) :=NULL;
    VL_ERROR                VARCHAR2(500) :='EXITO';
    VL_AVANCE               NUMBER;
    VL_CAMPUS               VARCHAR2(4);
    VL_BESC                 NUMBER;

/* SE REALIZA CAMBIO PARA EXCLUIR BECAS ESPECIALES
ACTUALIZADO 04/03/2020  */

 BEGIN

   BEGIN

     SELECT NVL(SZTHITA_AVANCE,0),SORLCUR_CAMP_CODE
       INTO VL_AVANCE,VL_CAMPUS
       FROM SZTHITA,SORLCUR A
      WHERE     1=1
            AND SZTHITA_PIDM = SORLCUR_PIDM
            AND SZTHITA_PROG = SORLCUR_PROGRAM
            AND A.SORLCUR_LMOD_CODE = 'LEARNER'
            AND A.SORLCUR_ROLL_IND  = 'Y'
            AND A.SORLCUR_CACT_CODE = 'ACTIVE'
            AND A.SORLCUR_SEQNO IN (SELECT MAX (A1.SORLCUR_SEQNO)
                                   FROM SORLCUR A1
                                   WHERE A1.SORLCUR_PIDM = A.SORLCUR_PIDM
                                   AND A1.SORLCUR_ROLL_IND  = A.SORLCUR_ROLL_IND
                                   AND A1.SORLCUR_CACT_CODE = A.SORLCUR_CACT_CODE
                                   AND A1.SORLCUR_PROGRAM = A.SORLCUR_PROGRAM
                                   AND A1.SORLCUR_LMOD_CODE = A.SORLCUR_LMOD_CODE)
            AND A.SORLCUR_PIDM = PN_PIDM
            ;
   EXCEPTION
   WHEN OTHERS THEN
   VL_AVANCE:=0;
   END;

   BEGIN
     SELECT COUNT(*)
     INTO VL_BESC
     FROM GORADID
     WHERE GORADID_PIDM = PN_PIDM
     AND GORADID_ADID_CODE = 'BCSP';
   END;

   IF VL_BESC != 0 THEN VL_AVANCE:= 100; END IF;

   IF VL_AVANCE < 50 AND VL_CAMPUS IN ('UTL','UTS') THEN

       BEGIN
         FOR ALUMNO IN (

                      SELECT A.TBRACCD_TRAN_NUMBER TRANS,
                             B.SPRIDEN_ID,
                             A.TBRACCD_PIDM,
                             A.TBRACCD_TRAN_NUMBER_PAID PAGA,
                             A.TBRACCD_TERM_CODE,
                             A.TBRACCD_DETAIL_CODE CODIGO_DETALLE,
                             A.TBRACCD_DESC,
                             A.TBRACCD_AMOUNT,
                             A.TBRACCD_BALANCE,
                             C.TBBDETC_TYPE_IND TIPO,
                             A.TBRACCD_DOCUMENT_NUMBER,
                             A.TBRACCD_RECEIPT_NUMBER,
                             A.TBRACCD_STSP_KEY_SEQUENCE STUDY,
                             A.TBRACCD_PERIOD PARTE,
                             A.TBRACCD_FEED_DATE FECHA,
                             (SELECT SUBSTR(A.TBRACCD_DETAIL_CODE,1,2)||ZSTPARA_PARAM_VALOR
                                FROM ZSTPARA
                               WHERE ZSTPARA_MAPA_ID = 'CAN_PAQT'
                                    AND ZSTPARA_PARAM_ID = SUBSTR(A.TBRACCD_DETAIL_CODE,3,2))CANCELA
                        FROM TBRACCD A, SPRIDEN B, TBBDETC C
                       WHERE     A.TBRACCD_PIDM = B.SPRIDEN_PIDM
                             AND B.SPRIDEN_CHANGE_IND IS NULL
                             AND C.TBBDETC_DETAIL_CODE = A.TBRACCD_DETAIL_CODE
                             AND SUBSTR (A.TBRACCD_DETAIL_CODE, 3, 4) IN (SELECT (ZSTPARA_PARAM_ID)
                                                                            FROM ZSTPARA
                                                                           WHERE ZSTPARA_MAPA_ID = 'CAN_PAQT')
                             AND A.TBRACCD_DETAIL_CODE NOT IN (SELECT TBBDETC_DETAIL_CODE
                                                                 FROM TBBDETC
                                                                WHERE (   TBBDETC_DCAT_CODE IN ('TUI', 'DSP', 'LPC', 'DSI', 'COL')
                                                                       OR SUBSTR (TBBDETC_DETAIL_CODE, 3, 2) = 'M3'))
                             AND A.TBRACCD_PIDM = PN_PIDM
                             AND A.TBRACCD_DOCUMENT_NUMBER IS NULL
                    ORDER BY 3, 4


         ) LOOP

             BEGIN

                   SELECT NVL (MAX(TBRACCD_TRAN_NUMBER) , 0)+1
                   INTO VL_SECUENCIA
                   FROM TBRACCD
                   WHERE TBRACCD_PIDM =  ALUMNO.TBRACCD_PIDM;

             EXCEPTION
             WHEN OTHERS THEN
             VL_SECUENCIA := 1;
             END;

             BEGIN

                   SELECT TBBDETC_DETAIL_CODE, TBBDETC_DESC
                     INTO VL_COD_CONTRA, VL_DESC_CONTRA
                     FROM TBBDETC
                    WHERE    1=1
                         AND TBBDETC_DETAIL_CODE = ALUMNO.CANCELA;

             EXCEPTION
             WHEN OTHERS THEN
                 VL_COD_CONTRA:= NULL;
                 VL_DESC_CONTRA := NULL;
             END;



             IF VL_COD_CONTRA IS NOT NULL THEN

               PKG_FINANZAS.P_DESAPLICA_PAGOS (ALUMNO.TBRACCD_PIDM, ALUMNO.TRANS);

                IF ALUMNO.TIPO = 'C' THEN

                  BEGIN

                         INSERT
                           INTO TBRACCD
                         VALUES
                                (ALUMNO.TBRACCD_PIDM,   -- TBRACCD_PIDM
                                VL_SECUENCIA,     --TBRACCD_TRAN_NUMBER
                                ALUMNO.TBRACCD_TERM_CODE,    -- TBRACCD_TERM_CODE
                                VL_COD_CONTRA,     ---TBRACCD_DETAIL_CODE
                                USER,     ---TBRACCD_USER
                                SYSDATE,     --TBRACCD_ENTRY_DATE
                                ALUMNO.TBRACCD_AMOUNT,
                                (ALUMNO.TBRACCD_AMOUNT)*-1,    ---TBRACCD_BALANCE
                                SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                                NULL,    --TBRACCD_BILL_DATE
                                NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                                VL_DESC_CONTRA,    -- TBRACCD_DESC
                                ALUMNO.TBRACCD_RECEIPT_NUMBER,     --TBRACCD_RECEIPT_NUMBER
                                ALUMNO.TRANS,     --TBRACCD_TRAN_NUMBER_PAID
                                NULL,     --TBRACCD_CROSSREF_PIDM
                                NULL,    --TBRACCD_CROSSREF_NUMBER
                                NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                                'T',    --TBRACCD_SRCE_CODE
                                'Y',    --TBRACCD_ACCT_FEED_IND
                                SYSDATE,  --TBRACCD_ACTIVITY_DATE
                                0,        --TBRACCD_SESSION_NUMBER
                                NULL,    -- TBRACCD_CSHR_END_DATE
                                NULL,     --TBRACCD_CRN
                                NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                                NULL,     -- TBRACCD_LOC_MDT
                                NULL,     --TBRACCD_LOC_MDT_SEQ
                                NULL,     -- TBRACCD_RATE
                                NULL,     --TBRACCD_UNITS
                                'CANCE',     -- TBRACCD_DOCUMENT_NUMBER
                                SYSDATE,  -- TBRACCD_TRANS_DATE
                                NULL,        -- TBRACCD_PAYMENT_ID
                                NULL,     -- TBRACCD_INVOICE_NUMBER
                                NULL,     -- TBRACCD_STATEMENT_DATE
                                NULL,     -- TBRACCD_INV_NUMBER_PAID
                                'MXN',     -- TBRACCD_CURR_CODE
                                NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                                NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                                NULL,     -- TBRACCD_LATE_DCAT_CODE
                                ALUMNO.FECHA,     -- TBRACCD_FEED_DATE
                                NULL,     -- TBRACCD_FEED_DOC_CODE
                                NULL,     -- TBRACCD_ATYP_CODE
                                NULL,     -- TBRACCD_ATYP_SEQNO
                                NULL,     -- TBRACCD_CARD_TYPE_VR
                                NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                                NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                                NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                                NULL,     -- TBRACCD_ORIG_CHG_IND
                                NULL,     -- TBRACCD_CCRD_CODE
                                NULL,     -- TBRACCD_MERCHANT_ID
                                NULL,     -- TBRACCD_TAX_REPT_YEAR
                                NULL,     -- TBRACCD_TAX_REPT_BOX
                                NULL,     -- TBRACCD_TAX_AMOUNT
                                NULL,     -- TBRACCD_TAX_FUTURE_IND
                                'CANCE',     -- TBRACCD_DATA_ORIGIN
                                'CAJOR',   -- TBRACCD_CREATE_SOURCE
                                NULL,     -- TBRACCD_CPDT_IND
                                NULL,     --TBRACCD_AIDY_CODE
                                ALUMNO.STUDY,     --TBRACCD_STSP_KEY_SEQUENCE
                                ALUMNO.PARTE,     --TBRACCD_PERIOD
                                NULL,    --TBRACCD_SURROGATE_ID
                                NULL,     -- TBRACCD_VERSION
                                USER,     --TBRACCD_USER_ID
                                NULL );     --TBRACCD_VPDI_CODE

                  EXCEPTION
                  WHEN OTHERS THEN
                  VL_ERROR:= 'ERROR AL INSERTAR TBRACCD 1 = '||SQLERRM;
                  END;

                ELSIF ALUMNO.TIPO = 'P' THEN

                  BEGIN

                     INSERT
                       INTO TBRACCD
                     VALUES
                            (ALUMNO.TBRACCD_PIDM,   -- TBRACCD_PIDM
                            VL_SECUENCIA,     --TBRACCD_TRAN_NUMBER
                            ALUMNO.TBRACCD_TERM_CODE,    -- TBRACCD_TERM_CODE
                            VL_COD_CONTRA,     ---TBRACCD_DETAIL_CODE
                            USER,     ---TBRACCD_USER
                            SYSDATE,     --TBRACCD_ENTRY_DATE
                            ALUMNO.TBRACCD_AMOUNT,
                            ALUMNO.TBRACCD_AMOUNT,    ---TBRACCD_BALANCE
                            SYSDATE,     -- TBRACCD_EFFECTIVE_DATE
                            NULL,    --TBRACCD_BILL_DATE
                            NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                            VL_DESC_CONTRA,    -- TBRACCD_DESC
                            ALUMNO.TBRACCD_RECEIPT_NUMBER,     --TBRACCD_RECEIPT_NUMBER
                            ALUMNO.TRANS,     --TBRACCD_TRAN_NUMBER_PAID
                            NULL,     --TBRACCD_CROSSREF_PIDM
                            NULL,    --TBRACCD_CROSSREF_NUMBER
                            NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                            'T',    --TBRACCD_SRCE_CODE
                            'Y',    --TBRACCD_ACCT_FEED_IND
                            SYSDATE,  --TBRACCD_ACTIVITY_DATE
                            0,        --TBRACCD_SESSION_NUMBER
                            NULL,    -- TBRACCD_CSHR_END_DATE
                            NULL,     --TBRACCD_CRN
                            NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                            NULL,     -- TBRACCD_LOC_MDT
                            NULL,     --TBRACCD_LOC_MDT_SEQ
                            NULL,     -- TBRACCD_RATE
                            NULL,     --TBRACCD_UNITS
                            'CANCE',     -- TBRACCD_DOCUMENT_NUMBER
                            SYSDATE,  -- TBRACCD_TRANS_DATE
                            NULL,        -- TBRACCD_PAYMENT_ID
                            NULL,     -- TBRACCD_INVOICE_NUMBER
                            NULL,     -- TBRACCD_STATEMENT_DATE
                            NULL,     -- TBRACCD_INV_NUMBER_PAID
                            'MXN',     -- TBRACCD_CURR_CODE
                            NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                            NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                            NULL,     -- TBRACCD_LATE_DCAT_CODE
                            ALUMNO.FECHA,     -- TBRACCD_FEED_DATE
                            NULL,     -- TBRACCD_FEED_DOC_CODE
                            NULL,     -- TBRACCD_ATYP_CODE
                            NULL,     -- TBRACCD_ATYP_SEQNO
                            NULL,     -- TBRACCD_CARD_TYPE_VR
                            NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                            NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                            NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                            NULL,     -- TBRACCD_ORIG_CHG_IND
                            NULL,     -- TBRACCD_CCRD_CODE
                            NULL,     -- TBRACCD_MERCHANT_ID
                            NULL,     -- TBRACCD_TAX_REPT_YEAR
                            NULL,     -- TBRACCD_TAX_REPT_BOX
                            NULL,     -- TBRACCD_TAX_AMOUNT
                            NULL,     -- TBRACCD_TAX_FUTURE_IND
                            'CANCE',     -- TBRACCD_DATA_ORIGIN
                            'CAJOR',   -- TBRACCD_CREATE_SOURCE
                            NULL,     -- TBRACCD_CPDT_IND
                            NULL,     --TBRACCD_AIDY_CODE
                            ALUMNO.STUDY,     --TBRACCD_STSP_KEY_SEQUENCE
                            ALUMNO.PARTE,     --TBRACCD_PERIOD
                            NULL,    --TBRACCD_SURROGATE_ID
                            NULL,     -- TBRACCD_VERSION
                            USER,     --TBRACCD_USER_ID
                            NULL );     --TBRACCD_VPDI_CODE

                  EXCEPTION
                  WHEN OTHERS THEN
                  VL_ERROR:= 'ERROR AL INSERTAR TBRACCD 2 = '||SQLERRM;
                  END;

                END IF;

             END IF;

             BEGIN
                     UPDATE TBRACCD
                        SET TBRACCD_DOCUMENT_NUMBER = 'CANCE',
                            TBRACCD_TRAN_NUMBER_PAID = NULL
                      WHERE TBRACCD_PIDM = PN_PIDM
                        AND TBRACCD_TRAN_NUMBER = ALUMNO.TRANS;
             EXCEPTION
              WHEN OTHERS THEN
                VL_ERROR :=' Errror al actualizar tbraccd  ' || SQLERRM ;
             END;

             BEGIN
                     UPDATE TVRACCD
                        SET TVRACCD_DOCUMENT_NUMBER = 'CANCE',
                            TVRACCD_TRAN_NUMBER_PAID = NULL
                      WHERE TVRACCD_PIDM = PN_PIDM
                        AND TVRACCD_ACCD_TRAN_NUMBER = ALUMNO.TRANS;
             EXCEPTION
              WHEN OTHERS THEN
                VL_ERROR :=' Errror al actualizar tvraccd  ' || SQLERRM ;
             END;

         END LOOP;

       END;

   END IF;

  RETURN(VL_ERROR);

  COMMIT;

 END;

FUNCTION F_PARA_PAQT (P_PAQT IN VARCHAR2, P_NUMERO IN NUMBER)RETURN VARCHAR2 IS

VL_ENTRA        NUMBER;
VL_SEC          NUMBER;
VL_ERROR        VARCHAR2(500);

 BEGIN

    BEGIN
       SELECT COUNT(*)
         INTO VL_ENTRA
         FROM ZSTPARA
        WHERE ZSTPARA_MAPA_ID = '4TO. BIMESTRE' AND ZSTPARA_PARAM_VALOR = P_PAQT;

    EXCEPTION
    WHEN OTHERS THEN
    NULL;
    END;

    BEGIN

        SELECT MAX(ZSTPARA_PARAM_SEC)+1
          INTO VL_SEC
          FROM ZSTPARA
         WHERE ZSTPARA_MAPA_ID = '4TO. BIMESTRE';
    END;

    IF VL_ENTRA = 0 THEN

       BEGIN

         INSERT INTO ZSTPARA
         VALUES
               ('4TO. BIMESTRE',
                VL_SEC,
                P_NUMERO,
                'PROMOCION '||P_NUMERO||' BIM GRATIS',
                P_PAQT,
                SYSDATE,
                SYSDATE,
                USER);

          VL_ERROR:='EXITO';

       EXCEPTION
       WHEN OTHERS THEN
        VL_ERROR:= 'Error al insertar en ZSTPARA = '||SQLERRM;
       END;

    ELSE
        VL_ERROR:= 'Ya existe paquete en parametrizador';

    END IF;

   COMMIT;

  RETURN(VL_ERROR);

 END F_PARA_PAQT;

FUNCTION F_BIME_GRATIS (P_PIDM IN NUMBER,P_SEQNO IN NUMBER,P_FECHA IN DATE,P_PERIODICIDAD IN VARCHAR2, P_NIVEL VARCHAR2)RETURN VARCHAR2
IS

/*
    Función para aplicar el descuento de 4 bimestre gratis
    Autor JREZAOLI fecha  23/09/2019
*/

VL_PAQT             NUMBER;
VL_ERROR            VARCHAR2(500);
VL_TZFACCE          NUMBER;
VL_MATERIA          NUMBER;
VL_SALDO            NUMBER;
VL_PARCIALIDADES    NUMBER;
VL_RESPUESTA        VARCHAR2(500);
VL_SECU             NUMBER;
VL_DIAS             NUMBER;
VL_SEQNO            NUMBER;
VL_PAR1             NUMBER;
VL_PAR2             NUMBER;


 BEGIN

    BEGIN
           SELECT A.SORLCUR_APPL_KEY_SEQNO
             INTO VL_SEQNO
             FROM SORLCUR A
            WHERE 1=1
              AND A.SORLCUR_PIDM      = P_PIDM
              AND A.SORLCUR_LMOD_CODE = 'LEARNER'
              AND A.SORLCUR_ROLL_IND  = 'Y'
              AND A.SORLCUR_CACT_CODE = 'ACTIVE'
              AND A.SORLCUR_KEY_SEQNO = P_SEQNO
              AND A.SORLCUR_SEQNO IN (SELECT MAX (A1.SORLCUR_SEQNO)
                                              FROM SORLCUR A1
                                             WHERE 1=1
                                               AND A1.SORLCUR_PIDM      = A.SORLCUR_PIDM
                                               AND A1.SORLCUR_ROLL_IND  = A.SORLCUR_ROLL_IND
                                               AND A1.SORLCUR_CACT_CODE = A.SORLCUR_CACT_CODE
                                               AND A1.SORLCUR_LMOD_CODE = A.SORLCUR_LMOD_CODE
                                               AND A1.SORLCUR_KEY_SEQNO = P_SEQNO);

    EXCEPTION
    WHEN OTHERS THEN
    VL_SEQNO:=1;
    END;

    BEGIN

      SELECT DISTINCT ZSTPARA_PARAM_ID
        INTO VL_PAQT
        FROM ZSTPARA
       WHERE    1=1
            AND ZSTPARA_MAPA_ID = '4TO. BIMESTRE'
            AND (SELECT DISTINCT(SARACMT_COMMENT_TEXT)
                 FROM SARACMT MT
                WHERE     MT.SARACMT_PIDM = P_PIDM
                      AND MT.SARACMT_APPL_NO = vl_seqno
                      AND MT.SARACMT_ORIG_CODE = 'PAQT'
                      AND MT.SARACMT_SEQNO = (SELECT MAX(SARACMT_SEQNO)
                                                FROM SARACMT
                                               WHERE     SARACMT_PIDM = MT.SARACMT_PIDM
                                                     AND SARACMT_ORIG_CODE = 'PAQT'
                                                     AND SARACMT_APPL_NO = MT.SARACMT_APPL_NO)) LIKE '%'||ZSTPARA_PARAM_VALOR||'%';

    EXCEPTION
    WHEN OTHERS THEN
    VL_PAQT:=0;
    END;

    BEGIN
       SELECT COUNT (*)
         INTO VL_TZFACCE
         FROM TZFACCE
        WHERE 1 = 1 AND TZFACCE_PIDM = P_PIDM AND (TZFACCE_USER = 'ABCC' OR TZFACCE_USER = 'EDCA');
    EXCEPTION
       WHEN OTHERS
       THEN VL_TZFACCE := 0;
    END;

    IF (VL_PAQT = 0 OR VL_TZFACCE != 0) THEN VL_ERROR:= 'Alumno sin promocion 4to Bimestre gratis';

    ELSE

        BEGIN
           SELECT COUNT (*)
             INTO VL_MATERIA
             FROM SFRSTCR,SHRGRDE
            WHERE       1=1
                    AND SFRSTCR_GRDE_CODE = SHRGRDE_CODE
                    AND SUBSTR (SFRSTCR_TERM_CODE,5,1) NOT IN (8,9)
                    AND SFRSTCR_STSP_KEY_SEQUENCE = P_SEQNO
                    AND SHRGRDE_PASSED_IND = 'N'
                    AND SHRGRDE_LEVL_CODE  = P_NIVEL
                    AND SFRSTCR_PIDM = P_PIDM;
        EXCEPTION
           WHEN OTHERS
           THEN VL_MATERIA := 0;
        END;

        BEGIN
           SELECT SUM (TBRACCD_BALANCE)
             INTO VL_SALDO
             FROM TBRACCD
            WHERE TBRACCD_PIDM = P_PIDM AND TBRACCD_EFFECTIVE_DATE <= SYSDATE AND TBRACCD_FEED_DATE != P_FECHA;
        EXCEPTION
           WHEN OTHERS
           THEN VL_SALDO := 0;
        END;

        IF (VL_MATERIA > 0 OR VL_SALDO > 0) THEN

           VL_ERROR:='Alumno con promoción 4to Bimestre cancelado, materias reprobadas = '||VL_MATERIA||', saldo vencido = '||VL_SALDO;

        ELSE

            BEGIN

               SELECT COUNT(*)
                 INTO VL_PARCIALIDADES
                 FROM TBRACCD,TBBDETC
                WHERE       1=1
                        AND TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
                        AND TBBDETC_DCAT_CODE = 'COL'
                        AND TBBDETC_DESC LIKE 'COLEGIATURA %'
                        AND TBBDETC_DESC != 'COLEGIATURA EXTRAORDINARIO'
                        AND TBRACCD_STSP_KEY_SEQUENCE = P_SEQNO
                        AND TBRACCD_DOCUMENT_NUMBER IS NULL
                        AND TBRACCD_PIDM = P_PIDM
                        ;

            EXCEPTION
            WHEN OTHERS THEN
            VL_PARCIALIDADES:=0;
            END;

            IF P_PERIODICIDAD = 'Bime'
            THEN VL_DIAS:=1;
                 VL_PAR1:=1;
                 VL_PAR2:=2;
            ELSIF  P_PERIODICIDAD = 'Cuatri'
            THEN VL_DIAS:=1;
                 VL_PAR1:=3;
                 VL_PAR2:=4;
            END IF;

            IF      VL_PARCIALIDADES >= (VL_PAQT*2)
                AND VL_PARCIALIDADES <= (VL_PAQT*2)+VL_DIAS
                THEN

              BEGIN

                FOR ALUMNO IN (

                         SELECT *
                         FROM
                               (SELECT   ROW_NUMBER()OVER (PARTITION BY TBRACCD_PIDM ORDER BY TBRACCD_TRAN_NUMBER)SEC,
                                        TBRACCD_PIDM PIDM,
                                        TBRACCD_TRAN_NUMBER NUM,
                                        TBRACCD_TERM_CODE PERIODO,
                                        TBRACCD_PERIOD PARTE,
                                        TBRACCD_AMOUNT MONTO,
                                        TBRACCD_FEED_DATE FECHA,
                                        TBRACCD_STSP_KEY_SEQUENCE STUDY,
                                        TBRACCD_EFFECTIVE_DATE VIG,
                                        TBRACCD_RECEIPT_NUMBER ORDEN
                                 FROM TBRACCD,TBBDETC
                                WHERE       1=1
                                        AND TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
                                        AND TBBDETC_DCAT_CODE = 'COL'
                                        AND TBBDETC_DESC LIKE 'COLEGIATURA %'
                                        AND TBBDETC_DESC != 'COLEGIATURA EXTRAORDINARIO'
                                        AND TBRACCD_PIDM = P_PIDM
                                        AND TBRACCD_FEED_DATE = P_FECHA
                                        AND TBRACCD_DOCUMENT_NUMBER IS NULL
                                ORDER BY 2)
                         WHERE 1 = 1
                         AND SEC BETWEEN VL_PAR1 AND VL_PAR2

                )LOOP

                    PKG_FINANZAS.P_DESAPLICA_PAGOS (ALUMNO.PIDM, ALUMNO.NUM);

                    VL_RESPUESTA := PKG_FINANZAS.SP_APLICA_AJUSTE ( ALUMNO.PIDM,
                                                                    ALUMNO.NUM,
                                                                    SUBSTR(ALUMNO.PERIODO,1,2)||'R5',
                                                                    ALUMNO.MONTO,
                                                                    ALUMNO.PERIODO,
                                                                    'PROMOCION DESCUENTO',
                                                                    ALUMNO.VIG,
                                                                    ALUMNO.STUDY,
                                                                    ALUMNO.FECHA,
                                                                    ALUMNO.PARTE,
                                                                    USER );
                END LOOP;

              END;

              BEGIN

                  SELECT NVL(MAX(TZFACCE_SEC_PIDM)+1,1)
                  INTO VL_SECU
                  FROM TZFACCE
                  WHERE 1=1
                  AND TZFACCE_PIDM = P_PIDM;

              END;

              BEGIN
                   INSERT
                     INTO TZFACCE
                        (TZFACCE_PIDM,
                         TZFACCE_SEC_PIDM,
                         TZFACCE_TERM_CODE,
                         TZFACCE_DETAIL_CODE,
                         TZFACCE_DESC,
                         TZFACCE_AMOUNT,
                         TZFACCE_EFFECTIVE_DATE,
                         TZFACCE_USER,
                         TZFACCE_ACTIVITY_DATE,
                         TZFACCE_FLAG,
                         TZFACCE_STUDY
                          )
                        VALUES(
                         P_PIDM,
                         VL_SECU,
                         '00000',
                         '0000',
                         '4TO BIM FINALIZADO',
                         0,
                         SYSDATE,
                         'EDCA',
                         SYSDATE,
                         1,
                         1
                         );

              EXCEPTION
              WHEN OTHERS THEN
              VL_ERROR:='NO INSERTA';
              END;

            ELSE
                VL_ERROR:= 'Alumno fuera del rango de promoción';
            END IF;

        END IF;

    END IF;

--    DBMS_OUTPUT.PUT_LINE('REZA 4BIM GRATIS = '||
--                            VL_PAQT||' = '||
--                            VL_ERROR||' = '||
--                            VL_TZFACCE||' = '||
--                            VL_MATERIA||' = '||
--                            VL_SALDO||' = '||
--                            VL_PARCIALIDADES||' = '||
--                            VL_RESPUESTA||' = '||
--                            VL_SECU||' = '||
--                            VL_DIAS||' = '||
--                            P_SEQNO);
--    DBMS_OUTPUT.PUT_LINE(VL_ERROR);
    COMMIT;
   RETURN(VL_ERROR);

 END F_BIME_GRATIS;

 FUNCTION F_CANCEL_BIM_GRATIS (P_PIDM IN NUMBER,P_STUDY IN NUMBER,P_PROGRAM IN VARCHAR2) RETURN VARCHAR2
IS

vl_return  varchar2(100);
vl_seqno  number;
vl_paqt   varchar(200);
vl_secu  number;
vl_error varchar(500);

BEGIN
    BEGIN
           SELECT a.SORLCUR_APPL_KEY_SEQNO seqno
             INTO vl_seqno
             FROM sorlcur a
            WHERE 1=1
              AND a.sorlcur_pidm      = p_pidm
              AND a.sorlcur_program   = p_program
              AND a.sorlcur_lmod_code = 'LEARNER'
              AND a.sorlcur_roll_ind  = 'Y'
              AND a.sorlcur_cact_code = 'ACTIVE'
              and a.SORLCUR_KEY_SEQNO = p_study
              AND a.sorlcur_seqno in (SELECT MAX (a1.sorlcur_seqno)
                                              FROM sorlcur a1
                                             WHERE 1=1
                                               AND a1.sorlcur_pidm      = a.sorlcur_pidm
                                               AND a1.sorlcur_roll_ind  = a.sorlcur_roll_ind
                                               AND a1.sorlcur_cact_code = a.sorlcur_cact_code
                                               AND a1.sorlcur_lmod_code = a.sorlcur_lmod_code
                                               and a1.SORLCUR_KEY_SEQNO = p_study
                                               AND a1.sorlcur_program   = p_program
                                      );

         EXCEPTION
          WHEN OTHERS THEN
          vl_seqno:=null;
    END;

      BEGIN

      SELECT DISTINCT zstpara_param_id
        INTO vl_paqt
        FROM zstpara
       WHERE    1=1
         AND ZSTPARA_MAPA_ID = '4TO. BIMESTRE'
         AND (SELECT DISTINCT(SARACMT_COMMENT_TEXT)
                 FROM SARACMT MT
                WHERE     MT.SARACMT_PIDM = P_PIDM
                      AND MT.SARACMT_APPL_NO = vl_seqno
                      AND MT.SARACMT_ORIG_CODE = 'PAQT'
                      AND MT.SARACMT_SEQNO = (SELECT MAX(SARACMT_SEQNO)
                                                FROM SARACMT
                                               WHERE     SARACMT_PIDM = MT.SARACMT_PIDM
                                                     AND SARACMT_ORIG_CODE = 'PAQT'
                                                     AND SARACMT_APPL_NO = MT.SARACMT_APPL_NO)) LIKE '%'||ZSTPARA_PARAM_VALOR||'%'

                                                                             ;

    EXCEPTION
    WHEN OTHERS THEN
    vl_paqt:=0;
    END;

    IF vl_paqt>0 THEN

      BEGIN
         SELECT NVL(MAX(tzfacce_sec_pidm)+1,1)
                   INTO vl_secu
                   FROM tzfacce
                  WHERE 1=1
                    AND tzfacce_pidm = p_pidm;

      EXCEPTION
       WHEN OTHERS THEN
       vl_secU:=1;
       vl_return:='no inserta';
      END;

      BEGIN
          INSERT INTO tzfacce
               (tzfacce_pidm,
                tzfacce_sec_pidm,
                tzfacce_term_code,
                tzfacce_detail_code,
                tzfacce_desc,
                tzfacce_amount,
                tzfacce_effective_date,
                tzfacce_user,
                tzfacce_activity_date,
                tzfacce_flag,
                tzfacce_study
                 )
               VALUES(
                p_pidm,
                vl_secu,
                '00000',
                '0000',
                'CANCELACION 4TO BIM',
                0,
                SYSDATE,
                'ABCC',
                SYSDATE,
                1,
                1
                );

       EXCEPTION
       WHEN OTHERS THEN
       vl_return:='no inserta';
      END;

    ELSE
      vl_return:='no inserta';
    END IF;

    COMMIT;

    RETURN(VL_ERROR);

 END F_CANCEL_BIM_GRATIS;

 FUNCTION F_AMARRE_DOM_APPL(P_MATRICULA IN VARCHAR2)RETURN VARCHAR2 IS

VL_ERROR     VARCHAR2(10);

 BEGIN

    FOR DOM IN (
                SELECT DISTINCT
                       SPRIDEN_ID MATRICULA,
                       SPRIDEN_PIDM PIDM,
                       TBRACCD_TRAN_NUMBER,
                       (SELECT DISTINCT TBRACCD_DESC
                          FROM TBRACCD
                         WHERE       TBRACCD_PIDM = A.TBRACCD_PIDM
                                AND (TBRACCD_BALANCE*-1) = A.TBRACCD_BALANCE
                                AND  TBRACCD_BALANCE != 0)PAGA_DESC,
                       (SELECT MAX( TBRACCD_TRAN_NUMBER)
                          FROM TBRACCD
                         WHERE       TBRACCD_PIDM = A.TBRACCD_PIDM
                                AND (TBRACCD_BALANCE*-1) = A.TBRACCD_BALANCE
                                AND  TBRACCD_BALANCE != 0)PAGA_TRAN
                FROM TBRACCD A,SPRIDEN
                WHERE 1=1
                AND SPRIDEN_PIDM =TBRACCD_PIDM
                AND SPRIDEN_CHANGE_IND IS NULL
                AND A.TBRACCD_BALANCE > 0
                AND TRUNC(A.TBRACCD_EFFECTIVE_DATE) <= TRUNC(SYSDATE)
                AND TBRACCD_PIDM IN (SELECT TBRACCD_PIDM
                                       FROM TBRACCD B
                                        WHERE B.TBRACCD_BALANCE < 0
                                        AND TRUNC(B.TBRACCD_EFFECTIVE_DATE) <= TRUNC(SYSDATE)
                                        AND B.TBRACCD_PIDM = A.TBRACCD_PIDM)
                AND SPRIDEN_ID = P_MATRICULA
                AND (SELECT COUNT(DISTINCT TBRACCD_DESC)
                       FROM TBRACCD
                      WHERE      TBRACCD_PIDM = A.TBRACCD_PIDM
                            AND (TBRACCD_BALANCE*-1) = A.TBRACCD_BALANCE
                            AND  TBRACCD_BALANCE != 0) = 1
                AND (SELECT DISTINCT TBRACCD_DESC
                          FROM TBRACCD
                         WHERE       TBRACCD_PIDM = A.TBRACCD_PIDM
                                AND (TBRACCD_BALANCE*-1) = A.TBRACCD_BALANCE
                                AND  TBRACCD_BALANCE != 0) = 'DESCUENTO POR DOMICILIACION'
                ORDER BY 4 ASC

    )LOOP

        UPDATE TBRACCD
           SET TBRACCD_TRAN_NUMBER_PAID = DOM.TBRACCD_TRAN_NUMBER
         WHERE     1=1
               AND TBRACCD_PIDM = DOM.PIDM
               AND TBRACCD_TRAN_NUMBER = DOM.PAGA_TRAN
          ;

       IF SQL%ROWCOUNT != 0 THEN

        VL_ERROR:='EXITO';

       END IF;

    END LOOP;

    COMMIT;

    RETURN(VL_ERROR);

 END F_AMARRE_DOM_APPL;

FUNCTION F_INSERT_TZTBESP (P_PIDM       IN NUMBER,
                           P_MATRICULA  IN VARCHAR2,
                           P_ESTATUS    IN VARCHAR2,
                           P_MONTO      IN NUMBER) RETURN VARCHAR2
AS

/*  FUNCION PARA INSERTAR PARAMETROS DE BECAS ESPECIALES
    AUTOR:          JREZAOLI
    ACTUALIZADO:    04/03/2020
*/

VL_EXISTE               NUMBER;
VL_GORADID              VARCHAR2(10);
VL_PAGOS                NUMBER;
VL_CODIGO               VARCHAR2(4);
VL_DESC                 VARCHAR2(40);
VL_ERROR                VARCHAR2(800):= NULL;

BEGIN

  BEGIN
    SELECT COUNT(*)
    INTO VL_EXISTE
    FROM TZTBESP
    WHERE TZTBESP_PIDM = P_PIDM;
  END;

  BEGIN
    SELECT DISTINCT GORADID_ADID_CODE
      INTO VL_GORADID
      FROM GORADID
     WHERE     GORADID_PIDM = P_PIDM
           AND GORADID_ADID_CODE IN ( SELECT DISTINCT(SUBSTR(ZSTPARA_PARAM_ID,1,4))
                                        FROM ZSTPARA
                                       WHERE ZSTPARA_MAPA_ID = 'PARA_BCSP');
  EXCEPTION
  WHEN OTHERS THEN
  VL_ERROR:='ERROR AL ENCONTRAR GORADID '||SQLERRM;
  END;

  BEGIN
    SELECT TBBDETC_DETAIL_CODE,TBBDETC_DESC
      INTO VL_CODIGO,VL_DESC
      FROM TBBDETC,ZSTPARA
     WHERE     TBBDETC_DETAIL_CODE = SUBSTR(P_MATRICULA,1,2)||ZSTPARA_PARAM_VALOR
           AND ZSTPARA_MAPA_ID = 'PARA_BCSP'
           AND ZSTPARA_PARAM_ID = VL_GORADID||'_CODE';
  EXCEPTION
  WHEN OTHERS THEN
  VL_ERROR:='ERROR AL ENCONTRAR EL CODIGO'||SQLERRM;
  END;

  BEGIN
    SELECT ZSTPARA_PARAM_VALOR
      INTO VL_PAGOS
      FROM ZSTPARA
     WHERE     1=1
           AND ZSTPARA_MAPA_ID = 'PARA_BCSP'
           AND ZSTPARA_PARAM_ID = VL_GORADID||'_PAGO';
  EXCEPTION
  WHEN OTHERS THEN
  VL_ERROR:='ERROR AL ENCONTRAR NUM PAGOS'||SQLERRM;
  END;

  IF VL_EXISTE = 0 THEN

     IF VL_GORADID IS NOT NULL THEN


        BEGIN
          INSERT
            INTO TZTBESP
            VALUES (
                     P_PIDM,        -- TZTBESP_PIDM
                     P_MATRICULA,   -- TZTBESP_ID
                     P_ESTATUS,     -- TZTBESP_STS_CODE
                     VL_PAGOS,      -- TZTBESP_PAG
                     P_MONTO,       -- TZTBESP_AMOUNT
                     VL_CODIGO,     -- TZTBESP_DETAIL_CODE
                     VL_DESC,       -- TZTBESP_DESC
                     USER,          -- TZTBESP_USER
                     'TZTEDCA',     -- TZTBESP_DATA_ORIGIN
                     SYSDATE,       -- TZTBESP_ACTIVITY_DATE
                     NULL,          -- TZTBESP_CHECK
                     NULL,           -- TZTBESP_OBSERVACIONES
                     VL_GORADID
                         );

        EXCEPTION
        WHEN OTHERS THEN
        VL_ERROR:= 'ERROR AL INSERTAR EN TZTBESP = '||SQLERRM;
        END;

     END IF;

  END IF;

 RETURN(VL_ERROR);

 COMMIT;

END F_INSERT_TZTBESP;

PROCEDURE P_PAQT_ESPECIAL IS


VL_ENTRA            NUMBER;
VL_ESTATUS          VARCHAR2(3);
VL_MES_AVANCE       NUMBER;
VL_FECHA_ESTATUS    DATE;
VL_SECUENCIA        NUMBER:=0;
VL_DIA              NUMBER;
VL_MES              NUMBER;
VL_ANO              NUMBER;
VL_PERIODO          VARCHAR2(7);
VL_ERROR            VARCHAR2(700);
VL_VENCIMIENTO      DATE;
VL_PROCESO          VARCHAR2(5);

 BEGIN
    FOR X IN (
                 SELECT*
                   FROM TZTBESP
                  WHERE     1=1
                        AND TZTBESP_CHECK IS NULL
    )LOOP

            BEGIN
              SELECT COUNT(*)
              INTO VL_ENTRA
              FROM TZTBESP
              WHERE TZTBESP_PIDM = X.TZTBESP_PIDM
              AND TZTBESP_CHECK IS NULL;
            END;

            BEGIN
              SELECT DISTINCT SGBSTDN_STST_CODE,TRUNC(SGBSTDN_ACTIVITY_DATE)
              INTO VL_ESTATUS,VL_FECHA_ESTATUS
              FROM SGBSTDN A
              WHERE A.SGBSTDN_PIDM =X.TZTBESP_PIDM
              AND A.SGBSTDN_TERM_CODE_EFF = ( SELECT MAX(SGBSTDN_TERM_CODE_EFF)
                                              FROM SGBSTDN
                                              WHERE SGBSTDN_PIDM = A.SGBSTDN_PIDM);
            EXCEPTION
            WHEN OTHERS THEN
            VL_ESTATUS:=NULL;
            END;

            BEGIN
              SELECT TZTBESP_PROC
              INTO VL_PROCESO
              FROM TZTBESP
              WHERE TZTBESP_PIDM =X.TZTBESP_PIDM
              AND TZTBESP_CHECK IS NULL;
            EXCEPTION
            WHEN OTHERS THEN
            VL_PROCESO:=NULL;
            END;

            BEGIN
                SELECT ZSTPARA_PARAM_VALOR
                  INTO VL_MES_AVANCE
                  FROM ZSTPARA
                 WHERE     1=1
                       AND ZSTPARA_MAPA_ID = 'PARA_BCSP'
                       AND ZSTPARA_PARAM_ID = VL_PROCESO||'_MES'
                       ;
            EXCEPTION
            WHEN OTHERS THEN
            VL_ERROR:='ERROR AL ENCONTRAR EL CODIGO'||SQLERRM;
            END;

            IF VL_ENTRA != 0 THEN

               IF VL_ESTATUS = 'EG' THEN


                    BEGIN
                      SELECT TO_CHAR(TBRACCD_EFFECTIVE_DATE,'DD'),TBRACCD_TERM_CODE
                        INTO VL_DIA,VL_PERIODO
                        FROM TBRACCD A
                       WHERE A.TBRACCD_PIDM =X.TZTBESP_PIDM
                       AND A.TBRACCD_TRAN_NUMBER = (SELECT MAX(TBRACCD_TRAN_NUMBER)
                                                    FROM TBRACCD,TBBDETC
                                                   WHERE 1=1
                                                         AND TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
                                                         AND TBBDETC_DCAT_CODE IN ('COL')
                                                         AND TBBDETC_DESC LIKE 'COLEGIATURA%'
                                                         AND TBBDETC_DESC != 'COLEGIATURA EXTRAORDINARIO'
                                                         AND TBRACCD_PIDM = A.TBRACCD_PIDM);
                    EXCEPTION
                    WHEN OTHERS THEN
                    VL_ERROR:='ERROR AL CALCULAR DIA = '||SQLERRM;
                    END;

                    VL_MES :=SUBSTR (TO_CHAR(ADD_MONTHS(VL_FECHA_ESTATUS,VL_MES_AVANCE)/*PARC.fecha_inicio*/, 'dd/mm/rrrr'), 4, 2);
                    VL_ANO :=SUBSTR (TO_CHAR(ADD_MONTHS(VL_FECHA_ESTATUS,VL_MES_AVANCE)/*PARC.fecha_inicio*/, 'dd/mm/rrrr'), 7, 4);


                    IF VL_DIA = '30' THEN
                      VL_VENCIMIENTO := TO_DATE(CASE LPAD(VL_MES,2,'0') WHEN '02' THEN '28' ELSE VL_DIA END||'/'||LPAD(VL_MES,2,'0')||'/'||VL_ANO,'DD/MM/YYYY');
                    ELSE
                      VL_VENCIMIENTO := TO_DATE(VL_DIA||'/'||LPAD(VL_MES,2,'0')||'/'||VL_ANO);
                    END IF;

                     BEGIN
                        FOR PARC IN (

                                        SELECT*
                                        FROM TZTBESP
                                        WHERE TZTBESP_PIDM =X.TZTBESP_PIDM

                         )LOOP

                            BEGIN
                                FOR I IN 1..PARC.TZTBESP_PAG
                                LOOP

                                    BEGIN
                                      SELECT MAX(TBRACCD_TRAN_NUMBER)+1
                                      INTO VL_SECUENCIA
                                      FROM TBRACCD
                                      WHERE TBRACCD_PIDM =X.TZTBESP_PIDM;
                                    EXCEPTION
                                    WHEN OTHERS THEN
                                    VL_ERROR:= 'ERROR EN SECUENCIA = '||SQLERRM;
                                    END;


                                     BEGIN
                                         INSERT
                                           INTO TBRACCD
                                         VALUES
                                               (PARC.TZTBESP_PIDM,   -- TBRACCD_PIDM
                                                VL_SECUENCIA,     --TBRACCD_TRAN_NUMBER
                                                VL_PERIODO,    -- TBRACCD_TERM_CODE
                                                PARC.TZTBESP_DETAIL_CODE,     ---TBRACCD_DETAIL_CODE
                                                USER,     ---TBRACCD_USER
                                                SYSDATE,     --TBRACCD_ENTRY_DATE
                                                PARC.TZTBESP_AMOUNT,
                                                PARC.TZTBESP_AMOUNT,    ---TBRACCD_BALANCE
                                                VL_VENCIMIENTO,     -- TBRACCD_EFFECTIVE_DATE
                                                NULL,    --TBRACCD_BILL_DATE
                                                NULL,    --TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                                                PARC.TZTBESP_DESC,    -- TBRACCD_DESC
                                                NULL,     --TBRACCD_RECEIPT_NUMBER
                                                NULL,     --TBRACCD_TRAN_NUMBER_PAID
                                                NULL,     --TBRACCD_CROSSREF_PIDM
                                                NULL,    --TBRACCD_CROSSREF_NUMBER
                                                NULL,       --TBRACCD_CROSSREF_DETAIL_CODE
                                                'T',    --TBRACCD_SRCE_CODE
                                                'Y',    --TBRACCD_ACCT_FEED_IND
                                                SYSDATE,  --TBRACCD_ACTIVITY_DATE
                                                0,        --TBRACCD_SESSION_NUMBER
                                                NULL,    -- TBRACCD_CSHR_END_DATE
                                                NULL,     --TBRACCD_CRN
                                                NULL,     --TBRACCD_CROSSREF_SRCE_CODE
                                                NULL,     -- TBRACCD_LOC_MDT
                                                NULL,     --TBRACCD_LOC_MDT_SEQ
                                                NULL,     -- TBRACCD_RATE
                                                NULL,     --TBRACCD_UNITS
                                                'BCSP',     -- TBRACCD_DOCUMENT_NUMBER
                                                VL_VENCIMIENTO,  -- TBRACCD_TRANS_DATE
                                                NULL,        -- TBRACCD_PAYMENT_ID
                                                NULL,     -- TBRACCD_INVOICE_NUMBER
                                                NULL,     -- TBRACCD_STATEMENT_DATE
                                                NULL,     -- TBRACCD_INV_NUMBER_PAID
                                                'MXN',     -- TBRACCD_CURR_CODE
                                                NULL,     -- TBRACCD_EXCHANGE_DIFF   ----------******* Se gurada la referencia del cargo
                                                NULL,    -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                                                NULL,     -- TBRACCD_LATE_DCAT_CODE
                                                NULL,     -- TBRACCD_FEED_DATE
                                                NULL,     -- TBRACCD_FEED_DOC_CODE
                                                NULL,     -- TBRACCD_ATYP_CODE
                                                NULL,     -- TBRACCD_ATYP_SEQNO
                                                NULL,     -- TBRACCD_CARD_TYPE_VR
                                                NULL,     -- TBRACCD_CARD_EXP_DATE_VR
                                                NULL,     -- TBRACCD_CARD_AUTH_NUMBER_VR
                                                NULL,     -- TBRACCD_CROSSREF_DCAT_CODE
                                                NULL,     -- TBRACCD_ORIG_CHG_IND
                                                NULL,     -- TBRACCD_CCRD_CODE
                                                NULL,     -- TBRACCD_MERCHANT_ID
                                                NULL,     -- TBRACCD_TAX_REPT_YEAR
                                                NULL,     -- TBRACCD_TAX_REPT_BOX
                                                NULL,     -- TBRACCD_TAX_AMOUNT
                                                NULL,     -- TBRACCD_TAX_FUTURE_IND
                                                'BCSP',     -- TBRACCD_DATA_ORIGIN
                                                'BCSP',   -- TBRACCD_CREATE_SOURCE
                                                NULL,     -- TBRACCD_CPDT_IND
                                                NULL,     --TBRACCD_AIDY_CODE
                                                NULL,     --TBRACCD_STSP_KEY_SEQUENCE
                                                NULL,     --TBRACCD_PERIOD
                                                NULL,    --TBRACCD_SURROGATE_ID
                                                NULL,     -- TBRACCD_VERSION
                                                USER,     --TBRACCD_USER_ID
                                                NULL );     --TBRACCD_VPDI_CODE

                                     EXCEPTION
                                     WHEN OTHERS THEN
                                     VL_ERROR:= 'ERROR AL INSERTAR TBRACCD 1 = '||SQLERRM;
                                     END;

                                     VL_VENCIMIENTO:= LAST_DAY(ADD_MONTHS(VL_VENCIMIENTO,1));

                                     IF TO_CHAR(VL_VENCIMIENTO,'DD') = 31 THEN
                                       VL_VENCIMIENTO:=VL_VENCIMIENTO-1;
                                     END IF;

                                END LOOP;

                            END;

                         END LOOP;

                        IF VL_ERROR IS NULL THEN

                            UPDATE TZTBESP
                               SET TZTBESP_CHECK = 1
                             WHERE TZTBESP_PIDM =X.TZTBESP_PIDM
                              AND TZTBESP_CHECK IS NULL;
                        END IF;

                     END;


               END IF;

            END IF;

    END LOOP;

  COMMIT;

 END P_PAQT_ESPECIAL;

PROCEDURE P_INSERTA_COMPLE ( P_PIDM           NUMBER,
                             P_PERIODO        VARCHAR2,
                             P_MONTO          NUMBER,
                             P_DETAIL_CODE    VARCHAR2,
                             P_DETAIL_DESC    VARCHAR2,
                             P_VIGENCIA       NUMBER,
                             P_VIGENCIA_REG   NUMBER,
                             P_PROGRAMA       VARCHAR2,
                             P_STUDY_PATH     NUMBER
                              ) IS
/*
PROCESO PARA GENERAR EL ACCESORIO COMPLEMENTO DE COLEGIATURA EN LA TABLA TEMPORAL TZFACCE
 se agrega validacion para nuevo código adicional a complemento
AUTOR:  JREZAOLI
ACTUALIZADO:    20/07/2021

*/

V_MONEDA            VARCHAR2(10);
VL_MES              NUMBER:=0;
VL_ANO              NUMBER:=0;
VL_VENCIMIENTO      VARCHAR2(10);
VL_VIGENCIA         NUMBER;
LV_TRAN_NUM_2       NUMBER;
VL_VIGENCIA_PARA    VARCHAR2(4);
VL_PROPEDEUTICO     VARCHAR (2);
LV_TRAN_NUM         NUMBER;
VL_ERROR            VARCHAR2(250):= 'EXITO';
VL_COMPLE_MES       NUMBER;
VL_ACCESORIO        NUMBER;
VL_COMPLE_INICIO    NUMBER;
VL_CPM              NUMBER;
vl_sp               NUMBER;
vl_inicio           date;
vl_campus           varchar2(5):= null;
vl_nivel            varchar2(5):= null;


 BEGIN


   --------------- Valida que no tenga cargos de complemento pendientes por aplicar ------------------

--
--   BEGIN
--     SELECT COUNT(*)
--       INTO VL_ACCESORIO
--       FROM TZFACCE
--      WHERE TZFACCE_PIDM = P_PIDM
--            AND TZFACCE_FLAG = 0
--            AND TZFACCE_DETAIL_CODE = P_DETAIL_CODE;
--   EXCEPTION
--   WHEN OTHERS THEN
--   VL_ACCESORIO:=0;
--   END;
--
--
--
--   IF VL_ACCESORIO > 0 THEN
--
--      BEGIN
--         UPDATE TZFACCE
--            SET TZFACCE_FLAG = 1
--          WHERE     TZFACCE_PIDM = P_PIDM
--                AND TZFACCE_FLAG = 0
--                AND TZFACCE_DETAIL_CODE= P_DETAIL_CODE;
--      END;
--
--   END IF;


--    --------- Se igual a la vigencia del parametro que se agrego
    VL_VIGENCIA_PARA :=P_VIGENCIA_REG;


   -----------------------------Se obtiene la fecha de inicio del plan de estudios---------------------------------------

    Begin
      SELECT trunc (SORLCUR_START_DATE), sorlcur_camp_code, sorlcur_levl_code
                Into vl_inicio, vl_campus, vl_nivel
           FROM SORLCUR A
           WHERE     1=1
                 AND A.SORLCUR_PIDM = P_PIDM
                 AND A.SORLCUR_LMOD_CODE = 'LEARNER'
                 AND A.SORLCUR_ROLL_IND  = 'Y'
                 AND A.SORLCUR_CACT_CODE = 'ACTIVE'
                 AND A.SORLCUR_PRIORITY_NO != 99
                 And A.SORLCUR_PROGRAM = P_PROGRAMA
                 AND A.SORLCUR_SEQNO IN (SELECT MAX (A1.SORLCUR_SEQNO)
                                           FROM SORLCUR A1
                                          WHERE     A1.SORLCUR_PIDM = A.SORLCUR_PIDM
                                                AND A1.SORLCUR_ROLL_IND  = A.SORLCUR_ROLL_IND
                                                AND A1.SORLCUR_CACT_CODE = A.SORLCUR_CACT_CODE
                                                AND A1.SORLCUR_PRIORITY_NO != 99
                                                AND A1.SORLCUR_LMOD_CODE = A.SORLCUR_LMOD_CODE) ;
    Exception
        When Others then
            vl_inicio:= null;
            vl_campus:= null;
            vl_nivel := null;
    End;


  --  DBMS_OUTPUT.PUT_LINE(' Obtiene Fechas = '||vl_inicio||'*'|| vl_campus||'*'|| vl_nivel);


            ------------------- Adiciona el numero de meses al ultimo registro encontrado en la tabla  de FACCE -----------------
    Begin
            select ADD_MONTHS(TZFACCE_EFFECTIVE_DATE,VL_VIGENCIA_PARA), TZFACCE_STUDY
                Into VL_VENCIMIENTO, vl_sp
            from TZFACCE a
            where 1=1
            and  a.TZFACCE_PIDM= P_PIDM
            and  TZFACCE_DETAIL_CODE in (select CODIGO
                                           from TZTINC
                                           Where CAMPUS = vl_campus
                                           And NIVEL = vl_nivel)
            and a.TZFACCE_SEC_PIDM = (select max (a1.TZFACCE_SEC_PIDM)
                                                   from    TZFACCE a1
                                                   Where  a.TZFACCE_PIDM = a1.TZFACCE_PIDM
                                                   and  a.TZFACCE_DETAIL_CODE = a1.TZFACCE_DETAIL_CODE
                                                   )
           And trunc (a.TZFACCE_EFFECTIVE_DATE ) < vl_inicio;
    Exception
    When Others then
        VL_VENCIMIENTO:= null;
        vl_sp := NULL;
    End;


    If VL_VENCIMIENTO <= vl_inicio then

        Select ADD_MONTHS(VL_VENCIMIENTO,VL_VIGENCIA_PARA)
            Into VL_VENCIMIENTO
        from dual;

    End if;


   -- DBMS_OUTPUT.PUT_LINE(' Obtiene Vencimiento = '||VL_VENCIMIENTO||'*'|| vl_sp);

    If VL_VENCIMIENTO is not null then

          --  DBMS_OUTPUT.PUT_LINE(' Entra por Vencimeinto');

            BEGIN
                    SELECT  NVL(MAX (TZFACCE_SEC_PIDM),0)+1
                    INTO  LV_TRAN_NUM_2
                    FROM  TZFACCE
                    WHERE TZFACCE_PIDM = P_PIDM;
            EXCEPTION
            WHEN OTHERS  THEN
            LV_TRAN_NUM_2 := 1;
            END;

            BEGIN
                 SELECT NVL(MAX (TBRACCD_TRAN_NUMBER),0)  +1
                 INTO  LV_TRAN_NUM
                 FROM  TBRACCD
                 WHERE TBRACCD_PIDM = P_PIDM;

            EXCEPTION
            WHEN OTHERS  THEN
            LV_TRAN_NUM := 1;
            END;

            VL_ACCESORIO:=0;

            BEGIN
             SELECT COUNT(*)
               INTO VL_ACCESORIO
               FROM TZFACCE
              WHERE TZFACCE_PIDM = P_PIDM
                    AND TZFACCE_FLAG = 0
                    AND TZFACCE_DETAIL_CODE = P_DETAIL_CODE
                    And trunc (TZFACCE_EFFECTIVE_DATE) = TO_DATE(VL_VENCIMIENTO,'DD/MM/RRRR');
            EXCEPTION
            WHEN OTHERS THEN
            VL_ACCESORIO:=0;
            END;

          --  DBMS_OUTPUT.PUT_LINE(' Valida Exista el accesorio '||VL_ACCESORIO||'*'||P_DETAIL_CODE||'*'||TO_DATE(VL_VENCIMIENTO,'DD/MM/RRRR'));

            If VL_ACCESORIO = 0 then

                DBMS_OUTPUT.PUT_LINE(' Entra por Accesorio 0');

                    BEGIN
                       INSERT INTO TZFACCE
                       VALUES (P_PIDM,                                 --TZFACCE_PIDM
                               LV_TRAN_NUM_2,                          --TZFACCE_SEC_PIDM
                               P_PERIODO,                              --TZFACCE_TERM_CODE
                               P_DETAIL_CODE,                          --TZFACCE_DETAIL_CODE
                               P_DETAIL_DESC,                          --TZFACCE_DESC
                               P_MONTO,                                --TZFACCE_AMOUNT
                               TO_DATE(VL_VENCIMIENTO,'DD/MM/RRRR'),   --TZFACCE_EFFECTIVE_DATE
                               'REZA',                                 --TZFACCE_USER
                               SYSDATE,                                --TZFACCE_ACTIVITY_DATE
                               0,                                      --TZFACCE_FLAG
                               P_STUDY_PATH);

                    EXCEPTION
                      WHEN OTHERS THEN
                          VL_ERROR:= 'ERROR INSERTAR TZFACCE'||SQLERRM;
                          DBMS_OUTPUT.PUT_LINE(' Entrar para insertar  TZFACCE_1  = '||VL_ERROR);
                    END;

            End if;

    Else

     --   DBMS_OUTPUT.PUT_LINE(' Llega por el ELSE');

            BEGIN
              FOR C IN (

                  SELECT EXTRACT(MONTH FROM SORLCUR_START_DATE)MES,
                         EXTRACT(YEAR FROM SORLCUR_START_DATE)ANO,
                         (DECODE (SUBSTR (SORLCUR_RATE_CODE, 4, 1), 'A', 15, 'B', '30', 'C', '10'))VIGENCIA,
                         SORLCUR_PROGRAM,
                         SORLCUR_START_DATE,
                         SORLCUR_KEY_SEQNO STUDY,
                         SORLCUR_CAMP_CODE CAMPUS,
                         SORLCUR_LEVL_CODE NIVEL,
                         SORLCUR_APPL_KEY_SEQNO SOLI
                   FROM SORLCUR A
                   WHERE     1=1
                         AND A.SORLCUR_PIDM = P_PIDM
                         AND A.SORLCUR_LMOD_CODE = 'LEARNER'
                         AND A.SORLCUR_ROLL_IND  = 'Y'
                         AND A.SORLCUR_CACT_CODE = 'ACTIVE'
                         AND A.SORLCUR_PRIORITY_NO != 99
                         And A.SORLCUR_PROGRAM = P_PROGRAMA
                         AND A.SORLCUR_SEQNO IN (SELECT MAX (A1.SORLCUR_SEQNO)
                                                   FROM SORLCUR A1
                                                  WHERE     A1.SORLCUR_PIDM = A.SORLCUR_PIDM
                                                        AND A1.SORLCUR_ROLL_IND  = A.SORLCUR_ROLL_IND
                                                        AND A1.SORLCUR_CACT_CODE = A.SORLCUR_CACT_CODE
                                                      --  AND A1.SORLCUR_PROGRAM = A.SORLCUR_PROGRAM
                                                        AND A1.SORLCUR_PRIORITY_NO != 99
                                                        AND A1.SORLCUR_LMOD_CODE = A.SORLCUR_LMOD_CODE)

               )LOOP

                   IF VL_VIGENCIA_PARA IS NULL THEN

                     VL_MES:= C.MES+((P_VIGENCIA)-1);
                     VL_ANO:= C.ANO;
                     VL_VIGENCIA:= C.VIGENCIA;

                   ELSE



                --    DBMS_OUTPUT.PUT_LINE('INICIA CON LA VIGENCIA = '||VL_VIGENCIA_PARA);

                       IF VL_VIGENCIA_PARA IS NULL THEN

                             VL_MES:= C.MES+((P_VIGENCIA)-1);
                             VL_ANO:= C.ANO;
                             VL_VIGENCIA:= C.VIGENCIA;

                    --         DBMS_OUTPUT.PUT_LINE('VALORES INICIALES = '||VL_MES||'*'||C.MES||'*'|| P_VIGENCIA );
                     --        DBMS_OUTPUT.PUT_LINE('VALORES INICIALES = '||VL_ANO||'*'||C.ANO||'*'|| P_VIGENCIA );

                       ELSE

                             VL_MES:= C.MES+((VL_VIGENCIA_PARA)-1);
                             VL_ANO:= C.ANO;
                             VL_VIGENCIA:= C.VIGENCIA;

--                             DBMS_OUTPUT.PUT_LINE(' ENTRA POR EL ELSE ' );
--                              DBMS_OUTPUT.PUT_LINE('VALORES INICIALES = '||VL_MES||'*'||C.MES||'*'|| P_VIGENCIA );
--                             DBMS_OUTPUT.PUT_LINE('VALORES INICIALES = '||VL_ANO||'*'||C.ANO||'*'|| P_VIGENCIA );

                       END IF;

                   END IF;

                  --  DBMS_OUTPUT.PUT_LINE('fecha_inicio = '||c.SORLCUR_START_DATE);

                   IF TO_NUMBER(TO_CHAR(C.SORLCUR_START_DATE,'dd')) >= 20 THEN
                                     -- DBMS_OUTPUT.PUT_LINE('VIG ANTES = '||VL_MES);
                   VL_MES:= VL_MES+1;

                                     --  DBMS_OUTPUT.PUT_LINE('VIG DESPUES = '||VL_MES);

                   END IF;


                   BEGIN

                       SELECT SZTPTRM_PROPEDEUTICO
                       INTO VL_PROPEDEUTICO
                       FROM SZTPTRM A
                       WHERE A.SZTPTRM_PROGRAM = C.SORLCUR_PROGRAM
                       AND A.SZTPTRM_TERM_CODE  = P_PERIODO
                       AND A.SZTPTRM_PTRM_CODE IN (SELECT SOBPTRM_PTRM_CODE
                                                   FROM SOBPTRM
                                                   WHERE SOBPTRM_TERM_CODE = A.SZTPTRM_TERM_CODE
                                                   AND  SOBPTRM_START_DATE = C.SORLCUR_START_DATE );

                   EXCEPTION
                   WHEN OTHERS THEN
                   VL_PROPEDEUTICO := 0;
                   END;

                   IF VL_PROPEDEUTICO >= 1 THEN
                    VL_MES:= (VL_MES)+1;
                   END IF;

                   BEGIN

                       IF VL_MES = '13' THEN VL_MES := '01';VL_ANO := VL_ANO +1;END IF;

                       IF VL_MES = '14' THEN VL_MES := '02';VL_ANO := VL_ANO +1;END IF;

                       IF VL_MES = '15' THEN VL_MES := '03';VL_ANO := VL_ANO +1;END IF;

                       IF VL_MES = '16' THEN VL_MES := '04';VL_ANO := VL_ANO +1;END IF;

                       IF VL_MES = '17' THEN VL_MES := '05';VL_ANO := VL_ANO +1;END IF;

                       IF VL_MES = '18' THEN VL_MES := '06';VL_ANO := VL_ANO +1;END IF;

                       IF VL_MES = '19' THEN VL_MES := '07';VL_ANO := VL_ANO +1;END IF;

                       IF VL_MES = '20' THEN VL_MES := '08';VL_ANO := VL_ANO +1;END IF;

                       IF VL_MES = '21' THEN VL_MES := '09';VL_ANO := VL_ANO +1;END IF;

                       IF VL_MES = '22' THEN VL_MES := '10';VL_ANO := VL_ANO +1;END IF;

                       IF VL_MES = '23' THEN VL_MES := '11';VL_ANO := VL_ANO +1;END IF;

                       IF VL_MES = '24' THEN VL_MES := '12';VL_ANO := VL_ANO +1;END IF;

                   EXCEPTION
                   WHEN OTHERS THEN
                   RAISE_APPLICATION_ERROR (-20002,'Contando 4 <>'||SQLERRM);
                   END;

                   VL_VENCIMIENTO := VL_VIGENCIA||'/'||VL_MES||'/'||VL_ANO;

                   IF VL_MES = 2 AND VL_VIGENCIA = 30 THEN
                    VL_VENCIMIENTO := '27/'||VL_MES||'/'||VL_ANO;
                   END IF;

                --   DBMS_OUTPUT.PUT_LINE('VIG FINAL = '||VL_VENCIMIENTO);

                   BEGIN
                         SELECT NVL(MAX (TBRACCD_TRAN_NUMBER),0)  +1
                         INTO  LV_TRAN_NUM
                         FROM  TBRACCD
                         WHERE TBRACCD_PIDM = P_PIDM;

                   EXCEPTION
                   WHEN OTHERS  THEN
                   LV_TRAN_NUM := 1;
                   END;

                 --  DBMS_OUTPUT.PUT_LINE('LV_TRAN_NUM = '||LV_TRAN_NUM);

                   IF  V_MONEDA  IS NULL  THEN

                     BEGIN

                       SELECT TVRDCTX_CURR_CODE
                       INTO V_MONEDA
                       FROM TAISMGR.TVRDCTX
                       WHERE TVRDCTX_DETC_CODE  = P_DETAIL_CODE;

                     EXCEPTION
                     WHEN OTHERS THEN
                     V_MONEDA  := 'MXN';
                     END;

                   END IF;

                   IF LV_TRAN_NUM <> 0 THEN
                 --   DBMS_OUTPUT.PUT_LINE(' Entra LV_TRAN_NUM = '||LV_TRAN_NUM);

                       IF  VL_VIGENCIA_PARA IS NULL THEN

                           null;

                       ELSE
                             --   DBMS_OUTPUT.PUT_LINE(' Entra por el flujo del ELSE = '||VL_VIGENCIA_PARA);

                          VL_MES           := NULL;


                           IF TO_NUMBER(TO_CHAR(C.SORLCUR_START_DATE,'dd')) >= 20 THEN

                                VL_COMPLE_MES := TO_NUMBER(TO_CHAR(TO_DATE(C.SORLCUR_START_DATE),'MM'))+1;
                              --  DBMS_OUTPUT.PUT_LINE(' entre por VL_COMPLE_MES  = '||VL_COMPLE_MES);

                           ELSE

                                 VL_COMPLE_MES := TO_NUMBER(TO_CHAR(TO_DATE(C.SORLCUR_START_DATE),'MM'));
                                --  DBMS_OUTPUT.PUT_LINE(' entre else por VL_COMPLE_MES  = '||VL_COMPLE_MES);

                           END IF;

                           IF TO_NUMBER(TO_CHAR(C.SORLCUR_START_DATE,'dd')) between 15 and 19
                               AND VL_VIGENCIA_PARA IS NOT NULL
                               AND C.CAMPUS = 'UTL'
                               AND C.NIVEL = 'LI'THEN

                               VL_COMPLE_MES:= VL_COMPLE_MES+1;

                           END IF;

                          -- DBMS_OUTPUT.PUT_LINE('VIG FINAL PARTE 2 = '||VL_COMPLE_MES);

                           BEGIN

                               SELECT ZSTPARA_PARAM_VALOR
                               INTO VL_MES
                               FROM ZSTPARA
                               WHERE ZSTPARA_MAPA_ID = 'COMPL_MES'
                               AND ZSTPARA_PARAM_SEC = VL_COMPLE_MES
                               ;

                           EXCEPTION
                           WHEN OTHERS THEN
                           NULL;
                           END;

                         --  DBMS_OUTPUT.PUT_LINE('VL_MES = '||VL_MES);

                           IF VL_VIGENCIA_PARA IS NOT NULL AND C.NIVEL = 'LI' THEN
                          -- DBMS_OUTPUT.PUT_LINE('Vigencia_para = '||VL_VIGENCIA_PARA);

                             IF C.MES IN (11,12) THEN
                               VL_VENCIMIENTO := VL_VIGENCIA||'/'||VL_MES||'/'||(C.ANO+1);
                           --    DBMS_OUTPUT.PUT_LINE('Vencimiento_1 = '||VL_VENCIMIENTO);
                             ELSE
                               VL_VENCIMIENTO := VL_VIGENCIA||'/'||VL_MES||'/'||C.ANO;
                           --    DBMS_OUTPUT.PUT_LINE('Vencimiento_2 = '||VL_VENCIMIENTO);

                             END IF;

                           ELSE

                            VL_VENCIMIENTO := VL_VENCIMIENTO;
                         --   DBMS_OUTPUT.PUT_LINE('Vencimiento_3 = '||VL_VENCIMIENTO);

                           END IF;



                           BEGIN
                             SELECT  NVL(MAX (TZFACCE_SEC_PIDM),0)+1
                               INTO  LV_TRAN_NUM_2
                               FROM  TZFACCE
                              WHERE TZFACCE_PIDM = P_PIDM;

                           EXCEPTION
                           WHEN OTHERS  THEN
                           LV_TRAN_NUM_2 := 1;
                           END;


                      --  DBMS_OUTPUT.PUT_LINE('LV_TRAN_NUM_2 = '||LV_TRAN_NUM_2);

                           BEGIN
                             SELECT COUNT(*)
                               INTO VL_COMPLE_INICIO
                               FROM ZSTPARA
                              WHERE     ZSTPARA_MAPA_ID = 'COM_PRIMES'
                                    AND ZSTPARA_PARAM_ID = C.CAMPUS||C.NIVEL ;
                           END;

                         --  DBMS_OUTPUT.PUT_LINE('VL_COMPLE_INICIO = '||VL_COMPLE_INICIO);

                           IF VL_COMPLE_INICIO = 0 THEN
                             VL_CPM:=1;
                         --    DBMS_OUTPUT.PUT_LINE('VL_CPM = '||VL_CPM);
                           ELSE

                             BEGIN
                               SELECT COUNT(*)
                                 INTO VL_CPM
                                 FROM GORADID
                                WHERE     GORADID_PIDM = P_PIDM
                                      AND GORADID_ADID_CODE = 'UAGM';
                             END;
                           --    DBMS_OUTPUT.PUT_LINE('ELSE VL_CPM = '||VL_CPM);

                             IF VL_CPM = 0 THEN
                               VL_CPM:= 1;
                            --   DBMS_OUTPUT.PUT_LINE('IF NUEVO VL_CPM = '||VL_CPM);
                                   IF C.CAMPUS != 'USA' THEN

                                     IF TO_NUMBER(TO_CHAR(C.SORLCUR_START_DATE,'dd')) >= 20 THEN
                                       VL_MES := TO_NUMBER(TO_CHAR(TO_DATE(C.SORLCUR_START_DATE),'MM'))+1;
                                     ELSE
                                      VL_MES := TO_NUMBER(TO_CHAR(TO_DATE(C.SORLCUR_START_DATE),'MM'));
                                     END IF;

                                     VL_VENCIMIENTO := VL_VIGENCIA||'/'||VL_MES||'/'||C.ANO;
                                 --       DBMS_OUTPUT.PUT_LINE('IF CAMPUS USA = '||VL_VENCIMIENTO);

                                   END IF;

                             ELSE

                            --    DBMS_OUTPUT.PUT_LINE('IF CAMPUS USA = '||VL_VENCIMIENTO);

                                   IF TO_NUMBER(TO_CHAR(C.SORLCUR_START_DATE,'dd')) >= 20 THEN

                                     VL_MES := TO_NUMBER(TO_CHAR(TO_DATE(C.SORLCUR_START_DATE),'MM'))+1;

                                   ELSE

                                     VL_MES := TO_NUMBER(TO_CHAR(TO_DATE(C.SORLCUR_START_DATE),'MM'));

                                   END IF;

                                 VL_VENCIMIENTO := VL_VIGENCIA||'/'||VL_MES||'/'||C.ANO;
                               --  DBMS_OUTPUT.PUT_LINE('VL_VENCIMIENTO ESTADOS UNIDOS *********** = '||VL_VENCIMIENTO);
                             END IF;

                           END IF;

                     --   DBMS_OUTPUT.PUT_LINE('Entra VL_CPM > 0 '||VL_CPM);

                           IF VL_CPM > 0 THEN

                                    VL_ACCESORIO:=0;

                                    BEGIN
                                     SELECT COUNT(*)
                                       INTO VL_ACCESORIO
                                       FROM TZFACCE
                                      WHERE TZFACCE_PIDM = P_PIDM
                                            AND TZFACCE_FLAG = 0
                                            AND TZFACCE_DETAIL_CODE = P_DETAIL_CODE
                                            And trunc (TZFACCE_EFFECTIVE_DATE) = TO_DATE(VL_VENCIMIENTO,'DD/MM/RRRR');
                                    EXCEPTION
                                    WHEN OTHERS THEN
                                    VL_ACCESORIO:=0;
                                    END;

                                    If VL_ACCESORIO = 0 then

                                           BEGIN
                                             INSERT
                                               INTO TZFACCE
                                             VALUES  (P_PIDM,                                --TZFACCE_PIDM
                                                      LV_TRAN_NUM_2,                         --TZFACCE_SEC_PIDM
                                                      P_PERIODO,                             --TZFACCE_TERM_CODE
                                                      P_DETAIL_CODE,                         --TZFACCE_DETAIL_CODE
                                                      P_DETAIL_DESC,                         --TZFACCE_DESC
                                                      P_MONTO,                               --TZFACCE_AMOUNT
                                                      TO_DATE(VL_VENCIMIENTO,'DD/MM/RRRR'),  --TZFACCE_EFFECTIVE_DATE
                                                      'REZA',                                --TZFACCE_USER
                                                      SYSDATE,                               --TZFACCE_ACTIVITY_DATE
                                                      0,                                     --TZFACCE_FLAG
                                                      P_STUDY_PATH);
                                           EXCEPTION
                                           WHEN OTHERS THEN
                                           VL_ERROR:= 'ERROR INSERTAR TZFACCE'||SQLERRM;
                                        --   DBMS_OUTPUT.PUT_LINE('Entra ERROR VL_CPM > 0 '||VL_ERROR);
                                           END;

                                    End if;

                           END IF;


                       END IF;
                   END IF;
               END LOOP;
            END;

    End if;
   COMMIT;
 END P_INSERTA_COMPLE;

  FUNCTION F_CARTERA_UTEL_X  (P_MATRICULA IN VARCHAR2)RETURN VARCHAR2 IS

VL_MENBRESIA              NUMBER;
VL_FECHA_COL              NUMBER;
VL_FECHA_CORR             NUMBER;
VL_VITACORA               NUMBER;


VL_PARCIALIDADES        NUMBER;
VL_CODIGO               VARCHAR2(10);
VL_DESCRIPCION          VARCHAR2(50);
VL_MONTO                NUMBER;
VL_SFRRGFE_RATE_CODE    VARCHAR2(5);
VL_CODIGO_DESC          VARCHAR2(5);
VL_DESCRIPCION_DESC     VARCHAR2(50);
VL_CODIGO_AFEC          VARCHAR2(5);
VL_MONTO_PERCENT        NUMBER;
VL_MONTO_AMOUNT         NUMBER;
VL_DESCUENTO            NUMBER;
VL_DESCUENTODSI         NUMBER;
VL_CODIGO_DSI           VARCHAR2(5);
VL_DESCRIPCION_DSI      VARCHAR2(50);
VL_CODIGO_PLP           VARCHAR2(50);
VL_DESCRIPCION_PLP      VARCHAR2(50);
VL_SECUENCIA            NUMBER;
VL_SECUENCIACOL         NUMBER;
VL_PLAN_PAGO            NUMBER;
VL_ULT_COL              NUMBER;
VL_CODIGO_PAR           VARCHAR2(5);
VL_DESCRIPCION_PAR      VARCHAR2(50);
VL_DIA                  VARCHAR2(2);
VL_MES                  VARCHAR2(2);
VL_ANO                  VARCHAR2(4);
VL_VENCIMIENTO          VARCHAR2(15);
VL_DOCTR                NUMBER;
VL_SECUEN               NUMBER;
VL_ERROR                VARCHAR2(500);
V_ENTRA                 NUMBER;
VL_ESTATUS              VARCHAR2(500);
VL_IND                  NUMBER;
VL_UTELX_ENTRA          NUMBER;
VL_COD_UTLX             VARCHAR2(5);
VL_DESCRIPCION_UTLX     VARCHAR2(50);
VL_MONTO_UTLX           NUMBER;
VL_MONTO_AJUSTE_UTLX    NUMBER;
VL_COD_DESC_UTLX        VARCHAR2(5);
VL_DESCUENTO_DESC_UTLX  VARCHAR2(50);
VL_SEC_CARGO            NUMBER;


 BEGIN
   FOR ALUMNO IN (

                   SELECT DISTINCT
                          D.SPRIDEN_ID MATRICULA,
                          A.SORLCUR_PIDM PIDM,
                          A.SORLCUR_PROGRAM PROGRAMA,
                          E.SZTDTEC_PROGRAMA_COMP PROGRAMA_DESC,
                          B.SGBSTDN_STST_CODE ESTATUS,
                          B.SGBSTDN_STYP_CODE TIPO_ALUMNO,
                          B.SGBSTDN_CAMP_CODE CAMPUS,
                          B.SGBSTDN_LEVL_CODE NIVEL,
                          B.SGBSTDN_TERM_CODE_EFF PERIODO,
                          A.SORLCUR_START_DATE FECHA_INICIO,
                          A.SORLCUR_VPDI_CODE PARTE_PERIODO,
                          A.SORLCUR_KEY_SEQNO STUDY_PATH,
                          CASE SUBSTR (B.SGBSTDN_RATE_CODE, 1, 1)
                              WHEN  ('P') THEN SUBSTR (B.SGBSTDN_RATE_CODE, 2, 2)
                              WHEN  ('C') THEN SUBSTR (B.SGBSTDN_RATE_CODE, 3, 1)-- Se agrega
                              WHEN  ('J') THEN SUBSTR (B.SGBSTDN_RATE_CODE, 3, 1)
                          END NUM_PAGOS,
                         (DECODE (SUBSTR (B.SGBSTDN_RATE_CODE, 4, 1), 'A', 15, 'B', '30', 'C', '10')) VENCIMIENTO,
                          SUBSTR (B.SGBSTDN_RATE_CODE, 1, 1) TIPO_PAGO,
                          B.SGBSTDN_RATE_CODE RATE,
                          DECODE (E.SZTDTEC_PERIODICIDAD, 1, 'Bime', 2, 'Cuatri', 3, 'Semes', 4, 'Anual') PERIODICIDAD,
                         (SELECT DISTINCT (SORLCUR_SITE_CODE)
                            FROM SORLCUR CUR
                           WHERE     CUR.SORLCUR_PIDM = A.SORLCUR_PIDM
                                 AND CUR.SORLCUR_LMOD_CODE = 'ADMISSIONS'
                                 AND CUR.SORLCUR_SEQNO = (SELECT MAX (SORLCUR_SEQNO)
                                                            FROM SORLCUR CUR2
                                                           WHERE     CUR2.SORLCUR_PIDM = CUR.SORLCUR_PIDM
                                                                 AND CUR2.SORLCUR_LMOD_CODE = CUR.SORLCUR_LMOD_CODE))PRE_ACTUALIZADO,
                         (SELECT MAX (T.SGRSATT_ATTS_CODE)
                            FROM SGRSATT T
                           WHERE     T.SGRSATT_PIDM = A.SORLCUR_PIDM
                                 AND T.SGRSATT_STSP_KEY_SEQUENCE = A.SORLCUR_KEY_SEQNO
                                 AND REGEXP_LIKE  (T.SGRSATT_ATTS_CODE , '^[0-9]')
                                 AND SUBSTR(T.SGRSATT_TERM_CODE_EFF,5,1) NOT IN (8,9)
                                 AND T.SGRSATT_TERM_CODE_EFF = ( SELECT MAX(SGRSATT_TERM_CODE_EFF)
                                                                   FROM SGRSATT TT
                                                                  WHERE     TT.SGRSATT_PIDM =  T.SGRSATT_PIDM
                                                                        AND TT.SGRSATT_STSP_KEY_SEQUENCE= T.SGRSATT_STSP_KEY_SEQUENCE
                                                                        AND SUBSTR(TT.SGRSATT_TERM_CODE_EFF,5,1) NOT IN (8,9)
                                                                        AND REGEXP_LIKE  (T.SGRSATT_ATTS_CODE , '^[0-9]'))
                                 AND T.SGRSATT_ACTIVITY_DATE = ( SELECT MAX(SGRSATT_ACTIVITY_DATE)
                                                                   FROM SGRSATT T1
                                                                  WHERE     T1.SGRSATT_PIDM = T.SGRSATT_PIDM
                                                                        AND T1.SGRSATT_STSP_KEY_SEQUENCE = T.SGRSATT_STSP_KEY_SEQUENCE
                                                                        AND T1.SGRSATT_TERM_CODE_EFF = T.SGRSATT_TERM_CODE_EFF
                                                                        AND SUBSTR(T1.SGRSATT_TERM_CODE_EFF,5,1) NOT IN (8,9)
                                                                        AND REGEXP_LIKE  (T.SGRSATT_ATTS_CODE , '^[0-9]')))JORNADA,
                          NVL((SELECT SUBSTR(TBBESTU_EXEMPTION_CODE,4,3)
                                 FROM TBBEXPT, TBBESTU A, TBBDETC, TBREDET
                                WHERE     TBBDETC_DETAIL_CODE = TBBEXPT_DETAIL_CODE
                                      AND A.TBBESTU_EXEMPTION_CODE  = TBBEXPT_EXEMPTION_CODE
                                      AND A.TBBESTU_TERM_CODE = TBBEXPT_TERM_CODE
                                      AND A.TBBESTU_STUDENT_EXPT_ROLL_IND= 'Y'
                                      AND A.TBBESTU_DEL_IND IS NULL
                                      AND TBREDET_EXEMPTION_CODE = TBBEXPT_EXEMPTION_CODE
                                      AND TBREDET_TERM_CODE = TBBEXPT_TERM_CODE
                                      AND A.TBBESTU_TERM_CODE = (SELECT MAX(A1.TBBESTU_TERM_CODE)
                                                                   FROM TBBESTU A1
                                                                  WHERE     A1.TBBESTU_PIDM = A.TBBESTU_PIDM
                                                                        AND A1.TBBESTU_STUDENT_EXPT_ROLL_IND = A.TBBESTU_STUDENT_EXPT_ROLL_IND
                                                                        AND A1.TBBESTU_DEL_IND IS NULL
                                                                        AND A1.TBBESTU_TERM_CODE <= B.SGBSTDN_TERM_CODE_EFF)
                                      AND A.TBBESTU_EXEMPTION_PRIORITY = (SELECT MAX(TBBESTU_EXEMPTION_PRIORITY)
                                                                            FROM TBBESTU A1
                                                                           WHERE     A1.TBBESTU_PIDM = A.TBBESTU_PIDM
                                                                                 AND A1.TBBESTU_STUDENT_EXPT_ROLL_IND = A.TBBESTU_STUDENT_EXPT_ROLL_IND
                                                                                 AND A1.TBBESTU_DEL_IND IS NULL
                                                                                 AND A1.TBBESTU_TERM_CODE = A.TBBESTU_TERM_CODE)
                                      AND A.TBBESTU_PIDM = A.SORLCUR_PIDM
                                      AND TBBDETC_DCAT_CODE = 'DSP'),0)DESCUENTO,
                         (SELECT SUBSTR(TEXTO,LARGO,2)
                            FROM (SELECT SARACMT_COMMENT_TEXT TEXTO,LENGTH (SARACMT_COMMENT_TEXT)-1 LARGO
                                    FROM SARACMT MT
                                   WHERE     MT.SARACMT_PIDM = A.SORLCUR_PIDM
                                         AND MT.SARACMT_APPL_NO = A.SORLCUR_APPL_KEY_SEQNO
                                         AND MT.SARACMT_ORIG_CODE = 'PAQT'
                                         AND MT.SARACMT_SEQNO = (SELECT MAX(SARACMT_SEQNO)
                                                                   FROM SARACMT
                                                                  WHERE     SARACMT_PIDM = MT.SARACMT_PIDM
                                                                        AND SARACMT_ORIG_CODE = 'PAQT'
                                                                        AND SARACMT_APPL_NO = MT.SARACMT_APPL_NO))
                           WHERE 1=1)PAGOS_PLAN,
                          DECODE (A.SORLCUR_DEGC_CODE, 'DIPL', 'COLEGIATURA DIPLOMADO', 'CURS', 'COLEGIATURA CURSO')DEGC_CODE,
                          TO_DATE(SUBSTR(SZTUTLX_ROW1,1,11),'YYYY/MM/DD')FECHA_INICIAL,
                          SZTUTLX_ROW2 MES_GRATIS,
                          SZTUTLX_ROW3 PORCENTAJE,
                          SZTUTLX_SEQ_NO
                    FROM SORLCUR A, SGBSTDN B, SPRIDEN D, SZTDTEC E,SZTUTLX X
                   WHERE      A.SORLCUR_LMOD_CODE = 'LEARNER'
                          AND A.SORLCUR_ROLL_IND  = 'Y'
                          AND A.SORLCUR_CACT_CODE = 'ACTIVE'
                          AND A.SORLCUR_SEQNO = (SELECT MAX (A1.SORLCUR_SEQNO)
                                                   FROM SORLCUR A1
                                                  WHERE     A1.SORLCUR_PIDM = A.SORLCUR_PIDM
                                                        AND A1.SORLCUR_ROLL_IND  = A.SORLCUR_ROLL_IND
                                                        AND A1.SORLCUR_CACT_CODE = A.SORLCUR_CACT_CODE
                                                        AND A1.SORLCUR_PROGRAM = A.SORLCUR_PROGRAM
                                                        AND A1.SORLCUR_LMOD_CODE = A.SORLCUR_LMOD_CODE)
                          AND X.SZTUTLX_CAMP_CODE = A.SORLCUR_CAMP_CODE
                          AND X.SZTUTLX_LEVL_CODE = A.SORLCUR_LEVL_CODE
                          AND X.SZTUTLX_SEQ_NO = (SELECT MAX(SZTUTLX_SEQ_NO)
                                                    FROM SZTUTLX
                                                   WHERE     SZTUTLX_PIDM = A.SORLCUR_PIDM
                                                         AND SZTUTLX_CAMP_CODE||SZTUTLX_LEVL_CODE = A.SORLCUR_CAMP_CODE||A.SORLCUR_LEVL_CODE)
                          AND A.SORLCUR_PIDM =  B.SGBSTDN_PIDM
                          AND A.SORLCUR_PROGRAM = B.SGBSTDN_PROGRAM_1
                          AND X.SZTUTLX_PIDM = A.SORLCUR_PIDM
                          AND X.SZTUTLX_DISABLE_IND = 'A'
                          AND B.SGBSTDN_TERM_CODE_EFF IN (SELECT MAX (B1.SGBSTDN_TERM_CODE_EFF)
                                                            FROM SGBSTDN B1
                                                           WHERE B.SGBSTDN_PIDM = B1.SGBSTDN_PIDM AND B.SGBSTDN_PROGRAM_1 = B1.SGBSTDN_PROGRAM_1)
                          AND E.SZTDTEC_PROGRAM = B.SGBSTDN_PROGRAM_1
                          AND A.SORLCUR_TERM_CODE_CTLG = E.SZTDTEC_TERM_CODE
                          AND D.SPRIDEN_PIDM = SGBSTDN_PIDM
                          AND D.SPRIDEN_ID = NVL(P_MATRICULA,D.SPRIDEN_ID)
                          AND D.SPRIDEN_CHANGE_IND IS NULL
                          AND A.SORLCUR_PIDM NOT IN (SELECT Z.TZFACCE_PIDM
                                                   FROM TZFACCE Z
                                                  WHERE     1=1
                                                        AND Z.TZFACCE_PIDM = A.SORLCUR_PIDM
                                                        AND Z.TZFACCE_STUDY = (SELECT MAX(TZFACCE_STUDY)
                                                                                 FROM TZFACCE
                                                                                 WHERE TZFACCE_PIDM = Z.TZFACCE_PIDM)
                                                        AND SUBSTR(Z.TZFACCE_DETAIL_CODE,3,2) = 'QG' )
                          AND (SELECT COUNT(*)  /*  SOLO TOMA LOS QUE NO TENGAN UTEL X EN EL MES EN CURSO*/
                                 FROM TBRACCD A
                                WHERE     A.TBRACCD_PIDM = A.SORLCUR_PIDM
                                      AND A.TBRACCD_TRAN_NUMBER = (SELECT MAX(TBRACCD_TRAN_NUMBER)
                                                                     FROM TBRACCD A1
                                                                    WHERE     A1.TBRACCD_PIDM = A.TBRACCD_PIDM
                                                                          AND A1.TBRACCD_CREATE_SOURCE IN ('UTEL X','TZFEDCA(ACC)')
                                                                          AND LAST_DAY(TRUNC(A1.TBRACCD_EFFECTIVE_DATE)) = LAST_DAY(TRUNC(SYSDATE))
                                                                          AND A1.TBRACCD_DETAIL_CODE LIKE '%QI'))=0
                          AND A.SORLCUR_PIDM NOT IN (SELECT TZDOCTR_PIDM
                                                       FROM TZDOCTR
                                                      WHERE     TZDOCTR_PIDM = A.SORLCUR_PIDM
                                                            AND TZDOCTR_OBSERVACIONES = 'Membresia Cancelada')
                          AND A.SORLCUR_PIDM NOT IN (SELECT TZDOCTR_PIDM
                                                       FROM TZDOCTR
                                                      WHERE     TZDOCTR_PIDM = A.SORLCUR_PIDM
                                                            AND LAST_DAY(TZDOCTR_START_DATE) = LAST_DAY(TRUNC(SYSDATE))
                                                            AND TZDOCTR_OBSERVACIONES IN ('Cartera creada con exito','Membresia vigente'))
                ORDER BY 1, 8, 9

    )LOOP

     /*INICIO SETEO DE VARIABLES*/
      VL_MENBRESIA            := NULL;
      VL_FECHA_COL            := NULL;
      VL_VITACORA             :=NULL;

      VL_PARCIALIDADES        := NULL;
      VL_CODIGO               := NULL;
      VL_DESCRIPCION          := NULL;
      VL_MONTO                := NULL;
      VL_SFRRGFE_RATE_CODE    := NULL;
      VL_CODIGO_DESC          := NULL;
      VL_DESCRIPCION_DESC     := NULL;
      VL_CODIGO_AFEC          := NULL;
      VL_MONTO_PERCENT        := NULL;
      VL_MONTO_AMOUNT         := NULL;
      VL_DESCUENTO            := NULL;
      VL_DESCUENTODSI         := NULL;
      VL_CODIGO_DSI           := NULL;
      VL_DESCRIPCION_DSI      := NULL;
      VL_CODIGO_PLP           := NULL;
      VL_DESCRIPCION_PLP      := NULL;
      VL_SECUENCIA            := NULL;
      VL_SECUENCIACOL         := NULL;
      VL_PLAN_PAGO            := NULL;
      VL_ULT_COL              := NULL;
      VL_CODIGO_PAR           := NULL;
      VL_DESCRIPCION_PAR      := NULL;
      VL_DIA                  := NULL;
      VL_MES                  := NULL;
      VL_ANO                  := NULL;
      VL_VENCIMIENTO          := NULL;
      VL_DOCTR                := NULL;
      VL_SECUEN               := NULL;
      VL_ERROR                := NULL;
      V_ENTRA                 := NULL;
      VL_UTELX_ENTRA          := NULL;
      /*FIN SETEO DE VARIABLES*/


      IF ALUMNO.FECHA_INICIAL IS NOT NULL THEN

       --DBMS_OUTPUT.PUT_LINE ('AQUI MIJO');

         BEGIN
           SELECT COUNT(*)
             INTO VL_UTELX_ENTRA
             FROM TBRACCD
            WHERE     TBRACCD_PIDM = ALUMNO.PIDM
                  AND SUBSTR(TBRACCD_DETAIL_CODE,3,2) = 'QG'
                  AND TBRACCD_DOCUMENT_NUMBER IS NULL
                  AND LAST_DAY(TBRACCD_EFFECTIVE_DATE) = LAST_DAY(TRUNC(SYSDATE));
         EXCEPTION
         WHEN OTHERS THEN
         VL_UTELX_ENTRA:=0;
         END;

         IF VL_UTELX_ENTRA = 0 THEN

           IF LAST_DAY(ADD_MONTHS(TO_DATE(ALUMNO.FECHA_INICIAL),(ALUMNO.MES_GRATIS-1))) >= TRUNC(SYSDATE) THEN

              --DBMS_OUTPUT.PUT_LINE ('VALIDACION VIGENCIA = '||LAST_DAY(ADD_MONTHS(TO_DATE(ALUMNO.FECHA_INICIAL),ALUMNO.MES_GRATIS))||' ==== '||TRUNC(SYSDATE));

              BEGIN

                  VL_DIA := ALUMNO.VENCIMIENTO;
                  VL_MES := SUBSTR (TO_CHAR(TRUNC(SYSDATE),'dd/mm/rrrr'), 4, 2);
                  VL_ANO := SUBSTR (TO_CHAR(TRUNC(SYSDATE),'dd/mm/rrrr'), 7, 4);

                  IF VL_DIA = '30' THEN
                     VL_VENCIMIENTO := CASE LPAD(VL_MES,2,'0') WHEN '02' THEN '28' ELSE VL_DIA END||'/'||LPAD(VL_MES,2,'0')||'/'||VL_ANO;
                  ELSE
                     VL_VENCIMIENTO := VL_DIA||'/'||LPAD(VL_MES,2,'0')||'/'||VL_ANO;
                  END IF;

               END;

              VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);
              VL_SEC_CARGO:= VL_SECUENCIA;

              BEGIN
                SELECT TBBDETC_DETAIL_CODE,TBBDETC_DESC,TBBDETC_AMOUNT,ROUND((TBBDETC_AMOUNT*(ALUMNO.PORCENTAJE/100)),0)
                  INTO VL_COD_UTLX,VL_DESCRIPCION_UTLX,VL_MONTO_UTLX,VL_MONTO_AJUSTE_UTLX
                  FROM TBBDETC
                 WHERE TBBDETC_DETAIL_CODE = SUBSTR(ALUMNO.MATRICULA,1,2)||'QG';
              END;

              IF ALUMNO.PORCENTAJE = 100 THEN

               VL_MONTO_UTLX:=0;

              ELSE

                  BEGIN
                    SELECT TBBDETC_DETAIL_CODE,TBBDETC_DESC
                      INTO VL_COD_DESC_UTLX,VL_DESCUENTO_DESC_UTLX
                      FROM TBBDETC
                     WHERE TBBDETC_DETAIL_CODE = SUBSTR(ALUMNO.MATRICULA,1,2)||'QK';
                  END;

              END IF;

              BEGIN
                 INSERT
                   INTO TBRACCD
                 VALUES (
                         ALUMNO.PIDM,                             --TBRACCD_PIDM
                         VL_SEC_CARGO,                            --TBRACCD_TRAN_NUMBER
                         ALUMNO.PERIODO,                          --TBRACCD_TERM_CODE
                         VL_COD_UTLX,                             --TBRACCD_DETAIL_CODE
                         USER,                                    --TBRACCD_USER
                         SYSDATE,                                 --TBRACCD_ENTRY_DATE
                         VL_MONTO_UTLX,                           --TBRACCD_AMOUNT
                         VL_MONTO_UTLX,                           --TBRACCD_BALANCE
                         TO_DATE(VL_VENCIMIENTO,'DD,MM,YYYY'),    --TBRACCD_EFFECTIVE_DATE
                         NULL,                                    --TBRACCD_BILL_DATE
                         NULL,                                    --TBRACCD_DUE_DATE
                         VL_DESCRIPCION_UTLX,                     --TBRACCD_DESC
                         NULL,                                    --TBRACCD_RECEIPT_NUMBER
                         NULL,                                    --TBRACCD_TRAN_NUMBER_PAID
                         NULL,                                    --TBRACCD_CROSSREF_PIDM
                         NULL,                                    --TBRACCD_CROSSREF_NUMBER
                         NULL,                                    --TBRACCD_CROSSREF_DETAIL_CODE
                        'T',                                      --TBRACCD_SRCE_CODE
                        'Y',                                      --TBRACCD_ACCT_FEED_IND
                         SYSDATE,                                 --TBRACCD_ACTIVITY_DATE
                         0,                                       --TBRACCD_SESSION_NUMBER
                         NULL,                                    --TBRACCD_CSHR_END_DATE
                         NULL,                                    --TBRACCD_CRN
                         NULL,                                    --TBRACCD_CROSSREF_SRCE_CODE
                         NULL,                                    --TBRACCD_LOC_MDT
                         NULL,                                    --TBRACCD_LOC_MDT_SEQ
                         NULL,                                    --TBRACCD_RATE
                         NULL,                                    --TBRACCD_UNITS
                         NULL,                                    --TBRACCD_DOCUMENT_NUMBER
                         TO_DATE(VL_VENCIMIENTO,'DD,MM,YYYY'),    --TBRACCD_TRANS_DATE
                         NULL,                                    --TBRACCD_PAYMENT_ID
                         NULL,                                    --TBRACCD_INVOICE_NUMBER
                         NULL,                                    --TBRACCD_STATEMENT_DATE
                         NULL,                                    --TBRACCD_INV_NUMBER_PAID
                        'MXN',                                    --TBRACCD_CURR_CODE
                         NULL,                                    --TBRACCD_EXCHANGE_DIFF
                         NULL,                                    --TBRACCD_FOREIGN_AMOUNT
                         NULL,                                    --TBRACCD_LATE_DCAT_CODE
                         TRUNC(SYSDATE),                          --TBRACCD_FEED_DATE
                         NULL,                                    --TBRACCD_FEED_DOC_CODE
                         NULL,                                    --TBRACCD_ATYP_CODE
                         NULL,                                    --TBRACCD_ATYP_SEQNO
                         NULL,                                    --TBRACCD_CARD_TYPE_VR
                         NULL,                                    --TBRACCD_CARD_EXP_DATE_VR
                         NULL,                                    --TBRACCD_CARD_AUTH_NUMBER_VR
                         NULL,                                    --TBRACCD_CROSSREF_DCAT_CODE
                         NULL,                                    --TBRACCD_ORIG_CHG_IND
                         NULL,                                    --TBRACCD_CCRD_CODE
                         NULL,                                    --TBRACCD_MERCHANT_ID
                         NULL,                                    --TBRACCD_TAX_REPT_YEAR
                         NULL,                                    --TBRACCD_TAX_REPT_BOX
                         NULL,                                    --TBRACCD_TAX_AMOUNT
                         NULL,                                    --TBRACCD_TAX_FUTURE_IND
                        'UTEL X',                                 --TBRACCD_DATA_ORIGIN
                        'UTEL X',                                 --TBRACCD_CREATE_SOURCE
                         NULL,                                    --TBRACCD_CPDT_IND
                         NULL,                                    --TBRACCD_AIDY_CODE
                         ALUMNO.STUDY_PATH,                       --TBRACCD_STSP_KEY_SEQUENCE
                         ALUMNO.PARTE_PERIODO,                    --TBRACCD_PERIOD
                         NULL,                                    --TBRACCD_SURROGATE_ID
                         NULL,                                    --TBRACCD_VERSION
                         USER,                                    --TBRACCD_USER_ID
                         NULL );                                  --TBRACCD_VPDI_CODE

              EXCEPTION
              WHEN OTHERS THEN
              VL_ERROR := 'Se presento ERROR INSERT TBRACCD CARGO '||VL_VENCIMIENTO||' = '||SQLERRM;
              END;

              IF ALUMNO.PORCENTAJE != 100 THEN

               VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);

                  BEGIN
                     INSERT
                       INTO TBRACCD
                     VALUES (
                             ALUMNO.PIDM,                             --TBRACCD_PIDM
                             VL_SECUENCIA,                            --TBRACCD_TRAN_NUMBER
                             ALUMNO.PERIODO,                          --TBRACCD_TERM_CODE
                             VL_COD_DESC_UTLX,                        --TBRACCD_DETAIL_CODE
                             USER,                                    --TBRACCD_USER
                             SYSDATE,                                 --TBRACCD_ENTRY_DATE
                             VL_MONTO_AJUSTE_UTLX,                    --TBRACCD_AMOUNT
                             VL_MONTO_AJUSTE_UTLX*-1,                 --TBRACCD_BALANCE
                             TO_DATE(VL_VENCIMIENTO,'DD,MM,YYYY'),    --TBRACCD_EFFECTIVE_DATE
                             NULL,                                    --TBRACCD_BILL_DATE
                             NULL,                                    --TBRACCD_DUE_DATE
                             VL_DESCUENTO_DESC_UTLX,                  --TBRACCD_DESC
                             NULL,                                    --TBRACCD_RECEIPT_NUMBER
                             VL_SEC_CARGO,                            --TBRACCD_TRAN_NUMBER_PAID
                             NULL,                                    --TBRACCD_CROSSREF_PIDM
                             NULL,                                    --TBRACCD_CROSSREF_NUMBER
                             NULL,                                    --TBRACCD_CROSSREF_DETAIL_CODE
                            'T',                                      --TBRACCD_SRCE_CODE
                            'Y',                                      --TBRACCD_ACCT_FEED_IND
                             SYSDATE,                                 --TBRACCD_ACTIVITY_DATE
                             0,                                       --TBRACCD_SESSION_NUMBER
                             NULL,                                    --TBRACCD_CSHR_END_DATE
                             NULL,                                    --TBRACCD_CRN
                             NULL,                                    --TBRACCD_CROSSREF_SRCE_CODE
                             NULL,                                    --TBRACCD_LOC_MDT
                             NULL,                                    --TBRACCD_LOC_MDT_SEQ
                             NULL,                                    --TBRACCD_RATE
                             NULL,                                    --TBRACCD_UNITS
                             NULL,                                    --TBRACCD_DOCUMENT_NUMBER
                             TO_DATE(VL_VENCIMIENTO,'DD,MM,YYYY'),    --TBRACCD_TRANS_DATE
                             NULL,                                    --TBRACCD_PAYMENT_ID
                             NULL,                                    --TBRACCD_INVOICE_NUMBER
                             NULL,                                    --TBRACCD_STATEMENT_DATE
                             NULL,                                    --TBRACCD_INV_NUMBER_PAID
                            'MXN',                                    --TBRACCD_CURR_CODE
                             NULL,                                    --TBRACCD_EXCHANGE_DIFF
                             NULL,                                    --TBRACCD_FOREIGN_AMOUNT
                             NULL,                                    --TBRACCD_LATE_DCAT_CODE
                             TRUNC(SYSDATE),                          --TBRACCD_FEED_DATE
                             NULL,                                    --TBRACCD_FEED_DOC_CODE
                             NULL,                                    --TBRACCD_ATYP_CODE
                             NULL,                                    --TBRACCD_ATYP_SEQNO
                             NULL,                                    --TBRACCD_CARD_TYPE_VR
                             NULL,                                    --TBRACCD_CARD_EXP_DATE_VR
                             NULL,                                    --TBRACCD_CARD_AUTH_NUMBER_VR
                             NULL,                                    --TBRACCD_CROSSREF_DCAT_CODE
                             NULL,                                    --TBRACCD_ORIG_CHG_IND
                             NULL,                                    --TBRACCD_CCRD_CODE
                             NULL,                                    --TBRACCD_MERCHANT_ID
                             NULL,                                    --TBRACCD_TAX_REPT_YEAR
                             NULL,                                    --TBRACCD_TAX_REPT_BOX
                             NULL,                                    --TBRACCD_TAX_AMOUNT
                             NULL,                                    --TBRACCD_TAX_FUTURE_IND
                            'UTEL X',                                 --TBRACCD_DATA_ORIGIN
                            'UTEL X',                                 --TBRACCD_CREATE_SOURCE
                             NULL,                                    --TBRACCD_CPDT_IND
                             NULL,                                    --TBRACCD_AIDY_CODE
                             ALUMNO.STUDY_PATH,                       --TBRACCD_STSP_KEY_SEQUENCE
                             ALUMNO.PARTE_PERIODO,                    --TBRACCD_PERIOD
                             NULL,                                    --TBRACCD_SURROGATE_ID
                             NULL,                                    --TBRACCD_VERSION
                             USER,                                    --TBRACCD_USER_ID
                             NULL );                                  --TBRACCD_VPDI_CODE

                  EXCEPTION
                  WHEN OTHERS THEN
                  VL_ERROR := 'Se presento ERROR INSERT TBRACCD PAGO '||SQLERRM;
                  END;

              END IF;

              VL_VITACORA:= 2;
              VL_ESTATUS  :='Membresia vigente';

           ELSE

                VL_ESTATUS:= PKG_FINANZAS.f_cancela_membresia_utelx(ALUMNO.PIDM);


--                 BEGIN
--                    UPDATE SZTUTLX
--                       SET SZTUTLX_DISABLE_IND = 'I',
--                           SZTUTLX_USER_UPDATE = USER,
--                           SZTUTLX_DATE_UPDATE= SYSDATE,
--                           SZTUTLX_STAT_IND      = 0,
--                           SZTUTLX_USER_BLOQUEO = 'pkg_finanzas.F_CARTERA_UTEL_X',
--                           SZTUTLX_ACTIVITY_BLOQUEO = sysdate
--                     WHERE     SZTUTLX_PIDM = ALUMNO.PIDM
--                           AND SZTUTLX_SEQ_NO = ALUMNO.SZTUTLX_SEQ_NO;
--                 END;

             VL_VITACORA :=2;
             VL_ESTATUS  :='Membresia Cancelada';

           END IF;

         ELSE
          VL_VITACORA :=2;
          VL_ESTATUS  :='Membresia vigente';
         END IF;

      ELSIF ALUMNO.FECHA_INICIAL IS NULL AND ALUMNO.ESTATUS != 'MA' THEN


        BEGIN
           SELECT COUNT(*)
             INTO VL_FECHA_CORR
             FROM TBRACCD A
            WHERE     A.TBRACCD_PIDM = ALUMNO.PIDM
                  AND A.TBRACCD_TRAN_NUMBER = (SELECT MAX(TBRACCD_TRAN_NUMBER)
                                                 FROM TBRACCD A1
                                                WHERE     A1.TBRACCD_PIDM = A.TBRACCD_PIDM
                                                      AND A1.TBRACCD_CREATE_SOURCE = 'UTEL X'
                                                      AND LAST_DAY(TRUNC(A1.TBRACCD_EFFECTIVE_DATE)) = LAST_DAY(TRUNC(SYSDATE))
                                                      AND A1.TBRACCD_DETAIL_CODE LIKE '%QI');
        EXCEPTION
        WHEN OTHERS THEN
        VL_FECHA_CORR:=0;
        END;

        BEGIN
          SELECT COUNT(*)
            INTO VL_FECHA_COL
            FROM TZDOCTR
           WHERE     TZDOCTR_PIDM = ALUMNO.PIDM
                 AND LAST_DAY(TRUNC(TZDOCTR_START_DATE+12)) = LAST_DAY(TRUNC(SYSDATE))
                 AND TZDOCTR_TIPO_PROC = 'EDCA';
        EXCEPTION
        WHEN OTHERS THEN
        VL_FECHA_COL:=0;
        END;

            DBMS_OUTPUT.PUT_LINE ('UTEL X ENTRA  = '||VL_FECHA_CORR||' = '||VL_FECHA_COL);

        IF TO_NUMBER(TO_CHAR(TRUNC(SYSDATE),'DD')) >= 7 THEN

          IF VL_FECHA_CORR = 0 AND VL_FECHA_COL = 0 THEN

            --DBMS_OUTPUT.PUT_LINE ('Reza 3 = '||VL_FECHA_COL||' = '||VL_FECHA_CORR);

            VL_VITACORA:= 1;

            BEGIN

              VL_DIA := ALUMNO.VENCIMIENTO;
              VL_MES := SUBSTR (TO_CHAR(TRUNC(SYSDATE),'dd/mm/rrrr'), 4, 2);
              VL_ANO := SUBSTR (TO_CHAR(TRUNC(SYSDATE),'dd/mm/rrrr'), 7, 4);

              IF VL_DIA = '30' THEN
                 VL_VENCIMIENTO := CASE LPAD(VL_MES,2,'0') WHEN '02' THEN '28' ELSE VL_DIA END||'/'||LPAD(VL_MES,2,'0')||'/'||VL_ANO;
              ELSE
                 VL_VENCIMIENTO := VL_DIA||'/'||LPAD(VL_MES,2,'0')||'/'||VL_ANO;
              END IF;

            END;

            VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);
            VL_SEC_CARGO:= VL_SECUENCIA;

            BEGIN
              SELECT TBBDETC_DETAIL_CODE,TBBDETC_DESC,TBBDETC_AMOUNT
                INTO VL_COD_UTLX,VL_DESCRIPCION_UTLX,VL_MONTO_UTLX
                FROM TBBDETC
               WHERE TBBDETC_DETAIL_CODE = SUBSTR(ALUMNO.MATRICULA,1,2)||'QI';
            END;

            IF ALUMNO.PORCENTAJE > 0 THEN

                BEGIN
                  SELECT TBBDETC_DETAIL_CODE,TBBDETC_DESC
                    INTO VL_COD_DESC_UTLX,VL_DESCUENTO_DESC_UTLX
                    FROM TBBDETC
                   WHERE TBBDETC_DETAIL_CODE = SUBSTR(ALUMNO.MATRICULA,1,2)||'QK';
                END;

            END IF;

            BEGIN
               INSERT
                 INTO TBRACCD
               VALUES (
                       ALUMNO.PIDM,                             --TBRACCD_PIDM
                       VL_SEC_CARGO,                            --TBRACCD_TRAN_NUMBER
                       ALUMNO.PERIODO,                          --TBRACCD_TERM_CODE
                       VL_COD_UTLX,                             --TBRACCD_DETAIL_CODE
                       USER,                                    --TBRACCD_USER
                       SYSDATE,                                 --TBRACCD_ENTRY_DATE
                       VL_MONTO_UTLX,                           --TBRACCD_AMOUNT
                       VL_MONTO_UTLX,                           --TBRACCD_BALANCE
                       TO_DATE(VL_VENCIMIENTO,'DD,MM,YYYY'),    --TBRACCD_EFFECTIVE_DATE
                       NULL,                                    --TBRACCD_BILL_DATE
                       NULL,                                    --TBRACCD_DUE_DATE
                       VL_DESCRIPCION_UTLX,                     --TBRACCD_DESC
                       NULL,                                    --TBRACCD_RECEIPT_NUMBER
                       NULL,                                    --TBRACCD_TRAN_NUMBER_PAID
                       NULL,                                    --TBRACCD_CROSSREF_PIDM
                       NULL,                                    --TBRACCD_CROSSREF_NUMBER
                       NULL,                                    --TBRACCD_CROSSREF_DETAIL_CODE
                      'T',                                      --TBRACCD_SRCE_CODE
                      'Y',                                      --TBRACCD_ACCT_FEED_IND
                       SYSDATE,                                 --TBRACCD_ACTIVITY_DATE
                       0,                                       --TBRACCD_SESSION_NUMBER
                       NULL,                                    --TBRACCD_CSHR_END_DATE
                       NULL,                                    --TBRACCD_CRN
                       NULL,                                    --TBRACCD_CROSSREF_SRCE_CODE
                       NULL,                                    --TBRACCD_LOC_MDT
                       NULL,                                    --TBRACCD_LOC_MDT_SEQ
                       NULL,                                    --TBRACCD_RATE
                       NULL,                                    --TBRACCD_UNITS
                       NULL,                                    --TBRACCD_DOCUMENT_NUMBER
                       TO_DATE(VL_VENCIMIENTO,'DD,MM,YYYY'),    --TBRACCD_TRANS_DATE
                       NULL,                                    --TBRACCD_PAYMENT_ID
                       NULL,                                    --TBRACCD_INVOICE_NUMBER
                       NULL,                                    --TBRACCD_STATEMENT_DATE
                       NULL,                                    --TBRACCD_INV_NUMBER_PAID
                      'MXN',                                    --TBRACCD_CURR_CODE
                       NULL,                                    --TBRACCD_EXCHANGE_DIFF
                       NULL,                                    --TBRACCD_FOREIGN_AMOUNT
                       NULL,                                    --TBRACCD_LATE_DCAT_CODE
                       TRUNC(SYSDATE),                          --TBRACCD_FEED_DATE
                       NULL,                                    --TBRACCD_FEED_DOC_CODE
                       NULL,                                    --TBRACCD_ATYP_CODE
                       NULL,                                    --TBRACCD_ATYP_SEQNO
                       NULL,                                    --TBRACCD_CARD_TYPE_VR
                       NULL,                                    --TBRACCD_CARD_EXP_DATE_VR
                       NULL,                                    --TBRACCD_CARD_AUTH_NUMBER_VR
                       NULL,                                    --TBRACCD_CROSSREF_DCAT_CODE
                       NULL,                                    --TBRACCD_ORIG_CHG_IND
                       NULL,                                    --TBRACCD_CCRD_CODE
                       NULL,                                    --TBRACCD_MERCHANT_ID
                       NULL,                                    --TBRACCD_TAX_REPT_YEAR
                       NULL,                                    --TBRACCD_TAX_REPT_BOX
                       NULL,                                    --TBRACCD_TAX_AMOUNT
                       NULL,                                    --TBRACCD_TAX_FUTURE_IND
                      'UTEL X',                                 --TBRACCD_DATA_ORIGIN
                      'UTEL X',                                 --TBRACCD_CREATE_SOURCE
                       NULL,                                    --TBRACCD_CPDT_IND
                       NULL,                                    --TBRACCD_AIDY_CODE
                       ALUMNO.STUDY_PATH,                       --TBRACCD_STSP_KEY_SEQUENCE
                       ALUMNO.PARTE_PERIODO,                    --TBRACCD_PERIOD
                       NULL,                                    --TBRACCD_SURROGATE_ID
                       NULL,                                    --TBRACCD_VERSION
                       USER,                                    --TBRACCD_USER_ID
                       NULL );                                  --TBRACCD_VPDI_CODE

            EXCEPTION
            WHEN OTHERS THEN
            VL_ERROR := 'Se presento ERROR INSERT TBRACCD CARGO '||VL_VENCIMIENTO||' = '||SQLERRM;
            END;

            IF ALUMNO.PORCENTAJE > 0 THEN

             VL_SECUENCIA:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (ALUMNO.PIDM);

                BEGIN
                   INSERT
                     INTO TBRACCD
                   VALUES (
                           ALUMNO.PIDM,                             --TBRACCD_PIDM
                           VL_SECUENCIA,                            --TBRACCD_TRAN_NUMBER
                           ALUMNO.PERIODO,                          --TBRACCD_TERM_CODE
                           VL_COD_DESC_UTLX,                        --TBRACCD_DETAIL_CODE
                           USER,                                    --TBRACCD_USER
                           SYSDATE,                                 --TBRACCD_ENTRY_DATE
                           ALUMNO.PORCENTAJE,                    --TBRACCD_AMOUNT
                           ALUMNO.PORCENTAJE*-1,                 --TBRACCD_BALANCE
                           TO_DATE(VL_VENCIMIENTO,'DD,MM,YYYY'),    --TBRACCD_EFFECTIVE_DATE
                           NULL,                                    --TBRACCD_BILL_DATE
                           NULL,                                    --TBRACCD_DUE_DATE
                           VL_DESCUENTO_DESC_UTLX,                  --TBRACCD_DESC
                           NULL,                                    --TBRACCD_RECEIPT_NUMBER
                           VL_SEC_CARGO,                            --TBRACCD_TRAN_NUMBER_PAID
                           NULL,                                    --TBRACCD_CROSSREF_PIDM
                           NULL,                                    --TBRACCD_CROSSREF_NUMBER
                           NULL,                                    --TBRACCD_CROSSREF_DETAIL_CODE
                          'T',                                      --TBRACCD_SRCE_CODE
                          'Y',                                      --TBRACCD_ACCT_FEED_IND
                           SYSDATE,                                 --TBRACCD_ACTIVITY_DATE
                           0,                                       --TBRACCD_SESSION_NUMBER
                           NULL,                                    --TBRACCD_CSHR_END_DATE
                           NULL,                                    --TBRACCD_CRN
                           NULL,                                    --TBRACCD_CROSSREF_SRCE_CODE
                           NULL,                                    --TBRACCD_LOC_MDT
                           NULL,                                    --TBRACCD_LOC_MDT_SEQ
                           NULL,                                    --TBRACCD_RATE
                           NULL,                                    --TBRACCD_UNITS
                           NULL,                                    --TBRACCD_DOCUMENT_NUMBER
                           TO_DATE(VL_VENCIMIENTO,'DD,MM,YYYY'),    --TBRACCD_TRANS_DATE
                           NULL,                                    --TBRACCD_PAYMENT_ID
                           NULL,                                    --TBRACCD_INVOICE_NUMBER
                           NULL,                                    --TBRACCD_STATEMENT_DATE
                           NULL,                                    --TBRACCD_INV_NUMBER_PAID
                          'MXN',                                    --TBRACCD_CURR_CODE
                           NULL,                                    --TBRACCD_EXCHANGE_DIFF
                           NULL,                                    --TBRACCD_FOREIGN_AMOUNT
                           NULL,                                    --TBRACCD_LATE_DCAT_CODE
                           TRUNC(SYSDATE),                          --TBRACCD_FEED_DATE
                           NULL,                                    --TBRACCD_FEED_DOC_CODE
                           NULL,                                    --TBRACCD_ATYP_CODE
                           NULL,                                    --TBRACCD_ATYP_SEQNO
                           NULL,                                    --TBRACCD_CARD_TYPE_VR
                           NULL,                                    --TBRACCD_CARD_EXP_DATE_VR
                           NULL,                                    --TBRACCD_CARD_AUTH_NUMBER_VR
                           NULL,                                    --TBRACCD_CROSSREF_DCAT_CODE
                           NULL,                                    --TBRACCD_ORIG_CHG_IND
                           NULL,                                    --TBRACCD_CCRD_CODE
                           NULL,                                    --TBRACCD_MERCHANT_ID
                           NULL,                                    --TBRACCD_TAX_REPT_YEAR
                           NULL,                                    --TBRACCD_TAX_REPT_BOX
                           NULL,                                    --TBRACCD_TAX_AMOUNT
                           NULL,                                    --TBRACCD_TAX_FUTURE_IND
                          'UTEL X',                                 --TBRACCD_DATA_ORIGIN
                          'UTEL X',                                 --TBRACCD_CREATE_SOURCE
                           NULL,                                    --TBRACCD_CPDT_IND
                           NULL,                                    --TBRACCD_AIDY_CODE
                           ALUMNO.STUDY_PATH,                       --TBRACCD_STSP_KEY_SEQUENCE
                           ALUMNO.PARTE_PERIODO,                    --TBRACCD_PERIOD
                           NULL,                                    --TBRACCD_SURROGATE_ID
                           NULL,                                    --TBRACCD_VERSION
                           USER,                                    --TBRACCD_USER_ID
                           NULL );                                  --TBRACCD_VPDI_CODE

                EXCEPTION
                WHEN OTHERS THEN
                VL_ERROR := 'Se presento ERROR INSERT TBRACCD PAGO '||SQLERRM;
                END;

            END IF;

            BEGIN
              SELECT MAX(TZTORDR_CONTADOR)+1
                INTO VL_SECUEN
                FROM TZTORDR;
            EXCEPTION
            WHEN OTHERS THEN
            VL_SECUEN:= NULL;
            END;

            IF VL_SECUEN IS NOT NULL THEN

               BEGIN

                 INSERT INTO TZTORDR
                 (
                   TZTORDR_CAMPUS,
                   TZTORDR_NIVEL,
                   TZTORDR_CONTADOR,
                   TZTORDR_PROGRAMA,
                   TZTORDR_PIDM,
                   TZTORDR_ID,
                   TZTORDR_ESTATUS,
                   TZTORDR_ACTIVITY_DATE,
                   TZTORDR_USER,
                   TZTORDR_DATA_ORIGIN,
                   TZTORDR_NO_REGLA,
                   TZTORDR_FECHA_INICIO,
                   TZTORDR_RATE,
                   TZTORDR_JORNADA,
                   TZTORDR_DSI,
                   TZTORDR_TERM_CODE
                 )
                 VALUES( ALUMNO.CAMPUS,
                         ALUMNO.NIVEL,
                         VL_SECUEN,
                         ALUMNO.PROGRAMA,
                         ALUMNO.PIDM,
                         ALUMNO.MATRICULA,
                         'S',
                         SYSDATE,
                         USER,
                         'TZTFEDC2',
                         NULL,
                         TRUNC(SYSDATE),
                         NULL,
                         NULL,
                         NULL,
                         ALUMNO.PERIODO
                         );
               EXCEPTION
               WHEN OTHERS THEN
               VL_ERROR:= 'ERROR AL INSERTAR EN TZTORDR = '||SQLERRM;
               END;

            END IF;

            BEGIN
              UPDATE TBRACCD A1
                 SET A1.TBRACCD_RECEIPT_NUMBER = VL_SECUEN,
                     A1.TBRACCD_FEED_DATE = TRUNC(SYSDATE)
               WHERE     A1.TBRACCD_PIDM = ALUMNO.PIDM
                     AND A1.TBRACCD_DATA_ORIGIN = 'UTEL X'
                     AND TRUNC(A1.TBRACCD_ENTRY_DATE) = TRUNC(SYSDATE);

              UPDATE TVRACCD A1
                 SET A1.TVRACCD_RECEIPT_NUMBER = VL_SECUEN,
                     A1.TVRACCD_FEED_DATE = TRUNC(SYSDATE)
               WHERE     A1.TVRACCD_PIDM = ALUMNO.PIDM
                     AND A1.TVRACCD_DATA_ORIGIN = 'UTEL X'
                     AND TRUNC(A1.TVRACCD_ENTRY_DATE) = TRUNC(SYSDATE);
            EXCEPTION
            WHEN OTHERS THEN
            VL_ERROR:= 'ERROR AL ACTUALIZAR TBRACCD = '||SQLERRM;
            END;

          END IF;

        END IF;


      ELSE

        VL_VITACORA:= 2;
        VL_IND:=1;
        VL_ESTATUS  :='Membresia vigente';

      END IF;

      IF VL_ERROR IS NULL THEN
        COMMIT;
      ELSE
       ROLLBACK;
      END IF;
      ------------------------  Se inserta la bitacora de TZDOCTR para identificar    ----------------------------------
      ------------------------  si se creo la cartera o aún no llega su vencimiento   ----------------------------------
          --DBMS_OUTPUT.PUT_LINE('FINAL =====  '||VL_ERROR);

      IF VL_VITACORA = 1 THEN

          IF VL_ERROR IS NULL THEN
              VL_ESTATUS := 'Cartera creada con exito';
              VL_IND     := 1;
          ELSE
              VL_ESTATUS:= VL_ERROR;
              VL_IND     := 0;
          END IF;

          BEGIN

              SELECT COUNT(*)
              INTO VL_DOCTR
              FROM TZDOCTR
              WHERE TZDOCTR_PIDM = ALUMNO.PIDM
              AND LAST_DAY(TZDOCTR_START_DATE) = LAST_DAY(TRUNC(SYSDATE))--ALUMNO.FECHA_INICIO PARA VALIDAR SI YA SE INTENTO EJECUTAR LA CARTERA
              ;

          EXCEPTION
          WHEN OTHERS THEN
          VL_DOCTR:=0;
          END;

          IF VL_DOCTR = 0 THEN

              BEGIN

                  INSERT INTO TZDOCTR (TZDOCTR_PIDM,
                                       TZDOCTR_PROGRAM,
                                       TZDOCTR_STST_CODE,
                                       TZDOCTR_STYP_CODE,
                                       TZDOCTR_CAMP_CODE,
                                       TZDOCTR_LEVL_CODE,
                                       TZDOCTR_TERM_CODE,
                                       TZDOCTR_START_DATE,
                                       TZDOCTR_PTRM_CODE,
                                       TZDOCTR_STUDY_PATH,
                                       TZDOCTR_NUM_PAGOS,
                                       TZDOCTR_RATE_CODE,
                                       TZDOCTR_COLEG,
                                       TZDOCTR_DESC,
                                       TZDOCTR_PPAGO,
                                       TZDOCTR_PARCI,
                                       FECHA_PROCESO,
                                       TZDOCTR_IND,
                                       TZDOCTR_OBSERVACIONES,
                                       TZDOCTR_VENCIMIENTO,
                                       TZDOCTR_ID,
                                       TZDOCTR_TIPO_PROC,
                                       TZDOCTR_DESCUENTO)
                  VALUES ( ALUMNO.PIDM,
                          ALUMNO.PROGRAMA,
                          ALUMNO.ESTATUS,
                          ALUMNO.TIPO_ALUMNO,
                          ALUMNO.CAMPUS,
                          ALUMNO.NIVEL,
                          ALUMNO.PERIODO,
                          LAST_DAY(TRUNC(SYSDATE)),--vd_Fecha_inicio,
                          ALUMNO.PARTE_PERIODO,
                          ALUMNO.STUDY_PATH,
                          ALUMNO.NUM_PAGOS,
                          ALUMNO.RATE,
                          NULL,
                          NULL,
                          NULL,
                          NULL,
                          SYSDATE,
                          VL_IND,
                          VL_ESTATUS,
                          ALUMNO.VENCIMIENTO,
                          ALUMNO.MATRICULA,
                          'UTLX',
                          1);
              EXCEPTION
              WHEN OTHERS THEN
              VL_ERROR:= 'Error al insertar en TZDOCTR'||SQLERRM;
              END;

          ELSE

            UPDATE TZDOCTR
               SET TZDOCTR_OBSERVACIONES = VL_ERROR,
                   FECHA_PROCESO = SYSDATE
             WHERE TZDOCTR_PIDM = ALUMNO.PIDM
             AND LAST_DAY(TZDOCTR_START_DATE) = LAST_DAY(TRUNC(SYSDATE));

          END IF;

      ELSIF VL_VITACORA = 2 THEN

          IF VL_ERROR IS NOT NULL THEN
              VL_ESTATUS := VL_ERROR;
              VL_IND     := 0;
          END IF;

          BEGIN

              SELECT COUNT(*)
              INTO VL_DOCTR
              FROM TZDOCTR
              WHERE TZDOCTR_PIDM = ALUMNO.PIDM
              AND LAST_DAY(TZDOCTR_START_DATE) = LAST_DAY(TRUNC(SYSDATE))--ALUMNO.FECHA_INICIO PARA VALIDAR SI YA SE INTENTO EJECUTAR LA CARTERA
              ;

          EXCEPTION
          WHEN OTHERS THEN
          VL_DOCTR:=0;
          END;

          IF VL_DOCTR = 0 THEN

              BEGIN

                  INSERT INTO
                  TZDOCTR (TZDOCTR_PIDM,
                           TZDOCTR_PROGRAM,
                           TZDOCTR_STST_CODE,
                           TZDOCTR_STYP_CODE,
                           TZDOCTR_CAMP_CODE,
                           TZDOCTR_LEVL_CODE,
                           TZDOCTR_TERM_CODE,
                           TZDOCTR_START_DATE,
                           TZDOCTR_PTRM_CODE,
                           TZDOCTR_STUDY_PATH,
                           TZDOCTR_NUM_PAGOS,
                           TZDOCTR_RATE_CODE,
                           TZDOCTR_COLEG,
                           TZDOCTR_DESC,
                           TZDOCTR_PPAGO,
                           TZDOCTR_PARCI,
                           FECHA_PROCESO,
                           TZDOCTR_IND,
                           TZDOCTR_OBSERVACIONES,
                           TZDOCTR_VENCIMIENTO,
                           TZDOCTR_ID,
                           TZDOCTR_TIPO_PROC,
                           TZDOCTR_DESCUENTO)
                  VALUES ( ALUMNO.PIDM,
                          ALUMNO.PROGRAMA,
                          ALUMNO.ESTATUS,
                          ALUMNO.TIPO_ALUMNO,
                          ALUMNO.CAMPUS,
                          ALUMNO.NIVEL,
                          ALUMNO.PERIODO,
                          LAST_DAY(TRUNC(SYSDATE)),--vd_Fecha_inicio,
                          ALUMNO.PARTE_PERIODO,
                          ALUMNO.STUDY_PATH,
                          ALUMNO.NUM_PAGOS,
                          ALUMNO.RATE,
                          NULL,
                          NULL,
                          NULL,
                          NULL,
                          SYSDATE,
                          1,
                          VL_ESTATUS,
                          ALUMNO.VENCIMIENTO,
                          ALUMNO.MATRICULA,
                          'UTLX',
                          1);
              EXCEPTION
              WHEN OTHERS THEN
              VL_ERROR:= 'Error al insertar en TZDOCTR'||SQLERRM;
              END;

          END IF;

      END IF;

     --DBMS_OUTPUT.PUT_LINE('FINAL BITACORA =====  '||VL_ERROR);

     COMMIT;

    END LOOP;

    IF VL_ERROR IS NULL THEN
       VL_ERROR:='EXITO';
    END IF;

   RETURN (VL_ERROR);

 END F_CARTERA_UTEL_X;

PROCEDURE P_ELIMINA_ESCA IS

VL_FACCE        NUMBER;

 BEGIN
    FOR ESCA IN (
                 SELECT DISTINCT TBRACCD_PIDM
                   FROM TBRACCD A,SORLCUR B
                  WHERE     B.SORLCUR_PIDM = A.TBRACCD_PIDM
                        AND B.SORLCUR_LMOD_CODE = 'LEARNER'
                        AND B.SORLCUR_ROLL_IND  = 'Y'
                        AND B.SORLCUR_CACT_CODE = 'ACTIVE'
                        AND A.TBRACCD_PIDM IN (SELECT GORADID_PIDM
                                                 FROM GORADID
                                                WHERE     GORADID_PIDM = A.TBRACCD_PIDM
                                                      AND GORADID_ADID_CODE = 'ESCA')
                        AND A.TBRACCD_PIDM NOT IN (SELECT TBRACCD_PIDM
                                                     FROM TBRACCD
                                                    WHERE     TBRACCD_PIDM = A.TBRACCD_PIDM
                                                          AND SUBSTR(TBRACCD_DETAIL_CODE,3,2) = 'M3'
                                                          AND LAST_DAY(TRUNC(TBRACCD_EFFECTIVE_DATE)) = LAST_DAY(TRUNC(SYSDATE)))
    )LOOP

        VL_FACCE := NULL;

        BEGIN

            SELECT COUNT(*)
            INTO VL_FACCE
            FROM TZFACCE
            WHERE TZFACCE_PIDM = ESCA.TBRACCD_PIDM
            AND SUBSTR(TZFACCE_DETAIL_CODE,3,2) = 'M3'
            AND TZFACCE_FLAG = 0
            AND LAST_DAY(TRUNC(TZFACCE_EFFECTIVE_DATE)) >= LAST_DAY(TRUNC(SYSDATE));

        END;

        IF VL_FACCE = 0 THEN

            DELETE GORADID
            WHERE GORADID_PIDM = ESCA.TBRACCD_PIDM AND GORADID_ADID_CODE = 'ESCA';

        END IF;

    END LOOP;

  COMMIT;

 END P_ELIMINA_ESCA;

FUNCTION F_MEMBRESIA_UTLX(  P_MATRICULA     VARCHAR2,
                            P_PROCESO       VARCHAR2,
                            P_FECHA         VARCHAR2,
                            P_PERIODO       VARCHAR2,
                            P_FECHA_INICIO  VARCHAR2,
                            P_STUDY_PATH    NUMBER,
                            P_PARTE_PERIODO VARCHAR2)RETURN VARCHAR2 IS

VL_ENTRA            NUMBER;
VL_COD_ACC          VARCHAR2(5);
VL_DESCRI_ACC       VARCHAR2(35);
VL_DESCUENTO_ACC    NUMBER;
VL_ERROR            VARCHAR2(900):= 'EXITO';
VL_PORCE_DESC       NUMBER;
VL_DESCUE_SW        NUMBER;
VL_MONTO_ACC        NUMBER;
VL_COD_DESCUENTO    VARCHAR2(5);
VL_AJUSTE           NUMBER;
VL_SECUENCIA        NUMBER;
VL_SECUENCIA_DESC   NUMBER;
VL_DESCRI_DESCUENTO VARCHAR2(35);
VL_BALANCE          NUMBER;
VL_COD_CANCE        VARCHAR2(5);
VL_ORDEN            NUMBER;
VL_ULTIMA_FECHA     VARCHAR2(20);

/*SE REALIZO CAMBIOS PARA INTEGRAR EL CODIGO 'NA' CORRESPONDIENTE A UTLX 1SS Y REACTIVA
AUTOR GGARCICA
FECHA 01/03/2022*/


BEGIN

   IF P_PROCESO = 'CARTERA' THEN

      BEGIN
        SELECT COUNT(*)
          INTO VL_ENTRA
          FROM SZTUTLX X
         WHERE     1 = 1
               AND X.SZTUTLX_PIDM = FGET_PIDM(P_MATRICULA)
               AND X.SZTUTLX_DISABLE_IND = 'A'
               AND X.SZTUTLX_SEQ_NO = ( SELECT MAX (SZTUTLX_SEQ_NO)
                                          FROM SZTUTLX
                                         WHERE SZTUTLX_PIDM = X.SZTUTLX_PIDM)
               AND X.SZTUTLX_PIDM IN ( SELECT TZFACCE_PIDM
                                         FROM TZFACCE
                                        WHERE     TZFACCE_PIDM = X.SZTUTLX_PIDM
                                              AND SUBSTR(TZFACCE_DETAIL_CODE,3,2) IN ('QI','NA')
                                              AND TZFACCE_FLAG = 0 );
      END;
      DBMS_OUTPUT.PUT_LINE('INICIA = '||VL_ENTRA);

      IF VL_ENTRA > 0 THEN
          DBMS_OUTPUT.PUT_LINE('EXISTE PARA CARTERA');
         BEGIN
           SELECT DISTINCT TZFACCE_DETAIL_CODE,TBBDETC_DESC,TBBDETC_AMOUNT,SZTUTLX_ROW3
             INTO VL_COD_ACC,VL_DESCRI_ACC,VL_MONTO_ACC,VL_DESCUENTO_ACC
             FROM TZFACCE E,SZTUTLX X,TBBDETC
            WHERE     E.TZFACCE_PIDM = X.SZTUTLX_PIDM
                  AND E.TZFACCE_PIDM = FGET_PIDM(P_MATRICULA)
                  AND E.TZFACCE_DETAIL_CODE = TBBDETC_DETAIL_CODE
                  AND SUBSTR(E.TZFACCE_DETAIL_CODE,3,2) IN ('QI','NA')
                  AND E.TZFACCE_FLAG = 0
                  AND E.TZFACCE_SEC_PIDM = (SELECT MAX(TZFACCE_SEC_PIDM)
                                              FROM TZFACCE
                                              WHERE TZFACCE_PIDM = E.TZFACCE_PIDM
                                                    AND SUBSTR(TZFACCE_DETAIL_CODE,3,2) IN ('QI','NA')
                                                    AND TZFACCE_FLAG = 0)
                  AND X.SZTUTLX_SEQ_NO = ( SELECT MAX (SZTUTLX_SEQ_NO)
                                             FROM SZTUTLX
                                            WHERE SZTUTLX_PIDM = X.SZTUTLX_PIDM);
         EXCEPTION
         WHEN OTHERS THEN
         VL_ERROR:='ERROR EN CALCULAR CODIGO '||SQLERRM;
         END;

         BEGIN
            SELECT TRUNC(TBRACCD_EFFECTIVE_DATE)
              INTO VL_ULTIMA_FECHA
              FROM TBRACCD A
             WHERE A.TBRACCD_PIDM = FGET_PIDM (P_MATRICULA)
                   AND A.TBRACCD_DETAIL_CODE = VL_COD_ACC
                   AND A.TBRACCD_TRAN_NUMBER = (SELECT MAX (TBRACCD_TRAN_NUMBER)
                                                     FROM TBRACCD
                                                    WHERE TBRACCD_PIDM = A.TBRACCD_PIDM
                                                          AND TBRACCD_DETAIL_CODE = A.TBRACCD_DETAIL_CODE);
--                                                          AND A.TBRACCD_DOCUMENT_NUMBER IS NULL;----SE QUITO ESTA VALIDACION YA V.S COLOCA EL NUMERO

--         DBMS_OUTPUT.PUT_LINE('FECHA = '||VL_ULTIMA_FECHA);
         EXCEPTION
         WHEN OTHERS THEN
         VL_ULTIMA_FECHA:='14/12/1990';
         VL_ERROR:='ERROR AL CALCULAR ULTIMA FECHA'||SQLERRM;
         END;


         IF TO_CHAR (TO_DATE(VL_ULTIMA_FECHA,'DD/MM/YYYY'),'MM/YY') != TO_CHAR (TO_DATE(P_FECHA,'DD/MM/YYYY'),'MM/YY') THEN
--         DBMS_OUTPUT.PUT_LINE('Fecha REZA BAILA = '||TO_CHAR(TO_DATE (VL_ULTIMA_FECHA,'DD/MM/YYYY'),'DD/MM/YYYY')||' = ' ||TO_CHAR (TO_DATE(P_FECHA,'DD/MM/YYYY'),'MM/YY'));

            IF SUBSTR(VL_COD_ACC,3,2) != 'NA' THEN

               BEGIN
                 SELECT SWTMDAC_PERCENT_DESC, SWTMDAC_AMOUNT_DESC, SWTMDAC_DETAIL_CODE_DESC,TBBDETC_DESC
                   INTO VL_PORCE_DESC,VL_DESCUE_SW,VL_COD_DESCUENTO,VL_DESCRI_DESCUENTO
                   FROM SWTMDAC A,TBBDETC
                  WHERE     SUBSTR(A.SWTMDAC_DETAIL_CODE_ACC,3,2) IN ('QI')
                        AND A.SWTMDAC_DETAIL_CODE_DESC = TBBDETC_DETAIL_CODE
                        AND A.SWTMDAC_PIDM = FGET_PIDM(P_MATRICULA)
                        AND A.SWTMDAC_SEC_PIDM = (SELECT MAX(SWTMDAC_SEC_PIDM)
                                                    FROM SWTMDAC
                                                   WHERE     SWTMDAC_PIDM = A.SWTMDAC_PIDM
                                                         AND SUBSTR(SWTMDAC_DETAIL_CODE_ACC,3,2) IN ('QI'));
               EXCEPTION
               WHEN OTHERS THEN
               VL_ERROR:='ERROR EN CALCULAR CODIGO SW'||SQLERRM;
               END;

               IF VL_PORCE_DESC IS NOT NULL AND (VL_DESCUE_SW IS NULL OR VL_DESCUE_SW = 0 ) THEN

                  VL_AJUSTE := VL_MONTO_ACC*(VL_PORCE_DESC/100);

               ELSIF VL_DESCUE_SW IS NOT NULL AND (VL_PORCE_DESC IS NULL OR VL_PORCE_DESC = 0) THEN

                  VL_AJUSTE := VL_DESCUE_SW;

               END IF;


               BEGIN
                 UPDATE SWTMDAC
                    SET SWTMDAC_APPLICATION_INDICATOR = 2
                  WHERE     SWTMDAC_PIDM = FGET_PIDM(P_MATRICULA)
                        AND SUBSTR(SWTMDAC_DETAIL_CODE_ACC,3,2) = 'QI';
               END;

               IF VL_AJUSTE IS NOT NULL THEN
                  BEGIN
                      UPDATE SZTUTLX X
                         SET SZTUTLX_ROW3 = VL_AJUSTE
                       WHERE     1 = 1
                             AND X.SZTUTLX_PIDM = FGET_PIDM(P_MATRICULA)
                             AND X.SZTUTLX_DISABLE_IND = 'A'
                             AND X.SZTUTLX_SEQ_NO = ( SELECT MAX (SZTUTLX_SEQ_NO)
                                                        FROM SZTUTLX
                                                       WHERE SZTUTLX_PIDM = X.SZTUTLX_PIDM
                                                             AND SZTUTLX_DISABLE_IND = 'A')
                             AND X.SZTUTLX_PIDM IN ( SELECT TZFACCE_PIDM
                                                       FROM TZFACCE
                                                      WHERE     TZFACCE_PIDM = X.SZTUTLX_PIDM
                                                            AND SUBSTR(TZFACCE_DETAIL_CODE,3,2) = 'QI'
                                                            AND TZFACCE_FLAG = 0 );
                  END;
               END IF;

            END IF;
           DBMS_OUTPUT.PUT_LINE('VL_AJUSTE := '||VL_AJUSTE);

            BEGIN
              SELECT MAX(TBRACCD_TRAN_NUMBER)+1
                INTO VL_SECUENCIA
                FROM TBRACCD WHERE TBRACCD_PIDM = FGET_PIDM(P_MATRICULA);
            EXCEPTION
            WHEN OTHERS THEN
            VL_SECUENCIA:= 0;
            END;


            BEGIN


            SELECT DISTINCT TBRACCD_RECEIPT_NUMBER
              INTO VL_ORDEN
              FROM TBRACCD A
             WHERE TBRACCD_PIDM = FGET_PIDM(P_MATRICULA)
                   AND TBRACCD_DOCUMENT_NUMBER IS NULL
                   AND TBRACCD_CREATE_SOURCE = 'TZFEDCA (PARC)'
                   AND TBRACCD_FEED_DATE = P_FECHA_INICIO
                   AND TBRACCD_STSP_KEY_SEQUENCE = (SELECT SORLCUR_KEY_SEQNO
                                                      FROM SORLCUR
                                                     WHERE SORLCUR_PIDM = A.TBRACCD_PIDM
                                                           AND SORLCUR_LMOD_CODE = 'LEARNER'
                                                           AND SORLCUR_ROLL_IND  = 'Y'
                                                           AND SORLCUR_CACT_CODE = 'ACTIVE');



            EXCEPTION WHEN
            OTHERS THEN VL_ERROR:= 'ERROR AL CALCULAR VIGENCIA';
            END;

            BEGIN
              INSERT
                INTO TBRACCD
              VALUES ( FGET_PIDM(P_MATRICULA),         -- TBRACCD_PIDM
                       VL_SECUENCIA,                   -- TBRACCD_TRAN_NUMBER
                       P_PERIODO,                      -- TBRACCD_TERM_CODE
                       VL_COD_ACC,                     -- TBRACCD_DETAIL_CODE
                       USER,                           -- TBRACCD_USER
                       SYSDATE,                        -- TBRACCD_ENTRY_DATE
                       NVL(VL_MONTO_ACC,0),            -- TBRACCD_AMOUNT
                       NVL(VL_MONTO_ACC,0),            -- TBRACCD_BALANCE
                       TO_DATE(P_FECHA,'DD/MM/RRRR'),  -- TBRACCD_EFFECTIVE_DATE
                       NULL,                           -- TBRACCD_BILL_DATE
                       NULL,                           -- TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                       VL_DESCRI_ACC,                  -- TBRACCD_DESC
                       VL_ORDEN,                       -- TBRACCD_RECEIPT_NUMBER
                       NULL,                           -- TBRACCD_TRAN_NUMBER_PAID
                       NULL,                           -- TBRACCD_CROSSREF_PIDM
                       NULL,                           -- TBRACCD_CROSSREF_NUMBER
                       NULL,                           -- TBRACCD_CROSSREF_DETAIL_CODE
                       'T',                            -- TBRACCD_SRCE_CODE
                       'Y',                            -- TBRACCD_ACCT_FEED_IND
                       SYSDATE,                        -- TBRACCD_ACTIVITY_DATE
                       0,                              -- TBRACCD_SESSION_NUMBER
                       NULL,                           -- TBRACCD_CSHR_END_DATE
                       NULL,                           -- TBRACCD_CRN
                       NULL,                           -- TBRACCD_CROSSREF_SRCE_CODE
                       NULL,                           -- TBRACCD_LOC_MDT
                       NULL,                           -- TBRACCD_LOC_MDT_SEQ
                       NULL,                           -- TBRACCD_RATE
                       NULL,                           -- TBRACCD_UNITS
                       NULL,                           -- TBRACCD_DOCUMENT_NUMBER
                       TO_DATE(P_FECHA,'DD/MM/RRRR'),  -- TBRACCD_TRANS_DATE
                       NULL,                           -- TBRACCD_PAYMENT_ID
                       NULL,                           -- TBRACCD_INVOICE_NUMBER
                       NULL,                           -- TBRACCD_STATEMENT_DATE
                       NULL,                           -- TBRACCD_INV_NUMBER_PAID
                       'MXN',                          -- TBRACCD_CURR_CODE
                       NULL,                           -- TBRACCD_EXCHANGE_DIFF
                       NULL,                           -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                       NULL,                           -- TBRACCD_LATE_DCAT_CODE
                       P_FECHA_INICIO,                 -- TBRACCD_FEED_DATE
                       NULL,                           -- TBRACCD_FEED_DOC_CODE
                       NULL,                           -- TBRACCD_ATYP_CODE
                       NULL,                           -- TBRACCD_ATYP_SEQNO
                       NULL,                           -- TBRACCD_CARD_TYPE_VR
                       NULL,                           -- TBRACCD_CARD_EXP_DATE_VR
                       NULL,                           -- TBRACCD_CARD_AUTH_NUMBER_VR
                       NULL,                           -- TBRACCD_CROSSREF_DCAT_CODE
                       NULL,                           -- TBRACCD_ORIG_CHG_IND
                       NULL,                           -- TBRACCD_CCRD_CODE
                       NULL,                           -- TBRACCD_MERCHANT_ID
                       NULL,                           -- TBRACCD_TAX_REPT_YEAR
                       NULL,                           -- TBRACCD_TAX_REPT_BOX
                       NULL,                           -- TBRACCD_TAX_AMOUNT
                       NULL,                           -- TBRACCD_TAX_FUTURE_IND
                       'TZFEDCA(ACC)',                 -- TBRACCD_DATA_ORIGIN
                       'TZFEDCA(ACC)',                 -- TBRACCD_CREATE_SOURCE
                       NULL,                           -- TBRACCD_CPDT_IND
                       NULL,                           -- TBRACCD_AIDY_CODE
                       P_STUDY_PATH,                   -- TBRACCD_STSP_KEY_SEQUENCE
                       P_PARTE_PERIODO,                -- TBRACCD_PERIOD
                       NULL,                           -- TBRACCD_SURROGATE_ID
                       NULL,                           -- TBRACCD_VERSION
                       USER,                           -- TBRACCD_USER_ID
                       NULL );                         -- TBRACCD_VPDI_CODE
            EXCEPTION
            WHEN OTHERS THEN
            VL_ERROR := 'Se presento ERROR INSERT TBRACCD '||SQLERRM;
            END;


            IF VL_AJUSTE > 0 THEN

                VL_SECUENCIA_DESC:= VL_SECUENCIA+1;

               BEGIN
                 INSERT
                   INTO TBRACCD
                 VALUES ( FGET_PIDM(P_MATRICULA),         -- TBRACCD_PIDM
                          VL_SECUENCIA_DESC,              -- TBRACCD_TRAN_NUMBER
                          P_PERIODO,                      -- TBRACCD_TERM_CODE
                          VL_COD_DESCUENTO,               -- TBRACCD_DETAIL_CODE
                          USER,                           -- TBRACCD_USER
                          SYSDATE,                        -- TBRACCD_ENTRY_DATE
                          NVL(VL_AJUSTE,0),               -- TBRACCD_AMOUNT
                          NVL(VL_AJUSTE,0)*-1,            -- TBRACCD_BALANCE
                          TO_DATE(P_FECHA,'DD/MM/RRRR'),  -- TBRACCD_EFFECTIVE_DATE
                          NULL,                           -- TBRACCD_BILL_DATE
                          NULL,                           -- TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                          VL_DESCRI_DESCUENTO,            -- TBRACCD_DESC
                          VL_ORDEN,                        -- TBRACCD_RECEIPT_NUMBER
                          VL_SECUENCIA,                   -- TBRACCD_TRAN_NUMBER_PAID
                          NULL,                           -- TBRACCD_CROSSREF_PIDM
                          NULL,                           -- TBRACCD_CROSSREF_NUMBER
                          NULL,                           -- TBRACCD_CROSSREF_DETAIL_CODE
                          'T',                            -- TBRACCD_SRCE_CODE
                          'Y',                            -- TBRACCD_ACCT_FEED_IND
                          SYSDATE,                        -- TBRACCD_ACTIVITY_DATE
                          0,                              -- TBRACCD_SESSION_NUMBER
                          NULL,                           -- TBRACCD_CSHR_END_DATE
                          NULL,                           -- TBRACCD_CRN
                          NULL,                           -- TBRACCD_CROSSREF_SRCE_CODE
                          NULL,                           -- TBRACCD_LOC_MDT
                          NULL,                           -- TBRACCD_LOC_MDT_SEQ
                          NULL,                           -- TBRACCD_RATE
                          NULL,                           -- TBRACCD_UNITS
                          NULL,                           -- TBRACCD_DOCUMENT_NUMBER
                          TO_DATE(P_FECHA,'DD/MM/RRRR'),  -- TBRACCD_TRANS_DATE
                          NULL,                           -- TBRACCD_PAYMENT_ID
                          NULL,                           -- TBRACCD_INVOICE_NUMBER
                          NULL,                           -- TBRACCD_STATEMENT_DATE
                          NULL,                           -- TBRACCD_INV_NUMBER_PAID
                          'MXN',                          -- TBRACCD_CURR_CODE
                          NULL,                           -- TBRACCD_EXCHANGE_DIFF
                          NULL,                           -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                          NULL,                           -- TBRACCD_LATE_DCAT_CODE
                          P_FECHA_INICIO,                 -- TBRACCD_FEED_DATE
                          NULL,                           -- TBRACCD_FEED_DOC_CODE
                          NULL,                           -- TBRACCD_ATYP_CODE
                          NULL,                           -- TBRACCD_ATYP_SEQNO
                          NULL,                           -- TBRACCD_CARD_TYPE_VR
                          NULL,                           -- TBRACCD_CARD_EXP_DATE_VR
                          NULL,                           -- TBRACCD_CARD_AUTH_NUMBER_VR
                          NULL,                           -- TBRACCD_CROSSREF_DCAT_CODE
                          NULL,                           -- TBRACCD_ORIG_CHG_IND
                          NULL,                           -- TBRACCD_CCRD_CODE
                          NULL,                           -- TBRACCD_MERCHANT_ID
                          NULL,                           -- TBRACCD_TAX_REPT_YEAR
                          NULL,                           -- TBRACCD_TAX_REPT_BOX
                          NULL,                           -- TBRACCD_TAX_AMOUNT
                          NULL,                           -- TBRACCD_TAX_FUTURE_IND
                          'TZFEDCA(ACC)',                 -- TBRACCD_DATA_ORIGIN
                          'TZFEDCA(ACC)',                 -- TBRACCD_CREATE_SOURCE
                          NULL,                           -- TBRACCD_CPDT_IND
                          NULL,                           -- TBRACCD_AIDY_CODE
                          P_STUDY_PATH,                   -- TBRACCD_STSP_KEY_SEQUENCE
                          P_PARTE_PERIODO,                -- TBRACCD_PERIOD
                          NULL,                           -- TBRACCD_SURROGATE_ID
                          NULL,                           -- TBRACCD_VERSION
                          USER,                           -- TBRACCD_USER_ID
                          NULL );                         -- TBRACCD_VPDI_CODE
               EXCEPTION
               WHEN OTHERS THEN
               VL_ERROR := 'Se presento ERROR INSERT TBRACCD DESCUENTO '||SQLERRM;
               END;

            END IF;

         END IF;

      ELSE
          DBMS_OUTPUT.PUT_LINE('SIN BENEFICIO');
      END IF;


   ELSIF P_PROCESO = 'CANCELA' THEN

       DBMS_OUTPUT.PUT_LINE('CANCELA CARTERA');

       BEGIN
         FOR CAN IN (

                      SELECT TBRACCD_PIDM,
                             TBRACCD_TRAN_NUMBER,
                             TBRACCD_DESC,
                             TBRACCD_AMOUNT,
                             TBRACCD_TERM_CODE,
                             TBRACCD_PERIOD,
                             TBRACCD_EFFECTIVE_DATE,
                             TBRACCD_STSP_KEY_SEQUENCE,
                             TBRACCD_FEED_DATE,
                             TBRACCD_RECEIPT_NUMBER,
                             TBBDETC_TYPE_IND
                      FROM TBRACCD,TBBDETC
                     WHERE TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
                     AND TBRACCD_PIDM = FGET_PIDM(P_MATRICULA)
                     AND SUBSTR(TBRACCD_DETAIL_CODE,3,2) IN ('QI','QK','QG')
                     AND TRUNC(TBRACCD_EFFECTIVE_DATE) > TRUNC(SYSDATE)
                     AND TBRACCD_DOCUMENT_NUMBER IS NULL
                     AND TBRACCD_AMOUNT > 0
                     ORDER BY TBBDETC_TYPE_IND

         )LOOP

           PKG_FINANZAS.P_DESAPLICA_PAGOS(CAN.TBRACCD_PIDM,CAN.TBRACCD_TRAN_NUMBER);

            IF CAN.TBBDETC_TYPE_IND = 'C' THEN
             VL_BALANCE     := CAN.TBRACCD_AMOUNT*-1;
             VL_COD_CANCE   := SUBSTR(P_MATRICULA,1,2)||'QJ';
            ELSIF CAN.TBBDETC_TYPE_IND = 'P' THEN
             VL_BALANCE:= CAN.TBRACCD_AMOUNT;
             VL_COD_CANCE   := SUBSTR(P_MATRICULA,1,2)||'QR';
            END IF;

            BEGIN
              SELECT MAX(TBRACCD_TRAN_NUMBER)+1
                INTO VL_SECUENCIA
                FROM TBRACCD WHERE TBRACCD_PIDM = CAN.TBRACCD_PIDM;
            EXCEPTION
            WHEN OTHERS THEN
            VL_SECUENCIA:= 0;
            END;

            BEGIN
              SELECT TBBDETC_DESC
              INTO VL_DESCRI_ACC
              FROM TBBDETC
              WHERE TBBDETC_DETAIL_CODE = VL_COD_CANCE;
            EXCEPTION
            WHEN OTHERS THEN
            VL_DESCRI_ACC:=NULL;
            END;

            BEGIN
              INSERT
                INTO TBRACCD
              VALUES ( CAN.TBRACCD_PIDM,               -- TBRACCD_PIDM
                       VL_SECUENCIA,                   -- TBRACCD_TRAN_NUMBER
                       CAN.TBRACCD_TERM_CODE,          -- TBRACCD_TERM_CODE
                       VL_COD_CANCE,                   -- TBRACCD_DETAIL_CODE
                       USER,                           -- TBRACCD_USER
                       SYSDATE,                        -- TBRACCD_ENTRY_DATE
                       NVL(CAN.TBRACCD_AMOUNT,0),      -- TBRACCD_AMOUNT
                       NVL(VL_BALANCE,0),              -- TBRACCD_BALANCE
                       SYSDATE,                        -- TBRACCD_EFFECTIVE_DATE
                       NULL,                           -- TBRACCD_BILL_DATE
                       NULL,                           -- TBRACCD_DUE_DATTBRACCD_UNITSTBRACCD_ACTIVITY_DATEE
                       VL_DESCRI_ACC,                  -- TBRACCD_DESC
                       CAN.TBRACCD_RECEIPT_NUMBER,     -- TBRACCD_RECEIPT_NUMBER
                       CAN.TBRACCD_TRAN_NUMBER,        -- TBRACCD_TRAN_NUMBER_PAID
                       NULL,                           -- TBRACCD_CROSSREF_PIDM
                       NULL,                           -- TBRACCD_CROSSREF_NUMBER
                       NULL,                           -- TBRACCD_CROSSREF_DETAIL_CODE
                       'T',                            -- TBRACCD_SRCE_CODE
                       'Y',                            -- TBRACCD_ACCT_FEED_IND
                       SYSDATE,                        -- TBRACCD_ACTIVITY_DATE
                       0,                              -- TBRACCD_SESSION_NUMBER
                       NULL,                           -- TBRACCD_CSHR_END_DATE
                       NULL,                           -- TBRACCD_CRN
                       NULL,                           -- TBRACCD_CROSSREF_SRCE_CODE
                       NULL,                           -- TBRACCD_LOC_MDT
                       NULL,                           -- TBRACCD_LOC_MDT_SEQ
                       NULL,                           -- TBRACCD_RATE
                       NULL,                           -- TBRACCD_UNITS
                       'SZFABCC',                        -- TBRACCD_DOCUMENT_NUMBER
                       SYSDATE,                        -- TBRACCD_TRANS_DATE
                       NULL,                           -- TBRACCD_PAYMENT_ID
                       NULL,                           -- TBRACCD_INVOICE_NUMBER
                       NULL,                           -- TBRACCD_STATEMENT_DATE
                       NULL,                           -- TBRACCD_INV_NUMBER_PAID
                       'MXN',                          -- TBRACCD_CURR_CODE
                       NULL,                           -- TBRACCD_EXCHANGE_DIFF
                       NULL,                           -- TBRACCD_FOREIGN_TBRACCD_EXCHANGE_DIFFTBRACCD_PAYMENT_IDAMOUNT
                       NULL,                           -- TBRACCD_LATE_DCAT_CODE
                       CAN.TBRACCD_FEED_DATE,          -- TBRACCD_FEED_DATE
                       NULL,                           -- TBRACCD_FEED_DOC_CODE
                       NULL,                           -- TBRACCD_ATYP_CODE
                       NULL,                           -- TBRACCD_ATYP_SEQNO
                       NULL,                           -- TBRACCD_CARD_TYPE_VR
                       NULL,                           -- TBRACCD_CARD_EXP_DATE_VR
                       NULL,                           -- TBRACCD_CARD_AUTH_NUMBER_VR
                       NULL,                           -- TBRACCD_CROSSREF_DCAT_CODE
                       NULL,                           -- TBRACCD_ORIG_CHG_IND
                       NULL,                           -- TBRACCD_CCRD_CODE
                       NULL,                           -- TBRACCD_MERCHANT_ID
                       NULL,                           -- TBRACCD_TAX_REPT_YEAR
                       NULL,                           -- TBRACCD_TAX_REPT_BOX
                       NULL,                           -- TBRACCD_TAX_AMOUNT
                       NULL,                           -- TBRACCD_TAX_FUTURE_IND
                       'CANCELA_UTLX',                 -- TBRACCD_DATA_ORIGIN
                       'CANCELA_UTLX',                 -- TBRACCD_CREATE_SOURCE
                       NULL,                           -- TBRACCD_CPDT_IND
                       NULL,                           -- TBRACCD_AIDY_CODE
                       CAN.TBRACCD_STSP_KEY_SEQUENCE,  -- TBRACCD_STSP_KEY_SEQUENCE
                       CAN.TBRACCD_PERIOD,             -- TBRACCD_PERIOD
                       NULL,                           -- TBRACCD_SURROGATE_ID
                       NULL,                           -- TBRACCD_VERSION
                       USER,                           -- TBRACCD_USER_ID
                       NULL );                         -- TBRACCD_VPDI_CODE
            EXCEPTION
            WHEN OTHERS THEN
            VL_ERROR := 'Se presento ERROR INSERT TBRACCD '||SQLERRM;
            END;

            BEGIN
              UPDATE TBRACCD
                 SET TBRACCD_DOCUMENT_NUMBER = 'SZFABCC',
                     TBRACCD_TRAN_NUMBER_PAID = NULL
               WHERE     TBRACCD_PIDM = CAN.TBRACCD_PIDM
                     AND TBRACCD_TRAN_NUMBER = CAN.TBRACCD_TRAN_NUMBER;

               UPDATE TVRACCD
                 SET TVRACCD_DOCUMENT_NUMBER = 'SZFABCC',
                     TVRACCD_TRAN_NUMBER_PAID = NULL
               WHERE     TVRACCD_PIDM = CAN.TBRACCD_PIDM
                     AND TVRACCD_ACCD_TRAN_NUMBER = CAN.TBRACCD_TRAN_NUMBER;
            END;

         END LOOP;

      END;

   END IF;

  RETURN (VL_ERROR);

  COMMIT;

END F_MEMBRESIA_UTLX;

PROCEDURE P_ADEUDO_UTLX IS

VL_SALDO_VENCIDO            NUMBER;
VL_SIN_APLICAR              NUMBER;
VL_REAL                     NUMBER;
VL_TRAN_AJUSTAR             NUMBER;
VL_ACTUALIZA                NUMBER;
VL_CART_UTL                 VARCHAR2(900);
vl_exito                    varchar2(250):= null;

 BEGIN
   FOR UTLX IN (
                 SELECT *
                   FROM SZTUTLX X
                  WHERE     1 = 1
                        AND X.SZTUTLX_DISABLE_IND = 'A'
                        AND X.SZTUTLX_SEQ_NO = ( SELECT MAX (SZTUTLX_SEQ_NO)
                                                   FROM SZTUTLX
                                                  WHERE SZTUTLX_PIDM = X.SZTUTLX_PIDM)
                        AND X.SZTUTLX_PIDM IN ( SELECT TZFACCE_PIDM
                                                  FROM TZFACCE
                                                 WHERE     TZFACCE_PIDM = X.SZTUTLX_PIDM
                                                       AND SUBSTR(TZFACCE_DETAIL_CODE,3,2) = 'QI'
                                                       AND TZFACCE_FLAG = 0 )
                        --AND X.SZTUTLX_ID = '010244011'
                        AND ( SELECT COUNT(*)
                                FROM TBRACCD D
                               WHERE D.TBRACCD_PIDM = X.SZTUTLX_PIDM
                                     AND SUBSTR(D.TBRACCD_DETAIL_CODE,3,2) = 'QI'
                                     AND TRUNC(D.TBRACCD_EFFECTIVE_DATE) <= TRUNC(SYSDATE)
                                     AND (D.TBRACCD_AMOUNT-(SELECT NVL(SUM(TBRACCD_AMOUNT),0)
                                                              FROM TBRACCD
                                                             WHERE TBRACCD_PIDM = D.TBRACCD_PIDM
                                                              AND TBRACCD_TRAN_NUMBER_PAID = D.TBRACCD_TRAN_NUMBER))>0
                                     AND D.TBRACCD_BALANCE > 0 ) >= ( SELECT ZSTPARA_PARAM_VALOR
                                                                        FROM ZSTPARA A
                                                                       WHERE     A.ZSTPARA_MAPA_ID = 'UTLX_MESES'
                                                                             AND A.ZSTPARA_PARAM_ID = 'MESES_'||SUBSTR(X.SZTUTLX_ID,1,2)
                                                                       UNION
                                                                      SELECT ZSTPARA_PARAM_VALOR
                                                                        FROM ZSTPARA A1
                                                                       WHERE     A1.ZSTPARA_MAPA_ID = 'UTLX_MESES'
                                                                             AND A1.ZSTPARA_PARAM_ID = 'GENERAL'
                                                                             AND (SELECT ZSTPARA_PARAM_VALOR
                                                                                    FROM ZSTPARA A
                                                                                   WHERE     A.ZSTPARA_MAPA_ID = 'UTLX_MESES'
                                                                                         AND A.ZSTPARA_PARAM_ID = 'MESES_'||SUBSTR(X.SZTUTLX_ID,1,2))IS NULL)

   )LOOP

     BEGIN
       SELECT SUM(TBRACCD_BALANCE)
         INTO VL_SALDO_VENCIDO
         FROM TBRACCD
        WHERE TBRACCD_PIDM = UTLX.SZTUTLX_PIDM
         AND TRUNC(TBRACCD_EFFECTIVE_DATE) <= TRUNC(SYSDATE);
     END;

     IF VL_SALDO_VENCIDO > 0 THEN

        BEGIN
           SELECT SUM(TBRACCD_BALANCE)*-1
             INTO VL_SIN_APLICAR
             FROM TBRACCD
            WHERE TBRACCD_PIDM = UTLX.SZTUTLX_PIDM
             AND TBRACCD_BALANCE < 0
             AND TRUNC(TBRACCD_EFFECTIVE_DATE) <= TRUNC(SYSDATE);
        END;

        VL_REAL := VL_SIN_APLICAR;

        BEGIN

           FOR TRANS IN (

                       SELECT *
                         FROM TBRACCD
                        WHERE TBRACCD_PIDM = UTLX.SZTUTLX_PIDM
                         AND TBRACCD_BALANCE > 0
                         AND TRUNC(TBRACCD_EFFECTIVE_DATE) <= TRUNC(SYSDATE)
                         ORDER BY TBRACCD_TRAN_NUMBER,TBRACCD_EFFECTIVE_DATE
           )LOOP

             VL_REAL := VL_REAL - TRANS.TBRACCD_BALANCE;

              IF VL_REAL <= 0 THEN
               VL_TRAN_AJUSTAR:= TRANS.TBRACCD_TRAN_NUMBER;
               EXIT;
              END IF;

           END LOOP;

        END;

        BEGIN
         SELECT COUNT(*)
         INTO VL_ACTUALIZA
           FROM SZTUTLX X
          WHERE     1 = 1
                AND X.SZTUTLX_DISABLE_IND = 'A'
                AND X.SZTUTLX_SEQ_NO = ( SELECT MAX (SZTUTLX_SEQ_NO)
                                           FROM SZTUTLX
                                          WHERE SZTUTLX_PIDM = X.SZTUTLX_PIDM)
                AND X.SZTUTLX_PIDM IN ( SELECT TZFACCE_PIDM
                                          FROM TZFACCE
                                         WHERE     TZFACCE_PIDM = X.SZTUTLX_PIDM
                                               AND SUBSTR(TZFACCE_DETAIL_CODE,3,2) = 'QI'
                                               AND TZFACCE_FLAG = 0 )
                AND X.SZTUTLX_ID = UTLX.SZTUTLX_ID
                AND ( SELECT COUNT(*)
                        FROM TBRACCD D
                       WHERE D.TBRACCD_PIDM = X.SZTUTLX_PIDM
                             AND SUBSTR(D.TBRACCD_DETAIL_CODE,3,2) = 'QI'
                             AND TBRACCD_TRAN_NUMBER > VL_TRAN_AJUSTAR
                             AND TRUNC(D.TBRACCD_EFFECTIVE_DATE) <= TRUNC(SYSDATE)
                             AND (D.TBRACCD_AMOUNT-(SELECT NVL(SUM(TBRACCD_AMOUNT),0)
                                                      FROM TBRACCD
                                                     WHERE TBRACCD_PIDM = D.TBRACCD_PIDM
                                                      AND TBRACCD_TRAN_NUMBER_PAID = D.TBRACCD_TRAN_NUMBER))>0
                             AND D.TBRACCD_BALANCE > 0 ) >= ( SELECT ZSTPARA_PARAM_VALOR
                                                                FROM ZSTPARA A
                                                               WHERE     A.ZSTPARA_MAPA_ID = 'UTLX_MESES'
                                                                     AND A.ZSTPARA_PARAM_ID = 'MESES_'||SUBSTR(X.SZTUTLX_ID,1,2)
                                                               UNION
                                                              SELECT ZSTPARA_PARAM_VALOR
                                                                FROM ZSTPARA A1
                                                               WHERE     A1.ZSTPARA_MAPA_ID = 'UTLX_MESES'
                                                                     AND A1.ZSTPARA_PARAM_ID = 'GENERAL'
                                                                     AND (SELECT ZSTPARA_PARAM_VALOR
                                                                            FROM ZSTPARA A
                                                                           WHERE     A.ZSTPARA_MAPA_ID = 'UTLX_MESES'
                                                                                 AND A.ZSTPARA_PARAM_ID = 'MESES_'||SUBSTR(X.SZTUTLX_ID,1,2))IS NULL);
        END;

        IF VL_ACTUALIZA > 0 THEN


              vl_exito := pkg_finanzas.f_cancela_membresia_utelx(UTLX.SZTUTLX_PIDM);

--           BEGIN
--              UPDATE SZTUTLX
--                 SET SZTUTLX_DISABLE_IND   = 'I',
--                     SZTUTLX_USER_UPDATE   = USER,
--                     SZTUTLX_DATE_UPDATE   = SYSDATE,
--                     SZTUTLX_STAT_IND      = 0,
--                    SZTUTLX_USER_BLOQUEO = 'pkg_finanzas.P_ADEUDO_UTLX',
--                    SZTUTLX_ACTIVITY_BLOQUEO = sysdate
--               WHERE     SZTUTLX_PIDM = UTLX.SZTUTLX_PIDM;
--           END;


           VL_CART_UTL:= PKG_FINANZAS.F_MEMBRESIA_UTLX( UTLX.SZTUTLX_ID,
                                                         'CANCELA',
                                                         NULL,
                                                         NULL,
                                                         NULL,
                                                         NULL,
                                                         NULL);
         DBMS_OUTPUT.PUT_LINE('ACTUALIZA ESTATUS A IN ACTIVO '||UTLX.SZTUTLX_PIDM||' = '||USER);
        END IF;
     END IF;
   END LOOP;
  COMMIT;
 END P_ADEUDO_UTLX;

FUNCTION F_CARTERA_REVERSION_BAJA (P_PIDM IN VARCHAR2,
                                   P_FECHA_INICIO IN VARCHAR2
                                   )RETURN VARCHAR2 IS
VL_ENTRA                NUMBER;
VL_ERROR                VARCHAR2(900);
INSERTA_TBRACCD         VARCHAR2(900);
VL_SECUENCIA            NUMBER;
VL_BALANCE              NUMBER;
VL_PAID                 NUMBER;
VL_FECHA_VENC           DATE;
VL_CODIGO               VARCHAR2(5);
VL_DESCRIPCION          VARCHAR2(45);
VL_APL_AJUSTE           VARCHAR2(900);


BEGIN
   BEGIN
     SELECT COUNT(*)
       INTO VL_ENTRA
       FROM TBRACCD A
      WHERE     A.TBRACCD_PIDM = P_PIDM
            AND A.TBRACCD_FEED_DATE = P_FECHA_INICIO
            AND A.TBRACCD_DOCUMENT_NUMBER = 'SZFABCC'
            AND A.TBRACCD_CREATE_SOURCE LIKE 'TZFEDCA%';
   END;

   IF VL_ENTRA > 0 THEN
     FOR EDC IN (

        SELECT TBRACCD_PIDM,
               TBRACCD_TRAN_NUMBER,
               TBRACCD_TERM_CODE,
               TBRACCD_DETAIL_CODE,
               TBRACCD_AMOUNT,
               TBRACCD_BALANCE,
               TBRACCD_DESC,
               TBRACCD_USER,
               TBRACCD_ENTRY_DATE,
               TBRACCD_EFFECTIVE_DATE,
               TBRACCD_SRCE_CODE,
               TBRACCD_ACCT_FEED_IND,
               TBRACCD_ACTIVITY_DATE,
               TBRACCD_SESSION_NUMBER,
               TBRACCD_SURROGATE_ID,
               TBRACCD_VERSION,
               TBRACCD_STSP_KEY_SEQUENCE,
               TBRACCD_PERIOD,
               TBRACCD_FEED_DATE,
               TBRACCD_RECEIPT_NUMBER,
               TBRACCD_CREATE_SOURCE,
               TBBDETC_TYPE_IND TIPO
          FROM TBRACCD A,TBBDETC
         WHERE     A.TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
               AND A.TBRACCD_PIDM = P_PIDM
               AND A.TBRACCD_FEED_DATE = P_FECHA_INICIO
               AND A.TBRACCD_DOCUMENT_NUMBER = 'SZFABCC'
               AND A.TBRACCD_CREATE_SOURCE LIKE 'TZFEDCA%'
         ORDER BY 1 ASC

     )LOOP

       BEGIN
         SELECT MAX(TBRACCD_TRAN_NUMBER)+1
           INTO VL_SECUENCIA
           FROM TBRACCD
          WHERE TBRACCD_PIDM = EDC.TBRACCD_PIDM;
       EXCEPTION
       WHEN OTHERS THEN
       VL_SECUENCIA:=0;
       END;

       IF EDC.TIPO = 'C' THEN
         VL_BALANCE := EDC.TBRACCD_AMOUNT;
         VL_PAID := NULL;
       ELSIF EDC.TIPO = 'P' THEN
         VL_BALANCE := (EDC.TBRACCD_AMOUNT*-1);
         VL_PAID := VL_SECUENCIA+1;
       END IF;

       IF TRUNC(EDC.TBRACCD_EFFECTIVE_DATE)< TRUNC(SYSDATE) THEN
         VL_FECHA_VENC:= TRUNC(SYSDATE);
       ELSE
         VL_FECHA_VENC:= EDC.TBRACCD_EFFECTIVE_DATE;
       END IF;

       BEGIN
        INSERTA_TBRACCD := PKG_FINANZAS.F_INSERTA_TBRACCD ( EDC.TBRACCD_PIDM,
                                                            VL_SECUENCIA,
                                                            VL_PAID,
                                                            EDC.TBRACCD_TERM_CODE,
                                                            EDC.TBRACCD_PERIOD,
                                                            EDC.TBRACCD_DETAIL_CODE,
                                                            EDC.TBRACCD_AMOUNT,
                                                            VL_BALANCE,
                                                            VL_FECHA_VENC,
                                                            EDC.TBRACCD_DESC,
                                                            EDC.TBRACCD_STSP_KEY_SEQUENCE,
                                                            EDC.TBRACCD_CREATE_SOURCE,
                                                            EDC.TBRACCD_FEED_DATE);
       END;

       BEGIN
         UPDATE TBRACCD
            SET TBRACCD_DOCUMENT_NUMBER = 'REB_BAJA'
          WHERE     TBRACCD_PIDM = EDC.TBRACCD_PIDM
                AND TBRACCD_TRAN_NUMBER = EDC.TBRACCD_TRAN_NUMBER;
       EXCEPTION
       WHEN OTHERS THEN
        VL_ERROR :=' Errror al actualizar saldo Saldo>>  ' || SQLERRM ;
       END;


     END LOOP;
   END IF;

   BEGIN
     FOR TRAM IN (

      SELECT  TBRACCD_PIDM,
                TBRACCD_TRAN_NUMBER,
                TBRACCD_TERM_CODE,
                TBRACCD_DETAIL_CODE,
                TBRACCD_AMOUNT,
                TBRACCD_BALANCE,
                TBRACCD_DESC,
                TBRACCD_USER,
                TBRACCD_ENTRY_DATE,
                TBRACCD_EFFECTIVE_DATE,
                TBRACCD_SRCE_CODE,
                TBRACCD_ACCT_FEED_IND,
                TBRACCD_ACTIVITY_DATE,
                TBRACCD_SESSION_NUMBER,
                TBRACCD_SURROGATE_ID,
                TBRACCD_VERSION,
                TBRACCD_STSP_KEY_SEQUENCE,
                TBRACCD_PERIOD,
                TBRACCD_FEED_DATE,
                TBRACCD_RECEIPT_NUMBER
       FROM TBRACCD A
       WHERE A.TBRACCD_PIDM = P_PIDM
       AND A.TBRACCD_EFFECTIVE_DATE >= P_FECHA_INICIO
       AND SUBSTR(A.TBRACCD_DETAIL_CODE,3,2) IN ('AH','AI','7X','7W')
       AND TBRACCD_TRAN_NUMBER IN (SELECT MAX(TBRACCD_TRAN_NUMBER)
                                     FROM TBRACCD
                                    WHERE     TBRACCD_PIDM = A.TBRACCD_PIDM
                                          AND TBRACCD_EFFECTIVE_DATE >= P_FECHA_INICIO
                                          AND SUBSTR(TBRACCD_DETAIL_CODE,3,2) IN SUBSTR(A.TBRACCD_DETAIL_CODE,3,2)
       )

     )LOOP

       PKG_FINANZAS.P_DESAPLICA_PAGOS (TRAM.TBRACCD_PIDM,TRAM.TBRACCD_TRAN_NUMBER);

       IF SUBSTR (TRAM.TBRACCD_DETAIL_CODE,3,2) = 'M3' THEN
        VL_CODIGO           := SUBSTR (TRAM.TBRACCD_TERM_CODE, 1, 2) || 'ON';
        VL_DESCRIPCION      :='CANCELACION DE PROMOCION';

       ELSIF SUBSTR (TRAM.TBRACCD_DETAIL_CODE,3,2) IN ('AH') THEN
        VL_CODIGO           := SUBSTR (TRAM.TBRACCD_TERM_CODE, 1, 2) || 'PL';
        VL_DESCRIPCION      :='CANCELACION BAJA DEFINITIVA';

       ELSIF SUBSTR (TRAM.TBRACCD_DETAIL_CODE,3,2) IN ('AI') THEN
        VL_CODIGO           := SUBSTR (TRAM.TBRACCD_TERM_CODE, 1, 2) || 'PH';
        VL_DESCRIPCION      :='CANCELACION DE BAJA TEMPORAL';

       ELSIF SUBSTR (TRAM.TBRACCD_DETAIL_CODE,3,2) = '7X' THEN
        VL_CODIGO           := SUBSTR (TRAM.TBRACCD_TERM_CODE, 1, 2) || '7Z';
        VL_DESCRIPCION      :='CANCELA DSC  BAJA DEFI ENCUEST';

       ELSIF SUBSTR (TRAM.TBRACCD_DETAIL_CODE,3,2) = '7W' THEN
        VL_CODIGO           := SUBSTR (TRAM.TBRACCD_TERM_CODE, 1, 2) || '7Y';
        VL_DESCRIPCION      :='CANCELA DSC  BAJA TEMP ENCUEST';
       END IF;

       BEGIN
          VL_APL_AJUSTE :=
             PKG_FINANZAS.SP_APLICA_AJUSTE ( TRAM.TBRACCD_PIDM,
                                             TRAM.TBRACCD_TRAN_NUMBER,
                                             VL_CODIGO,
                                             TRAM.TBRACCD_AMOUNT,
                                             TRAM.TBRACCD_TERM_CODE,
                                             VL_DESCRIPCION,
                                             SYSDATE,
                                             TRAM.TBRACCD_STSP_KEY_SEQUENCE,
                                             TRAM.TBRACCD_FEED_DATE,
                                             TRAM.TBRACCD_PERIOD,
                                             'SZFABCC');
       EXCEPTION
       WHEN OTHERS THEN
       NULL;
       END;

       BEGIN
         UPDATE TBRACCD
            SET TBRACCD_DOCUMENT_NUMBER = 'REB_BAJA'
          WHERE     TBRACCD_PIDM = TRAM.TBRACCD_PIDM
                AND TBRACCD_DETAIL_CODE = VL_CODIGO
                AND TBRACCD_USER = 'SZFABCC'
                AND TRUNC(TBRACCD_EFFECTIVE_DATE) = TRUNC(SYSDATE);
       EXCEPTION
       WHEN OTHERS THEN
        VL_ERROR :=' Errror al actualizar saldo Saldo>>  ' || SQLERRM ;
       END;

     END LOOP;
   END;
  COMMIT;
 RETURN(VL_ERROR);
END F_CARTERA_REVERSION_BAJA;

FUNCTION F_BECA_COLABORADOR ( P_CAMP IN VARCHAR2,
                              P_NIVEL IN VARCHAR2,
                              P_PIDM IN NUMBER,
                              P_FECHA IN DATE,
                              P_PROGRAM IN VARCHAR2,
                              P_PROMEDIO IN NUMBER) RETURN VARCHAR2 IS
/*
    Proceso encargado de realizar ajuste de beca para colaboradores
    Autor JREZAOLI
    Fecha 14/07/2020
*/

VL_VALIDACION           NUMBER;
VL_CODIGO               VARCHAR2(5);
VL_DESCRIP              VARCHAR2(50);
VL_FECHA_EFF            DATE;
VL_RESP                 VARCHAR2(500);
VL_AJUSTES              NUMBER;
VL_MONTO                NUMBER;
VL_ERROR                VARCHAR2(500);
VL_APLI_PAG             NUMBER;

 BEGIN

     BEGIN
       SELECT ZSTPARA_PARAM_VALOR
         INTO VL_VALIDACION
         FROM ZSTPARA
        WHERE 1=1
        AND ZSTPARA_MAPA_ID = 'COLAB_PROME'
        AND SUBSTR(ZSTPARA_PARAM_ID,1,3) = P_CAMP
        AND SUBSTR(ZSTPARA_PARAM_ID,4,2) = P_NIVEL;
     EXCEPTION
     WHEN OTHERS THEN
     VL_VALIDACION := 100;
     END;
      --DBMS_OUTPUT.PUT_LINE('BECA 3 = '||VL_VALIDACION);

     IF P_PROMEDIO >= VL_VALIDACION THEN

        VL_ERROR:='EXITO';

       BEGIN

          FOR ALUMNO IN (

                          SELECT A.*
                            FROM TBRACCD A,TBBDETC
                           WHERE     A.TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
                                 AND A.TBRACCD_PIDM = P_PIDM
                                 AND A.TBRACCD_FEED_DATE = P_FECHA
                                 AND A.TBRACCD_CREATE_SOURCE = 'TZFEDCA (PARC)'
                                 AND TBBDETC_DCAT_CODE = 'COL'
                                 AND TBBDETC_DESC NOT LIKE '%NOTA%'
                                 AND TBBDETC_DESC != 'COLEGIATURA EXTRAORDINARIO'
                                 AND A.TBRACCD_DOCUMENT_NUMBER IS NULL
                                 AND A.TBRACCD_PIDM NOT IN (SELECT GORADID_PIDM
                                                              FROM GORADID
                                                             WHERE GORADID_ADID_CODE = 'FUTL')
                          UNION
                          SELECT A.*
                            FROM TBRACCD A,TBBDETC
                           WHERE     A.TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
                                 AND A.TBRACCD_PIDM = P_PIDM
                                 AND A.TBRACCD_EFFECTIVE_DATE > P_FECHA+10
                                 AND SUBSTR(A.TBRACCD_DETAIL_CODE,3,2) = 'X2'
                                 AND A.TBRACCD_DOCUMENT_NUMBER IS NULL
                                 AND A.TBRACCD_PIDM NOT IN (SELECT GORADID_PIDM
                                                              FROM GORADID
                                                             WHERE GORADID_ADID_CODE = 'FUTL')

         )LOOP

            DBMS_OUTPUT.PUT_LINE('BECA 1 = '||ALUMNO.TBRACCD_EFFECTIVE_DATE);

            VL_VALIDACION   :=NULL;
            VL_CODIGO       :=NULL;
            VL_DESCRIP      :=NULL;
            VL_FECHA_EFF    :=NULL;
            VL_RESP         :=NULL;
            VL_AJUSTES      :=NULL;
            VL_MONTO        :=NULL;
            VL_APLI_PAG     :=NULL;

           IF LAST_DAY(ALUMNO.TBRACCD_EFFECTIVE_DATE) < TRUNC(SYSDATE) THEN

             VL_FECHA_EFF:= TRUNC(SYSDATE);

             BEGIN
               SELECT ZSTPARA_PARAM_VALOR,TBBDETC_DESC
                 INTO VL_CODIGO,VL_DESCRIP
                 FROM ZSTPARA,TBBDETC
                WHERE     ZSTPARA_PARAM_VALOR = TBBDETC_DETAIL_CODE
                      AND ZSTPARA_MAPA_ID = 'COLAB_PROME'
                      AND SUBSTR(ZSTPARA_PARAM_ID,1,4) = 'COD_'
                      AND SUBSTR(ZSTPARA_PARAM_ID,5,3) = P_CAMP
                      AND SUBSTR(ZSTPARA_PARAM_ID,8,2) = P_NIVEL
                      AND SUBSTR(ZSTPARA_PARAM_ID,11,2) = 'VC';
             EXCEPTION
             WHEN OTHERS THEN
             VL_CODIGO:=NULL;
             VL_DESCRIP:=NULL;
             VL_ERROR:='ERROR = '||SQLERRM;
             END;

           ELSE

             VL_FECHA_EFF:= ALUMNO.TBRACCD_EFFECTIVE_DATE;

             BEGIN
               SELECT ZSTPARA_PARAM_VALOR,TBBDETC_DESC
                 INTO VL_CODIGO,VL_DESCRIP
                 FROM ZSTPARA,TBBDETC
                WHERE     ZSTPARA_PARAM_VALOR = TBBDETC_DETAIL_CODE
                      AND ZSTPARA_MAPA_ID = 'COLAB_PROME'
                      AND SUBSTR(ZSTPARA_PARAM_ID,1,4) = 'COD_'
                      AND SUBSTR(ZSTPARA_PARAM_ID,5,3) = P_CAMP
                      AND SUBSTR(ZSTPARA_PARAM_ID,8,2) = P_NIVEL
                      AND SUBSTR(ZSTPARA_PARAM_ID,11,2) = 'PR';
             EXCEPTION
             WHEN OTHERS THEN
             VL_CODIGO:=NULL;
             VL_DESCRIP:=NULL;
             VL_ERROR:='ERROR = '||SQLERRM;
             END;

           END IF;
            DBMS_OUTPUT.PUT_LINE('BECA 2 = '||VL_CODIGO||' = '||VL_DESCRIP);
           IF SUBSTR(ALUMNO.TBRACCD_DETAIL_CODE,3,2) = 'X2' THEN

             BEGIN
               SELECT COUNT(*)
                 INTO VL_AJUSTES
                 FROM TBRACCD
                WHERE     TBRACCD_PIDM = ALUMNO.TBRACCD_PIDM
                      AND TBRACCD_DESC LIKE '%INTERES%'
                      AND TBRACCD_TRAN_NUMBER = (SELECT TBRAPPL_PAY_TRAN_NUMBER
                                                   FROM TBRAPPL
                                                  WHERE     TBRAPPL_PIDM = ALUMNO.TBRACCD_PIDM
                                                        AND TBRAPPL_CHG_TRAN_NUMBER = ALUMNO.TBRACCD_TRAN_NUMBER
                                                        AND TBRAPPL_REAPPL_IND IS NULL);
             EXCEPTION
             WHEN OTHERS THEN
             VL_AJUSTES:=0;
             END;

           ELSE

             BEGIN
               SELECT COUNT(*)
                 INTO VL_AJUSTES
                 FROM TBRACCD
                WHERE     TBRACCD_PIDM = ALUMNO.TBRACCD_PIDM
                      AND TBRACCD_TRAN_NUMBER_PAID = ALUMNO.TBRACCD_TRAN_NUMBER
                      AND TBRACCD_DETAIL_CODE = VL_CODIGO;
             EXCEPTION
             WHEN OTHERS THEN
             VL_AJUSTES:=0;
             END;

           END IF;
           DBMS_OUTPUT.PUT_LINE('BECA 3 = '||VL_AJUSTES||' = '||ALUMNO.TBRACCD_TRAN_NUMBER);
           IF VL_AJUSTES = 0 THEN

             BEGIN
               SELECT COUNT(*)
                 INTO VL_APLI_PAG
                 FROM TBRACCD
                WHERE    TBRACCD_PIDM = ALUMNO.TBRACCD_PIDM
                     AND TBRACCD_DESC LIKE '%BECA%'
                     AND TBRACCD_TRAN_NUMBER IN (SELECT TBRAPPL_PAY_TRAN_NUMBER
                                                   FROM TBRAPPL
                                                  WHERE     TBRAPPL_PIDM = ALUMNO.TBRACCD_PIDM
                                                        AND TBRAPPL_CHG_TRAN_NUMBER = ALUMNO.TBRACCD_TRAN_NUMBER
                                                        AND TBRAPPL_REAPPL_IND IS NULL);
             END;

             IF VL_APLI_PAG = 0 THEN
                 VL_MONTO:= ALUMNO.TBRACCD_AMOUNT;
             ELSE
                 VL_MONTO:= 0;
             END IF;

           ELSE

            VL_MONTO:= 0;

           END IF;
           DBMS_OUTPUT.PUT_LINE('BECA 4 = '||VL_MONTO);
           IF SUBSTR(ALUMNO.TBRACCD_DETAIL_CODE,3,2) = 'X2' THEN

             VL_CODIGO:=SUBSTR(ALUMNO.TBRACCD_DETAIL_CODE,1,2)||74;
             VL_DESCRIP:='CANCELACION INTERES PGO TARDIO';

           END IF;

           IF VL_MONTO > 0 THEN

               PKG_FINANZAS.P_DESAPLICA_PAGOS(ALUMNO.TBRACCD_PIDM,ALUMNO.TBRACCD_TRAN_NUMBER);

               VL_RESP := PKG_FINANZAS.SP_APLICA_AJUSTE (ALUMNO.TBRACCD_PIDM,
                                                         ALUMNO.TBRACCD_TRAN_NUMBER,
                                                         VL_CODIGO,
                                                         VL_MONTO,
                                                         ALUMNO.TBRACCD_TERM_CODE,
                                                         VL_DESCRIP,
                                                         VL_FECHA_EFF,
                                                         ALUMNO.TBRACCD_STSP_KEY_SEQUENCE,
                                                         ALUMNO.TBRACCD_FEED_DATE,
                                                         ALUMNO.TBRACCD_PERIOD,
                                                         USER);

             DBMS_OUTPUT.PUT_LINE('BECA 5 = '||VL_RESP);
           END IF;

           BEGIN
             UPDATE TBRACCD
                SET TBRACCD_DOCUMENT_NUMBER = 'BECA COL',
                    TBRACCD_CREATE_SOURCE ='BECA COLABORADOR'
              WHERE     TBRACCD_PIDM = P_PIDM
                    AND TBRACCD_FEED_DATE = P_FECHA
                    AND TBRACCD_DETAIL_CODE = VL_CODIGO
                    AND TRUNC(TBRACCD_ENTRY_DATE) = TRUNC(SYSDATE)
                    AND TBRACCD_DOCUMENT_NUMBER IS NULL;
           END;

           BEGIN
             UPDATE TVRACCD
                SET TVRACCD_DOCUMENT_NUMBER = 'BECA COL',
                    TVRACCD_CREATE_SOURCE ='BECA COLABORADOR'
              WHERE     TVRACCD_PIDM = P_PIDM
                    AND TVRACCD_FEED_DATE = P_FECHA
                    AND TVRACCD_DETAIL_CODE = VL_CODIGO
                    AND TRUNC(TVRACCD_ENTRY_DATE) = TRUNC(SYSDATE)
                    AND TVRACCD_DOCUMENT_NUMBER IS NULL
               ;

           END;
         END LOOP;
       END;

     ELSE

        VL_ERROR:= 'PROMEDIO INSUFICIENTE PARA RECIBIR BECA '||P_PROMEDIO;

     END IF;

   COMMIT;
  RETURN(VL_ERROR);
 END F_BECA_COLABORADOR;

Function F_MONTO_INCREMENTO (P_CAMPUS VARCHAR2, P_NIVEL VARCHAR2, P_MESES IN NUMBER, P_FECHA_MATERIA DATE) return number IS
vl_porcentaje number:=0;

BEGIN

--dbms_output.put_line('Entrada'||P_CAMPUS ||'*'||P_NIVEL||'*'||P_MESES);

        Begin

                select  distinct TZTCINC_PORC--, a.TZTCINC_VIGENCIA
                    Into vl_porcentaje
                from TZTCINC a
                where A.TZTCINC_CAMP = P_CAMPUS
                And A.TZTCINC_LEVL = P_NIVEL
                And A.TZTCINC_VIGENCIA = P_MESES
                And trunc (a.TZTCINC_FECH_INI) >= trunc (P_FECHA_MATERIA);
              --P_NIVEL--  dbms_output.put_line('Entrada inicio1 '||vl_porcentaje);

        Exception
              When no_data_found then
                Begin
                        select  distinct TZTCINC_PORC--, a.TZTCINC_VIGENCIA
                            Into vl_porcentaje
                        from TZTCINC a
                        where A.TZTCINC_CAMP = P_CAMPUS
                        And A.TZTCINC_LEVL = P_NIVEL
                        And A.TZTCINC_VIGENCIA = P_MESES;
                        dbms_output.put_line('Entrada inicio2 '||vl_porcentaje);

                Exception
                    When no_data_found then
                         Begin
                         -- dbms_output.put_line('Entrada inicio 3 '||vl_porcentaje||'*'|| sqlerrm);
                                select  distinct TZTCINC_PORC--, a.TZTCINC_VIGENCIA
                                    Into vl_porcentaje
                                from TZTCINC a
                                where A.TZTCINC_CAMP = P_CAMPUS
                                And A.TZTCINC_LEVL = P_NIVEL
                                And A.TZTCINC_VIGENCIA < P_MESES
                                And a.TZTCINC_VIGENCIA = (select max (a1.TZTCINC_VIGENCIA)
                                                                            from TZTCINC a1
                                                                            Where a.TZTCINC_CAMP = a1.TZTCINC_CAMP
                                                                            And a.TZTCINC_LEVL = a1.TZTCINC_LEVL
                                                                            And a1.TZTCINC_VIGENCIA < P_MESES
                                                                          ) ;
                         Exception
                            When Others then
                                vl_porcentaje:=0;
                               -- dbms_output.put_line('Entrada inicio 4 '||vl_porcentaje||'*'|| sqlerrm);
                         End;
                       --  dbms_output.put_line('Entrada inicio 5 '||vl_porcentaje||'*'|| sqlerrm);
                End;
        End;

       Return vl_porcentaje;

END F_MONTO_INCREMENTO;

Function F_TIPO_INCREMENTO (P_CAMPUS VARCHAR2, P_NIVEL VARCHAR2, P_MESES IN NUMBER, P_FECHA_MATERIA DATE) return varchar2 IS
vl_porcentaje varchar2(1):=null;

BEGIN

--dbms_output.put_line('Entrada'||P_CAMPUS ||'*'||P_NIVEL||'*'||P_MESES);

        Begin

                select  distinct TZTCINC_ACUMULA--, a.TZTCINC_VIGENCIA
                    Into vl_porcentaje
                from TZTCINC a
                where A.TZTCINC_CAMP = P_CAMPUS
                And A.TZTCINC_LEVL = P_NIVEL
                And A.TZTCINC_VIGENCIA = P_MESES
                And a.TZTCINC_FECH_INI >= P_FECHA_MATERIA;
             --   dbms_output.put_line('Entrada inicio '||vl_porcentaje);

        Exception
              When no_data_found then
                Begin
                        select  distinct TZTCINC_ACUMULA--, a.TZTCINC_VIGENCIA
                            Into vl_porcentaje
                        from TZTCINC a
                        where A.TZTCINC_CAMP = P_CAMPUS
                        And A.TZTCINC_LEVL = P_NIVEL
                        And A.TZTCINC_VIGENCIA = P_MESES;
                       -- dbms_output.put_line('Entrada inicio '||vl_porcentaje);

                Exception
                    When no_data_found then
                         Begin
                       --   dbms_output.put_line('Entrada inicio 2 '||vl_porcentaje||'*'|| sqlerrm);
                                select  distinct TZTCINC_ACUMULA--, a.TZTCINC_VIGENCIA
                                    Into vl_porcentaje
                                from TZTCINC a
                                where A.TZTCINC_CAMP = P_CAMPUS
                                And A.TZTCINC_LEVL = P_NIVEL
                                And A.TZTCINC_VIGENCIA < P_MESES
                                And a.TZTCINC_VIGENCIA = (select max (a1.TZTCINC_VIGENCIA)
                                                                            from TZTCINC a1
                                                                            Where a.TZTCINC_CAMP = a1.TZTCINC_CAMP
                                                                            And a.TZTCINC_LEVL = a1.TZTCINC_LEVL
                                                                            And a1.TZTCINC_VIGENCIA < P_MESES
                                                                          ) ;
                         Exception
                            When Others then
                                vl_porcentaje:=null;
                                --dbms_output.put_line('Entrada inicio 3 '||vl_porcentaje||'*'|| sqlerrm);
                         End;
                        -- dbms_output.put_line('Entrada inicio 4 '||vl_porcentaje||'*'|| sqlerrm);
                End;
        End;



       Return vl_porcentaje;

END F_TIPO_INCREMENTO;


Function F_FECHA_INCREMENTO (P_CAMPUS VARCHAR2, P_NIVEL VARCHAR2, P_MESES IN NUMBER, P_FECHA_MATERIA DATE) return varchar2 IS
vl_porcentaje varchar2(50):=null;

BEGIN

--dbms_output.put_line('Entrada'||P_CAMPUS ||'*'||P_NIVEL||'*'||P_MESES);

        Begin

                select  distinct TZTCINC_FECH_INI--, a.TZTCINC_VIGENCIA
                    Into vl_porcentaje
                from TZTCINC a
                where A.TZTCINC_CAMP = P_CAMPUS
                And A.TZTCINC_LEVL = P_NIVEL
                And A.TZTCINC_VIGENCIA = P_MESES
                And a.TZTCINC_FECH_INI >= P_FECHA_MATERIA;
               -- dbms_output.put_line('Entrada inicio '||vl_porcentaje);

        Exception
              When no_data_found then
                Begin
                        select  distinct TZTCINC_FECH_INI--, a.TZTCINC_VIGENCIA
                            Into vl_porcentaje
                        from TZTCINC a
                        where A.TZTCINC_CAMP = P_CAMPUS
                        And A.TZTCINC_LEVL = P_NIVEL
                        And A.TZTCINC_VIGENCIA = P_MESES;
                     ---   dbms_output.put_line('Entrada inicio '||vl_porcentaje);

                Exception
                    When no_data_found then
                         Begin
                        --  dbms_output.put_line('Entrada inicio 2 '||vl_porcentaje||'*'|| sqlerrm);
                                select  distinct TZTCINC_FECH_INI--, a.TZTCINC_VIGENCIA
                                    Into vl_porcentaje
                                from TZTCINC a
                                where A.TZTCINC_CAMP = P_CAMPUS
                                And A.TZTCINC_LEVL = P_NIVEL
                                And A.TZTCINC_VIGENCIA < P_MESES
                                And a.TZTCINC_VIGENCIA = (select max (a1.TZTCINC_VIGENCIA)
                                                                            from TZTCINC a1
                                                                            Where a.TZTCINC_CAMP = a1.TZTCINC_CAMP
                                                                            And a.TZTCINC_LEVL = a1.TZTCINC_LEVL
                                                                            And a1.TZTCINC_VIGENCIA < P_MESES
                                                                          ) ;
                         Exception
                            When Others then
                                vl_porcentaje:=null;
                             --   dbms_output.put_line('Entrada inicio 3 '||vl_porcentaje||'*'|| sqlerrm);
                         End;
                       --  dbms_output.put_line('Entrada inicio 4 '||vl_porcentaje||'*'|| sqlerrm);
                End;
        End;



       Return vl_porcentaje;

END F_FECHA_INCREMENTO;

Function F_PORC_INCREMENTO (P_PIDM NUMBER, P_PROGRAMA VARCHAR2, P_FECHA_INI IN date) return number Is

vl_porcentaje number;

Begin

        Begin
                 SELECT distinct TZDOCTR_PORC_INCREM
                   INTO vl_porcentaje
                   FROM TZDOCTR A
                  WHERE     A.TZDOCTR_PIDM = P_PIDM
                        AND A.TZDOCTR_PROGRAM =P_PROGRAMA
                        AND trunc (A.TZDOCTR_START_DATE)  < P_FECHA_INI
                        AND A.TZDOCTR_START_DATE = (SELECT MAX(TZDOCTR_START_DATE)
                                                      FROM TZDOCTR
                                                     WHERE TZDOCTR_PIDM = A.TZDOCTR_PIDM
                                                           AND TZDOCTR_PROGRAM = A.TZDOCTR_PROGRAM
                                                           AND trunc (TZDOCTR_START_DATE) < P_FECHA_INI
                                                           --AND TZDOCTR_TIPO_PROC = 'ARGE'
                                                           )
                        And TZDOCTR_PORC_INCREM is not null;
        Exception
            When Others then
                vl_porcentaje:=0;
        End;
       Return vl_porcentaje;


End F_PORC_INCREMENTO;


Function F_NUM_INCREMENTO (P_PIDM NUMBER, P_PROGRAMA VARCHAR2, P_FECHA_INI IN date) return number Is

vl_porcentaje number;

Begin

        Begin
                 SELECT COUNT(1)
                   INTO vl_porcentaje
                   FROM TZDOCTR A
                  WHERE     A.TZDOCTR_PIDM = P_PIDM
                        AND A.TZDOCTR_PROGRAM =P_PROGRAMA
                        AND trunc (A.TZDOCTR_START_DATE)  != P_FECHA_INI
--                        AND A.TZDOCTR_START_DATE = (SELECT MAX(TZDOCTR_START_DATE)
--                                                      FROM TZDOCTR
--                                                     WHERE TZDOCTR_PIDM = A.TZDOCTR_PIDM
--                                                           AND TZDOCTR_PROGRAM = A.TZDOCTR_PROGRAM
--                                                           AND trunc (TZDOCTR_START_DATE) != P_FECHA_INI
--                                                           --AND TZDOCTR_TIPO_PROC = 'ARGE'
--                                                           )
                        And TZDOCTR_PORC_INCREM is not null;

                  If vl_porcentaje = 0 then
                      vl_porcentaje:=1;
                  end if;
        Exception
            When Others then
                vl_porcentaje:=1;
        End;
       Return vl_porcentaje;


End F_NUM_INCREMENTO;


Function F_MES_INCREMENTO (P_CAMPUS VARCHAR2, P_NIVEL VARCHAR2, P_MESES IN NUMBER, P_FECHA_MATERIA DATE) return number is

vl_porcentaje number:=0;

BEGIN

--dbms_output.put_line('Entrada'||P_CAMPUS ||'*'||P_NIVEL||'*'||P_MESES);

        Begin

                select  distinct TZTCINC_VIGENCIA--, a.TZTCINC_VIGENCIA
                    Into vl_porcentaje
                from TZTCINC a
                where A.TZTCINC_CAMP = P_CAMPUS
                And A.TZTCINC_LEVL = P_NIVEL
                And A.TZTCINC_VIGENCIA = P_MESES
                And a.TZTCINC_FECH_INI >= P_FECHA_MATERIA;
              --  dbms_output.put_line('Entrada inicio '||vl_porcentaje);

        Exception
              When no_data_found then
                Begin
                        select  distinct TZTCINC_VIGENCIA--, a.TZTCINC_VIGENCIA
                            Into vl_porcentaje
                        from TZTCINC a
                        where A.TZTCINC_CAMP = P_CAMPUS
                        And A.TZTCINC_LEVL = P_NIVEL
                        And A.TZTCINC_VIGENCIA = P_MESES;
                       -- dbms_output.put_line('Entrada inicio '||vl_porcentaje);

                Exception
                    When no_data_found then
                         Begin
                        --  dbms_output.put_line('Entrada inicio 2 '||vl_porcentaje||'*'|| sqlerrm);
                                select  distinct TZTCINC_VIGENCIA--, a.TZTCINC_VIGENCIA
                                    Into vl_porcentaje
                                from TZTCINC a
                                where A.TZTCINC_CAMP = P_CAMPUS
                                And A.TZTCINC_LEVL = P_NIVEL
                                And A.TZTCINC_VIGENCIA < P_MESES
                                And a.TZTCINC_VIGENCIA = (select max (a1.TZTCINC_VIGENCIA)
                                                                            from TZTCINC a1
                                                                            Where a.TZTCINC_CAMP = a1.TZTCINC_CAMP
                                                                            And a.TZTCINC_LEVL = a1.TZTCINC_LEVL
                                                                            And a1.TZTCINC_VIGENCIA < P_MESES
                                                                          ) ;
                         Exception
                            When Others then
                                vl_porcentaje:=1;
                                --dbms_output.put_line('Entrada inicio 3 '||vl_porcentaje||'*'|| sqlerrm);
                         End;
                     ---    dbms_output.put_line('Entrada inicio 4 '||vl_porcentaje||'*'|| sqlerrm);
                End;
        End;

       Return vl_porcentaje;

END F_MES_INCREMENTO;

Function F_NUM_MESES (P_PIDM NUMBER, P_PROGRAMA VARCHAR2, P_FECHA_INI IN date) return number Is

vl_porcentaje number:=0;
vl_meses number:=0;

Begin

             vl_porcentaje:=0;

                Begin
                    Select max (x.TZDOCTR_PORC_INCREM)
                        Into  vl_porcentaje
                    from (
                            Select distinct   a.TZDOCTR_PORC_INCREM
                               from  TZDOCTR a
                               where a.TZDOCTR_PIDM = P_PIDM
                                AND a.TZDOCTR_TIPO_PROC = 'AUME'
                                And a.TZDOCTR_PORC_INCREM > 0
                                And a.TZDOCTR_PROGRAM = P_PROGRAMA
                                and trunc (a.TZDOCTR_START_DATE) < P_FECHA_INI
                           ) x  ;
                Exception
                When others then
                    vl_porcentaje:=0;
                End;

               If vl_porcentaje > 0 then

                      Begin
                                Select max (x.meses)
                                    Into vl_meses
                                from (
                               Select distinct ROUND(MONTHS_BETWEEN(TO_DATE(P_FECHA_INI),TO_DATE(a.TZDOCTR_START_DATE))) meses
                               from  TZDOCTR a
                               where a.TZDOCTR_PIDM = P_PIDM
                                AND a.TZDOCTR_TIPO_PROC = 'AUME'
                                And a.TZDOCTR_PROGRAM = P_PROGRAMA
                                And a.TZDOCTR_PORC_INCREM = vl_porcentaje
                                and trunc (a.TZDOCTR_START_DATE) < P_FECHA_INI
                                ) x;

                     Exception
                        When Others then
                            vl_meses:=0;
                     End;
              Else
              vl_meses:=0;

              End if;

   Return vl_meses;

End F_NUM_MESES ;

 Function F_NUM_MINIMO (P_CAMPUS VARCHAR2, P_NIVEL VARCHAR2,  P_FECHA_MATERIA DATE) return number Is

vl_porcentaje number:=0;

BEGIN

--dbms_output.put_line('Entrada'||P_CAMPUS ||'*'||P_NIVEL||'*'||P_MESES);

        Begin

                select  distinct a.TZTCINC_VIGENCIA--, a.TZTCINC_VIGENCIA
                    Into vl_porcentaje
                from TZTCINC a
                where A.TZTCINC_CAMP = P_CAMPUS
                And A.TZTCINC_LEVL = P_NIVEL
                And trunc (a.TZTCINC_FECH_INI) >= trunc (P_FECHA_MATERIA)
                ANd a.TZTCINC_VIGENCIA = (select min (a1.TZTCINC_VIGENCIA)
                                                        from TZTCINC a1
                                                        where 1= 1
                                                        and a.TZTCINC_CAMP = a1.TZTCINC_CAMP
                                                        And a.TZTCINC_LEVL = a1.TZTCINC_LEVL
                                                     ) ;
              --  dbms_output.put_line('Entrada inicio1 '||vl_porcentaje);

        Exception
              When no_data_found then
                Begin
                        select  distinct a.TZTCINC_VIGENCIA--, a.TZTCINC_VIGENCIA
                            Into vl_porcentaje
                        from TZTCINC a
                        where A.TZTCINC_CAMP = P_CAMPUS
                        And A.TZTCINC_LEVL = P_NIVEL
                        ANd a.TZTCINC_VIGENCIA = (select min (a1.TZTCINC_VIGENCIA)
                                                                from TZTCINC a1
                                                                where 1= 1
                                                                and a.TZTCINC_CAMP = a1.TZTCINC_CAMP
                                                                And a.TZTCINC_LEVL = a1.TZTCINC_LEVL
                                                             ) ;
                                        --  dbms_output.put_line('Entrada inicio2 '||vl_porcentaje);


                Exception
                    When Others then
                        vl_porcentaje:=0;
                      --  dbms_output.put_line('Entrada inicio 4 '||vl_porcentaje||'*'|| sqlerrm);
                End;

        When Others then
                vl_porcentaje:=0;
               --  dbms_output.put_line('Entrada inicio 5 '||vl_porcentaje||'*'|| sqlerrm);
        End;

       Return vl_porcentaje;


  End F_NUM_MINIMO;


  Function F_PORC_MINIMO (P_CAMPUS VARCHAR2, P_NIVEL VARCHAR2,  P_FECHA_MATERIA DATE) return number Is

vl_porcentaje number:=0;

BEGIN

--dbms_output.put_line('Entrada'||P_CAMPUS ||'*'||P_NIVEL||'*'||P_MESES);

        Begin

                select  distinct a.TZTCINC_PORC--, a.TZTCINC_VIGENCIA
                    Into vl_porcentaje
                from TZTCINC a
                where A.TZTCINC_CAMP = P_CAMPUS
                And A.TZTCINC_LEVL = P_NIVEL
                And trunc (a.TZTCINC_FECH_INI) >= trunc (P_FECHA_MATERIA)
                ANd a.TZTCINC_VIGENCIA = (select min (a1.TZTCINC_VIGENCIA)
                                                        from TZTCINC a1
                                                        where 1= 1
                                                        and a.TZTCINC_CAMP = a1.TZTCINC_CAMP
                                                        And a.TZTCINC_LEVL = a1.TZTCINC_LEVL
                                                     ) ;
               -- dbms_output.put_line('Entrada inicio1 '||vl_porcentaje);

        Exception
              When no_data_found then
                Begin
                        select  distinct a.TZTCINC_PORC--, a.TZTCINC_VIGENCIA
                            Into vl_porcentaje
                        from TZTCINC a
                        where A.TZTCINC_CAMP = P_CAMPUS
                        And A.TZTCINC_LEVL = P_NIVEL
                        ANd a.TZTCINC_VIGENCIA = (select min (a1.TZTCINC_VIGENCIA)
                                                                from TZTCINC a1
                                                                where 1= 1
                                                                and a.TZTCINC_CAMP = a1.TZTCINC_CAMP
                                                                And a.TZTCINC_LEVL = a1.TZTCINC_LEVL
                                                             ) ;
                                         -- dbms_output.put_line('Entrada inicio2 '||vl_porcentaje);


                Exception
                    When Others then
                        vl_porcentaje:=0;
                      --  dbms_output.put_line('Entrada inicio 4 '||vl_porcentaje||'*'|| sqlerrm);
                End;

        When Others then
                vl_porcentaje:=0;
                -- dbms_output.put_line('Entrada inicio 5 '||vl_porcentaje||'*'|| sqlerrm);
        End;

       Return vl_porcentaje;


  End F_PORC_MINIMO;


Function f_exite_puni(p_pidm in number) return number is

vl_existe  number:=0;

Begin

        vl_existe:=0;
        Begin
                select distinct count(*)
                    Into vl_existe
                from tztpuni
                where 1= 1
                And TZTPUNI_PIDM = p_pidm
                and TZTPUNI_FINALIZADO = 0;
        Exception
            When Others then
            vl_existe:=0;
        End;

        Return vl_existe;

End f_exite_puni;


Procedure P_MAESTRIA_RESERVA_CARGO is

 vl_salida varchar2(500):= null;
 vl_secuencia number:=0;
 vl_descripcion varchar2(50):= null;
 vl_sp number:=0;

 Begin

        For cx in (

                        Select *
                        from tztpagm
                        where 1= 1
                        and aplicado = 'N'

                       ) loop

        vl_secuencia:=0;
        vl_secuencia:= PKG_FINANZAS.F_MAX_SEC_TBRACCD (cx.PIDM);
        Begin
                Select tbbdetc_desc
                    Into vl_descripcion
                from tbbdetc
                where TBBDETC_DETAIL_CODE = cx.codigo;
        Exception
            When Others then
              vl_descripcion:= null;
        End;

        Begin
                Select distinct TBRACCD_STSP_KEY_SEQUENCE
                    Into vl_sp
                from tbraccd
                where tbraccd_pidm = cx.PIDM;
        Exception
            When Others then
                vl_sp:=0;
        End;

               vl_salida:= PKG_FINANZAS.F_INSERTA_TBRACCD(
                                                                 P_PIDM => cx.PIDM
                                                               , P_SECUENCIA => vl_secuencia--vl_secuencia
                                                               , P_NUMBER_PAID => cx.TRANSACCION
                                                               , P_PERIODO => cx.PERIODO
                                                               , P_PARTE_PERIODO => null
                                                               , P_CODIGO => cx.codigo
                                                               , P_MONTO => cx.monto--vl_monto
                                                               , P_BALANCE => cx.monto
                                                               , P_FECHA_VENC => sysdate--sysdate
                                                               , P_DESCRIP => vl_descripcion
                                                               , P_STUDY_PATH => vl_sp+1
                                                               , P_ORIGEN => 'TZFEDCA (COL)'
                                                               , P_FECHA_INICIO => null) ;

                If vl_salida is null then
                    Begin
                            Update tztpagm
                            set aplicado ='S'
                            Where pidm = cx.pidm
                            And aplicado = 'N';
                    Exception
                        When Others then
                            null;
                    End;
                    Commit;
                Else
                    rollback;
                End if;



    End loop;

 End P_MAESTRIA_RESERVA_CARGO;


 Function f_cancela_membresia_utelx (P_PIDM NUMBER )return varchar2 as



vl_utelx  varchar2(2):= null;
vl_existe varchar2(250):= null;

Begin

    vl_utelx:= null;
    Begin
            Select SZTUTLX_DISABLE_IND
                Into vl_utelx
            from SZTUTLX a
            Where 1=1
            And a.SZTUTLX_PIDM = P_PIDM
            And a.SZTUTLX_SEQ_NO = (select max ( a1.SZTUTLX_SEQ_NO)
                                    from SZTUTLX a1
                                    Where 1=1
                                    And a.SZTUTLX_PIDM = a1.SZTUTLX_PIDM);
    Exception
        When Others then
            vl_utelx:= null;
    End;


    If vl_utelx = 'A' then
        Begin
             Insert into SZTUTLX
                  Select a.SZTUTLX_PIDM, a.SZTUTLX_ID, a.SZTUTLX_TERM_CODE, a.SZTUTLX_CAMP_CODE, a.SZTUTLX_LEVL_CODE, a.SZTUTLX_SEQ_NO+1 SZTUTLX_SEQ_NO,
                         0 SZTUTLX_STAT_IND, null SZTUTLX_OBS, 'I' SZTUTLX_DISABLE_IND, a.SZTUTLX_PWD, a.SZTUTLX_MDL_ID, user SZTUTLX_USER_INSERT,
                         sysdate SZTUTLX_ACTIVITY_DATE, null SZTUTLX_USER_UPDATE, null SZTUTLX_DATE_UPDATE, a.SZTUTLX_ROW1, a.SZTUTLX_ROW2, a.SZTUTLX_ROW3,
                         a.SZTUTLX_ROW4, a.SZTUTLX_ROW5 , user SZTUTLX_USER_BLOQUEO,  sysdate SZTUTLX_ACTIVITY_BLOQUEO, a.SZTUTLX_GRATIS, 
                         a.SZTUTLX_GRATIS_APLI, SZTUTLX_FREC_PAGO,SZTUTLX_MONTO_DESC, SZTUTLX_NUM_DESC,SZTUTLX_NUM_DESC_APLIC 
                  from SZTUTLX a
                        Where 1=1
                        And a.SZTUTLX_PIDM = P_PIDM
                        And a.SZTUTLX_SEQ_NO = (select max ( a1.SZTUTLX_SEQ_NO)
                                                from SZTUTLX a1
                                                Where 1=1
                                                And a.SZTUTLX_PIDM = a1.SZTUTLX_PIDM);
          vl_existe:= 'Exito';

        Exception
            When Others then
                vl_existe:= 'Se presento un error al bloquear la membreia'||Sqlerrm;
        End;

    End if;

   If vl_existe = 'Exito' then
       commit;
   Else
        Rollback;
   End if;

  Return vl_existe;


 End f_cancela_membresia_utelx;


FUNCTION F_DES_PAG_UNI_NW (P_PIDM IN NUMBER, P_FECHA IN DATE, P_FECHA_NW IN DATE default null) RETURN VARCHAR2 IS  --> Nueva funcion para Pago Anticipado se agrega el parametro de fecha de inicio de clares actual


/* Funcion para aplicar descuento de pago unico recurrente
  Autor         JREZAOLI
 Creado         13/09/2019
 Actualizado    11/03/2021
*/



VL_RESP             VARCHAR2(500);
VL_EXI_TBRA         NUMBER;
VL_ERROR            VARCHAR2(500):='EXITO';
VL_DESCUENTO        NUMBER;
VL_CADENA_ERROR     VARCHAR2(500);
VL_AJUSTES          NUMBER;
VL_DESC             VARCHAR2(35);
VL_FECHA_NEW        DATE;
VL_DIA              NUMBER;
VL_FECHA_FINAL      DATE;
VL_PAGO             NUMBER;
VL_FECHA_EFF        DATE;
VL_DESCUENTOS       NUMBER;
VL_FINAL            NUMBER;
VL_APLI_DESCU       NUMBER;
VL_FECHA_APLICA     DATE;
VL_NUM_APLICA       NUMBER;
VL_SECUENCIA        NUMBER;
VL_ENTRA            NUMBER;
vl_orden            number;
vl_moneda           varchar2(10):= null;
vl_existe_desc      number;


vl_fecha_ini   date;
vl_fecha_fin date;

 BEGIN

   -- DBMS_OUTPUT.PUT_LINE('inicia Registro  = '||P_FECHA);
   BEGIN

       SELECT COUNT(*)
       INTO VL_ENTRA
       FROM TZTPUNI
      WHERE         TZTPUNI_PIDM = P_PIDM
         --   AND  TZTPUNI_FECHA_INICIO = P_FECHA  
            AND (TZTPUNI_CHECK IS NULL OR TZTPUNI_CHECK = 0 OR TZTPUNI_CHECK = 1)
--                 OR
--                    (LAST_DAY(TZTPUNI_PROX_FECHA) = LAST_DAY(P_FECHA )+59
--                    AND TZTPUNI_CHECK = 1)
                ANd TZTPUNI_PIDM = P_PIDM
                AND     TZTPUNI_CHECH_FINAL IS NULL;
   Exception
    When Others then
        VL_ENTRA:=0;
   END;



   IF VL_ENTRA != 0 THEN

     --       DBMS_OUTPUT.PUT_LINE('Entrada Registro  = '||VL_ENTRA);

       BEGIN
         SELECT COUNT(*)
           INTO VL_EXI_TBRA
           FROM TBRACCD A,TBBDETC
          WHERE TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
                AND TBRACCD_PIDM = P_PIDM
                AND TBRACCD_FEED_DATE = P_FECHA
                AND TBBDETC_DCAT_CODE = 'COL'
                AND TBRACCD_DOCUMENT_NUMBER IS NULL;
              --  AND LAST_DAY(TRUNC(A.TBRACCD_EFFECTIVE_DATE)) >= LAST_DAY(TRUNC(SYSDATE-90)); --Se apaga para evitar que se muevan las fechas
       EXCEPTION
       WHEN OTHERS THEN
       VL_EXI_TBRA:=0;
       END;

       IF VL_EXI_TBRA > 0 THEN
       --     DBMS_OUTPUT.PUT_LINE('Existe  Registro Tbraccd = '||VL_EXI_TBRA);       

         BEGIN
           FOR DESCUENTO IN (
                               SELECT TZTPUNI_PIDM,
                                      TZTPUNI_ID,
                                      TZTPUNI_TERM_CODE,
                                      TZTPUNI_FECHA_INICIO,
                                      TO_NUMBER(TO_CHAR(TZTPUNI_FECHA_INICIO,'DD'))DIA,
                                      TO_NUMBER(NVL(TO_CHAR(TZTPUNI_PROX_FECHA,'DD'),'01'))DIAP,
                                      TZTPUNI_PROX_FECHA,
                                      TZTPUNI_MONTO,
                                      TZTPUNI_PORCENTAJE,
                                      TZTPUNI_CODIGO,
                                      TZTPUNI_REPLICA,
                                      TZTPUNI_VECES,
                                      TZTPUNI_APLI,
                                      TZTPUNI_CHECK,
                                      TZTPUNI_FINALIZADO,
                                      TZTPUNI_DATA_ORIGIN
                                 FROM TZTPUNI
                          WHERE         TZTPUNI_PIDM = P_PIDM
                               -- AND  TZTPUNI_FECHA_INICIO = P_FECHA  
                                            AND (TZTPUNI_CHECK IS NULL OR TZTPUNI_CHECK = 0 OR TZTPUNI_CHECK = 1)
--                                     OR
--                                        (LAST_DAY(TZTPUNI_PROX_FECHA) = LAST_DAY(P_FECHA )+59
--                                        AND TZTPUNI_CHECK = 1)
                                    AND     TZTPUNI_CHECH_FINAL IS NULL
                                    And TZTPUNI_PIDM = P_PIDM


           )LOOP

         --     DBMS_OUTPUT.PUT_LINE('Entra al Loop = '||DESCUENTO.TZTPUNI_ID);   

             IF (DESCUENTO.TZTPUNI_DATA_ORIGIN IS NULL OR DESCUENTO.TZTPUNI_DATA_ORIGIN != 'UNICO_SIU')THEN
                 VL_NUM_APLICA:= (DESCUENTO.TZTPUNI_REPLICA*DESCUENTO.TZTPUNI_VECES);
           --       DBMS_OUTPUT.PUT_LINE('Primer If = '||VL_NUM_APLICA); 
             ELSE
                 VL_NUM_APLICA:= DESCUENTO.TZTPUNI_VECES;
             --    DBMS_OUTPUT.PUT_LINE('Primer Else = '||VL_NUM_APLICA); 
             END IF;

             IF (DESCUENTO.TZTPUNI_CHECK IS NULL OR DESCUENTO.TZTPUNI_CHECK = 0) THEN
               --   DBMS_OUTPUT.PUT_LINE('Segundo If = '||DESCUENTO.TZTPUNI_CHECK);

                 BEGIN
                   SELECT COUNT(*)
                     INTO VL_PAGO
                     FROM TBRACCD A,TBBDETC
                    WHERE     TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
                          AND TBBDETC_DCAT_CODE = 'CSH'
                          AND TBRACCD_PIDM = P_PIDM
                          AND TBRACCD_AMOUNT >= DESCUENTO.TZTPUNI_MONTO;
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_PAGO:=0;
                 END;
                 --DBMS_OUTPUT.PUT_LINE('busca Pagos = '||VL_PAGO);

             ELSE

               VL_PAGO:=1;
                --DBMS_OUTPUT.PUT_LINE('busca Pagos = '||VL_PAGO);

             END IF;

                 BEGIN
                   SELECT COUNT(*)
                     INTO VL_DESCUENTOS
                     FROM TBRACCD
                    WHERE     TBRACCD_PIDM = P_PIDM
                          AND TBRACCD_DOCUMENT_NUMBER = 'PAGOUNIC'
                          AND TBRACCD_EFFECTIVE_DATE >= DESCUENTO.TZTPUNI_FECHA_INICIO;
                 EXCEPTION
                 WHEN OTHERS THEN
                 VL_DESCUENTOS:=0;
                 END;

                  --DBMS_OUTPUT.PUT_LINE('busca Descuento = '||VL_DESCUENTOS);

                   VL_APLI_DESCU:= VL_NUM_APLICA-VL_DESCUENTOS;

                   --DBMS_OUTPUT.PUT_LINE('busca Descuento para aplicar = '||VL_APLI_DESCU);

             IF (DESCUENTO.TZTPUNI_CHECK = 0 OR DESCUENTO.TZTPUNI_CHECK IS NULL ) THEN

               -- DBMS_OUTPUT.PUT_LINE('Valida el Check '||DESCUENTO.TZTPUNI_CHECK);


               IF DESCUENTO.TZTPUNI_FINALIZADO = 1 THEN
                   VL_FECHA_APLICA := DESCUENTO.TZTPUNI_FECHA_INICIO;
                 --  DBMS_OUTPUT.PUT_LINE('Valida el Check 1 '||VL_FECHA_APLICA);
               ELSE
                   VL_FECHA_APLICA := TRUNC(SYSDATE);
                   --DBMS_OUTPUT.PUT_LINE('Valida el Check 0 '||VL_FECHA_APLICA);
               END IF;

             ELSE
                 VL_FECHA_APLICA := TRUNC(SYSDATE);
             END IF;

             IF VL_PAGO > 0 THEN
                --DBMS_OUTPUT.PUT_LINE('Tiene el Monto PAGADO '||VL_PAGO);

                ----- Valida que no este registrado el descuento para el periodo de fecha de inicio  ------
                vl_existe_desc:=0;
                Begin
                        Select count (1)
                         Into vl_existe_desc
                        from tbraccd 
                        where 1=1
                        and tbraccd_pidm = P_PIDM
                        and tbraccd_detail_code = descuento.TZTPUNI_CODIGO
                        AND TBRACCD_FEED_DATE = P_FECHA_NW;
                Exception
                 when others then 
                  vl_existe_desc:=0;
                End;

               If vl_existe_desc = 0 then 

                   BEGIN
                     FOR ALUMNO IN (
                                     SELECT A.*,ROW_NUMBER()OVER (PARTITION BY A.TBRACCD_PIDM ORDER BY A.TBRACCD_EFFECTIVE_DATE)SECU
                                       FROM TBRACCD A,TBBDETC
                                      WHERE     A.TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
                                            AND A.TBRACCD_PIDM = P_PIDM
                                            AND A.TBRACCD_FEED_DATE = P_FECHA_NW
                                            AND TBBDETC_DCAT_CODE = 'COL'
                                            AND TBBDETC_DESC LIKE 'COLEGIATURA%'
                                            AND TBBDETC_DESC != 'COLEGIATURA EXTRAORDINARIO'
                                            AND A.TBRACCD_DOCUMENT_NUMBER IS NULL
                                         --   AND LAST_DAY(TRUNC(A.TBRACCD_EFFECTIVE_DATE)) >= LAST_DAY(TRUNC(VL_FECHA_APLICA))

                     )LOOP

                  --      DBMS_OUTPUT.PUT_LINE('LLega al segundo Loop');

                       IF DESCUENTO.TZTPUNI_DATA_ORIGIN = 'UNICO_SIU_V' THEN 
                    --    DBMS_OUTPUT.PUT_LINE('Entra al IF de Data');
                        VL_DESCUENTO:=ROUND(ALUMNO.TBRACCD_BALANCE*(DESCUENTO.TZTPUNI_PORCENTAJE/100),2);
                      --  DBMS_OUTPUT.PUT_LINE('Descuento If'||VL_DESCUENTO);

                       ELSE

                        VL_DESCUENTO:=ROUND(ALUMNO.TBRACCD_AMOUNT*(DESCUENTO.TZTPUNI_PORCENTAJE/100),2);
                        --DBMS_OUTPUT.PUT_LINE('Descuento ELSE'||VL_DESCUENTO);

                       END IF;

                       IF (DESCUENTO.TZTPUNI_DATA_ORIGIN IS NULL OR DESCUENTO.TZTPUNI_DATA_ORIGIN != 'UNICO_SIU')THEN
                           VL_DESCUENTO:=VL_DESCUENTO;
                       ELSE
                           VL_DESCUENTO:=FLOOR(VL_DESCUENTO);
                       END IF;

                       BEGIN
                         SELECT SUM(TBRACCD_AMOUNT)
                           INTO VL_AJUSTES
                           FROM TBRACCD
                          WHERE TBRACCD_PIDM = ALUMNO.TBRACCD_PIDM
                                AND TBRACCD_TRAN_NUMBER_PAID = ALUMNO.TBRACCD_TRAN_NUMBER;
                       EXCEPTION
                       WHEN OTHERS THEN
                       VL_AJUSTES:=0;
                       END;

                       IF (VL_AJUSTES+VL_DESCUENTO)> ALUMNO.TBRACCD_AMOUNT THEN

                         VL_ERROR:='LA TRANSACCION '||ALUMNO.TBRACCD_TRAN_NUMBER||', PRESENTA AJUSTES POR '||VL_AJUSTES||' desvincular pagos para aplicar descuento';

                       ELSE

                         BEGIN
                           SELECT TBBDETC_DESC
                             INTO VL_DESC
                             FROM TBBDETC
                            WHERE TBBDETC_DETAIL_CODE = DESCUENTO.TZTPUNI_CODIGO;
                         EXCEPTION
                         WHEN OTHERS THEN
                         VL_DESC:=NULL;
                         END;

                         BEGIN
                           SELECT TBBDETC_DESC
                             INTO VL_DESC
                             FROM TBBDETC
                            WHERE TBBDETC_DETAIL_CODE = DESCUENTO.TZTPUNI_CODIGO;
                         EXCEPTION
                         WHEN OTHERS THEN
                         VL_DESC:=NULL;
                         END;                     

                         vl_moneda:= null;
                         Begin 
                            Select TVRDCTX_CURR_CODE
                                Into vl_moneda
                            from tvrdctx
                            where 1=1
                            and TVRDCTX_DETC_CODE = DESCUENTO.TZTPUNI_CODIGO;                     
                         Exception 
                            When Others then 
                             vl_moneda := 'MXN';
                         End;                     


                         IF (DESCUENTO.TZTPUNI_DATA_ORIGIN != 'UNICO_SIU' OR DESCUENTO.TZTPUNI_DATA_ORIGIN IS NULL) THEN

                          PKG_FINANZAS.P_DESAPLICA_PAGOS ( ALUMNO.TBRACCD_PIDM, ALUMNO.TBRACCD_TRAN_NUMBER);

                         END IF;

                         IF LAST_DAY(ALUMNO.TBRACCD_EFFECTIVE_DATE) <= LAST_DAY(TRUNC(SYSDATE)) THEN
                              VL_FECHA_EFF:= TRUNC(SYSDATE);
                         ELSE
                              --VL_FECHA_EFF:= ALUMNO.TBRACCD_EFFECTIVE_DATE;
                              VL_FECHA_EFF:= TRUNC(SYSDATE);
                         END IF;

                         BEGIN
                           BEGIN
                             SELECT MAX(TBRACCD_TRAN_NUMBER)+1
                             INTO VL_SECUENCIA
                             FROM TBRACCD
                             WHERE TBRACCD_PIDM = ALUMNO.TBRACCD_PIDM;
                           END;

                          --  DBMS_OUTPUT.PUT_LINE('Inserta Descuento  = '||ALUMNO.TBRACCD_PIDM);

                           vl_orden:= null;

                           Begin                  
                             SELECT distinct TBRACCD_RECEIPT_NUMBER
                               INTO vl_orden
                               FROM TBRACCD A,TBBDETC
                              WHERE TBRACCD_DETAIL_CODE = TBBDETC_DETAIL_CODE
                                    AND TBRACCD_PIDM = P_PIDM
                                    AND A.TBRACCD_FEED_DATE = P_FECHA_NW
                                    AND TBBDETC_DCAT_CODE = 'COL'
                                    AND TBRACCD_DOCUMENT_NUMBER IS NULL;
                                  --  AND LAST_DAY(TRUNC(A.TBRACCD_EFFECTIVE_DATE)) >= LAST_DAY(TRUNC(SYSDATE-90))
                           EXCEPTION
                           WHEN OTHERS THEN
                           vl_orden:= null;
                           END;                            



                             BEGIN
                               INSERT
                                 INTO TBRACCD
                                      (TBRACCD_PIDM,
                                       TBRACCD_TRAN_NUMBER,
                                       TBRACCD_TERM_CODE,
                                       TBRACCD_DETAIL_CODE,
                                       TBRACCD_USER,
                                       TBRACCD_ENTRY_DATE,
                                       TBRACCD_AMOUNT,
                                       TBRACCD_BALANCE,
                                       TBRACCD_EFFECTIVE_DATE,
                                       TBRACCD_DESC,
                                       TBRACCD_ACTIVITY_DATE,
                                       TBRACCD_TRANS_DATE,
                                       TBRACCD_DATA_ORIGIN,
                                       TBRACCD_CREATE_SOURCE,
                                       TBRACCD_SRCE_CODE ,
                                       TBRACCD_ACCT_FEED_IND,
                                       TBRACCD_SESSION_NUMBER,
                                       TBRACCD_CURR_CODE,
                                       TBRACCD_TRAN_NUMBER_PAID,
                                       TBRACCD_STSP_KEY_SEQUENCE,
                                       TBRACCD_PERIOD,
                                       TBRACCD_FEED_DATE,
                                       TBRACCD_RECEIPT_NUMBER)
                                VALUES (ALUMNO.TBRACCD_PIDM,
                                        VL_SECUENCIA,
                                        ALUMNO.TBRACCD_TERM_CODE,
                                        DESCUENTO.TZTPUNI_CODIGO,
                                        USER,
                                        SYSDATE,
                                        VL_DESCUENTO,
                                        (VL_DESCUENTO)*-1 ,
                                        alumno.TBRACCD_EFFECTIVE_DATE,
                                        VL_DESC,
                                        SYSDATE,
                                        alumno.TBRACCD_EFFECTIVE_DATE,
                                        'PUNI_SIU',
                                        'PUNI_SIU',
                                        'T' ,
                                        'Y',
                                        0 ,
                                        vl_moneda,
                                        ALUMNO.TBRACCD_TRAN_NUMBER,
                                        ALUMNO.TBRACCD_STSP_KEY_SEQUENCE,
                                        ALUMNO.TBRACCD_PERIOD,
                                        ALUMNO.TBRACCD_FEED_DATE,
                                        vl_orden
                                        );

                             EXCEPTION
                             WHEN OTHERS THEN
                             VL_ERROR :=' Errror al Insertar el Ajuste>>  ' || SQLERRM ;
                             END;

                         END;

                       END IF;

                       VL_CADENA_ERROR:= VL_ERROR;

                       BEGIN
                         UPDATE TBRACCD
                            SET TBRACCD_DOCUMENT_NUMBER = 'PAGOUNIC'
                          WHERE     TBRACCD_PIDM = DESCUENTO.TZTPUNI_PIDM
                                AND TBRACCD_FEED_DATE = ALUMNO.TBRACCD_FEED_DATE
                                AND TBRACCD_DETAIL_CODE = DESCUENTO.TZTPUNI_CODIGO
                                AND TRUNC(TBRACCD_ENTRY_DATE) = TRUNC(SYSDATE)
                                AND TBRACCD_DOCUMENT_NUMBER IS NULL;
                       END;

                       BEGIN
                         UPDATE TVRACCD
                            SET TVRACCD_DOCUMENT_NUMBER = 'PAGOUNIC'
                          WHERE     TVRACCD_PIDM = DESCUENTO.TZTPUNI_PIDM
                                AND TVRACCD_FEED_DATE = ALUMNO.TBRACCD_FEED_DATE
                                AND TVRACCD_DETAIL_CODE = DESCUENTO.TZTPUNI_CODIGO
                                AND TRUNC(TVRACCD_ENTRY_DATE) = TRUNC(SYSDATE)
                                AND TVRACCD_DOCUMENT_NUMBER IS NULL;

                       END;

                       IF VL_APLI_DESCU = ALUMNO.SECU THEN
                          EXIT;
                       END IF;

                     END LOOP;


                   END;

                   IF (VL_CADENA_ERROR IS NULL OR VL_CADENA_ERROR = 'EXITO')THEN

                            --DBMS_OUTPUT.PUT_LINE('Hizo el inserta en tbraccd');


                     IF DESCUENTO.TZTPUNI_CHECK = 1 THEN
                        --DBMS_OUTPUT.PUT_LINE('Entra en el TZTPUNI_CHECK = 1');

                           VL_DIA:= DESCUENTO.DIAP;
                           VL_FECHA_FINAL:= DESCUENTO.TZTPUNI_PROX_FECHA;
                          -- DBMS_OUTPUT.PUT_LINE('valor vldia ' ||VL_DIA);
                          -- DBMS_OUTPUT.PUT_LINE('valor VL_FECHA_FINAL ' ||VL_FECHA_FINAL);

                     ELSE
                        --DBMS_OUTPUT.PUT_LINE('Entra en el TZTPUNI_CHECK = 0');
                           VL_DIA:= DESCUENTO.DIA;
                           VL_FECHA_FINAL:= DESCUENTO.TZTPUNI_FECHA_INICIO;
                          -- DBMS_OUTPUT.PUT_LINE('valor vldia ' ||VL_DIA);
                          -- DBMS_OUTPUT.PUT_LINE('valor VL_FECHA_FINAL ' ||VL_FECHA_FINAL);

                     END IF;

                     IF VL_DIA > 20 THEN
                        --DBMS_OUTPUT.PUT_LINE('Entra en el valor > 20');

                       BEGIN
                         SELECT ADD_MONTHS((TRUNC(VL_FECHA_FINAL)-(TO_NUMBER(TO_CHAR(VL_FECHA_FINAL,'DD'))-1)),(DESCUENTO.TZTPUNI_REPLICA+1))
                           INTO VL_FECHA_NEW
                           FROM DUAL;
                       EXCEPTION
                       WHEN OTHERS THEN
                       VL_FECHA_NEW:=NULL;
                       VL_ERROR:='ERROR AL CALCULAR FECHA NUEVA'||SQLERRM;
                       END;

                       --DBMS_OUTPUT.PUT_LINE('valor VL_FECHA_NEW ' ||VL_FECHA_NEW);


                     ELSE
                        --DBMS_OUTPUT.PUT_LINE('Entra en el valor > 20');

                       BEGIN
                         SELECT ADD_MONTHS((TRUNC(VL_FECHA_FINAL)-(TO_NUMBER(TO_CHAR(VL_FECHA_FINAL,'DD'))-1)),DESCUENTO.TZTPUNI_REPLICA)
                           INTO VL_FECHA_NEW
                           FROM DUAL;
                       EXCEPTION
                       WHEN OTHERS THEN
                       VL_FECHA_NEW:=NULL;
                       VL_ERROR:='ERROR AL CALCULAR FECHA NUEVA'||SQLERRM;
                       END;

                        --DBMS_OUTPUT.PUT_LINE('valor VL_FECHA_NEW ' ||VL_FECHA_NEW);

                     END IF;

                     BEGIN
                       UPDATE TZTPUNI
                       SET TZTPUNI_CHECK = 1,
                           TZTPUNI_APLI = NVL(DESCUENTO.TZTPUNI_APLI,0)+1,
                           TZTPUNI_OBSERVACIONES = 'GENERADO CORRECTAMENTE',
                           TZTPUNI_PROX_FECHA = VL_FECHA_NEW,
                           TZTPUNI_CHECK_ERROR = NULL
                       WHERE TZTPUNI_PIDM = DESCUENTO.TZTPUNI_PIDM
                       AND TZTPUNI_FECHA_INICIO = DESCUENTO.TZTPUNI_FECHA_INICIO;
                     END;

                     BEGIN
                       SELECT COUNT(*)
                         INTO VL_FINAL
                         FROM TBRACCD
                        WHERE     TBRACCD_PIDM = P_PIDM
                              AND TBRACCD_DOCUMENT_NUMBER = 'PAGOUNIC'
                              AND TBRACCD_EFFECTIVE_DATE >= DESCUENTO.TZTPUNI_FECHA_INICIO;
                     EXCEPTION
                     WHEN OTHERS THEN
                     VL_DESCUENTOS:=0;
                     END;

                     IF  VL_NUM_APLICA = VL_FINAL THEN

                        UPDATE TZTPUNI
                           SET TZTPUNI_CHECK = 1,
                               TZTPUNI_APLI = NVL(DESCUENTO.TZTPUNI_APLI,0)+1,
                               TZTPUNI_OBSERVACIONES = 'DESCUENTO FINALIZADO',
                               TZTPUNI_CHECK_ERROR = NULL,
                               TZTPUNI_CHECH_FINAL = 1
                         WHERE     TZTPUNI_PIDM = DESCUENTO.TZTPUNI_PIDM
                               AND TZTPUNI_FECHA_INICIO = DESCUENTO.TZTPUNI_FECHA_INICIO;

                     END IF;

                   ELSE

                    ROLLBACK;

                     IF DESCUENTO.TZTPUNI_CHECK = 1 THEN

                       UPDATE TZTPUNI
                          SET TZTPUNI_CHECK_ERROR = 1,
                              TZTPUNI_OBSERVACIONES = VL_CADENA_ERROR,
                              TZTPUNI_PROX_FECHA = P_FECHA
                        WHERE     TZTPUNI_PIDM = DESCUENTO.TZTPUNI_PIDM
                              AND TZTPUNI_FECHA_INICIO = DESCUENTO.TZTPUNI_FECHA_INICIO;

                     ELSE

                        UPDATE TZTPUNI
                           SET TZTPUNI_CHECK = 0,
                               TZTPUNI_OBSERVACIONES = VL_CADENA_ERROR,
                               TZTPUNI_PROX_FECHA = P_FECHA
                         WHERE     TZTPUNI_PIDM = DESCUENTO.TZTPUNI_PIDM
                               AND TZTPUNI_FECHA_INICIO = DESCUENTO.TZTPUNI_FECHA_INICIO;

                     END IF;

                   END IF;

                 ELSE

                    VL_ERROR:= 'No existe pago en el estado de cuenta = '||DESCUENTO.TZTPUNI_MONTO;

                    BEGIN
                      UPDATE TZTPUNI
                         SET TZTPUNI_CHECK = 0,
                             TZTPUNI_OBSERVACIONES = VL_ERROR
                       WHERE     TZTPUNI_PIDM = P_PIDM
                             AND TZTPUNI_FECHA_INICIO = P_FECHA;
                    END;

               END IF;

             End if;


           END LOOP;

         END;

       ELSE

       VL_ERROR:= 'NO EXISTE CARTERA PARA LA FECHA INICIO = '||P_FECHA;

         BEGIN
           UPDATE TZTPUNI
              SET TZTPUNI_CHECK = 0,
                  TZTPUNI_OBSERVACIONES = VL_ERROR
            WHERE     TZTPUNI_PIDM = P_PIDM
                  AND TZTPUNI_FECHA_INICIO = P_FECHA
                  AND TZTPUNI_CHECH_FINAL IS NULL;
         END;

         IF SQL%ROWCOUNT = 0 THEN

            BEGIN
              UPDATE TZTPUNI
                 SET TZTPUNI_CHECK_ERROR = 1,
                     TZTPUNI_OBSERVACIONES = VL_ERROR
               WHERE     TZTPUNI_PIDM = P_PIDM
                     AND TZTPUNI_PROX_FECHA = P_FECHA
                     AND TZTPUNI_CHECH_FINAL IS NULL;
            END;

         END IF;

       END IF;

   END IF;


  COMMIT;

    --DBMS_OUTPUT.PUT_LINE('F_DES_PAG_UNI_NW  = '||VL_ERROR);

   RETURN(VL_ERROR);

 END F_DES_PAG_UNI_NW;

---
FUNCTION f_max_colegiatura(p_pidm IN NUMBER) 
RETURN NUMBER
IS
/******************************************************************************
   NAME:       BANINST1.f_max_colegiatura
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        11/09/2023      GOLVERA       1. Created this package.
******************************************************************************/

    ln_retorna NUMBER;
BEGIN


 SELECT count(unique TBRACCD_TRAN_NUMBER)
 INTO ln_retorna
  FROM tbraccd a
       JOIN tbbdetc b ON b.TBBDETC_DETAIL_CODE = a.TBRACCD_DETAIL_CODE
       JOIN TZTNCD c
          ON     c.TZTNCD_CODE = a.TBRACCD_DETAIL_CODE
             AND UPPER (c.TZTNCD_CONCEPTO) = 'VENTA'
             AND b.TBBDETC_TYPE_IND = 'C'
             AND b.TBBDETC_DCAT_CODE = 'COL'
             AND b.TBBDETC_DETC_ACTIVE_IND = 'Y'
 WHERE     a.TBRACCD_PIDM = p_pidm
       AND a.TBRACCD_STSP_KEY_SEQUENCE IN (SELECT MAX (e.sp)
                                             FROM tztprog e
                                            WHERE e.pidm = a.TBRACCD_PIDM);

    return(nvl(ln_retorna,0));

EXCEPTION WHEN OTHERS THEN
    ln_retorna:=0;
END f_max_colegiatura;

procedure p_incremento_anual_new (p_matricula in varchar2, 
                                                p_programa in varchar2, 
                                                p_periodo in varchar2, 
                                                p_pperido in varchar2, 
                                                f_fecha_ini in date, 
                                                p_estatus in varchar2, 
                                                p_tipo in varchar2,
                                                p_sp in number) is

vl_existe_incr number:=0;
vl_incr_max number :=0;
vl_incr_meses number:=0;
VL_ERROR varchar2(5000):= null;
vl_porcentaje number:=0;

Begin

     For cx in (


                      Select y.campus, y.nivel, y.id, y.pidm, y.programa, y.rate, y.study, y.fecha_mate, y.fecha_cxc, y.fecha_inicio, y.meses, y.porcentaje, y.vigencia, y.puni,
                    case
                    When y.meses < 12 then 
                     '0' 
                     When y.meses >= 12 then
                    substr (to_char (y.meses/y.vigencia),1,1)
                    End redondeo,
                    case
                    When y.meses < 12 then 
                     --to_char ((substr ((1/y.vigencia),1,1) * y.porcentaje))
                     '0' 
                     When y.meses >= 12 then
                    to_char ((substr ((y.meses/y.vigencia),1,1) * y.porcentaje))
                    End porcentaje_new                    
                    from  (
                    SELECT CAMP Campus,
                           NIVEL,
                           ID,
                           PIDM,
                           PROGRAMA,
                           RATE,
                           STUDY,
                           FECHA_MATE,
                           FECHA_CXC,
                           FECHA_INICIO,
                            NVL( CASE
                                WHEN nvl (x.MESES,1) < 0 THEN 1
                                WHEN nvl (x.MESES,1) > 0 THEN nvl (x.MESES,1)
                           END,1)meses,
                            PKG_FINANZAS.F_MONTO_INCREMENTO(CAMP,NIVEL,NVL( CASE
                                                                                WHEN nvl (x.MESES,1) < 0 THEN 1
                                                                                WHEN nvl (x.MESES,1) > 0 THEN nvl (x.MESES,1)
                                                                           END,1), FECHA_MATE) PORCENTAJE,
                            PKG_FINANZAS.F_MES_INCREMENTO(CAMP,NIVEL,NVL( CASE
                                                                            WHEN nvl (x.MESES,1) < 0 THEN 1
                                                                            WHEN nvl (x.MESES,1) > 0 THEN nvl (x.MESES,1)
                                                                       END,1), FECHA_MATE) Vigencia,                                                                           
                            PKG_FINANZAS.f_exite_puni(PIDM) Puni
                    FROM(
                            SELECT CAMP,
                                   NIVEL,
                                   ID,
                                   PIDM,
                                   PROGRAMA,
                                   RATE,
                                   STUDY,
                                   FECHA_MATE,
                                   FECHA_CXC,
                                   FECHA_INICIO,
                                   (CASE
                                         WHEN FECHA_CXC IS NOT NULL THEN (SELECT ROUND(MONTHS_BETWEEN(TO_DATE(FECHA_INICIO),TO_DATE(FECHA_CXC)))FROM DUAL)
                                         WHEN FECHA_CXC IS NULL THEN (SELECT ROUND(MONTHS_BETWEEN(TO_DATE(FECHA_INICIO),TO_DATE(FECHA_MATE)))FROM DUAL)
                                   END) MESES
                            FROM (
                            SELECT DISTINCT
                                   SORLCUR_CAMP_CODE CAMP,
                                   SORLCUR_LEVL_CODE NIVEL,
                                   SORLCUR_PROGRAM PROGRAMA,
                                   SPRIDEN_ID ID,
                                   SFRSTCR_PIDM PIDM,
                                   SPRIDEN_FIRST_NAME||' '||SPRIDEN_LAST_NAME ALUMNO,
                                   (SELECT TO_DATE(TRUNC(MIN (SSBSECT_PTRM_START_DATE+12),'MONTH'))
                                    FROM SFRSTCR F1,SSBSECT T1
                                    WHERE SFRSTCR_CRN = SSBSECT_CRN
                                    AND SFRSTCR_TERM_CODE = SSBSECT_TERM_CODE
                                    AND SFRSTCR_PTRM_CODE = SSBSECT_PTRM_CODE
                                    AND SFRSTCR_PIDM = CUR.SORLCUR_PIDM
                                    AND SFRSTCR_STSP_KEY_SEQUENCE = CUR.SORLCUR_KEY_SEQNO
                                    AND (SFRSTCR_DATA_ORIGIN != 'CONVALIDACION' OR SFRSTCR_DATA_ORIGIN IS NULL)
                                    AND (SFRSTCR_DATA_ORIGIN != 'EXCLUIR' OR SFRSTCR_DATA_ORIGIN IS NULL)
                                    AND SUBSTR(F1.SFRSTCR_TERM_CODE,5,1) NOT IN (8,9)
                                    AND SFRSTCR_RSTS_CODE = 'RE')FECHA_MATE,
                                   (SELECT MAX(TZTINCR_START_DATE)
                                    FROM TZTINCR
                                    WHERE TZTINCR_PIDM = CUR.SORLCUR_PIDM
                                    AND TZTINCR_STUDY = CUR.SORLCUR_KEY_SEQNO)FECHA_CXC,
                                   SORLCUR_START_DATE FECHA_INICIO,
                                   SORLCUR_KEY_SEQNO STUDY,
                                   SORLCUR_RATE_CODE RATE
                            FROM SFRSTCR HST,
                                 SORLCUR CUR,
                                 SPRIDEN
                            WHERE 1 = 1
                            AND HST.SFRSTCR_PIDM=CUR.SORLCUR_PIDM
                            AND SPRIDEN_PIDM = SORLCUR_PIDM
                            AND SPRIDEN_CHANGE_IND IS NULL
                            AND SPRIDEN_ID = NVL(p_matricula,SPRIDEN_ID) ---> Matricula 
                            AND CUR.SORLCUR_LMOD_CODE = 'LEARNER'
                            AND CUR.SORLCUR_ROLL_IND  = 'Y'
                            AND CUR.SORLCUR_CACT_CODE = 'ACTIVE'
                            AND CUR.SORLCUR_SEQNO = (SELECT MAX(CUR2.SORLCUR_SEQNO)
                                                      FROM SORLCUR CUR2
                                                      WHERE 1 = 1
                                                      AND CUR2.SORLCUR_PIDM=CUR.SORLCUR_PIDM
                                                      and CUR2.SORLCUR_PROGRAM= CUR.SORLCUR_PROGRAM
                                                      AND CUR2.SORLCUR_LMOD_CODE = CUR.SORLCUR_LMOD_CODE
                                                      AND CUR2.SORLCUR_ROLL_IND = CUR.SORLCUR_ROLL_IND
                                                      AND CUR2.SORLCUR_CACT_CODE = CUR.SORLCUR_CACT_CODE)
                            AND CUR.SORLCUR_KEY_SEQNO = HST.SFRSTCR_STSP_KEY_SEQUENCE
                            AND HST.SFRSTCR_RSTS_CODE = 'RE'
                            AND SPRIDEN_PIDM NOT IN (SELECT TBRACCD_PIDM
                                                        FROM TBRACCD CCD
                                                       WHERE     CCD.TBRACCD_PIDM = CUR.SORLCUR_PIDM
                                                             AND SUBSTR(CCD.TBRACCD_DETAIL_CODE,3,2) IN ('RM','RN','RP')
                                                             AND CCD.TBRACCD_STSP_KEY_SEQUENCE = CUR.SORLCUR_KEY_SEQNO)
                            AND (HST.SFRSTCR_DATA_ORIGIN != 'CONVALIDACION' OR HST.SFRSTCR_DATA_ORIGIN IS NULL)
                            AND (HST.SFRSTCR_DATA_ORIGIN != 'EXCLUIR' OR HST.SFRSTCR_DATA_ORIGIN IS NULL)
                            AND trunc (CUR.SORLCUR_START_DATE) = nvl (f_fecha_ini, trunc (CUR.SORLCUR_START_DATE))    ---> Fecha de Incio
                            And CUR.SORLCUR_PROGRAM = nvl (p_programa, CUR.SORLCUR_PROGRAM)   ----> Programa
                            And CUR.SORLCUR_KEY_SEQNO = nvl (p_sp, CUR.SORLCUR_KEY_SEQNO)          ----> SP         
                            AND CUR.SORLCUR_PIDM NOT IN (SELECT GORADID_PIDM
                                                     FROM GORADID
                                                     WHERE GORADID_ADID_CODE in ('INBE','INBC'))
                            )ALUMNO
                    WHERE 1=1)X
                    ) y
    
     ) loop

        ------ Valida que la vigencia de los incrementos sea menor o igual al numoer de meses cursados

            vl_porcentaje :=0;
            If cx.puni >= 1 then
                If cx.meses between 0 and 11 then
                    vl_porcentaje:= 0;
                Elsif cx.meses between 12 and 23 then
                    vl_porcentaje:= 5;
                Elsif cx.meses between 24 and 100 then
                    vl_porcentaje:= 10;
                End if;
            ElsIf cx.puni = 0 then
               vl_porcentaje := cx.PORCENTAJE_New;

            End if;        

        --   DBMS_OUTPUT.PUT_LINE('Monto de Porcentaje ' ||vl_porcentaje);


            If cx.meses >= cx.vigencia then  ---> Cumple 
                vl_existe_incr:=0;
              --   DBMS_OUTPUT.PUT_LINE('Entra cuando los meses son mayore ' ||cx.meses ||' * '|| cx.vigencia);

                Begin 

                        SELECT count(*)
                            Into vl_existe_incr
                        FROM TZDOCTR
                        WHERE TZDOCTR_TIPO_PROC = 'AUME'
                        And trunc (TZDOCTR_START_DATE) < cx.fecha_inicio
                        and TZDOCTR_PIDM = cx.pidm
                        And TZDOCTR_PROGRAM = cx.programa 
                        And TZDOCTR_STUDY_PATH = cx.STUDY
                        ;
                Exception
                    When Others then 
                        vl_existe_incr:=0;
                End;

                If vl_existe_incr = 0 then ---> Creo el primer incremento con el valor de la tabla de configuracion porque no existe incrementos anteriores 

                 -- DBMS_OUTPUT.PUT_LINE('Crea el primer incremento del alumno' ||vl_existe_incr);

                    vl_existe_incr:=0;

                    BEGIN
                        SELECT COUNT(*)
                            INTO vl_existe_incr
                        FROM TZDOCTR
                        WHERE TZDOCTR_PIDM = cx.pidm
                        AND TZDOCTR_PROGRAM = cX.PROGRAMA
                        AND TZDOCTR_START_DATE = cx.fecha_inicio
                        And TZDOCTR_STUDY_PATH = cx.STUDY
                        AND TZDOCTR_TIPO_PROC = 'AUME';
                    EXCEPTION
                    WHEN OTHERS THEN
                        vl_existe_incr:=0;
                    END;


                    IF vl_existe_incr = 0 THEN
                    
                        If vl_porcentaje =0 or vl_porcentaje is null then 
                            null; -----> No registra en la bitacora
                        Else

                            BEGIN
                                  INSERT INTO  TZDOCTR
                                              (TZDOCTR_PIDM,
                                               TZDOCTR_PROGRAM,
                                               TZDOCTR_STST_CODE,
                                               TZDOCTR_STYP_CODE,
                                               TZDOCTR_CAMP_CODE,
                                               TZDOCTR_LEVL_CODE,
                                               TZDOCTR_TERM_CODE,
                                               TZDOCTR_START_DATE,
                                               TZDOCTR_PTRM_CODE,
                                               TZDOCTR_STUDY_PATH,
                                               FECHA_PROCESO,
                                               TZDOCTR_ID,
                                               TZDOCTR_TIPO_PROC,
                                               TZDOCTR_DESCUENTO,
                                               TZDOCTR_PERIODOS_CURSADOS,
                                               TZDOCTR_PORC_INCREM)
                                  VALUES (
                                          cx.PIDM,
                                          cx.PROGRAMA,
                                          p_estatus,
                                          p_tipo,
                                          cx.campus,
                                          cx.nivel,
                                          p_PERIODO,
                                          cx.fecha_inicio,
                                          p_pperido,
                                          cx.STUDY,
                                          SYSDATE,
                                          cx.ID,
                                          'AUME',
                                          0,
                                          cx.MESES,
                                          vl_porcentaje
                                          );


                            EXCEPTION
                            WHEN OTHERS THEN
                            VL_ERROR:=('Error 1 TZDOCTR '|| cx.PIDM ||'*'||SQLERRM);
                            END;
                        End if;


                    ELSE

                            BEGIN

                                DELETE TZDOCTR
                                WHERE TZDOCTR_PIDM = cx.PIDM
                                AND TZDOCTR_PROGRAM = cx.PROGRAMA
                                AND TZDOCTR_START_DATE = cx.fecha_inicio
                                And TZDOCTR_STUDY_PATH = cx.STUDY
                                AND TZDOCTR_TIPO_PROC = 'AUME'
                                ;

                            END;
                            
                        If vl_porcentaje =0 or vl_porcentaje is null then 
                            null; -----> No registra en la bitacora
                        Else                            

                            BEGIN
                                  INSERT INTO  TZDOCTR
                                              (TZDOCTR_PIDM,
                                               TZDOCTR_PROGRAM,
                                               TZDOCTR_STST_CODE,
                                               TZDOCTR_STYP_CODE,
                                               TZDOCTR_CAMP_CODE,
                                               TZDOCTR_LEVL_CODE,
                                               TZDOCTR_TERM_CODE,
                                               TZDOCTR_START_DATE,
                                               TZDOCTR_PTRM_CODE,
                                               TZDOCTR_STUDY_PATH,
                                               FECHA_PROCESO,
                                               TZDOCTR_ID,
                                               TZDOCTR_TIPO_PROC,
                                               TZDOCTR_DESCUENTO,
                                               TZDOCTR_PERIODOS_CURSADOS,
                                               TZDOCTR_PORC_INCREM)
                                  VALUES (
                                          cx.PIDM,
                                          cx.PROGRAMA,
                                          p_estatus,
                                          p_tipo,
                                          cx.campus,
                                          cx.nivel,
                                          p_PERIODO,
                                          cx.fecha_inicio,
                                          p_pperido,
                                          cx.STUDY,
                                          SYSDATE,
                                          cx.ID,
                                          'AUME',
                                          0,
                                          cx.MESES,
                                          vl_porcentaje
                                          );
                            EXCEPTION
                            WHEN OTHERS THEN
                            VL_ERROR:=('Error 2 TZDOCTR '|| cx.PIDM ||'*'||SQLERRM);
                            END;
                            
                        End if;

                    END IF;

                Elsif vl_existe_incr > 0 then   ---> Ya existe incrementos

                      --  DBMS_OUTPUT.PUT_LINE('Entro cuando ya existes Incrementos' ||vl_existe_incr);

                     Begin 
                          SELECT max (TZDOCTR_PORC_INCREM)
                                Into vl_incr_max
                            FROM TZDOCTR
                            WHERE TZDOCTR_TIPO_PROC = 'AUME'
                            And trunc (TZDOCTR_START_DATE) < cx.fecha_inicio
                            and  TZDOCTR_PIDM = cx.pidm
                            And TZDOCTR_PROGRAM = cx.programa 
                            And TZDOCTR_STUDY_PATH = cx.STUDY
                            ;                 
                     Exception
                        When Others then 
                            vl_incr_max:=0;
                     End;

                   --  DBMS_OUTPUT.PUT_LINE('Recupero el porcentaje maximo' ||vl_incr_max);


                     If vl_incr_max > 0 then --> ya con los incrementos identificados obtenemos el numero de meses con el ultimo incremento
                     --   DBMS_OUTPUT.PUT_LINE('Recupero el porcentaje maximo Existe' ||vl_incr_max);
                        vl_incr_meses:=0;
                        Begin 
                                SELECT  trunc (MONTHS_BETWEEN(  cx.fecha_inicio , min (TZDOCTR_START_DATE) ))
                                    Into vl_incr_meses
                                FROM TZDOCTR
                                WHERE TZDOCTR_TIPO_PROC = 'AUME'
                                --And trunc (TZDOCTR_START_DATE) < '08/01/2024'
                                and  TZDOCTR_PIDM = cx.pidm
                                And TZDOCTR_PROGRAM = cx.programa 
                                And TZDOCTR_STUDY_PATH = cx.STUDY
                                And TZDOCTR_PORC_INCREM = vl_incr_max;
                        Exception
                            When others then 
                             vl_incr_meses:=0;
                        End;

                      --  DBMS_OUTPUT.PUT_LINE('Recupero el numero de meses para incremento' ||vl_incr_meses);


                        If vl_incr_meses >= cx.vigencia then   -----Comple con el salto de meses configurados para nuevo incremento
                         --  DBMS_OUTPUT.PUT_LINE('Entra cuando cumple con el nuevo incremento' ||vl_incr_meses||'*'||cx.vigencia);


                            vl_existe_incr:=0;

                            BEGIN
                                SELECT COUNT(*)
                                    INTO vl_existe_incr
                                FROM TZDOCTR
                                WHERE TZDOCTR_PIDM = cx.pidm
                                AND TZDOCTR_PROGRAM = cX.PROGRAMA
                                AND TZDOCTR_START_DATE = cx.fecha_inicio
                                And TZDOCTR_STUDY_PATH = cx.STUDY
                                AND TZDOCTR_TIPO_PROC = 'AUME';
                            EXCEPTION
                            WHEN OTHERS THEN
                                vl_existe_incr:=0;
                            END;


                            IF vl_existe_incr = 0 THEN
                            
                                If vl_porcentaje =0 or vl_porcentaje is null then 
                                    null; -----> No registra en la bitacora
                                Else                            
                            

                                    BEGIN
                                          INSERT INTO  TZDOCTR
                                                      (TZDOCTR_PIDM,
                                                       TZDOCTR_PROGRAM,
                                                       TZDOCTR_STST_CODE,
                                                       TZDOCTR_STYP_CODE,
                                                       TZDOCTR_CAMP_CODE,
                                                       TZDOCTR_LEVL_CODE,
                                                       TZDOCTR_TERM_CODE,
                                                       TZDOCTR_START_DATE,
                                                       TZDOCTR_PTRM_CODE,
                                                       TZDOCTR_STUDY_PATH,
                                                       FECHA_PROCESO,
                                                       TZDOCTR_ID,
                                                       TZDOCTR_TIPO_PROC,
                                                       TZDOCTR_DESCUENTO,
                                                       TZDOCTR_PERIODOS_CURSADOS,
                                                       TZDOCTR_PORC_INCREM)
                                          VALUES (
                                                  cx.PIDM,
                                                  cx.PROGRAMA,
                                                  p_estatus,
                                                  p_tipo,
                                                  cx.campus,
                                                  cx.nivel,
                                                  p_PERIODO,
                                                  cx.fecha_inicio,
                                                  p_pperido,
                                                  cx.STUDY,
                                                  SYSDATE,
                                                  cx.ID,
                                                  'AUME',
                                                  0,
                                                  cx.MESES,
                                                  vl_porcentaje
                                                  );


                                    EXCEPTION
                                    WHEN OTHERS THEN
                                    VL_ERROR:=('Error 1 TZDOCTR '|| cx.PIDM ||'*'||SQLERRM);
                                    END;

                                End if;

                            ELSE

                                    BEGIN

                                        DELETE TZDOCTR
                                        WHERE TZDOCTR_PIDM = cx.PIDM
                                        AND TZDOCTR_PROGRAM = cx.PROGRAMA
                                        AND TZDOCTR_START_DATE = cx.fecha_inicio
                                        And TZDOCTR_STUDY_PATH = cx.STUDY
                                        AND TZDOCTR_TIPO_PROC = 'AUME'
                                        ;

                                    END;

                                If vl_porcentaje =0 or vl_porcentaje is null then 
                                    null; -----> No registra en la bitacora
                                Else


                                    BEGIN
                                          INSERT INTO  TZDOCTR
                                                      (TZDOCTR_PIDM,
                                                       TZDOCTR_PROGRAM,
                                                       TZDOCTR_STST_CODE,
                                                       TZDOCTR_STYP_CODE,
                                                       TZDOCTR_CAMP_CODE,
                                                       TZDOCTR_LEVL_CODE,
                                                       TZDOCTR_TERM_CODE,
                                                       TZDOCTR_START_DATE,
                                                       TZDOCTR_PTRM_CODE,
                                                       TZDOCTR_STUDY_PATH,
                                                       FECHA_PROCESO,
                                                       TZDOCTR_ID,
                                                       TZDOCTR_TIPO_PROC,
                                                       TZDOCTR_DESCUENTO,
                                                       TZDOCTR_PERIODOS_CURSADOS,
                                                       TZDOCTR_PORC_INCREM)
                                          VALUES (
                                                  cx.PIDM,
                                                  cx.PROGRAMA,
                                                  p_estatus,
                                                  p_tipo,
                                                  cx.campus,
                                                  cx.nivel,
                                                  p_PERIODO,
                                                  cx.fecha_inicio,
                                                  p_pperido,
                                                  cx.STUDY,
                                                  SYSDATE,
                                                  cx.ID,
                                                  'AUME',
                                                  0,
                                                  cx.MESES,
                                                  vl_porcentaje
                                                  );
                                    EXCEPTION
                                    WHEN OTHERS THEN
                                    VL_ERROR:=('Error 2 TZDOCTR '|| cx.PIDM ||'*'||SQLERRM);
                                    END;
                                    
                                End if;    

                            END IF;

                        ElsIf vl_incr_meses < cx.vigencia then

                       ---  DBMS_OUTPUT.PUT_LINE('Entra cuando no cumple con el nuevo incremento' ||vl_incr_meses||'*'||cx.vigencia);

                            vl_existe_incr:=0;

                            BEGIN
                                SELECT COUNT(*)
                                    INTO vl_existe_incr
                                FROM TZDOCTR
                                WHERE TZDOCTR_PIDM = cx.pidm
                                AND TZDOCTR_PROGRAM = cX.PROGRAMA
                                AND TZDOCTR_START_DATE = cx.fecha_inicio
                                And TZDOCTR_STUDY_PATH = cx.STUDY
                                AND TZDOCTR_TIPO_PROC = 'AUME';
                            EXCEPTION
                            WHEN OTHERS THEN
                                vl_existe_incr:=0;
                            END;


                            IF vl_existe_incr = 0 THEN
                            
                                If vl_porcentaje =0 or vl_porcentaje is null then 
                                    null; -----> No registra en la bitacora
                                Else                            

                                    BEGIN
                                          INSERT INTO  TZDOCTR
                                                      (TZDOCTR_PIDM,
                                                       TZDOCTR_PROGRAM,
                                                       TZDOCTR_STST_CODE,
                                                       TZDOCTR_STYP_CODE,
                                                       TZDOCTR_CAMP_CODE,
                                                       TZDOCTR_LEVL_CODE,
                                                       TZDOCTR_TERM_CODE,
                                                       TZDOCTR_START_DATE,
                                                       TZDOCTR_PTRM_CODE,
                                                       TZDOCTR_STUDY_PATH,
                                                       FECHA_PROCESO,
                                                       TZDOCTR_ID,
                                                       TZDOCTR_TIPO_PROC,
                                                       TZDOCTR_DESCUENTO,
                                                       TZDOCTR_PERIODOS_CURSADOS,
                                                       TZDOCTR_PORC_INCREM)
                                          VALUES (
                                                  cx.PIDM,
                                                  cx.PROGRAMA,
                                                  p_estatus,
                                                  p_tipo,
                                                  cx.campus,
                                                  cx.nivel,
                                                  p_PERIODO,
                                                  cx.fecha_inicio,
                                                  p_pperido,
                                                  cx.STUDY,
                                                  SYSDATE,
                                                  cx.ID,
                                                  'AUME',
                                                  0,
                                                  cx.MESES,
                                                  vl_incr_max
                                                  );


                                    EXCEPTION
                                    WHEN OTHERS THEN
                                    VL_ERROR:=('Error 1 TZDOCTR '|| cx.PIDM ||'*'||SQLERRM);
                                    END;

                                End if;

                            ELSE

                                    BEGIN

                                        DELETE TZDOCTR
                                        WHERE TZDOCTR_PIDM = cx.PIDM
                                        AND TZDOCTR_PROGRAM = cx.PROGRAMA
                                        AND TZDOCTR_START_DATE = cx.fecha_inicio
                                        And TZDOCTR_STUDY_PATH = cx.STUDY
                                        AND TZDOCTR_TIPO_PROC = 'AUME'
                                        ;

                                    END;

                                    If vl_porcentaje =0 or vl_porcentaje is null then 
                                        null; -----> No registra en la bitacora
                                    Else


                                        BEGIN
                                              INSERT INTO  TZDOCTR
                                                          (TZDOCTR_PIDM,
                                                           TZDOCTR_PROGRAM,
                                                           TZDOCTR_STST_CODE,
                                                           TZDOCTR_STYP_CODE,
                                                           TZDOCTR_CAMP_CODE,
                                                           TZDOCTR_LEVL_CODE,
                                                           TZDOCTR_TERM_CODE,
                                                           TZDOCTR_START_DATE,
                                                           TZDOCTR_PTRM_CODE,
                                                           TZDOCTR_STUDY_PATH,
                                                           FECHA_PROCESO,
                                                           TZDOCTR_ID,
                                                           TZDOCTR_TIPO_PROC,
                                                           TZDOCTR_DESCUENTO,
                                                           TZDOCTR_PERIODOS_CURSADOS,
                                                           TZDOCTR_PORC_INCREM)
                                              VALUES (
                                                      cx.PIDM,
                                                      cx.PROGRAMA,
                                                      p_estatus,
                                                      p_tipo,
                                                      cx.campus,
                                                      cx.nivel,
                                                      p_PERIODO,
                                                      cx.fecha_inicio,
                                                      p_pperido,
                                                      cx.STUDY,
                                                      SYSDATE,
                                                      cx.ID,
                                                      'AUME',
                                                      0,
                                                      cx.MESES,
                                                      vl_incr_max
                                                      );
                                        EXCEPTION
                                        WHEN OTHERS THEN
                                        VL_ERROR:=('Error 2 TZDOCTR '|| cx.PIDM ||'*'||SQLERRM);
                                        END;
                                        
                                    End if;

                            END IF;                        



                        End if;


                     End if;

                End if;


            End if;




     End Loop cx;



End p_incremento_anual_new;


---

---
FUNCTION f_max_cole_domi(p_pidm IN NUMBER) 
RETURN NUMBER
IS
/******************************************************************************
   NAME:       BANINST1.f_max_colegiatura
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        11/09/2023      GOLVERA       1. Created this package.
******************************************************************************/

    ln_retorna NUMBER;
BEGIN


 SELECT count(DISTINCT TBRACCD_TRAN_NUMBER)
 INTO ln_retorna
  FROM tbraccd a
       JOIN tbbdetc b ON b.TBBDETC_DETAIL_CODE = a.TBRACCD_DETAIL_CODE
       JOIN TZTNCD c
          ON     c.TZTNCD_CODE = a.TBRACCD_DETAIL_CODE
       JOIN GORADID d
          ON d.goradid_pidm = a.TBRACCD_PIDM          
             AND UPPER (c.TZTNCD_CONCEPTO) = 'VENTA'
             AND b.TBBDETC_TYPE_IND = 'C'
             AND b.TBBDETC_DCAT_CODE = 'COL'
             AND b.TBBDETC_DETC_ACTIVE_IND = 'Y'
 WHERE     a.TBRACCD_PIDM = p_pidm
       AND TRUNC (TBRACCD_EFFECTIVE_DATE) >=
              (SELECT DISTINCT TRUNC (d.GORADID_ACTIVITY_DATE)
                 FROM goradid d
                WHERE     d.goradid_pidm = a.TBRACCD_PIDM
                      AND d.GORADID_ADID_CODE IN (select ZSTPARA_PARAM_ID from ZSTPARA where ZSTPARA_MAPA_ID = 'ETIQ_DOMI_LATAM')
                      )
       AND a.TBRACCD_STSP_KEY_SEQUENCE IN (SELECT MAX (e.sp)
                                             FROM tztprog e
                                            WHERE e.pidm = a.TBRACCD_PIDM);


    return(nvl(ln_retorna,0));

EXCEPTION WHEN OTHERS THEN
    ln_retorna:=0;
END f_max_cole_domi;

---



procedure alinea_mebresia_salud as

vl_salida varchar2(500):= null;

Begin 

        EXECUTE IMMEDIATE 'TRUNCATE TABLE migra.tztpadi_temp';
        ----------------- Alimenta la tabla temporal ---------------

        Begin 

        insert into migra.tztpadi_temp
        select *
        from tztpadi a
        where 1=1
        and a.TZTPADI_DETAIL_CODE in ('01CY', '014U')
        and a.TZTPADI_FLAG = 0
        And a.TZTPADI_SEQNO in (select max (a1.TZTPADI_SEQNO)
                                from tztpadi a1
                                Where a.TZTPADI_PIDM = a1.TZTPADI_PIDM
                                and a1.TZTPADI_DETAIL_CODE in ('01CY', '014U')
                                and a1.TZTPADI_FLAG = 0
                                );
        Exception
            When OThers then 
            null;
        End;


        Begin

            For cx in (

                        select *
                        from migra.tztpadi_temp
                        where ( TZTPADI_PIDM,TZTPADI_DETAIL_CODE) not in (select  TZTCOTA_PIDM, TZTCOTA_CODIGO   
                                                                            from tztcota)  

            ) loop    


                    Begin
                        Delete tztpadi
                        Where TZTPADI_PIDM = cx.TZTPADI_PIDM
                        And TZTPADI_SEQNO = cx.TZTPADI_SEQNO
                        And TZTPADI_DETAIL_CODE = cx.TZTPADI_DETAIL_CODE;
                    Exception
                        When Others then 
                         DBMS_OUTPUT.PUT_LINE('ERROR :'||sqlerrm);
                    End;


                    Begin
                        Insert into tztpadi
                        select *
                        from migra.tztpadi_temp
                        where ( TZTPADI_PIDM,TZTPADI_DETAIL_CODE) not in (select  TZTCOTA_PIDM, TZTCOTA_CODIGO   
                                                                            from tztcota)  
                        and  TZTPADI_PIDM  = cx.TZTPADI_PIDM;
                            Exception
                                When Others then 
                                 DBMS_OUTPUT.PUT_LINE('ERROR :'||sqlerrm);
                    End;        

            End loop;
            Commit;

        End;


        Begin

                    For cx in (

                                select *
                                from tztpadi
                                where ( TZTPADI_PIDM,TZTPADI_DETAIL_CODE)  in (select  TZTCOTA_PIDM, TZTCOTA_CODIGO   
                                                                                    from tztcota)  
                                 and substr (TZTPADI_DETAIL_CODE, 3,2) in ('4U', 'CY')
                                 and TZTPADI_FLAG in  ('0')

                              ) loop


                               Begin
                                    Update tztpadi
                                    set TZTPADI_FLAG ='9'
                                   Where TZTPADI_PIDM = cx.TZTPADI_PIDM
                                   And TZTPADI_SEQNO = cx.TZTPADI_SEQNO
                                   And TZTPADI_DETAIL_CODE = cx.TZTPADI_DETAIL_CODE
                                   And TZTPADI_FLAG ='0';
                               Exception
                                When Others then 
                                    null;

                               End;

                    End loop;
                    Commit;

        End;


-------------------------- Este proceso sirve para agregar etiqueta de la membresia de Salud -----------

        Begin 

             For cx in (

                        select distinct *
                        from migra.tztpadi_temp

             ) loop

                    If cx.TZTPADI_DETAIL_CODE = '014U' then 

                        vl_salida:= PKG_UTILERIAS.F_Genera_Etiqueta(cx.TZTPADI_PIDM, 
                                                                    'MDSB', 
                                                                    'ACCESORIO SALUD BASICO'
                                                                    , 'SistemaV2');
                    Else

                        vl_salida:= PKG_UTILERIAS.F_Genera_Etiqueta(cx.TZTPADI_PIDM, 
                                                                    'MDSP', 
                                                                    'ACCESORIO SALUD PREMIUM'
                                                                    , 'SistemaV2');            

                    End if;


            End loop;
            Commit;

        End;     

End alinea_mebresia_salud;


Function f_ajuste_mes_tres_baja (p_id varchar2, p_programa in varchar2) Return varchar2

is 

VL_ERROR varchar2(500) := null;
VL_TRANSACCION number:= 0;
VL_DESCRIPCION varchar2(50):= null;
vl_Cargo varchar2(4):= null;
vl_sp number:=0;
vl_nivel varchar2(5):= null;
p_pidm number;
vl_existe number:=0;
vl_inicio date:= '01/04/2024';
vl_fin date:= '30/04/2024';



Begin 

          vl_sp:=0;
          vl_nivel:= null;

          Begin
         
                Select a.sp, a.nivel, pidm
                    Into vl_sp, vl_nivel, p_pidm
                from tztprog a
                where 1=1
                And a.matricula = p_id
                And a.programa = p_programa
               -- And trunc(a.fecha_inicio) = p_fecha_ini
                And a.sp = (select max(a1.sp)
                            from tztprog a1
                            Where a.pidm = a1.pidm
                            And a.programa = a1.programa
                            And trunc (a.fecha_inicio) = trunc (a1.fecha_inicio));

          
          EXception
            When Others then 
            vl_sp:=0;
            vl_nivel:= null;
            p_pidm := null;
          End;
          

  
           -- dbms_output.put_line('Recupero Pidm:  '||p_pidm||'*'||vl_inicio||'*'||vl_fin||'*'||vl_sp);

             FOR COLEG IN (

                    SELECT  B.TBRACCD_PIDM PIDM,
                          B.TBRACCD_Amount MONTO,
                          B.TBRACCD_TRAN_NUMBER SECUENCIA,
                          SPRIDEN_ID Matricula,
                          substr (SPRIDEN_ID,1,2) ID,
                          b.TBRACCD_STSP_KEY_SEQUENCE, 
                          b.TBRACCD_PERIOD, 
                          b.TBRACCD_TERM_CODE PERIODO,
                          TVRDCTX_CURR_CODE Moneda,
                          b.TBRACCD_RECEIPT_NUMBER orden,
                          trunc (b.TBRACCD_FEED_DATE) Fecha_inicio
                    FROM TBRACCD B, SPRIDEN, TVRDCTX
                    WHERE  B.TBRACCD_PIDM = p_pidm --PN_PIDM
                         AND B.TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                                         FROM TBBDETC
                                                        WHERE TBBDETC_DCAT_CODE = 'COL'
                                                              AND SUBSTR (TBBDETC_DETAIL_CODE,1,2) = SUBSTR (B.TBRACCD_TERM_CODE,1,2)
                                                              AND TBBDETC_DETC_ACTIVE_IND = 'Y'
                                                              AND TBBDETC_TAXT_CODE = vl_nivel
                                                              )
                         And trunc (b.TBRACCD_EFFECTIVE_DATE)  between vl_inicio and vl_fin
                         And b.TBRACCD_STSP_KEY_SEQUENCE = vl_sp
                         AND B.TBRACCD_PIDM = SPRIDEN_PIDM
                         AND SPRIDEN_CHANGE_IND IS NULL
                         And b.tbraccd_detail_code = TVRDCTX_DETC_CODE
                         And trunc (b.TBRACCD_EFFECTIVE_DATE) in (select max(trunc (b1.TBRACCD_EFFECTIVE_DATE))
                                                                   from tbraccd b1
                                                                   Where b.TBRACCD_PIDM = b1.TBRACCD_PIDM
                                                                   And b.TBRACCD_DETAIL_CODE = b1.TBRACCD_DETAIL_CODE
                                                                   And b.TBRACCD_STSP_KEY_SEQUENCE = b1.TBRACCD_STSP_KEY_SEQUENCE
                                                                   And trunc (b1.TBRACCD_EFFECTIVE_DATE)  between vl_inicio and vl_fin
                                                                   )
                         
                         
             ) LOOP

                    VL_TRANSACCION:= 0;
                    VL_ERROR:= NULL;
                    --  dbms_output.put_line('Entro al FOR:  '||p_pidm);


               BEGIN
                 SELECT NVL(MAX(TBRACCD_TRAN_NUMBER),0) +1
                   INTO VL_TRANSACCION
                   FROM TBRACCD
                  WHERE TBRACCD_PIDM=COLEG.PIDM;
               EXCEPTION
               WHEN OTHERS THEN
               VL_TRANSACCION:=0;
               END;

--dbms_output.put_line('SEcuencia:  '||VL_TRANSACCION);
        
              Begin
                 Select TBBDETC_DETAIL_CODE, TBBDETC_DESC
                    Into vl_cargo, VL_DESCRIPCION
                 from tbbdetc
                 where tbbdetc_detail_code = coleg.id||'N4';  ---> Codigo de Detalle para aplicar el ajuste de Colegiatura
              Exception
                When Others then 
                    vl_cargo:= null; 
                    VL_DESCRIPCION:= null;
              
              End;

                vl_existe:=0;
              Begin
                Select count(1)
                    Into vl_existe 
                from tbraccd
                Where 1=1
                And tbraccd_pidm = COLEG.PIDM
                And trunc (TBRACCD_FEED_DATE) = coleg.Fecha_inicio
                And tbraccd_detail_code like '%N4';
              Exception
                When OThers then 
                   vl_existe:=0; 
              End;

              If vl_existe = 0 then 
              ---------------- Valida que no tenga el cargo para la fecha de inicio  -------------
           --   dbms_output.put_line('Registra en tbra:  '||COLEG.SECUENCIA);
              
                   BEGIN
                       INSERT
                         INTO TBRACCD
                       VALUES (
                               COLEG.PIDM,                                         -- TBRACCD_PIDM
                               VL_TRANSACCION,                                     -- TBRACCD_TRAN_NUMBER
                               COLEG.PERIODO,                                      -- TBRACCD_TERM_CODE
                               vl_Cargo,                                         -- TBRACCD_DETAIL_CODE
                               USER,                                               -- TBRACCD_USER
                               SYSDATE,                                            -- TBRACCD_ENTRY_DATE
                               NVL(COLEG.monto,0),                                 -- TBRACCD_AMOUNT
                               NVL(COLEG.monto,0) * -1,                            -- TBRACCD_BALANCE
                               SYSDATE,                                            -- TBRACCD_EFFECTIVE_DATE
                               NULL,                                               -- TBRACCD_BILL_DATE
                               NULL,                                               -- TBRACCD_DUE_DATE
                               VL_DESCRIPCION,                                     -- TBRACCD_DESC
                               coleg.orden,                                        -- TBRACCD_RECEIPT_NUMBER
                               null,                                               -- TBRACCD_TRAN_NUMBER_PAID
                               NULL,                                               -- TBRACCD_CROSSREF_PIDM
                               NULL,                                               -- TBRACCD_CROSSREF_NUMBER
                               NULL,                                               -- TBRACCD_CROSSREF_DETAIL_CODE
                               'T',                                                -- TBRACCD_SRCE_CODE
                               'Y',                                                -- TBRACCD_ACCT_FEED_IND
                               SYSDATE,                                            -- TBRACCD_ACTIVITY_DATE
                               0,                                                  -- TBRACCD_SESSION_NUMBER
                               NULL,                                               -- TBRACCD_CSHR_END_DATE
                               NULL,                                               -- TBRACCD_CRN
                               NULL,                                               -- TBRACCD_CROSSREF_SRCE_CODE
                               NULL,                                               -- TBRACCD_LOC_MDT
                               NULL,                                               -- TBRACCD_LOC_MDT_SEQ
                               NULL,                                               -- TBRACCD_RATE
                               NULL,                                               -- TBRACCD_UNITS
                               NULL,                                               -- TBRACCD_DOCUMENT_NUMBER
                               SYSDATE,                                            -- TBRACCD_TRANS_DATE
                               NULL,                                               -- TBRACCD_PAYMENT_ID
                               NULL,                                               -- TBRACCD_INVOICE_NUMBER
                               NULL,                                               -- TBRACCD_STATEMENT_DATE
                               NULL,                                               -- TBRACCD_INV_NUMBER_PAID
                               COLEG.moneda,                                              -- TBRACCD_CURR_CODE
                               NULL,                                               -- TBRACCD_EXCHANGE_DIFF
                               NULL,                                               -- TBRACCD_FOREIGN
                               NULL,                                               -- TBRACCD_LATE_DCAT_CODE
                               coleg.Fecha_inicio,                                        -- TBRACCD_FEED_DATE
                               NULL,                                               -- TBRACCD_FEED_DOC_CODE
                               NULL,                                               -- TBRACCD_ATYP_CODE
                               NULL,                                               -- TBRACCD_ATYP_SEQNO
                               NULL,                                               -- TBRACCD_CARD_TYPE_VR
                               NULL,                                               -- TBRACCD_CARD_EXP_DATE_VR
                               NULL,                                               -- TBRACCD_CARD_AUTH_NUMBER_VR
                               NULL,                                               -- TBRACCD_CROSSREF_DCAT_CODE
                               NULL,                                               -- TBRACCD_ORIG_CHG_IND
                               NULL,                                               -- TBRACCD_CCRD_CODE
                               NULL,                                               -- TBRACCD_MERCHANT_ID
                               NULL,                                               -- TBRACCD_TAX_REPT_YEAR
                               NULL,                                               -- TBRACCD_TAX_REPT_BOX
                               NULL,                                               -- TBRACCD_TAX_AMOUNT
                               NULL,                                               -- TBRACCD_TAX_FUTURE_IND
                               'AUTOMATICO',                                       -- TBRACCD_DATA_ORIGIN
                               'AUTOMATICO',                                       -- TBRACCD_CREATE_SOURCE
                               NULL,                                               -- TBRACCD_CPDT_IND
                               NULL,                                               -- TBRACCD_AIDY_CODE
                               COLEG.TBRACCD_STSP_KEY_SEQUENCE,                    -- TBRACCD_STSP_KEY_SEQUENCE
                               COLEG.TBRACCD_PERIOD,                               -- TBRACCD_PERIOD
                               NULL,                                               -- TBRACCD_SURROGATE_ID
                               NULL,                                               -- TBRACCD_VERSION
                               USER,                                               -- TBRACCD_USER_ID
                               NULL );                                             -- TBRACCD_VPDI_CODE
                               VL_ERROR:='EXITO';
                   EXCEPTION
                   WHEN OTHERS THEN
                   VL_ERROR := 'Se presento el siguiente error al momento de insertar ajuste para colegiatura en TBRACCD '||SQLERRM;
                   END;
               
                End if;

             END LOOP COLEG;


        Return VL_ERROR;
             
Exception
    When Others then
        VL_ERROR:= 'Error General al realizar ajuste Retencion '||sqlerrm;
        Return VL_ERROR;
End f_ajuste_mes_tres_baja;


--------------------------  fUNCION NUEVA PARA DASHBOARD TURBO RECUPERA INTERESES --------------------

FUNCTION F_INTERESES_OUT (P_PIDM IN NUMBER) RETURN PKG_FINANZAS.CUCAR_OUT_1
AS
CURCARGOS_OUT_1 PKG_FINANZAS.CUCAR_OUT_1;

    BEGIN

       OPEN CURCARGOS_OUT_1
       FOR
          Select TBRACCD_EFFECTIVE_DATE FECHA , TBRACCD_DESC CONCEPTO, TBRACCD_BALANCE Monto
          from tbraccd
          join TZTNCD on TZTNCD_CODE = tbraccd_detail_code and TZTNCD_CONCEPTO = 'Interes' and OPERA = 'SUMA'
          Where 1=1
          And tbraccd_pidm =P_PIDM
          and tbraccd_amount > 0
          order by 1 desc;

        RETURN (CURCARGOS_OUT_1);

    END F_INTERESES_OUT;


--------------------------  fUNCION NUEVA PARA DASHBOARD TURBO RECUPERA Notas Debito y CREDITO --------------------

FUNCTION F_NOTAS_OUT (P_PIDM IN NUMBER) RETURN PKG_FINANZAS.CUCAR_OUT_2
AS
CURCARGOS_OUT_2 PKG_FINANZAS.CUCAR_OUT_2;

    BEGIN

       OPEN CURCARGOS_OUT_2
       FOR
          Select TBRACCD_EFFECTIVE_DATE FECHA , TBRACCD_DESC CONCEPTO,  decode (TZTNCD_CONCEPTO, 'Nota Credito', 'Nota Credito','Nota Debito', 'Nota Debito', 'Financieras', 'Nota Credito') TIPO_NOTA , TBRACCD_BALANCE Monto
          from tbraccd
          join TZTNCD on TZTNCD_CODE = tbraccd_detail_code and TZTNCD_CONCEPTO   in ('Nota Credito', 'Nota Debito', 'Financieras')
          Where 1=1
          And tbraccd_pidm =P_PIDM
          and tbraccd_amount > 0
          order by 1 desc;

        RETURN (CURCARGOS_OUT_2);

    END F_NOTAS_OUT;

Procedure p_etiqueta_Retencion(p_pidm in number default null) as

vl_Exito varchar2(500):= null; 

Begin 


     for c in (


                        Select x.pidm, x.matricula, x.campus, x.nivel, x.estatus, x.sp, x.regla, x.Fecha_inicio_mod,
                        (select sum (tbraccd_amount)
                                             from tbraccd
                                             join TZTNCD on TZTNCD_CODE = tbraccd_detail_code And TZTNCD_CONCEPTO IN ('Venta')
                                             where tbraccd_pidm = x.pidm
                                             And trunc (TBRACCD_FEED_DATE) = x.Fecha_inicio_mod
                                             ) Monto
                        from (
                            select distinct a.pidm, a.matricula, a.campus, a.nivel, a.sp, b.SZSTUME_NO_REGLA Regla, a.fecha_inicio, b.SZSTUME_START_DATE Fecha_inicio_mod, a.estatus
                            from tztprog a
                            join SZSTUME b on b.SZSTUME_PIDM = a.pidm 
                            where 1=1
                           -- And trunc (a.FECHA_INICIO)  = trunc (b.SZSTUME_START_DATE)
                            And a.estatus ='MA'
                            AND b.SZSTUME_NO_REGLA IN  (SELECT ZSTPARA_PARAM_VALOR
                                                     FROM ZSTPARA
                                                     WHERE 1=1
                                                     AND ZSTPARA_MAPA_ID = 'MONITOR_SYNC_GR')
                       ) x
                       where 1=1
                       And x.pidm not in (Select GORADID_PIDM
                                      from goradid 
                                      Where 1=1
                                      And GORADID_ADID_CODE in ('SBTD','SBTI'))
                       And x.pidm = nvl (p_pidm, x.pidm)

       ) loop

          dbms_output.put_line('Recupero el registro :  '||c.pidm ||'Monto' ||c.monto);

        If c.nivel not in ('MS', 'MA', 'DO' )then 



            ---------------- Con esta consulta recupero todos los alumnos que estan en el pronostico para descargar calificaciones y que tienen adeudo y materias como 'NP' --------

             For cx in (

                            Select x.pidm, x.matricula, x.campus, x.nivel, x.sp, x.regla, x.fecha_inicio, x.saldo_total, x.total_materias, x.total_reprobadas, x.Fecha_inicio_mod
                            from (
                                select distinct a.pidm, a.matricula, a.campus, a.nivel, a.sp, b.SZSTUME_NO_REGLA Regla, a.fecha_inicio, b.SZSTUME_START_DATE Fecha_inicio_mod,
                                               ( PKG_DASHBOARD_ALUMNO.f_dashboard_saldototal(a.pidm) + c.monto) Saldo_Total,
                                   ( select Count(*) 
                                    from sfrstcr a
                                    join ssbsect b on b.SSBSECT_TERM_CODE = a.SFRSTCR_TERM_CODE and b.SSBSECT_CRN = a.SFRSTCR_CRN
                                    where 1=1
                                    and a.SFRSTCR_PIDM = a.pidm
                                    And a.SFRSTCR_STSP_KEY_SEQUENCE = a.sp
                                    and trunc (b.SSBSECT_PTRM_START_DATE) = trunc (b.SZSTUME_START_DATE)
                                    And a.SFRSTCR_RSTS_CODE ='RE'
                                    And substr (a.SFRSTCR_TERM_CODE,5,1) not in ('8','9')
                                    And substr (a.SFRSTCR_PTRM_CODE,3,1) not in ('B','C')
                                ) Total_Materias,
                                   ( select Count(*) 
                                    from sfrstcr a
                                    join ssbsect b on b.SSBSECT_TERM_CODE = a.SFRSTCR_TERM_CODE and b.SSBSECT_CRN = a.SFRSTCR_CRN
                                    where 1=1
                                    and a.SFRSTCR_PIDM = a.pidm
                                    And a.SFRSTCR_STSP_KEY_SEQUENCE = a.sp
                                    and trunc (b.SSBSECT_PTRM_START_DATE) = trunc (b.SZSTUME_START_DATE)
                                    And a.SFRSTCR_RSTS_CODE ='RE'
                                    And substr (a.SFRSTCR_TERM_CODE,5,1) not in ('8','9')
                                    And substr (a.SFRSTCR_PTRM_CODE,3,1) not in ('B','C')
                                    And SFRSTCR_GRDE_CODE ='NP'
                                ) Total_Reprobadas                  
                                from tztprog a
                                join SZSTUME b on b.SZSTUME_PIDM = a.pidm 
                                where 1=1
                               -- And trunc (a.FECHA_INICIO)  = trunc (b.SZSTUME_START_DATE)
                                And a.estatus ='MA'
                                AND b.SZSTUME_NO_REGLA IN  (SELECT ZSTPARA_PARAM_VALOR
                                                         FROM ZSTPARA
                                                         WHERE 1=1
                                                         AND ZSTPARA_MAPA_ID = 'MONITOR_SYNC_GR')
                                And (PKG_DASHBOARD_ALUMNO.f_dashboard_saldototal(a.pidm) +c.monto)  >= (Select to_number (ZSTPARA_PARAM_VALOR)
                                                                                            FROM ZSTPARA
                                                                                            WHERE 1=1
                                                                                            AND ZSTPARA_MAPA_ID = 'SBTI_COSTOS_4W'
                                                                                            And ZSTPARA_PARAM_ID = a.campus
                                                                                            And ZSTPARA_PARAM_DESC = a.nivel
                                                                                            )      
                           ) x
                           where 1=1
                           and x.total_materias >0
                           And x.total_materias = x.total_reprobadas
                           And x.pidm not in (Select GORADID_PIDM
                                          from goradid 
                                          Where 1=1
                                          And GORADID_ADID_CODE in ('SBTD','SBTI'))
                           And x.pidm = c.pidm
                            
                        ) loop
                        

dbms_output.put_line('Recupero el registro :  '||c.pidm ||'Monto' ||cx.Saldo_Total);
                        ---------------------- Inserta la etiqueta para Retencion ------------
                        Begin
                        
                            vl_Exito:= pkg_utilerias.F_Genera_Etiqueta(cx.pidm, 
                                                                       'SBTI', 
                                                                       'SUSPENSION POR BTI', 
                                                                        USER); 
                        Exception
                            When Others then
                                null;
                        End;
                        
                        Begin                                                
                            vl_Exito:=pkg_finanzas.f_ajuste_retencion (cx.pidm, 
                                                                       cx.nivel,
                                                                       cx.Fecha_inicio_mod,
                                                                       cx.sp); 
                        Exception
                            When Others then
                                null;
                        End;
                                                                     
                        
                        
            End Loop;


        Elsif c.nivel in ('MS', 'MA', 'DO')  then 

            ---------------- Con esta consulta recupero todos los alumnos que estan en el pronostico para descargar calificaciones y que tienen adeudo y materias como 'NP' --------

             For cx in (

                            Select x.pidm, x.matricula, x.campus, x.nivel, x.sp, x.regla, x.fecha_inicio, x.saldo_total, x.total_materias, x.total_reprobadas, x.Fecha_inicio_mod
                            from (
                                select distinct a.pidm, a.matricula, a.campus, a.nivel, a.sp, b.SZSTUME_NO_REGLA Regla, a.fecha_inicio, b.SZSTUME_START_DATE Fecha_inicio_mod,
                                                (PKG_DASHBOARD_ALUMNO.f_dashboard_saldototal(a.pidm) + c.monto) Saldo_Total,
                                   ( select Count(*) 
                                    from sfrstcr a
                                    join ssbsect b on b.SSBSECT_TERM_CODE = a.SFRSTCR_TERM_CODE and b.SSBSECT_CRN = a.SFRSTCR_CRN
                                    where 1=1
                                    and a.SFRSTCR_PIDM = a.pidm
                                    And a.SFRSTCR_STSP_KEY_SEQUENCE = a.sp
                                    and trunc (b.SSBSECT_PTRM_START_DATE) = trunc (b.SZSTUME_START_DATE)
                                    And a.SFRSTCR_RSTS_CODE ='RE'
                                    And substr (a.SFRSTCR_TERM_CODE,5,1) not in ('8','9')
                                ) Total_Materias,
                                   ( select Count(*) 
                                    from sfrstcr a
                                    join ssbsect b on b.SSBSECT_TERM_CODE = a.SFRSTCR_TERM_CODE and b.SSBSECT_CRN = a.SFRSTCR_CRN
                                    where 1=1
                                    and a.SFRSTCR_PIDM = a.pidm
                                    And a.SFRSTCR_STSP_KEY_SEQUENCE = a.sp
                                    and trunc (b.SSBSECT_PTRM_START_DATE) = trunc (b.SZSTUME_START_DATE)
                                    And a.SFRSTCR_RSTS_CODE ='RE'
                                    And substr (a.SFRSTCR_TERM_CODE,5,1) not in ('8','9')
                                    And SFRSTCR_GRDE_CODE ='NP'
                                ) Total_Reprobadas                  
                                from tztprog a
                                join SZSTUME b on b.SZSTUME_PIDM = a.pidm 
                                where 1=1
                               -- And trunc (a.FECHA_INICIO)  = trunc (b.SZSTUME_START_DATE)
                                And a.estatus ='MA'
                                AND b.SZSTUME_NO_REGLA IN  (SELECT ZSTPARA_PARAM_VALOR
                                                         FROM ZSTPARA
                                                         WHERE 1=1
                                                         AND ZSTPARA_MAPA_ID = 'MONITOR_SYNC_GR')
                                And (PKG_DASHBOARD_ALUMNO.f_dashboard_saldototal(a.pidm)+c.monto) >= (Select to_number (ZSTPARA_PARAM_VALOR)
                                                                                            FROM ZSTPARA
                                                                                            WHERE 1=1
                                                                                            AND ZSTPARA_MAPA_ID = 'SBTI_COSTOS_4W'
                                                                                            And ZSTPARA_PARAM_ID = a.campus
                                                                                            And ZSTPARA_PARAM_DESC = a.nivel
                                                                                            )      
                           ) x
                           where 1=1
                           and x.total_materias >0
                           And x.total_materias = x.total_reprobadas
                           And x.pidm not in (Select GORADID_PIDM
                                          from goradid 
                                          Where 1=1
                                          And GORADID_ADID_CODE = 'SBTI')
                           And x.pidm = c.pidm
                            
                        ) loop
                        

dbms_output.put_line('Recupero el registro :  '||c.pidm ||'Monto' ||cx.Saldo_Total);

                        ---------------------- Inserta la etiqueta para Retencion ------------
                        Begin
                        
                            vl_Exito:= pkg_utilerias.F_Genera_Etiqueta(cx.pidm, 
                                                                       'SBTI', 
                                                                       'SUSPENSION POR BTI', 
                                                                        USER); 
                        Exception
                            When Others then
                                null;
                        End;
                        
                        Begin                                                
                            vl_Exito:=pkg_finanzas.f_ajuste_retencion (cx.pidm, 
                                                                       cx.nivel,
                                                                       cx.Fecha_inicio_mod,
                                                                       cx.sp); 
                        Exception
                            When Others then
                                null;
                        End;
                                                                     
                        
                        
            End Loop;

        End if;

    End loop;


End p_etiqueta_Retencion;


Function f_ajuste_retencion (p_pidm number, p_nivel in varchar2, p_fecha_ini date, p_sp in number) Return varchar2

is 

VL_ERROR varchar2(500) := null;
VL_TRANSACCION number:= 0;
VL_DESCRIPCION varchar2(50):= null;
vl_Cargo varchar2(4):= null;
vl_Existe number:=0;



Begin 

          vl_Existe:=0;

          Begin
          
            Select count(1)
                Into vl_Existe
            from tbraccd
            Where 1=1
            And tbraccd_pidm = p_pidm
            And trunc (TBRACCD_FEED_DATE) =p_fecha_ini 
            And TBRACCD_STSP_KEY_SEQUENCE = p_sp
           And tbraccd_detail_code like '%N4';
            --And tbraccd_detail_code like '%89';
          
          EXception
            When Others then 
            vl_Existe:=0;
          End;
          
          If vl_Existe > 0 then 
            VL_ERROR:='Existe';

          Else 
  
           -- dbms_output.put_line('No Existen Cargos:  '||p_pidm);

             FOR COLEG IN (

                    SELECT  B.TBRACCD_PIDM PIDM,
                          B.TBRACCD_Amount MONTO,
                          B.TBRACCD_TRAN_NUMBER SECUENCIA,
                          SPRIDEN_ID Matricula,
                          substr (SPRIDEN_ID,1,2) ID,
                          TBRACCD_STSP_KEY_SEQUENCE, 
                          TBRACCD_PERIOD, 
                          TBRACCD_TERM_CODE PERIODO,
                          TVRDCTX_CURR_CODE Moneda,
                          TBRACCD_RECEIPT_NUMBER orden
                    FROM TBRACCD B, SPRIDEN, TVRDCTX
                    WHERE  B.TBRACCD_PIDM = p_pidm --PN_PIDM
                         AND B.TBRACCD_DETAIL_CODE IN (SELECT TBBDETC_DETAIL_CODE
                                                         FROM TBBDETC
                                                        WHERE TBBDETC_DCAT_CODE = 'COL'
                                                              AND SUBSTR (TBBDETC_DETAIL_CODE,1,2) = SUBSTR (B.TBRACCD_TERM_CODE,1,2)
                                                              AND TBBDETC_DETC_ACTIVE_IND = 'Y'
                                                              AND TBBDETC_TAXT_CODE = p_nivel
                                                              )
                         And trunc (b.TBRACCD_FEED_DATE) =p_fecha_ini
                         And b.TBRACCD_STSP_KEY_SEQUENCE = p_sp
                         AND B.TBRACCD_PIDM = SPRIDEN_PIDM
                         AND SPRIDEN_CHANGE_IND IS NULL
                         And b.tbraccd_detail_code = TVRDCTX_DETC_CODE
                         And trunc (b.TBRACCD_EFFECTIVE_DATE) between '01/06/2025'and '30/06/2025'
                         And trunc (b.TBRACCD_EFFECTIVE_DATE) in (select max(trunc (b1.TBRACCD_EFFECTIVE_DATE))
                                                                   from tbraccd b1
                                                                   Where b.TBRACCD_PIDM = b1.TBRACCD_PIDM
                                                                   And b.TBRACCD_DETAIL_CODE = b1.TBRACCD_DETAIL_CODE
                                                                   And b.TBRACCD_FEED_DATE = b1.TBRACCD_FEED_DATE
                                                                   And b.TBRACCD_STSP_KEY_SEQUENCE = b1.TBRACCD_STSP_KEY_SEQUENCE
                                                                   )
                         
                         
             ) LOOP

                    VL_TRANSACCION:= 0;
                    VL_ERROR:= NULL;


               BEGIN
                 SELECT NVL(MAX(TBRACCD_TRAN_NUMBER),0) +1
                   INTO VL_TRANSACCION
                   FROM TBRACCD
                  WHERE TBRACCD_PIDM=COLEG.PIDM;
               EXCEPTION
               WHEN OTHERS THEN
               VL_TRANSACCION:=0;
               END;

--dbms_output.put_line('SEcuencia:  '||VL_TRANSACCION);
        
              Begin
                 Select TBBDETC_DETAIL_CODE, TBBDETC_DESC
                    Into vl_cargo, VL_DESCRIPCION
                 from tbbdetc
                 where tbbdetc_detail_code = coleg.id||'N4';  ---> Codigo de Detalle para aplicar el ajuste de Colegiatura este es para Inactividad
                -- where tbbdetc_detail_code = coleg.id||'89';  ---> Codigo de Detalle para aplicar el ajuste de Colegiatura
              Exception
                When Others then 
                    vl_cargo:= null; 
                    VL_DESCRIPCION:= null;
              
              End;


              ---------------- Valida que no tenga el cargo para la fecha de inicio  -------------
              --dbms_output.put_line('Registra en tbra:  '||COLEG.SECUENCIA);
              
                   BEGIN
                       INSERT
                         INTO TBRACCD
                       VALUES (
                               COLEG.PIDM,                                         -- TBRACCD_PIDM
                               VL_TRANSACCION,                                     -- TBRACCD_TRAN_NUMBER
                               COLEG.PERIODO,                                      -- TBRACCD_TERM_CODE
                               vl_Cargo,                                         -- TBRACCD_DETAIL_CODE
                               USER,                                               -- TBRACCD_USER
                               SYSDATE,                                            -- TBRACCD_ENTRY_DATE
                               NVL(COLEG.monto,0),                                 -- TBRACCD_AMOUNT
                               NVL(COLEG.monto,0) * -1,                            -- TBRACCD_BALANCE
                               SYSDATE,                                            -- TBRACCD_EFFECTIVE_DATE
                               NULL,                                               -- TBRACCD_BILL_DATE
                               NULL,                                               -- TBRACCD_DUE_DATE
                               VL_DESCRIPCION,                                     -- TBRACCD_DESC
                               coleg.orden,                                        -- TBRACCD_RECEIPT_NUMBER
                               coleg.secuencia,                                    -- TBRACCD_TRAN_NUMBER_PAID
                               NULL,                                               -- TBRACCD_CROSSREF_PIDM
                               NULL,                                               -- TBRACCD_CROSSREF_NUMBER
                               NULL,                                               -- TBRACCD_CROSSREF_DETAIL_CODE
                               'T',                                                -- TBRACCD_SRCE_CODE
                               'Y',                                                -- TBRACCD_ACCT_FEED_IND
                               SYSDATE,                                            -- TBRACCD_ACTIVITY_DATE
                               0,                                                  -- TBRACCD_SESSION_NUMBER
                               NULL,                                               -- TBRACCD_CSHR_END_DATE
                               NULL,                                               -- TBRACCD_CRN
                               NULL,                                               -- TBRACCD_CROSSREF_SRCE_CODE
                               NULL,                                               -- TBRACCD_LOC_MDT
                               NULL,                                               -- TBRACCD_LOC_MDT_SEQ
                               NULL,                                               -- TBRACCD_RATE
                               NULL,                                               -- TBRACCD_UNITS
                               NULL,                                               -- TBRACCD_DOCUMENT_NUMBER
                               SYSDATE,                                            -- TBRACCD_TRANS_DATE
                               NULL,                                               -- TBRACCD_PAYMENT_ID
                               NULL,                                               -- TBRACCD_INVOICE_NUMBER
                               NULL,                                               -- TBRACCD_STATEMENT_DATE
                               NULL,                                               -- TBRACCD_INV_NUMBER_PAID
                               COLEG.moneda,                                              -- TBRACCD_CURR_CODE
                               NULL,                                               -- TBRACCD_EXCHANGE_DIFF
                               NULL,                                               -- TBRACCD_FOREIGN
                               NULL,                                               -- TBRACCD_LATE_DCAT_CODE
                               p_fecha_ini,                                        -- TBRACCD_FEED_DATE
                               NULL,                                               -- TBRACCD_FEED_DOC_CODE
                               NULL,                                               -- TBRACCD_ATYP_CODE
                               NULL,                                               -- TBRACCD_ATYP_SEQNO
                               NULL,                                               -- TBRACCD_CARD_TYPE_VR
                               NULL,                                               -- TBRACCD_CARD_EXP_DATE_VR
                               NULL,                                               -- TBRACCD_CARD_AUTH_NUMBER_VR
                               NULL,                                               -- TBRACCD_CROSSREF_DCAT_CODE
                               NULL,                                               -- TBRACCD_ORIG_CHG_IND
                               NULL,                                               -- TBRACCD_CCRD_CODE
                               NULL,                                               -- TBRACCD_MERCHANT_ID
                               NULL,                                               -- TBRACCD_TAX_REPT_YEAR
                               NULL,                                               -- TBRACCD_TAX_REPT_BOX
                               NULL,                                               -- TBRACCD_TAX_AMOUNT
                               NULL,                                               -- TBRACCD_TAX_FUTURE_IND
                               'AUTOMATICO',                                       -- TBRACCD_DATA_ORIGIN
                               'AUTOMATICO',                                       -- TBRACCD_CREATE_SOURCE
                               NULL,                                               -- TBRACCD_CPDT_IND
                               NULL,                                               -- TBRACCD_AIDY_CODE
                               COLEG.TBRACCD_STSP_KEY_SEQUENCE,                    -- TBRACCD_STSP_KEY_SEQUENCE
                               COLEG.TBRACCD_PERIOD,                               -- TBRACCD_PERIOD
                               NULL,                                               -- TBRACCD_SURROGATE_ID
                               NULL,                                               -- TBRACCD_VERSION
                               USER,                                               -- TBRACCD_USER_ID
                               NULL );                                             -- TBRACCD_VPDI_CODE
                               VL_ERROR:='EXITO';
                   EXCEPTION
                   WHEN OTHERS THEN
                   VL_ERROR := 'Se presento el siguiente error al momento de insertar ajuste para colegiatura en TBRACCD '||SQLERRM;
                   END;
               
       

               END LOOP COLEG;
          
           End if;

        Return VL_ERROR;
             
Exception
    When Others then
        VL_ERROR:= 'Error General al realizar ajuste Retencion '||sqlerrm;
        Return VL_ERROR;
End f_ajuste_retencion;





end PKG_FINANZAS;
/

DROP PUBLIC SYNONYM PKG_FINANZAS;

CREATE OR REPLACE PUBLIC SYNONYM PKG_FINANZAS FOR BANINST1.PKG_FINANZAS;


GRANT EXECUTE, DEBUG ON BANINST1.PKG_FINANZAS TO PUBLIC;
